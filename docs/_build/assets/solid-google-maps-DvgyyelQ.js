import{g as yn,A as Jn,i as tc,o as xs,z as gh,l as ve,K as mh,c as Pn,a as Zv,u as Jv,p as Tn,t as Bn,D as Qv,v as wu,e as e1,C as n1,H as r1,d as i1,q as s1,m as Tl,r as gi,S as _l,n as o1,B as sd,F as a1}from"./web-CZ3DQZL7.js";/* empty css              *//* empty css                     *//* empty css                */import{g as _h,c as ps}from"./_commonjsHelpers-Cpj98o6Y.js";function l1(n){return!n||typeof n!="object"||!("lat"in n&&"lng"in n)?!1:Number.isFinite(n.lat)&&Number.isFinite(n.lng)}function t0(n){return l1(n)?n:n.toJSON()}function c1(n,t,e){const r=yn(()=>e.center?t0(e.center):null),i=yn(()=>{let c=null,u=null;return r()&&Number.isFinite(r().lat)&&Number.isFinite(r().lng)&&(c=r().lat,u=r().lng),{lat:c,lng:u}}),s=yn(()=>Number.isFinite(e.zoom)?e.zoom:null),o=yn(()=>Number.isFinite(e.heading)?e.heading:null),a=yn(()=>Number.isFinite(e.tilt)?e.tilt:null);let l=null;Jn(tc(()=>({map:n(),cameraState:t(),latLng:i(),zoom:s(),heading:o(),tilt:a()}),({map:c})=>{c&&(l=setTimeout(()=>{const u={};let h=!1;i().lat!==null&&i().lng!==null&&(t().center.lat!==i().lat||t().center.lng!==i().lng)&&(u.center={lat:i().lat,lng:i().lng},h=!0),s()!==null&&t().zoom!==s()&&(u.zoom=s(),h=!0),o()!==null&&t().heading!==o()&&(u.heading=o(),h=!0),a()!==null&&t().tilt!==a()&&(u.tilt=a(),h=!0),h&&c.moveCamera(u)},0),xs(()=>l&&clearTimeout(l)))}))}function u1(n,t){gh(()=>{for(const e of p1){const r=e0[e],i=yn(()=>t[e]);Jn(tc(()=>({map:n(),handler:i()}),({map:s,handler:o})=>{if(!s||!o)return;const a=google.maps.event.addListener(s,r,l=>{o(h1(r,s,l))});xs(()=>a.remove())}))}})}function h1(n,t,e){const r={type:n,map:t,detail:{},stoppable:!1,stop:()=>{}};if(f1.includes(n)){const i=r,s=t.getCenter(),o=t.getZoom(),a=t.getHeading()||0,l=t.getTilt()||0,c=t.getBounds();return(!s||!c||!Number.isFinite(o))&&console.warn("[createEvent] at least one of the values from the map returned undefined. This is not expected to happen. Please report an issue at https://github.com/visgl/react-google-maps/issues/new"),i.detail={center:s?.toJSON()||{lat:0,lng:0},zoom:o||0,heading:a,tilt:l,bounds:c?.toJSON()||{north:90,east:180,south:-90,west:-180}},i}else if(d1.includes(n)){if(!e)throw new Error("[createEvent] mouse events must provide a srcEvent");const i=r;return i.domEvent=e.domEvent,i.stoppable=!0,i.stop=()=>e.stop(),i.detail={latLng:e.latLng?.toJSON()||null,placeId:e.placeId},i}return r}var e0={onBoundsChanged:"bounds_changed",onCenterChanged:"center_changed",onClick:"click",onContextmenu:"contextmenu",onDblclick:"dblclick",onDrag:"drag",onDragend:"dragend",onDragstart:"dragstart",onHeadingChanged:"heading_changed",onIdle:"idle",onIsFractionalZoomEnabledChanged:"isfractionalzoomenabled_changed",onMapCapabilitiesChanged:"mapcapabilities_changed",onMapTypeIdChanged:"maptypeid_changed",onMousemove:"mousemove",onMouseout:"mouseout",onMouseover:"mouseover",onProjectionChanged:"projection_changed",onRenderingTypeChanged:"renderingtype_changed",onTilesLoaded:"tilesloaded",onTiltChanged:"tilt_changed",onZoomChanged:"zoom_changed",onCameraChanged:"bounds_changed"},f1=["bounds_changed","center_changed","heading_changed","tilt_changed","zoom_changed"],d1=["click","contextmenu","dblclick","mousemove","mouseout","mouseover"],p1=Object.keys(e0);function g1(n,t){const e=n.getCenter(),r=n.getZoom(),i=n.getHeading()||0,s=n.getTilt()||0,o=n.getBounds();(!e||!o||!Number.isFinite(r))&&console.warn("[useTrackedCameraState] at least one of the values from the map returned undefined. This is not expected to happen. Please report an issue at https://github.com/visgl/react-google-maps/issues/new"),t(a=>({...a,center:e?.toJSON()||{lat:0,lng:0},zoom:r||0,heading:i,tilt:s}))}function m1(n){const[t,e]=ve({center:{lat:0,lng:0},heading:0,tilt:0,zoom:0});return Jn(tc(()=>({map:n()}),({map:r})=>{if(!r)return;const i=google.maps.event.addListener(r,"bounds_changed",()=>{g1(r,e)});xs(()=>i.remove())})),t}var Vi={NOT_LOADED:"NOT_LOADED",LOADING:"LOADING",LOADED:"LOADED",FAILED:"FAILED",AUTH_FAILURE:"AUTH_FAILURE"},_1="https://maps.googleapis.com/maps/api/js",Wg=class{static loadingStatus=Vi.NOT_LOADED;static serializedApiParams;static listeners=[];static async load(n,t){const e=n.libraries?n.libraries.split(","):[],r=this.serializeParams(n);this.listeners.push(t),window.google?.maps?.importLibrary?(this.serializedApiParams||(this.loadingStatus=Vi.LOADED),this.notifyLoadingStatusListeners()):(this.serializedApiParams=r,this.initImportLibrary(n)),this.serializedApiParams&&this.serializedApiParams!==r&&console.warn("[google-maps-api-loader] The maps API has already been loaded with different parameters and will not be loaded again. Refresh the page for new values to have effect.");const i=["maps",...e];await Promise.all(i.map(s=>google.maps.importLibrary(s)))}static serializeParams(n){return[n.v,n.key,n.language,n.region,n.authReferrerPolicy,n.solutionChannel].join("/")}static initImportLibrary(n){if(window.google||(window.google={}),window.google.maps||(window.google.maps={}),window.google.maps.importLibrary){console.error("[google-maps-api-loader-internal]: initImportLibrary must only be called once");return}let t=null;const e=()=>t||(t=new Promise((r,i)=>{const s=document.createElement("script"),o=new URLSearchParams;for(const[a,l]of Object.entries(n)){const c=a.replace(/[A-Z]/g,u=>"_"+u[0].toLowerCase());o.set(c,String(l))}o.set("loading","async"),o.set("callback","__googleMapsCallback__"),s.async=!0,s.src=_1+"?"+o.toString(),s.nonce=document.querySelector("script[nonce]")?.nonce||"",s.onerror=()=>{this.loadingStatus=Vi.FAILED,this.notifyLoadingStatusListeners(),i(new Error("The Google Maps JavaScript API could not load."))},window.__googleMapsCallback__=()=>{this.loadingStatus=Vi.LOADED,this.notifyLoadingStatusListeners(),r()},window.gm_authFailure=()=>{this.loadingStatus=Vi.AUTH_FAILURE,this.notifyLoadingStatusListeners()},this.loadingStatus=Vi.LOADING,this.notifyLoadingStatusListeners(),document.head.append(s)}),t);google.maps.importLibrary=r=>e().then(()=>google.maps.importLibrary(r))}static notifyLoadingStatusListeners(){for(const n of this.listeners)n(this.loadingStatus)}},y1="GMP_visgl_rgmlibrary_v1_default",fp=Zv(null);function v1(){const[n,t]=ve({});return{mapInstances:n,addMapInstance:(s,o="default")=>{t(a=>({...a,[o]:s}))},removeMapInstance:(s="default")=>{t(({[s]:o,...a})=>a)},clearMapInstances:()=>{t({})}}}function b1(n){const[t,e]=mh(n,["apiKey","version","libraries","onLoad","onError"]),[r,i]=ve(Wg.loadingStatus),[s,o]=ve({}),a=h=>{o(f=>f[h.name]?f:{...f,[h.name]:h.value})},l=yn(()=>t.libraries?.join(",")),c=yn(()=>JSON.stringify({apiKey:t.apiKey,version:t.version,...e})),u=async h=>{if(s()[h])return s()[h];if(!google.maps.importLibrary)throw new Error("[api-provider-internal] importLibrary was called before google.maps.importLibrary was defined.");const f=await window.google.maps.importLibrary(h);return a({name:h,value:f}),f};return Jn(tc(()=>({apiKey:t.apiKey,librariesString:l(),serializedParams:c()}),async()=>{try{const h={key:t.apiKey,...e};t.version&&(h.v=t.version),l.length>0&&(h.libraries=l()),(h.channel===void 0||h.channel<0||h.channel>999)&&delete h.channel,h.solutionChannel===void 0?h.solutionChannel=y1:h.solutionChannel===""&&delete h.solutionChannel,await Wg.load(h,f=>i(f));for(const f of["core","maps",...t.libraries||[]])await u(f);t.onLoad&&t.onLoad()}catch(h){t.onError?t.onError(h):console.error("<ApiProvider> failed to load the Google Maps JavaScript API",h)}})),{status:r,loadedLibraries:s,importLibrary:u}}var x1=n=>{const[t,e]=mh(n,["children"]),{mapInstances:r,addMapInstance:i,removeMapInstance:s,clearMapInstances:o}=v1(),{status:a,loadedLibraries:l,importLibrary:c}=b1(e),u={mapInstances:r,addMapInstance:i,removeMapInstance:s,clearMapInstances:o,status:a,loadedLibraries:l,importLibrary:c};return Pn(fp.Provider,{value:u,get children(){return n.children}})};function n0(){return Jv(fp)?.status||(()=>Vi.NOT_LOADED)}function E1(){const n=n0();return()=>n()===Vi.LOADED}var Zh=class{static entries={};static has(n){return this.entries[n]&&this.entries[n].length>0}static pop(n){return this.entries[n]&&this.entries[n].pop()||null}static push(n,t){this.entries[n]||(this.entries[n]=[]),this.entries[n].push(t)}};function w1(n,t){const e=E1(),[r,i]=ve(null),[s,o]=ve(),a=m1(r),[l,c]=mh(n,["id","defaultBounds","defaultCenter","defaultZoom","defaultHeading","defaultTilt","reuseMaps","renderingType","colorScheme"]),u=()=>c.zoom!==void 0||l.defaultZoom!==void 0,h=()=>c.center!==void 0||l.defaultCenter!==void 0;Jn(()=>{!l.defaultBounds&&(!u()||!h())&&console.warn("<Map> component is missing configuration. You have to provide zoom and center (via the `zoom`/`defaultZoom` and `center`/`defaultCenter` props) or specify the region to show using `defaultBounds`. See https://visgl.github.io/react-google-maps/docs/api-reference/components/map#required")});const[f,d]=ve(null),p=yn(()=>l.id),_=yn(()=>c.mapId),v=yn(()=>l.renderingType),E=yn(()=>l.colorScheme);return Jn(tc(()=>({container:s(),apiIsLoaded:e(),id:p(),mapId:_(),renderingType:v(),colorScheme:E()}),m=>{if(!m.container||!m.apiIsLoaded)return;const{addMapInstance:g,removeMapInstance:y}=t,b={...c,center:c.center||l.defaultCenter,zoom:c.zoom||l.defaultZoom,heading:c.heading||l.defaultHeading,tilt:c.tilt||l.defaultTilt},x=`${m.mapId||"default"}:${m.renderingType||"default"}:${m.colorScheme||"LIGHT"}`;let w,S;if(l.reuseMaps&&Zh.has(x)?(S=Zh.pop(x),w=S.getDiv(),m.container.appendChild(w),S.setOptions(b),setTimeout(()=>{const I=S.getCenter();I&&S.setCenter(I)},0)):(w=document.createElement("div"),w.style.height="100%",m.container.appendChild(w),S=new google.maps.Map(w,{...b,...m.renderingType?{renderingType:m.renderingType}:{},...m.colorScheme?{colorScheme:m.colorScheme}:{}})),i(S),g(S,m.id),l.defaultBounds){const{padding:I,...T}=l.defaultBounds;S.fitBounds(T,I)}else(!u()||!h())&&S.fitBounds({east:180,west:-180,south:-90,north:90});if(f()){const{mapId:I,cameraState:T}=f();I!==m.mapId&&S.setOptions(T)}xs(()=>{d({mapId:m.mapId,cameraState:a()}),w.remove(),l.reuseMaps?Zh.push(x,S):google.maps.event.clearInstanceListeners(S),i(null),y(m.id)})})),[r,o,a]}var S1=new Set(["backgroundColor","clickableIcons","controlSize","disableDefaultUI","disableDoubleClickZoom","draggable","draggableCursor","draggingCursor","fullscreenControl","fullscreenControlOptions","gestureHandling","headingInteractionEnabled","isFractionalZoomEnabled","keyboardShortcuts","mapTypeControl","mapTypeControlOptions","mapTypeId","maxZoom","minZoom","noClear","panControl","panControlOptions","restriction","rotateControl","rotateControlOptions","scaleControl","scaleControlOptions","scrollwheel","streetView","streetViewControl","streetViewControlOptions","styles","tiltInteractionEnabled","zoomControl","zoomControlOptions"]);function C1(n,t){const e=yn(()=>{const r={},i=Object.keys(t);for(const s of i)S1.has(s)&&(r[s]=t[s]);return r});Jn(()=>{n()&&n().setOptions(e())})}var T1=Bn("<div><h2>Error: AuthFailure</h2><p>A problem with your API key prevents the map from rendering correctly. Please make sure the value of the <code>APIProvider.apiKey</code> prop is correct. Check the error-message in the console for further details."),P1=()=>{const n={position:"absolute",top:0,left:0,bottom:0,right:0,"z-index":999,display:"flex","flex-flow":"column nowrap","text-align":"center","justify-content":"center","font-size":".8rem",color:"rgba(0,0,0,0.6)",background:"#dddddd",padding:"1rem 1.5rem"};return(()=>{var t=Tn(T1);return Qv(t,n),t})()};function I1(n,t){const e=()=>!!t.viewport;return Jn(()=>{if(!n()||!t.viewState)return;const{latitude:r,longitude:i,bearing:s,pitch:o,zoom:a}=t.viewState;n().moveCamera({center:{lat:r,lng:i},heading:s,tilt:o,zoom:a+1})}),e}var A1=Zv(null),M1=Bn("<div>"),R1=Bn("<div data-testid=map>"),r0=n=>{const t=Jv(fp),e=n0(),[r,i]=mh(n,["children","class","style"]);if(!t)throw new Error("<Map> can only be used inside an <ApiProvider> component.");const[s,o,a]=w1(i,t);c1(s,a,i),u1(s,i),C1(s,i);const l=I1(s,i),c=()=>!!i.controlled;Jn(()=>{i.ref?.(s()),xs(()=>{i.ref?.(null)})}),Jn(()=>{const p=s();p&&(l()&&p.setOptions({disableDefaultUI:!0}),(l()||c())&&p.setOptions({gestureHandling:"none",keyboardShortcuts:!1}),xs(()=>{p.setOptions({gestureHandling:i.gestureHandling,keyboardShortcuts:i.keyboardShortcuts})}))});const u=()=>i.center?t0(i.center):null,h=yn(()=>{let p=null,_=null;return u()&&Number.isFinite(u().lat)&&Number.isFinite(u().lng)&&(p=u().lat,_=u().lng),{lat:p,lng:_}}),f=yn(()=>({center:{lat:h().lat??0,lng:h().lng??0},zoom:i.zoom??0,heading:i.heading??0,tilt:i.tilt??0}));Jn(()=>{const p=s();if(!p||!c())return;p.moveCamera(f());const _=p.addListener("bounds_changed",()=>{p.moveCamera(f())});xs(()=>_.remove())});const d=yn(()=>({width:"100%",height:"100%",position:"relative","z-index":l()?-1:0,...r.style}));return Pn(_l,{get when(){return e()===Vi.AUTH_FAILURE},get fallback(){return Pn(A1.Provider,{value:{map:s},get children(){return[(()=>{var p=Tn(R1);return r1(o,p),i1(p,s1({get style(){return Tl(()=>!!r.class)()?void 0:d()},get class(){return r.class}},()=>i.id?{id:i.id}:{}),!1,!1),gi(),p})(),Pn(_l,{get when(){return s()},get children(){return r.children}})]}})},get children(){var p=Tn(M1);return wu(p,Pn(P1,{})),e1(_=>{var v={position:"relative",...r.class?{}:d()},E=r.class;return _.e=Qv(p,v,_.e),E!==_.t&&n1(p,_.t=E),_},{e:void 0,t:void 0}),p}})};r0.deckGLViewProps=!0;var N1=Bn("<div>DONE");const O1=n=>{let t;const e=[Tn(N1),Tl(()=>n.children)];Jn(()=>{r()}),xs(()=>{t?(t.toggleDOM(n.gmapref),t.setMap(null),t=null):console.log("[BBT GIS] Cannot Cleanup. Overlay not initialized yet")});const r=()=>{const s=new n.googleref.maps.LatLngBounds(new n.googleref.maps.LatLng(n.latitude,n.longitude),new n.googleref.maps.LatLng(n.latitude+.2,n.longitude+.2)),o=i(n.googleref),a=new o(e,s);t=a,a.setMap(n.gmapref)},i=s=>{class o extends s.maps.OverlayView{bounds;div;content;constructor(l,c){super(),this.bounds=c,this.content=l}onAdd(){this.div=document.createElement("div"),this.div.style.borderStyle="none",this.div.style.borderWidth="0px",this.div.style.position="absolute",this.div.style.pointerEvents="none",this.div.appendChild(this.content[1]()),this.getPanes().overlayMouseTarget.appendChild(this.div)}draw(){const l=this.getProjection(),c=l.fromLatLngToDivPixel(this.bounds.getSouthWest()),u=l.fromLatLngToDivPixel(this.bounds.getNorthEast());this.div&&(this.div.style.left=c.x+"0px",this.div.style.top=u.y+"0px",this.div.style.width=u.x-c.x+"px",this.div.style.height=c.y-u.y+"px")}onRemove(){this.div&&(this.div.parentNode.removeChild(this.div),delete this.div)}hide(){this.div&&(this.div.style.visibility="hidden")}show(){this.div&&(this.div.style.visibility="visible")}toggle(){this.div&&(this.div.style.visibility==="hidden"?this.show():this.hide())}toggleDOM(l){this.getMap()?this.setMap(null):this.setMap(l)}}return o};return[]};function Su(n,t){if(!n)throw new Error(t||"loader assertion failed.")}const dp=!!(typeof process!="object"||String(process)!=="[object process]"||process.browser),Hg=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);Hg&&parseFloat(Hg[1]);const jg=globalThis,$g=globalThis.process||{},D1=globalThis.navigator||{};function i0(n){if(typeof window<"u"&&window.process?.type==="renderer"||typeof process<"u"&&process.versions?.electron)return!0;const e=typeof navigator<"u"&&navigator.userAgent;return!!(e&&e.indexOf("Electron")>=0)}function To(){return!(typeof process=="object"&&String(process)==="[object process]"&&!process?.browser)||i0()}function L1(n){return To()?i0()?"Electron":(D1.userAgent||"").indexOf("Edge")>-1?"Edge":globalThis.chrome?"Chrome":globalThis.safari?"Safari":globalThis.mozInnerScreenX?"Firefox":"Unknown":"Node"}const s0="4.1.0";function k1(n){try{const t=window[n],e="__storage_test__";return t.setItem(e,e),t.removeItem(e),t}catch{return null}}class F1{constructor(t,e,r="sessionStorage"){this.storage=k1(r),this.id=t,this.config=e,this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(t){if(Object.assign(this.config,t),this.storage){const e=JSON.stringify(this.config);this.storage.setItem(this.id,e)}}_loadConfiguration(){let t={};if(this.storage){const e=this.storage.getItem(this.id);t=e?JSON.parse(e):{}}return Object.assign(this.config,t),this}}function B1(n){let t;return n<10?t=`${n.toFixed(2)}ms`:n<100?t=`${n.toFixed(1)}ms`:n<1e3?t=`${n.toFixed(0)}ms`:t=`${(n/1e3).toFixed(2)}s`,t}function U1(n,t=8){const e=Math.max(t-n.length,0);return`${" ".repeat(e)}${n}`}var Cu;(function(n){n[n.BLACK=30]="BLACK",n[n.RED=31]="RED",n[n.GREEN=32]="GREEN",n[n.YELLOW=33]="YELLOW",n[n.BLUE=34]="BLUE",n[n.MAGENTA=35]="MAGENTA",n[n.CYAN=36]="CYAN",n[n.WHITE=37]="WHITE",n[n.BRIGHT_BLACK=90]="BRIGHT_BLACK",n[n.BRIGHT_RED=91]="BRIGHT_RED",n[n.BRIGHT_GREEN=92]="BRIGHT_GREEN",n[n.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",n[n.BRIGHT_BLUE=94]="BRIGHT_BLUE",n[n.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",n[n.BRIGHT_CYAN=96]="BRIGHT_CYAN",n[n.BRIGHT_WHITE=97]="BRIGHT_WHITE"})(Cu||(Cu={}));const V1=10;function Xg(n){return typeof n!="string"?n:(n=n.toUpperCase(),Cu[n]||Cu.WHITE)}function z1(n,t,e){return!To&&typeof n=="string"&&(t&&(n=`\x1B[${Xg(t)}m${n}\x1B[39m`),e&&(n=`\x1B[${Xg(e)+V1}m${n}\x1B[49m`)),n}function W1(n,t=["constructor"]){const e=Object.getPrototypeOf(n),r=Object.getOwnPropertyNames(e),i=n;for(const s of r){const o=i[s];typeof o=="function"&&(t.find(a=>s===a)||(i[s]=o.bind(n)))}}function pp(n,t){if(!n)throw new Error("Assertion failed")}function Uo(){let n;if(To()&&jg.performance)n=jg?.performance?.now?.();else if("hrtime"in $g){const t=$g?.hrtime?.();n=t[0]*1e3+t[1]/1e6}else n=Date.now();return n}const Vo={debug:To()&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},H1={enabled:!0,level:0};function zo(){}const Gg={},Yg={once:!0};class ec{constructor({id:t}={id:""}){this.VERSION=s0,this._startTs=Uo(),this._deltaTs=Uo(),this.userData={},this.LOG_THROTTLE_TIMEOUT=0,this.id=t,this.userData={},this._storage=new F1(`__probe-${this.id}__`,H1),this.timeStamp(`${this.id} started`),W1(this),Object.seal(this)}set level(t){this.setLevel(t)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((Uo()-this._startTs).toPrecision(10))}getDelta(){return Number((Uo()-this._deltaTs).toPrecision(10))}set priority(t){this.level=t}get priority(){return this.level}getPriority(){return this.level}enable(t=!0){return this._storage.setConfiguration({enabled:t}),this}setLevel(t){return this._storage.setConfiguration({level:t}),this}get(t){return this._storage.config[t]}set(t,e){this._storage.setConfiguration({[t]:e})}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}assert(t,e){if(!t)throw new Error(e||"Assertion failed")}warn(t){return this._getLogFunction(0,t,Vo.warn,arguments,Yg)}error(t){return this._getLogFunction(0,t,Vo.error,arguments)}deprecated(t,e){return this.warn(`\`${t}\` is deprecated and will be removed in a later version. Use \`${e}\` instead`)}removed(t,e){return this.error(`\`${t}\` has been removed. Use \`${e}\` instead`)}probe(t,e){return this._getLogFunction(t,e,Vo.log,arguments,{time:!0,once:!0})}log(t,e){return this._getLogFunction(t,e,Vo.debug,arguments)}info(t,e){return this._getLogFunction(t,e,console.info,arguments)}once(t,e){return this._getLogFunction(t,e,Vo.debug||Vo.info,arguments,Yg)}table(t,e,r){return e?this._getLogFunction(t,e,console.table||zo,r&&[r],{tag:$1(e)}):zo}time(t,e){return this._getLogFunction(t,e,console.time?console.time:console.info)}timeEnd(t,e){return this._getLogFunction(t,e,console.timeEnd?console.timeEnd:console.info)}timeStamp(t,e){return this._getLogFunction(t,e,console.timeStamp||zo)}group(t,e,r={collapsed:!1}){const i=qg({logLevel:t,message:e,opts:r}),{collapsed:s}=r;return i.method=(s?console.groupCollapsed:console.group)||console.info,this._getLogFunction(i)}groupCollapsed(t,e,r={}){return this.group(t,e,Object.assign({},r,{collapsed:!0}))}groupEnd(t){return this._getLogFunction(t,"",console.groupEnd||zo)}withGroup(t,e,r){this.group(t,e)();try{r()}finally{this.groupEnd(t)()}}trace(){console.trace&&console.trace()}_shouldLog(t){return this.isEnabled()&&this.getLevel()>=o0(t)}_getLogFunction(t,e,r,i,s){if(this._shouldLog(t)){s=qg({logLevel:t,message:e,args:i,opts:s}),r=r||s.method,pp(r),s.total=this.getTotal(),s.delta=this.getDelta(),this._deltaTs=Uo();const o=s.tag||s.message;if(s.once&&o)if(!Gg[o])Gg[o]=Uo();else return zo;return e=j1(this.id,s.message,s),r.bind(console,e,...s.args)}return zo}}ec.VERSION=s0;function o0(n){if(!n)return 0;let t;switch(typeof n){case"number":t=n;break;case"object":t=n.logLevel||n.priority||0;break;default:return 0}return pp(Number.isFinite(t)&&t>=0),t}function qg(n){const{logLevel:t,message:e}=n;n.logLevel=o0(t);const r=n.args?Array.from(n.args):[];for(;r.length&&r.shift()!==e;);switch(typeof t){case"string":case"function":e!==void 0&&r.unshift(e),n.message=t;break;case"object":Object.assign(n,t);break}typeof n.message=="function"&&(n.message=n.message());const i=typeof n.message;return pp(i==="string"||i==="object"),Object.assign(n,{args:r},n.opts)}function j1(n,t,e){if(typeof t=="string"){const r=e.time?U1(B1(e.total)):"";t=e.time?`${n}: ${r}  ${t}`:`${n}: ${t}`,t=z1(t,e.color,e.background)}return t}function $1(n){for(const t in n)for(const e in n[t])return e||"untitled";return"empty"}const Jh="4.3.3",X1=Jh[0]>="0"&&Jh[0]<="9"?`v${Jh}`:"";function G1(){const n=new ec({id:"loaders.gl"});return globalThis.loaders=globalThis.loaders||{},globalThis.loaders.log=n,globalThis.loaders.version=X1,globalThis.probe=globalThis.probe||{},globalThis.probe.loaders=n,n}const Y1=G1();function q1(n,t){return a0(n||{},t)}function a0(n,t,e=0){if(e>3)return t;const r={...n};for(const[i,s]of Object.entries(t))s&&typeof s=="object"&&!Array.isArray(s)?r[i]=a0(r[i]||{},t[i],e+1):r[i]=t[i];return r}const K1="latest";function Z1(){return globalThis._loadersgl_?.version||(globalThis._loadersgl_=globalThis._loadersgl_||{},globalThis._loadersgl_.version="4.3.3"),globalThis._loadersgl_.version}const J1=Z1();function As(n,t){if(!n)throw new Error(t||"loaders.gl assertion failed.")}const to=typeof process!="object"||String(process)!=="[object process]"||process.browser,Q1=typeof window<"u"&&typeof window.orientation<"u",Kg=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);Kg&&parseFloat(Kg[1]);class tS{name;workerThread;isRunning=!0;result;_resolve=()=>{};_reject=()=>{};constructor(t,e){this.name=t,this.workerThread=e,this.result=new Promise((r,i)=>{this._resolve=r,this._reject=i})}postMessage(t,e){this.workerThread.postMessage({source:"loaders.gl",type:t,payload:e})}done(t){As(this.isRunning),this.isRunning=!1,this._resolve(t)}error(t){As(this.isRunning),this.isRunning=!1,this._reject(t)}}class Qh{terminate(){}}const tf=new Map;function eS(n){As(n.source&&!n.url||!n.source&&n.url);let t=tf.get(n.source||n.url);return t||(n.url&&(t=nS(n.url),tf.set(n.url,t)),n.source&&(t=l0(n.source),tf.set(n.source,t))),As(t),t}function nS(n){if(!n.startsWith("http"))return n;const t=rS(n);return l0(t)}function l0(n){const t=new Blob([n],{type:"application/javascript"});return URL.createObjectURL(t)}function rS(n){return`try {
  importScripts('${n}');
} catch (error) {
  console.error(error);
  throw error;
}`}function c0(n,t=!0,e){const r=e||new Set;if(n){if(Zg(n))r.add(n);else if(Zg(n.buffer))r.add(n.buffer);else if(!ArrayBuffer.isView(n)){if(t&&typeof n=="object")for(const i in n)c0(n[i],t,r)}}return e===void 0?Array.from(r):[]}function Zg(n){return n?n instanceof ArrayBuffer||typeof MessagePort<"u"&&n instanceof MessagePort||typeof ImageBitmap<"u"&&n instanceof ImageBitmap||typeof OffscreenCanvas<"u"&&n instanceof OffscreenCanvas:!1}const ef=()=>{};class od{name;source;url;terminated=!1;worker;onMessage;onError;_loadableURL="";static isSupported(){return typeof Worker<"u"&&to||typeof Qh<"u"&&!to}constructor(t){const{name:e,source:r,url:i}=t;As(r||i),this.name=e,this.source=r,this.url=i,this.onMessage=ef,this.onError=s=>console.log(s),this.worker=to?this._createBrowserWorker():this._createNodeWorker()}destroy(){this.onMessage=ef,this.onError=ef,this.worker.terminate(),this.terminated=!0}get isRunning(){return!!this.onMessage}postMessage(t,e){e=e||c0(t),this.worker.postMessage(t,e)}_getErrorFromErrorEvent(t){let e="Failed to load ";return e+=`worker ${this.name} from ${this.url}. `,t.message&&(e+=`${t.message} in `),t.lineno&&(e+=`:${t.lineno}:${t.colno}`),new Error(e)}_createBrowserWorker(){this._loadableURL=eS({source:this.source,url:this.url});const t=new Worker(this._loadableURL,{name:this.name});return t.onmessage=e=>{e.data?this.onMessage(e.data):this.onError(new Error("No data received"))},t.onerror=e=>{this.onError(this._getErrorFromErrorEvent(e)),this.terminated=!0},t.onmessageerror=e=>console.error(e),t}_createNodeWorker(){let t;if(this.url){const r=this.url.includes(":/")||this.url.startsWith("/")?this.url:`./${this.url}`;t=new Qh(r,{eval:!1})}else if(this.source)t=new Qh(this.source,{eval:!0});else throw new Error("no worker");return t.on("message",e=>{this.onMessage(e)}),t.on("error",e=>{this.onError(e)}),t.on("exit",e=>{}),t}}class iS{name="unnamed";source;url;maxConcurrency=1;maxMobileConcurrency=1;onDebug=()=>{};reuseWorkers=!0;props={};jobQueue=[];idleQueue=[];count=0;isDestroyed=!1;static isSupported(){return od.isSupported()}constructor(t){this.source=t.source,this.url=t.url,this.setProps(t)}destroy(){this.idleQueue.forEach(t=>t.destroy()),this.isDestroyed=!0}setProps(t){this.props={...this.props,...t},t.name!==void 0&&(this.name=t.name),t.maxConcurrency!==void 0&&(this.maxConcurrency=t.maxConcurrency),t.maxMobileConcurrency!==void 0&&(this.maxMobileConcurrency=t.maxMobileConcurrency),t.reuseWorkers!==void 0&&(this.reuseWorkers=t.reuseWorkers),t.onDebug!==void 0&&(this.onDebug=t.onDebug)}async startJob(t,e=(i,s,o)=>i.done(o),r=(i,s)=>i.error(s)){const i=new Promise(s=>(this.jobQueue.push({name:t,onMessage:e,onError:r,onStart:s}),this));return this._startQueuedJob(),await i}async _startQueuedJob(){if(!this.jobQueue.length)return;const t=this._getAvailableWorker();if(!t)return;const e=this.jobQueue.shift();if(e){this.onDebug({message:"Starting job",name:e.name,workerThread:t,backlog:this.jobQueue.length});const r=new tS(e.name,t);t.onMessage=i=>e.onMessage(r,i.type,i.payload),t.onError=i=>e.onError(r,i),e.onStart(r);try{await r.result}catch(i){console.error(`Worker exception: ${i}`)}finally{this.returnWorkerToQueue(t)}}}returnWorkerToQueue(t){!to||this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(t.destroy(),this.count--):this.idleQueue.push(t),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;const t=`${this.name.toLowerCase()} (#${this.count} of ${this.maxConcurrency})`;return new od({name:t,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return Q1?this.maxMobileConcurrency:this.maxConcurrency}}const sS={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}};class fs{props;workerPools=new Map;static _workerFarm;static isSupported(){return od.isSupported()}static getWorkerFarm(t={}){return fs._workerFarm=fs._workerFarm||new fs({}),fs._workerFarm.setProps(t),fs._workerFarm}constructor(t){this.props={...sS},this.setProps(t),this.workerPools=new Map}destroy(){for(const t of this.workerPools.values())t.destroy();this.workerPools=new Map}setProps(t){this.props={...this.props,...t};for(const e of this.workerPools.values())e.setProps(this._getWorkerPoolProps())}getWorkerPool(t){const{name:e,source:r,url:i}=t;let s=this.workerPools.get(e);return s||(s=new iS({name:e,source:r,url:i}),s.setProps(this._getWorkerPoolProps()),this.workerPools.set(e,s)),s}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}}function oS(n,t={}){const e=t[n.id]||{},r=to?`${n.id}-worker.js`:`${n.id}-worker-node.js`;let i=e.workerUrl;if(!i&&n.id==="compression"&&(i=t.workerUrl),t._workerType==="test"&&(to?i=`modules/${n.module}/dist/${r}`:i=`modules/${n.module}/src/workers/${n.id}-worker-node.ts`),!i){let s=n.version;s==="latest"&&(s=K1);const o=s?`@${s}`:"";i=`https://unpkg.com/@loaders.gl/${n.module}${o}/dist/${r}`}return As(i),i}function aS(n,t=J1){As(n,"no worker provided");const e=n.version;return!(!t||!e)}function lS(n,t){return!fs.isSupported()||!to&&!t?._nodeWorkers?!1:n.worker&&t?.worker}async function cS(n,t,e,r,i){const s=n.id,o=oS(n,e),l=fs.getWorkerFarm(e).getWorkerPool({name:s,url:o});e=JSON.parse(JSON.stringify(e)),r=JSON.parse(JSON.stringify(r||{}));const c=await l.startJob("process-on-worker",uS.bind(null,i));return c.postMessage("process",{input:t,options:e,context:r}),await(await c.result).result}async function uS(n,t,e,r){switch(e){case"done":t.done(r);break;case"error":t.error(new Error(r.error));break;case"process":const{id:i,input:s,options:o}=r;try{const a=await n(s,o);t.postMessage("done",{id:i,result:a})}catch(a){const l=a instanceof Error?a.message:"unknown error";t.postMessage("error",{id:i,error:l})}break;default:console.warn(`parse-with-worker unknown message ${e}`)}}function hS(n,t,e){if(e=e||n.byteLength,n.byteLength<e||t.byteLength<e)return!1;const r=new Uint8Array(n),i=new Uint8Array(t);for(let s=0;s<r.length;++s)if(r[s]!==i[s])return!1;return!0}function fS(...n){return dS(n)}function dS(n){const t=n.map(s=>s instanceof ArrayBuffer?new Uint8Array(s):s),e=t.reduce((s,o)=>s+o.byteLength,0),r=new Uint8Array(e);let i=0;for(const s of t)r.set(s,i),i+=s.byteLength;return r.buffer}async function pS(n){const t=[];for await(const e of n)t.push(e);return fS(...t)}function Jg(){let n;if(typeof window<"u"&&window.performance)n=window.performance.now();else if(typeof process<"u"&&process.hrtime){const t=process.hrtime();n=t[0]*1e3+t[1]/1e6}else n=Date.now();return n}class Qg{constructor(t,e){this.sampleSize=1,this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this.name=t,this.type=e,this.reset()}reset(){return this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this}setSampleSize(t){return this.sampleSize=t,this}incrementCount(){return this.addCount(1),this}decrementCount(){return this.subtractCount(1),this}addCount(t){return this._count+=t,this._samples++,this._checkSampling(),this}subtractCount(t){return this._count-=t,this._samples++,this._checkSampling(),this}addTime(t){return this._time+=t,this.lastTiming=t,this._samples++,this._checkSampling(),this}timeStart(){return this._startTime=Jg(),this._timerPending=!0,this}timeEnd(){return this._timerPending?(this.addTime(Jg()-this._startTime),this._timerPending=!1,this._checkSampling(),this):this}getSampleAverageCount(){return this.sampleSize>0?this.lastSampleCount/this.sampleSize:0}getSampleAverageTime(){return this.sampleSize>0?this.lastSampleTime/this.sampleSize:0}getSampleHz(){return this.lastSampleTime>0?this.sampleSize/(this.lastSampleTime/1e3):0}getAverageCount(){return this.samples>0?this.count/this.samples:0}getAverageTime(){return this.samples>0?this.time/this.samples:0}getHz(){return this.time>0?this.samples/(this.time/1e3):0}_checkSampling(){this._samples===this.sampleSize&&(this.lastSampleTime=this._time,this.lastSampleCount=this._count,this.count+=this._count,this.time+=this._time,this.samples+=this._samples,this._time=0,this._count=0,this._samples=0)}}class yh{constructor(t){this.stats={},this.id=t.id,this.stats={},this._initializeStats(t.stats),Object.seal(this)}get(t,e="count"){return this._getOrCreate({name:t,type:e})}get size(){return Object.keys(this.stats).length}reset(){for(const t of Object.values(this.stats))t.reset();return this}forEach(t){for(const e of Object.values(this.stats))t(e)}getTable(){const t={};return this.forEach(e=>{t[e.name]={time:e.time||0,count:e.count||0,average:e.getAverageTime()||0,hz:e.getHz()||0}}),t}_initializeStats(t=[]){t.forEach(e=>this._getOrCreate(e))}_getOrCreate(t){const{name:e,type:r}=t;let i=this.stats[e];return i||(t instanceof Qg?i=t:i=new Qg(e,r),this.stats[e]=i),i}}let gS="";const tm={};function mS(n){for(const t in tm)if(n.startsWith(t)){const e=tm[t];n=n.replace(t,e)}return!n.startsWith("http://")&&!n.startsWith("https://")&&(n=`${gS}${n}`),n}function _S(n){return n&&typeof n=="object"&&n.isBuffer}function u0(n){if(_S(n))return n;if(n instanceof ArrayBuffer)return n;if(ArrayBuffer.isView(n))return n.byteOffset===0&&n.byteLength===n.buffer.byteLength?n.buffer:n.buffer.slice(n.byteOffset,n.byteOffset+n.byteLength);if(typeof n=="string"){const t=n;return new TextEncoder().encode(t).buffer}if(n&&typeof n=="object"&&n._toArrayBuffer)return n._toArrayBuffer();throw new Error("toArrayBuffer")}function h0(n){const t=n?n.lastIndexOf("/"):-1;return t>=0?n.substr(t+1):""}function yS(n){const t=n?n.lastIndexOf("/"):-1;return t>=0?n.substr(0,t):""}const vS=n=>typeof n=="boolean",yl=n=>typeof n=="function",nc=n=>n!==null&&typeof n=="object",em=n=>nc(n)&&n.constructor==={}.constructor,bS=n=>!!n&&typeof n[Symbol.iterator]=="function",xS=n=>n&&typeof n[Symbol.asyncIterator]=="function",Po=n=>typeof Response<"u"&&n instanceof Response||n&&n.arrayBuffer&&n.text&&n.json,Io=n=>typeof Blob<"u"&&n instanceof Blob,ES=n=>n&&typeof n=="object"&&n.isBuffer,wS=n=>typeof ReadableStream<"u"&&n instanceof ReadableStream||nc(n)&&yl(n.tee)&&yl(n.cancel)&&yl(n.getReader),SS=n=>nc(n)&&yl(n.read)&&yl(n.pipe)&&vS(n.readable),f0=n=>wS(n)||SS(n);class CS extends Error{constructor(t,e){super(t),this.reason=e.reason,this.url=e.url,this.response=e.response}reason;url;response}const TS=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,PS=/^([-\w.]+\/[-\w.+]+)/;function nm(n,t){return n.toLowerCase()===t.toLowerCase()}function IS(n){const t=PS.exec(n);return t?t[1]:n}function rm(n){const t=TS.exec(n);return t?t[1]:""}const d0=/\?.*/;function AS(n){const t=n.match(d0);return t&&t[0]}function gp(n){return n.replace(d0,"")}function MS(n){if(n.length<50)return n;const t=n.slice(n.length-15);return`${n.substr(0,32)}...${t}`}function vh(n){return Po(n)?n.url:Io(n)?n.name||"":typeof n=="string"?n:""}function mp(n){if(Po(n)){const t=n,e=t.headers.get("content-type")||"",r=gp(t.url);return IS(e)||rm(r)}return Io(n)?n.type||"":typeof n=="string"?rm(n):""}function RS(n){return Po(n)?n.headers["content-length"]||-1:Io(n)?n.size:typeof n=="string"?n.length:n instanceof ArrayBuffer||ArrayBuffer.isView(n)?n.byteLength:-1}async function p0(n){if(Po(n))return n;const t={},e=RS(n);e>=0&&(t["content-length"]=String(e));const r=vh(n),i=mp(n);i&&(t["content-type"]=i);const s=await DS(n);s&&(t["x-first-bytes"]=s),typeof n=="string"&&(n=new TextEncoder().encode(n));const o=new Response(n,{headers:t});return Object.defineProperty(o,"url",{value:r}),o}async function NS(n){if(!n.ok)throw await OS(n)}async function OS(n){const t=MS(n.url);let e=`Failed to fetch resource (${n.status}) ${n.statusText}: ${t}`;e=e.length>100?`${e.slice(0,100)}...`:e;const r={reason:n.statusText,url:n.url,response:n};try{const i=n.headers.get("Content-Type");r.reason=!n.bodyUsed&&i?.includes("application/json")?await n.json():await n.text()}catch{}return new CS(e,r)}async function DS(n){if(typeof n=="string")return`data:,${n.slice(0,5)}`;if(n instanceof Blob){const e=n.slice(0,5);return await new Promise(r=>{const i=new FileReader;i.onload=s=>r(s?.target?.result),i.readAsDataURL(e)})}if(n instanceof ArrayBuffer){const e=n.slice(0,5);return`data:base64,${LS(e)}`}return null}function LS(n){let t="";const e=new Uint8Array(n);for(let r=0;r<e.byteLength;r++)t+=String.fromCharCode(e[r]);return btoa(t)}function kS(n){return!FS(n)&&!BS(n)}function FS(n){return n.startsWith("http:")||n.startsWith("https:")}function BS(n){return n.startsWith("data:")}async function im(n,t){if(typeof n=="string"){const e=mS(n);return kS(e)&&globalThis.loaders?.fetchNode?globalThis.loaders?.fetchNode(e,t):await fetch(e,t)}return await p0(n)}const sm=new ec({id:"loaders.gl"});class US{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}}class VS{console;constructor(){this.console=console}log(...t){return this.console.log.bind(this.console,...t)}info(...t){return this.console.info.bind(this.console,...t)}warn(...t){return this.console.warn.bind(this.console,...t)}error(...t){return this.console.error.bind(this.console,...t)}}const g0={fetch:null,mimeType:void 0,nothrow:!1,log:new VS,useLocalLibraries:!1,CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:dp,_nodeWorkers:!1,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},zS={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function m0(){globalThis.loaders=globalThis.loaders||{};const{loaders:n}=globalThis;return n._state||(n._state={}),n._state}function _0(){const n=m0();return n.globalOptions=n.globalOptions||{...g0},n.globalOptions}function WS(n,t,e,r){return e=e||[],e=Array.isArray(e)?e:[e],HS(n,e),$S(t,n,r)}function HS(n,t){om(n,null,g0,zS,t);for(const e of t){const r=n&&n[e.id]||{},i=e.options&&e.options[e.id]||{},s=e.deprecatedOptions&&e.deprecatedOptions[e.id]||{};om(r,e.id,i,s,t)}}function om(n,t,e,r,i){const s=t||"Top level",o=t?`${t}.`:"";for(const a in n){const l=!t&&nc(n[a]),c=a==="baseUri"&&!t,u=a==="workerUrl"&&t;if(!(a in e)&&!c&&!u){if(a in r)sm.warn(`${s} loader option '${o}${a}' no longer supported, use '${r[a]}'`)();else if(!l){const h=jS(a,i);sm.warn(`${s} loader option '${o}${a}' not recognized. ${h}`)()}}}}function jS(n,t){const e=n.toLowerCase();let r="";for(const i of t)for(const s in i.options){if(n===s)return`Did you mean '${i.id}.${s}'?`;const o=s.toLowerCase();(e.startsWith(o)||o.startsWith(e))&&(r=r||`Did you mean '${i.id}.${s}'?`)}return r}function $S(n,t,e){const i={...n.options||{}};return XS(i,e),i.log===null&&(i.log=new US),am(i,_0()),am(i,t),i}function am(n,t){for(const e in t)if(e in t){const r=t[e];em(r)&&em(n[e])?n[e]={...n[e],...t[e]}:n[e]=t[e]}}function XS(n,t){t&&!("baseUri"in n)&&(n.baseUri=t)}function _p(n){return n?(Array.isArray(n)&&(n=n[0]),Array.isArray(n?.extensions)):!1}function yp(n){Su(n,"null loader"),Su(_p(n),"invalid loader");let t;return Array.isArray(n)&&(t=n[1],n=n[0],n={...n,options:{...n.options,...t}}),(n?.parseTextSync||n?.parseText)&&(n.text=!0),n.text||(n.binary=!0),n}const y0=()=>{const n=m0();return n.loaderRegistry=n.loaderRegistry||[],n.loaderRegistry};function GS(n){const t=y0();n=Array.isArray(n)?n:[n];for(const e of n){const r=yp(e);t.find(i=>r===i)||t.unshift(r)}}function YS(){return y0()}const qS=/\.([^.]+)$/;async function KS(n,t=[],e,r){if(!v0(n))return null;let i=lm(n,t,{...e,nothrow:!0},r);if(i)return i;if(Io(n)&&(n=await n.slice(0,10).arrayBuffer(),i=lm(n,t,e,r)),!i&&!e?.nothrow)throw new Error(b0(n));return i}function lm(n,t=[],e,r){if(!v0(n))return null;if(t&&!Array.isArray(t))return yp(t);let i=[];t&&(i=i.concat(t)),e?.ignoreRegisteredLoaders||i.push(...YS()),JS(i);const s=ZS(n,i,e,r);if(!s&&!e?.nothrow)throw new Error(b0(n));return s}function ZS(n,t,e,r){const i=vh(n),s=mp(n),o=gp(i)||r?.url;let a=null,l="";return e?.mimeType&&(a=nf(t,e?.mimeType),l=`match forced by supplied MIME type ${e?.mimeType}`),a=a||QS(t,o),l=l||(a?`matched url ${o}`:""),a=a||nf(t,s),l=l||(a?`matched MIME type ${s}`:""),a=a||eC(t,n),l=l||(a?`matched initial data ${x0(n)}`:""),e?.fallbackMimeType&&(a=a||nf(t,e?.fallbackMimeType),l=l||(a?`matched fallback MIME type ${s}`:"")),l&&Y1.log(1,`selectLoader selected ${a?.name}: ${l}.`),a}function v0(n){return!(n instanceof Response&&n.status===204)}function b0(n){const t=vh(n),e=mp(n);let r="No valid loader found (";r+=t?`${h0(t)}, `:"no url provided, ",r+=`MIME type: ${e?`"${e}"`:"not provided"}, `;const i=n?x0(n):"";return r+=i?` first bytes: "${i}"`:"first bytes: not available",r+=")",r}function JS(n){for(const t of n)yp(t)}function QS(n,t){const e=t&&qS.exec(t),r=e&&e[1];return r?tC(n,r):null}function tC(n,t){t=t.toLowerCase();for(const e of n)for(const r of e.extensions)if(r.toLowerCase()===t)return e;return null}function nf(n,t){for(const e of n)if(e.mimeTypes?.some(r=>nm(t,r))||nm(t,`application/x.${e.id}`))return e;return null}function eC(n,t){if(!t)return null;for(const e of n)if(typeof t=="string"){if(nC(t,e))return e}else if(ArrayBuffer.isView(t)){if(cm(t.buffer,t.byteOffset,e))return e}else if(t instanceof ArrayBuffer&&cm(t,0,e))return e;return null}function nC(n,t){return t.testText?t.testText(n):(Array.isArray(t.tests)?t.tests:[t.tests]).some(r=>n.startsWith(r))}function cm(n,t,e){return(Array.isArray(e.tests)?e.tests:[e.tests]).some(i=>rC(n,t,e,i))}function rC(n,t,e,r){if(r instanceof ArrayBuffer)return hS(r,n,r.byteLength);switch(typeof r){case"function":return r(n);case"string":const i=ad(n,t,r.length);return r===i;default:return!1}}function x0(n,t=5){return typeof n=="string"?n.slice(0,t):ArrayBuffer.isView(n)?ad(n.buffer,n.byteOffset,t):n instanceof ArrayBuffer?ad(n,0,t):""}function ad(n,t,e){if(n.byteLength<t+e)return"";const r=new DataView(n);let i="";for(let s=0;s<e;s++)i+=String.fromCharCode(r.getUint8(t+s));return i}const iC=256*1024;function*sC(n,t){const e=t?.chunkSize||iC;let r=0;const i=new TextEncoder;for(;r<n.length;){const s=Math.min(n.length-r,e),o=n.slice(r,r+s);r+=s,yield i.encode(o)}}const oC=256*1024;function*aC(n,t={}){const{chunkSize:e=oC}=t;let r=0;for(;r<n.byteLength;){const i=Math.min(n.byteLength-r,e),s=new ArrayBuffer(i),o=new Uint8Array(n,r,i);new Uint8Array(s).set(o),r+=i,yield s}}const lC=1024*1024;async function*cC(n,t){const e=t?.chunkSize||lC;let r=0;for(;r<n.size;){const i=r+e,s=await n.slice(r,i).arrayBuffer();r=i,yield s}}function um(n,t){return dp?uC(n,t):hC(n)}async function*uC(n,t){const e=n.getReader();let r;try{for(;;){const i=r||e.read();t?._streamReadAhead&&(r=e.read());const{done:s,value:o}=await i;if(s)return;yield u0(o)}}catch{e.releaseLock()}}async function*hC(n,t){for await(const e of n)yield u0(e)}function fC(n,t){if(typeof n=="string")return sC(n,t);if(n instanceof ArrayBuffer)return aC(n,t);if(Io(n))return cC(n,t);if(f0(n))return um(n,t);if(Po(n))return um(n.body,t);throw new Error("makeIterator")}const E0="Cannot convert supplied data type";function dC(n,t,e){if(t.text&&typeof n=="string")return n;if(ES(n)&&(n=n.buffer),n instanceof ArrayBuffer){const r=n;return t.text&&!t.binary?new TextDecoder("utf8").decode(r):r}if(ArrayBuffer.isView(n)){if(t.text&&!t.binary)return new TextDecoder("utf8").decode(n);let r=n.buffer;const i=n.byteLength||n.length;return(n.byteOffset!==0||i!==r.byteLength)&&(r=r.slice(n.byteOffset,n.byteOffset+i)),r}throw new Error(E0)}async function pC(n,t,e){const r=n instanceof ArrayBuffer||ArrayBuffer.isView(n);if(typeof n=="string"||r)return dC(n,t);if(Io(n)&&(n=await p0(n)),Po(n)){const i=n;return await NS(i),t.binary?await i.arrayBuffer():await i.text()}if(f0(n)&&(n=fC(n,e)),bS(n)||xS(n))return pS(n);throw new Error(E0)}function w0(n,t){const e=_0(),r=n||e;return typeof r.fetch=="function"?r.fetch:nc(r.fetch)?i=>im(i,r.fetch):t?.fetch?t?.fetch:im}function gC(n,t,e){if(e)return e;const r={fetch:w0(t,n),...n};if(r.url){const i=gp(r.url);r.baseUrl=i,r.queryString=AS(r.url),r.filename=h0(i),r.baseUrl=yS(i)}return Array.isArray(r.loaders)||(r.loaders=null),r}function mC(n,t){if(n&&!Array.isArray(n))return n;let e;if(n&&(e=Array.isArray(n)?n:[n]),t&&t.loaders){const r=Array.isArray(t.loaders)?t.loaders:[t.loaders];e=e?[...e,...r]:r}return e&&e.length?e:void 0}async function Tu(n,t,e,r){t&&!Array.isArray(t)&&!_p(t)&&(r=void 0,e=t,t=void 0),n=await n,e=e||{};const i=vh(n),o=mC(t,r),a=await KS(n,o,e);return a?(e=WS(e,a,o,i),r=gC({url:i,_parse:Tu,loaders:o},e,r||null),await _C(a,n,e,r)):null}async function _C(n,t,e,r){if(aS(n),e=q1(n.options,e),Po(t)){const s=t,{ok:o,redirected:a,status:l,statusText:c,type:u,url:h}=s,f=Object.fromEntries(s.headers.entries());r.response={headers:f,ok:o,redirected:a,status:l,statusText:c,type:u,url:h}}t=await pC(t,n,e);const i=n;if(i.parseTextSync&&typeof t=="string")return i.parseTextSync(t,e,r);if(lS(n,e))return await cS(n,t,e,r,Tu);if(i.parseText&&typeof t=="string")return await i.parseText(t,e,r);if(i.parse)return await i.parse(t,e,r);throw As(!i.parseSync),new Error(`${n.id} loader - no parser found and worker is disabled`)}async function Pu(n,t,e,r){let i,s;!Array.isArray(t)&&!_p(t)?(i=[],s=t):(i=t,s=e);const o=w0(s);let a=n;return typeof n=="string"&&(a=await o(n)),Io(n)&&(a=await o(n)),Array.isArray(i)?await Tu(a,i,s):await Tu(a,i,s)}const yC="4.3.3",vC=globalThis.loaders?.parseImageNode,ld=typeof Image<"u",cd=typeof ImageBitmap<"u",bC=!!vC,ud=dp?!0:bC;function xC(n){switch(n){case"auto":return cd||ld||ud;case"imagebitmap":return cd;case"image":return ld;case"data":return ud;default:throw new Error(`@loaders.gl/images: image ${n} not supported in this environment`)}}function EC(){if(cd)return"imagebitmap";if(ld)return"image";if(ud)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}function wC(n){const t=CC(n);if(!t)throw new Error("Not an image");return t}function SC(n){switch(wC(n)){case"data":return n;case"image":case"imagebitmap":const t=document.createElement("canvas"),e=t.getContext("2d");if(!e)throw new Error("getImageData");return t.width=n.width,t.height=n.height,e.drawImage(n,0,0),e.getImageData(0,0,n.width,n.height);default:throw new Error("getImageData")}}function CC(n){return typeof ImageBitmap<"u"&&n instanceof ImageBitmap?"imagebitmap":typeof Image<"u"&&n instanceof Image?"image":n&&typeof n=="object"&&n.data&&n.width&&n.height?"data":null}const TC=/^data:image\/svg\+xml/,PC=/\.svg((\?|#).*)?$/;function vp(n){return n&&(TC.test(n)||PC.test(n))}function IC(n,t){if(vp(t)){let r=new TextDecoder().decode(n);try{typeof unescape=="function"&&typeof encodeURIComponent=="function"&&(r=unescape(encodeURIComponent(r)))}catch(s){throw new Error(s.message)}return`data:image/svg+xml;base64,${btoa(r)}`}return S0(n,t)}function S0(n,t){if(vp(t))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(n)])}async function C0(n,t,e){const r=IC(n,e),i=self.URL||self.webkitURL,s=typeof r!="string"&&i.createObjectURL(r);try{return await AC(s||r,t)}finally{s&&i.revokeObjectURL(s)}}async function AC(n,t){const e=new Image;return e.src=n,t.image&&t.image.decode&&e.decode?(await e.decode(),e):await new Promise((r,i)=>{try{e.onload=()=>r(e),e.onerror=s=>{const o=s instanceof Error?s.message:"error";i(new Error(o))}}catch(s){i(s)}})}const MC={};let hm=!0;async function RC(n,t,e){let r;vp(e)?r=await C0(n,t,e):r=S0(n,e);const i=t&&t.imagebitmap;return await NC(r,i)}async function NC(n,t=null){if((OC(t)||!hm)&&(t=null),t)try{return await createImageBitmap(n,t)}catch(e){console.warn(e),hm=!1}return await createImageBitmap(n)}function OC(n){for(const t in n||MC)return!1;return!0}function DC(n){return!BC(n,"ftyp",4)||(n[8]&96)===0?null:LC(n)}function LC(n){switch(kC(n,8,12).replace("\0"," ").trim()){case"avif":case"avis":return{extension:"avif",mimeType:"image/avif"};default:return null}}function kC(n,t,e){return String.fromCharCode(...n.slice(t,e))}function FC(n){return[...n].map(t=>t.charCodeAt(0))}function BC(n,t,e=0){const r=FC(t);for(let i=0;i<r.length;++i)if(r[i]!==n[i+e])return!1;return!0}const bi=!1,vl=!0;function T0(n){const t=rc(n);return VC(t)||HC(t)||zC(t)||WC(t)||UC(t)}function UC(n){const t=new Uint8Array(n instanceof DataView?n.buffer:n),e=DC(t);return e?{mimeType:e.mimeType,width:0,height:0}:null}function VC(n){const t=rc(n);return t.byteLength>=24&&t.getUint32(0,bi)===2303741511?{mimeType:"image/png",width:t.getUint32(16,bi),height:t.getUint32(20,bi)}:null}function zC(n){const t=rc(n);return t.byteLength>=10&&t.getUint32(0,bi)===1195984440?{mimeType:"image/gif",width:t.getUint16(6,vl),height:t.getUint16(8,vl)}:null}function WC(n){const t=rc(n);return t.byteLength>=14&&t.getUint16(0,bi)===16973&&t.getUint32(2,vl)===t.byteLength?{mimeType:"image/bmp",width:t.getUint32(18,vl),height:t.getUint32(22,vl)}:null}function HC(n){const t=rc(n);if(!(t.byteLength>=3&&t.getUint16(0,bi)===65496&&t.getUint8(2)===255))return null;const{tableMarkers:r,sofMarkers:i}=jC();let s=2;for(;s+9<t.byteLength;){const o=t.getUint16(s,bi);if(i.has(o))return{mimeType:"image/jpeg",height:t.getUint16(s+5,bi),width:t.getUint16(s+7,bi)};if(!r.has(o))return null;s+=2,s+=t.getUint16(s,bi)}return null}function jC(){const n=new Set([65499,65476,65484,65501,65534]);for(let e=65504;e<65520;++e)n.add(e);return{tableMarkers:n,sofMarkers:new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502])}}function rc(n){if(n instanceof DataView)return n;if(ArrayBuffer.isView(n))return new DataView(n.buffer);if(n instanceof ArrayBuffer)return new DataView(n);throw new Error("toDataView")}async function $C(n,t){const{mimeType:e}=T0(n)||{},r=globalThis.loaders?.parseImageNode;return Su(r),await r(n,e)}async function XC(n,t,e){t=t||{};const i=(t.image||{}).type||"auto",{url:s}=e||{},o=GC(i);let a;switch(o){case"imagebitmap":a=await RC(n,t,s);break;case"image":a=await C0(n,t,s);break;case"data":a=await $C(n);break;default:Su(!1)}return i==="data"&&(a=SC(a)),a}function GC(n){switch(n){case"auto":case"data":return EC();default:return xC(n),n}}const YC=["png","jpg","jpeg","gif","webp","bmp","ico","svg","avif"],qC=["image/png","image/jpeg","image/gif","image/webp","image/avif","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],KC={image:{type:"auto",decode:!0}},ZC={dataType:null,batchType:null,id:"image",module:"images",name:"Images",version:yC,mimeTypes:qC,extensions:YC,parse:XC,tests:[n=>!!T0(new DataView(n))],options:KC},It=new ec({id:"deck"});let hd={};function JC(n){hd=n}function _n(n,t,e,r){It.level>0&&hd[n]&&hd[n].call(null,t,e,r)}function QC(n){const t=n[0],e=n[n.length-1];return t==="{"&&e==="}"||t==="["&&e==="]"}const tT={dataType:null,batchType:null,id:"JSON",name:"JSON",module:"",version:"",options:{},extensions:["json","geojson"],mimeTypes:["application/json","application/geo+json"],testText:QC,parseTextSync:JSON.parse};function eT(){const n="9.1.12",t=globalThis.deck&&globalThis.deck.VERSION;if(t&&t!==n)throw new Error(`deck.gl - multiple versions detected: ${t} vs ${n}`);return t||(It.log(1,`deck.gl ${n}`)(),globalThis.deck={...globalThis.deck,VERSION:n,version:n,log:It,_registerLoggers:JC},GS([tT,[ZC,{imagebitmap:{premultiplyAlpha:"none"}}]])),n}const nT=eT();function bp(n,t){if(!n)throw new Error(t||"shadertools: assertion failed.")}const rf={number:{type:"number",validate(n,t){return Number.isFinite(n)&&typeof t=="object"&&(t.max===void 0||n<=t.max)&&(t.min===void 0||n>=t.min)}},array:{type:"array",validate(n,t){return Array.isArray(n)||ArrayBuffer.isView(n)}}};function rT(n){const t={};for(const[e,r]of Object.entries(n))t[e]=iT(r);return t}function iT(n){let t=fm(n);if(t!=="object")return{value:n,...rf[t],type:t};if(typeof n=="object")return n?n.type!==void 0?{...n,...rf[n.type],type:n.type}:n.value===void 0?{type:"object",value:n}:(t=fm(n.value),{...n,...rf[t],type:t}):{type:"object",value:null};throw new Error("props")}function fm(n){return Array.isArray(n)||ArrayBuffer.isView(n)?"array":typeof n}const sT=`#ifdef MODULE_LOGDEPTH
  logdepth_adjustPosition(gl_Position);
#endif
`,oT=`#ifdef MODULE_MATERIAL
  fragColor = material_filterColor(fragColor);
#endif

#ifdef MODULE_LIGHTING
  fragColor = lighting_filterColor(fragColor);
#endif

#ifdef MODULE_FOG
  fragColor = fog_filterColor(fragColor);
#endif

#ifdef MODULE_PICKING
  fragColor = picking_filterHighlightColor(fragColor);
  fragColor = picking_filterPickingColor(fragColor);
#endif

#ifdef MODULE_LOGDEPTH
  logdepth_setFragDepth();
#endif
`,aT={vertex:sT,fragment:oT},dm=/void\s+main\s*\([^)]*\)\s*\{\n?/,pm=/}\n?[^{}]*$/,sf=[],tu="__LUMA_INJECT_DECLARATIONS__";function lT(n){const t={vertex:{},fragment:{}};for(const e in n){let r=n[e];const i=cT(e);typeof r=="string"&&(r={order:0,injection:r}),t[i][e]=r}return t}function cT(n){const t=n.slice(0,2);switch(t){case"vs":return"vertex";case"fs":return"fragment";default:throw new Error(t)}}function Iu(n,t,e,r=!1){const i=t==="vertex";for(const s in e){const o=e[s];o.sort((l,c)=>l.order-c.order),sf.length=o.length;for(let l=0,c=o.length;l<c;++l)sf[l]=o[l].injection;const a=`${sf.join(`
`)}
`;switch(s){case"vs:#decl":i&&(n=n.replace(tu,a));break;case"vs:#main-start":i&&(n=n.replace(dm,l=>l+a));break;case"vs:#main-end":i&&(n=n.replace(pm,l=>a+l));break;case"fs:#decl":i||(n=n.replace(tu,a));break;case"fs:#main-start":i||(n=n.replace(dm,l=>l+a));break;case"fs:#main-end":i||(n=n.replace(pm,l=>a+l));break;default:n=n.replace(s,l=>l+a)}}return n=n.replace(tu,""),r&&(n=n.replace(/\}\s*$/,s=>s+aT[t])),n}function Au(n){n.map(t=>uT(t))}function uT(n){if(n.instance)return;Au(n.dependencies||[]);const{propTypes:t={},deprecations:e=[],inject:r={}}=n,i={normalizedInjections:lT(r),parsedDeprecations:hT(e)};t&&(i.propValidators=rT(t)),n.instance=i;let s={};t&&(s=Object.entries(t).reduce((o,[a,l])=>{const c=l?.value;return c&&(o[a]=c),o},{})),n.defaultUniforms={...n.defaultUniforms,...s}}function P0(n,t,e){n.deprecations?.forEach(r=>{r.regex?.test(t)&&(r.deprecated?e.deprecated(r.old,r.new)():e.removed(r.old,r.new)())})}function hT(n){return n.forEach(t=>{switch(t.type){case"function":t.regex=new RegExp(`\\b${t.old}\\(`);break;default:t.regex=new RegExp(`${t.type} ${t.old};`)}}),n}function xp(n){Au(n);const t={},e={};I0({modules:n,level:0,moduleMap:t,moduleDepth:e});const r=Object.keys(e).sort((i,s)=>e[s]-e[i]).map(i=>t[i]);return Au(r),r}function I0(n){const{modules:t,level:e,moduleMap:r,moduleDepth:i}=n;if(e>=5)throw new Error("Possible loop in shader dependency graph");for(const s of t)r[s.name]=s,(i[s.name]===void 0||i[s.name]<e)&&(i[s.name]=e);for(const s of t)s.dependencies&&I0({modules:s.dependencies,level:e+1,moduleMap:r,moduleDepth:i})}function fT(n){switch(n?.gpu.toLowerCase()){case"apple":return`#define APPLE_GPU
// Apple optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"nvidia":return`#define NVIDIA_GPU
// Nvidia optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
`;case"intel":return`#define INTEL_GPU
// Intel optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Intel's built-in 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"amd":return`#define AMD_GPU
`;default:return`#define DEFAULT_GPU
// Prevent driver from optimizing away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Headless Chrome's software shader 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// If the GPU doesn't have full 32 bits precision, will causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`}}function dT(n,t){if(Number(n.match(/^#version[ \t]+(\d+)/m)?.[1]||100)!==300)throw new Error("luma.gl v9 only supports GLSL 3.00 shader sources");switch(t){case"vertex":return n=gm(n,pT),n;case"fragment":return n=gm(n,gT),n;default:throw new Error(t)}}const A0=[[/^(#version[ \t]+(100|300[ \t]+es))?[ \t]*\n/,`#version 300 es
`],[/\btexture(2D|2DProj|Cube)Lod(EXT)?\(/g,"textureLod("],[/\btexture(2D|2DProj|Cube)(EXT)?\(/g,"texture("]],pT=[...A0,[fd("attribute"),"in $1"],[fd("varying"),"out $1"]],gT=[...A0,[fd("varying"),"in $1"]];function gm(n,t){for(const[e,r]of t)n=n.replace(e,r);return n}function fd(n){return new RegExp(`\\b${n}[ \\t]+(\\w+[ \\t]+\\w+(\\[\\w+\\])?;)`,"g")}function M0(n,t){let e="";for(const r in n){const i=n[r];if(e+=`void ${i.signature} {
`,i.header&&(e+=`  ${i.header}`),t[r]){const s=t[r];s.sort((o,a)=>o.order-a.order);for(const o of s)e+=`  ${o.injection}
`}i.footer&&(e+=`  ${i.footer}`),e+=`}
`}return e}function R0(n){const t={vertex:{},fragment:{}};for(const e of n){let r,i;typeof e!="string"?(r=e,i=r.hook):(r={},i=e),i=i.trim();const[s,o]=i.split(":"),a=i.replace(/\(.+/,""),l=Object.assign(r,{signature:o});switch(s){case"vs":t.vertex[a]=l;break;case"fs":t.fragment[a]=l;break;default:throw new Error(s)}}return t}function mT(n,t){return{name:_T(n,t),language:"glsl",version:yT(n)}}function _T(n,t="unnamed"){const r=/#define[^\S\r\n]*SHADER_NAME[^\S\r\n]*([A-Za-z0-9_-]+)\s*/.exec(n);return r?r[1]:t}function yT(n){let t=100;const e=n.match(/[^\s]+/g);if(e&&e.length>=2&&e[0]==="#version"){const r=parseInt(e[1],10);Number.isFinite(r)&&(t=r)}if(t!==100&&t!==300)throw new Error(`Invalid GLSL version ${t}`);return t}const N0=`

${tu}
`,vT=`precision highp float;
`;function bT(n){const t=xp(n.modules||[]);return{source:ET(n.platformInfo,{...n,source:n.source,stage:"vertex",modules:t}),getUniforms:O0(t)}}function xT(n){const{vs:t,fs:e}=n,r=xp(n.modules||[]);return{vs:mm(n.platformInfo,{...n,source:t,stage:"vertex",modules:r}),fs:mm(n.platformInfo,{...n,source:e,stage:"fragment",modules:r}),getUniforms:O0(r)}}function ET(n,t){const{source:e,stage:r,modules:i,hookFunctions:s=[],inject:o={},log:a}=t;bp(typeof e=="string","shader source must be a string");const l=e;let c="";const u=R0(s),h={},f={},d={};for(const _ in o){const v=typeof o[_]=="string"?{injection:o[_],order:0}:o[_],E=/^(v|f)s:(#)?([\w-]+)$/.exec(_);if(E){const m=E[2],g=E[3];m?g==="decl"?f[_]=[v]:d[_]=[v]:h[_]=[v]}else d[_]=[v]}const p=i;for(const _ of p){a&&P0(_,l,a);const v=D0(_,"wgsl");c+=v;const E=_.injections?.[r]||{};for(const m in E){const g=/^(v|f)s:#([\w-]+)$/.exec(m);if(g){const b=g[2]==="decl"?f:d;b[m]=b[m]||[],b[m].push(E[m])}else h[m]=h[m]||[],h[m].push(E[m])}}return c+=N0,c=Iu(c,r,f),c+=M0(u[r],h),c+=l,c=Iu(c,r,d),c}function mm(n,t){const{id:e,source:r,stage:i,language:s="glsl",modules:o,defines:a={},hookFunctions:l=[],inject:c={},prologue:u=!0,log:h}=t;bp(typeof r=="string","shader source must be a string");const f=s==="glsl"?mT(r).version:-1,d=n.shaderLanguageVersion,p=f===100?"#version 100":"#version 300 es",v=r.split(`
`).slice(1).join(`
`),E={};o.forEach(w=>{Object.assign(E,w.defines)}),Object.assign(E,a);let m="";switch(s){case"wgsl":break;case"glsl":m=u?`${p}

// ----- PROLOGUE -------------------------
${wT({id:e,source:r,stage:i})}
${`#define SHADER_TYPE_${i.toUpperCase()}`}

${fT(n)}
${i==="fragment"?vT:""}

// ----- APPLICATION DEFINES -------------------------

${ST(E)}

`:`${p}
`;break}const g=R0(l),y={},b={},x={};for(const w in c){const S=typeof c[w]=="string"?{injection:c[w],order:0}:c[w],I=/^(v|f)s:(#)?([\w-]+)$/.exec(w);if(I){const T=I[2],M=I[3];T?M==="decl"?b[w]=[S]:x[w]=[S]:y[w]=[S]}else x[w]=[S]}for(const w of o){h&&P0(w,v,h);const S=D0(w,i);m+=S;const I=w.instance?.normalizedInjections[i]||{};for(const T in I){const M=/^(v|f)s:#([\w-]+)$/.exec(T);if(M){const O=M[2]==="decl"?b:x;O[T]=O[T]||[],O[T].push(I[T])}else y[T]=y[T]||[],y[T].push(I[T])}}return m+="// ----- MAIN SHADER SOURCE -------------------------",m+=N0,m=Iu(m,i,b),m+=M0(g[i],y),m+=v,m=Iu(m,i,x),s==="glsl"&&f!==d&&(m=dT(m,i)),m.trim()}function O0(n){return function(e){const r={};for(const i of n){const s=i.getUniforms?.(e,r);Object.assign(r,s)}return r}}function wT(n){const{id:t,source:e,stage:r}=n;return t&&e.indexOf("SHADER_NAME")===-1?`
#define SHADER_NAME ${t}_${r}`:""}function ST(n={}){let t="";for(const e in n){const r=n[e];(r||Number.isFinite(r))&&(t+=`#define ${e.toUpperCase()} ${n[e]}
`)}return t}function D0(n,t){let e;switch(t){case"vertex":e=n.vs||"";break;case"fragment":e=n.fs||"";break;case"wgsl":e=n.source||"";break;default:bp(!1)}if(!n.name)throw new Error("Shader module must have a name");const r=n.name.toUpperCase().replace(/[^0-9a-z]/gi,"_");let i=`// ----- MODULE ${n.name} ---------------

`;return t!=="wgsl"&&(i+=`#define MODULE_${r}
`),i+=`${e}
`,i}const CT=/^\s*\#\s*ifdef\s*([a-zA-Z_]+)\s*$/,TT=/^\s*\#\s*endif\s*$/;function PT(n,t){const e=n.split(`
`),r=[];let i=!0,s=null;for(const o of e){const a=o.match(CT),l=o.match(TT);a?(s=a[1],i=!!t?.defines?.[s]):l?i=!0:i&&r.push(o)}return r.join(`
`)}class Js{static defaultShaderAssembler;_hookFunctions=[];_defaultModules=[];static getDefaultShaderAssembler(){return Js.defaultShaderAssembler=Js.defaultShaderAssembler||new Js,Js.defaultShaderAssembler}addDefaultModule(t){this._defaultModules.find(e=>e.name===(typeof t=="string"?t:t.name))||this._defaultModules.push(t)}removeDefaultModule(t){const e=typeof t=="string"?t:t.name;this._defaultModules=this._defaultModules.filter(r=>r.name!==e)}addShaderHook(t,e){e&&(t=Object.assign(e,{hook:t})),this._hookFunctions.push(t)}assembleWGSLShader(t){const e=this._getModuleList(t.modules),r=this._hookFunctions,{source:i,getUniforms:s}=bT({...t,source:t.source,modules:e,hookFunctions:r});return{source:t.platformInfo.shaderLanguage==="wgsl"?PT(i):i,getUniforms:s,modules:e}}assembleGLSLShaderPair(t){const e=this._getModuleList(t.modules),r=this._hookFunctions;return{...xT({...t,vs:t.vs,fs:t.fs,modules:e,hookFunctions:r}),modules:e}}_getModuleList(t=[]){const e=new Array(this._defaultModules.length+t.length),r={};let i=0;for(let s=0,o=this._defaultModules.length;s<o;++s){const a=this._defaultModules[s],l=a.name;e[i++]=a,r[l]=!0}for(let s=0,o=t.length;s<o;++s){const a=t[s],l=a.name;r[l]||(e[i++]=a,r[l]=!0)}return e.length=i,Au(e),e}}const IT=`out vec4 transform_output;
void main() {
  transform_output = vec4(0);
}`,AT=`#version 300 es
${IT}`;function MT(n){const{input:t,inputChannels:e,output:r}={};if(!t)return AT;if(!e)throw new Error("inputChannels");const i=RT(e),s=NT(t,e);return`#version 300 es
in ${i} ${t};
out vec4 ${r};
void main() {
  ${r} = ${s};
}`}function RT(n){switch(n){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error(`invalid channels: ${n}`)}}function NT(n,t){switch(t){case 1:return`vec4(${n}, 0.0, 0.0, 1.0)`;case 2:return`vec4(${n}, 0.0, 1.0)`;case 3:return`vec4(${n}, 1.0)`;case 4:return n;default:throw new Error(`invalid channels: ${t}`)}}class OT{stats=new Map;getStats(t){return this.get(t)}get(t){return this.stats.has(t)||this.stats.set(t,new yh({id:t})),this.stats.get(t)}}const L0=new OT,tt=new ec({id:"luma.gl"}),of={};function bh(n="id"){of[n]=of[n]||1;const t=of[n]++;return`${n}-${t}`}let $t=class{static defaultProps={id:"undefined",handle:void 0,userData:void 0};toString(){return`${this[Symbol.toStringTag]||this.constructor.name}:"${this.id}"`}id;props;userData={};_device;destroyed=!1;allocatedBytes=0;_attachedResources=new Set;constructor(t,e,r){if(!t)throw new Error("no device");this._device=t,this.props=DT(e,r);const i=this.props.id!=="undefined"?this.props.id:bh(this[Symbol.toStringTag]);this.props.id=i,this.id=i,this.userData=this.props.userData||{},this.addStats()}destroy(){this.destroyResource()}delete(){return this.destroy(),this}getProps(){return this.props}attachResource(t){this._attachedResources.add(t)}detachResource(t){this._attachedResources.delete(t)}destroyAttachedResource(t){this._attachedResources.delete(t)&&t.destroy()}destroyAttachedResources(){for(const t of Object.values(this._attachedResources))t.destroy();this._attachedResources=new Set}destroyResource(){this.destroyAttachedResources(),this.removeStats(),this.destroyed=!0}removeStats(){const t=this._device.statsManager.getStats("Resource Counts"),e=this[Symbol.toStringTag];t.get(`${e}s Active`).decrementCount()}trackAllocatedMemory(t,e=this[Symbol.toStringTag]){const r=this._device.statsManager.getStats("Resource Counts");r.get("GPU Memory").addCount(t),r.get(`${e} Memory`).addCount(t),this.allocatedBytes=t}trackDeallocatedMemory(t=this[Symbol.toStringTag]){const e=this._device.statsManager.getStats("Resource Counts");e.get("GPU Memory").subtractCount(this.allocatedBytes),e.get(`${t} Memory`).subtractCount(this.allocatedBytes),this.allocatedBytes=0}addStats(){const t=this._device.statsManager.getStats("Resource Counts"),e=this[Symbol.toStringTag];t.get("Resources Created").incrementCount(),t.get(`${e}s Created`).incrementCount(),t.get(`${e}s Active`).incrementCount()}};function DT(n,t){const e={...t};for(const r in n)n[r]!==void 0&&(e[r]=n[r]);return e}class Yt extends $t{static defaultProps={...$t.defaultProps,usage:0,byteLength:0,byteOffset:0,data:null,indexType:"uint16",mappedAtCreation:!1};static MAP_READ=1;static MAP_WRITE=2;static COPY_SRC=4;static COPY_DST=8;static INDEX=16;static VERTEX=32;static UNIFORM=64;static STORAGE=128;static INDIRECT=256;static QUERY_RESOLVE=512;get[Symbol.toStringTag](){return"Buffer"}usage;indexType;updateTimestamp;constructor(t,e){const r={...e};(e.usage||0)&Yt.INDEX&&!e.indexType&&(e.data instanceof Uint32Array?r.indexType="uint32":e.data instanceof Uint16Array&&(r.indexType="uint16")),delete r.data,super(t,r,Yt.defaultProps),this.usage=r.usage||0,this.indexType=r.indexType,this.updateTimestamp=t.incrementTimestamp()}clone(t){return this.device.createBuffer({...this.props,...t})}readSyncWebGL(t,e){throw new Error("not implemented")}static DEBUG_DATA_MAX_LENGTH=32;debugData=new ArrayBuffer(0);_setDebugData(t,e,r){const i=ArrayBuffer.isView(t)?t.buffer:t,s=Math.min(t?t.byteLength:r,Yt.DEBUG_DATA_MAX_LENGTH);i===null?this.debugData=new ArrayBuffer(s):e===0&&r===i.byteLength?this.debugData=i.slice(0,s):this.debugData=i.slice(e,e+s)}}function k0(n){const t=_m[n],e=LT(t),r=n.includes("norm"),i=!r&&!n.startsWith("float"),s=n.startsWith("s");return{dataType:_m[n],byteLength:e,integer:i,signed:s,normalized:r}}function LT(n){return kT[n]}const _m={uint8:"uint8",sint8:"sint8",unorm8:"uint8",snorm8:"sint8",uint16:"uint16",sint16:"sint16",unorm16:"uint16",snorm16:"sint16",float16:"float16",float32:"float32",uint32:"uint32",sint32:"sint32"},kT={uint8:1,sint8:1,uint16:2,sint16:2,float16:2,float32:4,uint32:4,sint32:4},dn="texture-compression-bc",Ht="texture-compression-astc",hi="texture-compression-etc2",FT="texture-compression-etc1-webgl",Cc="texture-compression-pvrtc-webgl",af="texture-compression-atc-webgl",Tc="float32-renderable-webgl",lf="float16-renderable-webgl",BT="rgb9e5ufloat-renderable-webgl",cf="snorm8-renderable-webgl",Ja="norm16-renderable-webgl",uf="snorm16-renderable-webgl",Pc="float32-filterable",ym="float16-filterable-webgl";function F0(n){const t=UT[n];if(!t)throw new Error(`Unsupported texture format ${n}`);return t}const UT={r8unorm:{},r8snorm:{render:cf},r8uint:{},r8sint:{},rg8unorm:{},rg8snorm:{render:cf},rg8uint:{},rg8sint:{},r16uint:{},r16sint:{},r16float:{render:lf,filter:"float16-filterable-webgl"},"r16unorm-webgl":{f:Ja},"r16snorm-webgl":{f:uf},"rgba4unorm-webgl":{channels:"rgba",bitsPerChannel:[4,4,4,4],packed:!0},"rgb565unorm-webgl":{channels:"rgb",bitsPerChannel:[5,6,5,0],packed:!0},"rgb5a1unorm-webgl":{channels:"rgba",bitsPerChannel:[5,5,5,1],packed:!0},"rgb8unorm-webgl":{},"rgb8snorm-webgl":{},rgba8unorm:{},"rgba8unorm-srgb":{},rgba8snorm:{render:cf},rgba8uint:{},rgba8sint:{},bgra8unorm:{},"bgra8unorm-srgb":{},rg16uint:{},rg16sint:{},rg16float:{render:lf,filter:ym},"rg16unorm-webgl":{render:Ja},"rg16snorm-webgl":{render:uf},r32uint:{},r32sint:{},r32float:{render:Tc,filter:Pc},rgb9e5ufloat:{channels:"rgb",packed:!0,render:BT},rg11b10ufloat:{channels:"rgb",bitsPerChannel:[11,11,10,0],packed:!0,p:1,render:Tc},rgb10a2unorm:{channels:"rgba",bitsPerChannel:[10,10,10,2],packed:!0,p:1},"rgb10a2uint-webgl":{channels:"rgba",bitsPerChannel:[10,10,10,2],packed:!0,p:1,wgpu:!1},"rgb16unorm-webgl":{f:Ja},"rgb16snorm-webgl":{f:Ja},rg32uint:{},rg32sint:{},rg32float:{render:!1,filter:Pc},rgba16uint:{},rgba16sint:{},rgba16float:{render:lf,filter:ym},"rgba16unorm-webgl":{render:Ja},"rgba16snorm-webgl":{render:uf},"rgb32float-webgl":{render:Tc,filter:Pc},rgba32uint:{},rgba32sint:{},rgba32float:{render:Tc,filter:Pc},stencil8:{attachment:"stencil",bitsPerChannel:[8,0,0,0],dataType:"uint8"},depth16unorm:{attachment:"depth",bitsPerChannel:[16,0,0,0],dataType:"uint16"},depth24plus:{attachment:"depth",bitsPerChannel:[24,0,0,0],dataType:"uint32"},depth32float:{attachment:"depth",bitsPerChannel:[32,0,0,0],dataType:"float32"},"depth24plus-stencil8":{attachment:"depth-stencil",bitsPerChannel:[24,8,0,0],packed:!0},"depth32float-stencil8":{attachment:"depth-stencil",bitsPerChannel:[32,8,0,0],packed:!0},"bc1-rgb-unorm-webgl":{f:dn},"bc1-rgb-unorm-srgb-webgl":{f:dn},"bc1-rgba-unorm":{f:dn},"bc1-rgba-unorm-srgb":{f:dn},"bc2-rgba-unorm":{f:dn},"bc2-rgba-unorm-srgb":{f:dn},"bc3-rgba-unorm":{f:dn},"bc3-rgba-unorm-srgb":{f:dn},"bc4-r-unorm":{f:dn},"bc4-r-snorm":{f:dn},"bc5-rg-unorm":{f:dn},"bc5-rg-snorm":{f:dn},"bc6h-rgb-ufloat":{f:dn},"bc6h-rgb-float":{f:dn},"bc7-rgba-unorm":{f:dn},"bc7-rgba-unorm-srgb":{f:dn},"etc2-rgb8unorm":{f:hi},"etc2-rgb8unorm-srgb":{f:hi},"etc2-rgb8a1unorm":{f:hi},"etc2-rgb8a1unorm-srgb":{f:hi},"etc2-rgba8unorm":{f:hi},"etc2-rgba8unorm-srgb":{f:hi},"eac-r11unorm":{f:hi},"eac-r11snorm":{f:hi},"eac-rg11unorm":{f:hi},"eac-rg11snorm":{f:hi},"astc-4x4-unorm":{f:Ht},"astc-4x4-unorm-srgb":{f:Ht},"astc-5x4-unorm":{f:Ht},"astc-5x4-unorm-srgb":{f:Ht},"astc-5x5-unorm":{f:Ht},"astc-5x5-unorm-srgb":{f:Ht},"astc-6x5-unorm":{f:Ht},"astc-6x5-unorm-srgb":{f:Ht},"astc-6x6-unorm":{f:Ht},"astc-6x6-unorm-srgb":{f:Ht},"astc-8x5-unorm":{f:Ht},"astc-8x5-unorm-srgb":{f:Ht},"astc-8x6-unorm":{f:Ht},"astc-8x6-unorm-srgb":{f:Ht},"astc-8x8-unorm":{f:Ht},"astc-8x8-unorm-srgb":{f:Ht},"astc-10x5-unorm":{f:Ht},"astc-10x5-unorm-srgb":{f:Ht},"astc-10x6-unorm":{f:Ht},"astc-10x6-unorm-srgb":{f:Ht},"astc-10x8-unorm":{f:Ht},"astc-10x8-unorm-srgb":{f:Ht},"astc-10x10-unorm":{f:Ht},"astc-10x10-unorm-srgb":{f:Ht},"astc-12x10-unorm":{f:Ht},"astc-12x10-unorm-srgb":{f:Ht},"astc-12x12-unorm":{f:Ht},"astc-12x12-unorm-srgb":{f:Ht},"pvrtc-rgb4unorm-webgl":{f:Cc},"pvrtc-rgba4unorm-webgl":{f:Cc},"pvrtc-rbg2unorm-webgl":{f:Cc},"pvrtc-rgba2unorm-webgl":{f:Cc},"etc1-rbg-unorm-webgl":{f:FT},"atc-rgb-unorm-webgl":{f:af},"atc-rgba-unorm-webgl":{f:af},"atc-rgbai-unorm-webgl":{f:af}},VT=["bc1","bc2","bc3","bc4","bc5","bc6","bc7","etc1","etc2","eac","atc","astc","pvrtc"],zT=/^(r|rg|rgb|rgba|bgra)([0-9]*)([a-z]*)(-srgb)?(-webgl)?$/;function B0(n){return VT.some(t=>n.startsWith(t))}function Ep(n){let t=WT(n);if(B0(n)){t.channels="rgb",t.components=3,t.bytesPerPixel=1,t.srgb=!1,t.compressed=!0;const r=HT(n);r&&(t.blockWidth=r.blockWidth,t.blockHeight=r.blockHeight)}const e=zT.exec(n);if(e){const[,r,i,s,o,a]=e,l=`${s}${i}`,c=k0(l),u=c.byteLength*8,h=r.length,f=[u,h>=2?u:0,h>=3?u:0,h>=4?u:0];t={format:n,attachment:t.attachment,dataType:c.dataType,components:h,channels:r,integer:c.integer,signed:c.signed,normalized:c.normalized,bitsPerChannel:f,bytesPerPixel:c.byteLength*r.length,packed:t.packed,srgb:t.srgb},a==="-webgl"&&(t.webgl=!0),o==="-srgb"&&(t.srgb=!0)}return n.endsWith("-webgl")&&(t.webgl=!0),n.endsWith("-srgb")&&(t.srgb=!0),t}function WT(n){const t=F0(n),e=t.bytesPerPixel||1,r=t.bitsPerChannel||[8,8,8,8];return delete t.bitsPerChannel,delete t.bytesPerPixel,delete t.f,delete t.render,delete t.filter,delete t.blend,delete t.store,{...t,format:n,attachment:t.attachment||"color",channels:t.channels||"r",components:t.components||t.channels?.length||1,bytesPerPixel:e,bitsPerChannel:r,dataType:t.dataType||"uint8",srgb:t.srgb??!1,packed:t.packed??!1,webgl:t.webgl??!1,integer:t.integer??!1,signed:t.signed??!1,normalized:t.normalized??!1,compressed:t.compressed??!1}}function HT(n){const e=/.*-(\d+)x(\d+)-.*/.exec(n);if(e){const[,r,i]=e;return{blockWidth:Number(r),blockHeight:Number(i)}}return null}function jT(n){const t=F0(n),e={format:n,create:t.f??!0,render:t.render??!0,filter:t.filter??!0,blend:t.blend??!0,store:t.store??!0},r=Ep(n),i=n.startsWith("depth")||n.startsWith("stencil"),s=r?.signed,o=r?.integer,a=r?.webgl;return e.render&&=!s,e.filter&&=!i&&!s&&!o&&!a,e}class $T{}class XT{features;disabledFeatures;constructor(t=[],e){this.features=new Set(t),this.disabledFeatures=e||{}}*[Symbol.iterator](){yield*this.features}has(t){return!this.disabledFeatures?.[t]&&this.features.has(t)}}class Es{static defaultProps={id:null,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1,createCanvasContext:void 0,onError:t=>tt.error(t.message)(),_reuseDevices:!1,_requestMaxLimits:!0,_factoryDestroyPolicy:"unused",_initializeFeatures:!0,_disabledFeatures:{"compilation-status-async-webgl":!0},_resourceDefaults:{},webgl:{},debug:tt.get("debug")||void 0,debugShaders:tt.get("debug-shaders")||void 0,debugFramebuffers:!!tt.get("debug-framebuffers"),debugWebGL:!!tt.get("debug-webgl"),debugSpectorJS:void 0,debugSpectorJSUrl:void 0,_handle:void 0};get[Symbol.toStringTag](){return"Device"}constructor(t){this.props={...Es.defaultProps,...t},this.id=this.props.id||bh(this[Symbol.toStringTag].toLowerCase())}id;props;userData={};statsManager=L0;timestamp=0;_reused=!1;_lumaData={};getTextureFormatCapabilities(t){const e=jT(t),r=o=>(typeof o=="string"?this.features.has(o):o)??!0,i=r(e.create),s={format:t,create:i,render:i&&r(e.render),filter:i&&r(e.filter),blend:i&&r(e.blend),store:i&&r(e.store)};return this._getDeviceSpecificTextureFormatCapabilities(s)}isTextureFormatSupported(t,e){return this.getTextureFormatCapabilities(t).create}isTextureFormatFilterable(t){return this.getTextureFormatCapabilities(t).filter}isTextureFormatRenderable(t){return this.getTextureFormatCapabilities(t).render}isTextureFormatCompressed(t){return B0(t)}loseDevice(){return!1}reportError(t){this.props.onError(t)}getDefaultCanvasContext(){if(!this.canvasContext)throw new Error("Device has no default CanvasContext. See props.createCanvasContext");return this.canvasContext}createCommandEncoder(t={}){throw new Error("not implemented")}incrementTimestamp(){return this.timestamp++}onError(t){this.props.onError(t)}getCanvasContext(){return this.getDefaultCanvasContext()}readPixelsToArrayWebGL(t,e){throw new Error("not implemented")}readPixelsToBufferWebGL(t,e){throw new Error("not implemented")}setParametersWebGL(t){throw new Error("not implemented")}getParametersWebGL(t){throw new Error("not implemented")}withParametersWebGL(t,e){throw new Error("not implemented")}clearWebGL(t){throw new Error("not implemented")}resetWebGL(){throw new Error("not implemented")}static _getCanvasContextProps(t){return t.createCanvasContext===!0?{}:t.createCanvasContext}_normalizeBufferProps(t){(t instanceof ArrayBuffer||ArrayBuffer.isView(t))&&(t={data:t});const e={...t};return(t.usage||0)&Yt.INDEX&&!t.indexType&&(t.data instanceof Uint32Array?e.indexType="uint32":t.data instanceof Uint16Array?e.indexType="uint16":tt.warn("indices buffer content must be of integer type")()),e}}const GT=To()&&typeof document<"u",YT=()=>GT&&document.readyState==="complete",qT="set luma.log.level=1 (or higher) to trace rendering",vm="No matching device found. Ensure `@luma.gl/webgl` and/or `@luma.gl/webgpu` modules are imported.";class Ko{static defaultProps={...Es.defaultProps,type:"best-available",adapters:void 0,waitForPageLoad:!0};static pageLoaded=KT().then(()=>{tt.probe(2,"DOM is loaded")()});stats=L0;log=tt;VERSION="9.1.9";spector;preregisteredAdapters=new Map;constructor(){if(globalThis.luma){if(globalThis.luma.VERSION!==this.VERSION)throw tt.error(`Found luma.gl ${globalThis.luma.VERSION} while initialzing ${this.VERSION}`)(),tt.error("'yarn why @luma.gl/core' can help identify the source of the conflict")(),new Error("luma.gl - multiple versions detected: see console log");tt.error("This version of luma.gl has already been initialized")()}tt.log(1,`${this.VERSION} - ${qT}`)(),globalThis.luma=this}registerAdapters(t){for(const e of t)this.preregisteredAdapters.set(e.type,e)}getSupportedAdapters(t=[]){const e=this.getAdapterMap(t);return Array.from(e).map(([,r])=>r).filter(r=>r.isSupported?.()).map(r=>r.type)}getBestAvailableAdapter(t=[]){const e=this.getAdapterMap(t);return e.get("webgpu")?.isSupported?.()?"webgpu":e.get("webgl")?.isSupported?.()?"webgl":null}setDefaultDeviceProps(t){Object.assign(Ko.defaultProps,t)}async createDevice(t={}){t={...Ko.defaultProps,...t},t.waitForPageLoad&&await Ko.pageLoaded;const e=this.getAdapterMap(t.adapters);let r=t.type||"";r==="best-available"&&(r=this.getBestAvailableAdapter(t.adapters)||r);const o=await(this.getAdapterMap(t.adapters)||e).get(r)?.create?.(t);if(o)return o;throw new Error(vm)}async attachDevice(t){const e=this.getAdapterMap(t.adapters);let r="";t.handle instanceof WebGL2RenderingContext&&(r="webgl"),t.createCanvasContext&&await Ko.pageLoaded,t.handle===null&&(r="unknown");const s=await e.get(r)?.attach?.(null);if(s)return s;throw new Error(vm)}enforceWebGL2(t=!0,e=[]){const i=this.getAdapterMap(e).get("webgl");i||tt.warn("enforceWebGL2: webgl adapter not found")(),i?.enforceWebGL2?.(t)}getAdapterMap(t=[]){const e=new Map(this.preregisteredAdapters);for(const r of t)e.set(r.type,r);return e}registerDevices(t){tt.warn("luma.registerDevices() is deprecated, use luma.registerAdapters() instead");for(const e of t){const r=e.adapter;r&&this.preregisteredAdapters.set(r.type,r)}}}const dd=new Ko;function KT(){return YT()||typeof window>"u"?Promise.resolve():new Promise(n=>{window.addEventListener("load",()=>n())})}class ZT{}class wp{static defaultProps={canvas:null,width:800,height:600,useDevicePixels:!0,autoResize:!0,container:null,visible:!0,alphaMode:"opaque",colorSpace:"srgb"};id;props;canvas;htmlCanvas;offscreenCanvas;type;width=1;height=1;resizeObserver;_canvasSizeInfo={clientWidth:0,clientHeight:0,devicePixelRatio:1};toString(){return`${this[Symbol.toStringTag]}(${this.id})`}constructor(t){if(this.props={...wp.defaultProps,...t},t=this.props,!To()){this.id="node-canvas-context",this.type="node",this.width=this.props.width,this.height=this.props.height,this.canvas=null;return}if(t.canvas)typeof t.canvas=="string"?this.canvas=QT(t.canvas):this.canvas=t.canvas;else{const e=tP(t),r=JT(t?.container||null);r.insertBefore(e,r.firstChild),this.canvas=e,t?.visible||(this.canvas.style.visibility="hidden")}this.canvas instanceof HTMLCanvasElement?(this.id=this.canvas.id,this.type="html-canvas",this.htmlCanvas=this.canvas):(this.id="offscreen-canvas",this.type="offscreen-canvas",this.offscreenCanvas=this.canvas),this.canvas instanceof HTMLCanvasElement&&t.autoResize&&(this.resizeObserver=new ResizeObserver(e=>{for(const r of e)r.target===this.canvas&&this.update()}),this.resizeObserver.observe(this.canvas))}getDevicePixelRatio(t){return typeof OffscreenCanvas<"u"&&this.canvas instanceof OffscreenCanvas||(t=t===void 0?this.props.useDevicePixels:t,!t||t<=0)?1:t===!0?typeof window<"u"&&window.devicePixelRatio||1:t}getPixelSize(){switch(this.type){case"node":return[this.width,this.height];case"offscreen-canvas":return[this.canvas.width,this.canvas.height];case"html-canvas":const t=this.getDevicePixelRatio(),e=this.canvas;return e.parentElement?[e.clientWidth*t,e.clientHeight*t]:[this.canvas.width,this.canvas.height];default:throw new Error(this.type)}}getAspect(){const[t,e]=this.getPixelSize();return t/e}cssToDeviceRatio(){try{const[t]=this.getDrawingBufferSize(),e=this._canvasSizeInfo.clientWidth||this.htmlCanvas?.clientWidth;return e?t/e:1}catch{return 1}}cssToDevicePixels(t,e=!0){const r=this.cssToDeviceRatio(),[i,s]=this.getDrawingBufferSize();return eP(t,r,i,s,e)}setDevicePixelRatio(t,e={}){if(!this.htmlCanvas)return;let r="width"in e?e.width:this.htmlCanvas.clientWidth,i="height"in e?e.height:this.htmlCanvas.clientHeight;(!r||!i)&&(tt.log(1,"Canvas clientWidth/clientHeight is 0")(),t=1,r=this.htmlCanvas.width||1,i=this.htmlCanvas.height||1);const s=this._canvasSizeInfo;if(s.clientWidth!==r||s.clientHeight!==i||s.devicePixelRatio!==t){let o=t;const a=Math.floor(r*o),l=Math.floor(i*o);if(this.htmlCanvas.width=a,this.htmlCanvas.height=l,this.device.gl){const[u,h]=this.getDrawingBufferSize();(u!==a||h!==l)&&(o=Math.min(u/r,h/i),this.htmlCanvas.width=Math.floor(r*o),this.htmlCanvas.height=Math.floor(i*o),tt.warn("Device pixel ratio clamped")()),this._canvasSizeInfo.clientWidth=r,this._canvasSizeInfo.clientHeight=i,this._canvasSizeInfo.devicePixelRatio=t}}}getDrawingBufferSize(){const t=this.device.gl;return t?[t.drawingBufferWidth,t.drawingBufferHeight]:this.getPixelSize()}_setAutoCreatedCanvasId(t){this.htmlCanvas?.id==="lumagl-auto-created-canvas"&&(this.htmlCanvas.id=t)}}function JT(n){if(typeof n=="string"){const t=document.getElementById(n);if(!t)throw new Error(`${n} is not an HTML element`);return t}else if(n)return n;return document.body}function QT(n){const t=document.getElementById(n);if(!(t instanceof HTMLCanvasElement))throw new Error("Object is not a canvas element");return t}function tP(n){const{width:t,height:e}=n,r=document.createElement("canvas");return r.id=bh("lumagl-auto-created-canvas"),r.width=t||1,r.height=e||1,r.style.width=Number.isFinite(t)?`${t}px`:"100%",r.style.height=Number.isFinite(e)?`${e}px`:"100%",r}function eP(n,t,e,r,i){const s=n,o=bm(s[0],t,e);let a=xm(s[1],t,r,i),l=bm(s[0]+1,t,e);const c=l===e-1?l:l-1;l=xm(s[1]+1,t,r,i);let u;return i?(l=l===0?l:l+1,u=a,a=l):u=l===r-1?l:l-1,{x:o,y:a,width:Math.max(c-o+1,1),height:Math.max(u-a+1,1)}}function bm(n,t,e){return Math.min(Math.round(n*t),e-1)}function xm(n,t,e,r){return r?Math.max(0,e-1-Math.round(n*t)):Math.min(Math.round(n*t),e-1)}class jt extends $t{static COPY_SRC=1;static COPY_DST=2;static TEXTURE=4;static STORAGE=8;static RENDER_ATTACHMENT=16;static CubeFaces=["+X","-X","+Y","-Y","+Z","-Z"];static defaultProps={...$t.defaultProps,data:null,dimension:"2d",format:"rgba8unorm",width:void 0,height:void 0,depth:1,mipmaps:!1,compressed:!1,usage:0,mipLevels:void 0,samples:void 0,sampler:{},view:void 0,flipY:void 0};get[Symbol.toStringTag](){return"Texture"}toString(){return`Texture(${this.id},${this.format},${this.width}x${this.height})`}dimension;format;width;height;depth;mipLevels;updateTimestamp;constructor(t,e){if(e=jt.normalizeProps(t,e),super(t,e,jt.defaultProps),this.dimension=this.props.dimension,this.format=this.props.format,this.width=this.props.width,this.height=this.props.height,this.depth=this.props.depth,this.props.width===void 0||this.props.height===void 0){const r=jt.getTextureDataSize(this.props.data);this.width=r?.width||1,this.height=r?.height||1}this.props.mipmaps&&this.props.mipLevels===void 0&&(this.props.mipLevels="pyramid"),this.mipLevels=this.props.mipLevels==="pyramid"?jt.getMipLevelCount(this.width,this.height):this.props.mipLevels||1,this.updateTimestamp=t.incrementTimestamp()}clone(t){return this.device.createTexture({...this.props,...t})}static isExternalImage(t){return typeof ImageData<"u"&&t instanceof ImageData||typeof ImageBitmap<"u"&&t instanceof ImageBitmap||typeof HTMLImageElement<"u"&&t instanceof HTMLImageElement||typeof HTMLVideoElement<"u"&&t instanceof HTMLVideoElement||typeof VideoFrame<"u"&&t instanceof VideoFrame||typeof HTMLCanvasElement<"u"&&t instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&t instanceof OffscreenCanvas}static getExternalImageSize(t){if(typeof ImageData<"u"&&t instanceof ImageData||typeof ImageBitmap<"u"&&t instanceof ImageBitmap||typeof HTMLCanvasElement<"u"&&t instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&t instanceof OffscreenCanvas)return{width:t.width,height:t.height};if(typeof HTMLImageElement<"u"&&t instanceof HTMLImageElement)return{width:t.naturalWidth,height:t.naturalHeight};if(typeof HTMLVideoElement<"u"&&t instanceof HTMLVideoElement)return{width:t.videoWidth,height:t.videoHeight};if(typeof VideoFrame<"u"&&t instanceof VideoFrame)return{width:t.displayWidth,height:t.displayHeight};throw new Error("Unknown image type")}static isTextureLevelData(t){const e=t?.data;return ArrayBuffer.isView(e)}static getTextureDataSize(t){if(!t||ArrayBuffer.isView(t))return null;if(Array.isArray(t))return jt.getTextureDataSize(t[0]);if(jt.isExternalImage(t))return jt.getExternalImageSize(t);if(t&&typeof t=="object"&&t.constructor===Object){const r=Object.values(t)[0];return{width:r.width,height:r.height}}throw new Error("texture size deduction failed")}static normalizeTextureData(t,e){let r;return ArrayBuffer.isView(t)?r=[{data:t,width:e.width,height:e.height}]:Array.isArray(t)?r=t:r=[t],r}static getMipLevelCount(t,e){return Math.floor(Math.log2(Math.max(t,e)))+1}static getCubeFaceDepth(t){switch(t){case"+X":return 0;case"-X":return 1;case"+Y":return 2;case"-Y":return 3;case"+Z":return 4;case"-Z":return 5;default:throw new Error(t)}}static defaultCopyExternalImageOptions={image:void 0,sourceX:0,sourceY:0,width:void 0,height:void 0,depth:1,mipLevel:0,x:0,y:0,z:0,aspect:"all",colorSpace:"srgb",premultipliedAlpha:!1,flipY:!1};static normalizeProps(t,e){const r={...e},i=t?.props?._resourceDefaults?.texture||{};Object.assign(r,i);const{width:s,height:o}=r;return typeof s=="number"&&(r.width=Math.max(1,Math.ceil(s))),typeof o=="number"&&(r.height=Math.max(1,Math.ceil(o))),r}}class xh extends $t{static defaultProps={...$t.defaultProps,format:void 0,dimension:void 0,aspect:"all",baseMipLevel:0,mipLevelCount:void 0,baseArrayLayer:0,arrayLayerCount:void 0};get[Symbol.toStringTag](){return"TextureView"}constructor(t,e){super(t,e,xh.defaultProps)}}function nP(n,t,e){let r="";const i=t.split(/\r?\n/),s=n.slice().sort((o,a)=>o.lineNum-a.lineNum);switch(e?.showSourceCode||"no"){case"all":let o=0;for(let a=1;a<=i.length;a++)for(r+=U0(i[a-1],a,e);s.length>o&&s[o].lineNum===a;){const l=s[o++];r+=Em(l,i,l.lineNum,{...e,inlineSource:!1})}return r;case"issues":case"no":for(const a of n)r+=Em(a,i,a.lineNum,{inlineSource:e?.showSourceCode!=="no"});return r}}function Em(n,t,e,r){if(r?.inlineSource){const s=rP(t,e),o=n.linePos>0?`${" ".repeat(n.linePos+5)}^^^
`:"";return`
${s}${o}${n.type.toUpperCase()}: ${n.message}

`}const i=n.type==="error"?"red":"#8B4000";return r?.html?`<div class='luma-compiler-log-error' style="color:${i};"><b> ${n.type.toUpperCase()}: ${n.message}</b></div>`:`${n.type.toUpperCase()}: ${n.message}`}function rP(n,t,e){let r="";for(let i=t-2;i<=t;i++){const s=n[i-1];s!==void 0&&(r+=U0(s,t,e))}return r}function U0(n,t,e){const r=e?.html?sP(n):n;return`${iP(String(t),4)}: ${r}${e?.html?"<br/>":`
`}`}function iP(n,t){let e="";for(let r=n.length;r<t;++r)e+=" ";return e+n}function sP(n){return n.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}class Eh extends $t{static defaultProps={...$t.defaultProps,language:"auto",stage:void 0,source:"",sourceMap:null,entryPoint:"main",debugShaders:void 0};get[Symbol.toStringTag](){return"Shader"}stage;source;compilationStatus="pending";constructor(t,e){e={...e,debugShaders:e.debugShaders||t.props.debugShaders||"errors"},super(t,{id:oP(e),...e},Eh.defaultProps),this.stage=this.props.stage,this.source=this.props.source}getCompilationInfoSync(){return null}getTranslatedSource(){return null}async debugShader(){const t=this.props.debugShaders;switch(t){case"never":return;case"errors":if(this.compilationStatus==="success")return;break}const e=await this.getCompilationInfo();t==="warnings"&&e?.length===0||this._displayShaderLog(e)}_displayShaderLog(t){if(typeof document>"u"||!document?.createElement)return;const e=V0(this.source),r=`${this.stage} ${e}`;let i=nP(t,this.source,{showSourceCode:"all",html:!0});const s=this.getTranslatedSource();s&&(i+=`<br /><br /><h1>Translated Source</h1><br /><br /><code style="user-select:text;"><pre>${s}</pre></code>`);const o=document.createElement("Button");o.innerHTML=`
<h1>Shader Compilation Error in ${r}</h1><br /><br />
<code style="user-select:text;"><pre>
${i}
</pre></code>`,o.style.top="10px",o.style.left="10px",o.style.position="absolute",o.style.zIndex="9999",o.style.width="100%",o.style.textAlign="left",document.body.appendChild(o),document.getElementsByClassName("luma-compiler-log-error")[0]?.scrollIntoView(),o.onclick=()=>{const l=`data:text/plain,${encodeURIComponent(this.source)}`;navigator.clipboard.writeText(l)}}}function oP(n){return V0(n.source)||n.id||bh(`unnamed ${n.stage}-shader`)}function V0(n,t="unnamed"){const r=/#define[\s*]SHADER_NAME[\s*]([A-Za-z0-9_-]+)[\s*]/.exec(n);return r?r[1]:t}class Pl extends $t{static defaultProps={...$t.defaultProps,type:"color-sampler",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",addressModeW:"clamp-to-edge",magFilter:"nearest",minFilter:"nearest",mipmapFilter:"none",lodMinClamp:0,lodMaxClamp:32,compare:"less-equal",maxAnisotropy:1};get[Symbol.toStringTag](){return"Sampler"}constructor(t,e){e=Pl.normalizeProps(t,e),super(t,e,Pl.defaultProps)}static normalizeProps(t,e){const r=t?.props?._resourceDefaults?.sampler||{};return{...e,...r}}}class wh extends $t{static defaultProps={...$t.defaultProps,width:1,height:1,colorAttachments:[],depthStencilAttachment:null};get[Symbol.toStringTag](){return"Framebuffer"}width;height;constructor(t,e={}){super(t,e,wh.defaultProps),this.width=this.props.width,this.height=this.props.height}clone(t){const e=this.colorAttachments.map(i=>i.texture.clone(t)),r=this.depthStencilAttachment&&this.depthStencilAttachment.texture.clone(t);return this.device.createFramebuffer({...this.props,colorAttachments:e,depthStencilAttachment:r})}resize(t){let e=!t;if(t){const[r,i]=Array.isArray(t)?t:[t.width,t.height];e=e||i!==this.height||r!==this.width,this.width=r,this.height=i}e&&(tt.log(2,`Resizing framebuffer ${this.id} to ${this.width}x${this.height}`)(),this.resizeAttachments(this.width,this.height))}autoCreateAttachmentTextures(){if(this.props.colorAttachments.length===0&&!this.props.depthStencilAttachment)throw new Error("Framebuffer has noattachments");this.colorAttachments=this.props.colorAttachments.map((e,r)=>{if(typeof e=="string"){const i=this.createColorTexture(e,r);return this.attachResource(i),i.view}return e instanceof jt?e.view:e});const t=this.props.depthStencilAttachment;if(t)if(typeof t=="string"){const e=this.createDepthStencilTexture(t);this.attachResource(e),this.depthStencilAttachment=e.view}else t instanceof jt?this.depthStencilAttachment=t.view:this.depthStencilAttachment=t}createColorTexture(t,e){return this.device.createTexture({id:`${this.id}-color-attachment-${e}`,usage:jt.RENDER_ATTACHMENT,format:t,width:this.width,height:this.height,sampler:{magFilter:"linear",minFilter:"linear"}})}createDepthStencilTexture(t){return this.device.createTexture({id:`${this.id}-depth-stencil-attachment`,usage:jt.RENDER_ATTACHMENT,format:t,width:this.width,height:this.height,mipmaps:!1})}resizeAttachments(t,e){for(let r=0;r<this.colorAttachments.length;++r)if(this.colorAttachments[r]){const i=this.colorAttachments[r].texture.clone({width:t,height:e});this.destroyAttachedResource(this.colorAttachments[r]),this.colorAttachments[r]=i.view,this.attachResource(i.view)}if(this.depthStencilAttachment){const r=this.depthStencilAttachment.texture.clone({width:t,height:e});this.destroyAttachedResource(this.depthStencilAttachment),this.depthStencilAttachment=r.view,this.attachResource(r)}this.updateAttachments()}}class la extends $t{static defaultProps={...$t.defaultProps,vs:null,vertexEntryPoint:"vertexMain",vsConstants:{},fs:null,fragmentEntryPoint:"fragmentMain",fsConstants:{},shaderLayout:null,bufferLayout:[],topology:"triangle-list",parameters:{},bindings:{},uniforms:{}};get[Symbol.toStringTag](){return"RenderPipeline"}shaderLayout;bufferLayout;linkStatus="pending";hash="";constructor(t,e){super(t,e,la.defaultProps),this.shaderLayout=this.props.shaderLayout,this.bufferLayout=this.props.bufferLayout||[]}setUniformsWebGL(t){throw new Error("Use uniform blocks")}}class Zs extends $t{static defaultClearColor=[0,0,0,1];static defaultClearDepth=1;static defaultClearStencil=0;static defaultProps={...$t.defaultProps,framebuffer:null,parameters:void 0,clearColor:Zs.defaultClearColor,clearColors:void 0,clearDepth:Zs.defaultClearDepth,clearStencil:Zs.defaultClearStencil,depthReadOnly:!1,stencilReadOnly:!1,discard:!1,occlusionQuerySet:void 0,timestampQuerySet:void 0,beginTimestampIndex:void 0,endTimestampIndex:void 0};get[Symbol.toStringTag](){return"RenderPass"}constructor(t,e){e=Zs.normalizeProps(t,e),super(t,e,Zs.defaultProps)}static normalizeProps(t,e){return{...t.props._resourceDefaults?.renderPass,...e}}}class Mu extends $t{static defaultProps={...$t.defaultProps,shader:void 0,entryPoint:void 0,constants:{},shaderLayout:void 0};get[Symbol.toStringTag](){return"ComputePipeline"}hash="";shaderLayout;constructor(t,e){super(t,e,Mu.defaultProps),this.shaderLayout=e.shaderLayout}}class Sp extends $t{static defaultProps={...$t.defaultProps,measureExecutionTime:void 0};get[Symbol.toStringTag](){return"CommandEncoder"}constructor(t,e){super(t,e,Sp.defaultProps)}}class Cp extends $t{static defaultProps={...$t.defaultProps};get[Symbol.toStringTag](){return"CommandBuffer"}constructor(t,e){super(t,e,Cp.defaultProps)}}function aP(n){const[t,e]=cP[n],r=t==="i32"||t==="u32",i=t!=="u32",s=uP[t]*e,o=lP(t,e);return{dataType:t,components:e,defaultVertexFormat:o,byteLength:s,integer:r,signed:i}}function lP(n,t){let e;switch(n){case"f32":e="float32";break;case"i32":e="sint32";break;case"u32":e="uint32";break;case"f16":return t<=2?"float16x2":"float16x4"}return t===1?e:`${e}x${t}`}const cP={f32:["f32",1],"vec2<f32>":["f32",2],"vec3<f32>":["f32",3],"vec4<f32>":["f32",4],f16:["f16",1],"vec2<f16>":["f16",2],"vec3<f16>":["f16",3],"vec4<f16>":["f16",4],i32:["i32",1],"vec2<i32>":["i32",2],"vec3<i32>":["i32",3],"vec4<i32>":["i32",4],u32:["u32",1],"vec2<u32>":["u32",2],"vec3<u32>":["u32",3],"vec4<u32>":["u32",4]},uP={f32:4,f16:2,i32:4,u32:4};function z0(n){let t;n.endsWith("-webgl")&&(n.replace("-webgl",""),t=!0);const[e,r]=n.split("x"),i=e,s=r?parseInt(r):1,o=k0(i),a={type:i,components:s,byteLength:o.byteLength*s,integer:o.integer,signed:o.signed,normalized:o.normalized};return t&&(a.webglOnly=!0),a}function W0(n,t){const e={};for(const r of n.attributes){const i=fP(n,t,r.name);i&&(e[r.name]=i)}return e}function hP(n,t,e=16){const r=W0(n,t),i=new Array(e).fill(null);for(const s of Object.values(r))i[s.location]=s;return i}function fP(n,t,e){const r=dP(n,e),i=pP(t,e);if(!r)return null;const s=aP(r.type),o=i?.vertexFormat||s.defaultVertexFormat,a=z0(o);return{attributeName:i?.attributeName||r.name,bufferName:i?.bufferName||r.name,location:r.location,shaderType:r.type,shaderDataType:s.dataType,shaderComponents:s.components,vertexFormat:o,bufferDataType:a.type,bufferComponents:a.components,normalized:a.normalized,integer:s.integer,stepMode:i?.stepMode||r.stepMode||"vertex",byteOffset:i?.byteOffset||0,byteStride:i?.byteStride||0}}function dP(n,t){const e=n.attributes.find(r=>r.name===t);return e||tt.warn(`shader layout attribute "${t}" not present in shader`),e||null}function pP(n,t){gP(n);let e=mP(n,t);return e||(e=_P(n,t),e)?e:(tt.warn(`layout for attribute "${t}" not present in buffer layout`),null)}function gP(n){for(const t of n)(t.attributes&&t.format||!t.attributes&&!t.format)&&tt.warn(`BufferLayout ${name} must have either 'attributes' or 'format' field`)}function mP(n,t){for(const e of n)if(e.format&&e.name===t)return{attributeName:e.name,bufferName:t,stepMode:e.stepMode,vertexFormat:e.format,byteOffset:0,byteStride:e.byteStride||0};return null}function _P(n,t){for(const e of n){let r=e.byteStride;if(typeof e.byteStride!="number")for(const s of e.attributes||[]){const o=z0(s.format);r+=o.byteLength}const i=e.attributes?.find(s=>s.attribute===t);if(i)return{attributeName:i.attribute,bufferName:e.name,stepMode:e.stepMode,vertexFormat:i.format,byteOffset:i.byteOffset,byteStride:r}}return null}class Tp extends $t{static defaultProps={...$t.defaultProps,renderPipeline:null};get[Symbol.toStringTag](){return"VertexArray"}maxVertexAttributes;attributeInfos;indexBuffer=null;attributes;constructor(t,e){super(t,e,Tp.defaultProps),this.maxVertexAttributes=t.limits.maxVertexAttributes,this.attributes=new Array(this.maxVertexAttributes).fill(null);const{shaderLayout:r,bufferLayout:i}=e.renderPipeline||{};if(!r||!i)throw new Error("VertexArray");this.attributeInfos=hP(r,i,this.maxVertexAttributes)}setConstantWebGL(t,e){this.device.reportError(new Error("constant attributes not supported"))}}class Pp extends $t{static defaultProps={...$t.defaultProps,layout:void 0,buffers:{}};get[Symbol.toStringTag](){return"TransformFeedback"}constructor(t,e){super(t,e,Pp.defaultProps)}}class Ip extends $t{static defaultProps={...$t.defaultProps,type:void 0,count:void 0};get[Symbol.toStringTag](){return"QuerySet"}constructor(t,e){super(t,e,Ip.defaultProps)}}const yP={f32:{type:"f32",components:1},i32:{type:"i32",components:1},u32:{type:"u32",components:1},"vec2<f32>":{type:"f32",components:2},"vec3<f32>":{type:"f32",components:3},"vec4<f32>":{type:"f32",components:4},"vec2<i32>":{type:"i32",components:2},"vec3<i32>":{type:"i32",components:3},"vec4<i32>":{type:"i32",components:4},"vec2<u32>":{type:"u32",components:2},"vec3<u32>":{type:"u32",components:3},"vec4<u32>":{type:"u32",components:4},"mat2x2<f32>":{type:"f32",components:4},"mat2x3<f32>":{type:"f32",components:6},"mat2x4<f32>":{type:"f32",components:8},"mat3x2<f32>":{type:"f32",components:6},"mat3x3<f32>":{type:"f32",components:9},"mat3x4<f32>":{type:"f32",components:12},"mat4x2<f32>":{type:"f32",components:8},"mat4x3<f32>":{type:"f32",components:12},"mat4x4<f32>":{type:"f32",components:16}};function vP(n){return yP[n]}function bP(n,t){switch(t){case 1:return n;case 2:return n+n%2;default:return n+(4-n%4)%4}}let Ic;function H0(n){return(!Ic||Ic.byteLength<n)&&(Ic=new ArrayBuffer(n)),Ic}function xP(n,t){const e=H0(n.BYTES_PER_ELEMENT*t);return new n(e,0,t)}function EP(n){return ArrayBuffer.isView(n)&&!(n instanceof DataView)}function Ru(n){return Array.isArray(n)?n.length===0||typeof n[0]=="number":EP(n)}const wm=1024;class wP{layout={};byteLength;constructor(t){let e=0;for(const[i,s]of Object.entries(t)){const o=vP(s),{type:a,components:l}=o;e=bP(e,l);const c=e;e+=l,this.layout[i]={type:a,size:l,offset:c}}e+=(4-e%4)%4;const r=e*4;this.byteLength=Math.max(r,wm)}getData(t){const e=Math.max(this.byteLength,wm),r=H0(e),i={i32:new Int32Array(r),u32:new Uint32Array(r),f32:new Float32Array(r),f16:new Uint16Array(r)};for(const[s,o]of Object.entries(t)){const a=this.layout[s];if(!a){tt.warn(`Supplied uniform value ${s} not present in uniform block layout`)();continue}const{type:l,size:c,offset:u}=a,h=i[l];if(c===1){if(typeof o!="number"&&typeof o!="boolean"){tt.warn(`Supplied value for single component uniform ${s} is not a number: ${o}`)();continue}h[u]=Number(o)}else{if(!Ru(o)){tt.warn(`Supplied value for multi component / array uniform ${s} is not a numeric array: ${o}`)();continue}h.set(o,u)}}return new Uint8Array(r)}has(t){return!!this.layout[t]}get(t){return this.layout[t]}}function SP(n,t,e=16){if(n!==t)return!1;const r=n,i=t;if(!Ru(r))return!1;if(Ru(i)&&r.length===i.length){for(let s=0;s<r.length;++s)if(i[s]!==r[s])return!1}return!0}function CP(n){return Ru(n)?n.slice():n}class TP{name;uniforms={};modifiedUniforms={};modified=!0;bindingLayout={};needsRedraw="initialized";constructor(t){if(this.name=t?.name||"unnamed",t?.name&&t?.shaderLayout){const e=t?.shaderLayout.bindings?.find(i=>i.type==="uniform"&&i.name===t?.name);if(!e)throw new Error(t?.name);const r=e;for(const i of r.uniforms||[])this.bindingLayout[i.name]=i}}setUniforms(t){for(const[e,r]of Object.entries(t))this._setUniform(e,r),this.needsRedraw||this.setNeedsRedraw(`${this.name}.${e}=${r}`)}setNeedsRedraw(t){this.needsRedraw=this.needsRedraw||t}getAllUniforms(){return this.modifiedUniforms={},this.needsRedraw=!1,this.uniforms||{}}_setUniform(t,e){SP(this.uniforms[t],e)||(this.uniforms[t]=CP(e),this.modifiedUniforms[t]=!0,this.modified=!0)}}class PP{uniformBlocks=new Map;uniformBufferLayouts=new Map;uniformBuffers=new Map;constructor(t){for(const[e,r]of Object.entries(t)){const i=e,s=new wP(r.uniformTypes||{});this.uniformBufferLayouts.set(i,s);const o=new TP({name:e});o.setUniforms(r.defaultUniforms||{}),this.uniformBlocks.set(i,o)}}destroy(){for(const t of this.uniformBuffers.values())t.destroy()}setUniforms(t){for(const[e,r]of Object.entries(t))this.uniformBlocks.get(e)?.setUniforms(r);this.updateUniformBuffers()}getUniformBufferByteLength(t){return this.uniformBufferLayouts.get(t)?.byteLength||0}getUniformBufferData(t){const e=this.uniformBlocks.get(t)?.getAllUniforms()||{};return this.uniformBufferLayouts.get(t)?.getData(e)}createUniformBuffer(t,e,r){r&&this.setUniforms(r);const i=this.getUniformBufferByteLength(e),s=t.createBuffer({usage:Yt.UNIFORM|Yt.COPY_DST,byteLength:i}),o=this.getUniformBufferData(e);return s.write(o),s}getManagedUniformBuffer(t,e){if(!this.uniformBuffers.get(e)){const r=this.getUniformBufferByteLength(e),i=t.createBuffer({usage:Yt.UNIFORM|Yt.COPY_DST,byteLength:r});this.uniformBuffers.set(e,i)}return this.uniformBuffers.get(e)}updateUniformBuffers(){let t=!1;for(const e of this.uniformBlocks.keys()){const r=this.updateUniformBuffer(e);t||=r}return t&&tt.log(3,`UniformStore.updateUniformBuffers(): ${t}`)(),t}updateUniformBuffer(t){const e=this.uniformBlocks.get(t);let r=this.uniformBuffers.get(t),i=!1;if(r&&e?.needsRedraw){i||=e.needsRedraw;const s=this.getUniformBufferData(t);r=this.uniformBuffers.get(t),r?.write(s);const o=this.uniformBlocks.get(t)?.getAllUniforms();tt.log(4,`Writing to uniform buffer ${String(t)}`,s,o)()}return i}}function j0(n){const t=ArrayBuffer.isView(n)?n.constructor:n;switch(t){case Float32Array:return"float32";case Uint16Array:return"uint16";case Uint32Array:return"uint32";case Uint8Array:case Uint8ClampedArray:return"uint8";case Int8Array:return"sint8";case Int16Array:return"sint16";case Int32Array:return"sint32";default:throw new Error(t.constructor.name)}}function $0(n){switch(n){case"float32":return Float32Array;case"uint32":return Uint32Array;case"sint32":return Int32Array;case"uint16":case"unorm16":return Uint16Array;case"sint16":case"snorm16":return Int16Array;case"uint8":case"unorm8":return Uint8Array;case"sint8":case"snorm8":return Int8Array;default:throw new Error(n)}}function IP(n,t,e){if(!t||t>4)throw new Error(`size ${t}`);const r=t;let i=j0(n);if(i==="uint8"&&e&&r===1)return"unorm8-webgl";if(i==="uint8"&&e&&r===3)return"unorm8x3-webgl";if(i==="uint8"||i==="sint8"){if(r===1||r===3)throw new Error(`size: ${t}`);return e&&(i=i.replace("int","norm")),`${i}x${r}`}if(i==="uint16"||i==="sint16"){if(r===1||r===3)throw new Error(`size: ${t}`);return e&&(i=i.replace("int","norm")),`${i}x${r}`}return r===1?i:`${i}x${r}`}class hf{bufferLayouts;constructor(t){this.bufferLayouts=t}getBufferLayout(t){return this.bufferLayouts.find(e=>e.name===t)||null}getAttributeNamesForBuffer(t){return t.attributes?t.attributes?.map(e=>e.attribute):[t.name]}mergeBufferLayouts(t,e){const r=[...t];for(const i of e){const s=r.findIndex(o=>o.name===i.name);s<0?r.push(i):r[s]=i}return r}getBufferIndex(t){const e=this.bufferLayouts.findIndex(r=>r.name===t);return e===-1&&tt.warn(`BufferLayout: Missing buffer for "${t}".`)(),e}}function AP(n,t){const e=Object.fromEntries(n.attributes.map(i=>[i.name,i.location])),r=t.slice();return r.sort((i,s)=>{const o=i.attributes?i.attributes.map(u=>u.attribute):[i.name],a=s.attributes?s.attributes.map(u=>u.attribute):[s.name],l=Math.min(...o.map(u=>e[u])),c=Math.min(...a.map(u=>e[u]));return l-c}),r}let Er=class{constructor(t,e){this.name=t,this.attributes=e,this.size=0}get isArray(){return!1}get isStruct(){return!1}get isTemplate(){return!1}get isPointer(){return!1}getTypeName(){return this.name}},Sm=class{constructor(t,e,r){this.name=t,this.type=e,this.attributes=r,this.offset=0,this.size=0}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}},gs=class extends Er{constructor(t,e){super(t,e),this.members=[],this.align=0,this.startLine=-1,this.endLine=-1,this.inUse=!1}get isStruct(){return!0}},ws=class extends Er{constructor(t,e){super(t,e),this.count=0,this.stride=0}get isArray(){return!0}getTypeName(){return`array<${this.format.getTypeName()}, ${this.count}>`}},pd=class extends Er{constructor(t,e,r){super(t,r),this.format=e}get isPointer(){return!0}getTypeName(){return`&${this.format.getTypeName()}`}},oo=class extends Er{constructor(t,e,r,i){super(t,r),this.format=e,this.access=i}get isTemplate(){return!0}getTypeName(){let t=this.name;if(this.format!==null){if(t==="vec2"||t==="vec3"||t==="vec4"||t==="mat2x2"||t==="mat2x3"||t==="mat2x4"||t==="mat3x2"||t==="mat3x3"||t==="mat3x4"||t==="mat4x2"||t==="mat4x3"||t==="mat4x4"){if(this.format.name==="f32")return t+="f",t;if(this.format.name==="i32")return t+="i",t;if(this.format.name==="u32")return t+="u",t;if(this.format.name==="bool")return t+="b",t;if(this.format.name==="f16")return t+="h",t}t+=`<${this.format.name}>`}else if(t==="vec2"||t==="vec3"||t==="vec4")return t;return t}};var hs;(n=>{n[n.Uniform=0]="Uniform",n[n.Storage=1]="Storage",n[n.Texture=2]="Texture",n[n.Sampler=3]="Sampler",n[n.StorageTexture=4]="StorageTexture"})(hs||(hs={}));let Ac=class{constructor(t,e,r,i,s,o,a){this.name=t,this.type=e,this.group=r,this.binding=i,this.attributes=s,this.resourceType=o,this.access=a}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get size(){return this.type.size}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}},MP=class{constructor(t,e){this.name=t,this.type=e}},RP=class{constructor(t,e,r,i){this.name=t,this.type=e,this.locationType=r,this.location=i,this.interpolation=null}},Cm=class{constructor(t,e,r,i){this.name=t,this.type=e,this.locationType=r,this.location=i}};class NP{constructor(t,e,r,i){this.name=t,this.type=e,this.attributes=r,this.id=i}}let OP=class{constructor(t,e,r){this.name=t,this.type=e,this.attributes=r}},DP=class{constructor(t,e=null,r){this.stage=null,this.inputs=[],this.outputs=[],this.arguments=[],this.returnType=null,this.resources=[],this.overrides=[],this.startLine=-1,this.endLine=-1,this.inUse=!1,this.calls=new Set,this.name=t,this.stage=e,this.attributes=r}},LP=class{constructor(){this.vertex=[],this.fragment=[],this.compute=[]}};const X0=new Float32Array(1),kP=new Int32Array(X0.buffer),pn=new Uint16Array(1);function FP(n){X0[0]=n;const t=kP[0],e=t>>31&1;let r=t>>23&255,i=8388607&t;if(r===255)return pn[0]=e<<15|31744|(i!==0?512:0),pn[0];if(r===0){if(i===0)return pn[0]=e<<15,pn[0];i|=8388608;let s=113;for(;!(8388608&i);)i<<=1,s--;return r=127-s,i&=8388607,r>0?(i=(i>>126-r)+(i>>127-r&1),pn[0]=e<<15|r<<10|i>>13,pn[0]):(pn[0]=e<<15,pn[0])}return r=r-127+15,r>=31?(pn[0]=e<<15|31744,pn[0]):r<=0?r<-10?(pn[0]=e<<15,pn[0]):(i=(8388608|i)>>1-r,pn[0]=e<<15|i>>13,pn[0]):(i>>=13,pn[0]=e<<15|r<<10|i,pn[0])}const Ap=new Uint32Array(1),G0=new Float32Array(Ap.buffer,0,1);function Tm(n){const t=112+(n>>6&31)<<23|(63&n)<<17;return Ap[0]=t,G0[0]}function BP(n,t,e,r,i,s,o,a,l){const c=r*(o>>=i)*(s>>=i)+e*o+t*a;switch(l){case"r8unorm":return[Bt(n,c,"8unorm",1)[0]];case"r8snorm":return[Bt(n,c,"8snorm",1)[0]];case"r8uint":return[Bt(n,c,"8uint",1)[0]];case"r8sint":return[Bt(n,c,"8sint",1)[0]];case"rg8unorm":{const u=Bt(n,c,"8unorm",2);return[u[0],u[1]]}case"rg8snorm":{const u=Bt(n,c,"8snorm",2);return[u[0],u[1]]}case"rg8uint":{const u=Bt(n,c,"8uint",2);return[u[0],u[1]]}case"rg8sint":{const u=Bt(n,c,"8sint",2);return[u[0],u[1]]}case"rgba8unorm-srgb":case"rgba8unorm":{const u=Bt(n,c,"8unorm",4);return[u[0],u[1],u[2],u[3]]}case"rgba8snorm":{const u=Bt(n,c,"8snorm",4);return[u[0],u[1],u[2],u[3]]}case"rgba8uint":{const u=Bt(n,c,"8uint",4);return[u[0],u[1],u[2],u[3]]}case"rgba8sint":{const u=Bt(n,c,"8sint",4);return[u[0],u[1],u[2],u[3]]}case"bgra8unorm-srgb":case"bgra8unorm":{const u=Bt(n,c,"8unorm",4);return[u[2],u[1],u[0],u[3]]}case"r16uint":return[Bt(n,c,"16uint",1)[0]];case"r16sint":return[Bt(n,c,"16sint",1)[0]];case"r16float":return[Bt(n,c,"16float",1)[0]];case"rg16uint":{const u=Bt(n,c,"16uint",2);return[u[0],u[1]]}case"rg16sint":{const u=Bt(n,c,"16sint",2);return[u[0],u[1]]}case"rg16float":{const u=Bt(n,c,"16float",2);return[u[0],u[1]]}case"rgba16uint":{const u=Bt(n,c,"16uint",4);return[u[0],u[1],u[2],u[3]]}case"rgba16sint":{const u=Bt(n,c,"16sint",4);return[u[0],u[1],u[2],u[3]]}case"rgba16float":{const u=Bt(n,c,"16float",4);return[u[0],u[1],u[2],u[3]]}case"r32uint":return[Bt(n,c,"32uint",1)[0]];case"r32sint":return[Bt(n,c,"32sint",1)[0]];case"depth16unorm":case"depth24plus":case"depth24plus-stencil8":case"depth32float":case"depth32float-stencil8":case"r32float":return[Bt(n,c,"32float",1)[0]];case"rg32uint":{const u=Bt(n,c,"32uint",2);return[u[0],u[1]]}case"rg32sint":{const u=Bt(n,c,"32sint",2);return[u[0],u[1]]}case"rg32float":{const u=Bt(n,c,"32float",2);return[u[0],u[1]]}case"rgba32uint":{const u=Bt(n,c,"32uint",4);return[u[0],u[1],u[2],u[3]]}case"rgba32sint":{const u=Bt(n,c,"32sint",4);return[u[0],u[1],u[2],u[3]]}case"rgba32float":{const u=Bt(n,c,"32float",4);return[u[0],u[1],u[2],u[3]]}case"rg11b10ufloat":{const u=new Uint32Array(n.buffer,c,1)[0],h=(4192256&u)>>11,f=(4290772992&u)>>22;return[Tm(2047&u),Tm(h),function(d){const p=112+(d>>5&31)<<23|(31&d)<<18;return Ap[0]=p,G0[0]}(f),1]}}return null}function Bt(n,t,e,r){const i=[0,0,0,0];for(let c=0;c<r;++c)switch(e){case"8unorm":i[c]=n[t]/255,t++;break;case"8snorm":i[c]=n[t]/255*2-1,t++;break;case"8uint":i[c]=n[t],t++;break;case"8sint":i[c]=n[t]-127,t++;break;case"16uint":i[c]=n[t]|n[t+1]<<8,t+=2;break;case"16sint":i[c]=(n[t]|n[t+1]<<8)-32768,t+=2;break;case"16float":i[c]=(s=n[t]|n[t+1]<<8,o=void 0,a=void 0,l=void 0,o=(32768&s)>>15,l=1023&s,(a=(31744&s)>>10)==0?(o?-1:1)*Math.pow(2,-14)*(l/Math.pow(2,10)):a==31?l?NaN:1/0*(o?-1:1):(o?-1:1)*Math.pow(2,a-15)*(1+l/Math.pow(2,10))),t+=2;break;case"32uint":case"32sint":i[c]=n[t]|n[t+1]<<8|n[t+2]<<16|n[t+3]<<24,t+=4;break;case"32float":i[c]=new Float32Array(n.buffer,t,1)[0],t+=4}var s,o,a,l;return i}function zt(n,t,e,r,i){for(let s=0;s<r;++s)switch(e){case"8unorm":n[t]=255*i[s],t++;break;case"8snorm":n[t]=.5*(i[s]+1)*255,t++;break;case"8uint":n[t]=i[s],t++;break;case"8sint":n[t]=i[s]+127,t++;break;case"16uint":new Uint16Array(n.buffer,t,1)[0]=i[s],t+=2;break;case"16sint":new Int16Array(n.buffer,t,1)[0]=i[s],t+=2;break;case"16float":{const o=FP(i[s]);new Uint16Array(n.buffer,t,1)[0]=o,t+=2;break}case"32uint":new Uint32Array(n.buffer,t,1)[0]=i[s],t+=4;break;case"32sint":new Int32Array(n.buffer,t,1)[0]=i[s],t+=4;break;case"32float":new Float32Array(n.buffer,t,1)[0]=i[s],t+=4}return i}const ff={r8unorm:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8snorm:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8uint:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8sint:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg8unorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8snorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8uint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8sint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba8unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"rgba8unorm-srgb":{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8snorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},bgra8unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"bgra8unorm-srgb":{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},r16uint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r16sint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r16float:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg16uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg16sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg16float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba16uint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba16sint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba16float:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},r32uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r32sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r32float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg32uint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg32sint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg32float:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba32uint:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba32sint:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba32float:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgb10a2uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgb10a2unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rg11b10ufloat:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},stencil8:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!1,hasStencil:!0,channels:1},depth16unorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,channels:1},depth24plus:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,depthOnlyFormat:"depth32float",channels:1},"depth24plus-stencil8":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!0,depthOnlyFormat:"depth32float",channels:1},depth32float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,channels:1},"depth32float-stencil8":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!0,stencilOnlyFormat:"depth32float",channels:1},rgb9e5ufloat:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"bc1-rgba-unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc1-rgba-unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc2-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc2-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc3-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc3-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc4-r-unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:1},"bc4-r-snorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:1},"bc5-rg-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:2},"bc5-rg-snorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:2},"bc6h-rgb-ufloat":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc6h-rgb-float":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc7-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc7-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8a1unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8a1unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgba8unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgba8unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"eac-r11unorm":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!0,channels:1},"eac-r11snorm":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!0,channels:1},"eac-rg11unorm":{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!0,channels:2},"eac-rg11snorm":{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!0,channels:2},"astc-4x4-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"astc-4x4-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"astc-5x4-unorm":{bytesPerBlock:16,blockWidth:5,blockHeight:4,isCompressed:!0,channels:4},"astc-5x4-unorm-srgb":{bytesPerBlock:16,blockWidth:5,blockHeight:4,isCompressed:!0,channels:4},"astc-5x5-unorm":{bytesPerBlock:16,blockWidth:5,blockHeight:5,isCompressed:!0,channels:4},"astc-5x5-unorm-srgb":{bytesPerBlock:16,blockWidth:5,blockHeight:5,isCompressed:!0,channels:4},"astc-6x5-unorm":{bytesPerBlock:16,blockWidth:6,blockHeight:5,isCompressed:!0,channels:4},"astc-6x5-unorm-srgb":{bytesPerBlock:16,blockWidth:6,blockHeight:5,isCompressed:!0,channels:4},"astc-6x6-unorm":{bytesPerBlock:16,blockWidth:6,blockHeight:6,isCompressed:!0,channels:4},"astc-6x6-unorm-srgb":{bytesPerBlock:16,blockWidth:6,blockHeight:6,isCompressed:!0,channels:4},"astc-8x5-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:5,isCompressed:!0,channels:4},"astc-8x5-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:5,isCompressed:!0,channels:4},"astc-8x6-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:6,isCompressed:!0,channels:4},"astc-8x6-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:6,isCompressed:!0,channels:4},"astc-8x8-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:8,isCompressed:!0,channels:4},"astc-8x8-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:8,isCompressed:!0,channels:4},"astc-10x5-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:5,isCompressed:!0,channels:4},"astc-10x5-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:5,isCompressed:!0,channels:4},"astc-10x6-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:6,isCompressed:!0,channels:4},"astc-10x6-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:6,isCompressed:!0,channels:4},"astc-10x8-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:8,isCompressed:!0,channels:4},"astc-10x8-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:8,isCompressed:!0,channels:4},"astc-10x10-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:10,isCompressed:!0,channels:4},"astc-10x10-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:10,isCompressed:!0,channels:4},"astc-12x10-unorm":{bytesPerBlock:16,blockWidth:12,blockHeight:10,isCompressed:!0,channels:4},"astc-12x10-unorm-srgb":{bytesPerBlock:16,blockWidth:12,blockHeight:10,isCompressed:!0,channels:4},"astc-12x12-unorm":{bytesPerBlock:16,blockWidth:12,blockHeight:12,isCompressed:!0,channels:4},"astc-12x12-unorm-srgb":{bytesPerBlock:16,blockWidth:12,blockHeight:12,isCompressed:!0,channels:4}};let Li=class Y0{constructor(){this.id=Y0._id++,this.line=0}get isAstNode(){return!0}get astNodeType(){return""}search(t){t(this)}searchBlock(t,e){if(t){e(Nu.instance);for(const r of t)r instanceof Array?this.searchBlock(r,e):r.search(e);e(Ou.instance)}}constEvaluate(t,e){throw new Error("Cannot evaluate node")}constEvaluateString(t){return this.constEvaluate(t).toString()}};Li._id=0;let Nu=class extends Li{};Nu.instance=new Nu;let Ou=class extends Li{};Ou.instance=new Ou;const q0=new Set(["all","all","any","select","arrayLength","abs","acos","acosh","asin","asinh","atan","atanh","atan2","ceil","clamp","cos","cosh","countLeadingZeros","countOneBits","countTrailingZeros","cross","degrees","determinant","distance","dot","dot4U8Packed","dot4I8Packed","exp","exp2","extractBits","faceForward","firstLeadingBit","firstTrailingBit","floor","fma","fract","frexp","insertBits","inverseSqrt","ldexp","length","log","log2","max","min","mix","modf","normalize","pow","quantizeToF16","radians","reflect","refract","reverseBits","round","saturate","sign","sin","sinh","smoothStep","sqrt","step","tan","tanh","transpose","trunc","dpdx","dpdxCoarse","dpdxFine","dpdy","dpdyCoarse","dpdyFine","fwidth","fwidthCoarse","fwidthFine","textureDimensions","textureGather","textureGatherCompare","textureLoad","textureNumLayers","textureNumLevels","textureNumSamples","textureSample","textureSampleBias","textureSampleCompare","textureSampleCompareLevel","textureSampleGrad","textureSampleLevel","textureSampleBaseClampToEdge","textureStore","atomicLoad","atomicStore","atomicAdd","atomicSub","atomicMax","atomicMin","atomicAnd","atomicOr","atomicXor","atomicExchange","atomicCompareExchangeWeak","pack4x8snorm","pack4x8unorm","pack4xI8","pack4xU8","pack4x8Clamp","pack4xU8Clamp","pack2x16snorm","pack2x16unorm","pack2x16float","unpack4x8snorm","unpack4x8unorm","unpack4xI8","unpack4xU8","unpack2x16snorm","unpack2x16unorm","unpack2x16float","storageBarrier","textureBarrier","workgroupBarrier","workgroupUniformLoad","subgroupAdd","subgroupExclusiveAdd","subgroupInclusiveAdd","subgroupAll","subgroupAnd","subgroupAny","subgroupBallot","subgroupBroadcast","subgroupBroadcastFirst","subgroupElect","subgroupMax","subgroupMin","subgroupMul","subgroupExclusiveMul","subgroupInclusiveMul","subgroupOr","subgroupShuffle","subgroupShuffleDown","subgroupShuffleUp","subgroupShuffleXor","subgroupXor","quadBroadcast","quadSwapDiagonal","quadSwapX","quadSwapY"]);class ce extends Li{constructor(){super()}}let Il=class extends ce{constructor(t,e,r,i,s,o){super(),this.calls=new Set,this.name=t,this.args=e,this.returnType=r,this.body=i,this.startLine=s,this.endLine=o}get astNodeType(){return"function"}search(t){if(this.attributes)for(const e of this.attributes)t(e);t(this);for(const e of this.args)t(e);this.searchBlock(this.body,t)}},UP=class extends ce{constructor(t){super(),this.expression=t}get astNodeType(){return"staticAssert"}search(t){this.expression.search(t)}},K0=class extends ce{constructor(t,e){super(),this.condition=t,this.body=e}get astNodeType(){return"while"}search(t){this.condition.search(t),this.searchBlock(this.body,t)}},gd=class extends ce{constructor(t,e){super(),this.body=t,this.loopId=e}get astNodeType(){return"continuing"}search(t){this.searchBlock(this.body,t)}},Z0=class extends ce{constructor(t,e,r,i){super(),this.init=t,this.condition=e,this.increment=r,this.body=i}get astNodeType(){return"for"}search(t){var e,r,i;(e=this.init)===null||e===void 0||e.search(t),(r=this.condition)===null||r===void 0||r.search(t),(i=this.increment)===null||i===void 0||i.search(t),this.searchBlock(this.body,t)}},Wi=class extends ce{constructor(t,e,r,i,s){super(),this.attributes=null,this.name=t,this.type=e,this.storage=r,this.access=i,this.value=s}get astNodeType(){return"var"}search(t){var e;t(this),(e=this.value)===null||e===void 0||e.search(t)}};class Mp extends ce{constructor(t,e,r){super(),this.attributes=null,this.name=t,this.type=e,this.value=r}get astNodeType(){return"override"}search(t){var e;(e=this.value)===null||e===void 0||e.search(t)}}let bl=class extends ce{constructor(t,e,r,i,s){super(),this.attributes=null,this.name=t,this.type=e,this.storage=r,this.access=i,this.value=s}get astNodeType(){return"let"}search(t){var e;t(this),(e=this.value)===null||e===void 0||e.search(t)}};class eu extends ce{constructor(t,e,r,i,s){super(),this.attributes=null,this.name=t,this.type=e,this.storage=r,this.access=i,this.value=s}get astNodeType(){return"const"}constEvaluate(t,e){return this.value.constEvaluate(t,e)}search(t){var e;t(this),(e=this.value)===null||e===void 0||e.search(t)}}var Zo,al,$,B;(n=>{n.increment="++",n.decrement="--"})(Zo||(Zo={})),(n=>{n.parse=function(t){const e=t;if(e=="parse")throw new Error("Invalid value for IncrementOperator");return n[e]}})(Zo||(Zo={}));let J0=class extends ce{constructor(t,e){super(),this.operator=t,this.variable=e}get astNodeType(){return"increment"}search(t){this.variable.search(t)}};(n=>{n.assign="=",n.addAssign="+=",n.subtractAssin="-=",n.multiplyAssign="*=",n.divideAssign="/=",n.moduloAssign="%=",n.andAssign="&=",n.orAssign="|=",n.xorAssign="^=",n.shiftLeftAssign="<<=",n.shiftRightAssign=">>="})(al||(al={})),(n=>{n.parse=function(t){const e=t;if(e=="parse")throw new Error("Invalid value for AssignOperator");return e}})(al||(al={}));class Q0 extends ce{constructor(t,e,r){super(),this.operator=t,this.variable=e,this.value=r}get astNodeType(){return"assign"}search(t){this.variable.search(t),this.value.search(t)}}class Rp extends ce{constructor(t,e){super(),this.name=t,this.args=e}get astNodeType(){return"call"}isBuiltin(){return q0.has(this.name)}search(t){for(const e of this.args)e.search(t);t(this)}}let tb=class extends ce{constructor(t,e){super(),this.body=t,this.continuing=e}get astNodeType(){return"loop"}},eb=class extends ce{constructor(t,e){super(),this.condition=t,this.cases=e}get astNodeType(){return"switch"}search(t){t(this);for(const e of this.cases)e.search(t)}},nb=class extends ce{constructor(t,e,r,i){super(),this.condition=t,this.body=e,this.elseif=r,this.else=i}get astNodeType(){return"if"}search(t){this.condition.search(t),this.searchBlock(this.body,t),this.searchBlock(this.elseif,t),this.searchBlock(this.else,t)}};class rb extends ce{constructor(t){super(),this.value=t}get astNodeType(){return"return"}search(t){var e;(e=this.value)===null||e===void 0||e.search(t)}}let VP=class extends ce{constructor(t){super(),this.name=t}get astNodeType(){return"enable"}},zP=class extends ce{constructor(t){super(),this.extensions=t}get astNodeType(){return"requires"}};class ib extends ce{constructor(t,e){super(),this.severity=t,this.rule=e}get astNodeType(){return"diagnostic"}}let Np=class extends ce{constructor(t,e){super(),this.name=t,this.type=e}get astNodeType(){return"alias"}},WP=class extends ce{constructor(){super()}get astNodeType(){return"discard"}},sb=class extends ce{constructor(){super(),this.condition=null,this.loopId=-1}get astNodeType(){return"break"}},ob=class extends ce{constructor(){super(),this.loopId=-1}get astNodeType(){return"continue"}},Z=class nu extends ce{constructor(t){super(),this.attributes=null,this.name=t}get astNodeType(){return"type"}get isStruct(){return!1}get isArray(){return!1}static maxFormatType(t){let e=t[0];if(e.name==="f32")return e;for(let r=1;r<t.length;++r){const i=nu._priority.get(e.name);nu._priority.get(t[r].name)<i&&(e=t[r])}return e.name==="x32"?nu.i32:e}getTypeName(){return this.name}};Z.x32=new Z("x32"),Z.f32=new Z("f32"),Z.i32=new Z("i32"),Z.u32=new Z("u32"),Z.f16=new Z("f16"),Z.bool=new Z("bool"),Z.void=new Z("void"),Z._priority=new Map([["f32",0],["f16",1],["u32",2],["i32",3],["x32",3]]);let Pm=class extends Z{constructor(t){super(t)}},zi=class extends Z{constructor(t,e,r,i){super(t),this.members=e,this.startLine=r,this.endLine=i}get astNodeType(){return"struct"}get isStruct(){return!0}getMemberIndex(t){for(let e=0;e<this.members.length;e++)if(this.members[e].name==t)return e;return-1}search(t){for(const e of this.members)t(e)}},W=class extends Z{constructor(t,e,r){super(t),this.format=e,this.access=r}get astNodeType(){return"template"}getTypeName(){let t=this.name;if(this.format!==null){if(t==="vec2"||t==="vec3"||t==="vec4"||t==="mat2x2"||t==="mat2x3"||t==="mat2x4"||t==="mat3x2"||t==="mat3x3"||t==="mat3x4"||t==="mat4x2"||t==="mat4x3"||t==="mat4x4"){if(this.format.name==="f32")return t+="f",t;if(this.format.name==="i32")return t+="i",t;if(this.format.name==="u32")return t+="u",t;if(this.format.name==="bool")return t+="b",t;if(this.format.name==="f16")return t+="h",t}t+=`<${this.format.name}>`}else if(t==="vec2"||t==="vec3"||t==="vec4")return t;return t}};W.vec2f=new W("vec2",Z.f32,null),W.vec3f=new W("vec3",Z.f32,null),W.vec4f=new W("vec4",Z.f32,null),W.vec2i=new W("vec2",Z.i32,null),W.vec3i=new W("vec3",Z.i32,null),W.vec4i=new W("vec4",Z.i32,null),W.vec2u=new W("vec2",Z.u32,null),W.vec3u=new W("vec3",Z.u32,null),W.vec4u=new W("vec4",Z.u32,null),W.vec2h=new W("vec2",Z.f16,null),W.vec3h=new W("vec3",Z.f16,null),W.vec4h=new W("vec4",Z.f16,null),W.vec2b=new W("vec2",Z.bool,null),W.vec3b=new W("vec3",Z.bool,null),W.vec4b=new W("vec4",Z.bool,null),W.mat2x2f=new W("mat2x2",Z.f32,null),W.mat2x3f=new W("mat2x3",Z.f32,null),W.mat2x4f=new W("mat2x4",Z.f32,null),W.mat3x2f=new W("mat3x2",Z.f32,null),W.mat3x3f=new W("mat3x3",Z.f32,null),W.mat3x4f=new W("mat3x4",Z.f32,null),W.mat4x2f=new W("mat4x2",Z.f32,null),W.mat4x3f=new W("mat4x3",Z.f32,null),W.mat4x4f=new W("mat4x4",Z.f32,null),W.mat2x2h=new W("mat2x2",Z.f16,null),W.mat2x3h=new W("mat2x3",Z.f16,null),W.mat2x4h=new W("mat2x4",Z.f16,null),W.mat3x2h=new W("mat3x2",Z.f16,null),W.mat3x3h=new W("mat3x3",Z.f16,null),W.mat3x4h=new W("mat3x4",Z.f16,null),W.mat4x2h=new W("mat4x2",Z.f16,null),W.mat4x3h=new W("mat4x3",Z.f16,null),W.mat4x4h=new W("mat4x4",Z.f16,null),W.mat2x2i=new W("mat2x2",Z.i32,null),W.mat2x3i=new W("mat2x3",Z.i32,null),W.mat2x4i=new W("mat2x4",Z.i32,null),W.mat3x2i=new W("mat3x2",Z.i32,null),W.mat3x3i=new W("mat3x3",Z.i32,null),W.mat3x4i=new W("mat3x4",Z.i32,null),W.mat4x2i=new W("mat4x2",Z.i32,null),W.mat4x3i=new W("mat4x3",Z.i32,null),W.mat4x4i=new W("mat4x4",Z.i32,null),W.mat2x2u=new W("mat2x2",Z.u32,null),W.mat2x3u=new W("mat2x3",Z.u32,null),W.mat2x4u=new W("mat2x4",Z.u32,null),W.mat3x2u=new W("mat3x2",Z.u32,null),W.mat3x3u=new W("mat3x3",Z.u32,null),W.mat3x4u=new W("mat3x4",Z.u32,null),W.mat4x2u=new W("mat4x2",Z.u32,null),W.mat4x3u=new W("mat4x3",Z.u32,null),W.mat4x4u=new W("mat4x4",Z.u32,null);let ru=class extends Z{constructor(t,e,r,i){super(t),this.storage=e,this.type=r,this.access=i}get astNodeType(){return"pointer"}},xl=class extends Z{constructor(t,e,r,i){super(t),this.attributes=e,this.format=r,this.count=i}get astNodeType(){return"array"}get isArray(){return!0}},ll=class extends Z{constructor(t,e,r){super(t),this.format=e,this.access=r}get astNodeType(){return"sampler"}},li=class extends Li{constructor(){super(),this.postfix=null}},ao=class extends li{constructor(t){super(),this.value=t}get astNodeType(){return"stringExpr"}toString(){return this.value}constEvaluateString(){return this.value}},yi=class extends li{constructor(t,e){super(),this.type=t,this.args=e}get astNodeType(){return"createExpr"}search(t){if(t(this),this.args)for(const e of this.args)e.search(t)}constEvaluate(t,e){return e&&(e[0]=this.type),t.evalExpression(this,t.context)}},Op=class extends li{constructor(t,e){super(),this.cachedReturnValue=null,this.name=t,this.args=e}get astNodeType(){return"callExpr"}setCachedReturnValue(t){this.cachedReturnValue=t}get isBuiltin(){return q0.has(this.name)}constEvaluate(t,e){return t.evalExpression(this,t.context)}search(t){for(const e of this.args)e.search(t);t(this)}},Zn=class extends li{constructor(t){super(),this.name=t}get astNodeType(){return"varExpr"}search(t){t(this),this.postfix&&this.postfix.search(t)}constEvaluate(t,e){return t.evalExpression(this,t.context)}};class ab extends li{constructor(t,e){super(),this.name=t,this.initializer=e}get astNodeType(){return"constExpr"}constEvaluate(t,e){if(this.initializer){const r=t.evalExpression(this.initializer,t.context);return r!==null&&this.postfix?r.getSubData(t,this.postfix,t.context):r}return null}search(t){this.initializer.search(t)}}let Be=class extends li{constructor(t,e){super(),this.value=t,this.type=e}get astNodeType(){return"literalExpr"}constEvaluate(t,e){return e!==void 0&&(e[0]=this.type),this.value}get isScalar(){return this.value instanceof F}get isVector(){return this.value instanceof N||this.value instanceof pt}get scalarValue(){return this.value instanceof F?this.value.value:(console.error("Value is not scalar."),0)}get vectorValue(){return this.value instanceof N||this.value instanceof pt?this.value.data:(console.error("Value is not a vector or matrix."),new Float32Array(0))}};class lb extends li{constructor(t,e){super(),this.type=t,this.value=e}get astNodeType(){return"bitcastExpr"}search(t){this.value.search(t)}}class ca extends li{constructor(t){super(),this.index=t}search(t){this.index.search(t)}}let cb=class extends li{constructor(){super()}};class Pe extends cb{constructor(t,e){super(),this.operator=t,this.right=e}get astNodeType(){return"unaryOp"}constEvaluate(t,e){return t.evalExpression(this,t.context)}search(t){this.right.search(t)}}class Hr extends cb{constructor(t,e,r){super(),this.operator=t,this.left=e,this.right=r}get astNodeType(){return"binaryOp"}_getPromotedType(t,e){return t.name===e.name?t:t.name==="f32"||e.name==="f32"?Z.f32:t.name==="u32"||e.name==="u32"?Z.u32:Z.i32}constEvaluate(t,e){return t.evalExpression(this,t.context)}search(t){this.left.search(t),this.right.search(t)}}class ub extends Li{constructor(t){super(),this.body=t}search(t){t(this),this.searchBlock(this.body,t)}}class iu extends li{constructor(){super()}get astNodeType(){return"default"}}class hb extends ub{constructor(t,e){super(e),this.selectors=t}get astNodeType(){return"case"}search(t){this.searchBlock(this.body,t)}}let fb=class extends ub{constructor(t){super(t)}get astNodeType(){return"default"}search(t){this.searchBlock(this.body,t)}};class Im extends Li{constructor(t,e,r){super(),this.name=t,this.type=e,this.attributes=r}get astNodeType(){return"argument"}}class HP extends Li{constructor(t,e){super(),this.condition=t,this.body=e}get astNodeType(){return"elseif"}search(t){this.condition.search(t),this.searchBlock(this.body,t)}}class Am extends Li{constructor(t,e,r){super(),this.name=t,this.type=e,this.attributes=r}get astNodeType(){return"member"}}let db=class extends Li{constructor(t,e){super(),this.name=t,this.value=e}get astNodeType(){return"attribute"}};class Tr{constructor(t,e){this.parent=null,this.typeInfo=t,this.parent=e,this.id=Tr._id++}clone(){throw`Clone: Not implemented for ${this.constructor.name}`}setDataValue(t,e,r,i){console.error(`SetDataValue: Not implemented for ${this.constructor.name}`)}getSubData(t,e,r){return console.error(`GetDataValue: Not implemented for ${this.constructor.name}`),null}toString(){return`<${this.typeInfo.getTypeName()}>`}}Tr._id=0;class md extends Tr{constructor(){super(new Er("void",null),null)}toString(){return"void"}}md.void=new md;let Wo=class extends Tr{constructor(t){super(new pd("pointer",t.typeInfo,null),null),this.reference=t}clone(){return this}setDataValue(t,e,r,i){this.reference.setDataValue(t,e,r,i)}getSubData(t,e,r){return e?this.reference.getSubData(t,e,r):this}toString(){return`&${this.reference.toString()}`}};class F extends Tr{constructor(t,e,r=null){super(e,r),t instanceof Int32Array||t instanceof Uint32Array||t instanceof Float32Array?this.data=t:this.typeInfo.name==="x32"?t-Math.floor(t)!=0?this.data=new Float32Array([t]):this.data=t>=0?new Uint32Array([t]):new Int32Array([t]):this.typeInfo.name==="i32"||this.typeInfo.name==="bool"?this.data=new Int32Array([t]):this.typeInfo.name==="u32"?this.data=new Uint32Array([t]):this.typeInfo.name==="f32"||this.typeInfo.name==="f16"?this.data=new Float32Array([t]):console.error("ScalarData2: Invalid type",e)}clone(){if(this.data instanceof Float32Array)return new F(new Float32Array(this.data),this.typeInfo,null);if(this.data instanceof Int32Array)return new F(new Int32Array(this.data),this.typeInfo,null);if(this.data instanceof Uint32Array)return new F(new Uint32Array(this.data),this.typeInfo,null);throw"ScalarData: Invalid data type"}get value(){return this.data[0]}set value(t){this.data[0]=t}setDataValue(t,e,r,i){if(r)return void console.error("SetDataValue: Scalar data does not support postfix",r);if(!(e instanceof F))return void console.error("SetDataValue: Invalid value",e);let s=e.data[0];this.typeInfo.name==="i32"||this.typeInfo.name==="u32"?s=Math.floor(s):this.typeInfo.name==="bool"&&(s=s?1:0),this.data[0]=s}getSubData(t,e,r){return e?(console.error("getSubData: Scalar data does not support postfix",e),null):this}toString(){return`${this.value}`}}function jP(n,t,e){const r=t.length;return r===2?e==="f32"?new N(new Float32Array(t),n.getTypeInfo("vec2f")):e==="i32"||e==="bool"?new N(new Int32Array(t),n.getTypeInfo("vec2i")):e==="u32"?new N(new Uint32Array(t),n.getTypeInfo("vec2u")):e==="f16"?new N(new Float32Array(t),n.getTypeInfo("vec2h")):(console.error(`getSubData: Unknown format ${e}`),null):r===3?e==="f32"?new N(new Float32Array(t),n.getTypeInfo("vec3f")):e==="i32"||e==="bool"?new N(new Int32Array(t),n.getTypeInfo("vec3i")):e==="u32"?new N(new Uint32Array(t),n.getTypeInfo("vec3u")):e==="f16"?new N(new Float32Array(t),n.getTypeInfo("vec3h")):(console.error(`getSubData: Unknown format ${e}`),null):r===4?e==="f32"?new N(new Float32Array(t),n.getTypeInfo("vec4f")):e==="i32"||e==="bool"?new N(new Int32Array(t),n.getTypeInfo("vec4i")):e==="u32"?new N(new Uint32Array(t),n.getTypeInfo("vec4u")):e==="f16"?new N(new Float32Array(t),n.getTypeInfo("vec4h")):(console.error(`getSubData: Unknown format ${e}`),null):(console.error(`getSubData: Invalid vector size ${t.length}`),null)}class N extends Tr{constructor(t,e,r=null){if(super(e,r),t instanceof Float32Array||t instanceof Uint32Array||t instanceof Int32Array)this.data=t;else{const i=this.typeInfo.name;i==="vec2f"||i==="vec3f"||i==="vec4f"?this.data=new Float32Array(t):i==="vec2i"||i==="vec3i"||i==="vec4i"?this.data=new Int32Array(t):i==="vec2u"||i==="vec3u"||i==="vec4u"?this.data=new Uint32Array(t):i==="vec2h"||i==="vec3h"||i==="vec4h"?this.data=new Float32Array(t):i==="vec2b"||i==="vec3b"||i==="vec4b"?this.data=new Int32Array(t):i==="vec2"||i==="vec3"||i==="vec4"?this.data=new Float32Array(t):console.error(`VectorData: Invalid type ${i}`)}}clone(){if(this.data instanceof Float32Array)return new N(new Float32Array(this.data),this.typeInfo,null);if(this.data instanceof Int32Array)return new N(new Int32Array(this.data),this.typeInfo,null);if(this.data instanceof Uint32Array)return new N(new Uint32Array(this.data),this.typeInfo,null);throw"VectorData: Invalid data type"}setDataValue(t,e,r,i){r instanceof ao?console.error("TODO: Set vector postfix"):e instanceof N?this.data=e.data:console.error("SetDataValue: Invalid value",e)}getSubData(t,e,r){if(e===null)return this;let i=t.getTypeInfo("f32");if(this.typeInfo instanceof oo)i=this.typeInfo.format||i;else{const o=this.typeInfo.name;o==="vec2f"||o==="vec3f"||o==="vec4f"?i=t.getTypeInfo("f32"):o==="vec2i"||o==="vec3i"||o==="vec4i"?i=t.getTypeInfo("i32"):o==="vec2b"||o==="vec3b"||o==="vec4b"?i=t.getTypeInfo("bool"):o==="vec2u"||o==="vec3u"||o==="vec4u"?i=t.getTypeInfo("u32"):o==="vec2h"||o==="vec3h"||o==="vec4h"?i=t.getTypeInfo("f16"):console.error(`GetSubData: Unknown type ${o}`)}let s=this;for(;e!==null&&s!==null;){if(e instanceof ca){const o=e.index;let a=-1;if(o instanceof Be){if(!(o.value instanceof F))return console.error(`GetSubData: Invalid array index ${o.value}`),null;a=o.value.value}else{const l=t.evalExpression(o,r);if(!(l instanceof F))return console.error("GetSubData: Unknown index type",o),null;a=l.value}if(a<0||a>=s.data.length)return console.error("GetSubData: Index out of range",a),null;if(s.data instanceof Float32Array){const l=new Float32Array(s.data.buffer,s.data.byteOffset+4*a,1);return new F(l,i)}if(s.data instanceof Int32Array){const l=new Int32Array(s.data.buffer,s.data.byteOffset+4*a,1);return new F(l,i)}if(s.data instanceof Uint32Array){const l=new Uint32Array(s.data.buffer,s.data.byteOffset+4*a,1);return new F(l,i)}throw"GetSubData: Invalid data type"}if(!(e instanceof ao))return console.error("GetSubData: Unknown postfix",e),null;{const o=e.value.toLowerCase();if(o.length===1){let l=0;if(o==="x"||o==="r")l=0;else if(o==="y"||o==="g")l=1;else if(o==="z"||o==="b")l=2;else{if(o!=="w"&&o!=="a")return console.error(`GetSubData: Unknown member ${o}`),null;l=3}if(this.data instanceof Float32Array){let c=new Float32Array(this.data.buffer,this.data.byteOffset+4*l,1);return new F(c,i,this)}if(this.data instanceof Int32Array){let c=new Int32Array(this.data.buffer,this.data.byteOffset+4*l,1);return new F(c,i,this)}if(this.data instanceof Uint32Array){let c=new Uint32Array(this.data.buffer,this.data.byteOffset+4*l,1);return new F(c,i,this)}}const a=[];for(const l of o)l==="x"||l==="r"?a.push(this.data[0]):l==="y"||l==="g"?a.push(this.data[1]):l==="z"||l==="b"?a.push(this.data[2]):l==="w"||l==="a"?a.push(this.data[3]):console.error(`GetDataValue: Unknown member ${l}`);s=jP(t,a,i.name)}e=e.postfix}return s}toString(){let t=`${this.data[0]}`;for(let e=1;e<this.data.length;++e)t+=`, ${this.data[e]}`;return t}}class pt extends Tr{constructor(t,e,r=null){super(e,r),t instanceof Float32Array?this.data=t:this.data=new Float32Array(t)}clone(){return new pt(new Float32Array(this.data),this.typeInfo,null)}setDataValue(t,e,r,i){r instanceof ao?console.error("TODO: Set matrix postfix"):e instanceof pt?this.data=e.data:console.error("SetDataValue: Invalid value",e)}getSubData(t,e,r){if(e===null)return this;const i=this.typeInfo.name;if(t.getTypeInfo("f32"),this.typeInfo instanceof oo)this.typeInfo.format;else if(i.endsWith("f"))t.getTypeInfo("f32");else if(i.endsWith("i"))t.getTypeInfo("i32");else if(i.endsWith("u"))t.getTypeInfo("u32");else{if(!i.endsWith("h"))return console.error(`GetDataValue: Unknown type ${i}`),null;t.getTypeInfo("f16")}if(e instanceof ca){const s=e.index;let o=-1;if(s instanceof Be){if(!(s.value instanceof F))return console.error(`GetDataValue: Invalid array index ${s.value}`),null;o=s.value.value}else{const c=t.evalExpression(s,r);if(!(c instanceof F))return console.error("GetDataValue: Unknown index type",s),null;o=c.value}if(o<0||o>=this.data.length)return console.error("GetDataValue: Index out of range",o),null;const a=i.endsWith("h")?"h":"f";let l;if(i==="mat2x2"||i==="mat2x2f"||i==="mat2x2h"||i==="mat3x2"||i==="mat3x2f"||i==="mat3x2h"||i==="mat4x2"||i==="mat4x2f"||i==="mat4x2h")l=new N(new Float32Array(this.data.buffer,this.data.byteOffset+2*o*4,2),t.getTypeInfo(`vec2${a}`));else if(i==="mat2x3"||i==="mat2x3f"||i==="mat2x3h"||i==="mat3x3"||i==="mat3x3f"||i==="mat3x3h"||i==="mat4x3"||i==="mat4x3f"||i==="mat4x3h")l=new N(new Float32Array(this.data.buffer,this.data.byteOffset+3*o*4,3),t.getTypeInfo(`vec3${a}`));else{if(i!=="mat2x4"&&i!=="mat2x4f"&&i!=="mat2x4h"&&i!=="mat3x4"&&i!=="mat3x4f"&&i!=="mat3x4h"&&i!=="mat4x4"&&i!=="mat4x4f"&&i!=="mat4x4h")return console.error(`GetDataValue: Unknown type ${i}`),null;l=new N(new Float32Array(this.data.buffer,this.data.byteOffset+4*o*4,4),t.getTypeInfo(`vec4${a}`))}return e.postfix?l.getSubData(t,e.postfix,r):l}return console.error("GetDataValue: Invalid postfix",e),null}toString(){let t=`${this.data[0]}`;for(let e=1;e<this.data.length;++e)t+=`, ${this.data[e]}`;return t}}class _e extends Tr{constructor(t,e,r=0,i=null){super(e,i),this.buffer=t instanceof ArrayBuffer?t:t.buffer,this.offset=r}clone(){const t=new Uint8Array(new Uint8Array(this.buffer,this.offset,this.typeInfo.size));return new _e(t.buffer,this.typeInfo,0,null)}setDataValue(t,e,r,i){if(e===null)return void console.log("setDataValue: NULL data.");let s=this.offset,o=this.typeInfo;for(;r;){if(r instanceof ca)if(o instanceof ws){const a=r.index;if(a instanceof Be){if(!(a.value instanceof F))return void console.error(`SetDataValue: Invalid index type ${a.value}`);s+=a.value.value*o.stride}else{const l=t.evalExpression(a,i);if(!(l instanceof F))return void console.error("SetDataValue: Unknown index type",a);s+=l.value*o.stride}o=o.format}else console.error(`SetDataValue: Type ${o.getTypeName()} is not an array`);else{if(!(r instanceof ao))return void console.error("SetDataValue: Unknown postfix type",r);{const a=r.value;if(o instanceof gs){let l=!1;for(const c of o.members)if(c.name===a){s+=c.offset,o=c.type,l=!0;break}if(!l)return void console.error(`SetDataValue: Member ${a} not found`)}else if(o instanceof Er){const l=o.getTypeName();let c=0;if(a==="x"||a==="r")c=0;else if(a==="y"||a==="g")c=1;else if(a==="z"||a==="b")c=2;else{if(a!=="w"&&a!=="a")return void console.error(`SetDataValue: Unknown member ${a}`);c=3}if(!(e instanceof F))return void console.error("SetDataValue: Invalid value",e);const u=e.value;return l==="vec2f"?void(new Float32Array(this.buffer,s,2)[c]=u):l==="vec3f"?void(new Float32Array(this.buffer,s,3)[c]=u):l==="vec4f"?void(new Float32Array(this.buffer,s,4)[c]=u):l==="vec2i"?void(new Int32Array(this.buffer,s,2)[c]=u):l==="vec3i"?void(new Int32Array(this.buffer,s,3)[c]=u):l==="vec4i"?void(new Int32Array(this.buffer,s,4)[c]=u):l==="vec2u"?void(new Uint32Array(this.buffer,s,2)[c]=u):l==="vec3u"?void(new Uint32Array(this.buffer,s,3)[c]=u):l==="vec4u"?void(new Uint32Array(this.buffer,s,4)[c]=u):void console.error(`SetDataValue: Type ${l} is not a struct`)}}}r=r.postfix}this.setData(t,e,o,s,i)}setData(t,e,r,i,s){const o=r.getTypeName();if(o!=="f32"&&o!=="f16")if(o!=="i32"&&o!=="atomic<i32>"&&o!=="x32")if(o!=="u32"&&o!=="atomic<u32>")if(o!=="bool")if(o!=="vec2f"&&o!=="vec2h")if(o!=="vec3f"&&o!=="vec3h")if(o!=="vec4f"&&o!=="vec4h")if(o!=="vec2i")if(o!=="vec3i")if(o!=="vec4i")if(o!=="vec2u")if(o!=="vec3u")if(o!=="vec4u")if(o!=="vec2b")if(o!=="vec3b")if(o!=="vec4b")if(o!=="mat2x2f"&&o!=="mat2x2h")if(o!=="mat2x3f"&&o!=="mat2x3h")if(o!=="mat2x4f"&&o!=="mat2x4h")if(o!=="mat3x2f"&&o!=="mat3x2h")if(o!=="mat3x3f"&&o!=="mat3x3h")if(o!=="mat3x4f"&&o!=="mat3x4h")if(o!=="mat4x2f"&&o!=="mat4x2h")if(o!=="mat4x3f"&&o!=="mat4x3h")if(o!=="mat4x4f"&&o!=="mat4x4h")if(e instanceof _e){if(r===e.typeInfo)return void new Uint8Array(this.buffer,i,e.buffer.byteLength).set(new Uint8Array(e.buffer));console.error("SetDataValue: Type mismatch",o,e.typeInfo.getTypeName())}else console.error(`SetData: Unknown type ${o}`);else{const a=new Float32Array(this.buffer,i,16);e instanceof pt?(a[0]=e.data[0],a[1]=e.data[1],a[2]=e.data[2],a[3]=e.data[3],a[4]=e.data[4],a[5]=e.data[5],a[6]=e.data[6],a[7]=e.data[7],a[8]=e.data[8],a[9]=e.data[9],a[10]=e.data[10],a[11]=e.data[11],a[12]=e.data[12],a[13]=e.data[13],a[14]=e.data[14],a[15]=e.data[15]):(a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=e[3],a[4]=e[4],a[5]=e[5],a[6]=e[6],a[7]=e[7],a[8]=e[8],a[9]=e[9],a[10]=e[10],a[11]=e[11],a[12]=e[12],a[13]=e[13],a[14]=e[14],a[15]=e[15])}else{const a=new Float32Array(this.buffer,i,12);e instanceof pt?(a[0]=e.data[0],a[1]=e.data[1],a[2]=e.data[2],a[3]=e.data[3],a[4]=e.data[4],a[5]=e.data[5],a[6]=e.data[6],a[7]=e.data[7],a[8]=e.data[8],a[9]=e.data[9],a[10]=e.data[10],a[11]=e.data[11]):(a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=e[3],a[4]=e[4],a[5]=e[5],a[6]=e[6],a[7]=e[7],a[8]=e[8],a[9]=e[9],a[10]=e[10],a[11]=e[11])}else{const a=new Float32Array(this.buffer,i,8);e instanceof pt?(a[0]=e.data[0],a[1]=e.data[1],a[2]=e.data[2],a[3]=e.data[3],a[4]=e.data[4],a[5]=e.data[5],a[6]=e.data[6],a[7]=e.data[7]):(a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=e[3],a[4]=e[4],a[5]=e[5],a[6]=e[6],a[7]=e[7])}else{const a=new Float32Array(this.buffer,i,12);e instanceof pt?(a[0]=e.data[0],a[1]=e.data[1],a[2]=e.data[2],a[3]=e.data[3],a[4]=e.data[4],a[5]=e.data[5],a[6]=e.data[6],a[7]=e.data[7],a[8]=e.data[8],a[9]=e.data[9],a[10]=e.data[10],a[11]=e.data[11]):(a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=e[3],a[4]=e[4],a[5]=e[5],a[6]=e[6],a[7]=e[7],a[8]=e[8],a[9]=e[9],a[10]=e[10],a[11]=e[11])}else{const a=new Float32Array(this.buffer,i,9);e instanceof pt?(a[0]=e.data[0],a[1]=e.data[1],a[2]=e.data[2],a[3]=e.data[3],a[4]=e.data[4],a[5]=e.data[5],a[6]=e.data[6],a[7]=e.data[7],a[8]=e.data[8]):(a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=e[3],a[4]=e[4],a[5]=e[5],a[6]=e[6],a[7]=e[7],a[8]=e[8])}else{const a=new Float32Array(this.buffer,i,6);e instanceof pt?(a[0]=e.data[0],a[1]=e.data[1],a[2]=e.data[2],a[3]=e.data[3],a[4]=e.data[4],a[5]=e.data[5]):(a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=e[3],a[4]=e[4],a[5]=e[5])}else{const a=new Float32Array(this.buffer,i,8);e instanceof pt?(a[0]=e.data[0],a[1]=e.data[1],a[2]=e.data[2],a[3]=e.data[3],a[4]=e.data[4],a[5]=e.data[5],a[6]=e.data[6],a[7]=e.data[7]):(a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=e[3],a[4]=e[4],a[5]=e[5],a[6]=e[6],a[7]=e[7])}else{const a=new Float32Array(this.buffer,i,6);e instanceof pt?(a[0]=e.data[0],a[1]=e.data[1],a[2]=e.data[2],a[3]=e.data[3],a[4]=e.data[4],a[5]=e.data[5]):(a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=e[3],a[4]=e[4],a[5]=e[5])}else{const a=new Float32Array(this.buffer,i,4);e instanceof pt?(a[0]=e.data[0],a[1]=e.data[1],a[2]=e.data[2],a[3]=e.data[3]):(a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=e[3])}else{const a=new Uint32Array(this.buffer,i,4);e instanceof N?(a[0]=e.data[0],a[1]=e.data[1],a[2]=e.data[2],a[3]=e.data[3]):(a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=e[3])}else{const a=new Uint32Array(this.buffer,i,3);e instanceof N?(a[0]=e.data[0],a[1]=e.data[1],a[2]=e.data[2]):(a[0]=e[0],a[1]=e[1],a[2]=e[2])}else{const a=new Uint32Array(this.buffer,i,2);e instanceof N?(a[0]=e.data[0],a[1]=e.data[1]):(a[0]=e[0],a[1]=e[1])}else{const a=new Uint32Array(this.buffer,i,4);e instanceof N?(a[0]=e.data[0],a[1]=e.data[1],a[2]=e.data[2],a[3]=e.data[3]):(a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=e[3])}else{const a=new Uint32Array(this.buffer,i,3);e instanceof N?(a[0]=e.data[0],a[1]=e.data[1],a[2]=e.data[2]):(a[0]=e[0],a[1]=e[1],a[2]=e[2])}else{const a=new Uint32Array(this.buffer,i,2);e instanceof N?(a[0]=e.data[0],a[1]=e.data[1]):(a[0]=e[0],a[1]=e[1])}else{const a=new Int32Array(this.buffer,i,4);e instanceof N?(a[0]=e.data[0],a[1]=e.data[1],a[2]=e.data[2],a[3]=e.data[3]):(a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=e[3])}else{const a=new Int32Array(this.buffer,i,3);e instanceof N?(a[0]=e.data[0],a[1]=e.data[1],a[2]=e.data[2]):(a[0]=e[0],a[1]=e[1],a[2]=e[2])}else{const a=new Int32Array(this.buffer,i,2);e instanceof N?(a[0]=e.data[0],a[1]=e.data[1]):(a[0]=e[0],a[1]=e[1])}else{const a=new Float32Array(this.buffer,i,4);e instanceof N?(a[0]=e.data[0],a[1]=e.data[1],a[2]=e.data[2],a[3]=e.data[3]):(a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=e[3])}else{const a=new Float32Array(this.buffer,i,3);e instanceof N?(a[0]=e.data[0],a[1]=e.data[1],a[2]=e.data[2]):(a[0]=e[0],a[1]=e[1],a[2]=e[2])}else{const a=new Float32Array(this.buffer,i,2);e instanceof N?(a[0]=e.data[0],a[1]=e.data[1]):(a[0]=e[0],a[1]=e[1])}else e instanceof F&&(new Int32Array(this.buffer,i,1)[0]=e.value);else e instanceof F&&(new Uint32Array(this.buffer,i,1)[0]=e.value);else e instanceof F&&(new Int32Array(this.buffer,i,1)[0]=e.value);else e instanceof F&&(new Float32Array(this.buffer,i,1)[0]=e.value)}getSubData(t,e,r){var i,s,o;if(e===null)return this;let a=this.offset,l=this.typeInfo;for(;e;){if(e instanceof ca){const u=e.index,h=u instanceof li?t.evalExpression(u,r):u;let f=0;if(h instanceof F?f=h.value:typeof h=="number"?f=h:console.error("GetDataValue: Invalid index type",u),l instanceof ws)a+=f*l.stride,l=l.format;else{const d=l.getTypeName();d==="mat4x4"||d==="mat4x4f"||d==="mat4x4h"?(a+=16*f,l=t.getTypeInfo("vec4f")):console.error(`getDataValue: Type ${l.getTypeName()} is not an array`)}}else{if(!(e instanceof ao))return console.error("GetDataValue: Unknown postfix type",e),null;{const u=e.value;if(l instanceof gs){let h=!1;for(const f of l.members)if(f.name===u){a+=f.offset,l=f.type,h=!0;break}if(!h)return console.error(`GetDataValue: Member ${u} not found`),null}else if(l instanceof Er){const h=l.getTypeName();if(h==="vec2f"||h==="vec3f"||h==="vec4f"||h==="vec2i"||h==="vec3i"||h==="vec4i"||h==="vec2u"||h==="vec3u"||h==="vec4u"||h==="vec2b"||h==="vec3b"||h==="vec4b"||h==="vec2h"||h==="vec3h"||h==="vec4h"||h==="vec2"||h==="vec3"||h==="vec4"){if(u.length>0&&u.length<5){let f="f";const d=[];for(let p=0;p<u.length;++p){const _=u[p].toLowerCase();let v=0;if(_==="x"||_==="r")v=0;else if(_==="y"||_==="g")v=1;else if(_==="z"||_==="b")v=2;else{if(_!=="w"&&_!=="a")return console.error(`Unknown member ${u}`),null;v=3}if(u.length===1){if(h.endsWith("f"))return this.buffer.byteLength<a+4*v+4?(console.log("Insufficient buffer data"),null):new F(new Float32Array(this.buffer,a+4*v,1),t.getTypeInfo("f32"),this);if(h.endsWith("h"))return new F(new Float32Array(this.buffer,a+4*v,1),t.getTypeInfo("f16"),this);if(h.endsWith("i"))return new F(new Int32Array(this.buffer,a+4*v,1),t.getTypeInfo("i32"),this);if(h.endsWith("b"))return new F(new Int32Array(this.buffer,a+4*v,1),t.getTypeInfo("bool"),this);if(h.endsWith("u"))return new F(new Uint32Array(this.buffer,a+4*v,1),t.getTypeInfo("i32"),this)}if(h==="vec2f")d.push(new Float32Array(this.buffer,a,2)[v]);else if(h==="vec3f"){if(a+12>=this.buffer.byteLength)return console.log("Insufficient buffer data"),null;const E=new Float32Array(this.buffer,a,3);d.push(E[v])}else if(h==="vec4f")d.push(new Float32Array(this.buffer,a,4)[v]);else if(h==="vec2i")f="i",d.push(new Int32Array(this.buffer,a,2)[v]);else if(h==="vec3i")f="i",d.push(new Int32Array(this.buffer,a,3)[v]);else if(h==="vec4i")f="i",d.push(new Int32Array(this.buffer,a,4)[v]);else if(h==="vec2u"){f="u";const E=new Uint32Array(this.buffer,a,2);d.push(E[v])}else h==="vec3u"?(f="u",d.push(new Uint32Array(this.buffer,a,3)[v])):h==="vec4u"&&(f="u",d.push(new Uint32Array(this.buffer,a,4)[v]))}return d.length===2?l=t.getTypeInfo(`vec2${f}`):d.length===3?l=t.getTypeInfo(`vec3${f}`):d.length===4?l=t.getTypeInfo(`vec4${f}`):console.error(`GetDataValue: Invalid vector length ${d.length}`),new N(d,l,null)}return console.error(`GetDataValue: Unknown member ${u}`),null}return console.error(`GetDataValue: Type ${h} is not a struct`),null}}}e=e.postfix}const c=l.getTypeName();return c==="f32"?new F(new Float32Array(this.buffer,a,1),l,this):c==="i32"?new F(new Int32Array(this.buffer,a,1),l,this):c==="u32"?new F(new Uint32Array(this.buffer,a,1),l,this):c==="vec2f"?new N(new Float32Array(this.buffer,a,2),l,this):c==="vec3f"?new N(new Float32Array(this.buffer,a,3),l,this):c==="vec4f"?new N(new Float32Array(this.buffer,a,4),l,this):c==="vec2i"?new N(new Int32Array(this.buffer,a,2),l,this):c==="vec3i"?new N(new Int32Array(this.buffer,a,3),l,this):c==="vec4i"?new N(new Int32Array(this.buffer,a,4),l,this):c==="vec2u"?new N(new Uint32Array(this.buffer,a,2),l,this):c==="vec3u"?new N(new Uint32Array(this.buffer,a,3),l,this):c==="vec4u"?new N(new Uint32Array(this.buffer,a,4),l,this):l instanceof oo&&l.name==="atomic"?((i=l.format)===null||i===void 0?void 0:i.name)==="u32"?new F(new Uint32Array(this.buffer,a,1)[0],l.format,this):((s=l.format)===null||s===void 0?void 0:s.name)==="i32"?new F(new Int32Array(this.buffer,a,1)[0],l.format,this):(console.error(`GetDataValue: Invalid atomic format ${(o=l.format)===null||o===void 0?void 0:o.name}`),null):new _e(this.buffer,l,a,this)}toString(){let t="";if(this.typeInfo instanceof ws)if(this.typeInfo.format.name==="f32"){const e=new Float32Array(this.buffer,this.offset);t=`[${e[0]}`;for(let r=1;r<e.length;++r)t+=`, ${e[r]}`}else if(this.typeInfo.format.name==="i32"){const e=new Int32Array(this.buffer,this.offset);t=`[${e[0]}`;for(let r=1;r<e.length;++r)t+=`, ${e[r]}`}else if(this.typeInfo.format.name==="u32"){const e=new Uint32Array(this.buffer,this.offset);t=`[${e[0]}`;for(let r=1;r<e.length;++r)t+=`, ${e[r]}`}else if(this.typeInfo.format.name==="vec2f"){const e=new Float32Array(this.buffer,this.offset);t=`[${e[0]}, ${e[1]}]`;for(let r=1;r<e.length/2;++r)t+=`, [${e[2*r]}, ${e[2*r+1]}]`}else if(this.typeInfo.format.name==="vec3f"){const e=new Float32Array(this.buffer,this.offset);t=`[${e[0]}, ${e[1]}, ${e[2]}]`;for(let r=4;r<e.length;r+=4)t+=`, [${e[r]}, ${e[r+1]}, ${e[r+2]}]`}else if(this.typeInfo.format.name==="vec4f"){const e=new Float32Array(this.buffer,this.offset);t=`[${e[0]}, ${e[1]}, ${e[2]}, ${e[3]}]`;for(let r=4;r<e.length;r+=4)t+=`, [${e[r]}, ${e[r+1]}, ${e[r+2]}, ${e[r+3]}]`}else t="[...]";else this.typeInfo instanceof gs?t+="{...}":t="[...]";return t}}let Ks=class pb extends Tr{constructor(t,e,r,i){super(e,null),this.data=t,this.descriptor=r,this.view=i}clone(){return new pb(this.data,this.typeInfo,this.descriptor,this.view)}get width(){var t,e;const r=this.descriptor.size;return r instanceof Array&&r.length>0?(t=r[0])!==null&&t!==void 0?t:0:r instanceof Object&&(e=r.width)!==null&&e!==void 0?e:0}get height(){var t,e;const r=this.descriptor.size;return r instanceof Array&&r.length>1?(t=r[1])!==null&&t!==void 0?t:0:r instanceof Object&&(e=r.height)!==null&&e!==void 0?e:0}get depthOrArrayLayers(){var t,e;const r=this.descriptor.size;return r instanceof Array&&r.length>2?(t=r[2])!==null&&t!==void 0?t:0:r instanceof Object&&(e=r.depthOrArrayLayers)!==null&&e!==void 0?e:0}get format(){var t;return this.descriptor&&(t=this.descriptor.format)!==null&&t!==void 0?t:"rgba8unorm"}get sampleCount(){var t;return this.descriptor&&(t=this.descriptor.sampleCount)!==null&&t!==void 0?t:1}get mipLevelCount(){var t;return this.descriptor&&(t=this.descriptor.mipLevelCount)!==null&&t!==void 0?t:1}get dimension(){var t;return this.descriptor&&(t=this.descriptor.dimension)!==null&&t!==void 0?t:"2d"}getMipLevelSize(t){if(t>=this.mipLevelCount)return[0,0,0];const e=[this.width,this.height,this.depthOrArrayLayers];for(let r=0;r<e.length;++r)e[r]=Math.max(1,e[r]>>t);return e}get texelByteSize(){const t=this.format,e=ff[t];return e?e.isDepthStencil?4:e.bytesPerBlock:0}get bytesPerRow(){return this.width*this.texelByteSize}get isDepthStencil(){const t=this.format,e=ff[t];return!!e&&e.isDepthStencil}getGpuSize(){const t=this.format,e=ff[t],r=this.width;if(!t||r<=0||!e)return-1;const i=this.height,s=this.depthOrArrayLayers,o=this.dimension;return r/e.blockWidth*(o==="1d"?1:i/e.blockHeight)*e.bytesPerBlock*s}getPixel(t,e,r=0,i=0){const s=this.texelByteSize,o=this.bytesPerRow,a=this.height,l=this.data[i];return BP(new Uint8Array(l),t,e,r,i,a,o,s,this.format)}setPixel(t,e,r,i,s){const o=this.texelByteSize,a=this.bytesPerRow,l=this.height,c=this.data[i];(function(u,h,f,d,p,_,v,E,m,g){const y=d*(v>>=p)*(_>>=p)+f*v+h*E;switch(m){case"r8unorm":return void zt(u,y,"8unorm",1,g);case"r8snorm":return void zt(u,y,"8snorm",1,g);case"r8uint":return void zt(u,y,"8uint",1,g);case"r8sint":return void zt(u,y,"8sint",1,g);case"rg8unorm":return void zt(u,y,"8unorm",2,g);case"rg8snorm":return void zt(u,y,"8snorm",2,g);case"rg8uint":return void zt(u,y,"8uint",2,g);case"rg8sint":return void zt(u,y,"8sint",2,g);case"rgba8unorm-srgb":case"rgba8unorm":case"bgra8unorm-srgb":case"bgra8unorm":return void zt(u,y,"8unorm",4,g);case"rgba8snorm":return void zt(u,y,"8snorm",4,g);case"rgba8uint":return void zt(u,y,"8uint",4,g);case"rgba8sint":return void zt(u,y,"8sint",4,g);case"r16uint":return void zt(u,y,"16uint",1,g);case"r16sint":return void zt(u,y,"16sint",1,g);case"r16float":return void zt(u,y,"16float",1,g);case"rg16uint":return void zt(u,y,"16uint",2,g);case"rg16sint":return void zt(u,y,"16sint",2,g);case"rg16float":return void zt(u,y,"16float",2,g);case"rgba16uint":return void zt(u,y,"16uint",4,g);case"rgba16sint":return void zt(u,y,"16sint",4,g);case"rgba16float":return void zt(u,y,"16float",4,g);case"r32uint":return void zt(u,y,"32uint",1,g);case"r32sint":return void zt(u,y,"32sint",1,g);case"depth16unorm":case"depth24plus":case"depth24plus-stencil8":case"depth32float":case"depth32float-stencil8":case"r32float":return void zt(u,y,"32float",1,g);case"rg32uint":return void zt(u,y,"32uint",2,g);case"rg32sint":return void zt(u,y,"32sint",2,g);case"rg32float":return void zt(u,y,"32float",2,g);case"rgba32uint":return void zt(u,y,"32uint",4,g);case"rgba32sint":return void zt(u,y,"32sint",4,g);case"rgba32float":return void zt(u,y,"32float",4,g);case"rg11b10ufloat":console.error("TODO: rg11b10ufloat not supported for writing")}})(new Uint8Array(c),t,e,r,i,l,a,o,this.format,s)}};(n=>{n[n.token=0]="token",n[n.keyword=1]="keyword",n[n.reserved=2]="reserved"})(B||(B={}));class U{constructor(t,e,r){this.name=t,this.type=e,this.rule=r}toString(){return this.name}}class A{}$=A,A.none=new U("",B.reserved,""),A.eof=new U("EOF",B.token,""),A.reserved={asm:new U("asm",B.reserved,"asm"),bf16:new U("bf16",B.reserved,"bf16"),do:new U("do",B.reserved,"do"),enum:new U("enum",B.reserved,"enum"),f16:new U("f16",B.reserved,"f16"),f64:new U("f64",B.reserved,"f64"),handle:new U("handle",B.reserved,"handle"),i8:new U("i8",B.reserved,"i8"),i16:new U("i16",B.reserved,"i16"),i64:new U("i64",B.reserved,"i64"),mat:new U("mat",B.reserved,"mat"),premerge:new U("premerge",B.reserved,"premerge"),regardless:new U("regardless",B.reserved,"regardless"),typedef:new U("typedef",B.reserved,"typedef"),u8:new U("u8",B.reserved,"u8"),u16:new U("u16",B.reserved,"u16"),u64:new U("u64",B.reserved,"u64"),unless:new U("unless",B.reserved,"unless"),using:new U("using",B.reserved,"using"),vec:new U("vec",B.reserved,"vec"),void:new U("void",B.reserved,"void")},A.keywords={array:new U("array",B.keyword,"array"),atomic:new U("atomic",B.keyword,"atomic"),bool:new U("bool",B.keyword,"bool"),f32:new U("f32",B.keyword,"f32"),i32:new U("i32",B.keyword,"i32"),mat2x2:new U("mat2x2",B.keyword,"mat2x2"),mat2x3:new U("mat2x3",B.keyword,"mat2x3"),mat2x4:new U("mat2x4",B.keyword,"mat2x4"),mat3x2:new U("mat3x2",B.keyword,"mat3x2"),mat3x3:new U("mat3x3",B.keyword,"mat3x3"),mat3x4:new U("mat3x4",B.keyword,"mat3x4"),mat4x2:new U("mat4x2",B.keyword,"mat4x2"),mat4x3:new U("mat4x3",B.keyword,"mat4x3"),mat4x4:new U("mat4x4",B.keyword,"mat4x4"),ptr:new U("ptr",B.keyword,"ptr"),sampler:new U("sampler",B.keyword,"sampler"),sampler_comparison:new U("sampler_comparison",B.keyword,"sampler_comparison"),struct:new U("struct",B.keyword,"struct"),texture_1d:new U("texture_1d",B.keyword,"texture_1d"),texture_2d:new U("texture_2d",B.keyword,"texture_2d"),texture_2d_array:new U("texture_2d_array",B.keyword,"texture_2d_array"),texture_3d:new U("texture_3d",B.keyword,"texture_3d"),texture_cube:new U("texture_cube",B.keyword,"texture_cube"),texture_cube_array:new U("texture_cube_array",B.keyword,"texture_cube_array"),texture_multisampled_2d:new U("texture_multisampled_2d",B.keyword,"texture_multisampled_2d"),texture_storage_1d:new U("texture_storage_1d",B.keyword,"texture_storage_1d"),texture_storage_2d:new U("texture_storage_2d",B.keyword,"texture_storage_2d"),texture_storage_2d_array:new U("texture_storage_2d_array",B.keyword,"texture_storage_2d_array"),texture_storage_3d:new U("texture_storage_3d",B.keyword,"texture_storage_3d"),texture_depth_2d:new U("texture_depth_2d",B.keyword,"texture_depth_2d"),texture_depth_2d_array:new U("texture_depth_2d_array",B.keyword,"texture_depth_2d_array"),texture_depth_cube:new U("texture_depth_cube",B.keyword,"texture_depth_cube"),texture_depth_cube_array:new U("texture_depth_cube_array",B.keyword,"texture_depth_cube_array"),texture_depth_multisampled_2d:new U("texture_depth_multisampled_2d",B.keyword,"texture_depth_multisampled_2d"),texture_external:new U("texture_external",B.keyword,"texture_external"),u32:new U("u32",B.keyword,"u32"),vec2:new U("vec2",B.keyword,"vec2"),vec3:new U("vec3",B.keyword,"vec3"),vec4:new U("vec4",B.keyword,"vec4"),bitcast:new U("bitcast",B.keyword,"bitcast"),block:new U("block",B.keyword,"block"),break:new U("break",B.keyword,"break"),case:new U("case",B.keyword,"case"),continue:new U("continue",B.keyword,"continue"),continuing:new U("continuing",B.keyword,"continuing"),default:new U("default",B.keyword,"default"),diagnostic:new U("diagnostic",B.keyword,"diagnostic"),discard:new U("discard",B.keyword,"discard"),else:new U("else",B.keyword,"else"),enable:new U("enable",B.keyword,"enable"),fallthrough:new U("fallthrough",B.keyword,"fallthrough"),false:new U("false",B.keyword,"false"),fn:new U("fn",B.keyword,"fn"),for:new U("for",B.keyword,"for"),function:new U("function",B.keyword,"function"),if:new U("if",B.keyword,"if"),let:new U("let",B.keyword,"let"),const:new U("const",B.keyword,"const"),loop:new U("loop",B.keyword,"loop"),while:new U("while",B.keyword,"while"),private:new U("private",B.keyword,"private"),read:new U("read",B.keyword,"read"),read_write:new U("read_write",B.keyword,"read_write"),return:new U("return",B.keyword,"return"),requires:new U("requires",B.keyword,"requires"),storage:new U("storage",B.keyword,"storage"),switch:new U("switch",B.keyword,"switch"),true:new U("true",B.keyword,"true"),alias:new U("alias",B.keyword,"alias"),type:new U("type",B.keyword,"type"),uniform:new U("uniform",B.keyword,"uniform"),var:new U("var",B.keyword,"var"),override:new U("override",B.keyword,"override"),workgroup:new U("workgroup",B.keyword,"workgroup"),write:new U("write",B.keyword,"write"),r8unorm:new U("r8unorm",B.keyword,"r8unorm"),r8snorm:new U("r8snorm",B.keyword,"r8snorm"),r8uint:new U("r8uint",B.keyword,"r8uint"),r8sint:new U("r8sint",B.keyword,"r8sint"),r16uint:new U("r16uint",B.keyword,"r16uint"),r16sint:new U("r16sint",B.keyword,"r16sint"),r16float:new U("r16float",B.keyword,"r16float"),rg8unorm:new U("rg8unorm",B.keyword,"rg8unorm"),rg8snorm:new U("rg8snorm",B.keyword,"rg8snorm"),rg8uint:new U("rg8uint",B.keyword,"rg8uint"),rg8sint:new U("rg8sint",B.keyword,"rg8sint"),r32uint:new U("r32uint",B.keyword,"r32uint"),r32sint:new U("r32sint",B.keyword,"r32sint"),r32float:new U("r32float",B.keyword,"r32float"),rg16uint:new U("rg16uint",B.keyword,"rg16uint"),rg16sint:new U("rg16sint",B.keyword,"rg16sint"),rg16float:new U("rg16float",B.keyword,"rg16float"),rgba8unorm:new U("rgba8unorm",B.keyword,"rgba8unorm"),rgba8unorm_srgb:new U("rgba8unorm_srgb",B.keyword,"rgba8unorm_srgb"),rgba8snorm:new U("rgba8snorm",B.keyword,"rgba8snorm"),rgba8uint:new U("rgba8uint",B.keyword,"rgba8uint"),rgba8sint:new U("rgba8sint",B.keyword,"rgba8sint"),bgra8unorm:new U("bgra8unorm",B.keyword,"bgra8unorm"),bgra8unorm_srgb:new U("bgra8unorm_srgb",B.keyword,"bgra8unorm_srgb"),rgb10a2unorm:new U("rgb10a2unorm",B.keyword,"rgb10a2unorm"),rg11b10float:new U("rg11b10float",B.keyword,"rg11b10float"),rg32uint:new U("rg32uint",B.keyword,"rg32uint"),rg32sint:new U("rg32sint",B.keyword,"rg32sint"),rg32float:new U("rg32float",B.keyword,"rg32float"),rgba16uint:new U("rgba16uint",B.keyword,"rgba16uint"),rgba16sint:new U("rgba16sint",B.keyword,"rgba16sint"),rgba16float:new U("rgba16float",B.keyword,"rgba16float"),rgba32uint:new U("rgba32uint",B.keyword,"rgba32uint"),rgba32sint:new U("rgba32sint",B.keyword,"rgba32sint"),rgba32float:new U("rgba32float",B.keyword,"rgba32float"),static_assert:new U("static_assert",B.keyword,"static_assert")},A.tokens={decimal_float_literal:new U("decimal_float_literal",B.token,/((-?[0-9]*\.[0-9]+|-?[0-9]+\.[0-9]*)((e|E)(\+|-)?[0-9]+)?[fh]?)|(-?[0-9]+(e|E)(\+|-)?[0-9]+[fh]?)|(-?[0-9]+[fh])/),hex_float_literal:new U("hex_float_literal",B.token,/-?0x((([0-9a-fA-F]*\.[0-9a-fA-F]+|[0-9a-fA-F]+\.[0-9a-fA-F]*)((p|P)(\+|-)?[0-9]+[fh]?)?)|([0-9a-fA-F]+(p|P)(\+|-)?[0-9]+[fh]?))/),int_literal:new U("int_literal",B.token,/-?0x[0-9a-fA-F]+|0i?|-?[1-9][0-9]*i?/),uint_literal:new U("uint_literal",B.token,/0x[0-9a-fA-F]+u|0u|[1-9][0-9]*u/),name:new U("name",B.token,/([_\p{XID_Start}][\p{XID_Continue}]+)|([\p{XID_Start}])/u),ident:new U("ident",B.token,/[_a-zA-Z][0-9a-zA-Z_]*/),and:new U("and",B.token,"&"),and_and:new U("and_and",B.token,"&&"),arrow:new U("arrow ",B.token,"->"),attr:new U("attr",B.token,"@"),forward_slash:new U("forward_slash",B.token,"/"),bang:new U("bang",B.token,"!"),bracket_left:new U("bracket_left",B.token,"["),bracket_right:new U("bracket_right",B.token,"]"),brace_left:new U("brace_left",B.token,"{"),brace_right:new U("brace_right",B.token,"}"),colon:new U("colon",B.token,":"),comma:new U("comma",B.token,","),equal:new U("equal",B.token,"="),equal_equal:new U("equal_equal",B.token,"=="),not_equal:new U("not_equal",B.token,"!="),greater_than:new U("greater_than",B.token,">"),greater_than_equal:new U("greater_than_equal",B.token,">="),shift_right:new U("shift_right",B.token,">>"),less_than:new U("less_than",B.token,"<"),less_than_equal:new U("less_than_equal",B.token,"<="),shift_left:new U("shift_left",B.token,"<<"),modulo:new U("modulo",B.token,"%"),minus:new U("minus",B.token,"-"),minus_minus:new U("minus_minus",B.token,"--"),period:new U("period",B.token,"."),plus:new U("plus",B.token,"+"),plus_plus:new U("plus_plus",B.token,"++"),or:new U("or",B.token,"|"),or_or:new U("or_or",B.token,"||"),paren_left:new U("paren_left",B.token,"("),paren_right:new U("paren_right",B.token,")"),semicolon:new U("semicolon",B.token,";"),star:new U("star",B.token,"*"),tilde:new U("tilde",B.token,"~"),underscore:new U("underscore",B.token,"_"),xor:new U("xor",B.token,"^"),plus_equal:new U("plus_equal",B.token,"+="),minus_equal:new U("minus_equal",B.token,"-="),times_equal:new U("times_equal",B.token,"*="),division_equal:new U("division_equal",B.token,"/="),modulo_equal:new U("modulo_equal",B.token,"%="),and_equal:new U("and_equal",B.token,"&="),or_equal:new U("or_equal",B.token,"|="),xor_equal:new U("xor_equal",B.token,"^="),shift_right_equal:new U("shift_right_equal",B.token,">>="),shift_left_equal:new U("shift_left_equal",B.token,"<<=")},A.simpleTokens={"@":$.tokens.attr,"{":$.tokens.brace_left,"}":$.tokens.brace_right,":":$.tokens.colon,",":$.tokens.comma,"(":$.tokens.paren_left,")":$.tokens.paren_right,";":$.tokens.semicolon},A.literalTokens={"&":$.tokens.and,"&&":$.tokens.and_and,"->":$.tokens.arrow,"/":$.tokens.forward_slash,"!":$.tokens.bang,"[":$.tokens.bracket_left,"]":$.tokens.bracket_right,"=":$.tokens.equal,"==":$.tokens.equal_equal,"!=":$.tokens.not_equal,">":$.tokens.greater_than,">=":$.tokens.greater_than_equal,">>":$.tokens.shift_right,"<":$.tokens.less_than,"<=":$.tokens.less_than_equal,"<<":$.tokens.shift_left,"%":$.tokens.modulo,"-":$.tokens.minus,"--":$.tokens.minus_minus,".":$.tokens.period,"+":$.tokens.plus,"++":$.tokens.plus_plus,"|":$.tokens.or,"||":$.tokens.or_or,"*":$.tokens.star,"~":$.tokens.tilde,_:$.tokens.underscore,"^":$.tokens.xor,"+=":$.tokens.plus_equal,"-=":$.tokens.minus_equal,"*=":$.tokens.times_equal,"/=":$.tokens.division_equal,"%=":$.tokens.modulo_equal,"&=":$.tokens.and_equal,"|=":$.tokens.or_equal,"^=":$.tokens.xor_equal,">>=":$.tokens.shift_right_equal,"<<=":$.tokens.shift_left_equal},A.regexTokens={decimal_float_literal:$.tokens.decimal_float_literal,hex_float_literal:$.tokens.hex_float_literal,int_literal:$.tokens.int_literal,uint_literal:$.tokens.uint_literal,ident:$.tokens.ident},A.storage_class=[$.keywords.function,$.keywords.private,$.keywords.workgroup,$.keywords.uniform,$.keywords.storage],A.access_mode=[$.keywords.read,$.keywords.write,$.keywords.read_write],A.sampler_type=[$.keywords.sampler,$.keywords.sampler_comparison],A.sampled_texture_type=[$.keywords.texture_1d,$.keywords.texture_2d,$.keywords.texture_2d_array,$.keywords.texture_3d,$.keywords.texture_cube,$.keywords.texture_cube_array],A.multisampled_texture_type=[$.keywords.texture_multisampled_2d],A.storage_texture_type=[$.keywords.texture_storage_1d,$.keywords.texture_storage_2d,$.keywords.texture_storage_2d_array,$.keywords.texture_storage_3d],A.depth_texture_type=[$.keywords.texture_depth_2d,$.keywords.texture_depth_2d_array,$.keywords.texture_depth_cube,$.keywords.texture_depth_cube_array,$.keywords.texture_depth_multisampled_2d],A.texture_external_type=[$.keywords.texture_external],A.any_texture_type=[...$.sampled_texture_type,...$.multisampled_texture_type,...$.storage_texture_type,...$.depth_texture_type,...$.texture_external_type],A.texel_format=[$.keywords.r8unorm,$.keywords.r8snorm,$.keywords.r8uint,$.keywords.r8sint,$.keywords.r16uint,$.keywords.r16sint,$.keywords.r16float,$.keywords.rg8unorm,$.keywords.rg8snorm,$.keywords.rg8uint,$.keywords.rg8sint,$.keywords.r32uint,$.keywords.r32sint,$.keywords.r32float,$.keywords.rg16uint,$.keywords.rg16sint,$.keywords.rg16float,$.keywords.rgba8unorm,$.keywords.rgba8unorm_srgb,$.keywords.rgba8snorm,$.keywords.rgba8uint,$.keywords.rgba8sint,$.keywords.bgra8unorm,$.keywords.bgra8unorm_srgb,$.keywords.rgb10a2unorm,$.keywords.rg11b10float,$.keywords.rg32uint,$.keywords.rg32sint,$.keywords.rg32float,$.keywords.rgba16uint,$.keywords.rgba16sint,$.keywords.rgba16float,$.keywords.rgba32uint,$.keywords.rgba32sint,$.keywords.rgba32float],A.const_literal=[$.tokens.int_literal,$.tokens.uint_literal,$.tokens.decimal_float_literal,$.tokens.hex_float_literal,$.keywords.true,$.keywords.false],A.literal_or_ident=[$.tokens.ident,$.tokens.int_literal,$.tokens.uint_literal,$.tokens.decimal_float_literal,$.tokens.hex_float_literal,$.tokens.name],A.element_count_expression=[$.tokens.int_literal,$.tokens.uint_literal,$.tokens.ident],A.template_types=[$.keywords.vec2,$.keywords.vec3,$.keywords.vec4,$.keywords.mat2x2,$.keywords.mat2x3,$.keywords.mat2x4,$.keywords.mat3x2,$.keywords.mat3x3,$.keywords.mat3x4,$.keywords.mat4x2,$.keywords.mat4x3,$.keywords.mat4x4,$.keywords.atomic,$.keywords.bitcast,...$.any_texture_type],A.attribute_name=[$.tokens.ident,$.keywords.block,$.keywords.diagnostic],A.assignment_operators=[$.tokens.equal,$.tokens.plus_equal,$.tokens.minus_equal,$.tokens.times_equal,$.tokens.division_equal,$.tokens.modulo_equal,$.tokens.and_equal,$.tokens.or_equal,$.tokens.xor_equal,$.tokens.shift_right_equal,$.tokens.shift_left_equal],A.increment_operators=[$.tokens.plus_plus,$.tokens.minus_minus];class Mm{constructor(t,e,r,i,s){this.type=t,this.lexeme=e,this.line=r,this.start=i,this.end=s}toString(){return this.lexeme}isTemplateType(){return A.template_types.indexOf(this.type)!=-1}isArrayType(){return this.type==A.keywords.array}isArrayOrTemplateType(){return this.isArrayType()||this.isTemplateType()}}class $P{constructor(t){this._tokens=[],this._start=0,this._current=0,this._line=1,this._source=t??""}scanTokens(){for(;!this._isAtEnd();)if(this._start=this._current,!this.scanToken())throw`Invalid syntax at line ${this._line}`;return this._tokens.push(new Mm(A.eof,"",this._line,this._current,this._current)),this._tokens}scanToken(){let t=this._advance();if(t==`
`)return this._line++,!0;if(this._isWhitespace(t))return!0;if(t=="/"){if(this._peekAhead()=="/"){for(;t!=`
`;){if(this._isAtEnd())return!0;t=this._advance()}return this._line++,!0}if(this._peekAhead()=="*"){this._advance();let o=1;for(;o>0;){if(this._isAtEnd())return!0;if(t=this._advance(),t==`
`)this._line++;else if(t=="*"){if(this._peekAhead()=="/"&&(this._advance(),o--,o==0))return!0}else t=="/"&&this._peekAhead()=="*"&&(this._advance(),o++)}return!0}}const e=A.simpleTokens[t];if(e)return this._addToken(e),!0;let r=A.none;const i=this._isAlpha(t),s=t==="_";if(this._isAlphaNumeric(t)){let o=this._peekAhead();for(;this._isAlphaNumeric(o);)t+=this._advance(),o=this._peekAhead()}if(i){const o=A.keywords[t];if(o)return this._addToken(o),!0}if(i||s)return this._addToken(A.tokens.ident),!0;for(;;){let o=this._findType(t);const a=this._peekAhead();if(t=="-"&&this._tokens.length>0){if(a=="=")return this._current++,t+=a,this._addToken(A.tokens.minus_equal),!0;if(a=="-")return this._current++,t+=a,this._addToken(A.tokens.minus_minus),!0;const l=this._tokens.length-1;if((A.literal_or_ident.indexOf(this._tokens[l].type)!=-1||this._tokens[l].type==A.tokens.paren_right)&&a!=">")return this._addToken(o),!0}if(t==">"&&(a==">"||a=="=")){let l=!1,c=this._tokens.length-1;for(let u=0;u<5&&c>=0&&A.assignment_operators.indexOf(this._tokens[c].type)===-1;++u,--c)if(this._tokens[c].type===A.tokens.less_than){c>0&&this._tokens[c-1].isArrayOrTemplateType()&&(l=!0);break}if(l)return this._addToken(o),!0}if(o===A.none){let l=t,c=0;const u=2;for(let h=0;h<u;++h)if(l+=this._peekAhead(h),o=this._findType(l),o!==A.none){c=h;break}if(o===A.none)return r!==A.none&&(this._current--,this._addToken(r),!0);t=l,this._current+=c+1}if(r=o,this._isAtEnd())break;t+=this._advance()}return r!==A.none&&(this._addToken(r),!0)}_findType(t){for(const r in A.regexTokens){const i=A.regexTokens[r];if(this._match(t,i.rule))return i}return A.literalTokens[t]||A.none}_match(t,e){const r=e.exec(t);return r&&r.index==0&&r[0]==t}_isAtEnd(){return this._current>=this._source.length}_isAlpha(t){return!this._isNumeric(t)&&!this._isWhitespace(t)&&t!=="_"&&t!=="."&&t!=="("&&t!==")"&&t!=="["&&t!=="]"&&t!=="{"&&t!=="}"&&t!==","&&t!==";"&&t!==":"&&t!=="="&&t!=="!"&&t!=="<"&&t!==">"&&t!=="+"&&t!=="-"&&t!=="*"&&t!=="/"&&t!=="%"&&t!=="&"&&t!=="|"&&t!=="^"&&t!=="~"&&t!=="@"&&t!=="#"&&t!=="?"&&t!=="'"&&t!=="`"&&t!=='"'&&t!=="\\"&&t!==`
`&&t!=="\r"&&t!=="	"&&t!=="\0"}_isNumeric(t){return t>="0"&&t<="9"}_isAlphaNumeric(t){return this._isAlpha(t)||this._isNumeric(t)||t==="_"}_isWhitespace(t){return t==" "||t=="	"||t=="\r"}_advance(t=0){let e=this._source[this._current];return t=t||0,t++,this._current+=t,e}_peekAhead(t=0){return t=t||0,this._current+t>=this._source.length?"\0":this._source[this._current+t]}_addToken(t){const e=this._source.substring(this._start,this._current);this._tokens.push(new Mm(t,e,this._line,this._start,this._current))}}function it(n){return Array.isArray(n)||n?.buffer instanceof ArrayBuffer}const Du=new Float32Array(1),XP=new Uint32Array(Du.buffer),GP=new Uint32Array(Du.buffer),Lu=new Int32Array(1),YP=new Float32Array(Lu.buffer),qP=new Uint32Array(Lu.buffer),ku=new Uint32Array(1),KP=new Float32Array(ku.buffer),ZP=new Int32Array(ku.buffer);function Rm(n,t,e){if(t===e)return n;if(t==="f32"){if(e==="i32"||e==="x32")return Du[0]=n,XP[0];if(e==="u32")return Du[0]=n,GP[0]}else if(t==="i32"||t==="x32"){if(e==="f32")return Lu[0]=n,YP[0];if(e==="u32")return Lu[0]=n,qP[0]}else if(t==="u32"){if(e==="f32")return ku[0]=n,KP[0];if(e==="i32"||e==="x32")return ku[0]=n,ZP[0]}return console.error(`Unsupported cast from ${t} to ${e}`),n}class JP{constructor(t){this.resources=null,this.inUse=!1,this.info=null,this.node=t}}class Mc{constructor(t,e){this.align=t,this.size=e}}class xi{constructor(){this.uniforms=[],this.storage=[],this.textures=[],this.samplers=[],this.aliases=[],this.overrides=[],this.structs=[],this.entry=new LP,this.functions=[],this._types=new Map,this._functions=new Map}_isStorageTexture(t){return t.name=="texture_storage_1d"||t.name=="texture_storage_2d"||t.name=="texture_storage_2d_array"||t.name=="texture_storage_3d"}updateAST(t){for(const e of t)e instanceof Il&&this._functions.set(e.name,new JP(e));for(const e of t)if(e instanceof zi){const r=this.getTypeInfo(e,null);r instanceof gs&&this.structs.push(r)}for(const e of t)if(e instanceof Np)this.aliases.push(this._getAliasInfo(e));else if(e instanceof Mp){const r=e,i=this._getAttributeNum(r.attributes,"id",0),s=r.type!=null?this.getTypeInfo(r.type,r.attributes):null;this.overrides.push(new NP(r.name,s,r.attributes,i))}else if(this._isUniformVar(e)){const r=e,i=this._getAttributeNum(r.attributes,"group",0),s=this._getAttributeNum(r.attributes,"binding",0),o=this.getTypeInfo(r.type,r.attributes),a=new Ac(r.name,o,i,s,r.attributes,hs.Uniform,r.access);a.access||(a.access="read"),this.uniforms.push(a)}else if(this._isStorageVar(e)){const r=e,i=this._getAttributeNum(r.attributes,"group",0),s=this._getAttributeNum(r.attributes,"binding",0),o=this.getTypeInfo(r.type,r.attributes),a=this._isStorageTexture(o),l=new Ac(r.name,o,i,s,r.attributes,a?hs.StorageTexture:hs.Storage,r.access);l.access||(l.access="read"),this.storage.push(l)}else if(this._isTextureVar(e)){const r=e,i=this._getAttributeNum(r.attributes,"group",0),s=this._getAttributeNum(r.attributes,"binding",0),o=this.getTypeInfo(r.type,r.attributes),a=this._isStorageTexture(o),l=new Ac(r.name,o,i,s,r.attributes,a?hs.StorageTexture:hs.Texture,r.access);l.access||(l.access="read"),a?this.storage.push(l):this.textures.push(l)}else if(this._isSamplerVar(e)){const r=e,i=this._getAttributeNum(r.attributes,"group",0),s=this._getAttributeNum(r.attributes,"binding",0),o=this.getTypeInfo(r.type,r.attributes),a=new Ac(r.name,o,i,s,r.attributes,hs.Sampler,r.access);this.samplers.push(a)}for(const e of t)if(e instanceof Il){const r=this._getAttribute(e,"vertex"),i=this._getAttribute(e,"fragment"),s=this._getAttribute(e,"compute"),o=r||i||s,a=new DP(e.name,o?.name,e.attributes);a.attributes=e.attributes,a.startLine=e.startLine,a.endLine=e.endLine,this.functions.push(a),this._functions.get(e.name).info=a,o&&(this._functions.get(e.name).inUse=!0,a.inUse=!0,a.resources=this._findResources(e,!!o),a.inputs=this._getInputs(e.args),a.outputs=this._getOutputs(e.returnType),this.entry[o.name].push(a)),a.arguments=e.args.map(l=>new OP(l.name,this.getTypeInfo(l.type,l.attributes),l.attributes)),a.returnType=e.returnType?this.getTypeInfo(e.returnType,e.attributes):null}for(const e of this._functions.values())e.info&&(e.info.inUse=e.inUse,this._addCalls(e.node,e.info.calls));for(const e of this._functions.values())e.node.search(r=>{var i,s,o;if(r instanceof db){if(r.value)if(it(r.value))for(const a of r.value)for(const l of this.overrides)a===l.name&&((i=e.info)===null||i===void 0||i.overrides.push(l));else for(const a of this.overrides)r.value===a.name&&((s=e.info)===null||s===void 0||s.overrides.push(a))}else if(r instanceof Zn)for(const a of this.overrides)r.name===a.name&&((o=e.info)===null||o===void 0||o.overrides.push(a))});for(const e of this.uniforms)this._markStructsInUse(e.type);for(const e of this.storage)this._markStructsInUse(e.type)}getStructInfo(t){for(const e of this.structs)if(e.name==t)return e;return null}getOverrideInfo(t){for(const e of this.overrides)if(e.name==t)return e;return null}_markStructsInUse(t){if(t)if(t.isStruct){if(t.inUse=!0,t.members)for(const e of t.members)this._markStructsInUse(e.type)}else if(t.isArray)this._markStructsInUse(t.format);else if(t.isTemplate)t.format&&this._markStructsInUse(t.format);else{const e=this._getAlias(t.name);e&&this._markStructsInUse(e)}}_addCalls(t,e){var r;for(const i of t.calls){const s=(r=this._functions.get(i.name))===null||r===void 0?void 0:r.info;s&&e.add(s)}}findResource(t,e,r){if(r){for(const i of this.entry.compute)if(i.name===r){for(const s of i.resources)if(s.group==t&&s.binding==e)return s}for(const i of this.entry.vertex)if(i.name===r){for(const s of i.resources)if(s.group==t&&s.binding==e)return s}for(const i of this.entry.fragment)if(i.name===r){for(const s of i.resources)if(s.group==t&&s.binding==e)return s}}for(const i of this.uniforms)if(i.group==t&&i.binding==e)return i;for(const i of this.storage)if(i.group==t&&i.binding==e)return i;for(const i of this.textures)if(i.group==t&&i.binding==e)return i;for(const i of this.samplers)if(i.group==t&&i.binding==e)return i;return null}_findResource(t){for(const e of this.uniforms)if(e.name==t)return e;for(const e of this.storage)if(e.name==t)return e;for(const e of this.textures)if(e.name==t)return e;for(const e of this.samplers)if(e.name==t)return e;return null}_markStructsFromAST(t){const e=this.getTypeInfo(t,null);this._markStructsInUse(e)}_findResources(t,e){const r=[],i=this,s=[];return t.search(o=>{if(o instanceof Nu)s.push({});else if(o instanceof Ou)s.pop();else if(o instanceof Wi){const a=o;e&&a.type!==null&&this._markStructsFromAST(a.type),s.length>0&&(s[s.length-1][a.name]=a)}else if(o instanceof yi){const a=o;e&&a.type!==null&&this._markStructsFromAST(a.type)}else if(o instanceof bl){const a=o;e&&a.type!==null&&this._markStructsFromAST(a.type),s.length>0&&(s[s.length-1][a.name]=a)}else if(o instanceof Zn){const a=o;if(s.length>0&&s[s.length-1][a.name])return;const l=i._findResource(a.name);l&&r.push(l)}else if(o instanceof Op){const a=o,l=i._functions.get(a.name);l&&(e&&(l.inUse=!0),t.calls.add(l.node),l.resources===null&&(l.resources=i._findResources(l.node,e)),r.push(...l.resources))}else if(o instanceof Rp){const a=o,l=i._functions.get(a.name);l&&(e&&(l.inUse=!0),t.calls.add(l.node),l.resources===null&&(l.resources=i._findResources(l.node,e)),r.push(...l.resources))}}),[...new Map(r.map(o=>[o.name,o])).values()]}getBindGroups(){const t=[];function e(r,i){r>=t.length&&(t.length=r+1),t[r]===void 0&&(t[r]=[]),i>=t[r].length&&(t[r].length=i+1)}for(const r of this.uniforms)e(r.group,r.binding),t[r.group][r.binding]=r;for(const r of this.storage)e(r.group,r.binding),t[r.group][r.binding]=r;for(const r of this.textures)e(r.group,r.binding),t[r.group][r.binding]=r;for(const r of this.samplers)e(r.group,r.binding),t[r.group][r.binding]=r;return t}_getOutputs(t,e=void 0){if(e===void 0&&(e=[]),t instanceof zi)this._getStructOutputs(t,e);else{const r=this._getOutputInfo(t);r!==null&&e.push(r)}return e}_getStructOutputs(t,e){for(const r of t.members)if(r.type instanceof zi)this._getStructOutputs(r.type,e);else{const i=this._getAttribute(r,"location")||this._getAttribute(r,"builtin");if(i!==null){const s=this.getTypeInfo(r.type,r.type.attributes),o=this._parseInt(i.value),a=new Cm(r.name,s,i.name,o);e.push(a)}}}_getOutputInfo(t){const e=this._getAttribute(t,"location")||this._getAttribute(t,"builtin");if(e!==null){const r=this.getTypeInfo(t,t.attributes),i=this._parseInt(e.value);return new Cm("",r,e.name,i)}return null}_getInputs(t,e=void 0){e===void 0&&(e=[]);for(const r of t)if(r.type instanceof zi)this._getStructInputs(r.type,e);else{const i=this._getInputInfo(r);i!==null&&e.push(i)}return e}_getStructInputs(t,e){for(const r of t.members)if(r.type instanceof zi)this._getStructInputs(r.type,e);else{const i=this._getInputInfo(r);i!==null&&e.push(i)}}_getInputInfo(t){const e=this._getAttribute(t,"location")||this._getAttribute(t,"builtin");if(e!==null){const r=this._getAttribute(t,"interpolation"),i=this.getTypeInfo(t.type,t.attributes),s=this._parseInt(e.value),o=new RP(t.name,i,e.name,s);return r!==null&&(o.interpolation=this._parseString(r.value)),o}return null}_parseString(t){return t instanceof Array&&(t=t[0]),t}_parseInt(t){t instanceof Array&&(t=t[0]);const e=parseInt(t);return isNaN(e)?t:e}_getAlias(t){for(const e of this.aliases)if(e.name==t)return e.type;return null}_getAliasInfo(t){return new MP(t.name,this.getTypeInfo(t.type,null))}getTypeInfoByName(t){for(const e of this.structs)if(e.name==t)return e;for(const e of this.aliases)if(e.name==t)return e.type;return null}getTypeInfo(t,e=null){if(this._types.has(t))return this._types.get(t);if(t instanceof ru){const i=t.type?this.getTypeInfo(t.type,t.attributes):null,s=new pd(t.name,i,e);return this._types.set(t,s),this._updateTypeInfo(s),s}if(t instanceof xl){const i=t,s=i.format?this.getTypeInfo(i.format,i.attributes):null,o=new ws(i.name,e);return o.format=s,o.count=i.count,this._types.set(t,o),this._updateTypeInfo(o),o}if(t instanceof zi){const i=t,s=new gs(i.name,e);s.startLine=i.startLine,s.endLine=i.endLine;for(const o of i.members){const a=this.getTypeInfo(o.type,o.attributes);s.members.push(new Sm(o.name,a,o.attributes))}return this._types.set(t,s),this._updateTypeInfo(s),s}if(t instanceof ll){const i=t,s=i.format instanceof Z,o=i.format?s?this.getTypeInfo(i.format,null):new Er(i.format,null):null,a=new oo(i.name,o,e,i.access);return this._types.set(t,a),this._updateTypeInfo(a),a}if(t instanceof W){const i=t,s=i.format?this.getTypeInfo(i.format,null):null,o=new oo(i.name,s,e,i.access);return this._types.set(t,o),this._updateTypeInfo(o),o}const r=new Er(t.name,e);return this._types.set(t,r),this._updateTypeInfo(r),r}_updateTypeInfo(t){var e,r,i;const s=this._getTypeSize(t);if(t.size=(e=s?.size)!==null&&e!==void 0?e:0,t instanceof ws&&t.format){const o=this._getTypeSize(t.format);t.stride=Math.max((r=o?.size)!==null&&r!==void 0?r:0,(i=o?.align)!==null&&i!==void 0?i:0),this._updateTypeInfo(t.format)}t instanceof pd&&this._updateTypeInfo(t.format),t instanceof gs&&this._updateStructInfo(t)}_updateStructInfo(t){var e;let r=0,i=0,s=0,o=0;for(let a=0,l=t.members.length;a<l;++a){const c=t.members[a],u=this._getTypeSize(c);if(!u)continue;(e=this._getAlias(c.type.name))!==null&&e!==void 0||c.type;const h=u.align,f=u.size;r=this._roundUp(h,r+i),i=f,s=r,o=Math.max(o,h),c.offset=r,c.size=f,this._updateTypeInfo(c.type)}t.size=this._roundUp(o,s+i),t.align=o}_getTypeSize(t){var e,r;if(t==null)return null;const i=this._getAttributeNum(t.attributes,"size",0),s=this._getAttributeNum(t.attributes,"align",0);if(t instanceof Sm&&(t=t.type),t instanceof Er){const o=this._getAlias(t.name);o!==null&&(t=o)}{const o=xi._typeInfo[t.name];if(o!==void 0){const a=((e=t.format)===null||e===void 0?void 0:e.name)==="f16"?2:1;return new Mc(Math.max(s,o.align/a),Math.max(i,o.size/a))}}{const o=xi._typeInfo[t.name.substring(0,t.name.length-1)];if(o){const a=t.name[t.name.length-1]==="h"?2:1;return new Mc(Math.max(s,o.align/a),Math.max(i,o.size/a))}}if(t instanceof ws){let o=t,a=8,l=8;const c=this._getTypeSize(o.format);return c!==null&&(l=c.size,a=c.align),l=o.count*this._getAttributeNum((r=t?.attributes)!==null&&r!==void 0?r:null,"stride",this._roundUp(a,l)),i&&(l=i),new Mc(Math.max(s,a),Math.max(i,l))}if(t instanceof gs){let o=0,a=0,l=0,c=0,u=0;for(const h of t.members){const f=this._getTypeSize(h.type);f!==null&&(o=Math.max(f.align,o),l=this._roundUp(f.align,l+c),c=f.size,u=l)}return a=this._roundUp(o,u+c),new Mc(Math.max(s,o),Math.max(i,a))}return null}_isUniformVar(t){return t instanceof Wi&&t.storage=="uniform"}_isStorageVar(t){return t instanceof Wi&&t.storage=="storage"}_isTextureVar(t){return t instanceof Wi&&t.type!==null&&xi._textureTypes.indexOf(t.type.name)!=-1}_isSamplerVar(t){return t instanceof Wi&&t.type!==null&&xi._samplerTypes.indexOf(t.type.name)!=-1}_getAttribute(t,e){const r=t;if(!r||!r.attributes)return null;const i=r.attributes;for(let s of i)if(s.name==e)return s;return null}_getAttributeNum(t,e,r){if(t===null)return r;for(let i of t)if(i.name==e){let s=i!==null&&i.value!==null?i.value:r;return s instanceof Array&&(s=s[0]),typeof s=="number"?s:typeof s=="string"?parseInt(s):r}return r}_roundUp(t,e){return Math.ceil(e/t)*t}}xi._typeInfo={f16:{align:2,size:2},i32:{align:4,size:4},u32:{align:4,size:4},f32:{align:4,size:4},atomic:{align:4,size:4},vec2:{align:8,size:8},vec3:{align:16,size:12},vec4:{align:16,size:16},mat2x2:{align:8,size:16},mat3x2:{align:8,size:24},mat4x2:{align:8,size:32},mat2x3:{align:16,size:32},mat3x3:{align:16,size:48},mat4x3:{align:16,size:64},mat2x4:{align:16,size:32},mat3x4:{align:16,size:48},mat4x4:{align:16,size:64}},xi._textureTypes=A.any_texture_type.map(n=>n.name),xi._samplerTypes=A.sampler_type.map(n=>n.name);let Dp=0;class Lp{constructor(t,e,r){this.id=Dp++,this.name=t,this.value=e,this.node=r}clone(){return new Lp(this.name,this.value,this.node)}}class kp{constructor(t){this.id=Dp++,this.name=t.name,this.node=t}clone(){return new kp(this.node)}}let QP=class gb{constructor(t){this.parent=null,this.variables=new Map,this.functions=new Map,this.currentFunctionName="",this.id=Dp++,t&&(this.parent=t,this.currentFunctionName=t.currentFunctionName)}getVariable(t){var e;return this.variables.has(t)?(e=this.variables.get(t))!==null&&e!==void 0?e:null:this.parent?this.parent.getVariable(t):null}getFunction(t){var e;return this.functions.has(t)?(e=this.functions.get(t))!==null&&e!==void 0?e:null:this.parent?this.parent.getFunction(t):null}createVariable(t,e,r){this.variables.set(t,new Lp(t,e,r??null))}setVariable(t,e,r){const i=this.getVariable(t);i!==null?i.value=e:this.createVariable(t,e,r)}getVariableValue(t){var e;const r=this.getVariable(t);return(e=r?.value)!==null&&e!==void 0?e:null}clone(){return new gb(this)}},tI=class{evalExpression(t,e){return null}getTypeInfo(t){return null}getVariableName(t,e){return""}},eI=class{constructor(t){this.exec=t}getTypeInfo(t){return this.exec.getTypeInfo(t)}All(t,e){const r=this.exec.evalExpression(t.args[0],e);let i=!0;if(r instanceof N)return r.data.forEach(s=>{s||(i=!1)}),new F(i?1:0,this.getTypeInfo("bool"));throw new Error(`All() expects a vector argument. Line ${t.line}`)}Any(t,e){const r=this.exec.evalExpression(t.args[0],e);if(r instanceof N){const i=r.data.some(s=>s);return new F(i?1:0,this.getTypeInfo("bool"))}throw new Error(`Any() expects a vector argument. Line ${t.line}`)}Select(t,e){const r=this.exec.evalExpression(t.args[2],e);if(!(r instanceof F))throw new Error(`Select() expects a bool condition. Line ${t.line}`);return r.value?this.exec.evalExpression(t.args[1],e):this.exec.evalExpression(t.args[0],e)}ArrayLength(t,e){let r=t.args[0];r instanceof Pe&&(r=r.right);const i=this.exec.evalExpression(r,e);if(i instanceof _e&&i.typeInfo.size===0){const s=i.typeInfo,o=i.buffer.byteLength/s.stride;return new F(o,this.getTypeInfo("u32"))}return new F(i.typeInfo.size,this.getTypeInfo("u32"))}Abs(t,e){const r=this.exec.evalExpression(t.args[0],e);if(r instanceof N)return new N(r.data.map(s=>Math.abs(s)),r.typeInfo);const i=r;return new F(Math.abs(i.value),i.typeInfo)}Acos(t,e){const r=this.exec.evalExpression(t.args[0],e);if(r instanceof N)return new N(r.data.map(s=>Math.acos(s)),r.typeInfo);const i=r;return new F(Math.acos(i.value),r.typeInfo)}Acosh(t,e){const r=this.exec.evalExpression(t.args[0],e);if(r instanceof N)return new N(r.data.map(s=>Math.acosh(s)),r.typeInfo);const i=r;return new F(Math.acosh(i.value),r.typeInfo)}Asin(t,e){const r=this.exec.evalExpression(t.args[0],e);if(r instanceof N)return new N(r.data.map(s=>Math.asin(s)),r.typeInfo);const i=r;return new F(Math.asin(i.value),r.typeInfo)}Asinh(t,e){const r=this.exec.evalExpression(t.args[0],e);if(r instanceof N)return new N(r.data.map(s=>Math.asinh(s)),r.typeInfo);const i=r;return new F(Math.asinh(i.value),r.typeInfo)}Atan(t,e){const r=this.exec.evalExpression(t.args[0],e);if(r instanceof N)return new N(r.data.map(s=>Math.atan(s)),r.typeInfo);const i=r;return new F(Math.atan(i.value),r.typeInfo)}Atanh(t,e){const r=this.exec.evalExpression(t.args[0],e);if(r instanceof N)return new N(r.data.map(s=>Math.atanh(s)),r.typeInfo);const i=r;return new F(Math.atanh(i.value),r.typeInfo)}Atan2(t,e){const r=this.exec.evalExpression(t.args[0],e),i=this.exec.evalExpression(t.args[1],e);if(r instanceof N&&i instanceof N)return new N(r.data.map((a,l)=>Math.atan2(a,i.data[l])),r.typeInfo);const s=r,o=i;return new F(Math.atan2(s.value,o.value),r.typeInfo)}Ceil(t,e){const r=this.exec.evalExpression(t.args[0],e);if(r instanceof N)return new N(r.data.map(s=>Math.ceil(s)),r.typeInfo);const i=r;return new F(Math.ceil(i.value),r.typeInfo)}_clamp(t,e,r){return Math.min(Math.max(t,e),r)}Clamp(t,e){const r=this.exec.evalExpression(t.args[0],e),i=this.exec.evalExpression(t.args[1],e),s=this.exec.evalExpression(t.args[2],e);if(r instanceof N&&i instanceof N&&s instanceof N)return new N(r.data.map((c,u)=>this._clamp(c,i.data[u],s.data[u])),r.typeInfo);const o=r,a=i,l=s;return new F(this._clamp(o.value,a.value,l.value),r.typeInfo)}Cos(t,e){const r=this.exec.evalExpression(t.args[0],e);if(r instanceof N)return new N(r.data.map(s=>Math.cos(s)),r.typeInfo);const i=r;return new F(Math.cos(i.value),r.typeInfo)}Cosh(t,e){const r=this.exec.evalExpression(t.args[0],e);if(r instanceof N)return new N(r.data.map(s=>Math.cosh(s)),r.typeInfo);const i=r;return new F(Math.cos(i.value),r.typeInfo)}CountLeadingZeros(t,e){const r=this.exec.evalExpression(t.args[0],e);if(r instanceof N)return new N(r.data.map(s=>Math.clz32(s)),r.typeInfo);const i=r;return new F(Math.clz32(i.value),r.typeInfo)}_countOneBits(t){let e=0;for(;t!==0;)1&t&&e++,t>>=1;return e}CountOneBits(t,e){const r=this.exec.evalExpression(t.args[0],e);if(r instanceof N)return new N(r.data.map(s=>this._countOneBits(s)),r.typeInfo);const i=r;return new F(this._countOneBits(i.value),r.typeInfo)}_countTrailingZeros(t){if(t===0)return 32;let e=0;for(;!(1&t);)t>>=1,e++;return e}CountTrailingZeros(t,e){const r=this.exec.evalExpression(t.args[0],e);if(r instanceof N)return new N(r.data.map(s=>this._countTrailingZeros(s)),r.typeInfo);const i=r;return new F(this._countTrailingZeros(i.value),r.typeInfo)}Cross(t,e){const r=this.exec.evalExpression(t.args[0],e),i=this.exec.evalExpression(t.args[1],e);if(r instanceof N&&i instanceof N){if(r.data.length!==3||i.data.length!==3)return console.error(`Cross() expects 3D vectors. Line ${t.line}`),null;const s=r.data,o=i.data;return new N([s[1]*o[2]-o[1]*s[2],s[2]*o[0]-o[2]*s[0],s[0]*o[1]-o[0]*s[1]],r.typeInfo)}return console.error(`Cross() expects vector arguments. Line ${t.line}`),null}Degrees(t,e){const r=this.exec.evalExpression(t.args[0],e),i=180/Math.PI;return r instanceof N?new N(r.data.map(s=>s*i),r.typeInfo):new F(r.value*i,this.getTypeInfo("f32"))}Determinant(t,e){const r=this.exec.evalExpression(t.args[0],e);if(r instanceof pt){const i=r.data,s=r.typeInfo.getTypeName(),o=s.endsWith("h")?this.getTypeInfo("f16"):this.getTypeInfo("f32");if(s==="mat2x2"||s==="mat2x2f"||s==="mat2x2h")return new F(i[0]*i[3]-i[1]*i[2],o);if(s==="mat2x3"||s==="mat2x3f"||s==="mat2x3h")return new F(i[0]*(i[4]*i[8]-i[5]*i[7])-i[1]*(i[3]*i[8]-i[5]*i[6])+i[2]*(i[3]*i[7]-i[4]*i[6]),o);if(s==="mat2x4"||s==="mat2x4f"||s==="mat2x4h")console.error(`TODO: Determinant for ${s}`);else if(s==="mat3x2"||s==="mat3x2f"||s==="mat3x2h")console.error(`TODO: Determinant for ${s}`);else{if(s==="mat3x3"||s==="mat3x3f"||s==="mat3x3h")return new F(i[0]*(i[4]*i[8]-i[5]*i[7])-i[1]*(i[3]*i[8]-i[5]*i[6])+i[2]*(i[3]*i[7]-i[4]*i[6]),o);s==="mat3x4"||s==="mat3x4f"||s==="mat3x4h"||s==="mat4x2"||s==="mat4x2f"||s==="mat4x2h"||s==="mat4x3"||s==="mat4x3f"||s==="mat4x3h"?console.error(`TODO: Determinant for ${s}`):s!=="mat4x4"&&s!=="mat4x4f"&&s!=="mat4x4h"||console.error(`TODO: Determinant for ${s}`)}}return console.error(`Determinant expects a matrix argument. Line ${t.line}`),null}Distance(t,e){const r=this.exec.evalExpression(t.args[0],e),i=this.exec.evalExpression(t.args[1],e);if(r instanceof N&&i instanceof N){let a=0;for(let l=0;l<r.data.length;++l)a+=(r.data[l]-i.data[l])*(r.data[l]-i.data[l]);return new F(Math.sqrt(a),this.getTypeInfo("f32"))}const s=r,o=i;return new F(Math.abs(s.value-o.value),r.typeInfo)}_dot(t,e){let r=0;for(let i=0;i<t.length;++i)r+=e[i]*t[i];return r}Dot(t,e){const r=this.exec.evalExpression(t.args[0],e),i=this.exec.evalExpression(t.args[1],e);return r instanceof N&&i instanceof N?new F(this._dot(r.data,i.data),this.getTypeInfo("f32")):(console.error(`Dot() expects vector arguments. Line ${t.line}`),null)}Dot4U8Packed(t,e){return console.error(`TODO: dot4U8Packed. Line ${t.line}`),null}Dot4I8Packed(t,e){return console.error(`TODO: dot4I8Packed. Line ${t.line}`),null}Exp(t,e){const r=this.exec.evalExpression(t.args[0],e);if(r instanceof N)return new N(r.data.map(s=>Math.exp(s)),r.typeInfo);const i=r;return new F(Math.exp(i.value),r.typeInfo)}Exp2(t,e){const r=this.exec.evalExpression(t.args[0],e);if(r instanceof N)return new N(r.data.map(s=>Math.pow(2,s)),r.typeInfo);const i=r;return new F(Math.pow(2,i.value),r.typeInfo)}ExtractBits(t,e){const r=this.exec.evalExpression(t.args[0],e),i=this.exec.evalExpression(t.args[1],e),s=this.exec.evalExpression(t.args[2],e);if(i.typeInfo.name!=="u32"&&i.typeInfo.name!=="x32")return console.error(`ExtractBits() expects an i32 offset argument. Line ${t.line}`),null;if(s.typeInfo.name!=="u32"&&s.typeInfo.name!=="x32")return console.error(`ExtractBits() expects an i32 count argument. Line ${t.line}`),null;const o=i.value,a=s.value;if(r instanceof N)return new N(r.data.map(c=>c>>o&(1<<a)-1),r.typeInfo);if(r.typeInfo.name!=="i32"&&r.typeInfo.name!=="x32")return console.error(`ExtractBits() expects an i32 argument. Line ${t.line}`),null;const l=r.value;return new F(l>>o&(1<<a)-1,this.getTypeInfo("i32"))}FaceForward(t,e){const r=this.exec.evalExpression(t.args[0],e),i=this.exec.evalExpression(t.args[1],e),s=this.exec.evalExpression(t.args[2],e);if(r instanceof N&&i instanceof N&&s instanceof N){const o=this._dot(i.data,s.data);return new N(o<0?Array.from(r.data):r.data.map(a=>-a),r.typeInfo)}return console.error(`FaceForward() expects vector arguments. Line ${t.line}`),null}_firstLeadingBit(t){return t===0?-1:31-Math.clz32(t)}FirstLeadingBit(t,e){const r=this.exec.evalExpression(t.args[0],e);if(r instanceof N)return new N(r.data.map(s=>this._firstLeadingBit(s)),r.typeInfo);const i=r;return new F(this._firstLeadingBit(i.value),r.typeInfo)}_firstTrailingBit(t){return t===0?-1:Math.log2(t&-t)}FirstTrailingBit(t,e){const r=this.exec.evalExpression(t.args[0],e);if(r instanceof N)return new N(r.data.map(s=>this._firstTrailingBit(s)),r.typeInfo);const i=r;return new F(this._firstTrailingBit(i.value),r.typeInfo)}Floor(t,e){const r=this.exec.evalExpression(t.args[0],e);if(r instanceof N)return new N(r.data.map(s=>Math.floor(s)),r.typeInfo);const i=r;return new F(Math.floor(i.value),r.typeInfo)}Fma(t,e){const r=this.exec.evalExpression(t.args[0],e),i=this.exec.evalExpression(t.args[1],e),s=this.exec.evalExpression(t.args[2],e);if(r instanceof N&&i instanceof N&&s instanceof N)return r.data.length!==i.data.length||r.data.length!==s.data.length?(console.error(`Fma() expects vectors of the same length. Line ${t.line}`),null):new N(r.data.map((c,u)=>c*i.data[u]+s.data[u]),r.typeInfo);const o=r,a=i,l=s;return new F(o.value*a.value+l.value,o.typeInfo)}Fract(t,e){const r=this.exec.evalExpression(t.args[0],e);if(r instanceof N)return new N(r.data.map(s=>s-Math.floor(s)),r.typeInfo);const i=r;return new F(i.value-Math.floor(i.value),r.typeInfo)}Frexp(t,e){return console.error(`TODO: frexp. Line ${t.line}`),null}InsertBits(t,e){const r=this.exec.evalExpression(t.args[0],e),i=this.exec.evalExpression(t.args[1],e),s=this.exec.evalExpression(t.args[2],e),o=this.exec.evalExpression(t.args[3],e);if(s.typeInfo.name!=="u32"&&s.typeInfo.name!=="x32")return console.error(`InsertBits() expects an i32 offset argument. Line ${t.line}`),null;const a=s.value,l=(1<<o.value)-1<<a,c=~l;if(r instanceof N&&i instanceof N)return new N(r.data.map((f,d)=>f&c|i.data[d]<<a&l),r.typeInfo);const u=r.value,h=i.value;return new F(u&c|h<<a&l,r.typeInfo)}InverseSqrt(t,e){const r=this.exec.evalExpression(t.args[0],e);if(r instanceof N)return new N(r.data.map(s=>1/Math.sqrt(s)),r.typeInfo);const i=r;return new F(1/Math.sqrt(i.value),r.typeInfo)}Ldexp(t,e){return console.error(`TODO: ldexp. Line ${t.line}`),null}Length(t,e){const r=this.exec.evalExpression(t.args[0],e);if(r instanceof N){let s=0;return r.data.forEach(o=>{s+=o*o}),new F(Math.sqrt(s),this.getTypeInfo("f32"))}const i=r;return new F(Math.abs(i.value),r.typeInfo)}Log(t,e){const r=this.exec.evalExpression(t.args[0],e);if(r instanceof N)return new N(r.data.map(s=>Math.log(s)),r.typeInfo);const i=r;return new F(Math.log(i.value),r.typeInfo)}Log2(t,e){const r=this.exec.evalExpression(t.args[0],e);if(r instanceof N)return new N(r.data.map(s=>Math.log2(s)),r.typeInfo);const i=r;return new F(Math.log2(i.value),r.typeInfo)}Max(t,e){const r=this.exec.evalExpression(t.args[0],e),i=this.exec.evalExpression(t.args[1],e);if(r instanceof N&&i instanceof N)return new N(r.data.map((a,l)=>Math.max(a,i.data[l])),r.typeInfo);const s=r,o=i;return new F(Math.max(s.value,o.value),r.typeInfo)}Min(t,e){const r=this.exec.evalExpression(t.args[0],e),i=this.exec.evalExpression(t.args[1],e);if(r instanceof N&&i instanceof N)return new N(r.data.map((a,l)=>Math.min(a,i.data[l])),r.typeInfo);const s=r,o=i;return new F(Math.min(s.value,o.value),r.typeInfo)}Mix(t,e){const r=this.exec.evalExpression(t.args[0],e),i=this.exec.evalExpression(t.args[1],e),s=this.exec.evalExpression(t.args[2],e);if(r instanceof N&&i instanceof N&&s instanceof N)return new N(r.data.map((l,c)=>r.data[c]*(1-s.data[c])+i.data[c]*s.data[c]),r.typeInfo);const o=i,a=s;return new F(r.value*(1-a.value)+o.value*a.value,r.typeInfo)}Modf(t,e){const r=this.exec.evalExpression(t.args[0],e),i=this.exec.evalExpression(t.args[1],e);if(r instanceof N&&i instanceof N)return new N(r.data.map((o,a)=>o%i.data[a]),r.typeInfo);const s=i;return new F(r.value%s.value,r.typeInfo)}Normalize(t,e){const r=this.exec.evalExpression(t.args[0],e);if(r instanceof N){const i=this.Length(t,e).value;return new N(r.data.map(s=>s/i),r.typeInfo)}return console.error(`Normalize() expects a vector argument. Line ${t.line}`),null}Pow(t,e){const r=this.exec.evalExpression(t.args[0],e),i=this.exec.evalExpression(t.args[1],e);if(r instanceof N&&i instanceof N)return new N(r.data.map((a,l)=>Math.pow(a,i.data[l])),r.typeInfo);const s=r,o=i;return new F(Math.pow(s.value,o.value),r.typeInfo)}QuantizeToF16(t,e){const r=this.exec.evalExpression(t.args[0],e);return r instanceof N?new N(r.data.map(i=>i),r.typeInfo):new F(r.value,r.typeInfo)}Radians(t,e){const r=this.exec.evalExpression(t.args[0],e);return r instanceof N?new N(r.data.map(i=>i*Math.PI/180),r.typeInfo):new F(r.value*Math.PI/180,this.getTypeInfo("f32"))}Reflect(t,e){let r=this.exec.evalExpression(t.args[0],e),i=this.exec.evalExpression(t.args[1],e);if(r instanceof N&&i instanceof N){const s=this._dot(r.data,i.data);return new N(r.data.map((o,a)=>o-2*s*i.data[a]),r.typeInfo)}return console.error(`Reflect() expects vector arguments. Line ${t.line}`),null}Refract(t,e){let r=this.exec.evalExpression(t.args[0],e),i=this.exec.evalExpression(t.args[1],e),s=this.exec.evalExpression(t.args[2],e);if(r instanceof N&&i instanceof N&&s instanceof F){const o=this._dot(i.data,r.data);return new N(r.data.map((a,l)=>{const c=1-s.value*s.value*(1-o*o);if(c<0)return 0;const u=Math.sqrt(c);return s.value*a-(s.value*o+u)*i.data[l]}),r.typeInfo)}return console.error(`Refract() expects vector arguments and a scalar argument. Line ${t.line}`),null}ReverseBits(t,e){return console.error(`TODO: reverseBits. Line ${t.line}`),null}Round(t,e){const r=this.exec.evalExpression(t.args[0],e);if(r instanceof N)return new N(r.data.map(s=>Math.round(s)),r.typeInfo);const i=r;return new F(Math.round(i.value),r.typeInfo)}Saturate(t,e){const r=this.exec.evalExpression(t.args[0],e);if(r instanceof N)return new N(r.data.map(s=>Math.min(Math.max(s,0),1)),r.typeInfo);const i=r;return new F(Math.min(Math.max(i.value,0),1),r.typeInfo)}Sign(t,e){const r=this.exec.evalExpression(t.args[0],e);if(r instanceof N)return new N(r.data.map(s=>Math.sign(s)),r.typeInfo);const i=r;return new F(Math.sign(i.value),r.typeInfo)}Sin(t,e){const r=this.exec.evalExpression(t.args[0],e);if(r instanceof N)return new N(r.data.map(s=>Math.sin(s)),r.typeInfo);const i=r;return new F(Math.sin(i.value),r.typeInfo)}Sinh(t,e){const r=this.exec.evalExpression(t.args[0],e);if(r instanceof N)return new N(r.data.map(s=>Math.sinh(s)),r.typeInfo);const i=r;return new F(Math.sinh(i.value),r.typeInfo)}_smoothstep(t,e,r){const i=Math.min(Math.max((r-t)/(e-t),0),1);return i*i*(3-2*i)}SmoothStep(t,e){const r=this.exec.evalExpression(t.args[0],e),i=this.exec.evalExpression(t.args[1],e),s=this.exec.evalExpression(t.args[2],e);if(s instanceof N&&r instanceof N&&i instanceof N)return new N(s.data.map((c,u)=>this._smoothstep(r.data[u],i.data[u],c)),s.typeInfo);const o=r,a=i,l=s;return new F(this._smoothstep(o.value,a.value,l.value),s.typeInfo)}Sqrt(t,e){const r=this.exec.evalExpression(t.args[0],e);if(r instanceof N)return new N(r.data.map(s=>Math.sqrt(s)),r.typeInfo);const i=r;return new F(Math.sqrt(i.value),r.typeInfo)}Step(t,e){const r=this.exec.evalExpression(t.args[0],e),i=this.exec.evalExpression(t.args[1],e);if(i instanceof N&&r instanceof N)return new N(i.data.map((o,a)=>o<r.data[a]?0:1),i.typeInfo);const s=r;return new F(i.value<s.value?0:1,s.typeInfo)}Tan(t,e){const r=this.exec.evalExpression(t.args[0],e);if(r instanceof N)return new N(r.data.map(s=>Math.tan(s)),r.typeInfo);const i=r;return new F(Math.tan(i.value),r.typeInfo)}Tanh(t,e){const r=this.exec.evalExpression(t.args[0],e);if(r instanceof N)return new N(r.data.map(s=>Math.tanh(s)),r.typeInfo);const i=r;return new F(Math.tanh(i.value),r.typeInfo)}_getTransposeType(t){const e=t.getTypeName();return e==="mat2x2f"||e==="mat2x2h"?t:e==="mat2x3f"?this.getTypeInfo("mat3x2f"):e==="mat2x3h"?this.getTypeInfo("mat3x2h"):e==="mat2x4f"?this.getTypeInfo("mat4x2f"):e==="mat2x4h"?this.getTypeInfo("mat4x2h"):e==="mat3x2f"?this.getTypeInfo("mat2x3f"):e==="mat3x2h"?this.getTypeInfo("mat2x3h"):e==="mat3x3f"||e==="mat3x3h"?t:e==="mat3x4f"?this.getTypeInfo("mat4x3f"):e==="mat3x4h"?this.getTypeInfo("mat4x3h"):e==="mat4x2f"?this.getTypeInfo("mat2x4f"):e==="mat4x2h"?this.getTypeInfo("mat2x4h"):e==="mat4x3f"?this.getTypeInfo("mat3x4f"):e==="mat4x3h"?this.getTypeInfo("mat3x4h"):(e==="mat4x4f"||e==="mat4x4h"||console.error(`Invalid matrix type ${e}`),t)}Transpose(t,e){const r=this.exec.evalExpression(t.args[0],e);if(!(r instanceof pt))return console.error(`Transpose() expects a matrix argument. Line ${t.line}`),null;const i=this._getTransposeType(r.typeInfo);if(r.typeInfo.name==="mat2x2"||r.typeInfo.name==="mat2x2f"||r.typeInfo.name==="mat2x2h"){const s=r.data;return new pt([s[0],s[2],s[1],s[3]],i)}if(r.typeInfo.name==="mat2x3"||r.typeInfo.name==="mat2x3f"||r.typeInfo.name==="mat2x3h"){const s=r.data;return new pt([s[0],s[3],s[6],s[1],s[4],s[7]],i)}if(r.typeInfo.name==="mat2x4"||r.typeInfo.name==="mat2x4f"||r.typeInfo.name==="mat2x4h"){const s=r.data;return new pt([s[0],s[4],s[8],s[12],s[1],s[5],s[9],s[13]],i)}if(r.typeInfo.name==="mat3x2"||r.typeInfo.name==="mat3x2f"||r.typeInfo.name==="mat3x2h"){const s=r.data;return new pt([s[0],s[3],s[1],s[4],s[2],s[5]],i)}if(r.typeInfo.name==="mat3x3"||r.typeInfo.name==="mat3x3f"||r.typeInfo.name==="mat3x3h"){const s=r.data;return new pt([s[0],s[3],s[6],s[1],s[4],s[7],s[2],s[5],s[8]],i)}if(r.typeInfo.name==="mat3x4"||r.typeInfo.name==="mat3x4f"||r.typeInfo.name==="mat3x4h"){const s=r.data;return new pt([s[0],s[4],s[8],s[12],s[1],s[5],s[9],s[13],s[2],s[6],s[10],s[14]],i)}if(r.typeInfo.name==="mat4x2"||r.typeInfo.name==="mat4x2f"||r.typeInfo.name==="mat4x2h"){const s=r.data;return new pt([s[0],s[4],s[1],s[5],s[2],s[6]],i)}if(r.typeInfo.name==="mat4x3"||r.typeInfo.name==="mat4x3f"||r.typeInfo.name==="mat4x3h"){const s=r.data;return new pt([s[0],s[4],s[8],s[1],s[5],s[9],s[2],s[6],s[10]],i)}if(r.typeInfo.name==="mat4x4"||r.typeInfo.name==="mat4x4f"||r.typeInfo.name==="mat4x4h"){const s=r.data;return new pt([s[0],s[4],s[8],s[12],s[1],s[5],s[9],s[13],s[2],s[6],s[10],s[14],s[3],s[7],s[11],s[15]],i)}return console.error(`Invalid matrix type ${r.typeInfo.name}`),null}Trunc(t,e){const r=this.exec.evalExpression(t.args[0],e);if(r instanceof N)return new N(r.data.map(s=>Math.trunc(s)),r.typeInfo);const i=r;return new F(Math.trunc(i.value),r.typeInfo)}Dpdx(t,e){return console.error(`TODO: dpdx. Line ${t.line}`),null}DpdxCoarse(t,e){return console.error(`TODO: dpdxCoarse. Line ${t.line}`),null}DpdxFine(t,e){return console.error("TODO: dpdxFine"),null}Dpdy(t,e){return console.error("TODO: dpdy"),null}DpdyCoarse(t,e){return console.error("TODO: dpdyCoarse"),null}DpdyFine(t,e){return console.error("TODO: dpdyFine"),null}Fwidth(t,e){return console.error("TODO: fwidth"),null}FwidthCoarse(t,e){return console.error("TODO: fwidthCoarse"),null}FwidthFine(t,e){return console.error("TODO: fwidthFine"),null}TextureDimensions(t,e){const r=t.args[0],i=t.args.length>1?this.exec.evalExpression(t.args[1],e).value:0;if(r instanceof Zn){const s=r.name,o=e.getVariableValue(s);if(o instanceof Ks){if(i<0||i>=o.mipLevelCount)return console.error(`Invalid mip level for textureDimensions. Line ${t.line}`),null;const a=o.getMipLevelSize(i),l=o.dimension;return l==="1d"?new F(a[0],this.getTypeInfo("u32")):l==="3d"?new N(a,this.getTypeInfo("vec3u")):l==="2d"?new N(a.slice(0,2),this.getTypeInfo("vec2u")):(console.error(`Invalid texture dimension ${l} not found. Line ${t.line}`),null)}return console.error(`Texture ${s} not found. Line ${t.line}`),null}return console.error(`Invalid texture argument for textureDimensions. Line ${t.line}`),null}TextureGather(t,e){return console.error("TODO: textureGather"),null}TextureGatherCompare(t,e){return console.error("TODO: textureGatherCompare"),null}TextureLoad(t,e){const r=t.args[0],i=this.exec.evalExpression(t.args[1],e),s=t.args.length>2?this.exec.evalExpression(t.args[2],e).value:0;if(!(i instanceof N)||i.data.length!==2)return console.error(`Invalid UV argument for textureLoad. Line ${t.line}`),null;if(r instanceof Zn){const o=r.name,a=e.getVariableValue(o);if(a instanceof Ks){const l=Math.floor(i.data[0]),c=Math.floor(i.data[1]);if(l<0||l>=a.width||c<0||c>=a.height)return console.error(`Texture ${o} out of bounds. Line ${t.line}`),null;const u=a.getPixel(l,c,0,s);return u===null?(console.error(`Invalid texture format for textureLoad. Line ${t.line}`),null):new N(u,this.getTypeInfo("vec4f"))}return console.error(`Texture ${o} not found. Line ${t.line}`),null}return console.error(`Invalid texture argument for textureLoad. Line ${t.line}`),null}TextureNumLayers(t,e){const r=t.args[0];if(r instanceof Zn){const i=r.name,s=e.getVariableValue(i);return s instanceof Ks?new F(s.depthOrArrayLayers,this.getTypeInfo("u32")):(console.error(`Texture ${i} not found. Line ${t.line}`),null)}return console.error(`Invalid texture argument for textureNumLayers. Line ${t.line}`),null}TextureNumLevels(t,e){const r=t.args[0];if(r instanceof Zn){const i=r.name,s=e.getVariableValue(i);return s instanceof Ks?new F(s.mipLevelCount,this.getTypeInfo("u32")):(console.error(`Texture ${i} not found. Line ${t.line}`),null)}return console.error(`Invalid texture argument for textureNumLevels. Line ${t.line}`),null}TextureNumSamples(t,e){const r=t.args[0];if(r instanceof Zn){const i=r.name,s=e.getVariableValue(i);return s instanceof Ks?new F(s.sampleCount,this.getTypeInfo("u32")):(console.error(`Texture ${i} not found. Line ${t.line}`),null)}return console.error(`Invalid texture argument for textureNumSamples. Line ${t.line}`),null}TextureSample(t,e){return console.error("TODO: textureSample"),null}TextureSampleBias(t,e){return console.error("TODO: textureSampleBias"),null}TextureSampleCompare(t,e){return console.error("TODO: textureSampleCompare"),null}TextureSampleCompareLevel(t,e){return console.error("TODO: textureSampleCompareLevel"),null}TextureSampleGrad(t,e){return console.error("TODO: textureSampleGrad"),null}TextureSampleLevel(t,e){return console.error("TODO: textureSampleLevel"),null}TextureSampleBaseClampToEdge(t,e){return console.error("TODO: textureSampleBaseClampToEdge"),null}TextureStore(t,e){const r=t.args[0],i=this.exec.evalExpression(t.args[1],e),s=t.args.length===4?this.exec.evalExpression(t.args[2],e).value:0,o=t.args.length===4?this.exec.evalExpression(t.args[3],e).data:this.exec.evalExpression(t.args[2],e).data;if(o.length!==4)return console.error(`Invalid value argument for textureStore. Line ${t.line}`),null;if(!(i instanceof N)||i.data.length!==2)return console.error(`Invalid UV argument for textureStore. Line ${t.line}`),null;if(r instanceof Zn){const a=r.name,l=e.getVariableValue(a);if(l instanceof Ks){const c=l.getMipLevelSize(0),u=Math.floor(i.data[0]),h=Math.floor(i.data[1]);return u<0||u>=c[0]||h<0||h>=c[1]?(console.error(`Texture ${a} out of bounds. Line ${t.line}`),null):(l.setPixel(u,h,0,s,Array.from(o)),null)}return console.error(`Texture ${a} not found. Line ${t.line}`),null}return console.error(`Invalid texture argument for textureStore. Line ${t.line}`),null}AtomicLoad(t,e){let r=t.args[0];r instanceof Pe&&(r=r.right);const i=this.exec.getVariableName(r,e);return e.getVariable(i).value.getSubData(this.exec,r.postfix,e)}AtomicStore(t,e){let r=t.args[0];r instanceof Pe&&(r=r.right);const i=this.exec.getVariableName(r,e),s=e.getVariable(i);let o=t.args[1];const a=this.exec.evalExpression(o,e),l=s.value.getSubData(this.exec,r.postfix,e);return l instanceof F&&a instanceof F&&(l.value=a.value),s.value instanceof _e&&s.value.setDataValue(this.exec,l,r.postfix,e),null}AtomicAdd(t,e){let r=t.args[0];r instanceof Pe&&(r=r.right);const i=this.exec.getVariableName(r,e),s=e.getVariable(i);let o=t.args[1];const a=this.exec.evalExpression(o,e),l=s.value.getSubData(this.exec,r.postfix,e),c=new F(l.value,l.typeInfo);return l instanceof F&&a instanceof F&&(l.value+=a.value),s.value instanceof _e&&s.value.setDataValue(this.exec,l,r.postfix,e),c}AtomicSub(t,e){let r=t.args[0];r instanceof Pe&&(r=r.right);const i=this.exec.getVariableName(r,e),s=e.getVariable(i);let o=t.args[1];const a=this.exec.evalExpression(o,e),l=s.value.getSubData(this.exec,r.postfix,e),c=new F(l.value,l.typeInfo);return l instanceof F&&a instanceof F&&(l.value-=a.value),s.value instanceof _e&&s.value.setDataValue(this.exec,l,r.postfix,e),c}AtomicMax(t,e){let r=t.args[0];r instanceof Pe&&(r=r.right);const i=this.exec.getVariableName(r,e),s=e.getVariable(i);let o=t.args[1];const a=this.exec.evalExpression(o,e),l=s.value.getSubData(this.exec,r.postfix,e),c=new F(l.value,l.typeInfo);return l instanceof F&&a instanceof F&&(l.value=Math.max(l.value,a.value)),s.value instanceof _e&&s.value.setDataValue(this.exec,l,r.postfix,e),c}AtomicMin(t,e){let r=t.args[0];r instanceof Pe&&(r=r.right);const i=this.exec.getVariableName(r,e),s=e.getVariable(i);let o=t.args[1];const a=this.exec.evalExpression(o,e),l=s.value.getSubData(this.exec,r.postfix,e),c=new F(l.value,l.typeInfo);return l instanceof F&&a instanceof F&&(l.value=Math.min(l.value,a.value)),s.value instanceof _e&&s.value.setDataValue(this.exec,l,r.postfix,e),c}AtomicAnd(t,e){let r=t.args[0];r instanceof Pe&&(r=r.right);const i=this.exec.getVariableName(r,e),s=e.getVariable(i);let o=t.args[1];const a=this.exec.evalExpression(o,e),l=s.value.getSubData(this.exec,r.postfix,e),c=new F(l.value,l.typeInfo);return l instanceof F&&a instanceof F&&(l.value=l.value&a.value),s.value instanceof _e&&s.value.setDataValue(this.exec,l,r.postfix,e),c}AtomicOr(t,e){let r=t.args[0];r instanceof Pe&&(r=r.right);const i=this.exec.getVariableName(r,e),s=e.getVariable(i);let o=t.args[1];const a=this.exec.evalExpression(o,e),l=s.value.getSubData(this.exec,r.postfix,e),c=new F(l.value,l.typeInfo);return l instanceof F&&a instanceof F&&(l.value=l.value|a.value),s.value instanceof _e&&s.value.setDataValue(this.exec,l,r.postfix,e),c}AtomicXor(t,e){let r=t.args[0];r instanceof Pe&&(r=r.right);const i=this.exec.getVariableName(r,e),s=e.getVariable(i);let o=t.args[1];const a=this.exec.evalExpression(o,e),l=s.value.getSubData(this.exec,r.postfix,e),c=new F(l.value,l.typeInfo);return l instanceof F&&a instanceof F&&(l.value=l.value^a.value),s.value instanceof _e&&s.value.setDataValue(this.exec,l,r.postfix,e),c}AtomicExchange(t,e){let r=t.args[0];r instanceof Pe&&(r=r.right);const i=this.exec.getVariableName(r,e),s=e.getVariable(i);let o=t.args[1];const a=this.exec.evalExpression(o,e),l=s.value.getSubData(this.exec,r.postfix,e),c=new F(l.value,l.typeInfo);return l instanceof F&&a instanceof F&&(l.value=a.value),s.value instanceof _e&&s.value.setDataValue(this.exec,l,r.postfix,e),c}AtomicCompareExchangeWeak(t,e){return console.error("TODO: atomicCompareExchangeWeak"),null}Pack4x8snorm(t,e){return console.error("TODO: pack4x8snorm"),null}Pack4x8unorm(t,e){return console.error("TODO: pack4x8unorm"),null}Pack4xI8(t,e){return console.error("TODO: pack4xI8"),null}Pack4xU8(t,e){return console.error("TODO: pack4xU8"),null}Pack4x8Clamp(t,e){return console.error("TODO: pack4x8Clamp"),null}Pack4xU8Clamp(t,e){return console.error("TODO: pack4xU8Clamp"),null}Pack2x16snorm(t,e){return console.error("TODO: pack2x16snorm"),null}Pack2x16unorm(t,e){return console.error("TODO: pack2x16unorm"),null}Pack2x16float(t,e){return console.error("TODO: pack2x16float"),null}Unpack4x8snorm(t,e){return console.error("TODO: unpack4x8snorm"),null}Unpack4x8unorm(t,e){return console.error("TODO: unpack4x8unorm"),null}Unpack4xI8(t,e){return console.error("TODO: unpack4xI8"),null}Unpack4xU8(t,e){return console.error("TODO: unpack4xU8"),null}Unpack2x16snorm(t,e){return console.error("TODO: unpack2x16snorm"),null}Unpack2x16unorm(t,e){return console.error("TODO: unpack2x16unorm"),null}Unpack2x16float(t,e){return console.error("TODO: unpack2x16float"),null}StorageBarrier(t,e){return null}TextureBarrier(t,e){return null}WorkgroupBarrier(t,e){return null}WorkgroupUniformLoad(t,e){return null}SubgroupAdd(t,e){return console.error("TODO: subgroupAdd"),null}SubgroupExclusiveAdd(t,e){return console.error("TODO: subgroupExclusiveAdd"),null}SubgroupInclusiveAdd(t,e){return console.error("TODO: subgroupInclusiveAdd"),null}SubgroupAll(t,e){return console.error("TODO: subgroupAll"),null}SubgroupAnd(t,e){return console.error("TODO: subgroupAnd"),null}SubgroupAny(t,e){return console.error("TODO: subgroupAny"),null}SubgroupBallot(t,e){return console.error("TODO: subgroupBallot"),null}SubgroupBroadcast(t,e){return console.error("TODO: subgroupBroadcast"),null}SubgroupBroadcastFirst(t,e){return console.error("TODO: subgroupBroadcastFirst"),null}SubgroupElect(t,e){return console.error("TODO: subgroupElect"),null}SubgroupMax(t,e){return console.error("TODO: subgroupMax"),null}SubgroupMin(t,e){return console.error("TODO: subgroupMin"),null}SubgroupMul(t,e){return console.error("TODO: subgroupMul"),null}SubgroupExclusiveMul(t,e){return console.error("TODO: subgroupExclusiveMul"),null}SubgroupInclusiveMul(t,e){return console.error("TODO: subgroupInclusiveMul"),null}SubgroupOr(t,e){return console.error("TODO: subgroupOr"),null}SubgroupShuffle(t,e){return console.error("TODO: subgroupShuffle"),null}SubgroupShuffleDown(t,e){return console.error("TODO: subgroupShuffleDown"),null}SubgroupShuffleUp(t,e){return console.error("TODO: subgroupShuffleUp"),null}SubgroupShuffleXor(t,e){return console.error("TODO: subgroupShuffleXor"),null}SubgroupXor(t,e){return console.error("TODO: subgroupXor"),null}QuadBroadcast(t,e){return console.error("TODO: quadBroadcast"),null}QuadSwapDiagonal(t,e){return console.error("TODO: quadSwapDiagonal"),null}QuadSwapX(t,e){return console.error("TODO: quadSwapX"),null}QuadSwapY(t,e){return console.error("TODO: quadSwapY"),null}};const df={vec2:2,vec2f:2,vec2i:2,vec2u:2,vec2b:2,vec2h:2,vec3:3,vec3f:3,vec3i:3,vec3u:3,vec3b:3,vec3h:3,vec4:4,vec4f:4,vec4i:4,vec4u:4,vec4b:4,vec4h:4},Sn={mat2x2:[2,2,4],mat2x2f:[2,2,4],mat2x2h:[2,2,4],mat2x3:[2,3,6],mat2x3f:[2,3,6],mat2x3h:[2,3,6],mat2x4:[2,4,8],mat2x4f:[2,4,8],mat2x4h:[2,4,8],mat3x2:[3,2,6],mat3x2f:[3,2,6],mat3x2h:[3,2,6],mat3x3:[3,3,9],mat3x3f:[3,3,9],mat3x3h:[3,3,9],mat3x4:[3,4,12],mat3x4f:[3,4,12],mat3x4h:[3,4,12],mat4x2:[4,2,8],mat4x2f:[4,2,8],mat4x2h:[4,2,8],mat4x3:[4,3,12],mat4x3f:[4,3,12],mat4x3h:[4,3,12],mat4x4:[4,4,16],mat4x4f:[4,4,16],mat4x4h:[4,4,16]};let su=class pr extends tI{constructor(t,e){var r;super(),this.ast=t??[],this.reflection=new xi,this.reflection.updateAST(this.ast),this.context=(r=e?.clone())!==null&&r!==void 0?r:new QP,this.builtins=new eI(this),this.typeInfo={bool:this.getTypeInfo(Z.bool),i32:this.getTypeInfo(Z.i32),u32:this.getTypeInfo(Z.u32),f32:this.getTypeInfo(Z.f32),f16:this.getTypeInfo(Z.f16),vec2f:this.getTypeInfo(W.vec2f),vec2u:this.getTypeInfo(W.vec2u),vec2i:this.getTypeInfo(W.vec2i),vec2h:this.getTypeInfo(W.vec2h),vec3f:this.getTypeInfo(W.vec3f),vec3u:this.getTypeInfo(W.vec3u),vec3i:this.getTypeInfo(W.vec3i),vec3h:this.getTypeInfo(W.vec3h),vec4f:this.getTypeInfo(W.vec4f),vec4u:this.getTypeInfo(W.vec4u),vec4i:this.getTypeInfo(W.vec4i),vec4h:this.getTypeInfo(W.vec4h),mat2x2f:this.getTypeInfo(W.mat2x2f),mat2x3f:this.getTypeInfo(W.mat2x3f),mat2x4f:this.getTypeInfo(W.mat2x4f),mat3x2f:this.getTypeInfo(W.mat3x2f),mat3x3f:this.getTypeInfo(W.mat3x3f),mat3x4f:this.getTypeInfo(W.mat3x4f),mat4x2f:this.getTypeInfo(W.mat4x2f),mat4x3f:this.getTypeInfo(W.mat4x3f),mat4x4f:this.getTypeInfo(W.mat4x4f)}}getVariableValue(t){var e,r;const i=(r=(e=this.context.getVariable(t))===null||e===void 0?void 0:e.value)!==null&&r!==void 0?r:null;if(i===null)return null;if(i instanceof F)return i.value;if(i instanceof N||i instanceof pt)return Array.from(i.data);if(i instanceof _e&&i.typeInfo instanceof ws){if(i.typeInfo.format.name==="u32")return Array.from(new Uint32Array(i.buffer,i.offset,i.typeInfo.count));if(i.typeInfo.format.name==="i32")return Array.from(new Int32Array(i.buffer,i.offset,i.typeInfo.count));if(i.typeInfo.format.name==="f32")return Array.from(new Float32Array(i.buffer,i.offset,i.typeInfo.count))}return console.error(`Unsupported return variable type ${i.typeInfo.name}`),null}execute(t){(t=t??{}).constants&&this._setOverrides(t.constants,this.context),this._execStatements(this.ast,this.context)}dispatchWorkgroups(t,e,r,i){const s=this.context.clone();(i=i??{}).constants&&this._setOverrides(i.constants,s),this._execStatements(this.ast,s);const o=s.getFunction(t);if(!o)return void console.error(`Function ${t} not found`);if(typeof e=="number")e=[e,1,1];else{if(e.length===0)return void console.error("Invalid dispatch count");e.length===1?e=[e[0],1,1]:e.length===2?e=[e[0],e[1],1]:e.length>3&&(e=[e[0],e[1],e[2]])}const a=e[0],l=e[1],c=e[2],u=this.getTypeInfo("vec3u");s.setVariable("@num_workgroups",new N(e,u));for(const h in r)for(const f in r[h]){const d=r[h][f];s.variables.forEach(p=>{var _;const v=p.node;if(v?.attributes){let E=null,m=null;for(const g of v.attributes)g.name==="binding"?E=g.value:g.name==="group"&&(m=g.value);if(f==E&&h==m)if(d.texture!==void 0&&d.descriptor!==void 0){const g=new Ks(d.texture,this.getTypeInfo(v.type),d.descriptor,(_=d.texture.view)!==null&&_!==void 0?_:null);p.value=g}else d.uniform!==void 0?p.value=new _e(d.uniform,this.getTypeInfo(v.type)):p.value=new _e(d,this.getTypeInfo(v.type))}})}for(let h=0;h<c;++h)for(let f=0;f<l;++f)for(let d=0;d<a;++d)s.setVariable("@workgroup_id",new N([d,f,h],this.getTypeInfo("vec3u"))),this._dispatchWorkgroup(o,[d,f,h],s)}execStatement(t,e){if(t instanceof rb)return this.evalExpression(t.value,e);if(t instanceof sb){if(t.condition){const r=this.evalExpression(t.condition,e);if(!(r instanceof F))throw new Error("Invalid break-if condition");if(!r.value)return null}return pr._breakObj}if(t instanceof ob)return pr._continueObj;if(t instanceof bl)this._let(t,e);else if(t instanceof Wi)this._var(t,e);else if(t instanceof eu)this._const(t,e);else if(t instanceof Il)this._function(t,e);else{if(t instanceof nb)return this._if(t,e);if(t instanceof eb)return this._switch(t,e);if(t instanceof Z0)return this._for(t,e);if(t instanceof K0)return this._while(t,e);if(t instanceof tb)return this._loop(t,e);if(t instanceof gd){const r=e.clone();return r.currentFunctionName=e.currentFunctionName,this._execStatements(t.body,r)}if(t instanceof Q0)this._assign(t,e);else if(t instanceof J0)this._increment(t,e);else{if(t instanceof zi)return null;if(t instanceof Mp){const r=t.name;e.getVariable(r)===null&&e.setVariable(r,new F(0,this.getTypeInfo("u32")))}else if(t instanceof Rp)this._call(t,e);else{if(t instanceof ib||t instanceof Np)return null;console.error("Invalid statement type.",t,`Line ${t.line}`)}}}return null}evalExpression(t,e){return t instanceof Hr?this._evalBinaryOp(t,e):t instanceof Be?this._evalLiteral(t,e):t instanceof Zn?this._evalVariable(t,e):t instanceof Op?this._evalCall(t,e):t instanceof yi?this._evalCreate(t,e):t instanceof ab?this._evalConst(t,e):t instanceof lb?this._evalBitcast(t,e):t instanceof Pe?this._evalUnaryOp(t,e):(console.error("Invalid expression type",t,`Line ${t.line}`),null)}getTypeInfo(t){var e;if(t instanceof Z){const i=this.reflection.getTypeInfo(t);if(i!==null)return i}let r=(e=this.typeInfo[t])!==null&&e!==void 0?e:null;return r!==null||(r=this.reflection.getTypeInfoByName(t)),r}_setOverrides(t,e){for(const r in t){const i=t[r],s=this.reflection.getOverrideInfo(r);s!==null?(s.type===null&&(s.type=this.getTypeInfo("u32")),s.type.name==="u32"||s.type.name==="i32"||s.type.name==="f32"||s.type.name==="f16"?e.setVariable(r,new F(i,s.type)):s.type.name==="bool"?e.setVariable(r,new F(i?1:0,s.type)):s.type.name==="vec2"||s.type.name==="vec3"||s.type.name==="vec4"||s.type.name==="vec2f"||s.type.name==="vec3f"||s.type.name==="vec4f"||s.type.name==="vec2i"||s.type.name==="vec3i"||s.type.name==="vec4i"||s.type.name==="vec2u"||s.type.name==="vec3u"||s.type.name==="vec4u"||s.type.name==="vec2h"||s.type.name==="vec3h"||s.type.name==="vec4h"?e.setVariable(r,new N(i,s.type)):console.error(`Invalid constant type for ${r}`)):console.error(`Override ${r} does not exist in the shader.`)}}_dispatchWorkgroup(t,e,r){const i=[1,1,1];for(const u of t.node.attributes)if(u.name==="workgroup_size"){if(u.value.length>0){const h=r.getVariableValue(u.value[0]);i[0]=h instanceof F?h.value:parseInt(u.value[0])}if(u.value.length>1){const h=r.getVariableValue(u.value[1]);i[1]=h instanceof F?h.value:parseInt(u.value[1])}if(u.value.length>2){const h=r.getVariableValue(u.value[2]);i[2]=h instanceof F?h.value:parseInt(u.value[2])}}const s=this.getTypeInfo("vec3u"),o=this.getTypeInfo("u32");r.setVariable("@workgroup_size",new N(i,s));const a=i[0],l=i[1],c=i[2];for(let u=0,h=0;u<c;++u)for(let f=0;f<l;++f)for(let d=0;d<a;++d,++h){const p=[d,f,u],_=[d+e[0]*i[0],f+e[1]*i[1],u+e[2]*i[2]];r.setVariable("@local_invocation_id",new N(p,s)),r.setVariable("@global_invocation_id",new N(_,s)),r.setVariable("@local_invocation_index",new F(h,o)),this._dispatchExec(t,r)}}_dispatchExec(t,e){for(const r of t.node.args)for(const i of r.attributes)if(i.name==="builtin"){const s=`@${i.value}`,o=e.getVariable(s);o!==void 0&&e.variables.set(r.name,o)}this._execStatements(t.node.body,e)}getVariableName(t,e){for(;t instanceof Pe;)t=t.right;return t instanceof Zn?t.name:(console.error("Unknown variable type",t,"Line",t.line),null)}_execStatements(t,e){for(const r of t){if(r instanceof Array){const s=e.clone(),o=this._execStatements(r,s);if(o)return o;continue}const i=this.execStatement(r,e);if(i)return i}return null}_call(t,e){const r=e.clone();r.currentFunctionName=t.name;const i=e.getFunction(t.name);if(i){for(let s=0;s<i.node.args.length;++s){const o=i.node.args[s],a=this.evalExpression(t.args[s],r);r.setVariable(o.name,a,o)}this._execStatements(i.node.body,r)}else t.isBuiltin?this._callBuiltinFunction(t,r):this.getTypeInfo(t.name)&&this._evalCreate(t,e)}_increment(t,e){const r=this.getVariableName(t.variable,e),i=e.getVariable(r);i?t.operator==="++"?i.value instanceof F?i.value.value++:console.error(`Variable ${r} is not a scalar. Line ${t.line}`):t.operator==="--"?i.value instanceof F?i.value.value--:console.error(`Variable ${r} is not a scalar. Line ${t.line}`):console.error(`Unknown increment operator ${t.operator}. Line ${t.line}`):console.error(`Variable ${r} not found. Line ${t.line}`)}_getVariableData(t,e){if(t instanceof Zn){const r=this.getVariableName(t,e),i=e.getVariable(r);return i===null?(console.error(`Variable ${r} not found. Line ${t.line}`),null):i.value.getSubData(this,t.postfix,e)}if(t instanceof Pe){if(t.operator==="*"){const r=this._getVariableData(t.right,e);return r instanceof Wo?r.reference.getSubData(this,t.postfix,e):(console.error(`Variable ${t.right} is not a pointer. Line ${t.line}`),null)}if(t.operator==="&"){const r=this._getVariableData(t.right,e);return new Wo(r)}}return null}_assign(t,e){let r=null,i="<var>",s=null;if(t.variable instanceof Pe){const l=this._getVariableData(t.variable,e),c=this.evalExpression(t.value,e),u=t.operator;if(u==="="){if(l instanceof F||l instanceof N||l instanceof pt){if(c instanceof F||c instanceof N||c instanceof pt&&l.data.length===c.data.length)return void l.data.set(c.data);console.error(`Invalid assignment. Line ${t.line}`)}else if(l instanceof _e&&c instanceof _e&&l.buffer.byteLength-l.offset>=c.buffer.byteLength-c.offset)return void(l.buffer.byteLength%4==0?new Uint32Array(l.buffer,l.offset,l.typeInfo.size/4).set(new Uint32Array(c.buffer,c.offset,c.typeInfo.size/4)):new Uint8Array(l.buffer,l.offset,l.typeInfo.size).set(new Uint8Array(c.buffer,c.offset,c.typeInfo.size)));return console.error(`Invalid assignment. Line ${t.line}`),null}if(u==="+=")return l instanceof F||l instanceof N||l instanceof pt?c instanceof F||c instanceof N||c instanceof pt?void l.data.set(c.data.map((h,f)=>l.data[f]+h)):void console.error(`Invalid assignment . Line ${t.line}`):void console.error(`Invalid assignment. Line ${t.line}`);if(u==="-=")return(l instanceof F||l instanceof N||l instanceof pt)&&(c instanceof F||c instanceof N||c instanceof pt)?void l.data.set(c.data.map((h,f)=>l.data[f]-h)):void console.error(`Invalid assignment. Line ${t.line}`)}if(t.variable instanceof Pe){if(t.variable.operator==="*"){i=this.getVariableName(t.variable.right,e);const l=e.getVariable(i);if(!(l&&l.value instanceof Wo))return void console.error(`Variable ${i} is not a pointer. Line ${t.line}`);r=l.value.reference;let c=t.variable.postfix;if(!c){let u=t.variable.right;for(;u instanceof Pe;){if(u.postfix){c=u.postfix;break}u=u.right}}c&&(r=r.getSubData(this,c,e))}}else{s=t.variable.postfix,i=this.getVariableName(t.variable,e);const l=e.getVariable(i);if(l===null)return void console.error(`Variable ${i} not found. Line ${t.line}`);r=l.value}if(r instanceof Wo&&(r=r.reference),r===null)return void console.error(`Variable ${i} not found. Line ${t.line}`);const o=this.evalExpression(t.value,e),a=t.operator;if(a==="=")if(r instanceof _e)r.setDataValue(this,o,s,e);else if(s){if(!(r instanceof N||r instanceof pt))return void console.error(`Variable ${i} is not a vector or matrix. Line ${t.line}`);if(s instanceof ca){const l=this.evalExpression(s.index,e).value;if(r instanceof N){if(!(o instanceof F))return void console.error(`Invalid assignment to ${i}. Line ${t.line}`);r.data[l]=o.value}else{if(!(r instanceof pt))return void console.error(`Invalid assignment to ${i}. Line ${t.line}`);{const c=this.evalExpression(s.index,e).value;if(c<0)return void console.error(`Invalid assignment to ${i}. Line ${t.line}`);if(!(o instanceof N))return void console.error(`Invalid assignment to ${i}. Line ${t.line}`);{const u=r.typeInfo.getTypeName();if(u==="mat2x2"||u==="mat2x2f"||u==="mat2x2h"){if(!(c<2&&o.data.length===2))return void console.error(`Invalid assignment to ${i}. Line ${t.line}`);r.data[2*c]=o.data[0],r.data[2*c+1]=o.data[1]}else if(u==="mat2x3"||u==="mat2x3f"||u==="mat2x3h"){if(!(c<2&&o.data.length===3))return void console.error(`Invalid assignment to ${i}. Line ${t.line}`);r.data[3*c]=o.data[0],r.data[3*c+1]=o.data[1],r.data[3*c+2]=o.data[2]}else if(u==="mat2x4"||u==="mat2x4f"||u==="mat2x4h"){if(!(c<2&&o.data.length===4))return void console.error(`Invalid assignment to ${i}. Line ${t.line}`);r.data[4*c]=o.data[0],r.data[4*c+1]=o.data[1],r.data[4*c+2]=o.data[2],r.data[4*c+3]=o.data[3]}else if(u==="mat3x2"||u==="mat3x2f"||u==="mat3x2h"){if(!(c<3&&o.data.length===2))return void console.error(`Invalid assignment to ${i}. Line ${t.line}`);r.data[2*c]=o.data[0],r.data[2*c+1]=o.data[1]}else if(u==="mat3x3"||u==="mat3x3f"||u==="mat3x3h"){if(!(c<3&&o.data.length===3))return void console.error(`Invalid assignment to ${i}. Line ${t.line}`);r.data[3*c]=o.data[0],r.data[3*c+1]=o.data[1],r.data[3*c+2]=o.data[2]}else if(u==="mat3x4"||u==="mat3x4f"||u==="mat3x4h"){if(!(c<3&&o.data.length===4))return void console.error(`Invalid assignment to ${i}. Line ${t.line}`);r.data[4*c]=o.data[0],r.data[4*c+1]=o.data[1],r.data[4*c+2]=o.data[2],r.data[4*c+3]=o.data[3]}else if(u==="mat4x2"||u==="mat4x2f"||u==="mat4x2h"){if(!(c<4&&o.data.length===2))return void console.error(`Invalid assignment to ${i}. Line ${t.line}`);r.data[2*c]=o.data[0],r.data[2*c+1]=o.data[1]}else if(u==="mat4x3"||u==="mat4x3f"||u==="mat4x3h"){if(!(c<4&&o.data.length===3))return void console.error(`Invalid assignment to ${i}. Line ${t.line}`);r.data[3*c]=o.data[0],r.data[3*c+1]=o.data[1],r.data[3*c+2]=o.data[2]}else{if(u!=="mat4x4"&&u!=="mat4x4f"&&u!=="mat4x4h")return void console.error(`Invalid assignment to ${i}. Line ${t.line}`);if(!(c<4&&o.data.length===4))return void console.error(`Invalid assignment to ${i}. Line ${t.line}`);r.data[4*c]=o.data[0],r.data[4*c+1]=o.data[1],r.data[4*c+2]=o.data[2],r.data[4*c+3]=o.data[3]}}}}}else if(s instanceof ao){const l=s.value;if(!(r instanceof N))return void console.error(`Invalid assignment to ${l}. Variable ${i} is not a vector. Line ${t.line}`);if(o instanceof F){if(l.length>1)return void console.error(`Invalid assignment to ${l} for variable ${i}. Line ${t.line}`);if(l==="x")r.data[0]=o.value;else if(l==="y"){if(r.data.length<2)return void console.error(`Invalid assignment to ${l} for variable ${i}. Line ${t.line}`);r.data[1]=o.value}else if(l==="z"){if(r.data.length<3)return void console.error(`Invalid assignment to ${l} for variable ${i}. Line ${t.line}`);r.data[2]=o.value}else if(l==="w"){if(r.data.length<4)return void console.error(`Invalid assignment to ${l} for variable ${i}. Line ${t.line}`);r.data[3]=o.value}}else{if(!(o instanceof N))return void console.error(`Invalid assignment to ${i}. Line ${t.line}`);if(l.length!==o.data.length)return void console.error(`Invalid assignment to ${l} for variable ${i}. Line ${t.line}`);for(let c=0;c<l.length;++c){const u=l[c];if(u==="x"||u==="r")r.data[0]=o.data[c];else if(u==="y"||u==="g"){if(o.data.length<2)return void console.error(`Invalid assignment to ${u} for variable ${i}. Line ${t.line}`);r.data[1]=o.data[c]}else if(u==="z"||u==="b"){if(o.data.length<3)return void console.error(`Invalid assignment to ${u} for variable ${i}. Line ${t.line}`);r.data[2]=o.data[c]}else{if(u!=="w"&&u!=="a")return void console.error(`Invalid assignment to ${u} for variable ${i}. Line ${t.line}`);if(o.data.length<4)return void console.error(`Invalid assignment to ${u} for variable ${i}. Line ${t.line}`);r.data[3]=o.data[c]}}}}}else r instanceof F&&o instanceof F?r.value=o.value:r instanceof N&&o instanceof N||r instanceof pt&&o instanceof pt?r.data.set(o.data):console.error(`Invalid assignment to ${i}. Line ${t.line}`);else{const l=r.getSubData(this,s,e);if(l instanceof N&&o instanceof F){const c=l.data,u=o.value;if(a==="+=")for(let h=0;h<c.length;++h)c[h]+=u;else if(a==="-=")for(let h=0;h<c.length;++h)c[h]-=u;else if(a==="*=")for(let h=0;h<c.length;++h)c[h]*=u;else if(a==="/=")for(let h=0;h<c.length;++h)c[h]/=u;else if(a==="%=")for(let h=0;h<c.length;++h)c[h]%=u;else if(a==="&=")for(let h=0;h<c.length;++h)c[h]&=u;else if(a==="|=")for(let h=0;h<c.length;++h)c[h]|=u;else if(a==="^=")for(let h=0;h<c.length;++h)c[h]^=u;else if(a==="<<=")for(let h=0;h<c.length;++h)c[h]<<=u;else if(a===">>=")for(let h=0;h<c.length;++h)c[h]>>=u;else console.error(`Invalid operator ${a}. Line ${t.line}`)}else if(l instanceof N&&o instanceof N){const c=l.data,u=o.data;if(c.length!==u.length)return void console.error(`Vector length mismatch. Line ${t.line}`);if(a==="+=")for(let h=0;h<c.length;++h)c[h]+=u[h];else if(a==="-=")for(let h=0;h<c.length;++h)c[h]-=u[h];else if(a==="*=")for(let h=0;h<c.length;++h)c[h]*=u[h];else if(a==="/=")for(let h=0;h<c.length;++h)c[h]/=u[h];else if(a==="%=")for(let h=0;h<c.length;++h)c[h]%=u[h];else if(a==="&=")for(let h=0;h<c.length;++h)c[h]&=u[h];else if(a==="|=")for(let h=0;h<c.length;++h)c[h]|=u[h];else if(a==="^=")for(let h=0;h<c.length;++h)c[h]^=u[h];else if(a==="<<=")for(let h=0;h<c.length;++h)c[h]<<=u[h];else if(a===">>=")for(let h=0;h<c.length;++h)c[h]>>=u[h];else console.error(`Invalid operator ${a}. Line ${t.line}`)}else{if(!(l instanceof F&&o instanceof F))return void console.error(`Invalid type for ${t.operator} operator. Line ${t.line}`);a==="+="?l.value+=o.value:a==="-="?l.value-=o.value:a==="*="?l.value*=o.value:a==="/="?l.value/=o.value:a==="%="?l.value%=o.value:a==="&="?l.value&=o.value:a==="|="?l.value|=o.value:a==="^="?l.value^=o.value:a==="<<="?l.value<<=o.value:a===">>="?l.value>>=o.value:console.error(`Invalid operator ${a}. Line ${t.line}`)}r instanceof _e&&r.setDataValue(this,l,s,e)}}_function(t,e){const r=new kp(t);e.functions.set(t.name,r)}_const(t,e){let r=null;t.value!==null&&(r=this.evalExpression(t.value,e)),e.createVariable(t.name,r,t)}_let(t,e){let r=null;if(t.value!==null){if(r=this.evalExpression(t.value,e),r===null)return void console.error(`Invalid value for variable ${t.name}. Line ${t.line}`);t.value instanceof Pe||(r=r.clone())}else{const i=t.type.name;if(i==="f32"||i==="i32"||i==="u32"||i==="bool"||i==="f16"||i==="vec2"||i==="vec3"||i==="vec4"||i==="vec2f"||i==="vec3f"||i==="vec4f"||i==="vec2i"||i==="vec3i"||i==="vec4i"||i==="vec2u"||i==="vec3u"||i==="vec4u"||i==="vec2h"||i==="vec3h"||i==="vec4h"||i==="vec2b"||i==="vec3b"||i==="vec4b"||i==="mat2x2"||i==="mat2x3"||i==="mat2x4"||i==="mat3x2"||i==="mat3x3"||i==="mat3x4"||i==="mat4x2"||i==="mat4x3"||i==="mat4x4"||i==="mat2x2f"||i==="mat2x3f"||i==="mat2x4f"||i==="mat3x2f"||i==="mat3x3f"||i==="mat3x4f"||i==="mat4x2f"||i==="mat4x3f"||i==="mat4x4f"||i==="mat2x2h"||i==="mat2x3h"||i==="mat2x4h"||i==="mat3x2h"||i==="mat3x3h"||i==="mat3x4h"||i==="mat4x2h"||i==="mat4x3h"||i==="mat4x4h"||i==="array"){const s=new yi(t.type,[]);r=this._evalCreate(s,e)}}e.createVariable(t.name,r,t)}_var(t,e){let r=null;if(t.value!==null){if(r=this.evalExpression(t.value,e),r===null)return void console.error(`Invalid value for variable ${t.name}. Line ${t.line}`);t.value instanceof Pe||(r=r.clone())}else{if(t.type===null)return void console.error(`Variable ${t.name} has no type. Line ${t.line}`);const i=t.type.name;if(i==="f32"||i==="i32"||i==="u32"||i==="bool"||i==="f16"||i==="vec2"||i==="vec3"||i==="vec4"||i==="vec2f"||i==="vec3f"||i==="vec4f"||i==="vec2i"||i==="vec3i"||i==="vec4i"||i==="vec2u"||i==="vec3u"||i==="vec4u"||i==="vec2h"||i==="vec3h"||i==="vec4h"||i==="vec2b"||i==="vec3b"||i==="vec4b"||i==="mat2x2"||i==="mat2x3"||i==="mat2x4"||i==="mat3x2"||i==="mat3x3"||i==="mat3x4"||i==="mat4x2"||i==="mat4x3"||i==="mat4x4"||i==="mat2x2f"||i==="mat2x3f"||i==="mat2x4f"||i==="mat3x2f"||i==="mat3x3f"||i==="mat3x4f"||i==="mat4x2f"||i==="mat4x3f"||i==="mat4x4f"||i==="mat2x2h"||i==="mat2x3h"||i==="mat2x4h"||i==="mat3x2h"||i==="mat3x3h"||i==="mat3x4h"||i==="mat4x2h"||i==="mat4x3h"||i==="mat4x4h"||t.type instanceof xl||t.type instanceof zi||t.type instanceof W){const s=new yi(t.type,[]);r=this._evalCreate(s,e)}}e.createVariable(t.name,r,t)}_switch(t,e){e=e.clone();const r=this.evalExpression(t.condition,e);if(!(r instanceof F))return console.error(`Invalid if condition. Line ${t.line}`),null;let i=null;for(const s of t.cases)if(s instanceof hb)for(const o of s.selectors){if(o instanceof iu){i=s;continue}const a=this.evalExpression(o,e);if(!(a instanceof F))return console.error(`Invalid case selector. Line ${t.line}`),null;if(a.value===r.value)return this._execStatements(s.body,e)}else s instanceof fb&&(i=s);return i?this._execStatements(i.body,e):null}_if(t,e){e=e.clone();const r=this.evalExpression(t.condition,e);if(!(r instanceof F))return console.error(`Invalid if condition. Line ${t.line}`),null;if(r.value)return this._execStatements(t.body,e);for(const i of t.elseif){const s=this.evalExpression(i.condition,e);if(!(s instanceof F))return console.error(`Invalid if condition. Line ${t.line}`),null;if(s.value)return this._execStatements(i.body,e)}return t.else?this._execStatements(t.else,e):null}_getScalarValue(t){return t instanceof F?t.value:(console.error("Expected scalar value.",t),0)}_for(t,e){for(e=e.clone(),this.execStatement(t.init,e);this._getScalarValue(this.evalExpression(t.condition,e));){const r=this._execStatements(t.body,e);if(r===pr._breakObj)break;if(r!==null&&r!==pr._continueObj)return r;this.execStatement(t.increment,e)}return null}_loop(t,e){for(e=e.clone();;){const r=this._execStatements(t.body,e);if(r===pr._breakObj)break;if(r===pr._continueObj){if(t.continuing&&this._execStatements(t.continuing.body,e)===pr._breakObj)break}else if(r!==null)return r}return null}_while(t,e){for(e=e.clone();this._getScalarValue(this.evalExpression(t.condition,e));){const r=this._execStatements(t.body,e);if(r===pr._breakObj)break;if(r!==pr._continueObj&&r!==null)return r}return null}_evalBitcast(t,e){const r=this.evalExpression(t.value,e),i=t.type;if(r instanceof F){const s=Rm(r.value,r.typeInfo.name,i.name);return new F(s,this.getTypeInfo(i))}if(r instanceof N){const s=r.typeInfo.getTypeName();let o="";if(s.endsWith("f"))o="f32";else if(s.endsWith("i"))o="i32";else if(s.endsWith("u"))o="u32";else if(s.endsWith("b"))o="bool";else{if(!s.endsWith("h"))return console.error(`Unknown vector type ${s}. Line ${t.line}`),null;o="f16"}const a=i.getTypeName();let l="";if(a.endsWith("f"))l="f32";else if(a.endsWith("i"))l="i32";else if(a.endsWith("u"))l="u32";else if(a.endsWith("b"))l="bool";else{if(!a.endsWith("h"))return console.error(`Unknown vector type ${l}. Line ${t.line}`),null;l="f16"}const c=function(u,h,f){if(h===f)return u;const d=new Array(u.length);for(let p=0;p<u.length;p++)d[p]=Rm(u[p],h,f);return d}(Array.from(r.data),o,l);return new N(c,this.getTypeInfo(i))}return console.error(`TODO: bitcast for ${r.typeInfo.name}. Line ${t.line}`),null}_evalConst(t,e){return e.getVariableValue(t.name).clone().getSubData(this,t.postfix,e)}_evalCreate(t,e){var r;if(t instanceof yi){if(t.type===null)return md.void;switch(t.type.getTypeName()){case"bool":case"i32":case"u32":case"f32":case"f16":return this._callConstructorValue(t,e);case"vec2":case"vec3":case"vec4":case"vec2f":case"vec3f":case"vec4f":case"vec2h":case"vec3h":case"vec4h":case"vec2i":case"vec3i":case"vec4i":case"vec2u":case"vec3u":case"vec4u":case"vec2b":case"vec3b":case"vec4b":return this._callConstructorVec(t,e);case"mat2x2":case"mat2x2f":case"mat2x2h":case"mat2x3":case"mat2x3f":case"mat2x3h":case"mat2x4":case"mat2x4f":case"mat2x4h":case"mat3x2":case"mat3x2f":case"mat3x2h":case"mat3x3":case"mat3x3f":case"mat3x3h":case"mat3x4":case"mat3x4f":case"mat3x4h":case"mat4x2":case"mat4x2f":case"mat4x2h":case"mat4x3":case"mat4x3f":case"mat4x3h":case"mat4x4":case"mat4x4f":case"mat4x4h":return this._callConstructorMatrix(t,e)}}const i=t instanceof yi?t.type.name:t.name,s=t instanceof yi?this.getTypeInfo(t.type):this.getTypeInfo(t.name);if(s===null)return console.error(`Unknown type ${i}. Line ${t.line}`),null;if(s.size===0)return null;const o=new _e(new ArrayBuffer(s.size),s,0);if(s instanceof gs){if(t.args)for(let a=0;a<t.args.length;++a){const l=s.members[a],c=t.args[a],u=this.evalExpression(c,e);o.setData(this,u,l.type,l.offset,e)}}else if(s instanceof ws){let a=0;if(t.args)for(let l=0;l<t.args.length;++l){const c=t.args[l],u=this.evalExpression(c,e);s.format===null&&(((r=u.typeInfo)===null||r===void 0?void 0:r.name)==="x32"?s.format=this.getTypeInfo("i32"):s.format=u.typeInfo),o.setData(this,u,s.format,a,e),a+=s.stride}}else console.error(`Unknown type "${i}". Line ${t.line}`);return t instanceof yi?o.getSubData(this,t.postfix,e):o}_evalLiteral(t,e){const r=this.getTypeInfo(t.type),i=r.name;return i==="x32"||i==="u32"||i==="f32"||i==="f16"||i==="i32"||i==="bool"?new F(t.scalarValue,r):i==="vec2"||i==="vec3"||i==="vec4"||i==="vec2f"||i==="vec3f"||i==="vec4f"||i==="vec2h"||i==="vec3h"||i==="vec4h"||i==="vec2i"||i==="vec3i"||i==="vec4i"||i==="vec2u"||i==="vec3u"||i==="vec4u"?this._callConstructorVec(t,e):i==="mat2x2"||i==="mat2x3"||i==="mat2x4"||i==="mat3x2"||i==="mat3x3"||i==="mat3x4"||i==="mat4x2"||i==="mat4x3"||i==="mat4x4"||i==="mat2x2f"||i==="mat2x3f"||i==="mat2x4f"||i==="mat3x2f"||i==="mat3x3f"||i==="mat3x4f"||i==="mat4x2f"||i==="mat4x3f"||i==="mat4x4f"||i==="mat2x2h"||i==="mat2x3h"||i==="mat2x4h"||i==="mat3x2h"||i==="mat3x3h"||i==="mat3x4h"||i==="mat4x2h"||i==="mat4x3h"||i==="mat4x4h"?this._callConstructorMatrix(t,e):t.value}_evalVariable(t,e){const r=e.getVariableValue(t.name);return r===null?r:r.getSubData(this,t.postfix,e)}_maxFormatTypeInfo(t){let e=t[0];if(e.name==="f32")return e;for(let r=1;r<t.length;++r){const i=pr._priority.get(e.name);pr._priority.get(t[r].name)<i&&(e=t[r])}return e.name==="x32"?this.getTypeInfo("i32"):e}_evalUnaryOp(t,e){const r=this.evalExpression(t.right,e);if(t.operator==="&")return new Wo(r);if(t.operator==="*")return r instanceof Wo?r.reference.getSubData(this,t.postfix,e):(console.error(`Invalid dereference. Line ${t.line}`),null);const i=r instanceof F?r.value:r instanceof N?Array.from(r.data):null;switch(t.operator){case"+":{if(it(i)){const a=i.map((l,c)=>+l);return new N(a,r.typeInfo)}const s=i,o=this._maxFormatTypeInfo([r.typeInfo,r.typeInfo]);return new F(+s,o)}case"-":{if(it(i)){const a=i.map((l,c)=>-l);return new N(a,r.typeInfo)}const s=i,o=this._maxFormatTypeInfo([r.typeInfo,r.typeInfo]);return new F(-s,o)}case"!":{if(it(i)){const a=i.map((l,c)=>l?0:1);return new N(a,r.typeInfo)}const s=i,o=this._maxFormatTypeInfo([r.typeInfo,r.typeInfo]);return new F(s?0:1,o)}case"~":{if(it(i)){const a=i.map((l,c)=>~l);return new N(a,r.typeInfo)}const s=i,o=this._maxFormatTypeInfo([r.typeInfo,r.typeInfo]);return new F(~s,o)}}return console.error(`Invalid unary operator ${t.operator}. Line ${t.line}`),null}_evalBinaryOp(t,e){const r=this.evalExpression(t.left,e),i=this.evalExpression(t.right,e),s=r instanceof F?r.value:r instanceof N||r instanceof pt?Array.from(r.data):null,o=i instanceof F?i.value:i instanceof N||i instanceof pt?Array.from(i.data):null;switch(t.operator){case"+":{if(it(s)&&it(o)){const u=s,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;const f=u.map((d,p)=>d+h[p]);return new N(f,r.typeInfo)}if(it(s)){const u=o,h=s.map((f,d)=>f+u);return new N(h,r.typeInfo)}if(it(o)){const u=s,h=o.map((f,d)=>u+f);return new N(h,i.typeInfo)}const a=s,l=o,c=this._maxFormatTypeInfo([r.typeInfo,i.typeInfo]);return new F(a+l,c)}case"-":{if(it(s)&&it(o)){const u=s,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;const f=u.map((d,p)=>d-h[p]);return new N(f,r.typeInfo)}if(it(s)){const u=o,h=s.map((f,d)=>f-u);return new N(h,r.typeInfo)}if(it(o)){const u=s,h=o.map((f,d)=>u-f);return new N(h,i.typeInfo)}const a=s,l=o,c=this._maxFormatTypeInfo([r.typeInfo,i.typeInfo]);return new F(a-l,c)}case"*":{if(it(s)&&it(o)){const u=s,h=o;if(r instanceof pt&&i instanceof pt){const f=function(v,E,m,g){if(Sn[E.name]===void 0||Sn[g.name]===void 0)return null;const y=Sn[E.name][0],b=Sn[E.name][1],x=Sn[g.name][0];if(y!==Sn[g.name][1])return null;const w=new Array(x*b);for(let S=0;S<b;S++)for(let I=0;I<x;I++){let T=0;for(let M=0;M<y;M++)T+=v[M*b+S]*m[I*y+M];w[S*x+I]=T}return w}(u,r.typeInfo,h,i.typeInfo);if(f===null)return console.error(`Matrix multiplication failed. Line ${t.line}.`),null;const d=Sn[i.typeInfo.name][0],p=Sn[r.typeInfo.name][1],_=this.getTypeInfo(`mat${d}x${p}f`);return new pt(f,_)}if(r instanceof pt&&i instanceof N){const f=function(d,p,_,v){if(Sn[p.name]===void 0||df[v.name]===void 0)return null;const E=Sn[p.name][0],m=Sn[p.name][1];if(E!==_.length)return null;const g=new Array(m);for(let y=0;y<m;y++){let b=0;for(let x=0;x<E;x++)b+=d[x*m+y]*_[x];g[y]=b}return g}(u,r.typeInfo,h,i.typeInfo);return f===null?(console.error(`Matrix vector multiplication failed. Line ${t.line}.`),null):new N(f,i.typeInfo)}if(r instanceof N&&i instanceof pt){const f=function(d,p,_,v){if(df[p.name]===void 0||Sn[v.name]===void 0)return null;const E=Sn[v.name][0],m=Sn[v.name][1];if(m!==d.length)return null;const g=[];for(let y=0;y<E;y++){let b=0;for(let x=0;x<m;x++)b+=d[x]*_[x*E+y];g[y]=b}return g}(u,r.typeInfo,h,i.typeInfo);return f===null?(console.error(`Matrix vector multiplication failed. Line ${t.line}.`),null):new N(f,r.typeInfo)}{if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;const f=u.map((d,p)=>d*h[p]);return new N(f,r.typeInfo)}}if(it(s)){const u=o,h=s.map((f,d)=>f*u);return r instanceof pt?new pt(h,r.typeInfo):new N(h,r.typeInfo)}if(it(o)){const u=s,h=o.map((f,d)=>u*f);return i instanceof pt?new pt(h,i.typeInfo):new N(h,i.typeInfo)}const a=s,l=o,c=this._maxFormatTypeInfo([r.typeInfo,i.typeInfo]);return new F(a*l,c)}case"%":{if(it(s)&&it(o)){const u=s,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;const f=u.map((d,p)=>d%h[p]);return new N(f,r.typeInfo)}if(it(s)){const u=o,h=s.map((f,d)=>f%u);return new N(h,r.typeInfo)}if(it(o)){const u=s,h=o.map((f,d)=>u%f);return new N(h,i.typeInfo)}const a=s,l=o,c=this._maxFormatTypeInfo([r.typeInfo,i.typeInfo]);return new F(a%l,c)}case"/":{if(it(s)&&it(o)){const u=s,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;const f=u.map((d,p)=>d/h[p]);return new N(f,r.typeInfo)}if(it(s)){const u=o,h=s.map((f,d)=>f/u);return new N(h,r.typeInfo)}if(it(o)){const u=s,h=o.map((f,d)=>u/f);return new N(h,i.typeInfo)}const a=s,l=o,c=this._maxFormatTypeInfo([r.typeInfo,i.typeInfo]);return new F(a/l,c)}case"&":{if(it(s)&&it(o)){const u=s,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;const f=u.map((d,p)=>d&h[p]);return new N(f,r.typeInfo)}if(it(s)){const u=o,h=s.map((f,d)=>f&u);return new N(h,r.typeInfo)}if(it(o)){const u=s,h=o.map((f,d)=>u&f);return new N(h,i.typeInfo)}const a=s,l=o,c=this._maxFormatTypeInfo([r.typeInfo,i.typeInfo]);return new F(a&l,c)}case"|":{if(it(s)&&it(o)){const u=s,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;const f=u.map((d,p)=>d|h[p]);return new N(f,r.typeInfo)}if(it(s)){const u=o,h=s.map((f,d)=>f|u);return new N(h,r.typeInfo)}if(it(o)){const u=s,h=o.map((f,d)=>u|f);return new N(h,i.typeInfo)}const a=s,l=o,c=this._maxFormatTypeInfo([r.typeInfo,i.typeInfo]);return new F(a|l,c)}case"^":{if(it(s)&&it(o)){const u=s,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;const f=u.map((d,p)=>d^h[p]);return new N(f,r.typeInfo)}if(it(s)){const u=o,h=s.map((f,d)=>f^u);return new N(h,r.typeInfo)}if(it(o)){const u=s,h=o.map((f,d)=>u^f);return new N(h,i.typeInfo)}const a=s,l=o,c=this._maxFormatTypeInfo([r.typeInfo,i.typeInfo]);return new F(a^l,c)}case"<<":{if(it(s)&&it(o)){const u=s,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;const f=u.map((d,p)=>d<<h[p]);return new N(f,r.typeInfo)}if(it(s)){const u=o,h=s.map((f,d)=>f<<u);return new N(h,r.typeInfo)}if(it(o)){const u=s,h=o.map((f,d)=>u<<f);return new N(h,i.typeInfo)}const a=s,l=o,c=this._maxFormatTypeInfo([r.typeInfo,i.typeInfo]);return new F(a<<l,c)}case">>":{if(it(s)&&it(o)){const u=s,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;const f=u.map((d,p)=>d>>h[p]);return new N(f,r.typeInfo)}if(it(s)){const u=o,h=s.map((f,d)=>f>>u);return new N(h,r.typeInfo)}if(it(o)){const u=s,h=o.map((f,d)=>u>>f);return new N(h,i.typeInfo)}const a=s,l=o,c=this._maxFormatTypeInfo([r.typeInfo,i.typeInfo]);return new F(a>>l,c)}case">":if(it(s)&&it(o)){const a=s,l=o;if(a.length!==l.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;const c=a.map((u,h)=>u>l[h]?1:0);return new N(c,r.typeInfo)}if(it(s)){const a=o,l=s.map((c,u)=>c>a?1:0);return new N(l,r.typeInfo)}if(it(o)){const a=s,l=o.map((c,u)=>a>c?1:0);return new N(l,i.typeInfo)}return new F(s>o?1:0,this.getTypeInfo("bool"));case"<":if(it(s)&&it(o)){const a=s,l=o;if(a.length!==l.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;const c=a.map((u,h)=>u<l[h]?1:0);return new N(c,r.typeInfo)}if(it(s)){const a=o,l=s.map((c,u)=>c<a?1:0);return new N(l,r.typeInfo)}if(it(o)){const a=s,l=o.map((c,u)=>a<c?1:0);return new N(l,i.typeInfo)}return new F(s<o?1:0,this.getTypeInfo("bool"));case"==":if(it(s)&&it(o)){const a=s,l=o;if(a.length!==l.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;const c=a.map((u,h)=>u===l[h]?1:0);return new N(c,r.typeInfo)}if(it(s)){const a=o,l=s.map((c,u)=>c==a?1:0);return new N(l,r.typeInfo)}if(it(o)){const a=s,l=o.map((c,u)=>a==c?1:0);return new N(l,i.typeInfo)}return new F(s===o?1:0,this.getTypeInfo("bool"));case"!=":if(it(s)&&it(o)){const a=s,l=o;if(a.length!==l.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;const c=a.map((u,h)=>u!==l[h]?1:0);return new N(c,r.typeInfo)}if(it(s)){const a=o,l=s.map((c,u)=>c!==a?1:0);return new N(l,r.typeInfo)}if(it(o)){const a=s,l=o.map((c,u)=>a!==c?1:0);return new N(l,i.typeInfo)}return new F(s!==o?1:0,this.getTypeInfo("bool"));case">=":if(it(s)&&it(o)){const a=s,l=o;if(a.length!==l.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;const c=a.map((u,h)=>u>=l[h]?1:0);return new N(c,r.typeInfo)}if(it(s)){const a=o,l=s.map((c,u)=>c>=a?1:0);return new N(l,r.typeInfo)}if(it(o)){const a=s,l=o.map((c,u)=>a>=c?1:0);return new N(l,i.typeInfo)}return new F(s>=o?1:0,this.getTypeInfo("bool"));case"<=":if(it(s)&&it(o)){const a=s,l=o;if(a.length!==l.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;const c=a.map((u,h)=>u<=l[h]?1:0);return new N(c,r.typeInfo)}if(it(s)){const a=o,l=s.map((c,u)=>c<=a?1:0);return new N(l,r.typeInfo)}if(it(o)){const a=s,l=o.map((c,u)=>a<=c?1:0);return new N(l,i.typeInfo)}return new F(s<=o?1:0,this.getTypeInfo("bool"));case"&&":if(it(s)&&it(o)){const a=s,l=o;if(a.length!==l.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;const c=a.map((u,h)=>u&&l[h]?1:0);return new N(c,r.typeInfo)}if(it(s)){const a=o,l=s.map((c,u)=>c&&a?1:0);return new N(l,r.typeInfo)}if(it(o)){const a=s,l=o.map((c,u)=>a&&c?1:0);return new N(l,i.typeInfo)}return new F(s&&o?1:0,this.getTypeInfo("bool"));case"||":if(it(s)&&it(o)){const a=s,l=o;if(a.length!==l.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;const c=a.map((u,h)=>u||l[h]?1:0);return new N(c,r.typeInfo)}if(it(s)){const a=o,l=s.map((c,u)=>c||a?1:0);return new N(l,r.typeInfo)}if(it(o)){const a=s,l=o.map((c,u)=>a||c?1:0);return new N(l,i.typeInfo)}return new F(s||o?1:0,this.getTypeInfo("bool"))}return console.error(`Unknown operator ${t.operator}. Line ${t.line}`),null}_evalCall(t,e){if(t.cachedReturnValue!==null)return t.cachedReturnValue;const r=e.clone();r.currentFunctionName=t.name;const i=e.getFunction(t.name);if(!i)return t.isBuiltin?this._callBuiltinFunction(t,r):this.getTypeInfo(t.name)?this._evalCreate(t,e):(console.error(`Unknown function "${t.name}". Line ${t.line}`),null);for(let s=0;s<i.node.args.length;++s){const o=i.node.args[s],a=this.evalExpression(t.args[s],r);r.createVariable(o.name,a,o)}return this._execStatements(i.node.body,r)}_callBuiltinFunction(t,e){switch(t.name){case"all":return this.builtins.All(t,e);case"any":return this.builtins.Any(t,e);case"select":return this.builtins.Select(t,e);case"arrayLength":return this.builtins.ArrayLength(t,e);case"abs":return this.builtins.Abs(t,e);case"acos":return this.builtins.Acos(t,e);case"acosh":return this.builtins.Acosh(t,e);case"asin":return this.builtins.Asin(t,e);case"asinh":return this.builtins.Asinh(t,e);case"atan":return this.builtins.Atan(t,e);case"atanh":return this.builtins.Atanh(t,e);case"atan2":return this.builtins.Atan2(t,e);case"ceil":return this.builtins.Ceil(t,e);case"clamp":return this.builtins.Clamp(t,e);case"cos":return this.builtins.Cos(t,e);case"cosh":return this.builtins.Cosh(t,e);case"countLeadingZeros":return this.builtins.CountLeadingZeros(t,e);case"countOneBits":return this.builtins.CountOneBits(t,e);case"countTrailingZeros":return this.builtins.CountTrailingZeros(t,e);case"cross":return this.builtins.Cross(t,e);case"degrees":return this.builtins.Degrees(t,e);case"determinant":return this.builtins.Determinant(t,e);case"distance":return this.builtins.Distance(t,e);case"dot":return this.builtins.Dot(t,e);case"dot4U8Packed":return this.builtins.Dot4U8Packed(t,e);case"dot4I8Packed":return this.builtins.Dot4I8Packed(t,e);case"exp":return this.builtins.Exp(t,e);case"exp2":return this.builtins.Exp2(t,e);case"extractBits":return this.builtins.ExtractBits(t,e);case"faceForward":return this.builtins.FaceForward(t,e);case"firstLeadingBit":return this.builtins.FirstLeadingBit(t,e);case"firstTrailingBit":return this.builtins.FirstTrailingBit(t,e);case"floor":return this.builtins.Floor(t,e);case"fma":return this.builtins.Fma(t,e);case"fract":return this.builtins.Fract(t,e);case"frexp":return this.builtins.Frexp(t,e);case"insertBits":return this.builtins.InsertBits(t,e);case"inverseSqrt":return this.builtins.InverseSqrt(t,e);case"ldexp":return this.builtins.Ldexp(t,e);case"length":return this.builtins.Length(t,e);case"log":return this.builtins.Log(t,e);case"log2":return this.builtins.Log2(t,e);case"max":return this.builtins.Max(t,e);case"min":return this.builtins.Min(t,e);case"mix":return this.builtins.Mix(t,e);case"modf":return this.builtins.Modf(t,e);case"normalize":return this.builtins.Normalize(t,e);case"pow":return this.builtins.Pow(t,e);case"quantizeToF16":return this.builtins.QuantizeToF16(t,e);case"radians":return this.builtins.Radians(t,e);case"reflect":return this.builtins.Reflect(t,e);case"refract":return this.builtins.Refract(t,e);case"reverseBits":return this.builtins.ReverseBits(t,e);case"round":return this.builtins.Round(t,e);case"saturate":return this.builtins.Saturate(t,e);case"sign":return this.builtins.Sign(t,e);case"sin":return this.builtins.Sin(t,e);case"sinh":return this.builtins.Sinh(t,e);case"smoothStep":return this.builtins.SmoothStep(t,e);case"sqrt":return this.builtins.Sqrt(t,e);case"step":return this.builtins.Step(t,e);case"tan":return this.builtins.Tan(t,e);case"tanh":return this.builtins.Tanh(t,e);case"transpose":return this.builtins.Transpose(t,e);case"trunc":return this.builtins.Trunc(t,e);case"dpdx":return this.builtins.Dpdx(t,e);case"dpdxCoarse":return this.builtins.DpdxCoarse(t,e);case"dpdxFine":return this.builtins.DpdxFine(t,e);case"dpdy":return this.builtins.Dpdy(t,e);case"dpdyCoarse":return this.builtins.DpdyCoarse(t,e);case"dpdyFine":return this.builtins.DpdyFine(t,e);case"fwidth":return this.builtins.Fwidth(t,e);case"fwidthCoarse":return this.builtins.FwidthCoarse(t,e);case"fwidthFine":return this.builtins.FwidthFine(t,e);case"textureDimensions":return this.builtins.TextureDimensions(t,e);case"textureGather":return this.builtins.TextureGather(t,e);case"textureGatherCompare":return this.builtins.TextureGatherCompare(t,e);case"textureLoad":return this.builtins.TextureLoad(t,e);case"textureNumLayers":return this.builtins.TextureNumLayers(t,e);case"textureNumLevels":return this.builtins.TextureNumLevels(t,e);case"textureNumSamples":return this.builtins.TextureNumSamples(t,e);case"textureSample":return this.builtins.TextureSample(t,e);case"textureSampleBias":return this.builtins.TextureSampleBias(t,e);case"textureSampleCompare":return this.builtins.TextureSampleCompare(t,e);case"textureSampleCompareLevel":return this.builtins.TextureSampleCompareLevel(t,e);case"textureSampleGrad":return this.builtins.TextureSampleGrad(t,e);case"textureSampleLevel":return this.builtins.TextureSampleLevel(t,e);case"textureSampleBaseClampToEdge":return this.builtins.TextureSampleBaseClampToEdge(t,e);case"textureStore":return this.builtins.TextureStore(t,e);case"atomicLoad":return this.builtins.AtomicLoad(t,e);case"atomicStore":return this.builtins.AtomicStore(t,e);case"atomicAdd":return this.builtins.AtomicAdd(t,e);case"atomicSub":return this.builtins.AtomicSub(t,e);case"atomicMax":return this.builtins.AtomicMax(t,e);case"atomicMin":return this.builtins.AtomicMin(t,e);case"atomicAnd":return this.builtins.AtomicAnd(t,e);case"atomicOr":return this.builtins.AtomicOr(t,e);case"atomicXor":return this.builtins.AtomicXor(t,e);case"atomicExchange":return this.builtins.AtomicExchange(t,e);case"atomicCompareExchangeWeak":return this.builtins.AtomicCompareExchangeWeak(t,e);case"pack4x8snorm":return this.builtins.Pack4x8snorm(t,e);case"pack4x8unorm":return this.builtins.Pack4x8unorm(t,e);case"pack4xI8":return this.builtins.Pack4xI8(t,e);case"pack4xU8":return this.builtins.Pack4xU8(t,e);case"pack4x8Clamp":return this.builtins.Pack4x8Clamp(t,e);case"pack4xU8Clamp":return this.builtins.Pack4xU8Clamp(t,e);case"pack2x16snorm":return this.builtins.Pack2x16snorm(t,e);case"pack2x16unorm":return this.builtins.Pack2x16unorm(t,e);case"pack2x16float":return this.builtins.Pack2x16float(t,e);case"unpack4x8snorm":return this.builtins.Unpack4x8snorm(t,e);case"unpack4x8unorm":return this.builtins.Unpack4x8unorm(t,e);case"unpack4xI8":return this.builtins.Unpack4xI8(t,e);case"unpack4xU8":return this.builtins.Unpack4xU8(t,e);case"unpack2x16snorm":return this.builtins.Unpack2x16snorm(t,e);case"unpack2x16unorm":return this.builtins.Unpack2x16unorm(t,e);case"unpack2x16float":return this.builtins.Unpack2x16float(t,e);case"storageBarrier":return this.builtins.StorageBarrier(t,e);case"textureBarrier":return this.builtins.TextureBarrier(t,e);case"workgroupBarrier":return this.builtins.WorkgroupBarrier(t,e);case"workgroupUniformLoad":return this.builtins.WorkgroupUniformLoad(t,e);case"subgroupAdd":return this.builtins.SubgroupAdd(t,e);case"subgroupExclusiveAdd":return this.builtins.SubgroupExclusiveAdd(t,e);case"subgroupInclusiveAdd":return this.builtins.SubgroupInclusiveAdd(t,e);case"subgroupAll":return this.builtins.SubgroupAll(t,e);case"subgroupAnd":return this.builtins.SubgroupAnd(t,e);case"subgroupAny":return this.builtins.SubgroupAny(t,e);case"subgroupBallot":return this.builtins.SubgroupBallot(t,e);case"subgroupBroadcast":return this.builtins.SubgroupBroadcast(t,e);case"subgroupBroadcastFirst":return this.builtins.SubgroupBroadcastFirst(t,e);case"subgroupElect":return this.builtins.SubgroupElect(t,e);case"subgroupMax":return this.builtins.SubgroupMax(t,e);case"subgroupMin":return this.builtins.SubgroupMin(t,e);case"subgroupMul":return this.builtins.SubgroupMul(t,e);case"subgroupExclusiveMul":return this.builtins.SubgroupExclusiveMul(t,e);case"subgroupInclusiveMul":return this.builtins.SubgroupInclusiveMul(t,e);case"subgroupOr":return this.builtins.SubgroupOr(t,e);case"subgroupShuffle":return this.builtins.SubgroupShuffle(t,e);case"subgroupShuffleDown":return this.builtins.SubgroupShuffleDown(t,e);case"subgroupShuffleUp":return this.builtins.SubgroupShuffleUp(t,e);case"subgroupShuffleXor":return this.builtins.SubgroupShuffleXor(t,e);case"subgroupXor":return this.builtins.SubgroupXor(t,e);case"quadBroadcast":return this.builtins.QuadBroadcast(t,e);case"quadSwapDiagonal":return this.builtins.QuadSwapDiagonal(t,e);case"quadSwapX":return this.builtins.QuadSwapX(t,e);case"quadSwapY":return this.builtins.QuadSwapY(t,e)}const r=e.getFunction(t.name);if(r){const i=e.clone();for(let s=0;s<r.node.args.length;++s){const o=r.node.args[s],a=this.evalExpression(t.args[s],i);i.setVariable(o.name,a,o)}return this._execStatements(r.node.body,i)}return null}_callConstructorValue(t,e){if(!t.args||t.args.length===0)return new F(0,this.getTypeInfo(t.type));const r=this.evalExpression(t.args[0],e);return r.typeInfo=this.getTypeInfo(t.type),r.getSubData(this,t.postfix,e).clone()}_callConstructorVec(t,e){const r=this.getTypeInfo(t.type),i=t.type.getTypeName(),s=df[i];if(s===void 0)return console.error(`Invalid vec constructor ${i}. Line ${t.line}`),null;const o=[];if(t instanceof Be)if(t.isVector){const a=t.vectorValue;for(const l of a)o.push(l)}else o.push(t.scalarValue);else if(t.args)for(const a of t.args){const l=this.evalExpression(a,e);if(l instanceof N){const c=l.data;for(let u=0;u<c.length;++u){let h=c[u];o.push(h)}}else if(l instanceof F){let c=l.value;o.push(c)}}if(t.type instanceof W&&t.type.format===null&&(t.type.format=W.f32),o.length===0){const a=new Array(s).fill(0);return new N(a,r).getSubData(this,t.postfix,e)}if(o.length===1)for(;o.length<s;)o.push(o[0]);return o.length<s?(console.error(`Invalid vec constructor. Line ${t.line}`),null):new N(o.length>s?o.slice(0,s):o,r).getSubData(this,t.postfix,e)}_callConstructorMatrix(t,e){const r=this.getTypeInfo(t.type),i=t.type.getTypeName(),s=Sn[i];if(s===void 0)return console.error(`Invalid matrix constructor ${i}. Line ${t.line}`),null;const o=[];if(t instanceof Be)if(t.isVector){const a=t.vectorValue;for(const l of a)o.push(l)}else o.push(t.scalarValue);else if(t.args)for(const a of t.args){const l=this.evalExpression(a,e);l instanceof N?o.push(...l.data):l instanceof F?o.push(l.value):l instanceof pt&&o.push(...l.data)}if(r instanceof oo&&r.format===null&&(r.format=this.getTypeInfo("f32")),o.length===0){const a=new Array(s[2]).fill(0);return new pt(a,r).getSubData(this,t.postfix,e)}return o.length!==s[2]?(console.error(`Invalid matrix constructor. Line ${t.line}`),null):new pt(o,r).getSubData(this,t.postfix,e)}};su._breakObj=new Tr(new Er("BREAK",null),null),su._continueObj=new Tr(new Er("CONTINUE",null),null),su._priority=new Map([["f32",0],["f16",1],["u32",2],["i32",3],["x32",3]]);class nI{constructor(){this.constants=new Map,this.aliases=new Map,this.structs=new Map}}class rI{constructor(){this._tokens=[],this._current=0,this._currentLine=1,this._deferArrayCountEval=[],this._currentLoop=[],this._context=new nI,this._exec=new su,this._forwardTypeCount=0}parse(t){this._initialize(t),this._deferArrayCountEval.length=0;const e=[];for(;!this._isAtEnd();){const r=this._global_decl_or_directive();if(!r)break;e.push(r)}if(this._deferArrayCountEval.length>0){for(const r of this._deferArrayCountEval){const i=r.arrayType,s=r.countNode;if(s instanceof Zn){const o=s.name,a=this._context.constants.get(o);if(a)try{const l=a.constEvaluate(this._exec);i.count=l}catch{}}}this._deferArrayCountEval.length=0}if(this._forwardTypeCount>0)for(const r of e)r.search(i=>{i instanceof Am||i instanceof ru?i.type=this._forwardType(i.type):i instanceof xl?i.format=this._forwardType(i.format):i instanceof Wi||i instanceof bl||i instanceof eu?i.type=this._forwardType(i.type):i instanceof Il?i.returnType=this._forwardType(i.returnType):i instanceof Im&&(i.type=this._forwardType(i.type))});return e}_forwardType(t){if(t instanceof Pm){const e=this._getType(t.name);if(e)return e}else t instanceof ru?t.type=this._forwardType(t.type):t instanceof xl&&(t.format=this._forwardType(t.format));return t}_initialize(t){if(t)if(typeof t=="string"){const e=new $P(t);this._tokens=e.scanTokens()}else this._tokens=t;else this._tokens=[];this._current=0}_updateNode(t,e){return t.line=e??this._currentLine,t}_error(t,e){return{token:t,message:e,toString:()=>`${e}`}}_isAtEnd(){return this._current>=this._tokens.length||this._peek().type==A.eof}_match(t){if(t instanceof U)return!!this._check(t)&&(this._advance(),!0);for(let e=0,r=t.length;e<r;++e){const i=t[e];if(this._check(i))return this._advance(),!0}return!1}_consume(t,e){if(this._check(t))return this._advance();throw this._error(this._peek(),`${e}. Line:${this._currentLine}`)}_check(t){if(this._isAtEnd())return!1;const e=this._peek();if(t instanceof Array){const r=e.type;let i=!1;for(const s of t){if(r===s)return!0;s===A.tokens.name&&(i=!0)}if(i){const s=A.tokens.name.rule.exec(e.lexeme);if(s&&s.index==0&&s[0]==e.lexeme)return!0}return!1}if(e.type===t)return!0;if(t===A.tokens.name){const r=A.tokens.name.rule.exec(e.lexeme);return r&&r.index==0&&r[0]==e.lexeme}return!1}_advance(){var t,e;return this._currentLine=(e=(t=this._peek())===null||t===void 0?void 0:t.line)!==null&&e!==void 0?e:-1,this._isAtEnd()||this._current++,this._previous()}_peek(){return this._tokens[this._current]}_previous(){return this._tokens[this._current-1]}_global_decl_or_directive(){for(;this._match(A.tokens.semicolon)&&!this._isAtEnd(););if(this._match(A.keywords.alias)){const e=this._type_alias();return this._consume(A.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([e]),e}if(this._match(A.keywords.diagnostic)){const e=this._diagnostic();return this._consume(A.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([e]),e}if(this._match(A.keywords.requires)){const e=this._requires_directive();return this._consume(A.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([e]),e}if(this._match(A.keywords.enable)){const e=this._enable_directive();return this._consume(A.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([e]),e}const t=this._attribute();if(this._check(A.keywords.var)){const e=this._global_variable_decl();return e!=null&&(e.attributes=t),this._consume(A.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([e]),e}if(this._check(A.keywords.override)){const e=this._override_variable_decl();return e!=null&&(e.attributes=t),this._consume(A.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([e]),e}if(this._check(A.keywords.let)){const e=this._global_let_decl();return e!=null&&(e.attributes=t),this._consume(A.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([e]),e}if(this._check(A.keywords.const)){const e=this._global_const_decl();return e!=null&&(e.attributes=t),this._consume(A.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([e]),e}if(this._check(A.keywords.struct)){const e=this._struct_decl();return e!=null&&(e.attributes=t),this._exec.reflection.updateAST([e]),e}if(this._check(A.keywords.fn)){const e=this._function_decl();return e!=null&&(e.attributes=t),this._exec.reflection.updateAST([e]),e}return null}_function_decl(){if(!this._match(A.keywords.fn))return null;const t=this._currentLine,e=this._consume(A.tokens.ident,"Expected function name.").toString();this._consume(A.tokens.paren_left,"Expected '(' for function arguments.");const r=[];if(!this._check(A.tokens.paren_right))do{if(this._check(A.tokens.paren_right))break;const a=this._attribute(),l=this._consume(A.tokens.name,"Expected argument name.").toString();this._consume(A.tokens.colon,"Expected ':' for argument type.");const c=this._attribute(),u=this._type_decl();u!=null&&(u.attributes=c,r.push(this._updateNode(new Im(l,u,a))))}while(this._match(A.tokens.comma));this._consume(A.tokens.paren_right,"Expected ')' after function arguments.");let i=null;if(this._match(A.tokens.arrow)){const a=this._attribute();i=this._type_decl(),i!=null&&(i.attributes=a)}const s=this._compound_statement(),o=this._currentLine;return this._updateNode(new Il(e,r,i,s,t,o),t)}_compound_statement(){const t=[];for(this._consume(A.tokens.brace_left,"Expected '{' for block.");!this._check(A.tokens.brace_right);){const e=this._statement();e!==null&&t.push(e)}return this._consume(A.tokens.brace_right,"Expected '}' for block."),t}_statement(){for(;this._match(A.tokens.semicolon)&&!this._isAtEnd(););if(this._check(A.tokens.attr)&&this._attribute(),this._check(A.keywords.if))return this._if_statement();if(this._check(A.keywords.switch))return this._switch_statement();if(this._check(A.keywords.loop))return this._loop_statement();if(this._check(A.keywords.for))return this._for_statement();if(this._check(A.keywords.while))return this._while_statement();if(this._check(A.keywords.continuing))return this._continuing_statement();if(this._check(A.keywords.static_assert))return this._static_assert_statement();if(this._check(A.tokens.brace_left))return this._compound_statement();let t=null;if(this._check(A.keywords.return))t=this._return_statement();else if(this._check([A.keywords.var,A.keywords.let,A.keywords.const]))t=this._variable_statement();else if(this._match(A.keywords.discard))t=this._updateNode(new WP);else if(this._match(A.keywords.break)){const e=this._updateNode(new sb);if(this._currentLoop.length>0){const r=this._currentLoop[this._currentLoop.length-1];e.loopId=r.id}t=e,this._check(A.keywords.if)&&(this._advance(),e.condition=this._optional_paren_expression())}else if(this._match(A.keywords.continue)){const e=this._updateNode(new ob);if(!(this._currentLoop.length>0))throw this._error(this._peek(),`Continue statement must be inside a loop. Line: ${e.line}`);{const r=this._currentLoop[this._currentLoop.length-1];e.loopId=r.id}t=e}else t=this._increment_decrement_statement()||this._func_call_statement()||this._assignment_statement();return t!=null&&this._consume(A.tokens.semicolon,"Expected ';' after statement."),t}_static_assert_statement(){if(!this._match(A.keywords.static_assert))return null;const t=this._currentLine,e=this._optional_paren_expression();return this._updateNode(new UP(e),t)}_while_statement(){if(!this._match(A.keywords.while))return null;const t=this._updateNode(new K0(null,null));return this._currentLoop.push(t),t.condition=this._optional_paren_expression(),this._check(A.tokens.attr)&&this._attribute(),t.body=this._compound_statement(),this._currentLoop.pop(),t}_continuing_statement(){const t=this._currentLoop.length>0?this._currentLoop[this._currentLoop.length-1].id:-1;if(!this._match(A.keywords.continuing))return null;const e=this._currentLine,r=this._compound_statement();return this._updateNode(new gd(r,t),e)}_for_statement(){if(!this._match(A.keywords.for))return null;this._consume(A.tokens.paren_left,"Expected '('.");const t=this._updateNode(new Z0(null,null,null,null));return this._currentLoop.push(t),t.init=this._check(A.tokens.semicolon)?null:this._for_init(),this._consume(A.tokens.semicolon,"Expected ';'."),t.condition=this._check(A.tokens.semicolon)?null:this._short_circuit_or_expression(),this._consume(A.tokens.semicolon,"Expected ';'."),t.increment=this._check(A.tokens.paren_right)?null:this._for_increment(),this._consume(A.tokens.paren_right,"Expected ')'."),this._check(A.tokens.attr)&&this._attribute(),t.body=this._compound_statement(),this._currentLoop.pop(),t}_for_init(){return this._variable_statement()||this._func_call_statement()||this._assignment_statement()}_for_increment(){return this._func_call_statement()||this._increment_decrement_statement()||this._assignment_statement()}_variable_statement(){if(this._check(A.keywords.var)){const t=this._variable_decl();if(t===null)throw this._error(this._peek(),"Variable declaration expected.");let e=null;return this._match(A.tokens.equal)&&(e=this._short_circuit_or_expression()),this._updateNode(new Wi(t.name,t.type,t.storage,t.access,e),t.line)}if(this._match(A.keywords.let)){const t=this._currentLine,e=this._consume(A.tokens.name,"Expected name for let.").toString();let r=null;if(this._match(A.tokens.colon)){const s=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=s)}this._consume(A.tokens.equal,"Expected '=' for let.");const i=this._short_circuit_or_expression();return this._updateNode(new bl(e,r,null,null,i),t)}if(this._match(A.keywords.const)){const t=this._currentLine,e=this._consume(A.tokens.name,"Expected name for const.").toString();let r=null;if(this._match(A.tokens.colon)){const s=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=s)}this._consume(A.tokens.equal,"Expected '=' for const.");const i=this._short_circuit_or_expression();return r===null&&i instanceof Be&&(r=i.type),this._updateNode(new eu(e,r,null,null,i),t)}return null}_increment_decrement_statement(){const t=this._current,e=this._unary_expression();if(e==null)return null;if(!this._check(A.increment_operators))return this._current=t,null;const r=this._consume(A.increment_operators,"Expected increment operator");return this._updateNode(new J0(r.type===A.tokens.plus_plus?Zo.increment:Zo.decrement,e))}_assignment_statement(){let t=null;const e=this._currentLine;if(this._check(A.tokens.brace_right))return null;let r=this._match(A.tokens.underscore);if(r||(t=this._unary_expression()),!r&&t==null)return null;const i=this._consume(A.assignment_operators,"Expected assignment operator."),s=this._short_circuit_or_expression();return this._updateNode(new Q0(al.parse(i.lexeme),t,s),e)}_func_call_statement(){if(!this._check(A.tokens.ident))return null;const t=this._currentLine,e=this._current,r=this._consume(A.tokens.ident,"Expected function name."),i=this._argument_expression_list();return i===null?(this._current=e,null):this._updateNode(new Rp(r.lexeme,i),t)}_loop_statement(){if(!this._match(A.keywords.loop))return null;this._check(A.tokens.attr)&&this._attribute(),this._consume(A.tokens.brace_left,"Expected '{' for loop.");const t=this._updateNode(new tb([],null));this._currentLoop.push(t);let e=this._statement();for(;e!==null;){if(Array.isArray(e))for(let r of e)t.body.push(r);else t.body.push(e);if(e instanceof gd){t.continuing=e;break}e=this._statement()}return this._currentLoop.pop(),this._consume(A.tokens.brace_right,"Expected '}' for loop."),t}_switch_statement(){if(!this._match(A.keywords.switch))return null;const t=this._updateNode(new eb(null,[]));if(this._currentLoop.push(t),t.condition=this._optional_paren_expression(),this._check(A.tokens.attr)&&this._attribute(),this._consume(A.tokens.brace_left,"Expected '{' for switch."),t.cases=this._switch_body(),t.cases==null||t.cases.length==0)throw this._error(this._previous(),"Expected 'case' or 'default'.");return this._consume(A.tokens.brace_right,"Expected '}' for switch."),this._currentLoop.pop(),t}_switch_body(){const t=[];let e=!1;for(;this._check([A.keywords.default,A.keywords.case]);){if(this._match(A.keywords.case)){const r=this._case_selectors();for(const s of r)if(s instanceof iu){if(e)throw this._error(this._previous(),"Multiple default cases in switch statement.");e=!0;break}this._match(A.tokens.colon),this._check(A.tokens.attr)&&this._attribute(),this._consume(A.tokens.brace_left,"Exected '{' for switch case.");const i=this._case_body();this._consume(A.tokens.brace_right,"Exected '}' for switch case."),t.push(this._updateNode(new hb(r,i)))}if(this._match(A.keywords.default)){if(e)throw this._error(this._previous(),"Multiple default cases in switch statement.");this._match(A.tokens.colon),this._check(A.tokens.attr)&&this._attribute(),this._consume(A.tokens.brace_left,"Exected '{' for switch default.");const r=this._case_body();this._consume(A.tokens.brace_right,"Exected '}' for switch default."),t.push(this._updateNode(new fb(r)))}}return t}_case_selectors(){const t=[];for(this._match(A.keywords.default)?t.push(this._updateNode(new iu)):t.push(this._shift_expression());this._match(A.tokens.comma);)this._match(A.keywords.default)?t.push(this._updateNode(new iu)):t.push(this._shift_expression());return t}_case_body(){if(this._match(A.keywords.fallthrough))return this._consume(A.tokens.semicolon,"Expected ';'"),[];let t=this._statement();if(t==null)return[];t instanceof Array||(t=[t]);const e=this._case_body();return e.length==0?t:[...t,e[0]]}_if_statement(){if(!this._match(A.keywords.if))return null;const t=this._currentLine,e=this._optional_paren_expression();this._check(A.tokens.attr)&&this._attribute();const r=this._compound_statement();let i=[];this._match_elseif()&&(this._check(A.tokens.attr)&&this._attribute(),i=this._elseif_statement(i));let s=null;return this._match(A.keywords.else)&&(this._check(A.tokens.attr)&&this._attribute(),s=this._compound_statement()),this._updateNode(new nb(e,r,i,s),t)}_match_elseif(){return this._tokens[this._current].type===A.keywords.else&&this._tokens[this._current+1].type===A.keywords.if&&(this._advance(),this._advance(),!0)}_elseif_statement(t=[]){const e=this._optional_paren_expression(),r=this._compound_statement();return t.push(this._updateNode(new HP(e,r))),this._match_elseif()&&(this._check(A.tokens.attr)&&this._attribute(),this._elseif_statement(t)),t}_return_statement(){if(!this._match(A.keywords.return))return null;const t=this._short_circuit_or_expression();return this._updateNode(new rb(t))}_short_circuit_or_expression(){let t=this._short_circuit_and_expr();for(;this._match(A.tokens.or_or);)t=this._updateNode(new Hr(this._previous().toString(),t,this._short_circuit_and_expr()));return t}_short_circuit_and_expr(){let t=this._inclusive_or_expression();for(;this._match(A.tokens.and_and);)t=this._updateNode(new Hr(this._previous().toString(),t,this._inclusive_or_expression()));return t}_inclusive_or_expression(){let t=this._exclusive_or_expression();for(;this._match(A.tokens.or);)t=this._updateNode(new Hr(this._previous().toString(),t,this._exclusive_or_expression()));return t}_exclusive_or_expression(){let t=this._and_expression();for(;this._match(A.tokens.xor);)t=this._updateNode(new Hr(this._previous().toString(),t,this._and_expression()));return t}_and_expression(){let t=this._equality_expression();for(;this._match(A.tokens.and);)t=this._updateNode(new Hr(this._previous().toString(),t,this._equality_expression()));return t}_equality_expression(){const t=this._relational_expression();return this._match([A.tokens.equal_equal,A.tokens.not_equal])?this._updateNode(new Hr(this._previous().toString(),t,this._relational_expression())):t}_relational_expression(){let t=this._shift_expression();for(;this._match([A.tokens.less_than,A.tokens.greater_than,A.tokens.less_than_equal,A.tokens.greater_than_equal]);)t=this._updateNode(new Hr(this._previous().toString(),t,this._shift_expression()));return t}_shift_expression(){let t=this._additive_expression();for(;this._match([A.tokens.shift_left,A.tokens.shift_right]);)t=this._updateNode(new Hr(this._previous().toString(),t,this._additive_expression()));return t}_additive_expression(){let t=this._multiplicative_expression();for(;this._match([A.tokens.plus,A.tokens.minus]);)t=this._updateNode(new Hr(this._previous().toString(),t,this._multiplicative_expression()));return t}_multiplicative_expression(){let t=this._unary_expression();for(;this._match([A.tokens.star,A.tokens.forward_slash,A.tokens.modulo]);)t=this._updateNode(new Hr(this._previous().toString(),t,this._unary_expression()));return t}_unary_expression(){return this._match([A.tokens.minus,A.tokens.bang,A.tokens.tilde,A.tokens.star,A.tokens.and])?this._updateNode(new Pe(this._previous().toString(),this._unary_expression())):this._singular_expression()}_singular_expression(){const t=this._primary_expression(),e=this._postfix_expression();return e&&(t.postfix=e),t}_postfix_expression(){if(this._match(A.tokens.bracket_left)){const t=this._short_circuit_or_expression();this._consume(A.tokens.bracket_right,"Expected ']'.");const e=this._updateNode(new ca(t)),r=this._postfix_expression();return r&&(e.postfix=r),e}if(this._match(A.tokens.period)){const t=this._consume(A.tokens.name,"Expected member name."),e=this._postfix_expression(),r=this._updateNode(new ao(t.lexeme));return e&&(r.postfix=e),r}return null}_getStruct(t){return this._context.aliases.has(t)?this._context.aliases.get(t).type:this._context.structs.has(t)?this._context.structs.get(t):null}_getType(t){const e=this._getStruct(t);if(e!==null)return e;switch(t){case"void":return Z.void;case"bool":return Z.bool;case"i32":return Z.i32;case"u32":return Z.u32;case"f32":return Z.f32;case"f16":return Z.f16;case"vec2f":return W.vec2f;case"vec3f":return W.vec3f;case"vec4f":return W.vec4f;case"vec2i":return W.vec2i;case"vec3i":return W.vec3i;case"vec4i":return W.vec4i;case"vec2u":return W.vec2u;case"vec3u":return W.vec3u;case"vec4u":return W.vec4u;case"vec2h":return W.vec2h;case"vec3h":return W.vec3h;case"vec4h":return W.vec4h;case"mat2x2f":return W.mat2x2f;case"mat2x3f":return W.mat2x3f;case"mat2x4f":return W.mat2x4f;case"mat3x2f":return W.mat3x2f;case"mat3x3f":return W.mat3x3f;case"mat3x4f":return W.mat3x4f;case"mat4x2f":return W.mat4x2f;case"mat4x3f":return W.mat4x3f;case"mat4x4f":return W.mat4x4f;case"mat2x2h":return W.mat2x2h;case"mat2x3h":return W.mat2x3h;case"mat2x4h":return W.mat2x4h;case"mat3x2h":return W.mat3x2h;case"mat3x3h":return W.mat3x3h;case"mat3x4h":return W.mat3x4h;case"mat4x2h":return W.mat4x2h;case"mat4x3h":return W.mat4x3h;case"mat4x4h":return W.mat4x4h;case"mat2x2i":return W.mat2x2i;case"mat2x3i":return W.mat2x3i;case"mat2x4i":return W.mat2x4i;case"mat3x2i":return W.mat3x2i;case"mat3x3i":return W.mat3x3i;case"mat3x4i":return W.mat3x4i;case"mat4x2i":return W.mat4x2i;case"mat4x3i":return W.mat4x3i;case"mat4x4i":return W.mat4x4i;case"mat2x2u":return W.mat2x2u;case"mat2x3u":return W.mat2x3u;case"mat2x4u":return W.mat2x4u;case"mat3x2u":return W.mat3x2u;case"mat3x3u":return W.mat3x3u;case"mat3x4u":return W.mat3x4u;case"mat4x2u":return W.mat4x2u;case"mat4x3u":return W.mat4x3u;case"mat4x4u":return W.mat4x4u}return null}_validateTypeRange(t,e){if(e.name==="i32"){if(t<-2147483648||t>2147483647)throw this._error(this._previous(),`Value out of range for i32: ${t}. Line: ${this._currentLine}.`)}else if(e.name==="u32"&&(t<0||t>4294967295))throw this._error(this._previous(),`Value out of range for u32: ${t}. Line: ${this._currentLine}.`)}_primary_expression(){if(this._match(A.tokens.ident)){const r=this._previous().toString();if(this._check(A.tokens.paren_left)){const i=this._argument_expression_list(),s=this._getType(r);return s!==null?this._updateNode(new yi(s,i)):this._updateNode(new Op(r,i))}if(this._context.constants.has(r)){const i=this._context.constants.get(r);return this._updateNode(new ab(r,i.value))}return this._updateNode(new Zn(r))}if(this._match(A.tokens.int_literal)){const r=this._previous().toString();let i=r.endsWith("i")||r.endsWith("i")?Z.i32:r.endsWith("u")||r.endsWith("U")?Z.u32:Z.x32;const s=parseInt(r);return this._validateTypeRange(s,i),this._updateNode(new Be(new F(s,this._exec.getTypeInfo(i)),i))}if(this._match(A.tokens.uint_literal)){const r=parseInt(this._previous().toString());return this._validateTypeRange(r,Z.u32),this._updateNode(new Be(new F(r,this._exec.getTypeInfo(Z.u32)),Z.u32))}if(this._match([A.tokens.decimal_float_literal,A.tokens.hex_float_literal])){let r=this._previous().toString(),i=r.endsWith("h");i&&(r=r.substring(0,r.length-1));const s=parseFloat(r);this._validateTypeRange(s,i?Z.f16:Z.f32);const o=i?Z.f16:Z.f32;return this._updateNode(new Be(new F(s,this._exec.getTypeInfo(o)),o))}if(this._match([A.keywords.true,A.keywords.false])){let r=this._previous().toString()===A.keywords.true.rule;return this._updateNode(new Be(new F(r?1:0,this._exec.getTypeInfo(Z.bool)),Z.bool))}if(this._check(A.tokens.paren_left))return this._paren_expression();if(this._match(A.keywords.bitcast)){this._consume(A.tokens.less_than,"Expected '<'.");const r=this._type_decl();this._consume(A.tokens.greater_than,"Expected '>'.");const i=this._paren_expression();return this._updateNode(new lb(r,i))}const t=this._type_decl(),e=this._argument_expression_list();return this._updateNode(new yi(t,e))}_argument_expression_list(){if(!this._match(A.tokens.paren_left))return null;const t=[];do{if(this._check(A.tokens.paren_right))break;const e=this._short_circuit_or_expression();t.push(e)}while(this._match(A.tokens.comma));return this._consume(A.tokens.paren_right,"Expected ')' for agument list"),t}_optional_paren_expression(){this._match(A.tokens.paren_left);const t=this._short_circuit_or_expression();return this._match(A.tokens.paren_right),t}_paren_expression(){this._consume(A.tokens.paren_left,"Expected '('.");const t=this._short_circuit_or_expression();return this._consume(A.tokens.paren_right,"Expected ')'."),t}_struct_decl(){if(!this._match(A.keywords.struct))return null;const t=this._currentLine,e=this._consume(A.tokens.ident,"Expected name for struct.").toString();this._consume(A.tokens.brace_left,"Expected '{' for struct body.");const r=[];for(;!this._check(A.tokens.brace_right);){const o=this._attribute(),a=this._consume(A.tokens.name,"Expected variable name.").toString();this._consume(A.tokens.colon,"Expected ':' for struct member type.");const l=this._attribute(),c=this._type_decl();c!=null&&(c.attributes=l),this._check(A.tokens.brace_right)?this._match(A.tokens.comma):this._consume(A.tokens.comma,"Expected ',' for struct member."),r.push(this._updateNode(new Am(a,c,o)))}this._consume(A.tokens.brace_right,"Expected '}' after struct body.");const i=this._currentLine,s=this._updateNode(new zi(e,r,t,i),t);return this._context.structs.set(e,s),s}_global_variable_decl(){const t=this._variable_decl();if(!t)return null;if(this._match(A.tokens.equal)){const e=this._const_expression();t.value=e}if(t.type!==null&&t.value instanceof Be){if(t.value.type.name!=="x32"&&t.type.getTypeName()!==t.value.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${t.value.type.name} to ${t.type.name}. Line:${this._currentLine}`);t.value.isScalar&&this._validateTypeRange(t.value.scalarValue,t.type),t.value.type=t.type}else t.type===null&&t.value instanceof Be&&(t.type=t.value.type.name==="x32"?Z.i32:t.value.type,t.value.isScalar&&this._validateTypeRange(t.value.scalarValue,t.type));return t}_override_variable_decl(){const t=this._override_decl();return t&&this._match(A.tokens.equal)&&(t.value=this._const_expression()),t}_global_const_decl(){var t;if(!this._match(A.keywords.const))return null;const e=this._consume(A.tokens.name,"Expected variable name"),r=this._currentLine;let i=null;if(this._match(A.tokens.colon)){const l=this._attribute();i=this._type_decl(),i!=null&&(i.attributes=l)}let s=null;this._consume(A.tokens.equal,"const declarations require an assignment");const o=this._short_circuit_or_expression();try{let l=[Z.f32],c=o.constEvaluate(this._exec,l);c instanceof F&&this._validateTypeRange(c.value,l[0]),l[0]instanceof W&&l[0].format===null&&c.typeInfo instanceof oo&&c.typeInfo.format!==null&&(c.typeInfo.format.name==="f16"?l[0].format=Z.f16:c.typeInfo.format.name==="f32"?l[0].format=Z.f32:c.typeInfo.format.name==="i32"?l[0].format=Z.i32:c.typeInfo.format.name==="u32"?l[0].format=Z.u32:c.typeInfo.format.name==="bool"?l[0].format=Z.bool:console.error(`TODO: impelement template format type ${c.typeInfo.format.name}`)),s=this._updateNode(new Be(c,l[0])),this._exec.context.setVariable(e.toString(),c)}catch{s=o}if(i!==null&&s instanceof Be){if(s.type.name!=="x32"&&i.getTypeName()!==s.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${s.type.name} to ${i.name}. Line:${this._currentLine}`);s.type=i,s.isScalar&&this._validateTypeRange(s.scalarValue,s.type)}else i===null&&s instanceof Be&&(i=(t=s?.type)!==null&&t!==void 0?t:Z.f32,i===Z.x32&&(i=Z.i32));const a=this._updateNode(new eu(e.toString(),i,"","",s),r);return this._context.constants.set(a.name,a),a}_global_let_decl(){if(!this._match(A.keywords.let))return null;const t=this._currentLine,e=this._consume(A.tokens.name,"Expected variable name");let r=null;if(this._match(A.tokens.colon)){const s=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=s)}let i=null;if(this._match(A.tokens.equal)&&(i=this._const_expression()),r!==null&&i instanceof Be){if(i.type.name!=="x32"&&r.getTypeName()!==i.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${i.type.name} to ${r.name}. Line:${this._currentLine}`);i.type=r}else r===null&&i instanceof Be&&(r=i.type.name==="x32"?Z.i32:i.type);return i instanceof Be&&i.isScalar&&this._validateTypeRange(i.scalarValue,r),this._updateNode(new bl(e.toString(),r,"","",i),t)}_const_expression(){return this._short_circuit_or_expression()}_variable_decl(){if(!this._match(A.keywords.var))return null;const t=this._currentLine;let e="",r="";this._match(A.tokens.less_than)&&(e=this._consume(A.storage_class,"Expected storage_class.").toString(),this._match(A.tokens.comma)&&(r=this._consume(A.access_mode,"Expected access_mode.").toString()),this._consume(A.tokens.greater_than,"Expected '>'."));const i=this._consume(A.tokens.name,"Expected variable name");let s=null;if(this._match(A.tokens.colon)){const o=this._attribute();s=this._type_decl(),s!=null&&(s.attributes=o)}return this._updateNode(new Wi(i.toString(),s,e,r,null),t)}_override_decl(){if(!this._match(A.keywords.override))return null;const t=this._consume(A.tokens.name,"Expected variable name");let e=null;if(this._match(A.tokens.colon)){const r=this._attribute();e=this._type_decl(),e!=null&&(e.attributes=r)}return this._updateNode(new Mp(t.toString(),e,null))}_diagnostic(){this._consume(A.tokens.paren_left,"Expected '('");const t=this._consume(A.tokens.ident,"Expected severity control name.");this._consume(A.tokens.comma,"Expected ','");let e=this._consume(A.tokens.ident,"Expected diagnostic rule name.").toString();return this._match(A.tokens.period)&&(e+=`.${this._consume(A.tokens.ident,"Expected diagnostic message.").toString()}`),this._consume(A.tokens.paren_right,"Expected ')'"),this._updateNode(new ib(t.toString(),e))}_enable_directive(){const t=this._consume(A.tokens.ident,"identity expected.");return this._updateNode(new VP(t.toString()))}_requires_directive(){const t=[this._consume(A.tokens.ident,"identity expected.").toString()];for(;this._match(A.tokens.comma);){const e=this._consume(A.tokens.ident,"identity expected.");t.push(e.toString())}return this._updateNode(new zP(t))}_type_alias(){const t=this._consume(A.tokens.ident,"identity expected.");this._consume(A.tokens.equal,"Expected '=' for type alias.");let e=this._type_decl();if(e===null)throw this._error(this._peek(),"Expected Type for Alias.");this._context.aliases.has(e.name)&&(e=this._context.aliases.get(e.name).type);const r=this._updateNode(new Np(t.toString(),e));return this._context.aliases.set(r.name,r),r}_type_decl(){if(this._check([A.tokens.ident,...A.texel_format,A.keywords.bool,A.keywords.f32,A.keywords.i32,A.keywords.u32])){const r=this._advance().toString();if(this._context.structs.has(r))return this._context.structs.get(r);if(this._context.aliases.has(r))return this._context.aliases.get(r).type;if(!this._getType(r)){const i=this._updateNode(new Pm(r));return this._forwardTypeCount++,i}return this._updateNode(new Z(r))}let t=this._texture_sampler_types();if(t)return t;if(this._check(A.template_types)){let r=this._advance().toString(),i=null,s=null;return this._match(A.tokens.less_than)&&(i=this._type_decl(),s=null,this._match(A.tokens.comma)&&(s=this._consume(A.access_mode,"Expected access_mode for pointer").toString()),this._consume(A.tokens.greater_than,"Expected '>' for type.")),this._updateNode(new W(r,i,s))}if(this._match(A.keywords.ptr)){let r=this._previous().toString();this._consume(A.tokens.less_than,"Expected '<' for pointer.");const i=this._consume(A.storage_class,"Expected storage_class for pointer");this._consume(A.tokens.comma,"Expected ',' for pointer.");const s=this._type_decl();let o=null;return this._match(A.tokens.comma)&&(o=this._consume(A.access_mode,"Expected access_mode for pointer").toString()),this._consume(A.tokens.greater_than,"Expected '>' for pointer."),this._updateNode(new ru(r,i.toString(),s,o))}const e=this._attribute();if(this._match(A.keywords.array)){let r=null,i=-1;const s=this._previous();let o=null;if(this._match(A.tokens.less_than)){r=this._type_decl(),this._context.aliases.has(r.name)&&(r=this._context.aliases.get(r.name).type);let l="";if(this._match(A.tokens.comma)){o=this._shift_expression();try{l=o.constEvaluate(this._exec).toString(),o=null}catch{l="1"}}this._consume(A.tokens.greater_than,"Expected '>' for array."),i=l?parseInt(l):0}const a=this._updateNode(new xl(s.toString(),e,r,i));return o&&this._deferArrayCountEval.push({arrayType:a,countNode:o}),a}return null}_texture_sampler_types(){if(this._match(A.sampler_type))return this._updateNode(new ll(this._previous().toString(),null,null));if(this._match(A.depth_texture_type))return this._updateNode(new ll(this._previous().toString(),null,null));if(this._match(A.sampled_texture_type)||this._match(A.multisampled_texture_type)){const t=this._previous();this._consume(A.tokens.less_than,"Expected '<' for sampler type.");const e=this._type_decl();return this._consume(A.tokens.greater_than,"Expected '>' for sampler type."),this._updateNode(new ll(t.toString(),e,null))}if(this._match(A.storage_texture_type)){const t=this._previous();this._consume(A.tokens.less_than,"Expected '<' for sampler type.");const e=this._consume(A.texel_format,"Invalid texel format.").toString();this._consume(A.tokens.comma,"Expected ',' after texel format.");const r=this._consume(A.access_mode,"Expected access mode for storage texture type.").toString();return this._consume(A.tokens.greater_than,"Expected '>' for sampler type."),this._updateNode(new ll(t.toString(),e,r))}return null}_attribute(){let t=[];for(;this._match(A.tokens.attr);){const e=this._consume(A.attribute_name,"Expected attribute name"),r=this._updateNode(new db(e.toString(),null));if(this._match(A.tokens.paren_left)){if(r.value=this._consume(A.literal_or_ident,"Expected attribute value").toString(),this._check(A.tokens.comma)){this._advance();do{const i=this._consume(A.literal_or_ident,"Expected attribute value").toString();r.value instanceof Array||(r.value=[r.value]),r.value.push(i)}while(this._match(A.tokens.comma))}this._consume(A.tokens.paren_right,"Expected ')'")}t.push(r)}return t.length==0?null:t}}class iI extends xi{constructor(t){super(),t&&this.update(t)}update(t){const e=new rI().parse(t);this.updateAST(e)}}function sI(n){const t={attributes:[],bindings:[]};let e;try{e=oI(n)}catch(s){return tt.error(s.message)(),t}for(const s of e.uniforms){const o=[];for(const a of s.type?.members||[])o.push({name:a.name,type:Nm(a.type)});t.bindings.push({type:"uniform",name:s.name,group:s.group,location:s.binding,members:o})}for(const s of e.textures)t.bindings.push({type:"texture",name:s.name,group:s.group,location:s.binding});for(const s of e.samplers)t.bindings.push({type:"sampler",name:s.name,group:s.group,location:s.binding});const r=e.entry.vertex[0],i=r?.inputs.length||0;for(let s=0;s<i;s++){const o=r.inputs[s];if(o.locationType==="location"){const a=Nm(o.type);t.attributes.push({name:o.name,location:Number(o.location),type:a})}}return t}function Nm(n){return n.format?`${n.name}<${n.format.name}>`:n.name}function oI(n){try{return new iI(n)}catch(t){if(t instanceof Error)throw t;let e="WGSL parse error";throw typeof t=="object"&&t?.message&&(e+=`: ${t.message} `),typeof t=="object"&&t?.token&&(e+=t.token.line||""),new Error(e,{cause:t})}}const aI={EPSILON:1e-12,debug:!1,precision:4,printTypes:!1,printDegrees:!1,printRowMajor:!0,_cartographicRadians:!1};globalThis.mathgl=globalThis.mathgl||{config:{...aI}};const Vn=globalThis.mathgl.config;function lI(n,{precision:t=Vn.precision}={}){return n=cI(n),`${parseFloat(n.toPrecision(t))}`}function lo(n){return Array.isArray(n)||ArrayBuffer.isView(n)&&!(n instanceof DataView)}function ms(n,t,e){return hI(n,r=>Math.max(t,Math.min(e,r)))}function Fu(n,t,e){return lo(n)?n.map((r,i)=>Fu(r,t[i],e)):e*t+(1-e)*n}function Al(n,t,e){const r=Vn.EPSILON;try{if(n===t)return!0;if(lo(n)&&lo(t)){if(n.length!==t.length)return!1;for(let i=0;i<n.length;++i)if(!Al(n[i],t[i]))return!1;return!0}return n&&n.equals?n.equals(t):t&&t.equals?t.equals(n):typeof n=="number"&&typeof t=="number"?Math.abs(n-t)<=Vn.EPSILON*Math.max(1,Math.abs(n),Math.abs(t)):!1}finally{Vn.EPSILON=r}}function cI(n){return Math.round(n/Vn.EPSILON)*Vn.EPSILON}function uI(n){return n.clone?n.clone():new Array(n.length)}function hI(n,t,e){if(lo(n)){const r=n;e=e||uI(r);for(let i=0;i<e.length&&i<r.length;++i){const s=typeof n=="number"?n:n[i];e[i]=t(s,i,e)}return e}return t(n)}class mb extends Array{clone(){return new this.constructor().copy(this)}fromArray(t,e=0){for(let r=0;r<this.ELEMENTS;++r)this[r]=t[r+e];return this.check()}toArray(t=[],e=0){for(let r=0;r<this.ELEMENTS;++r)t[e+r]=this[r];return t}toObject(t){return t}from(t){return Array.isArray(t)?this.copy(t):this.fromObject(t)}to(t){return t===this?this:lo(t)?this.toArray(t):this.toObject(t)}toTarget(t){return t?this.to(t):this}toFloat32Array(){return new Float32Array(this)}toString(){return this.formatString(Vn)}formatString(t){let e="";for(let r=0;r<this.ELEMENTS;++r)e+=(r>0?", ":"")+lI(this[r],t);return`${t.printTypes?this.constructor.name:""}[${e}]`}equals(t){if(!t||this.length!==t.length)return!1;for(let e=0;e<this.ELEMENTS;++e)if(!Al(this[e],t[e]))return!1;return!0}exactEquals(t){if(!t||this.length!==t.length)return!1;for(let e=0;e<this.ELEMENTS;++e)if(this[e]!==t[e])return!1;return!0}negate(){for(let t=0;t<this.ELEMENTS;++t)this[t]=-this[t];return this.check()}lerp(t,e,r){if(r===void 0)return this.lerp(this,t,e);for(let i=0;i<this.ELEMENTS;++i){const s=t[i],o=typeof e=="number"?e:e[i];this[i]=s+r*(o-s)}return this.check()}min(t){for(let e=0;e<this.ELEMENTS;++e)this[e]=Math.min(t[e],this[e]);return this.check()}max(t){for(let e=0;e<this.ELEMENTS;++e)this[e]=Math.max(t[e],this[e]);return this.check()}clamp(t,e){for(let r=0;r<this.ELEMENTS;++r)this[r]=Math.min(Math.max(this[r],t[r]),e[r]);return this.check()}add(...t){for(const e of t)for(let r=0;r<this.ELEMENTS;++r)this[r]+=e[r];return this.check()}subtract(...t){for(const e of t)for(let r=0;r<this.ELEMENTS;++r)this[r]-=e[r];return this.check()}scale(t){if(typeof t=="number")for(let e=0;e<this.ELEMENTS;++e)this[e]*=t;else for(let e=0;e<this.ELEMENTS&&e<t.length;++e)this[e]*=t[e];return this.check()}multiplyByScalar(t){for(let e=0;e<this.ELEMENTS;++e)this[e]*=t;return this.check()}check(){if(Vn.debug&&!this.validate())throw new Error(`math.gl: ${this.constructor.name} some fields set to invalid numbers'`);return this}validate(){let t=this.length===this.ELEMENTS;for(let e=0;e<this.ELEMENTS;++e)t=t&&Number.isFinite(this[e]);return t}sub(t){return this.subtract(t)}setScalar(t){for(let e=0;e<this.ELEMENTS;++e)this[e]=t;return this.check()}addScalar(t){for(let e=0;e<this.ELEMENTS;++e)this[e]+=t;return this.check()}subScalar(t){return this.addScalar(-t)}multiplyScalar(t){for(let e=0;e<this.ELEMENTS;++e)this[e]*=t;return this.check()}divideScalar(t){return this.multiplyByScalar(1/t)}clampScalar(t,e){for(let r=0;r<this.ELEMENTS;++r)this[r]=Math.min(Math.max(this[r],t),e);return this.check()}get elements(){return this}}function fI(n,t){if(n.length!==t)return!1;for(let e=0;e<n.length;++e)if(!Number.isFinite(n[e]))return!1;return!0}function on(n){if(!Number.isFinite(n))throw new Error(`Invalid number ${JSON.stringify(n)}`);return n}function pf(n,t,e=""){if(Vn.debug&&!fI(n,t))throw new Error(`math.gl: ${e} some fields set to invalid numbers'`);return n}function Om(n,t){if(!n)throw new Error(`math.gl assertion ${t}`)}class _b extends mb{get x(){return this[0]}set x(t){this[0]=on(t)}get y(){return this[1]}set y(t){this[1]=on(t)}len(){return Math.sqrt(this.lengthSquared())}magnitude(){return this.len()}lengthSquared(){let t=0;for(let e=0;e<this.ELEMENTS;++e)t+=this[e]*this[e];return t}magnitudeSquared(){return this.lengthSquared()}distance(t){return Math.sqrt(this.distanceSquared(t))}distanceSquared(t){let e=0;for(let r=0;r<this.ELEMENTS;++r){const i=this[r]-t[r];e+=i*i}return on(e)}dot(t){let e=0;for(let r=0;r<this.ELEMENTS;++r)e+=this[r]*t[r];return on(e)}normalize(){const t=this.magnitude();if(t!==0)for(let e=0;e<this.ELEMENTS;++e)this[e]/=t;return this.check()}multiply(...t){for(const e of t)for(let r=0;r<this.ELEMENTS;++r)this[r]*=e[r];return this.check()}divide(...t){for(const e of t)for(let r=0;r<this.ELEMENTS;++r)this[r]/=e[r];return this.check()}lengthSq(){return this.lengthSquared()}distanceTo(t){return this.distance(t)}distanceToSquared(t){return this.distanceSquared(t)}getComponent(t){return Om(t>=0&&t<this.ELEMENTS,"index is out of range"),on(this[t])}setComponent(t,e){return Om(t>=0&&t<this.ELEMENTS,"index is out of range"),this[t]=e,this.check()}addVectors(t,e){return this.copy(t).add(e)}subVectors(t,e){return this.copy(t).subtract(e)}multiplyVectors(t,e){return this.copy(t).multiply(e)}addScaledVector(t,e){return this.add(new this.constructor(t).multiplyScalar(e))}}const ou=1e-6;let ua=typeof Float32Array<"u"?Float32Array:Array;function dI(){const n=new ua(2);return ua!=Float32Array&&(n[0]=0,n[1]=0),n}function Dm(n,t,e){return n[0]=t[0]+e[0],n[1]=t[1]+e[1],n}function pI(n,t){return n[0]=-t[0],n[1]=-t[1],n}function yb(n,t,e,r){const i=t[0],s=t[1];return n[0]=i+r*(e[0]-i),n[1]=s+r*(e[1]-s),n}function gI(n,t,e){const r=t[0],i=t[1];return n[0]=e[0]*r+e[2]*i,n[1]=e[1]*r+e[3]*i,n}function mI(n,t,e){const r=t[0],i=t[1];return n[0]=e[0]*r+e[2]*i+e[4],n[1]=e[1]*r+e[3]*i+e[5],n}function _I(n,t,e){const r=t[0],i=t[1];return n[0]=e[0]*r+e[3]*i+e[6],n[1]=e[1]*r+e[4]*i+e[7],n}function vb(n,t,e){const r=t[0],i=t[1];return n[0]=e[0]*r+e[4]*i+e[12],n[1]=e[1]*r+e[5]*i+e[13],n}(function(){const n=dI();return function(t,e,r,i,s,o){let a,l;for(e||(e=2),r||(r=0),i?l=Math.min(i*e+r,t.length):l=t.length,a=r;a<l;a+=e)n[0]=t[a],n[1]=t[a+1],s(n,n,o),t[a]=n[0],t[a+1]=n[1];return t}})();function bb(n,t,e){const r=t[0],i=t[1],s=e[3]*r+e[7]*i||1;return n[0]=(e[0]*r+e[4]*i)/s,n[1]=(e[1]*r+e[5]*i)/s,n}function xb(n,t,e){const r=t[0],i=t[1],s=t[2],o=e[3]*r+e[7]*i+e[11]*s||1;return n[0]=(e[0]*r+e[4]*i+e[8]*s)/o,n[1]=(e[1]*r+e[5]*i+e[9]*s)/o,n[2]=(e[2]*r+e[6]*i+e[10]*s)/o,n}function yI(n,t,e){const r=t[0],i=t[1];return n[0]=e[0]*r+e[2]*i,n[1]=e[1]*r+e[3]*i,n[2]=t[2],n}class gf extends _b{constructor(t=0,e=0){super(2),lo(t)&&arguments.length===1?this.copy(t):(Vn.debug&&(on(t),on(e)),this[0]=t,this[1]=e)}set(t,e){return this[0]=t,this[1]=e,this.check()}copy(t){return this[0]=t[0],this[1]=t[1],this.check()}fromObject(t){return Vn.debug&&(on(t.x),on(t.y)),this[0]=t.x,this[1]=t.y,this.check()}toObject(t){return t.x=this[0],t.y=this[1],t}get ELEMENTS(){return 2}horizontalAngle(){return Math.atan2(this.y,this.x)}verticalAngle(){return Math.atan2(this.x,this.y)}transform(t){return this.transformAsPoint(t)}transformAsPoint(t){return vb(this,this,t),this.check()}transformAsVector(t){return bb(this,this,t),this.check()}transformByMatrix3(t){return _I(this,this,t),this.check()}transformByMatrix2x3(t){return mI(this,this,t),this.check()}transformByMatrix2(t){return gI(this,this,t),this.check()}}function vI(){const n=new ua(3);return ua!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n}function bI(n,t,e){return n[0]=t[0]-e[0],n[1]=t[1]-e[1],n[2]=t[2]-e[2],n}function xI(n,t){const e=t[0]-n[0],r=t[1]-n[1],i=t[2]-n[2];return Math.sqrt(e*e+r*r+i*i)}function EI(n,t){return n[0]=-t[0],n[1]=-t[1],n[2]=-t[2],n}function wI(n,t){return n[0]*t[0]+n[1]*t[1]+n[2]*t[2]}function SI(n,t,e){const r=t[0],i=t[1],s=t[2],o=e[0],a=e[1],l=e[2];return n[0]=i*l-s*a,n[1]=s*o-r*l,n[2]=r*a-i*o,n}function Eb(n,t,e){const r=t[0],i=t[1],s=t[2];let o=e[3]*r+e[7]*i+e[11]*s+e[15];return o=o||1,n[0]=(e[0]*r+e[4]*i+e[8]*s+e[12])/o,n[1]=(e[1]*r+e[5]*i+e[9]*s+e[13])/o,n[2]=(e[2]*r+e[6]*i+e[10]*s+e[14])/o,n}function CI(n,t,e){const r=t[0],i=t[1],s=t[2];return n[0]=r*e[0]+i*e[3]+s*e[6],n[1]=r*e[1]+i*e[4]+s*e[7],n[2]=r*e[2]+i*e[5]+s*e[8],n}function TI(n,t,e){const r=e[0],i=e[1],s=e[2],o=e[3],a=t[0],l=t[1],c=t[2];let u=i*c-s*l,h=s*a-r*c,f=r*l-i*a,d=i*f-s*h,p=s*u-r*f,_=r*h-i*u;const v=o*2;return u*=v,h*=v,f*=v,d*=2,p*=2,_*=2,n[0]=a+u+d,n[1]=l+h+p,n[2]=c+f+_,n}function PI(n,t,e,r){const i=[],s=[];return i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],s[0]=i[0],s[1]=i[1]*Math.cos(r)-i[2]*Math.sin(r),s[2]=i[1]*Math.sin(r)+i[2]*Math.cos(r),n[0]=s[0]+e[0],n[1]=s[1]+e[1],n[2]=s[2]+e[2],n}function II(n,t,e,r){const i=[],s=[];return i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],s[0]=i[2]*Math.sin(r)+i[0]*Math.cos(r),s[1]=i[1],s[2]=i[2]*Math.cos(r)-i[0]*Math.sin(r),n[0]=s[0]+e[0],n[1]=s[1]+e[1],n[2]=s[2]+e[2],n}function AI(n,t,e,r){const i=[],s=[];return i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],s[0]=i[0]*Math.cos(r)-i[1]*Math.sin(r),s[1]=i[0]*Math.sin(r)+i[1]*Math.cos(r),s[2]=i[2],n[0]=s[0]+e[0],n[1]=s[1]+e[1],n[2]=s[2]+e[2],n}function MI(n,t){const e=n[0],r=n[1],i=n[2],s=t[0],o=t[1],a=t[2],l=Math.sqrt((e*e+r*r+i*i)*(s*s+o*o+a*a)),c=l&&wI(n,t)/l;return Math.acos(Math.min(Math.max(c,-1),1))}const RI=bI,NI=xI;(function(){const n=vI();return function(t,e,r,i,s,o){let a,l;for(e||(e=3),r||(r=0),i?l=Math.min(i*e+r,t.length):l=t.length,a=r;a<l;a+=e)n[0]=t[a],n[1]=t[a+1],n[2]=t[a+2],s(n,n,o),t[a]=n[0],t[a+1]=n[1],t[a+2]=n[2];return t}})();const mf=[0,0,0];let Rc;class Ti extends _b{static get ZERO(){return Rc||(Rc=new Ti(0,0,0),Object.freeze(Rc)),Rc}constructor(t=0,e=0,r=0){super(-0,-0,-0),arguments.length===1&&lo(t)?this.copy(t):(Vn.debug&&(on(t),on(e),on(r)),this[0]=t,this[1]=e,this[2]=r)}set(t,e,r){return this[0]=t,this[1]=e,this[2]=r,this.check()}copy(t){return this[0]=t[0],this[1]=t[1],this[2]=t[2],this.check()}fromObject(t){return Vn.debug&&(on(t.x),on(t.y),on(t.z)),this[0]=t.x,this[1]=t.y,this[2]=t.z,this.check()}toObject(t){return t.x=this[0],t.y=this[1],t.z=this[2],t}get ELEMENTS(){return 3}get z(){return this[2]}set z(t){this[2]=on(t)}angle(t){return MI(this,t)}cross(t){return SI(this,this,t),this.check()}rotateX({radians:t,origin:e=mf}){return PI(this,this,e,t),this.check()}rotateY({radians:t,origin:e=mf}){return II(this,this,e,t),this.check()}rotateZ({radians:t,origin:e=mf}){return AI(this,this,e,t),this.check()}transform(t){return this.transformAsPoint(t)}transformAsPoint(t){return Eb(this,this,t),this.check()}transformAsVector(t){return xb(this,this,t),this.check()}transformByMatrix3(t){return CI(this,this,t),this.check()}transformByMatrix2(t){return yI(this,this,t),this.check()}transformByQuaternion(t){return TI(this,this,t),this.check()}}class OI extends mb{toString(){let t="[";if(Vn.printRowMajor){t+="row-major:";for(let e=0;e<this.RANK;++e)for(let r=0;r<this.RANK;++r)t+=` ${this[r*this.RANK+e]}`}else{t+="column-major:";for(let e=0;e<this.ELEMENTS;++e)t+=` ${this[e]}`}return t+="]",t}getElementIndex(t,e){return e*this.RANK+t}getElement(t,e){return this[e*this.RANK+t]}setElement(t,e,r){return this[e*this.RANK+t]=on(r),this}getColumn(t,e=new Array(this.RANK).fill(-0)){const r=t*this.RANK;for(let i=0;i<this.RANK;++i)e[i]=this[r+i];return e}setColumn(t,e){const r=t*this.RANK;for(let i=0;i<this.RANK;++i)this[r+i]=e[i];return this}}function DI(n){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function LI(n,t){if(n===t){const e=t[1],r=t[2],i=t[3],s=t[6],o=t[7],a=t[11];n[1]=t[4],n[2]=t[8],n[3]=t[12],n[4]=e,n[6]=t[9],n[7]=t[13],n[8]=r,n[9]=s,n[11]=t[14],n[12]=i,n[13]=o,n[14]=a}else n[0]=t[0],n[1]=t[4],n[2]=t[8],n[3]=t[12],n[4]=t[1],n[5]=t[5],n[6]=t[9],n[7]=t[13],n[8]=t[2],n[9]=t[6],n[10]=t[10],n[11]=t[14],n[12]=t[3],n[13]=t[7],n[14]=t[11],n[15]=t[15];return n}function _d(n,t){const e=t[0],r=t[1],i=t[2],s=t[3],o=t[4],a=t[5],l=t[6],c=t[7],u=t[8],h=t[9],f=t[10],d=t[11],p=t[12],_=t[13],v=t[14],E=t[15],m=e*a-r*o,g=e*l-i*o,y=e*c-s*o,b=r*l-i*a,x=r*c-s*a,w=i*c-s*l,S=u*_-h*p,I=u*v-f*p,T=u*E-d*p,M=h*v-f*_,L=h*E-d*_,O=f*E-d*v;let P=m*O-g*L+y*M+b*T-x*I+w*S;return P?(P=1/P,n[0]=(a*O-l*L+c*M)*P,n[1]=(i*L-r*O-s*M)*P,n[2]=(_*w-v*x+E*b)*P,n[3]=(f*x-h*w-d*b)*P,n[4]=(l*T-o*O-c*I)*P,n[5]=(e*O-i*T+s*I)*P,n[6]=(v*y-p*w-E*g)*P,n[7]=(u*w-f*y+d*g)*P,n[8]=(o*L-a*T+c*S)*P,n[9]=(r*T-e*L-s*S)*P,n[10]=(p*x-_*y+E*m)*P,n[11]=(h*y-u*x-d*m)*P,n[12]=(a*I-o*M-l*S)*P,n[13]=(e*M-r*I+i*S)*P,n[14]=(_*g-p*b-v*m)*P,n[15]=(u*b-h*g+f*m)*P,n):null}function kI(n){const t=n[0],e=n[1],r=n[2],i=n[3],s=n[4],o=n[5],a=n[6],l=n[7],c=n[8],u=n[9],h=n[10],f=n[11],d=n[12],p=n[13],_=n[14],v=n[15],E=t*o-e*s,m=t*a-r*s,g=e*a-r*o,y=c*p-u*d,b=c*_-h*d,x=u*_-h*p,w=t*x-e*b+r*y,S=s*x-o*b+a*y,I=c*g-u*m+h*E,T=d*g-p*m+_*E;return l*w-i*S+v*I-f*T}function eo(n,t,e){const r=t[0],i=t[1],s=t[2],o=t[3],a=t[4],l=t[5],c=t[6],u=t[7],h=t[8],f=t[9],d=t[10],p=t[11],_=t[12],v=t[13],E=t[14],m=t[15];let g=e[0],y=e[1],b=e[2],x=e[3];return n[0]=g*r+y*a+b*h+x*_,n[1]=g*i+y*l+b*f+x*v,n[2]=g*s+y*c+b*d+x*E,n[3]=g*o+y*u+b*p+x*m,g=e[4],y=e[5],b=e[6],x=e[7],n[4]=g*r+y*a+b*h+x*_,n[5]=g*i+y*l+b*f+x*v,n[6]=g*s+y*c+b*d+x*E,n[7]=g*o+y*u+b*p+x*m,g=e[8],y=e[9],b=e[10],x=e[11],n[8]=g*r+y*a+b*h+x*_,n[9]=g*i+y*l+b*f+x*v,n[10]=g*s+y*c+b*d+x*E,n[11]=g*o+y*u+b*p+x*m,g=e[12],y=e[13],b=e[14],x=e[15],n[12]=g*r+y*a+b*h+x*_,n[13]=g*i+y*l+b*f+x*v,n[14]=g*s+y*c+b*d+x*E,n[15]=g*o+y*u+b*p+x*m,n}function Bu(n,t,e){const r=e[0],i=e[1],s=e[2];let o,a,l,c,u,h,f,d,p,_,v,E;return t===n?(n[12]=t[0]*r+t[4]*i+t[8]*s+t[12],n[13]=t[1]*r+t[5]*i+t[9]*s+t[13],n[14]=t[2]*r+t[6]*i+t[10]*s+t[14],n[15]=t[3]*r+t[7]*i+t[11]*s+t[15]):(o=t[0],a=t[1],l=t[2],c=t[3],u=t[4],h=t[5],f=t[6],d=t[7],p=t[8],_=t[9],v=t[10],E=t[11],n[0]=o,n[1]=a,n[2]=l,n[3]=c,n[4]=u,n[5]=h,n[6]=f,n[7]=d,n[8]=p,n[9]=_,n[10]=v,n[11]=E,n[12]=o*r+u*i+p*s+t[12],n[13]=a*r+h*i+_*s+t[13],n[14]=l*r+f*i+v*s+t[14],n[15]=c*r+d*i+E*s+t[15]),n}function Fp(n,t,e){const r=e[0],i=e[1],s=e[2];return n[0]=t[0]*r,n[1]=t[1]*r,n[2]=t[2]*r,n[3]=t[3]*r,n[4]=t[4]*i,n[5]=t[5]*i,n[6]=t[6]*i,n[7]=t[7]*i,n[8]=t[8]*s,n[9]=t[9]*s,n[10]=t[10]*s,n[11]=t[11]*s,n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15],n}function FI(n,t,e,r){let i=r[0],s=r[1],o=r[2],a=Math.sqrt(i*i+s*s+o*o),l,c,u,h,f,d,p,_,v,E,m,g,y,b,x,w,S,I,T,M,L,O,P,V;return a<ou?null:(a=1/a,i*=a,s*=a,o*=a,c=Math.sin(e),l=Math.cos(e),u=1-l,h=t[0],f=t[1],d=t[2],p=t[3],_=t[4],v=t[5],E=t[6],m=t[7],g=t[8],y=t[9],b=t[10],x=t[11],w=i*i*u+l,S=s*i*u+o*c,I=o*i*u-s*c,T=i*s*u-o*c,M=s*s*u+l,L=o*s*u+i*c,O=i*o*u+s*c,P=s*o*u-i*c,V=o*o*u+l,n[0]=h*w+_*S+g*I,n[1]=f*w+v*S+y*I,n[2]=d*w+E*S+b*I,n[3]=p*w+m*S+x*I,n[4]=h*T+_*M+g*L,n[5]=f*T+v*M+y*L,n[6]=d*T+E*M+b*L,n[7]=p*T+m*M+x*L,n[8]=h*O+_*P+g*V,n[9]=f*O+v*P+y*V,n[10]=d*O+E*P+b*V,n[11]=p*O+m*P+x*V,t!==n&&(n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n)}function wb(n,t,e){const r=Math.sin(e),i=Math.cos(e),s=t[4],o=t[5],a=t[6],l=t[7],c=t[8],u=t[9],h=t[10],f=t[11];return t!==n&&(n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n[4]=s*i+c*r,n[5]=o*i+u*r,n[6]=a*i+h*r,n[7]=l*i+f*r,n[8]=c*i-s*r,n[9]=u*i-o*r,n[10]=h*i-a*r,n[11]=f*i-l*r,n}function BI(n,t,e){const r=Math.sin(e),i=Math.cos(e),s=t[0],o=t[1],a=t[2],l=t[3],c=t[8],u=t[9],h=t[10],f=t[11];return t!==n&&(n[4]=t[4],n[5]=t[5],n[6]=t[6],n[7]=t[7],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n[0]=s*i-c*r,n[1]=o*i-u*r,n[2]=a*i-h*r,n[3]=l*i-f*r,n[8]=s*r+c*i,n[9]=o*r+u*i,n[10]=a*r+h*i,n[11]=l*r+f*i,n}function Sb(n,t,e){const r=Math.sin(e),i=Math.cos(e),s=t[0],o=t[1],a=t[2],l=t[3],c=t[4],u=t[5],h=t[6],f=t[7];return t!==n&&(n[8]=t[8],n[9]=t[9],n[10]=t[10],n[11]=t[11],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n[0]=s*i+c*r,n[1]=o*i+u*r,n[2]=a*i+h*r,n[3]=l*i+f*r,n[4]=c*i-s*r,n[5]=u*i-o*r,n[6]=h*i-a*r,n[7]=f*i-l*r,n}function UI(n,t){const e=t[0],r=t[1],i=t[2],s=t[3],o=e+e,a=r+r,l=i+i,c=e*o,u=r*o,h=r*a,f=i*o,d=i*a,p=i*l,_=s*o,v=s*a,E=s*l;return n[0]=1-h-p,n[1]=u+E,n[2]=f-v,n[3]=0,n[4]=u-E,n[5]=1-c-p,n[6]=d+_,n[7]=0,n[8]=f+v,n[9]=d-_,n[10]=1-c-h,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function VI(n,t,e,r,i,s,o){const a=1/(e-t),l=1/(i-r),c=1/(s-o);return n[0]=s*2*a,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=s*2*l,n[6]=0,n[7]=0,n[8]=(e+t)*a,n[9]=(i+r)*l,n[10]=(o+s)*c,n[11]=-1,n[12]=0,n[13]=0,n[14]=o*s*2*c,n[15]=0,n}function zI(n,t,e,r,i){const s=1/Math.tan(t/2);if(n[0]=s/e,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=s,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=-1,n[12]=0,n[13]=0,n[15]=0,i!=null&&i!==1/0){const o=1/(r-i);n[10]=(i+r)*o,n[14]=2*i*r*o}else n[10]=-1,n[14]=-2*r;return n}const WI=zI;function HI(n,t,e,r,i,s,o){const a=1/(t-e),l=1/(r-i),c=1/(s-o);return n[0]=-2*a,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=-2*l,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=2*c,n[11]=0,n[12]=(t+e)*a,n[13]=(i+r)*l,n[14]=(o+s)*c,n[15]=1,n}const jI=HI;function $I(n,t,e,r){let i,s,o,a,l,c,u,h,f,d;const p=t[0],_=t[1],v=t[2],E=r[0],m=r[1],g=r[2],y=e[0],b=e[1],x=e[2];return Math.abs(p-y)<ou&&Math.abs(_-b)<ou&&Math.abs(v-x)<ou?DI(n):(h=p-y,f=_-b,d=v-x,i=1/Math.sqrt(h*h+f*f+d*d),h*=i,f*=i,d*=i,s=m*d-g*f,o=g*h-E*d,a=E*f-m*h,i=Math.sqrt(s*s+o*o+a*a),i?(i=1/i,s*=i,o*=i,a*=i):(s=0,o=0,a=0),l=f*a-d*o,c=d*s-h*a,u=h*o-f*s,i=Math.sqrt(l*l+c*c+u*u),i?(i=1/i,l*=i,c*=i,u*=i):(l=0,c=0,u=0),n[0]=s,n[1]=l,n[2]=h,n[3]=0,n[4]=o,n[5]=c,n[6]=f,n[7]=0,n[8]=a,n[9]=u,n[10]=d,n[11]=0,n[12]=-(s*p+o*_+a*v),n[13]=-(l*p+c*_+u*v),n[14]=-(h*p+f*_+d*v),n[15]=1,n)}function XI(){const n=new ua(4);return ua!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0,n[3]=0),n}function GI(n,t,e){return n[0]=t[0]*e,n[1]=t[1]*e,n[2]=t[2]*e,n[3]=t[3]*e,n}function ic(n,t,e){const r=t[0],i=t[1],s=t[2],o=t[3];return n[0]=e[0]*r+e[4]*i+e[8]*s+e[12]*o,n[1]=e[1]*r+e[5]*i+e[9]*s+e[13]*o,n[2]=e[2]*r+e[6]*i+e[10]*s+e[14]*o,n[3]=e[3]*r+e[7]*i+e[11]*s+e[15]*o,n}(function(){const n=XI();return function(t,e,r,i,s,o){let a,l;for(e||(e=4),r||(r=0),i?l=Math.min(i*e+r,t.length):l=t.length,a=r;a<l;a+=e)n[0]=t[a],n[1]=t[a+1],n[2]=t[a+2],n[3]=t[a+3],s(n,n,o),t[a]=n[0],t[a+1]=n[1],t[a+2]=n[2],t[a+3]=n[3];return t}})();var yd;(function(n){n[n.COL0ROW0=0]="COL0ROW0",n[n.COL0ROW1=1]="COL0ROW1",n[n.COL0ROW2=2]="COL0ROW2",n[n.COL0ROW3=3]="COL0ROW3",n[n.COL1ROW0=4]="COL1ROW0",n[n.COL1ROW1=5]="COL1ROW1",n[n.COL1ROW2=6]="COL1ROW2",n[n.COL1ROW3=7]="COL1ROW3",n[n.COL2ROW0=8]="COL2ROW0",n[n.COL2ROW1=9]="COL2ROW1",n[n.COL2ROW2=10]="COL2ROW2",n[n.COL2ROW3=11]="COL2ROW3",n[n.COL3ROW0=12]="COL3ROW0",n[n.COL3ROW1=13]="COL3ROW1",n[n.COL3ROW2=14]="COL3ROW2",n[n.COL3ROW3=15]="COL3ROW3"})(yd||(yd={}));const YI=45*Math.PI/180,qI=1,_f=.1,yf=500,KI=Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);class Jr extends OI{static get IDENTITY(){return JI()}static get ZERO(){return ZI()}get ELEMENTS(){return 16}get RANK(){return 4}get INDICES(){return yd}constructor(t){super(-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0),arguments.length===1&&Array.isArray(t)?this.copy(t):this.identity()}copy(t){return this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3],this[4]=t[4],this[5]=t[5],this[6]=t[6],this[7]=t[7],this[8]=t[8],this[9]=t[9],this[10]=t[10],this[11]=t[11],this[12]=t[12],this[13]=t[13],this[14]=t[14],this[15]=t[15],this.check()}set(t,e,r,i,s,o,a,l,c,u,h,f,d,p,_,v){return this[0]=t,this[1]=e,this[2]=r,this[3]=i,this[4]=s,this[5]=o,this[6]=a,this[7]=l,this[8]=c,this[9]=u,this[10]=h,this[11]=f,this[12]=d,this[13]=p,this[14]=_,this[15]=v,this.check()}setRowMajor(t,e,r,i,s,o,a,l,c,u,h,f,d,p,_,v){return this[0]=t,this[1]=s,this[2]=c,this[3]=d,this[4]=e,this[5]=o,this[6]=u,this[7]=p,this[8]=r,this[9]=a,this[10]=h,this[11]=_,this[12]=i,this[13]=l,this[14]=f,this[15]=v,this.check()}toRowMajor(t){return t[0]=this[0],t[1]=this[4],t[2]=this[8],t[3]=this[12],t[4]=this[1],t[5]=this[5],t[6]=this[9],t[7]=this[13],t[8]=this[2],t[9]=this[6],t[10]=this[10],t[11]=this[14],t[12]=this[3],t[13]=this[7],t[14]=this[11],t[15]=this[15],t}identity(){return this.copy(KI)}fromObject(t){return this.check()}fromQuaternion(t){return UI(this,t),this.check()}frustum(t){const{left:e,right:r,bottom:i,top:s,near:o=_f,far:a=yf}=t;return a===1/0?QI(this,e,r,i,s,o):VI(this,e,r,i,s,o,a),this.check()}lookAt(t){const{eye:e,center:r=[0,0,0],up:i=[0,1,0]}=t;return $I(this,e,r,i),this.check()}ortho(t){const{left:e,right:r,bottom:i,top:s,near:o=_f,far:a=yf}=t;return jI(this,e,r,i,s,o,a),this.check()}orthographic(t){const{fovy:e=YI,aspect:r=qI,focalDistance:i=1,near:s=_f,far:o=yf}=t;Lm(e);const a=e/2,l=i*Math.tan(a),c=l*r;return this.ortho({left:-c,right:c,bottom:-l,top:l,near:s,far:o})}perspective(t){const{fovy:e=45*Math.PI/180,aspect:r=1,near:i=.1,far:s=500}=t;return Lm(e),WI(this,e,r,i,s),this.check()}determinant(){return kI(this)}getScale(t=[-0,-0,-0]){return t[0]=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]),t[1]=Math.sqrt(this[4]*this[4]+this[5]*this[5]+this[6]*this[6]),t[2]=Math.sqrt(this[8]*this[8]+this[9]*this[9]+this[10]*this[10]),t}getTranslation(t=[-0,-0,-0]){return t[0]=this[12],t[1]=this[13],t[2]=this[14],t}getRotation(t,e){t=t||[-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0],e=e||[-0,-0,-0];const r=this.getScale(e),i=1/r[0],s=1/r[1],o=1/r[2];return t[0]=this[0]*i,t[1]=this[1]*s,t[2]=this[2]*o,t[3]=0,t[4]=this[4]*i,t[5]=this[5]*s,t[6]=this[6]*o,t[7]=0,t[8]=this[8]*i,t[9]=this[9]*s,t[10]=this[10]*o,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}getRotationMatrix3(t,e){t=t||[-0,-0,-0,-0,-0,-0,-0,-0,-0],e=e||[-0,-0,-0];const r=this.getScale(e),i=1/r[0],s=1/r[1],o=1/r[2];return t[0]=this[0]*i,t[1]=this[1]*s,t[2]=this[2]*o,t[3]=this[4]*i,t[4]=this[5]*s,t[5]=this[6]*o,t[6]=this[8]*i,t[7]=this[9]*s,t[8]=this[10]*o,t}transpose(){return LI(this,this),this.check()}invert(){return _d(this,this),this.check()}multiplyLeft(t){return eo(this,t,this),this.check()}multiplyRight(t){return eo(this,this,t),this.check()}rotateX(t){return wb(this,this,t),this.check()}rotateY(t){return BI(this,this,t),this.check()}rotateZ(t){return Sb(this,this,t),this.check()}rotateXYZ(t){return this.rotateX(t[0]).rotateY(t[1]).rotateZ(t[2])}rotateAxis(t,e){return FI(this,this,t,e),this.check()}scale(t){return Fp(this,this,Array.isArray(t)?t:[t,t,t]),this.check()}translate(t){return Bu(this,this,t),this.check()}transform(t,e){return t.length===4?(e=ic(e||[-0,-0,-0,-0],t,this),pf(e,4),e):this.transformAsPoint(t,e)}transformAsPoint(t,e){const{length:r}=t;let i;switch(r){case 2:i=vb(e||[-0,-0],t,this);break;case 3:i=Eb(e||[-0,-0,-0],t,this);break;default:throw new Error("Illegal vector")}return pf(i,t.length),i}transformAsVector(t,e){let r;switch(t.length){case 2:r=bb(e||[-0,-0],t,this);break;case 3:r=xb(e||[-0,-0,-0],t,this);break;default:throw new Error("Illegal vector")}return pf(r,t.length),r}transformPoint(t,e){return this.transformAsPoint(t,e)}transformVector(t,e){return this.transformAsPoint(t,e)}transformDirection(t,e){return this.transformAsVector(t,e)}makeRotationX(t){return this.identity().rotateX(t)}makeTranslation(t,e,r){return this.identity().translate([t,e,r])}}let Nc,Oc;function ZI(){return Nc||(Nc=new Jr([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),Object.freeze(Nc)),Nc}function JI(){return Oc||(Oc=new Jr,Object.freeze(Oc)),Oc}function Lm(n){if(n>Math.PI*2)throw Error("expected radians")}function QI(n,t,e,r,i,s){const o=2*s/(e-t),a=2*s/(i-r),l=(e+t)/(e-t),c=(i+r)/(i-r),u=-1,h=-1,f=-2*s;return n[0]=o,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=a,n[6]=0,n[7]=0,n[8]=l,n[9]=c,n[10]=u,n[11]=h,n[12]=0,n[13]=0,n[14]=f,n[15]=0,n}function Cb(n,t=[],e=0){const r=Math.fround(n),i=n-r;return t[e]=r,t[e+1]=i,t}function tA(n){return n-Math.fround(n)}function eA(n){const t=new Float32Array(32);for(let e=0;e<4;++e)for(let r=0;r<4;++r){const i=e*4+r;Cb(n[r*4+e],t,i*2)}return t}const nA=`#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND

// All these functions are for substituting tan() function from Intel GPU only
const float TWO_PI = 6.2831854820251465;
const float PI_2 = 1.5707963705062866;
const float PI_16 = 0.1963495463132858;

const float SIN_TABLE_0 = 0.19509032368659973;
const float SIN_TABLE_1 = 0.3826834261417389;
const float SIN_TABLE_2 = 0.5555702447891235;
const float SIN_TABLE_3 = 0.7071067690849304;

const float COS_TABLE_0 = 0.9807852506637573;
const float COS_TABLE_1 = 0.9238795042037964;
const float COS_TABLE_2 = 0.8314695954322815;
const float COS_TABLE_3 = 0.7071067690849304;

const float INVERSE_FACTORIAL_3 = 1.666666716337204e-01; // 1/3!
const float INVERSE_FACTORIAL_5 = 8.333333767950535e-03; // 1/5!
const float INVERSE_FACTORIAL_7 = 1.9841270113829523e-04; // 1/7!
const float INVERSE_FACTORIAL_9 = 2.75573188446287533e-06; // 1/9!

float sin_taylor_fp32(float a) {
  float r, s, t, x;

  if (a == 0.0) {
    return 0.0;
  }

  x = -a * a;
  s = a;
  r = a;

  r = r * x;
  t = r * INVERSE_FACTORIAL_3;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_5;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_7;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_9;
  s = s + t;

  return s;
}

void sincos_taylor_fp32(float a, out float sin_t, out float cos_t) {
  if (a == 0.0) {
    sin_t = 0.0;
    cos_t = 1.0;
  }
  sin_t = sin_taylor_fp32(a);
  cos_t = sqrt(1.0 - sin_t * sin_t);
}

float tan_taylor_fp32(float a) {
    float sin_a;
    float cos_a;

    if (a == 0.0) {
        return 0.0;
    }

    // 2pi range reduction
    float z = floor(a / TWO_PI);
    float r = a - TWO_PI * z;

    float t;
    float q = floor(r / PI_2 + 0.5);
    int j = int(q);

    if (j < -2 || j > 2) {
        return 1.0 / 0.0;
    }

    t = r - PI_2 * q;

    q = floor(t / PI_16 + 0.5);
    int k = int(q);
    int abs_k = int(abs(float(k)));

    if (abs_k > 4) {
        return 1.0 / 0.0;
    } else {
        t = t - PI_16 * q;
    }

    float u = 0.0;
    float v = 0.0;

    float sin_t, cos_t;
    float s, c;
    sincos_taylor_fp32(t, sin_t, cos_t);

    if (k == 0) {
        s = sin_t;
        c = cos_t;
    } else {
        if (abs(float(abs_k) - 1.0) < 0.5) {
            u = COS_TABLE_0;
            v = SIN_TABLE_0;
        } else if (abs(float(abs_k) - 2.0) < 0.5) {
            u = COS_TABLE_1;
            v = SIN_TABLE_1;
        } else if (abs(float(abs_k) - 3.0) < 0.5) {
            u = COS_TABLE_2;
            v = SIN_TABLE_2;
        } else if (abs(float(abs_k) - 4.0) < 0.5) {
            u = COS_TABLE_3;
            v = SIN_TABLE_3;
        }
        if (k > 0) {
            s = u * sin_t + v * cos_t;
            c = u * cos_t - v * sin_t;
        } else {
            s = u * sin_t - v * cos_t;
            c = u * cos_t + v * sin_t;
        }
    }

    if (j == 0) {
        sin_a = s;
        cos_a = c;
    } else if (j == 1) {
        sin_a = c;
        cos_a = -s;
    } else if (j == -1) {
        sin_a = -c;
        cos_a = s;
    } else {
        sin_a = -s;
        cos_a = -c;
    }
    return sin_a / cos_a;
}
#endif

float tan_fp32(float a) {
#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
  return tan_taylor_fp32(a);
#else
  return tan(a);
#endif
}
`,rA={name:"fp32",vs:nA},iA=`
uniform fp64arithmeticUniforms {
  uniform float ONE;
} fp64;

/*
About LUMA_FP64_CODE_ELIMINATION_WORKAROUND

The purpose of this workaround is to prevent shader compilers from
optimizing away necessary arithmetic operations by swapping their sequences
or transform the equation to some 'equivalent' form.

The method is to multiply an artifical variable, ONE, which will be known to
the compiler to be 1 only at runtime. The whole expression is then represented
as a polynomial with respective to ONE. In the coefficients of all terms, only one a
and one b should appear

err = (a + b) * ONE^6 - a * ONE^5 - (a + b) * ONE^4 + a * ONE^3 - b - (a + b) * ONE^2 + a * ONE
*/

// Divide float number to high and low floats to extend fraction bits
vec2 split(float a) {
  const float SPLIT = 4097.0;
  float t = a * SPLIT;
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float a_hi = t * fp64.ONE - (t - a);
  float a_lo = a * fp64.ONE - a_hi;
#else
  float a_hi = t - (t - a);
  float a_lo = a - a_hi;
#endif
  return vec2(a_hi, a_lo);
}

// Divide float number again when high float uses too many fraction bits
vec2 split2(vec2 a) {
  vec2 b = split(a.x);
  b.y += a.y;
  return b;
}

// Special sum operation when a > b
vec2 quickTwoSum(float a, float b) {
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float sum = (a + b) * fp64.ONE;
  float err = b - (sum - a) * fp64.ONE;
#else
  float sum = a + b;
  float err = b - (sum - a);
#endif
  return vec2(sum, err);
}

// General sum operation
vec2 twoSum(float a, float b) {
  float s = (a + b);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float v = (s * fp64.ONE - a) * fp64.ONE;
  float err = (a - (s - v) * fp64.ONE) * fp64.ONE * fp64.ONE * fp64.ONE + (b - v);
#else
  float v = s - a;
  float err = (a - (s - v)) + (b - v);
#endif
  return vec2(s, err);
}

vec2 twoSub(float a, float b) {
  float s = (a - b);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float v = (s * fp64.ONE - a) * fp64.ONE;
  float err = (a - (s - v) * fp64.ONE) * fp64.ONE * fp64.ONE * fp64.ONE - (b + v);
#else
  float v = s - a;
  float err = (a - (s - v)) - (b + v);
#endif
  return vec2(s, err);
}

vec2 twoSqr(float a) {
  float prod = a * a;
  vec2 a_fp64 = split(a);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float err = ((a_fp64.x * a_fp64.x - prod) * fp64.ONE + 2.0 * a_fp64.x *
    a_fp64.y * fp64.ONE * fp64.ONE) + a_fp64.y * a_fp64.y * fp64.ONE * fp64.ONE * fp64.ONE;
#else
  float err = ((a_fp64.x * a_fp64.x - prod) + 2.0 * a_fp64.x * a_fp64.y) + a_fp64.y * a_fp64.y;
#endif
  return vec2(prod, err);
}

vec2 twoProd(float a, float b) {
  float prod = a * b;
  vec2 a_fp64 = split(a);
  vec2 b_fp64 = split(b);
  float err = ((a_fp64.x * b_fp64.x - prod) + a_fp64.x * b_fp64.y +
    a_fp64.y * b_fp64.x) + a_fp64.y * b_fp64.y;
  return vec2(prod, err);
}

vec2 sum_fp64(vec2 a, vec2 b) {
  vec2 s, t;
  s = twoSum(a.x, b.x);
  t = twoSum(a.y, b.y);
  s.y += t.x;
  s = quickTwoSum(s.x, s.y);
  s.y += t.y;
  s = quickTwoSum(s.x, s.y);
  return s;
}

vec2 sub_fp64(vec2 a, vec2 b) {
  vec2 s, t;
  s = twoSub(a.x, b.x);
  t = twoSub(a.y, b.y);
  s.y += t.x;
  s = quickTwoSum(s.x, s.y);
  s.y += t.y;
  s = quickTwoSum(s.x, s.y);
  return s;
}

vec2 mul_fp64(vec2 a, vec2 b) {
  vec2 prod = twoProd(a.x, b.x);
  // y component is for the error
  prod.y += a.x * b.y;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  prod = split2(prod);
#endif
  prod = quickTwoSum(prod.x, prod.y);
  prod.y += a.y * b.x;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  prod = split2(prod);
#endif
  prod = quickTwoSum(prod.x, prod.y);
  return prod;
}

vec2 div_fp64(vec2 a, vec2 b) {
  float xn = 1.0 / b.x;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  vec2 yn = mul_fp64(a, vec2(xn, 0));
#else
  vec2 yn = a * xn;
#endif
  float diff = (sub_fp64(a, mul_fp64(b, yn))).x;
  vec2 prod = twoProd(xn, diff);
  return sum_fp64(yn, prod);
}

vec2 sqrt_fp64(vec2 a) {
  if (a.x == 0.0 && a.y == 0.0) return vec2(0.0, 0.0);
  if (a.x < 0.0) return vec2(0.0 / 0.0, 0.0 / 0.0);

  float x = 1.0 / sqrt(a.x);
  float yn = a.x * x;
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  vec2 yn_sqr = twoSqr(yn) * fp64.ONE;
#else
  vec2 yn_sqr = twoSqr(yn);
#endif
  float diff = sub_fp64(a, yn_sqr).x;
  vec2 prod = twoProd(x * 0.5, diff);
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  return sum_fp64(split(yn), prod);
#else
  return sum_fp64(vec2(yn, 0.0), prod);
#endif
}
`,sA={ONE:1},oA={name:"fp64arithmetic",vs:iA,defaultUniforms:sA,uniformTypes:{ONE:"f32"},fp64ify:Cb,fp64LowPart:tA,fp64ifyMatrix4:eA},aA=[0,1,1,1],lA=`uniform pickingUniforms {
  float isActive;
  float isAttribute;
  float isHighlightActive;
  float useFloatColors;
  vec3 highlightedObjectColor;
  vec4 highlightColor;
} picking;

out vec4 picking_vRGBcolor_Avalid;

// Normalize unsigned byte color to 0-1 range
vec3 picking_normalizeColor(vec3 color) {
  return picking.useFloatColors > 0.5 ? color : color / 255.0;
}

// Normalize unsigned byte color to 0-1 range
vec4 picking_normalizeColor(vec4 color) {
  return picking.useFloatColors > 0.5 ? color : color / 255.0;
}

bool picking_isColorZero(vec3 color) {
  return dot(color, vec3(1.0)) < 0.00001;
}

bool picking_isColorValid(vec3 color) {
  return dot(color, vec3(1.0)) > 0.00001;
}

// Check if this vertex is highlighted 
bool isVertexHighlighted(vec3 vertexColor) {
  vec3 highlightedObjectColor = picking_normalizeColor(picking.highlightedObjectColor);
  return
    bool(picking.isHighlightActive) && picking_isColorZero(abs(vertexColor - highlightedObjectColor));
}

// Set the current picking color
void picking_setPickingColor(vec3 pickingColor) {
  pickingColor = picking_normalizeColor(pickingColor);

  if (bool(picking.isActive)) {
    // Use alpha as the validity flag. If pickingColor is [0, 0, 0] fragment is non-pickable
    picking_vRGBcolor_Avalid.a = float(picking_isColorValid(pickingColor));

    if (!bool(picking.isAttribute)) {
      // Stores the picking color so that the fragment shader can render it during picking
      picking_vRGBcolor_Avalid.rgb = pickingColor;
    }
  } else {
    // Do the comparison with selected item color in vertex shader as it should mean fewer compares
    picking_vRGBcolor_Avalid.a = float(isVertexHighlighted(pickingColor));
  }
}

void picking_setPickingAttribute(float value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.r = value;
  }
}

void picking_setPickingAttribute(vec2 value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.rg = value;
  }
}

void picking_setPickingAttribute(vec3 value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.rgb = value;
  }
}
`,cA=`uniform pickingUniforms {
  float isActive;
  float isAttribute;
  float isHighlightActive;
  float useFloatColors;
  vec3 highlightedObjectColor;
  vec4 highlightColor;
} picking;

in vec4 picking_vRGBcolor_Avalid;

/*
 * Returns highlight color if this item is selected.
 */
vec4 picking_filterHighlightColor(vec4 color) {
  // If we are still picking, we don't highlight
  if (picking.isActive > 0.5) {
    return color;
  }

  bool selected = bool(picking_vRGBcolor_Avalid.a);

  if (selected) {
    // Blend in highlight color based on its alpha value
    float highLightAlpha = picking.highlightColor.a;
    float blendedAlpha = highLightAlpha + color.a * (1.0 - highLightAlpha);
    float highLightRatio = highLightAlpha / blendedAlpha;

    vec3 blendedRGB = mix(color.rgb, picking.highlightColor.rgb, highLightRatio);
    return vec4(blendedRGB, blendedAlpha);
  } else {
    return color;
  }
}

/*
 * Returns picking color if picking enabled else unmodified argument.
 */
vec4 picking_filterPickingColor(vec4 color) {
  if (bool(picking.isActive)) {
    if (picking_vRGBcolor_Avalid.a == 0.0) {
      discard;
    }
    return picking_vRGBcolor_Avalid;
  }
  return color;
}

/*
 * Returns picking color if picking is enabled if not
 * highlight color if this item is selected, otherwise unmodified argument.
 */
vec4 picking_filterColor(vec4 color) {
  vec4 highlightColor = picking_filterHighlightColor(color);
  return picking_filterPickingColor(highlightColor);
}
`,km={props:{},uniforms:{},name:"picking",uniformTypes:{isActive:"f32",isAttribute:"f32",isHighlightActive:"f32",useFloatColors:"f32",highlightedObjectColor:"vec3<f32>",highlightColor:"vec4<f32>"},defaultUniforms:{isActive:!1,isAttribute:!1,isHighlightActive:!1,useFloatColors:!0,highlightedObjectColor:[0,0,0],highlightColor:aA},vs:lA,fs:cA,getUniforms:uA};function uA(n={},t){const e={};if(n.highlightedObjectColor!==void 0)if(n.highlightedObjectColor===null)e.isHighlightActive=!1;else{e.isHighlightActive=!0;const r=n.highlightedObjectColor.slice(0,3);e.highlightedObjectColor=r}if(n.highlightColor){const r=Array.from(n.highlightColor,i=>i/255);Number.isFinite(r[3])||(r[3]=1),e.highlightColor=r}return n.isActive!==void 0&&(e.isActive=!!n.isActive,e.isAttribute=!!n.isAttribute),n.useFloatColors!==void 0&&(e.useFloatColors=!!n.useFloatColors),e}const Fm=`precision highp int;

// #if (defined(SHADER_TYPE_FRAGMENT) && defined(LIGHTING_FRAGMENT)) || (defined(SHADER_TYPE_VERTEX) && defined(LIGHTING_VERTEX))
struct AmbientLight {
  vec3 color;
};

struct PointLight {
  vec3 color;
  vec3 position;
  vec3 attenuation; // 2nd order x:Constant-y:Linear-z:Exponential
};

struct DirectionalLight {
  vec3 color;
  vec3 direction;
};

uniform lightingUniforms {
  int enabled;
  int lightType;

  int directionalLightCount;
  int pointLightCount;

  vec3 ambientColor;

  vec3 lightColor0;
  vec3 lightPosition0;
  vec3 lightDirection0;
  vec3 lightAttenuation0;

  vec3 lightColor1;
  vec3 lightPosition1;
  vec3 lightDirection1;
  vec3 lightAttenuation1;

  vec3 lightColor2;
  vec3 lightPosition2;
  vec3 lightDirection2;
  vec3 lightAttenuation2;
} lighting;

PointLight lighting_getPointLight(int index) {
  switch (index) {
    case 0:
      return PointLight(lighting.lightColor0, lighting.lightPosition0, lighting.lightAttenuation0);
    case 1:
      return PointLight(lighting.lightColor1, lighting.lightPosition1, lighting.lightAttenuation1);
    case 2:
    default:  
      return PointLight(lighting.lightColor2, lighting.lightPosition2, lighting.lightAttenuation2);
  }
}

DirectionalLight lighting_getDirectionalLight(int index) {
  switch (index) {
    case 0:
      return DirectionalLight(lighting.lightColor0, lighting.lightDirection0);
    case 1:
      return DirectionalLight(lighting.lightColor1, lighting.lightDirection1);
    case 2:
    default:   
      return DirectionalLight(lighting.lightColor2, lighting.lightDirection2);
  }
} 

float getPointLightAttenuation(PointLight pointLight, float distance) {
  return pointLight.attenuation.x
       + pointLight.attenuation.y * distance
       + pointLight.attenuation.z * distance * distance;
}

// #endif
`,hA=`// #if (defined(SHADER_TYPE_FRAGMENT) && defined(LIGHTING_FRAGMENT)) || (defined(SHADER_TYPE_VERTEX) && defined(LIGHTING_VERTEX))
struct AmbientLight {
  color: vec3<f32>,
};

struct PointLight {
  color: vec3<f32>,
  position: vec3<f32>,
  attenuation: vec3<f32>, // 2nd order x:Constant-y:Linear-z:Exponential
};

struct DirectionalLight {
  color: vec3<f32>,
  direction: vec3<f32>,
};

struct lightingUniforms {
  enabled: i32,
  pointLightCount: i32,
  directionalLightCount: i32,

  ambientColor: vec3<f32>,

  // TODO - support multiple lights by uncommenting arrays below
  lightType: i32,
  lightColor: vec3<f32>,
  lightDirection: vec3<f32>,
  lightPosition: vec3<f32>,
  lightAttenuation: vec3<f32>,

  // AmbientLight ambientLight;
  // PointLight pointLight[MAX_LIGHTS];
  // DirectionalLight directionalLight[MAX_LIGHTS];
};

// Binding 0:1 is reserved for lighting (Note: could go into separate bind group as it is stable across draw calls)
@binding(1) @group(0) var<uniform> lighting : lightingUniforms;

fn lighting_getPointLight(index: i32) -> PointLight {
  return PointLight(lighting.lightColor, lighting.lightPosition, lighting.lightAttenuation);
}

fn lighting_getDirectionalLight(index: i32) -> DirectionalLight {
  return DirectionalLight(lighting.lightColor, lighting.lightDirection);
} 

fn getPointLightAttenuation(pointLight: PointLight, distance: f32) -> f32 {
  return pointLight.attenuation.x
       + pointLight.attenuation.y * distance
       + pointLight.attenuation.z * distance * distance;
}
`,Tb=3,fA=255;var Ml;(function(n){n[n.POINT=0]="POINT",n[n.DIRECTIONAL=1]="DIRECTIONAL"})(Ml||(Ml={}));const au={props:{},uniforms:{},name:"lighting",defines:{MAX_LIGHTS:Tb},uniformTypes:{enabled:"i32",lightType:"i32",directionalLightCount:"i32",pointLightCount:"i32",ambientLightColor:"vec3<f32>",lightColor0:"vec3<f32>",lightPosition0:"vec3<f32>",lightDirection0:"vec3<f32>",lightAttenuation0:"vec3<f32>",lightColor1:"vec3<f32>",lightPosition1:"vec3<f32>",lightDirection1:"vec3<f32>",lightAttenuation1:"vec3<f32>",lightColor2:"vec3<f32>",lightPosition2:"vec3<f32>",lightDirection2:"vec3<f32>",lightAttenuation2:"vec3<f32>"},defaultUniforms:{enabled:1,lightType:Ml.POINT,directionalLightCount:0,pointLightCount:0,ambientLightColor:[.1,.1,.1],lightColor0:[1,1,1],lightPosition0:[1,1,2],lightDirection0:[1,1,1],lightAttenuation0:[1,0,0],lightColor1:[1,1,1],lightPosition1:[1,1,2],lightDirection1:[1,1,1],lightAttenuation1:[1,0,0],lightColor2:[1,1,1],lightPosition2:[1,1,2],lightDirection2:[1,1,1],lightAttenuation2:[1,0,0]},source:hA,vs:Fm,fs:Fm,getUniforms:dA};function dA(n,t={}){if(n=n&&{...n},!n)return{...au.defaultUniforms};n.lights&&(n={...n,...gA(n.lights),lights:void 0});const{ambientLight:e,pointLights:r,directionalLights:i}=n||{};if(!(e||r&&r.length>0||i&&i.length>0))return{...au.defaultUniforms,enabled:0};const o={...au.defaultUniforms,...t,...pA({ambientLight:e,pointLights:r,directionalLights:i})};return n.enabled!==void 0&&(o.enabled=n.enabled?1:0),o}function pA({ambientLight:n,pointLights:t=[],directionalLights:e=[]}){const r={};r.ambientLightColor=vf(n);let i=0;for(const s of t){r.lightType=Ml.POINT;const o=i;r[`lightColor${o}`]=vf(s),r[`lightPosition${o}`]=s.position,r[`lightAttenuation${o}`]=s.attenuation||[1,0,0],i++}for(const s of e){r.lightType=Ml.DIRECTIONAL;const o=i;r[`lightColor${o}`]=vf(s),r[`lightDirection${o}`]=s.direction,i++}return i>Tb&&tt.warn("MAX_LIGHTS exceeded")(),r.directionalLightCount=e.length,r.pointLightCount=t.length,r}function gA(n){const t={pointLights:[],directionalLights:[]};for(const e of n||[])switch(e.type){case"ambient":t.ambientLight=e;break;case"directional":t.directionalLights?.push(e);break;case"point":t.pointLights?.push(e);break}return t}function vf(n={}){const{color:t=[0,0,0],intensity:e=1}=n;return t.map(r=>r*e/fA)}const mA=`uniform phongMaterialUniforms {
  uniform float ambient;
  uniform float diffuse;
  uniform float shininess;
  uniform vec3  specularColor;
} material;
`,_A=`uniform phongMaterialUniforms {
  uniform float ambient;
  uniform float diffuse;
  uniform float shininess;
  uniform vec3  specularColor;
} material;

vec3 lighting_getLightColor(vec3 surfaceColor, vec3 light_direction, vec3 view_direction, vec3 normal_worldspace, vec3 color) {
  vec3 halfway_direction = normalize(light_direction + view_direction);
  float lambertian = dot(light_direction, normal_worldspace);
  float specular = 0.0;
  if (lambertian > 0.0) {
    float specular_angle = max(dot(normal_worldspace, halfway_direction), 0.0);
    specular = pow(specular_angle, material.shininess);
  }
  lambertian = max(lambertian, 0.0);
  return (lambertian * material.diffuse * surfaceColor + specular * material.specularColor) * color;
}

vec3 lighting_getLightColor(vec3 surfaceColor, vec3 cameraPosition, vec3 position_worldspace, vec3 normal_worldspace) {
  vec3 lightColor = surfaceColor;

  if (lighting.enabled == 0) {
    return lightColor;
  }

  vec3 view_direction = normalize(cameraPosition - position_worldspace);
  lightColor = material.ambient * surfaceColor * lighting.ambientColor;

  for (int i = 0; i < lighting.pointLightCount; i++) {
    PointLight pointLight = lighting_getPointLight(i);
    vec3 light_position_worldspace = pointLight.position;
    vec3 light_direction = normalize(light_position_worldspace - position_worldspace);
    float light_attenuation = getPointLightAttenuation(pointLight, distance(light_position_worldspace, position_worldspace));
    lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color / light_attenuation);
  }

  int totalLights = min(MAX_LIGHTS, lighting.pointLightCount + lighting.directionalLightCount);
  for (int i = lighting.pointLightCount; i < totalLights; i++) {
    DirectionalLight directionalLight = lighting_getDirectionalLight(i);
    lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
  }
  
  return lightColor;
}
`,yA=`struct phongMaterialUniforms {
  ambient: f32,
  diffuse: f32,
  shininess: f32,
  specularColor: vec3<f32>,
};

@binding(2) @group(0) var<uniform> phongMaterial : phongMaterialUniforms;

fn lighting_getLightColor(surfaceColor: vec3<f32>, light_direction: vec3<f32>, view_direction: vec3<f32>, normal_worldspace: vec3<f32>, color: vec3<f32>) -> vec3<f32> {
  let halfway_direction: vec3<f32> = normalize(light_direction + view_direction);
  var lambertian: f32 = dot(light_direction, normal_worldspace);
  var specular: f32 = 0.0;
  if (lambertian > 0.0) {
    let specular_angle = max(dot(normal_worldspace, halfway_direction), 0.0);
    specular = pow(specular_angle, phongMaterial.shininess);
  }
  lambertian = max(lambertian, 0.0);
  return (lambertian * phongMaterial.diffuse * surfaceColor + specular * phongMaterial.specularColor) * color;
}

fn lighting_getLightColor2(surfaceColor: vec3<f32>, cameraPosition: vec3<f32>, position_worldspace: vec3<f32>, normal_worldspace: vec3<f32>) -> vec3<f32> {
  var lightColor: vec3<f32> = surfaceColor;

  if (lighting.enabled == 0) {
    return lightColor;
  }

  let view_direction: vec3<f32> = normalize(cameraPosition - position_worldspace);
  lightColor = phongMaterial.ambient * surfaceColor * lighting.ambientColor;

  if (lighting.lightType == 0) {
    let pointLight: PointLight  = lighting_getPointLight(0);
    let light_position_worldspace: vec3<f32> = pointLight.position;
    let light_direction: vec3<f32> = normalize(light_position_worldspace - position_worldspace);
    lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
  } else if (lighting.lightType == 1) {
    var directionalLight: DirectionalLight = lighting_getDirectionalLight(0);
    lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
  }
  
  return lightColor;
  /*
  for (int i = 0; i < MAX_LIGHTS; i++) {
    if (i >= lighting.pointLightCount) {
      break;
    }
    PointLight pointLight = lighting.pointLight[i];
    vec3 light_position_worldspace = pointLight.position;
    vec3 light_direction = normalize(light_position_worldspace - position_worldspace);
    lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
  }

  for (int i = 0; i < MAX_LIGHTS; i++) {
    if (i >= lighting.directionalLightCount) {
      break;
    }
    DirectionalLight directionalLight = lighting.directionalLight[i];
    lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
  }
  */
}

fn lighting_getSpecularLightColor(cameraPosition: vec3<f32>, position_worldspace: vec3<f32>, normal_worldspace: vec3<f32>) -> vec3<f32>{
  var lightColor = vec3<f32>(0, 0, 0);
  let surfaceColor = vec3<f32>(0, 0, 0);

  if (lighting.enabled == 0) {
    let view_direction = normalize(cameraPosition - position_worldspace);

    switch (lighting.lightType) {
      case 0, default: {
        let pointLight: PointLight = lighting_getPointLight(0);
        let light_position_worldspace: vec3<f32> = pointLight.position;
        let light_direction: vec3<f32> = normalize(light_position_worldspace - position_worldspace);
        lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
      }
      case 1: {
        let directionalLight: DirectionalLight = lighting_getDirectionalLight(0);
        lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
      }
    }
  }
  return lightColor;
}
`,Pb={props:{},name:"gouraudMaterial",vs:_A.replace("phongMaterial","gouraudMaterial"),fs:mA.replace("phongMaterial","gouraudMaterial"),source:yA.replaceAll("phongMaterial","gouraudMaterial"),defines:{LIGHTING_VERTEX:1},dependencies:[au],uniformTypes:{ambient:"f32",diffuse:"f32",shininess:"f32",specularColor:"vec3<f32>"},defaultUniforms:{ambient:.35,diffuse:.6,shininess:32,specularColor:[.15,.15,.15]},getUniforms(n){const t={...n};return t.specularColor&&(t.specularColor=t.specularColor.map(e=>e/255)),{...Pb.defaultUniforms,...t}}},Bm=`uniform layerUniforms {
  uniform float opacity;
} layer;
`,vA={name:"layer",vs:Bm,fs:Bm,getUniforms:n=>({opacity:Math.pow(n.opacity,1/2.2)}),uniformTypes:{opacity:"f32"}},bA=`const SMOOTH_EDGE_RADIUS: f32 = 0.5;

struct VertexGeometry {
  position: vec4<f32>,
  worldPosition: vec3<f32>,
  worldPositionAlt: vec3<f32>,
  normal: vec3<f32>,
  uv: vec2<f32>,
  pickingColor: vec3<f32>,
};

var<private> geometry_: VertexGeometry = VertexGeometry(
  vec4<f32>(0.0, 0.0, 1.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec2<f32>(0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0)
);

struct FragmentGeometry {
  uv: vec2<f32>,
};

var<private> fragmentGeometry: FragmentGeometry;

fn smoothedge(edge: f32, x: f32) -> f32 {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`,Ib="#define SMOOTH_EDGE_RADIUS 0.5",xA=`${Ib}

struct VertexGeometry {
  vec4 position;
  vec3 worldPosition;
  vec3 worldPositionAlt;
  vec3 normal;
  vec2 uv;
  vec3 pickingColor;
} geometry = VertexGeometry(
  vec4(0.0, 0.0, 1.0, 0.0),
  vec3(0.0),
  vec3(0.0),
  vec3(0.0),
  vec2(0.0),
  vec3(0.0)
);
`,EA=`${Ib}

struct FragmentGeometry {
  vec2 uv;
} geometry;

float smoothedge(float edge, float x) {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`,Ab={name:"geometry",source:bA,vs:xA,fs:EA},wA=25;var Re;(function(n){n[n.Start=1]="Start",n[n.Move=2]="Move",n[n.End=4]="End",n[n.Cancel=8]="Cancel"})(Re||(Re={}));var Ue;(function(n){n[n.None=0]="None",n[n.Left=1]="Left",n[n.Right=2]="Right",n[n.Up=4]="Up",n[n.Down=8]="Down",n[n.Horizontal=3]="Horizontal",n[n.Vertical=12]="Vertical",n[n.All=15]="All"})(Ue||(Ue={}));var vt;(function(n){n[n.Possible=1]="Possible",n[n.Began=2]="Began",n[n.Changed=4]="Changed",n[n.Ended=8]="Ended",n[n.Recognized=8]="Recognized",n[n.Cancelled=16]="Cancelled",n[n.Failed=32]="Failed"})(vt||(vt={}));const SA="compute",CA="auto",vd="manipulation",lu="none",bd="pan-x",xd="pan-y";function TA(n){if(n.includes(lu))return lu;const t=n.includes(bd),e=n.includes(xd);return t&&e?lu:t||e?t?bd:xd:n.includes(vd)?vd:CA}class PA{constructor(t,e){this.actions="",this.manager=t,this.set(e)}set(t){t===SA&&(t=this.compute()),this.manager.element&&(this.manager.element.style.touchAction=t,this.actions=t)}update(){this.set(this.manager.options.touchAction)}compute(){let t=[];for(const e of this.manager.recognizers)e.options.enable&&(t=t.concat(e.getTouchAction()));return TA(t.join(" "))}}function Uu(n){return n.trim().split(/\s+/g)}function bf(n,t,e){if(n)for(const r of Uu(t))n.addEventListener(r,e,!1)}function xf(n,t,e){if(n)for(const r of Uu(t))n.removeEventListener(r,e,!1)}function Um(n){return(n.ownerDocument||n).defaultView}function IA(n,t){let e=n;for(;e;){if(e===t)return!0;e=e.parentNode}return!1}function Mb(n){const t=n.length;if(t===1)return{x:Math.round(n[0].clientX),y:Math.round(n[0].clientY)};let e=0,r=0,i=0;for(;i<t;)e+=n[i].clientX,r+=n[i].clientY,i++;return{x:Math.round(e/t),y:Math.round(r/t)}}function Vm(n){const t=[];let e=0;for(;e<n.pointers.length;)t[e]={clientX:Math.round(n.pointers[e].clientX),clientY:Math.round(n.pointers[e].clientY)},e++;return{timeStamp:Date.now(),pointers:t,center:Mb(t),deltaX:n.deltaX,deltaY:n.deltaY}}function Rb(n,t){const e=t.x-n.x,r=t.y-n.y;return Math.sqrt(e*e+r*r)}function zm(n,t){const e=t.clientX-n.clientX,r=t.clientY-n.clientY;return Math.sqrt(e*e+r*r)}function AA(n,t){const e=t.x-n.x,r=t.y-n.y;return Math.atan2(r,e)*180/Math.PI}function Wm(n,t){const e=t.clientX-n.clientX,r=t.clientY-n.clientY;return Math.atan2(r,e)*180/Math.PI}function Nb(n,t){return n===t?Ue.None:Math.abs(n)>=Math.abs(t)?n<0?Ue.Left:Ue.Right:t<0?Ue.Up:Ue.Down}function MA(n,t){const e=t.center;let r=n.offsetDelta,i=n.prevDelta;const s=n.prevInput;return(t.eventType===Re.Start||s?.eventType===Re.End)&&(i=n.prevDelta={x:s?.deltaX||0,y:s?.deltaY||0},r=n.offsetDelta={x:e.x,y:e.y}),{deltaX:i.x+(e.x-r.x),deltaY:i.y+(e.y-r.y)}}function Ob(n,t,e){return{x:t/n||0,y:e/n||0}}function RA(n,t){return zm(t[0],t[1])/zm(n[0],n[1])}function NA(n,t){return Wm(t[1],t[0])-Wm(n[1],n[0])}function OA(n,t){const e=n.lastInterval||t,r=t.timeStamp-e.timeStamp;let i,s,o,a;if(t.eventType!==Re.Cancel&&(r>wA||e.velocity===void 0)){const l=t.deltaX-e.deltaX,c=t.deltaY-e.deltaY,u=Ob(r,l,c);s=u.x,o=u.y,i=Math.abs(u.x)>Math.abs(u.y)?u.x:u.y,a=Nb(l,c),n.lastInterval=t}else i=e.velocity,s=e.velocityX,o=e.velocityY,a=e.direction;t.velocity=i,t.velocityX=s,t.velocityY=o,t.direction=a}function DA(n,t){const{session:e}=n,{pointers:r}=t,{length:i}=r;e.firstInput||(e.firstInput=Vm(t)),i>1&&!e.firstMultiple?e.firstMultiple=Vm(t):i===1&&(e.firstMultiple=!1);const{firstInput:s,firstMultiple:o}=e,a=o?o.center:s.center,l=t.center=Mb(r);t.timeStamp=Date.now(),t.deltaTime=t.timeStamp-s.timeStamp,t.angle=AA(a,l),t.distance=Rb(a,l);const{deltaX:c,deltaY:u}=MA(e,t);t.deltaX=c,t.deltaY=u,t.offsetDirection=Nb(t.deltaX,t.deltaY);const h=Ob(t.deltaTime,t.deltaX,t.deltaY);t.overallVelocityX=h.x,t.overallVelocityY=h.y,t.overallVelocity=Math.abs(h.x)>Math.abs(h.y)?h.x:h.y,t.scale=o?RA(o.pointers,r):1,t.rotation=o?NA(o.pointers,r):0,t.maxPointers=e.prevInput?t.pointers.length>e.prevInput.maxPointers?t.pointers.length:e.prevInput.maxPointers:t.pointers.length;let f=n.element;return IA(t.srcEvent.target,f)&&(f=t.srcEvent.target),t.target=f,OA(e,t),t}function LA(n,t,e){const r=e.pointers.length,i=e.changedPointers.length,s=t&Re.Start&&r-i===0,o=t&(Re.End|Re.Cancel)&&r-i===0;e.isFirst=!!s,e.isFinal=!!o,s&&(n.session={}),e.eventType=t;const a=DA(n,e);n.emit("hammer.input",a),n.recognize(a),n.session.prevInput=a}let kA=class{constructor(t){this.evEl="",this.evWin="",this.evTarget="",this.domHandler=e=>{this.manager.options.enable&&this.handler(e)},this.manager=t,this.element=t.element,this.target=t.options.inputTarget||t.element}callback(t,e){LA(this.manager,t,e)}init(){bf(this.element,this.evEl,this.domHandler),bf(this.target,this.evTarget,this.domHandler),bf(Um(this.element),this.evWin,this.domHandler)}destroy(){xf(this.element,this.evEl,this.domHandler),xf(this.target,this.evTarget,this.domHandler),xf(Um(this.element),this.evWin,this.domHandler)}};const FA={pointerdown:Re.Start,pointermove:Re.Move,pointerup:Re.End,pointercancel:Re.Cancel,pointerout:Re.Cancel},BA="pointerdown",UA="pointermove pointerup pointercancel";class VA extends kA{constructor(t){super(t),this.evEl=BA,this.evWin=UA,this.store=this.manager.session.pointerEvents=[],this.init()}handler(t){const{store:e}=this;let r=!1;const i=FA[t.type],s=t.pointerType,o=s==="touch";let a=e.findIndex(l=>l.pointerId===t.pointerId);i&Re.Start&&(t.buttons||o)?a<0&&(e.push(t),a=e.length-1):i&(Re.End|Re.Cancel)&&(r=!0),!(a<0)&&(e[a]=t,this.callback(i,{pointers:e,changedPointers:[t],eventType:i,pointerType:s,srcEvent:t}),r&&e.splice(a,1))}}const zA=["","webkit","Moz","MS","ms","o"];function WA(n,t){const e=t[0].toUpperCase()+t.slice(1);for(const r of zA){const i=r?r+e:t;if(i in n)return i}}const HA=1,Hm=2,jm={touchAction:"compute",enable:!0,inputTarget:null,cssProps:{userSelect:"none",userDrag:"none",touchCallout:"none",tapHighlightColor:"rgba(0,0,0,0)"}};class jA{constructor(t,e){this.options={...jm,...e,cssProps:{...jm.cssProps,...e.cssProps},inputTarget:e.inputTarget||t},this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=t,this.input=new VA(this),this.touchAction=new PA(this,this.options.touchAction),this.toggleCssProps(!0)}set(t){return Object.assign(this.options,t),t.touchAction&&this.touchAction.update(),t.inputTarget&&(this.input.destroy(),this.input.target=t.inputTarget,this.input.init()),this}stop(t){this.session.stopped=t?Hm:HA}recognize(t){const{session:e}=this;if(e.stopped)return;this.session.prevented&&t.srcEvent.preventDefault();let r;const{recognizers:i}=this;let{curRecognizer:s}=e;(!s||s&&s.state&vt.Recognized)&&(s=e.curRecognizer=null);let o=0;for(;o<i.length;)r=i[o],e.stopped!==Hm&&(!s||r===s||r.canRecognizeWith(s))?r.recognize(t):r.reset(),!s&&r.state&(vt.Began|vt.Changed|vt.Ended)&&(s=e.curRecognizer=r),o++}get(t){const{recognizers:e}=this;for(let r=0;r<e.length;r++)if(e[r].options.event===t)return e[r];return null}add(t){if(Array.isArray(t)){for(const r of t)this.add(r);return this}const e=this.get(t.options.event);return e&&this.remove(e),this.recognizers.push(t),t.manager=this,this.touchAction.update(),t}remove(t){if(Array.isArray(t)){for(const r of t)this.remove(r);return this}const e=typeof t=="string"?this.get(t):t;if(e){const{recognizers:r}=this,i=r.indexOf(e);i!==-1&&(r.splice(i,1),this.touchAction.update())}return this}on(t,e){if(!t||!e)return;const{handlers:r}=this;for(const i of Uu(t))r[i]=r[i]||[],r[i].push(e)}off(t,e){if(!t)return;const{handlers:r}=this;for(const i of Uu(t))e?r[i]&&r[i].splice(r[i].indexOf(e),1):delete r[i]}emit(t,e){const r=this.handlers[t]&&this.handlers[t].slice();if(!r||!r.length)return;const i=e;i.type=t,i.preventDefault=function(){e.srcEvent.preventDefault()};let s=0;for(;s<r.length;)r[s](i),s++}destroy(){this.toggleCssProps(!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}toggleCssProps(t){const{element:e}=this;if(e){for(const[r,i]of Object.entries(this.options.cssProps)){const s=WA(e.style,r);t?(this.oldCssProps[s]=e.style[s],e.style[s]=i):e.style[s]=this.oldCssProps[s]||""}t||(this.oldCssProps={})}}}let $A=1;function XA(){return $A++}function $m(n){return n&vt.Cancelled?"cancel":n&vt.Ended?"end":n&vt.Changed?"move":n&vt.Began?"start":""}class Db{constructor(t){this.options=t,this.id=XA(),this.state=vt.Possible,this.simultaneous={},this.requireFail=[]}set(t){return Object.assign(this.options,t),this.manager.touchAction.update(),this}recognizeWith(t){if(Array.isArray(t)){for(const i of t)this.recognizeWith(i);return this}let e;if(typeof t=="string"){if(e=this.manager.get(t),!e)throw new Error(`Cannot find recognizer ${t}`)}else e=t;const{simultaneous:r}=this;return r[e.id]||(r[e.id]=e,e.recognizeWith(this)),this}dropRecognizeWith(t){if(Array.isArray(t)){for(const r of t)this.dropRecognizeWith(r);return this}let e;return typeof t=="string"?e=this.manager.get(t):e=t,e&&delete this.simultaneous[e.id],this}requireFailure(t){if(Array.isArray(t)){for(const i of t)this.requireFailure(i);return this}let e;if(typeof t=="string"){if(e=this.manager.get(t),!e)throw new Error(`Cannot find recognizer ${t}`)}else e=t;const{requireFail:r}=this;return r.indexOf(e)===-1&&(r.push(e),e.requireFailure(this)),this}dropRequireFailure(t){if(Array.isArray(t)){for(const r of t)this.dropRequireFailure(r);return this}let e;if(typeof t=="string"?e=this.manager.get(t):e=t,e){const r=this.requireFail.indexOf(e);r>-1&&this.requireFail.splice(r,1)}return this}hasRequireFailures(){return!!this.requireFail.find(t=>t.options.enable)}canRecognizeWith(t){return!!this.simultaneous[t.id]}emit(t){if(!t)return;const{state:e}=this;e<vt.Ended&&this.manager.emit(this.options.event+$m(e),t),this.manager.emit(this.options.event,t),t.additionalEvent&&this.manager.emit(t.additionalEvent,t),e>=vt.Ended&&this.manager.emit(this.options.event+$m(e),t)}tryEmit(t){this.canEmit()?this.emit(t):this.state=vt.Failed}canEmit(){let t=0;for(;t<this.requireFail.length;){if(!(this.requireFail[t].state&(vt.Failed|vt.Possible)))return!1;t++}return!0}recognize(t){const e={...t};if(!this.options.enable){this.reset(),this.state=vt.Failed;return}this.state&(vt.Recognized|vt.Cancelled|vt.Failed)&&(this.state=vt.Possible),this.state=this.process(e),this.state&(vt.Began|vt.Changed|vt.Ended|vt.Cancelled)&&this.tryEmit(e)}getEventNames(){return[this.options.event]}reset(){}}class Lb extends Db{attrTest(t){const e=this.options.pointers;return e===0||t.pointers.length===e}process(t){const{state:e}=this,{eventType:r}=t,i=e&(vt.Began|vt.Changed),s=this.attrTest(t);return i&&(r&Re.Cancel||!s)?e|vt.Cancelled:i||s?r&Re.End?e|vt.Ended:e&vt.Began?e|vt.Changed:vt.Began:vt.Failed}}class Xm extends Db{constructor(t={}){super({enable:!0,event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:9,posThreshold:10,...t}),this.pTime=null,this.pCenter=null,this._timer=null,this._input=null,this.count=0}getTouchAction(){return[vd]}process(t){const{options:e}=this,r=t.pointers.length===e.pointers,i=t.distance<e.threshold,s=t.deltaTime<e.time;if(this.reset(),t.eventType&Re.Start&&this.count===0)return this.failTimeout();if(i&&s&&r){if(t.eventType!==Re.End)return this.failTimeout();const o=this.pTime?t.timeStamp-this.pTime<e.interval:!0,a=!this.pCenter||Rb(this.pCenter,t.center)<e.posThreshold;if(this.pTime=t.timeStamp,this.pCenter=t.center,!a||!o?this.count=1:this.count+=1,this._input=t,this.count%e.taps===0)return this.hasRequireFailures()?(this._timer=setTimeout(()=>{this.state=vt.Recognized,this.tryEmit(this._input)},e.interval),vt.Began):vt.Recognized}return vt.Failed}failTimeout(){return this._timer=setTimeout(()=>{this.state=vt.Failed},this.options.interval),vt.Failed}reset(){clearTimeout(this._timer)}emit(t){this.state===vt.Recognized&&(t.tapCount=this.count,this.manager.emit(this.options.event,t))}}const GA=["","start","move","end","cancel","up","down","left","right"];class Gm extends Lb{constructor(t={}){super({enable:!0,pointers:1,event:"pan",threshold:10,direction:Ue.All,...t}),this.pX=null,this.pY=null}getTouchAction(){const{options:{direction:t}}=this,e=[];return t&Ue.Horizontal&&e.push(xd),t&Ue.Vertical&&e.push(bd),e}getEventNames(){return GA.map(t=>this.options.event+t)}directionTest(t){const{options:e}=this;let r=!0,{distance:i}=t,{direction:s}=t;const o=t.deltaX,a=t.deltaY;return s&e.direction||(e.direction&Ue.Horizontal?(s=o===0?Ue.None:o<0?Ue.Left:Ue.Right,r=o!==this.pX,i=Math.abs(t.deltaX)):(s=a===0?Ue.None:a<0?Ue.Up:Ue.Down,r=a!==this.pY,i=Math.abs(t.deltaY))),t.direction=s,r&&i>e.threshold&&!!(s&e.direction)}attrTest(t){return super.attrTest(t)&&(!!(this.state&vt.Began)||!(this.state&vt.Began)&&this.directionTest(t))}emit(t){this.pX=t.deltaX,this.pY=t.deltaY;const e=Ue[t.direction].toLowerCase();e&&(t.additionalEvent=this.options.event+e),super.emit(t)}}const YA=["","start","move","end","cancel","in","out"];class qA extends Lb{constructor(t={}){super({enable:!0,event:"pinch",threshold:0,pointers:2,...t})}getTouchAction(){return[lu]}getEventNames(){return YA.map(t=>this.options.event+t)}attrTest(t){return super.attrTest(t)&&(Math.abs(t.scale-1)>this.options.threshold||!!(this.state&vt.Began))}emit(t){if(t.scale!==1){const e=t.scale<1?"in":"out";t.additionalEvent=this.options.event+e}super.emit(t)}}class Sh{constructor(t,e,r){this.element=t,this.callback=e,this.options=r}}const KA=typeof navigator<"u"&&navigator.userAgent?navigator.userAgent.toLowerCase():"",ZA=KA.indexOf("firefox")!==-1,Ym=4.000244140625,JA=40,QA=.25;class t2 extends Sh{constructor(t,e,r){super(t,e,{enable:!0,...r}),this.handleEvent=i=>{if(!this.options.enable)return;let s=i.deltaY;globalThis.WheelEvent&&(ZA&&i.deltaMode===globalThis.WheelEvent.DOM_DELTA_PIXEL&&(s/=globalThis.devicePixelRatio),i.deltaMode===globalThis.WheelEvent.DOM_DELTA_LINE&&(s*=JA)),s!==0&&s%Ym===0&&(s=Math.floor(s/Ym)),i.shiftKey&&s&&(s=s*QA),this.callback({type:"wheel",center:{x:i.clientX,y:i.clientY},delta:-s,srcEvent:i,pointerType:"mouse",target:i.target})},t.addEventListener("wheel",this.handleEvent,{passive:!1})}destroy(){this.element.removeEventListener("wheel",this.handleEvent)}enableEventType(t,e){t==="wheel"&&(this.options.enable=e)}}const qm=["mousedown","mousemove","mouseup","mouseover","mouseout","mouseleave"];class e2 extends Sh{constructor(t,e,r){super(t,e,{enable:!0,...r}),this.handleEvent=s=>{this.handleOverEvent(s),this.handleOutEvent(s),this.handleEnterEvent(s),this.handleLeaveEvent(s),this.handleMoveEvent(s)},this.pressed=!1;const{enable:i}=this.options;this.enableMoveEvent=i,this.enableLeaveEvent=i,this.enableEnterEvent=i,this.enableOutEvent=i,this.enableOverEvent=i,qm.forEach(s=>t.addEventListener(s,this.handleEvent))}destroy(){qm.forEach(t=>this.element.removeEventListener(t,this.handleEvent))}enableEventType(t,e){switch(t){case"pointermove":this.enableMoveEvent=e;break;case"pointerover":this.enableOverEvent=e;break;case"pointerout":this.enableOutEvent=e;break;case"pointerenter":this.enableEnterEvent=e;break;case"pointerleave":this.enableLeaveEvent=e;break}}handleOverEvent(t){this.enableOverEvent&&t.type==="mouseover"&&this._emit("pointerover",t)}handleOutEvent(t){this.enableOutEvent&&t.type==="mouseout"&&this._emit("pointerout",t)}handleEnterEvent(t){this.enableEnterEvent&&t.type==="mouseenter"&&this._emit("pointerenter",t)}handleLeaveEvent(t){this.enableLeaveEvent&&t.type==="mouseleave"&&this._emit("pointerleave",t)}handleMoveEvent(t){if(this.enableMoveEvent)switch(t.type){case"mousedown":t.button>=0&&(this.pressed=!0);break;case"mousemove":t.buttons===0&&(this.pressed=!1),this.pressed||this._emit("pointermove",t);break;case"mouseup":this.pressed=!1;break}}_emit(t,e){this.callback({type:t,center:{x:e.clientX,y:e.clientY},srcEvent:e,pointerType:"mouse",target:e.target})}}const Km=["keydown","keyup"];class n2 extends Sh{constructor(t,e,r){super(t,e,{enable:!0,tabIndex:0,...r}),this.handleEvent=i=>{const s=i.target||i.srcElement;s.tagName==="INPUT"&&s.type==="text"||s.tagName==="TEXTAREA"||(this.enableDownEvent&&i.type==="keydown"&&this.callback({type:"keydown",srcEvent:i,key:i.key,target:i.target}),this.enableUpEvent&&i.type==="keyup"&&this.callback({type:"keyup",srcEvent:i,key:i.key,target:i.target}))},this.enableDownEvent=this.options.enable,this.enableUpEvent=this.options.enable,t.tabIndex=this.options.tabIndex,t.style.outline="none",Km.forEach(i=>t.addEventListener(i,this.handleEvent))}destroy(){Km.forEach(t=>this.element.removeEventListener(t,this.handleEvent))}enableEventType(t,e){t==="keydown"&&(this.enableDownEvent=e),t==="keyup"&&(this.enableUpEvent=e)}}class r2 extends Sh{constructor(t,e,r){super(t,e,r),this.handleEvent=i=>{this.options.enable&&this.callback({type:"contextmenu",center:{x:i.clientX,y:i.clientY},srcEvent:i,pointerType:"mouse",target:i.target})},t.addEventListener("contextmenu",this.handleEvent)}destroy(){this.element.removeEventListener("contextmenu",this.handleEvent)}enableEventType(t,e){t==="contextmenu"&&(this.options.enable=e)}}const Zm=1,Ed=2,Jm=4,i2={pointerdown:Zm,pointermove:Ed,pointerup:Jm,mousedown:Zm,mousemove:Ed,mouseup:Jm},s2=0,o2=1,a2=2,l2=1,c2=2,u2=4;function h2(n){const t=i2[n.srcEvent.type];if(!t)return null;const{buttons:e,button:r}=n.srcEvent;let i=!1,s=!1,o=!1;return t===Ed?(i=!!(e&l2),s=!!(e&u2),o=!!(e&c2)):(i=r===s2,s=r===o2,o=r===a2),{leftButton:i,middleButton:s,rightButton:o}}function f2(n,t){const e=n.center;if(!e)return null;const r=t.getBoundingClientRect(),i=r.width/t.offsetWidth||1,s=r.height/t.offsetHeight||1,o={x:(e.x-r.left-t.clientLeft)/i,y:(e.y-r.top-t.clientTop)/s};return{center:e,offsetCenter:o}}const d2={srcElement:"root",priority:0};class p2{constructor(t,e){this.handleEvent=r=>{if(this.isEmpty())return;const i=this._normalizeEvent(r);let s=r.srcEvent.target;for(;s&&s!==i.rootElement;){if(this._emit(i,s),i.handled)return;s=s.parentNode}this._emit(i,"root")},this.eventManager=t,this.recognizerName=e,this.handlers=[],this.handlersByElement=new Map,this._active=!1}isEmpty(){return!this._active}add(t,e,r,i=!1,s=!1){const{handlers:o,handlersByElement:a}=this,l={...d2,...r};let c=a.get(l.srcElement);c||(c=[],a.set(l.srcElement,c));const u={type:t,handler:e,srcElement:l.srcElement,priority:l.priority};i&&(u.once=!0),s&&(u.passive=!0),o.push(u),this._active=this._active||!u.passive;let h=c.length-1;for(;h>=0&&!(c[h].priority>=u.priority);)h--;c.splice(h+1,0,u)}remove(t,e){const{handlers:r,handlersByElement:i}=this;for(let s=r.length-1;s>=0;s--){const o=r[s];if(o.type===t&&o.handler===e){r.splice(s,1);const a=i.get(o.srcElement);a.splice(a.indexOf(o),1),a.length===0&&i.delete(o.srcElement)}}this._active=r.some(s=>!s.passive)}_emit(t,e){const r=this.handlersByElement.get(e);if(r){let i=!1;const s=()=>{t.handled=!0},o=()=>{t.handled=!0,i=!0},a=[];for(let l=0;l<r.length;l++){const{type:c,handler:u,once:h}=r[l];if(u({...t,type:c,stopPropagation:s,stopImmediatePropagation:o}),h&&a.push(r[l]),i)break}for(let l=0;l<a.length;l++){const{type:c,handler:u}=a[l];this.remove(c,u)}}}_normalizeEvent(t){const e=this.eventManager.getElement();return{...t,...h2(t),...f2(t,e),preventDefault:()=>{t.srcEvent.preventDefault()},stopImmediatePropagation:null,stopPropagation:null,handled:!1,rootElement:e}}}function g2(n){if("recognizer"in n)return n;let t;const e=Array.isArray(n)?[...n]:[n];if(typeof e[0]=="function"){const r=e.shift(),i=e.shift()||{};t=new r(i)}else t=e.shift();return{recognizer:t,recognizeWith:typeof e[0]=="string"?[e[0]]:e[0],requireFailure:typeof e[1]=="string"?[e[1]]:e[1]}}class m2{constructor(t=null,e={}){if(this._onBasicInput=r=>{this.manager.emit(r.srcEvent.type,r)},this._onOtherEvent=r=>{this.manager.emit(r.type,r)},this.options={recognizers:[],events:{},touchAction:"compute",tabIndex:0,cssProps:{},...e},this.events=new Map,this.element=t,!!t){this.manager=new jA(t,this.options);for(const r of this.options.recognizers){const{recognizer:i,recognizeWith:s,requireFailure:o}=g2(r);this.manager.add(i),s&&i.recognizeWith(s),o&&i.requireFailure(o)}this.manager.on("hammer.input",this._onBasicInput),this.wheelInput=new t2(t,this._onOtherEvent,{enable:!1}),this.moveInput=new e2(t,this._onOtherEvent,{enable:!1}),this.keyInput=new n2(t,this._onOtherEvent,{enable:!1,tabIndex:e.tabIndex}),this.contextmenuInput=new r2(t,this._onOtherEvent,{enable:!1}),this.on(this.options.events)}}getElement(){return this.element}destroy(){this.element&&(this.wheelInput.destroy(),this.moveInput.destroy(),this.keyInput.destroy(),this.contextmenuInput.destroy(),this.manager.destroy())}on(t,e,r){this._addEventHandler(t,e,r,!1)}once(t,e,r){this._addEventHandler(t,e,r,!0)}watch(t,e,r){this._addEventHandler(t,e,r,!1,!0)}off(t,e){this._removeEventHandler(t,e)}_toggleRecognizer(t,e){const{manager:r}=this;if(!r)return;const i=r.get(t);i&&(i.set({enable:e}),r.touchAction.update()),this.wheelInput?.enableEventType(t,e),this.moveInput?.enableEventType(t,e),this.keyInput?.enableEventType(t,e),this.contextmenuInput?.enableEventType(t,e)}_addEventHandler(t,e,r,i,s){if(typeof t!="string"){r=e;for(const[c,u]of Object.entries(t))this._addEventHandler(c,u,r,i,s);return}const{manager:o,events:a}=this;if(!o)return;let l=a.get(t);if(!l){const c=this._getRecognizerName(t)||t;l=new p2(this,c),a.set(t,l),o&&o.on(t,l.handleEvent)}l.add(t,e,r,i,s),l.isEmpty()||this._toggleRecognizer(l.recognizerName,!0)}_removeEventHandler(t,e){if(typeof t!="string"){for(const[s,o]of Object.entries(t))this._removeEventHandler(s,o);return}const{events:r}=this,i=r.get(t);if(i&&(i.remove(t,e),i.isEmpty())){const{recognizerName:s}=i;let o=!1;for(const a of r.values())if(a.recognizerName===s&&!a.isEmpty()){o=!0;break}o||this._toggleRecognizer(s,!1)}}_getRecognizerName(t){return this.manager.recognizers.find(e=>e.getEventNames().includes(t))?.options.event}}const At={DEFAULT:-1,LNGLAT:1,METER_OFFSETS:2,LNGLAT_OFFSETS:3,CARTESIAN:0};Object.defineProperty(At,"IDENTITY",{get:()=>(It.deprecated("COORDINATE_SYSTEM.IDENTITY","COORDINATE_SYSTEM.CARTESIAN")(),0)});const br={WEB_MERCATOR:1,GLOBE:2,WEB_MERCATOR_AUTO_OFFSET:4,IDENTITY:0},Gi={common:0,meters:1,pixels:2},wd={click:"onClick",panstart:"onDragStart",panmove:"onDrag",panend:"onDragEnd"},Qm={multipan:[Gm,{threshold:10,direction:Ue.Vertical,pointers:2}],pinch:[qA,{},null,["multipan"]],pan:[Gm,{threshold:1},["pinch"],["multipan"]],dblclick:[Xm,{event:"dblclick",taps:2}],click:[Xm,{event:"click"},null,["dblclick"]]};function _2(n,t){if(n===t)return!0;if(Array.isArray(n)){const e=n.length;if(!t||t.length!==e)return!1;for(let r=0;r<e;r++)if(n[r]!==t[r])return!1;return!0}return!1}function sc(n){let t={},e;return r=>{for(const i in r)if(!_2(r[i],t[i])){e=n(r),t=r;break}return e}}const t_=[0,0,0,0],y2=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0],kb=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],v2=[0,0,0],Fb=[0,0,0],b2=sc(w2);function Bb(n,t,e=Fb){e.length<3&&(e=[e[0],e[1],0]);let r=e,i,s=!0;switch(t===At.LNGLAT_OFFSETS||t===At.METER_OFFSETS?i=e:i=n.isGeospatial?[Math.fround(n.longitude),Math.fround(n.latitude),0]:null,n.projectionMode){case br.WEB_MERCATOR:(t===At.LNGLAT||t===At.CARTESIAN)&&(i=[0,0,0],s=!1);break;case br.WEB_MERCATOR_AUTO_OFFSET:t===At.LNGLAT?r=i:t===At.CARTESIAN&&(r=[Math.fround(n.center[0]),Math.fround(n.center[1]),0],i=n.unprojectPosition(r),r[0]-=e[0],r[1]-=e[1],r[2]-=e[2]);break;case br.IDENTITY:r=n.position.map(Math.fround),r[2]=r[2]||0;break;case br.GLOBE:s=!1,i=null;break;default:s=!1}return{geospatialOrigin:i,shaderCoordinateOrigin:r,offsetMode:s}}function x2(n,t,e){const{viewMatrixUncentered:r,projectionMatrix:i}=n;let{viewMatrix:s,viewProjectionMatrix:o}=n,a=t_,l=t_,c=n.cameraPosition;const{geospatialOrigin:u,shaderCoordinateOrigin:h,offsetMode:f}=Bb(n,t,e);return f&&(l=n.projectPosition(u||h),c=[c[0]-l[0],c[1]-l[1],c[2]-l[2]],l[3]=1,a=ic([],l,o),s=r||s,o=eo([],i,s),o=eo([],o,y2)),{viewMatrix:s,viewProjectionMatrix:o,projectionCenter:a,originCommon:l,cameraPosCommon:c,shaderCoordinateOrigin:h,geospatialOrigin:u}}function E2({viewport:n,devicePixelRatio:t=1,modelMatrix:e=null,coordinateSystem:r=At.DEFAULT,coordinateOrigin:i=Fb,autoWrapLongitude:s=!1}){r===At.DEFAULT&&(r=n.isGeospatial?At.LNGLAT:At.CARTESIAN);const o=b2({viewport:n,devicePixelRatio:t,coordinateSystem:r,coordinateOrigin:i});return o.wrapLongitude=s,o.modelMatrix=e||kb,o}function w2({viewport:n,devicePixelRatio:t,coordinateSystem:e,coordinateOrigin:r}){const{projectionCenter:i,viewProjectionMatrix:s,originCommon:o,cameraPosCommon:a,shaderCoordinateOrigin:l,geospatialOrigin:c}=x2(n,e,r),u=n.getDistanceScales(),h=[n.width*t,n.height*t],f=ic([],[0,0,-n.focalDistance,1],n.projectionMatrix)[3]||1,d={coordinateSystem:e,projectionMode:n.projectionMode,coordinateOrigin:l,commonOrigin:o.slice(0,3),center:i,pseudoMeters:!!n._pseudoMeters,viewportSize:h,devicePixelRatio:t,focalDistance:f,commonUnitsPerMeter:u.unitsPerMeter,commonUnitsPerWorldUnit:u.unitsPerMeter,commonUnitsPerWorldUnit2:v2,scale:n.scale,wrapLongitude:!1,viewProjectionMatrix:s,modelMatrix:kb,cameraPosition:a};if(c){const p=n.getDistanceScales(c);switch(e){case At.METER_OFFSETS:d.commonUnitsPerWorldUnit=p.unitsPerMeter,d.commonUnitsPerWorldUnit2=p.unitsPerMeter2;break;case At.LNGLAT:case At.LNGLAT_OFFSETS:n._pseudoMeters||(d.commonUnitsPerMeter=p.unitsPerMeter),d.commonUnitsPerWorldUnit=p.unitsPerDegree,d.commonUnitsPerWorldUnit2=p.unitsPerDegree2;break;case At.CARTESIAN:d.commonUnitsPerWorldUnit=[1,1,p.unitsPerMeter[2]],d.commonUnitsPerWorldUnit2=[0,0,p.unitsPerMeter2[2]];break}}return d}const S2=Object.keys(At).map(n=>`const COORDINATE_SYSTEM_${n}: i32 = ${At[n]};`).join(""),C2=Object.keys(br).map(n=>`const PROJECTION_MODE_${n}: i32 = ${br[n]};`).join(""),T2=Object.keys(Gi).map(n=>`const UNIT_${n.toUpperCase()}: i32 = ${Gi[n]};`).join(""),P2=`${S2}
${C2}
${T2}

const TILE_SIZE: f32 = 512.0;
const PI: f32 = 3.1415926536;
const WORLD_SCALE: f32 = TILE_SIZE / (PI * 2.0);
const ZERO_64_LOW: vec3<f32> = vec3<f32>(0.0, 0.0, 0.0);
const EARTH_RADIUS: f32 = 6370972.0; // meters
const GLOBE_RADIUS: f32 = 256.0;

// -----------------------------------------------------------------------------
// Uniform block (converted from GLSL uniform block)
// -----------------------------------------------------------------------------
struct ProjectUniforms {
  wrapLongitude: i32,
  coordinateSystem: i32,
  commonUnitsPerMeter: vec3<f32>,
  projectionMode: i32,
  scale: f32,
  commonUnitsPerWorldUnit: vec3<f32>,
  commonUnitsPerWorldUnit2: vec3<f32>,
  center: vec4<f32>,
  modelMatrix: mat4x4<f32>,
  viewProjectionMatrix: mat4x4<f32>,
  viewportSize: vec2<f32>,
  devicePixelRatio: f32,
  focalDistance: f32,
  cameraPosition: vec3<f32>,
  coordinateOrigin: vec3<f32>,
  commonOrigin: vec3<f32>,
  pseudoMeters: i32,
};

@group(0) @binding(0)
var<uniform> project: ProjectUniforms;

// -----------------------------------------------------------------------------
// Geometry data
// (In your GLSL code, "geometry" was assumed to be available globally. In WGSL,
// you might supply this via vertex attributes or a uniform. Here we define a
// uniform struct for demonstration.)
// -----------------------------------------------------------------------------

// Structure to carry additional geometry data used by deck.gl filters.
struct Geometry {
  worldPosition: vec3<f32>,
  worldPositionAlt: vec3<f32>,
  position: vec4<f32>,
  uv: vec2<f32>,
  pickingColor: vec3<f32>,
};

// @group(0) @binding(1)
var<private> geometry: Geometry;
`,I2=`${P2}

// -----------------------------------------------------------------------------
// Functions
// -----------------------------------------------------------------------------

// Returns an adjustment factor for commonUnitsPerMeter
fn _project_size_at_latitude(lat: f32) -> f32 {
  let y = clamp(lat, -89.9, 89.9);
  return 1.0 / cos(radians(y));
}

// Overloaded version: scales a value in meters at a given latitude.
fn _project_size_at_latitude_m(meters: f32, lat: f32) -> f32 {
  return meters * project.commonUnitsPerMeter.z * _project_size_at_latitude(lat);
}

// Computes a non-linear scale factor based on geometry.
// (Note: This function relies on "geometry" being provided.)
fn project_size() -> f32 {
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR &&
      project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
      project.pseudoMeters == 0) {
    if (geometry.position.w == 0.0) {
      return _project_size_at_latitude(geometry.worldPosition.y);
    }
    let y: f32 = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
    let y2 = y * y;
    let y4 = y2 * y2;
    let y6 = y4 * y2;
    return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
  }
  return 1.0;
}

// Overloads to scale offsets (meters to world units)
fn project_size_float(meters: f32) -> f32 {
  return meters * project.commonUnitsPerMeter.z * project_size();
}

fn project_size_vec2(meters: vec2<f32>) -> vec2<f32> {
  return meters * project.commonUnitsPerMeter.xy * project_size();
}

fn project_size_vec3(meters: vec3<f32>) -> vec3<f32> {
  return meters * project.commonUnitsPerMeter * project_size();
}

fn project_size_vec4(meters: vec4<f32>) -> vec4<f32> {
  return vec4<f32>(meters.xyz * project.commonUnitsPerMeter, meters.w);
}

// Returns a rotation matrix aligning the zaxis with the given up vector.
fn project_get_orientation_matrix(up: vec3<f32>) -> mat3x3<f32> {
  let uz = normalize(up);
  let ux = select(
    vec3<f32>(1.0, 0.0, 0.0),
    normalize(vec3<f32>(uz.y, -uz.x, 0.0)),
    abs(uz.z) == 1.0
  );
  let uy = cross(uz, ux);
  return mat3x3<f32>(ux, uy, uz);
}

// Since WGSL does not support "out" parameters, we return a struct.
struct RotationResult {
  needsRotation: bool,
  transform: mat3x3<f32>,
};

fn project_needs_rotation(commonPosition: vec3<f32>) -> RotationResult {
  if (project.projectionMode == PROJECTION_MODE_GLOBE) {
    return RotationResult(true, project_get_orientation_matrix(commonPosition));
  } else {
    return RotationResult(false, mat3x3<f32>());  // identity alternative if needed
  };
}

// Projects a normal vector from the current coordinate system to world space.
fn project_normal(vector: vec3<f32>) -> vec3<f32> {
  let normal_modelspace = project.modelMatrix * vec4<f32>(vector, 0.0);
  var n = normalize(normal_modelspace.xyz * project.commonUnitsPerMeter);
  let rotResult = project_needs_rotation(geometry.position.xyz);
  if (rotResult.needsRotation) {
    n = rotResult.transform * n;
  }
  return n;
}

// Applies a scale offset based on y-offset (dy)
fn project_offset_(offset: vec4<f32>) -> vec4<f32> {
  let dy: f32 = offset.y;
  let commonUnitsPerWorldUnit = project.commonUnitsPerWorldUnit + project.commonUnitsPerWorldUnit2 * dy;
  return vec4<f32>(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}

// Projects lng/lat coordinates to a unit tile [0,1]
fn project_mercator_(lnglat: vec2<f32>) -> vec2<f32> {
  var x = lnglat.x;
  if (project.wrapLongitude != 0) {
    x = ((x + 180.0) % 360.0) - 180.0;
  }
  let y = clamp(lnglat.y, -89.9, 89.9);
  return vec2<f32>(
    radians(x) + PI,
    PI + log(tan(PI * 0.25 + radians(y) * 0.5))
  ) * WORLD_SCALE;
}

// Projects lng/lat/z coordinates for a globe projection.
fn project_globe_(lnglatz: vec3<f32>) -> vec3<f32> {
  let lambda = radians(lnglatz.x);
  let phi = radians(lnglatz.y);
  let cosPhi = cos(phi);
  let D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;
  return vec3<f32>(
    sin(lambda) * cosPhi,
    -cos(lambda) * cosPhi,
    sin(phi)
  ) * D;
}

// Projects positions (with an optional 64-bit low part) from the input
// coordinate system to the common space.
fn project_position_vec4_f64(position: vec4<f32>, position64Low: vec3<f32>) -> vec4<f32> {
  var position_world = project.modelMatrix * position;

  // Work around for a Mac+NVIDIA bug:
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4<f32>(
        project_mercator_(position_world.xy),
        _project_size_at_latitude_m(position_world.z, position_world.y),
        position_world.w
      );
    }
    if (project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
      position_world = vec4f(position_world.xyz + project.coordinateOrigin, position_world.w);
    }
  }
  if (project.projectionMode == PROJECTION_MODE_GLOBE) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4<f32>(
        project_globe_(position_world.xyz),
        position_world.w
      );
    }
  }
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      if (abs(position_world.y - project.coordinateOrigin.y) > 0.25) {
        return vec4<f32>(
          project_mercator_(position_world.xy) - project.commonOrigin.xy,
          project_size_float(position_world.z),
          position_world.w
        );
      }
    }
  }
  if (project.projectionMode == PROJECTION_MODE_IDENTITY ||
      (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
       (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
        project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
    position_world = vec4f(position_world.xyz - project.coordinateOrigin, position_world.w);
  }

  return project_offset_(position_world) +
         project_offset_(project.modelMatrix * vec4<f32>(position64Low, 0.0));
}

// Overloaded versions for different input types.
fn project_position_vec4_f32(position: vec4<f32>) -> vec4<f32> {
  return project_position_vec4_f64(position, ZERO_64_LOW);
}

fn project_position_vec3_f64(position: vec3<f32>, position64Low: vec3<f32>) -> vec3<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 1.0), position64Low);
  return projected_position.xyz;
}

fn project_position_vec3_f32(position: vec3<f32>) -> vec3<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 1.0), ZERO_64_LOW);
  return projected_position.xyz;
}

fn project_position_vec2_f32(position: vec2<f32>) -> vec2<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 0.0, 1.0), ZERO_64_LOW);
  return projected_position.xy;
}

// Transforms a common space position to clip space.
fn project_common_position_to_clipspace_with_projection(position: vec4<f32>, viewProjectionMatrix: mat4x4<f32>, center: vec4<f32>) -> vec4<f32> {
  return viewProjectionMatrix * position + center;
}

// Uses the project viewProjectionMatrix and center.
fn project_common_position_to_clipspace(position: vec4<f32>) -> vec4<f32> {
  return project_common_position_to_clipspace_with_projection(position, project.viewProjectionMatrix, project.center);
}

// Returns a clip space offset corresponding to a given number of screen pixels.
fn project_pixel_size_to_clipspace(pixels: vec2<f32>) -> vec2<f32> {
  let offset = pixels / project.viewportSize * project.devicePixelRatio * 2.0;
  return offset * project.focalDistance;
}

fn project_meter_size_to_pixel(meters: f32) -> f32 {
  return project_size_float(meters) * project.scale;
}

fn project_unit_size_to_pixel(size: f32, unit: i32) -> f32 {
  if (unit == UNIT_METERS) {
    return project_meter_size_to_pixel(size);
  } else if (unit == UNIT_COMMON) {
    return size * project.scale;
  }
  // UNIT_PIXELS: no scaling applied.
  return size;
}

fn project_pixel_size_float(pixels: f32) -> f32 {
  return pixels / project.scale;
}

fn project_pixel_size_vec2(pixels: vec2<f32>) -> vec2<f32> {
  return pixels / project.scale;
}
`,A2=Object.keys(At).map(n=>`const int COORDINATE_SYSTEM_${n} = ${At[n]};`).join(""),M2=Object.keys(br).map(n=>`const int PROJECTION_MODE_${n} = ${br[n]};`).join(""),R2=Object.keys(Gi).map(n=>`const int UNIT_${n.toUpperCase()} = ${Gi[n]};`).join(""),N2=`${A2}
${M2}
${R2}
uniform projectUniforms {
bool wrapLongitude;
int coordinateSystem;
vec3 commonUnitsPerMeter;
int projectionMode;
float scale;
vec3 commonUnitsPerWorldUnit;
vec3 commonUnitsPerWorldUnit2;
vec4 center;
mat4 modelMatrix;
mat4 viewProjectionMatrix;
vec2 viewportSize;
float devicePixelRatio;
float focalDistance;
vec3 cameraPosition;
vec3 coordinateOrigin;
vec3 commonOrigin;
bool pseudoMeters;
} project;
const float TILE_SIZE = 512.0;
const float PI = 3.1415926536;
const float WORLD_SCALE = TILE_SIZE / (PI * 2.0);
const vec3 ZERO_64_LOW = vec3(0.0);
const float EARTH_RADIUS = 6370972.0;
const float GLOBE_RADIUS = 256.0;
float project_size_at_latitude(float lat) {
float y = clamp(lat, -89.9, 89.9);
return 1.0 / cos(radians(y));
}
float project_size() {
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR &&
project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
project.pseudoMeters == false) {
if (geometry.position.w == 0.0) {
return project_size_at_latitude(geometry.worldPosition.y);
}
float y = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
float y2 = y * y;
float y4 = y2 * y2;
float y6 = y4 * y2;
return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
}
return 1.0;
}
float project_size_at_latitude(float meters, float lat) {
return meters * project.commonUnitsPerMeter.z * project_size_at_latitude(lat);
}
float project_size(float meters) {
return meters * project.commonUnitsPerMeter.z * project_size();
}
vec2 project_size(vec2 meters) {
return meters * project.commonUnitsPerMeter.xy * project_size();
}
vec3 project_size(vec3 meters) {
return meters * project.commonUnitsPerMeter * project_size();
}
vec4 project_size(vec4 meters) {
return vec4(meters.xyz * project.commonUnitsPerMeter, meters.w);
}
mat3 project_get_orientation_matrix(vec3 up) {
vec3 uz = normalize(up);
vec3 ux = abs(uz.z) == 1.0 ? vec3(1.0, 0.0, 0.0) : normalize(vec3(uz.y, -uz.x, 0));
vec3 uy = cross(uz, ux);
return mat3(ux, uy, uz);
}
bool project_needs_rotation(vec3 commonPosition, out mat3 transform) {
if (project.projectionMode == PROJECTION_MODE_GLOBE) {
transform = project_get_orientation_matrix(commonPosition);
return true;
}
return false;
}
vec3 project_normal(vec3 vector) {
vec4 normal_modelspace = project.modelMatrix * vec4(vector, 0.0);
vec3 n = normalize(normal_modelspace.xyz * project.commonUnitsPerMeter);
mat3 rotation;
if (project_needs_rotation(geometry.position.xyz, rotation)) {
n = rotation * n;
}
return n;
}
vec4 project_offset_(vec4 offset) {
float dy = offset.y;
vec3 commonUnitsPerWorldUnit = project.commonUnitsPerWorldUnit + project.commonUnitsPerWorldUnit2 * dy;
return vec4(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}
vec2 project_mercator_(vec2 lnglat) {
float x = lnglat.x;
if (project.wrapLongitude) {
x = mod(x + 180., 360.0) - 180.;
}
float y = clamp(lnglat.y, -89.9, 89.9);
return vec2(
radians(x) + PI,
PI + log(tan_fp32(PI * 0.25 + radians(y) * 0.5))
) * WORLD_SCALE;
}
vec3 project_globe_(vec3 lnglatz) {
float lambda = radians(lnglatz.x);
float phi = radians(lnglatz.y);
float cosPhi = cos(phi);
float D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;
return vec3(
sin(lambda) * cosPhi,
-cos(lambda) * cosPhi,
sin(phi)
) * D;
}
vec4 project_position(vec4 position, vec3 position64Low) {
vec4 position_world = project.modelMatrix * position;
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
return vec4(
project_mercator_(position_world.xy),
project_size_at_latitude(position_world.z, position_world.y),
position_world.w
);
}
if (project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
position_world.xyz += project.coordinateOrigin;
}
}
if (project.projectionMode == PROJECTION_MODE_GLOBE) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
return vec4(
project_globe_(position_world.xyz),
position_world.w
);
}
}
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
if (abs(position_world.y - project.coordinateOrigin.y) > 0.25) {
return vec4(
project_mercator_(position_world.xy) - project.commonOrigin.xy,
project_size(position_world.z),
position_world.w
);
}
}
}
if (project.projectionMode == PROJECTION_MODE_IDENTITY ||
(project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
(project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
position_world.xyz -= project.coordinateOrigin;
}
return project_offset_(position_world) + project_offset_(project.modelMatrix * vec4(position64Low, 0.0));
}
vec4 project_position(vec4 position) {
return project_position(position, ZERO_64_LOW);
}
vec3 project_position(vec3 position, vec3 position64Low) {
vec4 projected_position = project_position(vec4(position, 1.0), position64Low);
return projected_position.xyz;
}
vec3 project_position(vec3 position) {
vec4 projected_position = project_position(vec4(position, 1.0), ZERO_64_LOW);
return projected_position.xyz;
}
vec2 project_position(vec2 position) {
vec4 projected_position = project_position(vec4(position, 0.0, 1.0), ZERO_64_LOW);
return projected_position.xy;
}
vec4 project_common_position_to_clipspace(vec4 position, mat4 viewProjectionMatrix, vec4 center) {
return viewProjectionMatrix * position + center;
}
vec4 project_common_position_to_clipspace(vec4 position) {
return project_common_position_to_clipspace(position, project.viewProjectionMatrix, project.center);
}
vec2 project_pixel_size_to_clipspace(vec2 pixels) {
vec2 offset = pixels / project.viewportSize * project.devicePixelRatio * 2.0;
return offset * project.focalDistance;
}
float project_size_to_pixel(float meters) {
return project_size(meters) * project.scale;
}
float project_size_to_pixel(float size, int unit) {
if (unit == UNIT_METERS) return project_size_to_pixel(size);
if (unit == UNIT_COMMON) return size * project.scale;
return size;
}
float project_pixel_size(float pixels) {
return pixels / project.scale;
}
vec2 project_pixel_size(vec2 pixels) {
return pixels / project.scale;
}
`,O2={};function D2(n=O2){return"viewport"in n?E2(n):{}}const Bp={name:"project",dependencies:[rA,Ab],source:I2,vs:N2,getUniforms:D2,uniformTypes:{wrapLongitude:"f32",coordinateSystem:"i32",commonUnitsPerMeter:"vec3<f32>",projectionMode:"i32",scale:"f32",commonUnitsPerWorldUnit:"vec3<f32>",commonUnitsPerWorldUnit2:"vec3<f32>",center:"vec4<f32>",modelMatrix:"mat4x4<f32>",viewProjectionMatrix:"mat4x4<f32>",viewportSize:"vec2<f32>",devicePixelRatio:"f32",focalDistance:"f32",cameraPosition:"vec3<f32>",coordinateOrigin:"vec3<f32>",commonOrigin:"vec3<f32>",pseudoMeters:"f32"}},L2=`// Define a structure to hold both the clip-space position and the common position.
struct ProjectResult {
  clipPosition: vec4<f32>,
  commonPosition: vec4<f32>,
};

// This function mimics the GLSL version with the 'out' parameter by returning both values.
fn project_position_to_clipspace_and_commonspace(
    position: vec3<f32>,
    position64Low: vec3<f32>,
    offset: vec3<f32>
) -> ProjectResult {
  // Compute the projected position.
  let projectedPosition: vec3<f32> = project_position_vec3_f64(position, position64Low);

  // Start with the provided offset.
  var finalOffset: vec3<f32> = offset;

  // Get whether a rotation is needed and the rotation matrix.
  let rotationResult = project_needs_rotation(projectedPosition);

  // If rotation is needed, update the offset.
  if (rotationResult.needsRotation) {
    finalOffset = rotationResult.transform * offset;
  }

  // Compute the common position.
  let commonPosition: vec4<f32> = vec4<f32>(projectedPosition + finalOffset, 1.0);

  // Convert to clip-space.
  let clipPosition: vec4<f32> = project_common_position_to_clipspace(commonPosition);

  return ProjectResult(clipPosition, commonPosition);
}

// A convenience overload that returns only the clip-space position.
fn project_position_to_clipspace(
    position: vec3<f32>,
    position64Low: vec3<f32>,
    offset: vec3<f32>
) -> vec4<f32> {
  return project_position_to_clipspace_and_commonspace(position, position64Low, offset).clipPosition;
}
`,k2=`vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset, out vec4 commonPosition
) {
  vec3 projectedPosition = project_position(position, position64Low);
  mat3 rotation;
  if (project_needs_rotation(projectedPosition, rotation)) {
    // offset is specified as ENU
    // when in globe projection, rotate offset so that the ground alighs with the surface of the globe
    offset = rotation * offset;
  }
  commonPosition = vec4(projectedPosition + offset, 1.0);
  return project_common_position_to_clipspace(commonPosition);
}

vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset
) {
  vec4 commonPosition;
  return project_position_to_clipspace(position, position64Low, offset, commonPosition);
}
`,oc={name:"project32",dependencies:[Bp],source:L2,vs:k2};function F2(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function ia(n,t){const e=ic([],t,n);return GI(e,e,1/e[3]),e}function e_(n,t){const e=n%t;return e<0?t+e:e}function Sd(n,t,e){return n<t?t:n>e?e:n}function B2(n){return Math.log(n)*Math.LOG2E}const Up=Math.log2||B2;function Yi(n,t){if(!n)throw new Error(t||"@math.gl/web-mercator: assertion failed.")}const $r=Math.PI,Ub=$r/4,wr=$r/180,Cd=180/$r,ha=512,Vu=4003e4,n_=85.051129,U2=1.5;function V2(n){return Up(n)}function zu(n){const[t,e]=n;Yi(Number.isFinite(t)),Yi(Number.isFinite(e)&&e>=-90&&e<=90,"invalid latitude");const r=t*wr,i=e*wr,s=ha*(r+$r)/(2*$r),o=ha*($r+Math.log(Math.tan(Ub+i*.5)))/(2*$r);return[s,o]}function fa(n){const[t,e]=n,r=t/ha*(2*$r)-$r,i=2*(Math.atan(Math.exp(e/ha*(2*$r)-$r))-Ub);return[r*Cd,i*Cd]}function z2(n){const{latitude:t}=n;Yi(Number.isFinite(t));const e=Math.cos(t*wr);return V2(Vu*e)-9}function Ef(n){const t=Math.cos(n*wr);return ha/Vu/t}function Td(n){const{latitude:t,longitude:e,highPrecision:r=!1}=n;Yi(Number.isFinite(t)&&Number.isFinite(e));const i=ha,s=Math.cos(t*wr),o=i/360,a=o/s,l=i/Vu/s,c={unitsPerMeter:[l,l,l],metersPerUnit:[1/l,1/l,1/l],unitsPerDegree:[o,a,l],degreesPerUnit:[1/o,1/a,1/l]};if(r){const u=wr*Math.tan(t*wr)/s,h=o*u/2,f=i/Vu*u,d=f/a*l;c.unitsPerDegree2=[0,h,f],c.unitsPerMeter2=[d,0,d]}return c}function Vb(n,t){const[e,r,i]=n,[s,o,a]=t,{unitsPerMeter:l,unitsPerMeter2:c}=Td({longitude:e,latitude:r,highPrecision:!0}),u=zu(n);u[0]+=s*(l[0]+c[0]*o),u[1]+=o*(l[1]+c[1]*o);const h=fa(u),f=(i||0)+(a||0);return Number.isFinite(i)||Number.isFinite(a)?[h[0],h[1],f]:h}function W2(n){const{height:t,pitch:e,bearing:r,altitude:i,scale:s,center:o}=n,a=F2();Bu(a,a,[0,0,-i]),wb(a,a,-e*wr),Sb(a,a,r*wr);const l=s/t;return Fp(a,a,[l,l,l]),o&&Bu(a,a,EI([],o)),a}function H2(n){const{width:t,height:e,altitude:r,pitch:i=0,offset:s,center:o,scale:a,nearZMultiplier:l=1,farZMultiplier:c=1}=n;let{fovy:u=Wu(U2)}=n;r!==void 0&&(u=Wu(r));const h=u*wr,f=i*wr,d=zb(u);let p=d;o&&(p+=o[2]*a/Math.cos(f)/e);const _=h*(.5+(s?s[1]:0)/e),v=Math.sin(_)*p/Math.sin(Sd(Math.PI/2-f-_,.01,Math.PI-.01)),E=Math.sin(f)*v+p,m=p*10,g=Math.min(E*c,m);return{fov:h,aspect:t/e,focalDistance:d,near:l,far:g}}function Wu(n){return 2*Math.atan(.5/n)*Cd}function zb(n){return .5/Math.tan(.5*n*wr)}function Wb(n,t){const[e,r,i=0]=n;return Yi(Number.isFinite(e)&&Number.isFinite(r)&&Number.isFinite(i)),ia(t,[e,r,i,1])}function Vp(n,t,e=0){const[r,i,s]=n;if(Yi(Number.isFinite(r)&&Number.isFinite(i),"invalid pixel coordinate"),Number.isFinite(s))return ia(t,[r,i,s,1]);const o=ia(t,[r,i,0,1]),a=ia(t,[r,i,1,1]),l=o[2],c=a[2],u=l===c?0:((e||0)-l)/(c-l);return yb([],o,a,u)}function j2(n){const{width:t,height:e,bounds:r,minExtent:i=0,maxZoom:s=24,offset:o=[0,0]}=n,[[a,l],[c,u]]=r,h=$2(n.padding),f=zu([a,Sd(u,-85.051129,n_)]),d=zu([c,Sd(l,-85.051129,n_)]),p=[Math.max(Math.abs(d[0]-f[0]),i),Math.max(Math.abs(d[1]-f[1]),i)],_=[t-h.left-h.right-Math.abs(o[0])*2,e-h.top-h.bottom-Math.abs(o[1])*2];Yi(_[0]>0&&_[1]>0);const v=_[0]/p[0],E=_[1]/p[1],m=(h.right-h.left)/2/v,g=(h.top-h.bottom)/2/E,y=[(d[0]+f[0])/2+m,(d[1]+f[1])/2+g],b=fa(y),x=Math.min(s,Up(Math.abs(Math.min(v,E))));return Yi(Number.isFinite(x)),{longitude:b[0],latitude:b[1],zoom:x}}function $2(n=0){return typeof n=="number"?{top:n,bottom:n,left:n,right:n}:(Yi(Number.isFinite(n.top)&&Number.isFinite(n.bottom)&&Number.isFinite(n.left)&&Number.isFinite(n.right)),n)}const r_=Math.PI/180;function X2(n,t=0){const{width:e,height:r,unproject:i}=n,s={targetZ:t},o=i([0,r],s),a=i([e,r],s);let l,c;const u=n.fovy?.5*n.fovy*r_:Math.atan(.5/n.altitude),h=(90-n.pitch)*r_;return u>h-.01?(l=i_(n,0,t),c=i_(n,e,t)):(l=i([0,0],s),c=i([e,0],s)),[o,a,c,l]}function i_(n,t,e){const{pixelUnprojectionMatrix:r}=n,i=ia(r,[t,0,1,1]),s=ia(r,[t,n.height,1,1]),a=(e*n.distanceScales.unitsPerMeter[2]-i[2])/(s[2]-i[2]),l=yb([],i,s,a),c=fa(l);return c.push(e),c}const s_=512;function G2(n){const{width:t,height:e,pitch:r=0}=n;let{longitude:i,latitude:s,zoom:o,bearing:a=0}=n;(i<-180||i>180)&&(i=e_(i+180,360)-180),(a<-180||a>180)&&(a=e_(a+180,360)-180);const l=Up(e/s_);if(o<=l)o=l,s=0;else{const c=e/2/Math.pow(2,o),u=fa([0,c])[1];if(s<u)s=u;else{const h=fa([0,s_-c])[1];s>h&&(s=h)}}return{width:t,height:e,longitude:i,latitude:s,zoom:o,pitch:r,bearing:a}}const Hb=`
uniform shadowUniforms {
  bool drawShadowMap;
  bool useShadowMap;
  vec4 color;
  highp int lightId;
  float lightCount;
  mat4 viewProjectionMatrix0;
  mat4 viewProjectionMatrix1;
  vec4 projectCenter0;
  vec4 projectCenter1;
} shadow;
`,Y2=`
const int max_lights = 2;

out vec3 shadow_vPosition[max_lights];

vec4 shadow_setVertexPosition(vec4 position_commonspace) {
  mat4 viewProjectionMatrices[max_lights];
  viewProjectionMatrices[0] = shadow.viewProjectionMatrix0;
  viewProjectionMatrices[1] = shadow.viewProjectionMatrix1;
  vec4 projectCenters[max_lights];
  projectCenters[0] = shadow.projectCenter0;
  projectCenters[1] = shadow.projectCenter1;

  if (shadow.drawShadowMap) {
    return project_common_position_to_clipspace(position_commonspace, viewProjectionMatrices[shadow.lightId], projectCenters[shadow.lightId]);
  }
  if (shadow.useShadowMap) {
    for (int i = 0; i < max_lights; i++) {
      if(i < int(shadow.lightCount)) {
        vec4 shadowMap_position = project_common_position_to_clipspace(position_commonspace, viewProjectionMatrices[i], projectCenters[i]);
        shadow_vPosition[i] = (shadowMap_position.xyz / shadowMap_position.w + 1.0) / 2.0;
      }
    }
  }
  return gl_Position;
}
`,q2=`
${Hb}
${Y2}
`,K2=`
const int max_lights = 2;
uniform sampler2D shadow_uShadowMap0;
uniform sampler2D shadow_uShadowMap1;

in vec3 shadow_vPosition[max_lights];

const vec4 bitPackShift = vec4(1.0, 255.0, 65025.0, 16581375.0);
const vec4 bitUnpackShift = 1.0 / bitPackShift;
const vec4 bitMask = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0,  0.0);

float shadow_getShadowWeight(vec3 position, sampler2D shadowMap) {
  vec4 rgbaDepth = texture(shadowMap, position.xy);

  float z = dot(rgbaDepth, bitUnpackShift);
  return smoothstep(0.001, 0.01, position.z - z);
}

vec4 shadow_filterShadowColor(vec4 color) {
  if (shadow.drawShadowMap) {
    vec4 rgbaDepth = fract(gl_FragCoord.z * bitPackShift);
    rgbaDepth -= rgbaDepth.gbaa * bitMask;
    return rgbaDepth;
  }
  if (shadow.useShadowMap) {
    float shadowAlpha = 0.0;
    shadowAlpha += shadow_getShadowWeight(shadow_vPosition[0], shadow_uShadowMap0);
    if(shadow.lightCount > 1.0) {
      shadowAlpha += shadow_getShadowWeight(shadow_vPosition[1], shadow_uShadowMap1);
    }
    shadowAlpha *= shadow.color.a / shadow.lightCount;
    float blendedAlpha = shadowAlpha + color.a * (1.0 - shadowAlpha);

    return vec4(
      mix(color.rgb, shadow.color.rgb, shadowAlpha / blendedAlpha),
      blendedAlpha
    );
  }
  return color;
}
`,Z2=`
${Hb}
${K2}
`,J2=sc(r3),Q2=sc(i3),t3=[0,0,0,1],e3=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0];function n3(n,t){const[e,r,i]=n,s=Vp([e,r,i],t);return Number.isFinite(i)?s:[s[0],s[1],0]}function r3({viewport:n,center:t}){return new Jr(n.viewProjectionMatrix).invert().transform(t)}function i3({viewport:n,shadowMatrices:t}){const e=[],r=n.pixelUnprojectionMatrix,i=n.isGeospatial?void 0:1,s=[[0,0,i],[n.width,0,i],[0,n.height,i],[n.width,n.height,i],[0,0,-1],[n.width,0,-1],[0,n.height,-1],[n.width,n.height,-1]].map(o=>n3(o,r));for(const o of t){const a=o.clone().translate(new Ti(n.center).negate()),l=s.map(u=>a.transform(u)),c=new Jr().ortho({left:Math.min(...l.map(u=>u[0])),right:Math.max(...l.map(u=>u[0])),bottom:Math.min(...l.map(u=>u[1])),top:Math.max(...l.map(u=>u[1])),near:Math.min(...l.map(u=>-u[2])),far:Math.max(...l.map(u=>-u[2]))});e.push(c.multiplyRight(o))}return e}function s3(n){const{shadowEnabled:t=!0,project:e}=n;if(!t||!e||!n.shadowMatrices||!n.shadowMatrices.length)return{drawShadowMap:!1,useShadowMap:!1,shadow_uShadowMap0:n.dummyShadowMap,shadow_uShadowMap1:n.dummyShadowMap};const r=Bp.getUniforms(e),i=J2({viewport:e.viewport,center:r.center}),s=[],o=Q2({shadowMatrices:n.shadowMatrices,viewport:e.viewport}).slice();for(let l=0;l<n.shadowMatrices.length;l++){const c=o[l],u=c.clone().translate(new Ti(e.viewport.center).negate());r.coordinateSystem===At.LNGLAT&&r.projectionMode===br.WEB_MERCATOR?(o[l]=u,s[l]=i):(o[l]=c.clone().multiplyRight(e3),s[l]=u.transform(i))}const a={drawShadowMap:!!n.drawToShadowMap,useShadowMap:n.shadowMaps?n.shadowMaps.length>0:!1,color:n.shadowColor||t3,lightId:n.shadowLightId||0,lightCount:n.shadowMatrices.length,shadow_uShadowMap0:n.dummyShadowMap,shadow_uShadowMap1:n.dummyShadowMap};for(let l=0;l<o.length;l++)a[`viewProjectionMatrix${l}`]=o[l],a[`projectCenter${l}`]=s[l];for(let l=0;l<2;l++)a[`shadow_uShadowMap${l}`]=n.shadowMaps&&n.shadowMaps[l]||n.dummyShadowMap;return a}const o_={name:"shadow",dependencies:[Bp],vs:q2,fs:Z2,inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    position = shadow_setVertexPosition(geometry.position);
    `,"fs:DECKGL_FILTER_COLOR":`
    color = shadow_filterShadowColor(color);
    `},getUniforms:s3,uniformTypes:{drawShadowMap:"f32",useShadowMap:"f32",color:"vec4<f32>",lightId:"i32",lightCount:"f32",viewProjectionMatrix0:"mat4x4<f32>",viewProjectionMatrix1:"mat4x4<f32>",projectCenter0:"vec4<f32>",projectCenter1:"vec4<f32>"}},ac={...km,defaultUniforms:{...km.defaultUniforms,useFloatColors:!1},inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    // for picking depth values
    picking_setPickingAttribute(position.z / position.w);
  `,"vs:DECKGL_FILTER_COLOR":`
  picking_setPickingColor(geometry.pickingColor);
  `,"fs:DECKGL_FILTER_COLOR":{order:99,injection:`
  // use highlight color if this fragment belongs to the selected object.
  color = picking_filterHighlightColor(color);

  // use picking color if rendering to picking FBO.
  color = picking_filterPickingColor(color);
    `}}},o3=[Ab],a3=["vs:DECKGL_FILTER_SIZE(inout vec3 size, VertexGeometry geometry)","vs:DECKGL_FILTER_GL_POSITION(inout vec4 position, VertexGeometry geometry)","vs:DECKGL_FILTER_COLOR(inout vec4 color, VertexGeometry geometry)","fs:DECKGL_FILTER_COLOR(inout vec4 color, FragmentGeometry geometry)"],l3=[];function c3(n){const t=Js.getDefaultShaderAssembler();for(const r of o3)t.addDefaultModule(r);const e=n==="glsl"?a3:l3;for(const r of e)t.addShaderHook(r);return t}const u3=[255,255,255],h3=1;let f3=0;class d3{constructor(t={}){this.type="ambient";const{color:e=u3}=t,{intensity:r=h3}=t;this.id=t.id||`ambient-${f3++}`,this.color=e,this.intensity=r}}const p3=[255,255,255],g3=1,m3=[0,0,-1];let _3=0;class a_{constructor(t={}){this.type="directional";const{color:e=p3}=t,{intensity:r=g3}=t,{direction:i=m3}=t,{_shadow:s=!1}=t;this.id=t.id||`directional-${_3++}`,this.color=e,this.intensity=r,this.type="directional",this.direction=new Ti(i).normalize().toArray(),this.shadow=s}getProjectedLight(t){return this}}class y3{constructor(t,e={id:"pass"}){const{id:r}=e;this.id=r,this.device=t,this.props={...e}}setProps(t){Object.assign(this.props,t)}render(t){}cleanup(){}}class zp extends y3{constructor(){super(...arguments),this._lastRenderIndex=-1}render(t){const[e,r]=this.device.canvasContext.getDrawingBufferSize(),i=t.clearCanvas??!0,s=t.clearColor??(i?[0,0,0,0]:!1),o=i?1:!1,a=i?0:!1,l=t.colorMask??15,c={viewport:[0,0,e,r]};t.colorMask&&(c.colorMask=l),t.scissorRect&&(c.scissorRect=t.scissorRect);const u=this.device.beginRenderPass({framebuffer:t.target,parameters:c,clearColor:s,clearDepth:o,clearStencil:a});try{return this._drawLayers(u,t)}finally{u.end(),this.device.submit()}}_drawLayers(t,e){const{target:r,shaderModuleProps:i,viewports:s,views:o,onViewportActive:a,clearStack:l=!0}=e;e.pass=e.pass||"unknown",l&&(this._lastRenderIndex=-1);const c=[];for(const u of s){const h=o&&o[u.id];a?.(u);const f=this._getDrawLayerParams(u,e),d=u.subViewports||[u];for(const p of d){const _=this._drawLayersInViewport(t,{target:r,shaderModuleProps:i,viewport:p,view:h,pass:e.pass,layers:e.layers},f);c.push(_)}}return c}_getDrawLayerParams(t,{layers:e,pass:r,isPicking:i=!1,layerFilter:s,cullRect:o,effects:a,shaderModuleProps:l},c=!1){const u=[],h=jb(this._lastRenderIndex+1),f={layer:e[0],viewport:t,isPicking:i,renderPass:r,cullRect:o},d={};for(let p=0;p<e.length;p++){const _=e[p],v=this._shouldDrawLayer(_,f,s,d),E={shouldDrawLayer:v};v&&!c&&(E.shouldDrawLayer=!0,E.layerRenderIndex=h(_,v),E.shaderModuleProps=this._getShaderModuleProps(_,a,r,l),E.layerParameters={..._.context.deck?.props.parameters,...this.getLayerParameters(_,p,t)}),u[p]=E}return u}_drawLayersInViewport(t,{layers:e,shaderModuleProps:r,pass:i,target:s,viewport:o,view:a},l){const c=v3(this.device,{shaderModuleProps:r,target:s,viewport:o});if(a&&a.props.clear){const h=a.props.clear===!0?{color:!0,depth:!0}:a.props.clear;this.device.beginRenderPass({framebuffer:s,parameters:{viewport:c,scissorRect:c},clearColor:h.color?[0,0,0,0]:!1,clearDepth:h.depth?1:!1}).end()}const u={totalCount:e.length,visibleCount:0,compositeCount:0,pickableCount:0};t.setParameters({viewport:c});for(let h=0;h<e.length;h++){const f=e[h],d=l[h],{shouldDrawLayer:p}=d;if(p&&f.props.pickable&&u.pickableCount++,f.isComposite&&u.compositeCount++,f.isDrawable&&d.shouldDrawLayer){const{layerRenderIndex:_,shaderModuleProps:v,layerParameters:E}=d;u.visibleCount++,this._lastRenderIndex=Math.max(this._lastRenderIndex,_),v.project&&(v.project.viewport=o),f.context.renderPass=t;try{f._drawLayer({renderPass:t,shaderModuleProps:v,uniforms:{layerIndex:_},parameters:E})}catch(m){f.raiseError(m,`drawing ${f} to ${i}`)}}}return u}shouldDrawLayer(t){return!0}getShaderModuleProps(t,e,r){return null}getLayerParameters(t,e,r){return t.props.parameters}_shouldDrawLayer(t,e,r,i){if(!(t.props.visible&&this.shouldDrawLayer(t)))return!1;e.layer=t;let o=t.parent;for(;o;){if(!o.props.visible||!o.filterSubLayer(e))return!1;e.layer=o,o=o.parent}if(r){const a=e.layer.id;if(a in i||(i[a]=r(e)),!i[a])return!1}return t.activateViewport(e.viewport),!0}_getShaderModuleProps(t,e,r,i){const s=this.device.canvasContext.cssToDeviceRatio(),o=t.internalState?.propsInTransition||t.props,a={layer:o,picking:{isActive:!1},project:{viewport:t.context.viewport,devicePixelRatio:s,modelMatrix:o.modelMatrix,coordinateSystem:o.coordinateSystem,coordinateOrigin:o.coordinateOrigin,autoWrapLongitude:t.wrapLongitude}};if(e)for(const l of e)l_(a,l.getShaderModuleProps?.(t,a));return l_(a,this.getShaderModuleProps(t,e,a),i)}}function jb(n=0,t={}){const e={},r=(i,s)=>{const o=i.props._offset,a=i.id,l=i.parent&&i.parent.id;let c;if(l&&!(l in t)&&r(i.parent,!1),l in e){const u=e[l]=e[l]||jb(t[l],t);c=u(i,s),e[a]=u}else Number.isFinite(o)?(c=o+(t[l]||0),e[a]=null):c=n;return s&&c>=n&&(n=c+1),t[a]=c,c};return r}function v3(n,{shaderModuleProps:t,target:e,viewport:r}){const i=t?.project?.devicePixelRatio??n.canvasContext.cssToDeviceRatio(),[,s]=n.canvasContext.getDrawingBufferSize(),o=e?e.height:s,a=r;return[a.x*i,o-(a.y+a.height)*i,a.width*i,a.height*i]}function l_(n,...t){for(const e of t)if(e)for(const r in e)n[r]?Object.assign(n[r],e[r]):n[r]=e[r];return n}class b3 extends zp{constructor(t,e){super(t,e);const r=t.createTexture({format:"rgba8unorm",width:1,height:1,sampler:{minFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},mipmaps:!0}),i=t.createTexture({format:"depth16unorm",width:1,height:1,mipmaps:!1});this.fbo=t.createFramebuffer({id:"shadowmap",width:1,height:1,colorAttachments:[r],depthStencilAttachment:i})}delete(){this.fbo&&(this.fbo.destroy(),this.fbo=null)}getShadowMap(){return this.fbo.colorAttachments[0].texture}render(t){const e=this.fbo,r=this.device.canvasContext.cssToDeviceRatio(),i=t.viewports[0],s=i.width*r,o=i.height*r,a=[1,1,1,1];(s!==e.width||o!==e.height)&&e.resize({width:s,height:o}),super.render({...t,clearColor:a,target:e,pass:"shadow"})}getLayerParameters(t,e,r){return{...t.props.parameters,blend:!1,depthWriteEnabled:!0,depthCompare:"less-equal"}}shouldDrawLayer(t){return t.props.shadowEnabled!==!1}getShaderModuleProps(t,e,r){return{shadow:{project:r.project,drawToShadowMap:!0}}}}const x3={color:[255,255,255],intensity:1},c_=[{color:[255,255,255],intensity:1,direction:[-1,3,-1]},{color:[255,255,255],intensity:.9,direction:[1,-8,-2.5]}],E3=[0,0,0,200/255];class $b{constructor(t={}){this.id="lighting-effect",this.shadowColor=E3,this.shadow=!1,this.directionalLights=[],this.pointLights=[],this.shadowPasses=[],this.dummyShadowMap=null,this.setProps(t)}setup(t){this.context=t;const{device:e,deck:r}=t;this.shadow&&!this.dummyShadowMap&&(this._createShadowPasses(e),r._addDefaultShaderModule(o_),this.dummyShadowMap=e.createTexture({width:1,height:1}))}setProps(t){this.ambientLight=void 0,this.directionalLights=[],this.pointLights=[];for(const e in t){const r=t[e];switch(r.type){case"ambient":this.ambientLight=r;break;case"directional":this.directionalLights.push(r);break;case"point":this.pointLights.push(r);break}}this._applyDefaultLights(),this.shadow=this.directionalLights.some(e=>e.shadow),this.context&&this.setup(this.context),this.props=t}preRender({layers:t,layerFilter:e,viewports:r,onViewportActive:i,views:s}){if(this.shadow){this.shadowMatrices=this._calculateMatrices();for(let o=0;o<this.shadowPasses.length;o++)this.shadowPasses[o].render({layers:t,layerFilter:e,viewports:r,onViewportActive:i,views:s,shaderModuleProps:{shadow:{shadowLightId:o,dummyShadowMap:this.dummyShadowMap,shadowMatrices:this.shadowMatrices}}})}}getShaderModuleProps(t,e){const r=this.shadow?{project:e.project,shadowMaps:this.shadowPasses.map(o=>o.getShadowMap()),dummyShadowMap:this.dummyShadowMap,shadowColor:this.shadowColor,shadowMatrices:this.shadowMatrices}:{},i={enabled:!0,ambientLight:this.ambientLight,directionalLights:this.directionalLights.map(o=>o.getProjectedLight({layer:t})),pointLights:this.pointLights.map(o=>o.getProjectedLight({layer:t}))},s=t.props.material;return{shadow:r,lighting:i,phongMaterial:s,gouraudMaterial:s}}cleanup(t){for(const e of this.shadowPasses)e.delete();this.shadowPasses.length=0,this.dummyShadowMap&&(this.dummyShadowMap.destroy(),this.dummyShadowMap=null,t.deck._removeDefaultShaderModule(o_))}_calculateMatrices(){const t=[];for(const e of this.directionalLights){const r=new Jr().lookAt({eye:new Ti(e.direction).negate()});t.push(r)}return t}_createShadowPasses(t){for(let e=0;e<this.directionalLights.length;e++){const r=new b3(t);this.shadowPasses[e]=r}}_applyDefaultLights(){const{ambientLight:t,pointLights:e,directionalLights:r}=this;!t&&e.length===0&&r.length===0&&(this.ambientLight=new d3(x3),this.directionalLights.push(new a_(c_[0]),new a_(c_[1])))}}class w3{constructor(t={}){this._pool=[],this.opts={overAlloc:2,poolSize:100},this.setOptions(t)}setOptions(t){Object.assign(this.opts,t)}allocate(t,e,{size:r=1,type:i,padding:s=0,copy:o=!1,initialize:a=!1,maxCount:l}){const c=i||t&&t.constructor||Float32Array,u=e*r+s;if(ArrayBuffer.isView(t)){if(u<=t.length)return t;if(u*t.BYTES_PER_ELEMENT<=t.buffer.byteLength)return new c(t.buffer,0,u)}let h=1/0;l&&(h=l*r+s);const f=this._allocate(c,u,a,h);return t&&o?f.set(t):a||f.fill(0,0,4),this._release(t),f}release(t){this._release(t)}_allocate(t,e,r,i){let s=Math.max(Math.ceil(e*this.opts.overAlloc),1);s>i&&(s=i);const o=this._pool,a=t.BYTES_PER_ELEMENT*s,l=o.findIndex(c=>c.byteLength>=a);if(l>=0){const c=new t(o.splice(l,1)[0],0,s);return r&&c.fill(0),c}return new t(s)}_release(t){if(!ArrayBuffer.isView(t))return;const e=this._pool,{buffer:r}=t,{byteLength:i}=r,s=e.findIndex(o=>o.byteLength>=i);s<0?e.push(r):(s>0||e.length<this.opts.poolSize)&&e.splice(s,0,r),e.length>this.opts.poolSize&&e.shift()}}const da=new w3;function cl(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function S3(n){return[n[12],n[13],n[14]]}function C3(n){return{left:Ho(n[3]+n[0],n[7]+n[4],n[11]+n[8],n[15]+n[12]),right:Ho(n[3]-n[0],n[7]-n[4],n[11]-n[8],n[15]-n[12]),bottom:Ho(n[3]+n[1],n[7]+n[5],n[11]+n[9],n[15]+n[13]),top:Ho(n[3]-n[1],n[7]-n[5],n[11]-n[9],n[15]-n[13]),near:Ho(n[3]+n[2],n[7]+n[6],n[11]+n[10],n[15]+n[14]),far:Ho(n[3]-n[2],n[7]-n[6],n[11]-n[10],n[15]-n[14])}}const u_=new Ti;function Ho(n,t,e,r){u_.set(n,t,e);const i=u_.len();return{distance:r/i,normal:new Ti(-n/i,-t/i,-e/i)}}function T3(n){return n-Math.fround(n)}let Qa;function wf(n,t){const{size:e=1,startIndex:r=0}=t,i=t.endIndex!==void 0?t.endIndex:n.length,s=(i-r)/e;Qa=da.allocate(Qa,s,{type:Float32Array,size:e*2});let o=r,a=0;for(;o<i;){for(let l=0;l<e;l++){const c=n[o++];Qa[a+l]=c,Qa[a+l+e]=T3(c)}a+=e*2}return Qa.subarray(0,s*e*2)}function P3(n){let t=null,e=!1;for(const r of n)r&&(t?(e||(t=[[t[0][0],t[0][1]],[t[1][0],t[1][1]]],e=!0),t[0][0]=Math.min(t[0][0],r[0][0]),t[0][1]=Math.min(t[0][1],r[0][1]),t[1][0]=Math.max(t[1][0],r[1][0]),t[1][1]=Math.max(t[1][1],r[1][1])):t=r);return t}const I3=Math.PI/180,A3=cl(),h_=[0,0,0],M3={unitsPerMeter:[1,1,1],metersPerUnit:[1,1,1]};function R3({width:n,height:t,orthographic:e,fovyRadians:r,focalDistance:i,padding:s,near:o,far:a}){const l=n/t,c=e?new Jr().orthographic({fovy:r,aspect:l,focalDistance:i,near:o,far:a}):new Jr().perspective({fovy:r,aspect:l,near:o,far:a});if(s){const{left:u=0,right:h=0,top:f=0,bottom:d=0}=s,p=ms((u+n-h)/2,0,n)-n/2,_=ms((f+t-d)/2,0,t)-t/2;c[8]-=p*2/n,c[9]+=_*2/t}return c}class lc{constructor(t={}){this._frustumPlanes={},this.id=t.id||this.constructor.displayName||"viewport",this.x=t.x||0,this.y=t.y||0,this.width=t.width||1,this.height=t.height||1,this.zoom=t.zoom||0,this.padding=t.padding,this.distanceScales=t.distanceScales||M3,this.focalDistance=t.focalDistance||1,this.position=t.position||h_,this.modelMatrix=t.modelMatrix||null;const{longitude:e,latitude:r}=t;this.isGeospatial=Number.isFinite(r)&&Number.isFinite(e),this._initProps(t),this._initMatrices(t),this.equals=this.equals.bind(this),this.project=this.project.bind(this),this.unproject=this.unproject.bind(this),this.projectPosition=this.projectPosition.bind(this),this.unprojectPosition=this.unprojectPosition.bind(this),this.projectFlat=this.projectFlat.bind(this),this.unprojectFlat=this.unprojectFlat.bind(this)}get subViewports(){return null}get metersPerPixel(){return this.distanceScales.metersPerUnit[2]/this.scale}get projectionMode(){return this.isGeospatial?this.zoom<12?br.WEB_MERCATOR:br.WEB_MERCATOR_AUTO_OFFSET:br.IDENTITY}equals(t){return t instanceof lc?this===t?!0:t.width===this.width&&t.height===this.height&&t.scale===this.scale&&Al(t.projectionMatrix,this.projectionMatrix)&&Al(t.viewMatrix,this.viewMatrix):!1}project(t,{topLeft:e=!0}={}){const r=this.projectPosition(t),i=Wb(r,this.pixelProjectionMatrix),[s,o]=i,a=e?o:this.height-o;return t.length===2?[s,a]:[s,a,i[2]]}unproject(t,{topLeft:e=!0,targetZ:r}={}){const[i,s,o]=t,a=e?s:this.height-s,l=r&&r*this.distanceScales.unitsPerMeter[2],c=Vp([i,a,o],this.pixelUnprojectionMatrix,l),[u,h,f]=this.unprojectPosition(c);return Number.isFinite(o)?[u,h,f]:Number.isFinite(r)?[u,h,r]:[u,h]}projectPosition(t){const[e,r]=this.projectFlat(t),i=(t[2]||0)*this.distanceScales.unitsPerMeter[2];return[e,r,i]}unprojectPosition(t){const[e,r]=this.unprojectFlat(t),i=(t[2]||0)*this.distanceScales.metersPerUnit[2];return[e,r,i]}projectFlat(t){if(this.isGeospatial){const e=zu(t);return e[1]=ms(e[1],-318,830),e}return t}unprojectFlat(t){return this.isGeospatial?fa(t):t}getBounds(t={}){const e={targetZ:t.z||0},r=this.unproject([0,0],e),i=this.unproject([this.width,0],e),s=this.unproject([0,this.height],e),o=this.unproject([this.width,this.height],e);return[Math.min(r[0],i[0],s[0],o[0]),Math.min(r[1],i[1],s[1],o[1]),Math.max(r[0],i[0],s[0],o[0]),Math.max(r[1],i[1],s[1],o[1])]}getDistanceScales(t){return t&&this.isGeospatial?Td({longitude:t[0],latitude:t[1],highPrecision:!0}):this.distanceScales}containsPixel({x:t,y:e,width:r=1,height:i=1}){return t<this.x+this.width&&this.x<t+r&&e<this.y+this.height&&this.y<e+i}getFrustumPlanes(){return this._frustumPlanes.near?this._frustumPlanes:(Object.assign(this._frustumPlanes,C3(this.viewProjectionMatrix)),this._frustumPlanes)}panByPosition(t,e){return null}_initProps(t){const e=t.longitude,r=t.latitude;this.isGeospatial&&(Number.isFinite(t.zoom)||(this.zoom=z2({latitude:r})+Math.log2(this.focalDistance)),this.distanceScales=t.distanceScales||Td({latitude:r,longitude:e}));const i=Math.pow(2,this.zoom);this.scale=i;const{position:s,modelMatrix:o}=t;let a=h_;if(s&&(a=o?new Jr(o).transformAsVector(s,[]):s),this.isGeospatial){const l=this.projectPosition([e,r,0]);this.center=new Ti(a).scale(this.distanceScales.unitsPerMeter).add(l)}else this.center=this.projectPosition(a)}_initMatrices(t){const{viewMatrix:e=A3,projectionMatrix:r=null,orthographic:i=!1,fovyRadians:s,fovy:o=75,near:a=.1,far:l=1e3,padding:c=null,focalDistance:u=1}=t;this.viewMatrixUncentered=e,this.viewMatrix=new Jr().multiplyRight(e).translate(new Ti(this.center).negate()),this.projectionMatrix=r||R3({width:this.width,height:this.height,orthographic:i,fovyRadians:s||o*I3,focalDistance:u,padding:c,near:a,far:l});const h=cl();eo(h,h,this.projectionMatrix),eo(h,h,this.viewMatrix),this.viewProjectionMatrix=h,this.viewMatrixInverse=_d([],this.viewMatrix)||this.viewMatrix,this.cameraPosition=S3(this.viewMatrixInverse);const f=cl(),d=cl();Fp(f,f,[this.width/2,-this.height/2,1]),Bu(f,f,[1,-1,0]),eo(d,f,this.viewProjectionMatrix),this.pixelProjectionMatrix=d,this.pixelUnprojectionMatrix=_d(cl(),this.pixelProjectionMatrix),this.pixelUnprojectionMatrix||It.warn("Pixel project matrix not invertible")()}}lc.displayName="Viewport";let Wp=class Pd extends lc{constructor(t={}){const{latitude:e=0,longitude:r=0,zoom:i=0,pitch:s=0,bearing:o=0,nearZMultiplier:a=.1,farZMultiplier:l=1.01,nearZ:c,farZ:u,orthographic:h=!1,projectionMatrix:f,repeat:d=!1,worldOffset:p=0,position:_,padding:v,legacyMeterSizes:E=!1}=t;let{width:m,height:g,altitude:y=1.5}=t;const b=Math.pow(2,i);m=m||1,g=g||1;let x,w=null;if(f)y=f[5]/2,x=Wu(y);else{t.fovy?(x=t.fovy,y=zb(x)):x=Wu(y);let I;if(v){const{top:T=0,bottom:M=0}=v;I=[0,ms((T+g-M)/2,0,g)-g/2]}w=H2({width:m,height:g,scale:b,center:_&&[0,0,_[2]*Ef(e)],offset:I,pitch:s,fovy:x,nearZMultiplier:a,farZMultiplier:l}),Number.isFinite(c)&&(w.near=c),Number.isFinite(u)&&(w.far=u)}let S=W2({height:g,pitch:s,bearing:o,scale:b,altitude:y});p&&(S=new Jr().translate([512*p,0,0]).multiplyLeft(S)),super({...t,width:m,height:g,viewMatrix:S,longitude:r,latitude:e,zoom:i,...w,fovy:x,focalDistance:y}),this.latitude=e,this.longitude=r,this.zoom=i,this.pitch=s,this.bearing=o,this.altitude=y,this.fovy=x,this.orthographic=h,this._subViewports=d?[]:null,this._pseudoMeters=E,Object.freeze(this)}get subViewports(){if(this._subViewports&&!this._subViewports.length){const t=this.getBounds(),e=Math.floor((t[0]+180)/360),r=Math.ceil((t[2]-180)/360);for(let i=e;i<=r;i++){const s=i?new Pd({...this,worldOffset:i}):this;this._subViewports.push(s)}}return this._subViewports}projectPosition(t){if(this._pseudoMeters)return super.projectPosition(t);const[e,r]=this.projectFlat(t),i=(t[2]||0)*Ef(t[1]);return[e,r,i]}unprojectPosition(t){if(this._pseudoMeters)return super.unprojectPosition(t);const[e,r]=this.unprojectFlat(t),i=(t[2]||0)/Ef(r);return[e,r,i]}addMetersToLngLat(t,e){return Vb(t,e)}panByPosition(t,e){const r=Vp(e,this.pixelUnprojectionMatrix),i=this.projectFlat(t),s=Dm([],i,pI([],r)),o=Dm([],this.center,s),[a,l]=this.unprojectFlat(o);return{longitude:a,latitude:l}}getBounds(t={}){const e=X2(this,t.z||0);return[Math.min(e[0][0],e[1][0],e[2][0],e[3][0]),Math.min(e[0][1],e[1][1],e[2][1],e[3][1]),Math.max(e[0][0],e[1][0],e[2][0],e[3][0]),Math.max(e[0][1],e[1][1],e[2][1],e[3][1])]}fitBounds(t,e={}){const{width:r,height:i}=this,{longitude:s,latitude:o,zoom:a}=j2({width:r,height:i,bounds:t,...e});return new Pd({width:r,height:i,longitude:s,latitude:o,zoom:a})}};Wp.displayName="WebMercatorViewport";const f_=[0,0,0];function Sf(n,t,e=!1){const r=t.projectPosition(n);if(e&&t instanceof Wp){const[i,s,o=0]=n,a=t.getDistanceScales([i,s]);r[2]=o*a.unitsPerMeter[2]}return r}function N3(n){const{viewport:t,modelMatrix:e,coordinateOrigin:r}=n;let{coordinateSystem:i,fromCoordinateSystem:s,fromCoordinateOrigin:o}=n;return i===At.DEFAULT&&(i=t.isGeospatial?At.LNGLAT:At.CARTESIAN),s===void 0&&(s=i),o===void 0&&(o=r),{viewport:t,coordinateSystem:i,coordinateOrigin:r,modelMatrix:e,fromCoordinateSystem:s,fromCoordinateOrigin:o}}function Xb(n,{viewport:t,modelMatrix:e,coordinateSystem:r,coordinateOrigin:i,offsetMode:s}){let[o,a,l=0]=n;switch(e&&([o,a,l]=ic([],[o,a,l,1],e)),r){case At.LNGLAT:return Sf([o,a,l],t,s);case At.LNGLAT_OFFSETS:return Sf([o+i[0],a+i[1],l+(i[2]||0)],t,s);case At.METER_OFFSETS:return Sf(Vb(i,[o,a,l]),t,s);case At.CARTESIAN:default:return t.isGeospatial?[o+i[0],a+i[1],l+i[2]]:t.projectPosition([o,a,l])}}function O3(n,t){const{viewport:e,coordinateSystem:r,coordinateOrigin:i,modelMatrix:s,fromCoordinateSystem:o,fromCoordinateOrigin:a}=N3(t),{autoOffset:l=!0}=t,{geospatialOrigin:c=f_,shaderCoordinateOrigin:u=f_,offsetMode:h=!1}=l?Bb(e,r,i):{},f=Xb(n,{viewport:e,modelMatrix:s,coordinateSystem:o,coordinateOrigin:a,offsetMode:h});if(h){const d=e.projectPosition(c||u);RI(f,f,d)}return f}let D3=1,L3=1;class Gb{time=0;channels=new Map;animations=new Map;playing=!1;lastEngineTime=-1;constructor(){}addChannel(t){const{delay:e=0,duration:r=Number.POSITIVE_INFINITY,rate:i=1,repeat:s=1}=t,o=D3++,a={time:0,delay:e,duration:r,rate:i,repeat:s};return this._setChannelTime(a,this.time),this.channels.set(o,a),o}removeChannel(t){this.channels.delete(t);for(const[e,r]of this.animations)r.channel===t&&this.detachAnimation(e)}isFinished(t){const e=this.channels.get(t);return e===void 0?!1:this.time>=e.delay+e.duration*e.repeat}getTime(t){if(t===void 0)return this.time;const e=this.channels.get(t);return e===void 0?-1:e.time}setTime(t){this.time=Math.max(0,t);const e=this.channels.values();for(const i of e)this._setChannelTime(i,this.time);const r=this.animations.values();for(const i of r){const{animation:s,channel:o}=i;s.setTime(this.getTime(o))}}play(){this.playing=!0}pause(){this.playing=!1,this.lastEngineTime=-1}reset(){this.setTime(0)}attachAnimation(t,e){const r=L3++;return this.animations.set(r,{animation:t,channel:e}),t.setTime(this.getTime(e)),r}detachAnimation(t){this.animations.delete(t)}update(t){this.playing&&(this.lastEngineTime===-1&&(this.lastEngineTime=t),this.setTime(this.time+(t-this.lastEngineTime)),this.lastEngineTime=t)}_setChannelTime(t,e){const r=e-t.delay,i=t.duration*t.repeat;r>=i?t.time=t.duration*t.rate:(t.time=Math.max(0,r)%t.duration,t.time*=t.rate)}}function k3(n){return typeof window<"u"&&window.requestAnimationFrame?window.requestAnimationFrame(n):setTimeout(n,1e3/60)}function F3(n){return typeof window<"u"&&window.cancelAnimationFrame?window.cancelAnimationFrame(n):clearTimeout(n)}let B3=0;const U3={device:null,onAddHTML:()=>"",onInitialize:async()=>null,onRender:()=>{},onFinalize:()=>{},onError:n=>console.error(n),stats:dd.stats.get(`animation-loop-${B3++}`),useDevicePixels:!0,autoResizeViewport:!1,autoResizeDrawingBuffer:!1};class V3{device=null;canvas=null;props;animationProps=null;timeline=null;stats;cpuTime;gpuTime;frameRate;display;needsRedraw="initialized";_initialized=!1;_running=!1;_animationFrameId=null;_nextFramePromise=null;_resolveNextFrame=null;_cpuStartTime=0;_error=null;constructor(t){if(this.props={...U3,...t},t=this.props,!t.device)throw new Error("No device provided");const{useDevicePixels:e=!0}=this.props;this.stats=t.stats||new yh({id:"animation-loop-stats"}),this.cpuTime=this.stats.get("CPU Time"),this.gpuTime=this.stats.get("GPU Time"),this.frameRate=this.stats.get("Frame Rate"),this.setProps({autoResizeViewport:t.autoResizeViewport,autoResizeDrawingBuffer:t.autoResizeDrawingBuffer,useDevicePixels:e}),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this._onMousemove=this._onMousemove.bind(this),this._onMouseleave=this._onMouseleave.bind(this)}destroy(){this.stop(),this._setDisplay(null)}delete(){this.destroy()}setError(t){if(this.props.onError(t),this._error=Error(),this.device?.canvasContext?.canvas instanceof HTMLCanvasElement){const r=document.createElement("h1");r.innerHTML=t.message,r.style.position="absolute",r.style.top="20%",r.style.left="10px",r.style.color="black",r.style.backgroundColor="red",document.body.appendChild(r)}}setNeedsRedraw(t){return this.needsRedraw=this.needsRedraw||t,this}setProps(t){return"autoResizeViewport"in t&&(this.props.autoResizeViewport=t.autoResizeViewport||!1),"autoResizeDrawingBuffer"in t&&(this.props.autoResizeDrawingBuffer=t.autoResizeDrawingBuffer||!1),"useDevicePixels"in t&&(this.props.useDevicePixels=t.useDevicePixels||!1),this}async start(){if(this._running)return this;this._running=!0;try{let t;return this._initialized||(this._initialized=!0,await this._initDevice(),this._initialize(),await this.props.onInitialize(this._getAnimationProps())),this._running?(t!==!1&&(this._cancelAnimationFrame(),this._requestAnimationFrame()),this):null}catch(t){const e=t instanceof Error?t:new Error("Unknown error");throw this.props.onError(e),e}}stop(){return this._running&&(this.animationProps&&!this._error&&this.props.onFinalize(this.animationProps),this._cancelAnimationFrame(),this._nextFramePromise=null,this._resolveNextFrame=null,this._running=!1),this}redraw(){return this.device?.isLost||this._error?this:(this._beginFrameTimers(),this._setupFrame(),this._updateAnimationProps(),this._renderFrame(this._getAnimationProps()),this._clearNeedsRedraw(),this._resolveNextFrame&&(this._resolveNextFrame(this),this._nextFramePromise=null,this._resolveNextFrame=null),this._endFrameTimers(),this)}attachTimeline(t){return this.timeline=t,this.timeline}detachTimeline(){this.timeline=null}waitForRender(){return this.setNeedsRedraw("waitForRender"),this._nextFramePromise||(this._nextFramePromise=new Promise(t=>{this._resolveNextFrame=t})),this._nextFramePromise}async toDataURL(){if(this.setNeedsRedraw("toDataURL"),await this.waitForRender(),this.canvas instanceof HTMLCanvasElement)return this.canvas.toDataURL();throw new Error("OffscreenCanvas")}_initialize(){this._startEventHandling(),this._initializeAnimationProps(),this._updateAnimationProps(),this._resizeCanvasDrawingBuffer(),this._resizeViewport()}_setDisplay(t){this.display&&(this.display.destroy(),this.display.animationLoop=null),t&&(t.animationLoop=this),this.display=t}_requestAnimationFrame(){this._running&&(this._animationFrameId=k3(this._animationFrame.bind(this)))}_cancelAnimationFrame(){this._animationFrameId!==null&&(F3(this._animationFrameId),this._animationFrameId=null)}_animationFrame(){this._running&&(this.redraw(),this._requestAnimationFrame())}_renderFrame(t){if(this.display){this.display._renderFrame(t);return}this.props.onRender(this._getAnimationProps()),this.device?.submit()}_clearNeedsRedraw(){this.needsRedraw=!1}_setupFrame(){this._resizeCanvasDrawingBuffer(),this._resizeViewport()}_initializeAnimationProps(){const t=this.device?.canvasContext?.canvas;if(!this.device||!t)throw new Error("loop");this.animationProps={animationLoop:this,device:this.device,canvas:t,timeline:this.timeline,useDevicePixels:this.props.useDevicePixels,needsRedraw:!1,width:1,height:1,aspect:1,time:0,startTime:Date.now(),engineTime:0,tick:0,tock:0,_mousePosition:null}}_getAnimationProps(){if(!this.animationProps)throw new Error("animationProps");return this.animationProps}_updateAnimationProps(){if(!this.animationProps)return;const{width:t,height:e,aspect:r}=this._getSizeAndAspect();(t!==this.animationProps.width||e!==this.animationProps.height)&&this.setNeedsRedraw("drawing buffer resized"),r!==this.animationProps.aspect&&this.setNeedsRedraw("drawing buffer aspect changed"),this.animationProps.width=t,this.animationProps.height=e,this.animationProps.aspect=r,this.animationProps.needsRedraw=this.needsRedraw,this.animationProps.engineTime=Date.now()-this.animationProps.startTime,this.timeline&&this.timeline.update(this.animationProps.engineTime),this.animationProps.tick=Math.floor(this.animationProps.time/1e3*60),this.animationProps.tock++,this.animationProps.time=this.timeline?this.timeline.getTime():this.animationProps.engineTime}async _initDevice(){if(this.device=await this.props.device,!this.device)throw new Error("No device provided");this.canvas=this.device.canvasContext?.canvas||null}_createInfoDiv(){if(this.canvas&&this.props.onAddHTML){const t=document.createElement("div");document.body.appendChild(t),t.style.position="relative";const e=document.createElement("div");e.style.position="absolute",e.style.left="10px",e.style.bottom="10px",e.style.width="300px",e.style.background="white",this.canvas instanceof HTMLCanvasElement&&t.appendChild(this.canvas),t.appendChild(e);const r=this.props.onAddHTML(e);r&&(e.innerHTML=r)}}_getSizeAndAspect(){if(!this.device)return{width:1,height:1,aspect:1};const[t,e]=this.device?.canvasContext?.getPixelSize()||[1,1];let r=1;const i=this.device?.canvasContext?.canvas;return i&&i.clientHeight?r=i.clientWidth/i.clientHeight:t>0&&e>0&&(r=t/e),{width:t,height:e,aspect:r}}_resizeViewport(){this.props.autoResizeViewport&&this.device.gl&&this.device.gl.viewport(0,0,this.device.gl.drawingBufferWidth,this.device.gl.drawingBufferHeight)}_resizeCanvasDrawingBuffer(){this.props.autoResizeDrawingBuffer&&this.device?.canvasContext?.resize({useDevicePixels:this.props.useDevicePixels})}_beginFrameTimers(){this.frameRate.timeEnd(),this.frameRate.timeStart(),this.cpuTime.timeStart()}_endFrameTimers(){this.cpuTime.timeEnd()}_startEventHandling(){this.canvas&&(this.canvas.addEventListener("mousemove",this._onMousemove.bind(this)),this.canvas.addEventListener("mouseleave",this._onMouseleave.bind(this)))}_onMousemove(t){t instanceof MouseEvent&&(this._getAnimationProps()._mousePosition=[t.offsetX,t.offsetY])}_onMouseleave(t){this._getAnimationProps()._mousePosition=null}}const Cf={};function Ch(n="id"){Cf[n]=Cf[n]||1;const t=Cf[n]++;return`${n}-${t}`}class d_{id;userData={};topology;bufferLayout=[];vertexCount;indices;attributes;constructor(t){if(this.id=t.id||Ch("geometry"),this.topology=t.topology,this.indices=t.indices||null,this.attributes=t.attributes,this.vertexCount=t.vertexCount,this.bufferLayout=t.bufferLayout||[],this.indices&&!(this.indices.usage&Yt.INDEX))throw new Error("Index buffer must have INDEX usage")}destroy(){this.indices?.destroy();for(const t of Object.values(this.attributes))t.destroy()}getVertexCount(){return this.vertexCount}getAttributes(){return this.attributes}getIndexes(){return this.indices||null}_calculateVertexCount(t){return t.byteLength/12}}function z3(n,t){if(t instanceof d_)return t;const e=W3(n,t),{attributes:r,bufferLayout:i}=H3(n,t);return new d_({topology:t.topology||"triangle-list",bufferLayout:i,vertexCount:t.vertexCount,indices:e,attributes:r})}function W3(n,t){if(!t.indices)return;const e=t.indices.value;return n.createBuffer({usage:Yt.INDEX,data:e})}function H3(n,t){const e=[],r={};for(const[s,o]of Object.entries(t.attributes)){let a=s;switch(s){case"POSITION":a="positions";break;case"NORMAL":a="normals";break;case"TEXCOORD_0":a="texCoords";break;case"COLOR_0":a="colors";break}if(o){r[a]=n.createBuffer({data:o.value,id:`${s}-buffer`});const{value:l,size:c,normalized:u}=o;e.push({name:a,format:IP(l,c,u)})}}const i=t._calculateVertexCount(t.attributes,t.indices);return{attributes:r,bufferLayout:e,vertexCount:i}}class Hp{static defaultProps={...la.defaultProps};static getDefaultPipelineFactory(t){return t._lumaData.defaultPipelineFactory=t._lumaData.defaultPipelineFactory||new Hp(t),t._lumaData.defaultPipelineFactory}device;destroyPolicy;_hashCounter=0;_hashes={};_renderPipelineCache={};_computePipelineCache={};constructor(t){this.device=t,this.destroyPolicy=t.props._factoryDestroyPolicy}createRenderPipeline(t){const e={...la.defaultProps,...t},r=this._hashRenderPipeline(e);if(!this._renderPipelineCache[r]){const i=this.device.createRenderPipeline({...e,id:e.id?`${e.id}-cached`:void 0});i.hash=r,this._renderPipelineCache[r]={pipeline:i,useCount:0}}return this._renderPipelineCache[r].useCount++,this._renderPipelineCache[r].pipeline}createComputePipeline(t){const e={...Mu.defaultProps,...t},r=this._hashComputePipeline(e);if(!this._computePipelineCache[r]){const i=this.device.createComputePipeline({...e,id:e.id?`${e.id}-cached`:void 0});i.hash=r,this._computePipelineCache[r]={pipeline:i,useCount:0}}return this._computePipelineCache[r].useCount++,this._computePipelineCache[r].pipeline}release(t){const e=t.hash,r=t instanceof Mu?this._computePipelineCache:this._renderPipelineCache;r[e].useCount--,r[e].useCount===0&&this.destroyPolicy==="unused"&&(r[e].pipeline.destroy(),delete r[e])}_hashComputePipeline(t){return`${this._getHash(t.shader.source)}`}_hashRenderPipeline(t){const e=t.vs?this._getHash(t.vs.source):0,r=t.fs?this._getHash(t.fs.source):0,i="-",s=this._getHash(JSON.stringify(t.bufferLayout));switch(this.device.type){case"webgl":return`${e}/${r}V${i}BL${s}`;default:const o=this._getHash(JSON.stringify(t.parameters));return`${e}/${r}V${i}T${t.topology}P${o}BL${s}`}}_getHash(t){return this._hashes[t]===void 0&&(this._hashes[t]=this._hashCounter++),this._hashes[t]}}class jp{static defaultProps={...Eh.defaultProps};static getDefaultShaderFactory(t){return t._lumaData.defaultShaderFactory||=new jp(t),t._lumaData.defaultShaderFactory}device;destroyPolicy;_cache={};constructor(t){this.device=t,this.destroyPolicy=t.props._factoryDestroyPolicy}createShader(t){const e=this._hashShader(t);let r=this._cache[e];if(!r){const i=this.device.createShader({...t,id:t.id?`${t.id}-cached`:void 0});this._cache[e]=r={shader:i,useCount:0}}return r.useCount++,r.shader}release(t){const e=this._hashShader(t),r=this._cache[e];r&&(r.useCount--,r.useCount===0&&this.destroyPolicy==="unused"&&(delete this._cache[e],r.shader.destroy()))}_hashShader(t){return`${t.stage}:${t.source}`}}function j3(n,t){const e={},r="Values";if(n.attributes.length===0&&!n.varyings?.length)return{"No attributes or varyings":{[r]:"N/A"}};for(const i of n.attributes)if(i){const s=`${i.location} ${i.name}: ${i.type}`;e[`in ${s}`]={[r]:i.stepMode||"vertex"}}for(const i of n.varyings||[]){const s=`${i.location} ${i.name}`;e[`out ${s}`]={[r]:JSON.stringify(i)}}return e}let $e=null,Tf=null;function $3(n,{id:t,minimap:e,opaque:r,top:i="0",left:s="0",rgbaScale:o=1}){$e||($e=document.createElement("canvas"),$e.id=t,$e.title=t,$e.style.zIndex="100",$e.style.position="absolute",$e.style.top=i,$e.style.left=s,$e.style.border="blue 5px solid",$e.style.transform="scaleY(-1)",document.body.appendChild($e),Tf=$e.getContext("2d")),($e.width!==n.width||$e.height!==n.height)&&($e.width=n.width/2,$e.height=n.height/2,$e.style.width="400px",$e.style.height="400px");const a=n.device.readPixelsToArrayWebGL(n),l=Tf?.createImageData(n.width,n.height);if(l){for(let u=0;u<a.length;u+=4)l.data[0+u+0]=a[u+0]*o,l.data[0+u+1]=a[u+1]*o,l.data[0+u+2]=a[u+2]*o,l.data[0+u+3]=r?255:a[u+3]*o;Tf?.putImageData(l,0,0)}}function Id(n,t,e){if(n===t)return!0;if(!e||!n||!t)return!1;if(Array.isArray(n)){if(!Array.isArray(t)||n.length!==t.length)return!1;for(let r=0;r<n.length;r++)if(!Id(n[r],t[r],e-1))return!1;return!0}if(Array.isArray(t))return!1;if(typeof n=="object"&&typeof t=="object"){const r=Object.keys(n),i=Object.keys(t);if(r.length!==i.length)return!1;for(const s of r)if(!t.hasOwnProperty(s)||!Id(n[s],t[s],e-1))return!1;return!0}return!1}function X3(n){return ArrayBuffer.isView(n)&&!(n instanceof DataView)}function G3(n){return Array.isArray(n)?n.length===0||typeof n[0]=="number":!1}function Yb(n){return X3(n)||G3(n)}function Y3(n){return Yb(n)||typeof n=="number"||typeof n=="boolean"}function qb(n){const t={bindings:{},uniforms:{}};return Object.keys(n).forEach(e=>{const r=n[e];Y3(r)?t.uniforms[e]=r:t.bindings[e]=r}),t}class q3{options={disableWarnings:!1};modules;moduleUniforms;moduleBindings;constructor(t,e){Object.assign(this.options,e);const r=xp(Object.values(t).filter(i=>i.dependencies));for(const i of r)t[i.name]=i;tt.log(1,"Creating ShaderInputs with modules",Object.keys(t))(),this.modules=t,this.moduleUniforms={},this.moduleBindings={};for(const[i,s]of Object.entries(t))this._addModule(s),s.name&&i!==s.name&&!this.options.disableWarnings&&tt.warn(`Module name: ${i} vs ${s.name}`)()}destroy(){}setProps(t){for(const e of Object.keys(t)){const r=e,i=t[r]||{},s=this.modules[r];if(!s){this.options.disableWarnings||tt.warn(`Module ${e} not found`)();continue}const o=this.moduleUniforms[r],a=this.moduleBindings[r],l=s.getUniforms?.(i,o)||i,{uniforms:c,bindings:u}=qb(l);this.moduleUniforms[r]={...o,...c},this.moduleBindings[r]={...a,...u}}}getModules(){return Object.values(this.modules)}getUniformValues(){return this.moduleUniforms}getBindingValues(){const t={};for(const e of Object.values(this.moduleBindings))Object.assign(t,e);return t}getDebugTable(){const t={};for(const[e,r]of Object.entries(this.moduleUniforms))for(const[i,s]of Object.entries(r))t[`${e}.${i}`]={type:this.modules[e].uniformTypes?.[i],value:String(s)};return t}_addModule(t){const e=t.name;this.moduleUniforms[e]=t.defaultUniforms||{},this.moduleBindings[e]={}}}let K3="";async function Z3(n,t){const e=new Image;return e.crossOrigin="anonymous",e.src=n.startsWith("http")?n:K3+n,await e.decode(),t?await createImageBitmap(e,t):await createImageBitmap(e)}class Pf{device;id;texture;sampler;view;ready;isReady=!1;destroyed=!1;resolveReady=()=>{};rejectReady=()=>{};get[Symbol.toStringTag](){return"AsyncTexture"}toString(){return`AsyncTexture:"${this.id}"(${this.isReady?"ready":"loading"})`}constructor(t,e){this.device=t,this.id=e.id||Ch("async-texture"),typeof e?.data=="string"&&e.dimension==="2d"&&(e={...e,data:Z3(e.data)}),this.ready=new Promise((r,i)=>{this.resolveReady=()=>{this.isReady=!0,r()},this.rejectReady=i}),this.initAsync(e)}async initAsync(t){const e=t.data;let r;try{r=await Kb(e)}catch(s){this.rejectReady(s)}if(this.destroyed)return;const i={...t,data:r};this.texture=this.device.createTexture(i),this.sampler=this.texture.sampler,this.view=this.texture.view,this.isReady=!0,this.resolveReady()}destroy(){this.texture&&(this.texture.destroy(),this.texture=null),this.destroyed=!0}resize(t){if(!this.isReady)throw new Error("Cannot resize texture before it is ready");if(t.width===this.texture.width&&t.height===this.texture.height)return!1;if(this.texture){const e=this.texture;this.texture=e.clone(t),e.destroy()}return!0}}async function Kb(n){if(n=await n,Array.isArray(n))return await Promise.all(n.map(Kb));if(n&&typeof n=="object"&&n.constructor===Object){const t=n,e=await Promise.all(Object.values(t)),r=Object.keys(t),i={};for(let s=0;s<r.length;s++)i[r[s]]=e[s];return i}return n}const Xs=2,J3=1e4;class qr{static defaultProps={...la.defaultProps,source:void 0,vs:null,fs:null,id:"unnamed",handle:void 0,userData:{},defines:{},modules:[],moduleSettings:void 0,geometry:null,indexBuffer:null,attributes:{},constantAttributes:{},varyings:[],isInstanced:void 0,instanceCount:0,vertexCount:0,shaderInputs:void 0,pipelineFactory:void 0,shaderFactory:void 0,transformFeedback:void 0,shaderAssembler:Js.getDefaultShaderAssembler(),debugShaders:void 0,disableWarnings:void 0};device;id;source;vs;fs;pipelineFactory;shaderFactory;userData={};parameters;topology;bufferLayout;isInstanced=void 0;instanceCount=0;vertexCount;indexBuffer=null;bufferAttributes={};constantAttributes={};bindings={};uniforms={};vertexArray;transformFeedback=null;pipeline;shaderInputs;_uniformStore;_attributeInfos={};_gpuGeometry=null;_getModuleUniforms;props;_pipelineNeedsUpdate="newly created";_needsRedraw="initializing";_destroyed=!1;_lastDrawTimestamp=-1;get[Symbol.toStringTag](){return"Model"}toString(){return`Model(${this.id})`}constructor(t,e){this.props={...qr.defaultProps,...e},e=this.props,this.id=e.id||Ch("model"),this.device=t,Object.assign(this.userData,e.userData);const r=Object.fromEntries(this.props.modules?.map(l=>[l.name,l])||[]),i=e.shaderInputs||new q3(r,{disableWarnings:this.props.disableWarnings});this.setShaderInputs(i);const s=tM(t),o=(this.props.modules?.length>0?this.props.modules:this.shaderInputs?.getModules())||[];if(this.device.type==="webgpu"&&this.props.source){const{source:l,getUniforms:c}=this.props.shaderAssembler.assembleWGSLShader({platformInfo:s,...this.props,modules:o});this.source=l,this._getModuleUniforms=c,this.props.shaderLayout||=sI(this.source)}else{const{vs:l,fs:c,getUniforms:u}=this.props.shaderAssembler.assembleGLSLShaderPair({platformInfo:s,...this.props,modules:o});this.vs=l,this.fs=c,this._getModuleUniforms=u}this.vertexCount=this.props.vertexCount,this.instanceCount=this.props.instanceCount,this.topology=this.props.topology,this.bufferLayout=this.props.bufferLayout,this.parameters=this.props.parameters,e.geometry&&this.setGeometry(e.geometry),this.pipelineFactory=e.pipelineFactory||Hp.getDefaultPipelineFactory(this.device),this.shaderFactory=e.shaderFactory||jp.getDefaultShaderFactory(this.device),this.pipeline=this._updatePipeline(),this.vertexArray=t.createVertexArray({renderPipeline:this.pipeline}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry),"isInstanced"in e&&(this.isInstanced=e.isInstanced),e.instanceCount&&this.setInstanceCount(e.instanceCount),e.vertexCount&&this.setVertexCount(e.vertexCount),e.indexBuffer&&this.setIndexBuffer(e.indexBuffer),e.attributes&&this.setAttributes(e.attributes),e.constantAttributes&&this.setConstantAttributes(e.constantAttributes),e.bindings&&this.setBindings(e.bindings),e.uniforms&&this.setUniformsWebGL(e.uniforms),e.moduleSettings&&this.updateModuleSettingsWebGL(e.moduleSettings),e.transformFeedback&&(this.transformFeedback=e.transformFeedback),Object.seal(this)}destroy(){this._destroyed||(this.pipelineFactory.release(this.pipeline),this.shaderFactory.release(this.pipeline.vs),this.pipeline.fs&&this.shaderFactory.release(this.pipeline.fs),this._uniformStore.destroy(),this._gpuGeometry?.destroy(),this._destroyed=!0)}needsRedraw(){this._getBindingsUpdateTimestamp()>this._lastDrawTimestamp&&this.setNeedsRedraw("contents of bound textures or buffers updated");const t=this._needsRedraw;return this._needsRedraw=!1,t}setNeedsRedraw(t){this._needsRedraw||=t}predraw(){this.updateShaderInputs(),this.pipeline=this._updatePipeline()}draw(t){const e=this._areBindingsLoading();if(e)return tt.info(Xs,`>>> DRAWING ABORTED ${this.id}: ${e} not loaded`)(),!1;try{t.pushDebugGroup(`${this}.predraw(${t})`),this.predraw()}finally{t.popDebugGroup()}let r;try{t.pushDebugGroup(`${this}.draw(${t})`),this._logDrawCallStart(),this.pipeline=this._updatePipeline();const i=this._getBindings();this.pipeline.setBindings(i,{disableWarnings:this.props.disableWarnings}),Ad(this.uniforms)||this.pipeline.setUniformsWebGL(this.uniforms);const{indexBuffer:s}=this.vertexArray,o=s?s.byteLength/(s.indexType==="uint32"?4:2):void 0;r=this.pipeline.draw({renderPass:t,vertexArray:this.vertexArray,isInstanced:this.isInstanced,vertexCount:this.vertexCount,instanceCount:this.instanceCount,indexCount:o,transformFeedback:this.transformFeedback||void 0,parameters:this.parameters,topology:this.topology})}finally{t.popDebugGroup(),this._logDrawCallEnd()}return this._logFramebuffer(t),r?(this._lastDrawTimestamp=this.device.timestamp,this._needsRedraw=!1):this._needsRedraw="waiting for resource initialization",r}setGeometry(t){this._gpuGeometry?.destroy();const e=t&&z3(this.device,t);if(e){this.setTopology(e.topology||"triangle-list");const r=new hf(this.bufferLayout);this.bufferLayout=r.mergeBufferLayouts(e.bufferLayout,this.bufferLayout),this.vertexArray&&this._setGeometryAttributes(e)}this._gpuGeometry=e}setTopology(t){t!==this.topology&&(this.topology=t,this._setPipelineNeedsUpdate("topology"))}setBufferLayout(t){const e=new hf(this.bufferLayout);this.bufferLayout=this._gpuGeometry?e.mergeBufferLayouts(t,this._gpuGeometry.bufferLayout):t,this._setPipelineNeedsUpdate("bufferLayout"),this.pipeline=this._updatePipeline(),this.vertexArray=this.device.createVertexArray({renderPipeline:this.pipeline}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry)}setParameters(t){Id(t,this.parameters,2)||(this.parameters=t,this._setPipelineNeedsUpdate("parameters"))}setInstanceCount(t){this.instanceCount=t,this.isInstanced===void 0&&t>0&&(this.isInstanced=!0),this.setNeedsRedraw("instanceCount")}setVertexCount(t){this.vertexCount=t,this.setNeedsRedraw("vertexCount")}setShaderInputs(t){this.shaderInputs=t,this._uniformStore=new PP(this.shaderInputs.modules);for(const[e,r]of Object.entries(this.shaderInputs.modules))if(Q3(r)){const i=this._uniformStore.getManagedUniformBuffer(this.device,e);this.bindings[`${e}Uniforms`]=i}this.setNeedsRedraw("shaderInputs")}updateShaderInputs(){this._uniformStore.setUniforms(this.shaderInputs.getUniformValues()),this.setBindings(this.shaderInputs.getBindingValues()),this.setNeedsRedraw("shaderInputs")}setBindings(t){Object.assign(this.bindings,t),this.setNeedsRedraw("bindings")}setTransformFeedback(t){this.transformFeedback=t,this.setNeedsRedraw("transformFeedback")}setIndexBuffer(t){this.vertexArray.setIndexBuffer(t),this.setNeedsRedraw("indexBuffer")}setAttributes(t,e){const r=e?.disableWarnings??this.props.disableWarnings;t.indices&&tt.warn(`Model:${this.id} setAttributes() - indexBuffer should be set using setIndexBuffer()`)(),this.bufferLayout=AP(this.pipeline.shaderLayout,this.bufferLayout);const i=new hf(this.bufferLayout);for(const[s,o]of Object.entries(t)){const a=i.getBufferLayout(s);if(!a){r||tt.warn(`Model(${this.id}): Missing layout for buffer "${s}".`)();continue}const l=i.getAttributeNamesForBuffer(a);let c=!1;for(const u of l){const h=this._attributeInfos[u];if(h){const f=this.device.type==="webgpu"?i.getBufferIndex(h.bufferName):h.location;this.vertexArray.setBuffer(f,o),c=!0}}!c&&!r&&tt.warn(`Model(${this.id}): Ignoring buffer "${o.id}" for unknown attribute "${s}"`)()}this.setNeedsRedraw("attributes")}setConstantAttributes(t,e){for(const[r,i]of Object.entries(t)){const s=this._attributeInfos[r];s?this.vertexArray.setConstantWebGL(s.location,i):(e?.disableWarnings??this.props.disableWarnings)||tt.warn(`Model "${this.id}: Ignoring constant supplied for unknown attribute "${r}"`)()}this.setNeedsRedraw("constants")}setUniforms(t){this.setUniformsWebGL(t)}setUniformsWebGL(t){Ad(t)||(this.pipeline.setUniformsWebGL(t),Object.assign(this.uniforms,t)),this.setNeedsRedraw("uniforms")}updateModuleSettingsWebGL(t){const{bindings:e,uniforms:r}=qb(this._getModuleUniforms(t));Object.assign(this.bindings,e),Object.assign(this.uniforms,r),this.setNeedsRedraw("moduleSettings")}_areBindingsLoading(){for(const t of Object.values(this.bindings))if(t instanceof Pf&&!t.isReady)return t.id;return!1}_getBindings(){const t={};for(const[e,r]of Object.entries(this.bindings))r instanceof Pf?r.isReady&&(t[e]=r.texture):t[e]=r;return t}_getBindingsUpdateTimestamp(){let t=0;for(const e of Object.values(this.bindings))e instanceof xh?t=Math.max(t,e.texture.updateTimestamp):e instanceof Yt||e instanceof jt?t=Math.max(t,e.updateTimestamp):e instanceof Pf?t=e.texture?Math.max(t,e.texture.updateTimestamp):1/0:e instanceof Pl||(t=Math.max(t,e.buffer.updateTimestamp));return t}_setGeometryAttributes(t){const e={...t.attributes};for(const[r]of Object.entries(e))!this.pipeline.shaderLayout.attributes.find(i=>i.name===r)&&r!=="positions"&&delete e[r];this.vertexCount=t.vertexCount,this.setIndexBuffer(t.indices||null),this.setAttributes(t.attributes,{disableWarnings:!0}),this.setAttributes(e,{disableWarnings:this.props.disableWarnings}),this.setNeedsRedraw("geometry attributes")}_setPipelineNeedsUpdate(t){this._pipelineNeedsUpdate||=t,this.setNeedsRedraw(t)}_updatePipeline(){if(this._pipelineNeedsUpdate){let t=null,e=null;this.pipeline&&(tt.log(1,`Model ${this.id}: Recreating pipeline because "${this._pipelineNeedsUpdate}".`)(),t=this.pipeline.vs,e=this.pipeline.fs),this._pipelineNeedsUpdate=!1;const r=this.shaderFactory.createShader({id:`${this.id}-vertex`,stage:"vertex",source:this.source||this.vs,debugShaders:this.props.debugShaders});let i=null;this.source?i=r:this.fs&&(i=this.shaderFactory.createShader({id:`${this.id}-fragment`,stage:"fragment",source:this.source||this.fs,debugShaders:this.props.debugShaders})),this.pipeline=this.pipelineFactory.createRenderPipeline({...this.props,bufferLayout:this.bufferLayout,topology:this.topology,parameters:this.parameters,bindings:this._getBindings(),vs:r,fs:i}),this._attributeInfos=W0(this.pipeline.shaderLayout,this.bufferLayout),t&&this.shaderFactory.release(t),e&&this.shaderFactory.release(e)}return this.pipeline}_lastLogTime=0;_logOpen=!1;_logDrawCallStart(){const t=tt.level>3?0:J3;tt.level<2||Date.now()-this._lastLogTime<t||(this._lastLogTime=Date.now(),this._logOpen=!0,tt.group(Xs,`>>> DRAWING MODEL ${this.id}`,{collapsed:tt.level<=2})())}_logDrawCallEnd(){if(this._logOpen){const t=j3(this.pipeline.shaderLayout,this.id);tt.table(Xs,t)();const e=this.shaderInputs.getDebugTable();for(const[i,s]of Object.entries(this.uniforms))e[i]={value:s};tt.table(Xs,e)();const r=this._getAttributeDebugTable();tt.table(Xs,this._attributeInfos)(),tt.table(Xs,r)(),tt.groupEnd(Xs)(),this._logOpen=!1}}_drawCount=0;_logFramebuffer(t){const e=this.device.props.debugFramebuffers;if(this._drawCount++,!e)return;const r=t.props.framebuffer;r&&$3(r,{id:r.id,minimap:!0})}_getAttributeDebugTable(){const t={};for(const[e,r]of Object.entries(this._attributeInfos)){const i=this.vertexArray.attributes[r.location];t[r.location]={name:e,type:r.shaderType,values:i?this._getBufferOrConstantValues(i,r.bufferDataType):"null"}}if(this.vertexArray.indexBuffer){const{indexBuffer:e}=this.vertexArray,r=e.indexType==="uint32"?new Uint32Array(e.debugData):new Uint16Array(e.debugData);t.indices={name:"indices",type:e.indexType,values:r.toString()}}return t}_getBufferOrConstantValues(t,e){const r=$0(e);return(t instanceof Yt?new r(t.debugData):t).toString()}}function Q3(n){return!!(n.uniformTypes&&!Ad(n.uniformTypes))}function tM(n){return{type:n.type,shaderLanguage:n.info.shadingLanguage,shaderLanguageVersion:n.info.shadingLanguageVersion,gpu:n.info.gpu,features:n.features}}function Ad(n){for(const t in n)return!1;return!0}class pa{device;model;transformFeedback;static defaultProps={...qr.defaultProps,outputs:void 0,feedbackBuffers:void 0};static isSupported(t){return t?.info?.type==="webgl"}constructor(t,e=pa.defaultProps){if(!pa.isSupported(t))throw new Error("BufferTransform not yet implemented on WebGPU");this.device=t,this.model=new qr(this.device,{id:e.id||"buffer-transform-model",fs:e.fs||MT(),topology:e.topology||"point-list",varyings:e.outputs||e.varyings,...e}),this.transformFeedback=this.device.createTransformFeedback({layout:this.model.pipeline.shaderLayout,buffers:e.feedbackBuffers}),this.model.setTransformFeedback(this.transformFeedback),Object.seal(this)}destroy(){this.model&&this.model.destroy()}delete(){this.destroy()}run(t){t?.inputBuffers&&this.model.setAttributes(t.inputBuffers),t?.outputBuffers&&this.transformFeedback.setBuffers(t.outputBuffers);const e=this.device.beginRenderPass(t);this.model.draw(e),e.end()}getBuffer(t){return this.transformFeedback.getBuffer(t)}readAsync(t){const e=this.getBuffer(t);if(!e)throw new Error("BufferTransform#getBuffer");if(e instanceof Yt)return e.readAsync();const{buffer:r,byteOffset:i=0,byteLength:s=r.byteLength}=e;return r.readAsync(i,s)}}let ga=class{id;topology;vertexCount;indices;attributes;userData={};constructor(t){const{attributes:e={},indices:r=null,vertexCount:i=null}=t;this.id=t.id||Ch("geometry"),this.topology=t.topology,r&&(this.indices=ArrayBuffer.isView(r)?{value:r,size:1}:r),this.attributes={};for(const[s,o]of Object.entries(e)){const a=ArrayBuffer.isView(o)?{value:o}:o;if(!ArrayBuffer.isView(a.value))throw new Error(`${this._print(s)}: must be typed array or object with value as typed array`);if((s==="POSITION"||s==="positions")&&!a.size&&(a.size=3),s==="indices"){if(this.indices)throw new Error("Multiple indices detected");this.indices=a}else this.attributes[s]=a}this.indices&&this.indices.isIndexed!==void 0&&(this.indices=Object.assign({},this.indices),delete this.indices.isIndexed),this.vertexCount=i||this._calculateVertexCount(this.attributes,this.indices)}getVertexCount(){return this.vertexCount}getAttributes(){return this.indices?{indices:this.indices,...this.attributes}:this.attributes}_print(t){return`Geometry ${this.id} attribute ${t}`}_setAttributes(t,e){return this}_calculateVertexCount(t,e){if(e)return e.value.length;let r=1/0;for(const i of Object.values(t)){const{value:s,size:o,constant:a}=i;!a&&s&&o!==void 0&&o>=1&&(r=Math.min(r,s.length/o))}return r}};const eM={blendColorOperation:"add",blendColorSrcFactor:"one",blendColorDstFactor:"zero",blendAlphaOperation:"add",blendAlphaSrcFactor:"constant-alpha",blendAlphaDstFactor:"zero"};class Zb extends zp{constructor(){super(...arguments),this._colorEncoderState=null}render(t){return"pickingFBO"in t?this._drawPickingBuffer(t):super.render(t)}_drawPickingBuffer({layers:t,layerFilter:e,views:r,viewports:i,onViewportActive:s,pickingFBO:o,deviceRect:{x:a,y:l,width:c,height:u},cullRect:h,effects:f,pass:d="picking",pickZ:p,shaderModuleProps:_}){this.pickZ=p;const v=this._resetColorEncoder(p),E=[a,l,c,u],m=super.render({target:o,layers:t,layerFilter:e,views:r,viewports:i,onViewportActive:s,cullRect:h,effects:f?.filter(y=>y.useInPicking),pass:d,isPicking:!0,shaderModuleProps:_,clearColor:[0,0,0,0],colorMask:15,scissorRect:E});return this._colorEncoderState=null,{decodePickingColor:v&&rM.bind(null,v),stats:m}}shouldDrawLayer(t){const{pickable:e,operation:r}=t.props;return e&&r.includes("draw")||r.includes("terrain")||r.includes("mask")}getShaderModuleProps(t,e,r){return{picking:{isActive:1,isAttribute:this.pickZ},lighting:{enabled:!1}}}getLayerParameters(t,e,r){const i={...t.props.parameters},{pickable:s,operation:o}=t.props;return!this._colorEncoderState||o.includes("terrain")?i.blend=!1:s&&o.includes("draw")&&(Object.assign(i,eM),i.blend=!0,i.blendColor=nM(this._colorEncoderState,t,r)),i}_resetColorEncoder(t){return this._colorEncoderState=t?null:{byLayer:new Map,byAlpha:[]},this._colorEncoderState}}function nM(n,t,e){const{byLayer:r,byAlpha:i}=n;let s,o=r.get(t);return o?(o.viewports.push(e),s=o.a):(s=r.size+1,s<=255?(o={a:s,layer:t,viewports:[e]},r.set(t,o),i[s]=o):(It.warn("Too many pickable layers, only picking the first 255")(),s=0)),[0,0,0,s/255]}function rM(n,t){const e=n.byAlpha[t[3]];return e&&{pickedLayer:e.layer,pickedViewports:e.viewports,pickedObjectIndex:e.layer.decodePickingColor(t)}}const Yo={NO_STATE:"Awaiting state",MATCHED:"Matched. State transferred from previous layer",INITIALIZED:"Initialized",AWAITING_GC:"Discarded. Awaiting garbage collection",AWAITING_FINALIZATION:"No longer matched. Awaiting garbage collection",FINALIZED:"Finalized! Awaiting garbage collection"},Hu=Symbol.for("component"),Ss=Symbol.for("propTypes"),If=Symbol.for("deprecatedProps"),sa=Symbol.for("asyncPropDefaults"),co=Symbol.for("asyncPropOriginal"),_s=Symbol.for("asyncPropResolved");function $p(n,t=()=>!0){return Array.isArray(n)?Jb(n,t,[]):t(n)?[n]:[]}function Jb(n,t,e){let r=-1;for(;++r<n.length;){const i=n[r];Array.isArray(i)?Jb(i,t,e):t(i)&&e.push(i)}return e}function iM({target:n,source:t,start:e=0,count:r=1}){const i=t.length,s=r*i;let o=0;for(let a=e;o<i;o++)n[a++]=t[o];for(;o<s;)o<s-o?(n.copyWithin(e+o,e,e+o),o*=2):(n.copyWithin(e+o,e,e+s-o),o=s);return n}class sM{constructor(t,e,r){this._loadCount=0,this._subscribers=new Set,this.id=t,this.context=r,this.setData(e)}subscribe(t){this._subscribers.add(t)}unsubscribe(t){this._subscribers.delete(t)}inUse(){return this._subscribers.size>0}delete(){}getData(){return this.isLoaded?this._error?Promise.reject(this._error):this._content:this._loader.then(()=>this.getData())}setData(t,e){if(t===this._data&&!e)return;this._data=t;const r=++this._loadCount;let i=t;typeof t=="string"&&(i=Pu(t)),i instanceof Promise?(this.isLoaded=!1,this._loader=i.then(s=>{this._loadCount===r&&(this.isLoaded=!0,this._error=void 0,this._content=s)}).catch(s=>{this._loadCount===r&&(this.isLoaded=!0,this._error=s||!0)})):(this.isLoaded=!0,this._error=void 0,this._content=t);for(const s of this._subscribers)s.onChange(this.getData())}}class oM{constructor(t){this.protocol=t.protocol||"resource://",this._context={device:t.device,gl:t.device?.gl,resourceManager:this},this._resources={},this._consumers={},this._pruneRequest=null}contains(t){return t.startsWith(this.protocol)?!0:t in this._resources}add({resourceId:t,data:e,forceUpdate:r=!1,persistent:i=!0}){let s=this._resources[t];s?s.setData(e,r):(s=new sM(t,e,this._context),this._resources[t]=s),s.persistent=i}remove(t){const e=this._resources[t];e&&(e.delete(),delete this._resources[t])}unsubscribe({consumerId:t}){const e=this._consumers[t];if(e){for(const r in e){const i=e[r],s=this._resources[i.resourceId];s&&s.unsubscribe(i)}delete this._consumers[t],this.prune()}}subscribe({resourceId:t,onChange:e,consumerId:r,requestId:i="default"}){const{_resources:s,protocol:o}=this;t.startsWith(o)&&(t=t.replace(o,""),s[t]||this.add({resourceId:t,data:null,persistent:!1}));const a=s[t];if(this._track(r,i,a,e),a)return a.getData()}prune(){this._pruneRequest||(this._pruneRequest=setTimeout(()=>this._prune(),0))}finalize(){for(const t in this._resources)this._resources[t].delete()}_track(t,e,r,i){const s=this._consumers,o=s[t]=s[t]||{};let a=o[e];const l=a&&a.resourceId&&this._resources[a.resourceId];l&&(l.unsubscribe(a),this.prune()),r&&(a?(a.onChange=i,a.resourceId=r.id):a={onChange:i,resourceId:r.id},o[e]=a,r.subscribe(a))}_prune(){this._pruneRequest=null;for(const t of Object.keys(this._resources)){const e=this._resources[t];!e.persistent&&!e.inUse()&&(e.delete(),delete this._resources[t])}}}const aM="layerManager.setLayers",lM="layerManager.activateViewport";class cM{constructor(t,e){this._lastRenderedLayers=[],this._needsRedraw=!1,this._needsUpdate=!1,this._nextLayers=null,this._debug=!1,this._defaultShaderModulesChanged=!1,this.activateViewport=a=>{_n(lM,this,a),a&&(this.context.viewport=a)};const{deck:r,stats:i,viewport:s,timeline:o}=e||{};this.layers=[],this.resourceManager=new oM({device:t,protocol:"deck://"}),this.context={mousePosition:null,userData:{},layerManager:this,device:t,gl:t?.gl,deck:r,shaderAssembler:c3(t?.info?.shadingLanguage||"glsl"),defaultShaderModules:[vA],renderPass:void 0,stats:i||new yh({id:"deck.gl"}),viewport:s||new lc({id:"DEFAULT-INITIAL-VIEWPORT"}),timeline:o||new Gb,resourceManager:this.resourceManager,onError:void 0},Object.seal(this)}finalize(){this.resourceManager.finalize();for(const t of this.layers)this._finalizeLayer(t)}needsRedraw(t={clearRedrawFlags:!1}){let e=this._needsRedraw;t.clearRedrawFlags&&(this._needsRedraw=!1);for(const r of this.layers){const i=r.getNeedsRedraw(t);e=e||i}return e}needsUpdate(){return this._nextLayers&&this._nextLayers!==this._lastRenderedLayers?"layers changed":this._defaultShaderModulesChanged?"shader modules changed":this._needsUpdate}setNeedsRedraw(t){this._needsRedraw=this._needsRedraw||t}setNeedsUpdate(t){this._needsUpdate=this._needsUpdate||t}getLayers({layerIds:t}={}){return t?this.layers.filter(e=>t.find(r=>e.id.indexOf(r)===0)):this.layers}setProps(t){"debug"in t&&(this._debug=t.debug),"userData"in t&&(this.context.userData=t.userData),"layers"in t&&(this._nextLayers=t.layers),"onError"in t&&(this.context.onError=t.onError)}setLayers(t,e){_n(aM,this,e,t),this._lastRenderedLayers=t;const r=$p(t,Boolean);for(const i of r)i.context=this.context;this._updateLayers(this.layers,r)}updateLayers(){const t=this.needsUpdate();t&&(this.setNeedsRedraw(`updating layers: ${t}`),this.setLayers(this._nextLayers||this._lastRenderedLayers,t)),this._nextLayers=null}addDefaultShaderModule(t){const{defaultShaderModules:e}=this.context;e.find(r=>r.name===t.name)||(e.push(t),this._defaultShaderModulesChanged=!0)}removeDefaultShaderModule(t){const{defaultShaderModules:e}=this.context,r=e.findIndex(i=>i.name===t.name);r>=0&&(e.splice(r,1),this._defaultShaderModulesChanged=!0)}_handleError(t,e,r){r.raiseError(e,`${t} of ${r}`)}_updateLayers(t,e){const r={};for(const o of t)r[o.id]?It.warn(`Multiple old layers with same id ${o.id}`)():r[o.id]=o;if(this._defaultShaderModulesChanged){for(const o of t)o.setNeedsUpdate(),o.setChangeFlags({extensionsChanged:!0});this._defaultShaderModulesChanged=!1}const i=[];this._updateSublayersRecursively(e,r,i),this._finalizeOldLayers(r);let s=!1;for(const o of i)if(o.hasUniformTransition()){s=`Uniform transition in ${o}`;break}this._needsUpdate=s,this.layers=i}_updateSublayersRecursively(t,e,r){for(const i of t){i.context=this.context;const s=e[i.id];s===null&&It.warn(`Multiple new layers with same id ${i.id}`)(),e[i.id]=null;let o=null;try{this._debug&&s!==i&&i.validateProps(),s?(this._transferLayerState(s,i),this._updateLayer(i)):this._initializeLayer(i),r.push(i),o=i.isComposite?i.getSubLayers():null}catch(a){this._handleError("matching",a,i)}o&&this._updateSublayersRecursively(o,e,r)}}_finalizeOldLayers(t){for(const e in t){const r=t[e];r&&this._finalizeLayer(r)}}_initializeLayer(t){try{t._initialize(),t.lifecycle=Yo.INITIALIZED}catch(e){this._handleError("initialization",e,t)}}_transferLayerState(t,e){e._transferState(t),e.lifecycle=Yo.MATCHED,e!==t&&(t.lifecycle=Yo.AWAITING_GC)}_updateLayer(t){try{t._update()}catch(e){this._handleError("update",e,t)}}_finalizeLayer(t){this._needsRedraw=this._needsRedraw||`finalized ${t}`,t.lifecycle=Yo.AWAITING_FINALIZATION;try{t._finalize(),t.lifecycle=Yo.FINALIZED}catch(e){this._handleError("finalization",e,t)}}}function xr(n,t,e){if(n===t)return!0;if(!e||!n||!t)return!1;if(Array.isArray(n)){if(!Array.isArray(t)||n.length!==t.length)return!1;for(let r=0;r<n.length;r++)if(!xr(n[r],t[r],e-1))return!1;return!0}if(Array.isArray(t))return!1;if(typeof n=="object"&&typeof t=="object"){const r=Object.keys(n),i=Object.keys(t);if(r.length!==i.length)return!1;for(const s of r)if(!t.hasOwnProperty(s)||!xr(n[s],t[s],e-1))return!1;return!0}return!1}class uM{constructor(t){this.views=[],this.width=100,this.height=100,this.viewState={},this.controllers={},this.timeline=t.timeline,this._viewports=[],this._viewportMap={},this._isUpdating=!1,this._needsRedraw="First render",this._needsUpdate="Initialize",this._eventManager=t.eventManager,this._eventCallbacks={onViewStateChange:t.onViewStateChange,onInteractionStateChange:t.onInteractionStateChange},Object.seal(this),this.setProps(t)}finalize(){for(const t in this.controllers){const e=this.controllers[t];e&&e.finalize()}this.controllers={}}needsRedraw(t={clearRedrawFlags:!1}){const e=this._needsRedraw;return t.clearRedrawFlags&&(this._needsRedraw=!1),e}setNeedsUpdate(t){this._needsUpdate=this._needsUpdate||t,this._needsRedraw=this._needsRedraw||t}updateViewStates(){for(const t in this.controllers){const e=this.controllers[t];e&&e.updateTransition()}}getViewports(t){return t?this._viewports.filter(e=>e.containsPixel(t)):this._viewports}getViews(){const t={};return this.views.forEach(e=>{t[e.id]=e}),t}getView(t){return this.views.find(e=>e.id===t)}getViewState(t){const e=typeof t=="string"?this.getView(t):t,r=e&&this.viewState[e.getViewStateId()]||this.viewState;return e?e.filterViewState(r):r}getViewport(t){return this._viewportMap[t]}unproject(t,e){const r=this.getViewports(),i={x:t[0],y:t[1]};for(let s=r.length-1;s>=0;--s){const o=r[s];if(o.containsPixel(i)){const a=t.slice();return a[0]-=o.x,a[1]-=o.y,o.unproject(a,e)}}return null}setProps(t){t.views&&this._setViews(t.views),t.viewState&&this._setViewState(t.viewState),("width"in t||"height"in t)&&this._setSize(t.width,t.height),this._isUpdating||this._update()}_update(){this._isUpdating=!0,this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._isUpdating=!1}_setSize(t,e){(t!==this.width||e!==this.height)&&(this.width=t,this.height=e,this.setNeedsUpdate("Size changed"))}_setViews(t){t=$p(t,Boolean),this._diffViews(t,this.views)&&this.setNeedsUpdate("views changed"),this.views=t}_setViewState(t){t?(!xr(t,this.viewState,3)&&this.setNeedsUpdate("viewState changed"),this.viewState=t):It.warn("missing `viewState` or `initialViewState`")()}_createController(t,e){const r=e.type;return new r({timeline:this.timeline,eventManager:this._eventManager,onViewStateChange:this._eventCallbacks.onViewStateChange,onStateChange:this._eventCallbacks.onInteractionStateChange,makeViewport:s=>this.getView(t.id)?.makeViewport({viewState:s,width:this.width,height:this.height})})}_updateController(t,e,r,i){const s=t.controller;if(s&&r){const o={...e,...s,id:t.id,x:r.x,y:r.y,width:r.width,height:r.height};return(!i||i.constructor!==s.type)&&(i=this._createController(t,o)),i&&i.setProps(o),i}return null}_rebuildViewports(){const{views:t}=this,e=this.controllers;this._viewports=[],this.controllers={};let r=!1;for(let i=t.length;i--;){const s=t[i],o=this.getViewState(s),a=s.makeViewport({viewState:o,width:this.width,height:this.height});let l=e[s.id];const c=!!s.controller;c&&!l&&(r=!0),(r||!c)&&l&&(l.finalize(),l=null),this.controllers[s.id]=this._updateController(s,o,a,l),a&&this._viewports.unshift(a)}for(const i in e){const s=e[i];s&&!this.controllers[i]&&s.finalize()}this._buildViewportMap()}_buildViewportMap(){this._viewportMap={},this._viewports.forEach(t=>{t.id&&(this._viewportMap[t.id]=this._viewportMap[t.id]||t)})}_diffViews(t,e){return t.length!==e.length?!0:t.some((r,i)=>!t[i].equals(e[i]))}}const hM=/([0-9]+\.?[0-9]*)(%|px)/;function ss(n){switch(typeof n){case"number":return{position:n,relative:!1};case"string":const t=hM.exec(n);if(t&&t.length>=3){const e=t[2]==="%",r=parseFloat(t[1]);return{position:e?r/100:r,relative:e}}default:throw new Error(`Could not parse position string ${n}`)}}function os(n,t){return n.relative?Math.round(n.position*t):n.position}class fM{constructor(t){const{id:e,x:r=0,y:i=0,width:s="100%",height:o="100%",padding:a=null}=t;this.id=e||this.constructor.displayName||"view",this.props={...t,id:this.id},this._x=ss(r),this._y=ss(i),this._width=ss(s),this._height=ss(o),this._padding=a&&{left:ss(a.left||0),right:ss(a.right||0),top:ss(a.top||0),bottom:ss(a.bottom||0)},this.equals=this.equals.bind(this),Object.seal(this)}equals(t){return this===t?!0:this.constructor===t.constructor&&xr(this.props,t.props,2)}makeViewport({width:t,height:e,viewState:r}){r=this.filterViewState(r);const i=this.getDimensions({width:t,height:e});if(!i.height||!i.width)return null;const s=this.getViewportType(r);return new s({...r,...this.props,...i})}getViewStateId(){const{viewState:t}=this.props;return typeof t=="string"?t:t?.id||this.id}filterViewState(t){if(this.props.viewState&&typeof this.props.viewState=="object"){if(!this.props.viewState.id)return this.props.viewState;const e={...t};for(const r in this.props.viewState)r!=="id"&&(e[r]=this.props.viewState[r]);return e}return t}getDimensions({width:t,height:e}){const r={x:os(this._x,t),y:os(this._y,e),width:os(this._width,t),height:os(this._height,e)};return this._padding&&(r.padding={left:os(this._padding.left,t),top:os(this._padding.top,e),right:os(this._padding.right,t),bottom:os(this._padding.bottom,e)}),r}get controller(){const t=this.props.controller;return t?t===!0?{type:this.ControllerType}:typeof t=="function"?{type:t}:{type:this.ControllerType,...t}:null}}class Th{constructor(t){this._inProgress=!1,this._handle=null,this.time=0,this.settings={duration:0},this._timeline=t}get inProgress(){return this._inProgress}start(t){this.cancel(),this.settings=t,this._inProgress=!0,this.settings.onStart?.(this)}end(){this._inProgress&&(this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1,this.settings.onEnd?.(this))}cancel(){this._inProgress&&(this.settings.onInterrupt?.(this),this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1)}update(){if(!this._inProgress)return!1;if(this._handle===null){const{_timeline:t,settings:e}=this;this._handle=t.addChannel({delay:t.getTime(),duration:e.duration})}return this.time=this._timeline.getTime(this._handle),this._onUpdate(),this.settings.onUpdate?.(this),this._timeline.isFinished(this._handle)&&this.end(),!0}_onUpdate(){}}const p_=()=>{},Md={BREAK:1,SNAP_TO_END:2,IGNORE:3},dM=n=>n,pM=Md.BREAK;class gM{constructor(t){this._onTransitionUpdate=e=>{const{time:r,settings:{interpolator:i,startProps:s,endProps:o,duration:a,easing:l}}=e,c=l(r/a),u=i.interpolateProps(s,o,c);this.propsInTransition=this.getControllerState({...this.props,...u}).getViewportProps(),this.onViewStateChange({viewState:this.propsInTransition,oldViewState:this.props})},this.getControllerState=t.getControllerState,this.propsInTransition=null,this.transition=new Th(t.timeline),this.onViewStateChange=t.onViewStateChange||p_,this.onStateChange=t.onStateChange||p_}finalize(){this.transition.cancel()}getViewportInTransition(){return this.propsInTransition}processViewStateChange(t){let e=!1;const r=this.props;if(this.props=t,!r||this._shouldIgnoreViewportChange(r,t))return!1;if(this._isTransitionEnabled(t)){let i=r;if(this.transition.inProgress){const{interruption:s,endProps:o}=this.transition.settings;i={...r,...s===Md.SNAP_TO_END?o:this.propsInTransition||r}}this._triggerTransition(i,t),e=!0}else this.transition.cancel();return e}updateTransition(){this.transition.update()}_isTransitionEnabled(t){const{transitionDuration:e,transitionInterpolator:r}=t;return(e>0||e==="auto")&&!!r}_isUpdateDueToCurrentTransition(t){return this.transition.inProgress&&this.propsInTransition?this.transition.settings.interpolator.arePropsEqual(t,this.propsInTransition):!1}_shouldIgnoreViewportChange(t,e){return this.transition.inProgress?this.transition.settings.interruption===Md.IGNORE||this._isUpdateDueToCurrentTransition(e):this._isTransitionEnabled(e)?e.transitionInterpolator.arePropsEqual(t,e):!0}_triggerTransition(t,e){const r=this.getControllerState(t),i=this.getControllerState(e).shortestPathFrom(r),s=e.transitionInterpolator,o=s.getDuration?s.getDuration(t,e):e.transitionDuration;if(o===0)return;const a=s.initializeProps(t,i);this.propsInTransition={};const l={duration:o,easing:e.transitionEasing||dM,interpolator:s,interruption:e.transitionInterruption||pM,startProps:a.start,endProps:a.end,onStart:e.onTransitionStart,onUpdate:this._onTransitionUpdate,onInterrupt:this._onTransitionEnd(e.onTransitionInterrupt),onEnd:this._onTransitionEnd(e.onTransitionEnd)};this.transition.start(l),this.onStateChange({inTransition:!0}),this.updateTransition()}_onTransitionEnd(t){return e=>{this.propsInTransition=null,this.onStateChange({inTransition:!1,isZooming:!1,isPanning:!1,isRotating:!1}),t?.(e)}}}function an(n,t){if(!n)throw new Error(t||"deck.gl: assertion failed.")}class mM{constructor(t){const{compare:e,extract:r,required:i}=t;this._propsToCompare=e,this._propsToExtract=r||e,this._requiredProps=i}arePropsEqual(t,e){for(const r of this._propsToCompare)if(!(r in t)||!(r in e)||!Al(t[r],e[r]))return!1;return!0}initializeProps(t,e){const r={},i={};for(const s of this._propsToExtract)(s in t||s in e)&&(r[s]=t[s],i[s]=e[s]);return this._checkRequiredProps(r),this._checkRequiredProps(i),{start:r,end:i}}getDuration(t,e){return e.transitionDuration}_checkRequiredProps(t){this._requiredProps&&this._requiredProps.forEach(e=>{const r=t[e];an(Number.isFinite(r)||Array.isArray(r),`${e} is required for transition`)})}}const _M=["longitude","latitude","zoom","bearing","pitch"],yM=["longitude","latitude","zoom"];class Qb extends mM{constructor(t={}){const e=Array.isArray(t)?t:t.transitionProps,r=Array.isArray(t)?{}:t;r.transitionProps=Array.isArray(e)?{compare:e,required:e}:e||{compare:_M,required:yM},super(r.transitionProps),this.opts=r}initializeProps(t,e){const r=super.initializeProps(t,e),{makeViewport:i,around:s}=this.opts;if(i&&s){const o=i(t),a=i(e),l=o.unproject(s);r.start.around=s,Object.assign(r.end,{around:a.project(l),aroundPosition:l,width:e.width,height:e.height})}return r}interpolateProps(t,e,r){const i={};for(const s of this._propsToExtract)i[s]=Fu(t[s]||0,e[s]||0,r);if(e.aroundPosition&&this.opts.makeViewport){const s=this.opts.makeViewport({...e,...i});Object.assign(i,s.panByPosition(e.aroundPosition,Fu(t.around,e.around,r)))}return i}}const as={transitionDuration:0},vM=300,Dc=n=>1-(1-n)*(1-n),jo={WHEEL:["wheel"],PAN:["panstart","panmove","panend"],PINCH:["pinchstart","pinchmove","pinchend"],MULTI_PAN:["multipanstart","multipanmove","multipanend"],DOUBLE_CLICK:["dblclick"],KEYBOARD:["keydown"]},Gs={};class bM{constructor(t){this.state={},this._events={},this._interactionState={isDragging:!1},this._customEvents=[],this._eventStartBlocked=null,this._panMove=!1,this.invertPan=!1,this.dragMode="rotate",this.inertia=0,this.scrollZoom=!0,this.dragPan=!0,this.dragRotate=!0,this.doubleClickZoom=!0,this.touchZoom=!0,this.touchRotate=!1,this.keyboard=!0,this.transitionManager=new gM({...t,getControllerState:e=>new this.ControllerState(e),onViewStateChange:this._onTransition.bind(this),onStateChange:this._setInteractionState.bind(this)}),this.handleEvent=this.handleEvent.bind(this),this.eventManager=t.eventManager,this.onViewStateChange=t.onViewStateChange||(()=>{}),this.onStateChange=t.onStateChange||(()=>{}),this.makeViewport=t.makeViewport}set events(t){this.toggleEvents(this._customEvents,!1),this.toggleEvents(t,!0),this._customEvents=t,this.props&&this.setProps(this.props)}finalize(){for(const t in this._events)this._events[t]&&this.eventManager?.off(t,this.handleEvent);this.transitionManager.finalize()}handleEvent(t){this._controllerState=void 0;const e=this._eventStartBlocked;switch(t.type){case"panstart":return e?!1:this._onPanStart(t);case"panmove":return this._onPan(t);case"panend":return this._onPanEnd(t);case"pinchstart":return e?!1:this._onPinchStart(t);case"pinchmove":return this._onPinch(t);case"pinchend":return this._onPinchEnd(t);case"multipanstart":return e?!1:this._onMultiPanStart(t);case"multipanmove":return this._onMultiPan(t);case"multipanend":return this._onMultiPanEnd(t);case"dblclick":return this._onDoubleClick(t);case"wheel":return this._onWheel(t);case"keydown":return this._onKeyDown(t);default:return!1}}get controllerState(){return this._controllerState=this._controllerState||new this.ControllerState({makeViewport:this.makeViewport,...this.props,...this.state}),this._controllerState}getCenter(t){const{x:e,y:r}=this.props,{offsetCenter:i}=t;return[i.x-e,i.y-r]}isPointInBounds(t,e){const{width:r,height:i}=this.props;if(e&&e.handled)return!1;const s=t[0]>=0&&t[0]<=r&&t[1]>=0&&t[1]<=i;return s&&e&&e.stopPropagation(),s}isFunctionKeyPressed(t){const{srcEvent:e}=t;return!!(e.metaKey||e.altKey||e.ctrlKey||e.shiftKey)}isDragging(){return this._interactionState.isDragging||!1}blockEvents(t){const e=setTimeout(()=>{this._eventStartBlocked===e&&(this._eventStartBlocked=null)},t);this._eventStartBlocked=e}setProps(t){t.dragMode&&(this.dragMode=t.dragMode),this.props=t,"transitionInterpolator"in t||(t.transitionInterpolator=this._getTransitionProps().transitionInterpolator),this.transitionManager.processViewStateChange(t);const{inertia:e}=t;this.inertia=Number.isFinite(e)?e:e===!0?vM:0;const{scrollZoom:r=!0,dragPan:i=!0,dragRotate:s=!0,doubleClickZoom:o=!0,touchZoom:a=!0,touchRotate:l=!1,keyboard:c=!0}=t,u=!!this.onViewStateChange;this.toggleEvents(jo.WHEEL,u&&r),this.toggleEvents(jo.PAN,u),this.toggleEvents(jo.PINCH,u&&(a||l)),this.toggleEvents(jo.MULTI_PAN,u&&l),this.toggleEvents(jo.DOUBLE_CLICK,u&&o),this.toggleEvents(jo.KEYBOARD,u&&c),this.scrollZoom=r,this.dragPan=i,this.dragRotate=s,this.doubleClickZoom=o,this.touchZoom=a,this.touchRotate=l,this.keyboard=c}updateTransition(){this.transitionManager.updateTransition()}toggleEvents(t,e){this.eventManager&&t.forEach(r=>{this._events[r]!==e&&(this._events[r]=e,e?this.eventManager.on(r,this.handleEvent):this.eventManager.off(r,this.handleEvent))})}updateViewport(t,e=null,r={}){const i={...t.getViewportProps(),...e},s=this.controllerState!==t;if(this.state=t.getState(),this._setInteractionState(r),s){const o=this.controllerState&&this.controllerState.getViewportProps();this.onViewStateChange&&this.onViewStateChange({viewState:i,interactionState:this._interactionState,oldViewState:o,viewId:this.props.id})}}_onTransition(t){this.onViewStateChange({...t,interactionState:this._interactionState,viewId:this.props.id})}_setInteractionState(t){Object.assign(this._interactionState,t),this.onStateChange(this._interactionState)}_onPanStart(t){const e=this.getCenter(t);if(!this.isPointInBounds(e,t))return!1;let r=this.isFunctionKeyPressed(t)||t.rightButton||!1;(this.invertPan||this.dragMode==="pan")&&(r=!r);const i=this.controllerState[r?"panStart":"rotateStart"]({pos:e});return this._panMove=r,this.updateViewport(i,as,{isDragging:!0}),!0}_onPan(t){return this.isDragging()?this._panMove?this._onPanMove(t):this._onPanRotate(t):!1}_onPanEnd(t){return this.isDragging()?this._panMove?this._onPanMoveEnd(t):this._onPanRotateEnd(t):!1}_onPanMove(t){if(!this.dragPan)return!1;const e=this.getCenter(t),r=this.controllerState.pan({pos:e});return this.updateViewport(r,as,{isDragging:!0,isPanning:!0}),!0}_onPanMoveEnd(t){const{inertia:e}=this;if(this.dragPan&&e&&t.velocity){const r=this.getCenter(t),i=[r[0]+t.velocityX*e/2,r[1]+t.velocityY*e/2],s=this.controllerState.pan({pos:i}).panEnd();this.updateViewport(s,{...this._getTransitionProps(),transitionDuration:e,transitionEasing:Dc},{isDragging:!1,isPanning:!0})}else{const r=this.controllerState.panEnd();this.updateViewport(r,null,{isDragging:!1,isPanning:!1})}return!0}_onPanRotate(t){if(!this.dragRotate)return!1;const e=this.getCenter(t),r=this.controllerState.rotate({pos:e});return this.updateViewport(r,as,{isDragging:!0,isRotating:!0}),!0}_onPanRotateEnd(t){const{inertia:e}=this;if(this.dragRotate&&e&&t.velocity){const r=this.getCenter(t),i=[r[0]+t.velocityX*e/2,r[1]+t.velocityY*e/2],s=this.controllerState.rotate({pos:i}).rotateEnd();this.updateViewport(s,{...this._getTransitionProps(),transitionDuration:e,transitionEasing:Dc},{isDragging:!1,isRotating:!0})}else{const r=this.controllerState.rotateEnd();this.updateViewport(r,null,{isDragging:!1,isRotating:!1})}return!0}_onWheel(t){if(!this.scrollZoom)return!1;const e=this.getCenter(t);if(!this.isPointInBounds(e,t))return!1;t.srcEvent.preventDefault();const{speed:r=.01,smooth:i=!1}=this.scrollZoom===!0?{}:this.scrollZoom,{delta:s}=t;let o=2/(1+Math.exp(-Math.abs(s*r)));s<0&&o!==0&&(o=1/o);const a=this.controllerState.zoom({pos:e,scale:o});return this.updateViewport(a,{...this._getTransitionProps({around:e}),transitionDuration:i?250:1},{isZooming:!0,isPanning:!0}),!0}_onMultiPanStart(t){const e=this.getCenter(t);if(!this.isPointInBounds(e,t))return!1;const r=this.controllerState.rotateStart({pos:e});return this.updateViewport(r,as,{isDragging:!0}),!0}_onMultiPan(t){if(!this.touchRotate||!this.isDragging())return!1;const e=this.getCenter(t);e[0]-=t.deltaX;const r=this.controllerState.rotate({pos:e});return this.updateViewport(r,as,{isDragging:!0,isRotating:!0}),!0}_onMultiPanEnd(t){if(!this.isDragging())return!1;const{inertia:e}=this;if(this.touchRotate&&e&&t.velocityY){const r=this.getCenter(t),i=[r[0],r[1]+=t.velocityY*e/2],s=this.controllerState.rotate({pos:i});this.updateViewport(s,{...this._getTransitionProps(),transitionDuration:e,transitionEasing:Dc},{isDragging:!1,isRotating:!0}),this.blockEvents(e)}else{const r=this.controllerState.rotateEnd();this.updateViewport(r,null,{isDragging:!1,isRotating:!1})}return!0}_onPinchStart(t){const e=this.getCenter(t);if(!this.isPointInBounds(e,t))return!1;const r=this.controllerState.zoomStart({pos:e}).rotateStart({pos:e});return Gs._startPinchRotation=t.rotation,Gs._lastPinchEvent=t,this.updateViewport(r,as,{isDragging:!0}),!0}_onPinch(t){if(!this.touchZoom&&!this.touchRotate||!this.isDragging())return!1;let e=this.controllerState;if(this.touchZoom){const{scale:r}=t,i=this.getCenter(t);e=e.zoom({pos:i,scale:r})}if(this.touchRotate){const{rotation:r}=t;e=e.rotate({deltaAngleX:Gs._startPinchRotation-r})}return this.updateViewport(e,as,{isDragging:!0,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:this.touchRotate}),Gs._lastPinchEvent=t,!0}_onPinchEnd(t){if(!this.isDragging())return!1;const{inertia:e}=this,{_lastPinchEvent:r}=Gs;if(this.touchZoom&&e&&r&&t.scale!==r.scale){const i=this.getCenter(t);let s=this.controllerState.rotateEnd();const o=Math.log2(t.scale),a=(o-Math.log2(r.scale))/(t.deltaTime-r.deltaTime),l=Math.pow(2,o+a*e/2);s=s.zoom({pos:i,scale:l}).zoomEnd(),this.updateViewport(s,{...this._getTransitionProps({around:i}),transitionDuration:e,transitionEasing:Dc},{isDragging:!1,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:!1}),this.blockEvents(e)}else{const i=this.controllerState.zoomEnd().rotateEnd();this.updateViewport(i,null,{isDragging:!1,isPanning:!1,isZooming:!1,isRotating:!1})}return Gs._startPinchRotation=null,Gs._lastPinchEvent=null,!0}_onDoubleClick(t){if(!this.doubleClickZoom)return!1;const e=this.getCenter(t);if(!this.isPointInBounds(e,t))return!1;const r=this.isFunctionKeyPressed(t),i=this.controllerState.zoom({pos:e,scale:r?.5:2});return this.updateViewport(i,this._getTransitionProps({around:e}),{isZooming:!0,isPanning:!0}),this.blockEvents(100),!0}_onKeyDown(t){if(!this.keyboard)return!1;const e=this.isFunctionKeyPressed(t),{zoomSpeed:r,moveSpeed:i,rotateSpeedX:s,rotateSpeedY:o}=this.keyboard===!0?{}:this.keyboard,{controllerState:a}=this;let l;const c={};switch(t.srcEvent.code){case"Minus":l=e?a.zoomOut(r).zoomOut(r):a.zoomOut(r),c.isZooming=!0;break;case"Equal":l=e?a.zoomIn(r).zoomIn(r):a.zoomIn(r),c.isZooming=!0;break;case"ArrowLeft":e?(l=a.rotateLeft(s),c.isRotating=!0):(l=a.moveLeft(i),c.isPanning=!0);break;case"ArrowRight":e?(l=a.rotateRight(s),c.isRotating=!0):(l=a.moveRight(i),c.isPanning=!0);break;case"ArrowUp":e?(l=a.rotateUp(o),c.isRotating=!0):(l=a.moveUp(i),c.isPanning=!0);break;case"ArrowDown":e?(l=a.rotateDown(o),c.isRotating=!0):(l=a.moveDown(i),c.isPanning=!0);break;default:return!1}return this.updateViewport(l,this._getTransitionProps(),c),!0}_getTransitionProps(t){const{transition:e}=this;return!e||!e.transitionInterpolator?as:t?{...e,transitionInterpolator:new Qb({...t,...e.transitionInterpolator.opts,makeViewport:this.controllerState.makeViewport})}:e}}class xM{constructor(t,e){this._viewportProps=this.applyConstraints(t),this._state=e}getViewportProps(){return this._viewportProps}getState(){return this._state}}const g_=5,EM=1.2;class wM extends xM{constructor(t){const{width:e,height:r,latitude:i,longitude:s,zoom:o,bearing:a=0,pitch:l=0,altitude:c=1.5,position:u=[0,0,0],maxZoom:h=20,minZoom:f=0,maxPitch:d=60,minPitch:p=0,startPanLngLat:_,startZoomLngLat:v,startRotatePos:E,startBearing:m,startPitch:g,startZoom:y,normalize:b=!0}=t;an(Number.isFinite(s)),an(Number.isFinite(i)),an(Number.isFinite(o)),super({width:e,height:r,latitude:i,longitude:s,zoom:o,bearing:a,pitch:l,altitude:c,maxZoom:h,minZoom:f,maxPitch:d,minPitch:p,normalize:b,position:u},{startPanLngLat:_,startZoomLngLat:v,startRotatePos:E,startBearing:m,startPitch:g,startZoom:y}),this.makeViewport=t.makeViewport}panStart({pos:t}){return this._getUpdatedState({startPanLngLat:this._unproject(t)})}pan({pos:t,startPos:e}){const r=this.getState().startPanLngLat||this._unproject(e);if(!r)return this;const s=this.makeViewport(this.getViewportProps()).panByPosition(r,t);return this._getUpdatedState(s)}panEnd(){return this._getUpdatedState({startPanLngLat:null})}rotateStart({pos:t}){return this._getUpdatedState({startRotatePos:t,startBearing:this.getViewportProps().bearing,startPitch:this.getViewportProps().pitch})}rotate({pos:t,deltaAngleX:e=0,deltaAngleY:r=0}){const{startRotatePos:i,startBearing:s,startPitch:o}=this.getState();if(!i||s===void 0||o===void 0)return this;let a;return t?a=this._getNewRotation(t,i,o,s):a={bearing:s+e,pitch:o+r},this._getUpdatedState(a)}rotateEnd(){return this._getUpdatedState({startBearing:null,startPitch:null})}zoomStart({pos:t}){return this._getUpdatedState({startZoomLngLat:this._unproject(t),startZoom:this.getViewportProps().zoom})}zoom({pos:t,startPos:e,scale:r}){let{startZoom:i,startZoomLngLat:s}=this.getState();if(s||(i=this.getViewportProps().zoom,s=this._unproject(e)||this._unproject(t)),!s)return this;const{maxZoom:o,minZoom:a}=this.getViewportProps();let l=i+Math.log2(r);l=ms(l,a,o);const c=this.makeViewport({...this.getViewportProps(),zoom:l});return this._getUpdatedState({zoom:l,...c.panByPosition(s,t)})}zoomEnd(){return this._getUpdatedState({startZoomLngLat:null,startZoom:null})}zoomIn(t=2){return this._zoomFromCenter(t)}zoomOut(t=2){return this._zoomFromCenter(1/t)}moveLeft(t=100){return this._panFromCenter([t,0])}moveRight(t=100){return this._panFromCenter([-t,0])}moveUp(t=100){return this._panFromCenter([0,t])}moveDown(t=100){return this._panFromCenter([0,-t])}rotateLeft(t=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing-t})}rotateRight(t=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing+t})}rotateUp(t=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch+t})}rotateDown(t=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch-t})}shortestPathFrom(t){const e=t.getViewportProps(),r={...this.getViewportProps()},{bearing:i,longitude:s}=r;return Math.abs(i-e.bearing)>180&&(r.bearing=i<0?i+360:i-360),Math.abs(s-e.longitude)>180&&(r.longitude=s<0?s+360:s-360),r}applyConstraints(t){const{maxZoom:e,minZoom:r,zoom:i}=t;t.zoom=ms(i,r,e);const{maxPitch:s,minPitch:o,pitch:a}=t;t.pitch=ms(a,o,s);const{normalize:l=!0}=t;return l&&Object.assign(t,G2(t)),t}_zoomFromCenter(t){const{width:e,height:r}=this.getViewportProps();return this.zoom({pos:[e/2,r/2],scale:t})}_panFromCenter(t){const{width:e,height:r}=this.getViewportProps();return this.pan({startPos:[e/2,r/2],pos:[e/2+t[0],r/2+t[1]]})}_getUpdatedState(t){return new this.constructor({makeViewport:this.makeViewport,...this.getViewportProps(),...this.getState(),...t})}_unproject(t){const e=this.makeViewport(this.getViewportProps());return t&&e.unproject(t)}_getNewRotation(t,e,r,i){const s=t[0]-e[0],o=t[1]-e[1],a=t[1],l=e[1],{width:c,height:u}=this.getViewportProps(),h=s/c;let f=0;o>0?Math.abs(u-l)>g_&&(f=o/(l-u)*EM):o<0&&l>g_&&(f=1-a/l),f=ms(f,-1,1);const{minPitch:d,maxPitch:p}=this.getViewportProps(),_=i+180*h;let v=r;return f>0?v=r+f*(p-r):f<0&&(v=r-f*(d-r)),{pitch:v,bearing:_}}}class SM extends bM{constructor(){super(...arguments),this.ControllerState=wM,this.transition={transitionDuration:300,transitionInterpolator:new Qb({transitionProps:{compare:["longitude","latitude","zoom","bearing","pitch","position"],required:["longitude","latitude","zoom"]}})},this.dragMode="pan"}setProps(t){t.position=t.position||[0,0,0];const e=this.props;super.setProps(t),(!e||e.height!==t.height)&&this.updateViewport(new this.ControllerState({makeViewport:this.makeViewport,...t,...this.state}))}}class Xp extends fM{constructor(t={}){super(t)}getViewportType(){return Wp}get ControllerType(){return SM}}Xp.displayName="MapView";const CM=new $b;function TM(n,t){const e=n.order??1/0,r=t.order??1/0;return e-r}class PM{constructor(t){this._resolvedEffects=[],this._defaultEffects=[],this.effects=[],this._context=t,this._needsRedraw="Initial render",this._setEffects([])}addDefaultEffect(t){const e=this._defaultEffects;if(!e.find(r=>r.id===t.id)){const r=e.findIndex(i=>TM(i,t)>0);r<0?e.push(t):e.splice(r,0,t),t.setup(this._context),this._setEffects(this.effects)}}setProps(t){"effects"in t&&(xr(t.effects,this.effects,1)||this._setEffects(t.effects))}needsRedraw(t={clearRedrawFlags:!1}){const e=this._needsRedraw;return t.clearRedrawFlags&&(this._needsRedraw=!1),e}getEffects(){return this._resolvedEffects}_setEffects(t){const e={};for(const i of this.effects)e[i.id]=i;const r=[];for(const i of t){const s=e[i.id];let o=i;s&&s!==i?s.setProps?(s.setProps(i.props),o=s):s.cleanup(this._context):s||i.setup(this._context),r.push(o),delete e[i.id]}for(const i in e)e[i].cleanup(this._context);this.effects=r,this._resolvedEffects=r.concat(this._defaultEffects),t.some(i=>i instanceof $b)||this._resolvedEffects.push(CM),this._needsRedraw="effects changed"}finalize(){for(const t of this._resolvedEffects)t.cleanup(this._context);this.effects.length=0,this._resolvedEffects.length=0,this._defaultEffects.length=0}}class IM extends zp{shouldDrawLayer(t){const{operation:e}=t.props;return e.includes("draw")||e.includes("terrain")}}const AM="deckRenderer.renderLayers";class MM{constructor(t){this.device=t,this.layerFilter=null,this.drawPickingColors=!1,this.drawLayersPass=new IM(t),this.pickLayersPass=new Zb(t),this.renderCount=0,this._needsRedraw="Initial render",this.renderBuffers=[],this.lastPostProcessEffect=null}setProps(t){this.layerFilter!==t.layerFilter&&(this.layerFilter=t.layerFilter,this._needsRedraw="layerFilter changed"),this.drawPickingColors!==t.drawPickingColors&&(this.drawPickingColors=t.drawPickingColors,this._needsRedraw="drawPickingColors changed")}renderLayers(t){if(!t.viewports.length)return;const e=this.drawPickingColors?this.pickLayersPass:this.drawLayersPass,r={layerFilter:this.layerFilter,isPicking:this.drawPickingColors,...t};r.effects&&this._preRender(r.effects,r);const i=this.lastPostProcessEffect?this.renderBuffers[0]:r.target;this.lastPostProcessEffect&&(r.clearColor=[0,0,0,0],r.clearCanvas=!0);const s=e.render({...r,target:i});r.effects&&this._postRender(r.effects,r),this.renderCount++,_n(AM,this,s,t)}needsRedraw(t={clearRedrawFlags:!1}){const e=this._needsRedraw;return t.clearRedrawFlags&&(this._needsRedraw=!1),e}finalize(){const{renderBuffers:t}=this;for(const e of t)e.delete();t.length=0}_preRender(t,e){this.lastPostProcessEffect=null,e.preRenderStats=e.preRenderStats||{};for(const r of t)e.preRenderStats[r.id]=r.preRender(e),r.postRender&&(this.lastPostProcessEffect=r.id);this.lastPostProcessEffect&&this._resizeRenderBuffers()}_resizeRenderBuffers(){const{renderBuffers:t}=this,e=this.device.canvasContext.getDrawingBufferSize();t.length===0&&[0,1].map(r=>{const i=this.device.createTexture({sampler:{minFilter:"linear",magFilter:"linear"}});t.push(this.device.createFramebuffer({id:`deck-renderbuffer-${r}`,colorAttachments:[i]}))});for(const r of t)r.resize(e)}_postRender(t,e){const{renderBuffers:r}=this,i={...e,inputBuffer:r[0],swapBuffer:r[1]};for(const s of t)if(s.postRender){i.target=s.id===this.lastPostProcessEffect?e.target:void 0;const o=s.postRender(i);i.inputBuffer=o,i.swapBuffer=o===r[0]?r[1]:r[0]}}}const RM={pickedColor:null,pickedObjectIndex:-1};function NM({pickedColors:n,decodePickingColor:t,deviceX:e,deviceY:r,deviceRadius:i,deviceRect:s}){const{x:o,y:a,width:l,height:c}=s;let u=i*i,h=-1,f=0;for(let d=0;d<c;d++){const p=d+a-r,_=p*p;if(_>u)f+=4*l;else for(let v=0;v<l;v++){if(n[f+3]-1>=0){const m=v+o-e,g=m*m+_;g<=u&&(u=g,h=f)}f+=4}}if(h>=0){const d=n.slice(h,h+4),p=t(d);if(p){const _=Math.floor(h/4/l),v=h/4-_*l;return{...p,pickedColor:d,pickedX:o+v,pickedY:a+_}}It.error("Picked non-existent layer. Is picking buffer corrupt?")()}return RM}function OM({pickedColors:n,decodePickingColor:t}){const e=new Map;if(n){for(let r=0;r<n.length;r+=4)if(n[r+3]-1>=0){const s=n.slice(r,r+4),o=s.join(",");if(!e.has(o)){const a=t(s);a?e.set(o,{...a,color:s}):It.error("Picked non-existent layer. Is picking buffer corrupt?")()}}}return Array.from(e.values())}function tx({pickInfo:n,viewports:t,pixelRatio:e,x:r,y:i,z:s}){let o=t[0];t.length>1&&(o=LM(n?.pickedViewports||t,{x:r,y:i}));let a;if(o){const l=[r-o.x,i-o.y];s!==void 0&&(l[2]=s),a=o.unproject(l)}return{color:null,layer:null,viewport:o,index:-1,picked:!1,x:r,y:i,pixel:[r,i],coordinate:a,devicePixel:n&&"pickedX"in n?[n.pickedX,n.pickedY]:void 0,pixelRatio:e}}function DM(n){const{pickInfo:t,lastPickedInfo:e,mode:r,layers:i}=n,{pickedColor:s,pickedLayer:o,pickedObjectIndex:a}=t,l=o?[o]:[];if(r==="hover"){const h=e.index,f=e.layerId,d=o?o.props.id:null;if(d!==f||a!==h){if(d!==f){const p=i.find(_=>_.props.id===f);p&&l.unshift(p)}e.layerId=d,e.index=a,e.info=null}}const c=tx(n),u=new Map;return u.set(null,c),l.forEach(h=>{let f={...c};h===o&&(f.color=s,f.index=a,f.picked=!0),f=ex({layer:h,info:f,mode:r});const d=f.layer;h===o&&r==="hover"&&(e.info=f),u.set(d.id,f),r==="hover"&&d.updateAutoHighlight(f)}),u}function ex({layer:n,info:t,mode:e}){for(;n&&t;){const r=t.layer||null;t.sourceLayer=r,t.layer=n,t=n.getPickingInfo({info:t,mode:e,sourceLayer:r}),n=n.parent}return t}function LM(n,t){for(let e=n.length-1;e>=0;e--){const r=n[e];if(r.containsPixel(t))return r}return n[0]}class kM{constructor(t){this._pickable=!0,this.device=t,this.pickLayersPass=new Zb(t),this.lastPickedInfo={index:-1,layerId:null,info:null}}setProps(t){"layerFilter"in t&&(this.layerFilter=t.layerFilter),"_pickable"in t&&(this._pickable=t._pickable)}finalize(){this.pickingFBO&&this.pickingFBO.destroy(),this.depthFBO&&this.depthFBO.destroy()}pickObject(t){return this._pickClosestObject(t)}pickObjects(t){return this._pickVisibleObjects(t)}getLastPickedObject({x:t,y:e,layers:r,viewports:i},s=this.lastPickedInfo.info){const o=s&&s.layer&&s.layer.id,a=s&&s.viewport&&s.viewport.id,l=o?r.find(f=>f.id===o):null,c=a&&i.find(f=>f.id===a)||i[0],u=c&&c.unproject([t-c.x,e-c.y]);return{...s,...{x:t,y:e,viewport:c,coordinate:u,layer:l}}}_resizeBuffer(){if(!this.pickingFBO&&(this.pickingFBO=this.device.createFramebuffer({colorAttachments:["rgba8unorm"],depthStencilAttachment:"depth16unorm"}),this.device.isTextureFormatRenderable("rgba32float"))){const e=this.device.createFramebuffer({colorAttachments:["rgba32float"],depthStencilAttachment:"depth16unorm"});this.depthFBO=e}const{canvas:t}=this.device.getDefaultCanvasContext();this.pickingFBO?.resize({width:t.width,height:t.height}),this.depthFBO?.resize({width:t.width,height:t.height})}_getPickable(t){if(this._pickable===!1)return null;const e=t.filter(r=>this.pickLayersPass.shouldDrawLayer(r)&&!r.isComposite);return e.length?e:null}_pickClosestObject({layers:t,views:e,viewports:r,x:i,y:s,radius:o=0,depth:a=1,mode:l="query",unproject3D:c,onViewportActive:u,effects:h}){const f=this.device.canvasContext.cssToDeviceRatio(),d=this._getPickable(t);if(!d||r.length===0)return{result:[],emptyInfo:tx({viewports:r,x:i,y:s,pixelRatio:f})};this._resizeBuffer();const p=this.device.canvasContext.cssToDevicePixels([i,s],!0),_=[p.x+Math.floor(p.width/2),p.y+Math.floor(p.height/2)],v=Math.round(o*f),{width:E,height:m}=this.pickingFBO,g=this._getPickingRect({deviceX:_[0],deviceY:_[1],deviceRadius:v,deviceWidth:E,deviceHeight:m}),y={x:i-o,y:s-o,width:o*2+1,height:o*2+1};let b;const x=[],w=new Set;for(let S=0;S<a;S++){let I;if(g){const M=this._drawAndSample({layers:d,views:e,viewports:r,onViewportActive:u,deviceRect:g,cullRect:y,effects:h,pass:`picking:${l}`});I=NM({...M,deviceX:_[0],deviceY:_[1],deviceRadius:v,deviceRect:g})}else I={pickedColor:null,pickedObjectIndex:-1};let T;if(I.pickedLayer&&c&&this.depthFBO){const{pickedColors:M}=this._drawAndSample({layers:[I.pickedLayer],views:e,viewports:r,onViewportActive:u,deviceRect:{x:I.pickedX,y:I.pickedY,width:1,height:1},cullRect:y,effects:h,pass:`picking:${l}:z`},!0);M[3]&&(T=M[0])}I.pickedLayer&&S+1<a&&(w.add(I.pickedLayer),I.pickedLayer.disablePickingIndex(I.pickedObjectIndex)),b=DM({pickInfo:I,lastPickedInfo:this.lastPickedInfo,mode:l,layers:d,viewports:r,x:i,y:s,z:T,pixelRatio:f});for(const M of b.values())M.layer&&x.push(M);if(!I.pickedColor)break}for(const S of w)S.restorePickingColors();return{result:x,emptyInfo:b.get(null)}}_pickVisibleObjects({layers:t,views:e,viewports:r,x:i,y:s,width:o=1,height:a=1,mode:l="query",maxObjects:c=null,onViewportActive:u,effects:h}){const f=this._getPickable(t);if(!f||r.length===0)return[];this._resizeBuffer();const d=this.device.canvasContext.cssToDeviceRatio(),p=this.device.canvasContext.cssToDevicePixels([i,s],!0),_=p.x,v=p.y+p.height,E=this.device.canvasContext.cssToDevicePixels([i+o,s+a],!0),m=E.x+E.width,g=E.y,y={x:_,y:g,width:m-_,height:v-g},b=this._drawAndSample({layers:f,views:e,viewports:r,onViewportActive:u,deviceRect:y,cullRect:{x:i,y:s,width:o,height:a},effects:h,pass:`picking:${l}`}),x=OM(b),w=new Map,S=[],I=Number.isFinite(c);for(let T=0;T<x.length&&!(I&&S.length>=c);T++){const M=x[T];let L={color:M.pickedColor,layer:null,index:M.pickedObjectIndex,picked:!0,x:i,y:s,pixelRatio:d};L=ex({layer:M.pickedLayer,info:L,mode:l});const O=L.layer.id;w.has(O)||w.set(O,new Set);const P=w.get(O),V=L.object??L.index;P.has(V)||(P.add(V),S.push(L))}return S}_drawAndSample({layers:t,views:e,viewports:r,onViewportActive:i,deviceRect:s,cullRect:o,effects:a,pass:l},c=!1){const u=c?this.depthFBO:this.pickingFBO,h={layers:t,layerFilter:this.layerFilter,views:e,viewports:r,onViewportActive:i,pickingFBO:u,deviceRect:s,cullRect:o,effects:a,pass:l,pickZ:c,preRenderStats:{},isPicking:!0};for(const m of a)m.useInPicking&&(h.preRenderStats[m.id]=m.preRender(h));const{decodePickingColor:f}=this.pickLayersPass.render(h),{x:d,y:p,width:_,height:v}=s,E=new(c?Float32Array:Uint8Array)(_*v*4);return this.device.readPixelsToArrayWebGL(u,{sourceX:d,sourceY:p,sourceWidth:_,sourceHeight:v,target:E}),{pickedColors:E,decodePickingColor:f}}_getPickingRect({deviceX:t,deviceY:e,deviceRadius:r,deviceWidth:i,deviceHeight:s}){const o=Math.max(0,t-r),a=Math.max(0,e-r),l=Math.min(i,t+r+1)-o,c=Math.min(s,e+r+1)-a;return l<=0||c<=0?null:{x:o,y:a,width:l,height:c}}}const FM={"top-left":{top:0,left:0},"top-right":{top:0,right:0},"bottom-left":{bottom:0,left:0},"bottom-right":{bottom:0,right:0},fill:{top:0,left:0,bottom:0,right:0}},BM="top-left",m_="__root";class UM{constructor({deck:t,parentElement:e}){this.defaultWidgets=[],this.widgets=[],this.resolvedWidgets=[],this.containers={},this.lastViewports={},this.deck=t,this.parentElement=e}getWidgets(){return this.resolvedWidgets}setProps(t){t.widgets&&!xr(t.widgets,this.widgets,1)&&this._setWidgets(t.widgets)}finalize(){for(const t of this.getWidgets())this._remove(t);this.defaultWidgets.length=0,this.resolvedWidgets.length=0;for(const t in this.containers)this.containers[t].remove()}addDefault(t){this.defaultWidgets.find(e=>e.id===t.id)||(this._add(t),this.defaultWidgets.push(t),this._setWidgets(this.widgets))}_setWidgets(t){const e={};for(const r of this.resolvedWidgets)e[r.id]=r;this.resolvedWidgets.length=0;for(const r of this.defaultWidgets)e[r.id]=null,this.resolvedWidgets.push(r);for(let r of t){const i=e[r.id];i?i.viewId!==r.viewId||i.placement!==r.placement?(this._remove(i),this._add(r)):r!==i&&(i.setProps(r.props),r=i):this._add(r),e[r.id]=null,this.resolvedWidgets.push(r)}for(const r in e){const i=e[r];i&&this._remove(i)}this.widgets=t}_add(t){const{viewId:e=null,placement:r=BM}=t,i=t.onAdd({deck:this.deck,viewId:e});i&&this._getContainer(e,r).append(i),t._element=i}_remove(t){t.onRemove?.(),t._element&&t._element.remove(),t._element=void 0}_getContainer(t,e){const r=t||m_;let i=this.containers[r];i||(i=document.createElement("div"),i.style.pointerEvents="none",i.style.position="absolute",i.style.overflow="hidden",this.parentElement?.append(i),this.containers[r]=i);let s=i.querySelector(`.${e}`);return s||(s=document.createElement("div"),s.className=e,s.style.position="absolute",s.style.zIndex="2",Object.assign(s.style,FM[e]),i.append(s)),s}_updateContainers(){const t=this.deck.width,e=this.deck.height;for(const r in this.containers){const i=this.lastViewports[r]||null,s=r===m_||i,o=this.containers[r];s?(o.style.display="block",o.style.left=`${i?i.x:0}px`,o.style.top=`${i?i.y:0}px`,o.style.width=`${i?i.width:t}px`,o.style.height=`${i?i.height:e}px`):o.style.display="none"}}onRedraw({viewports:t,layers:e}){const r=t.reduce((i,s)=>(i[s.id]=s,i),{});for(const i of this.getWidgets()){const{viewId:s}=i;if(s){const o=r[s];o&&(i.onViewportChange&&i.onViewportChange(o),i.onRedraw?.({viewports:[o],layers:e}))}else{if(i.onViewportChange)for(const o of t)i.onViewportChange(o);i.onRedraw?.({viewports:t,layers:e})}}this.lastViewports=r,this._updateContainers()}onHover(t,e){for(const r of this.getWidgets()){const{viewId:i}=r;(!i||i===t.viewport?.id)&&r.onHover?.(t,e)}}onEvent(t,e){const r=wd[e.type];if(r)for(const i of this.getWidgets()){const{viewId:s}=i;(!s||s===t.viewport?.id)&&i[r]?.(t,e)}}}const VM={zIndex:"1",position:"absolute",pointerEvents:"none",color:"#a0a7b4",backgroundColor:"#29323c",padding:"10px",top:"0",left:"0",display:"none"};class zM{constructor(){this.id="default-tooltip",this.placement="fill",this.props={},this.isVisible=!1}onAdd({deck:t}){const e=document.createElement("div");return e.className="deck-tooltip",Object.assign(e.style,VM),this.deck=t,this.element=e,e}onRemove(){this.deck=void 0,this.element=void 0}setProps(){}onViewportChange(t){this.isVisible&&t.id===this.lastViewport?.id&&t!==this.lastViewport&&this.setTooltip(null)}onHover(t){const{deck:e}=this,r=e&&e.props.getTooltip;if(!r)return;const i=r(t);this.lastViewport=t.viewport,this.setTooltip(i,t.x,t.y)}setTooltip(t,e,r){const i=this.element;if(i){if(typeof t=="string")i.innerText=t;else if(t)t.text&&(i.innerText=t.text),t.html&&(i.innerHTML=t.html),t.className&&(i.className=t.className);else{this.isVisible=!1,i.style.display="none";return}this.isVisible=!0,i.style.display="block",i.style.transform=`translate(${e}px, ${r}px)`,t&&typeof t=="object"&&"style"in t&&Object.assign(i.style,t.style)}}}var Jo;(function(n){n[n.DEPTH_BUFFER_BIT=256]="DEPTH_BUFFER_BIT",n[n.STENCIL_BUFFER_BIT=1024]="STENCIL_BUFFER_BIT",n[n.COLOR_BUFFER_BIT=16384]="COLOR_BUFFER_BIT",n[n.POINTS=0]="POINTS",n[n.LINES=1]="LINES",n[n.LINE_LOOP=2]="LINE_LOOP",n[n.LINE_STRIP=3]="LINE_STRIP",n[n.TRIANGLES=4]="TRIANGLES",n[n.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",n[n.TRIANGLE_FAN=6]="TRIANGLE_FAN",n[n.ZERO=0]="ZERO",n[n.ONE=1]="ONE",n[n.SRC_COLOR=768]="SRC_COLOR",n[n.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",n[n.SRC_ALPHA=770]="SRC_ALPHA",n[n.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",n[n.DST_ALPHA=772]="DST_ALPHA",n[n.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",n[n.DST_COLOR=774]="DST_COLOR",n[n.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",n[n.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE",n[n.CONSTANT_COLOR=32769]="CONSTANT_COLOR",n[n.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",n[n.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",n[n.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",n[n.FUNC_ADD=32774]="FUNC_ADD",n[n.FUNC_SUBTRACT=32778]="FUNC_SUBTRACT",n[n.FUNC_REVERSE_SUBTRACT=32779]="FUNC_REVERSE_SUBTRACT",n[n.BLEND_EQUATION=32777]="BLEND_EQUATION",n[n.BLEND_EQUATION_RGB=32777]="BLEND_EQUATION_RGB",n[n.BLEND_EQUATION_ALPHA=34877]="BLEND_EQUATION_ALPHA",n[n.BLEND_DST_RGB=32968]="BLEND_DST_RGB",n[n.BLEND_SRC_RGB=32969]="BLEND_SRC_RGB",n[n.BLEND_DST_ALPHA=32970]="BLEND_DST_ALPHA",n[n.BLEND_SRC_ALPHA=32971]="BLEND_SRC_ALPHA",n[n.BLEND_COLOR=32773]="BLEND_COLOR",n[n.ARRAY_BUFFER_BINDING=34964]="ARRAY_BUFFER_BINDING",n[n.ELEMENT_ARRAY_BUFFER_BINDING=34965]="ELEMENT_ARRAY_BUFFER_BINDING",n[n.LINE_WIDTH=2849]="LINE_WIDTH",n[n.ALIASED_POINT_SIZE_RANGE=33901]="ALIASED_POINT_SIZE_RANGE",n[n.ALIASED_LINE_WIDTH_RANGE=33902]="ALIASED_LINE_WIDTH_RANGE",n[n.CULL_FACE_MODE=2885]="CULL_FACE_MODE",n[n.FRONT_FACE=2886]="FRONT_FACE",n[n.DEPTH_RANGE=2928]="DEPTH_RANGE",n[n.DEPTH_WRITEMASK=2930]="DEPTH_WRITEMASK",n[n.DEPTH_CLEAR_VALUE=2931]="DEPTH_CLEAR_VALUE",n[n.DEPTH_FUNC=2932]="DEPTH_FUNC",n[n.STENCIL_CLEAR_VALUE=2961]="STENCIL_CLEAR_VALUE",n[n.STENCIL_FUNC=2962]="STENCIL_FUNC",n[n.STENCIL_FAIL=2964]="STENCIL_FAIL",n[n.STENCIL_PASS_DEPTH_FAIL=2965]="STENCIL_PASS_DEPTH_FAIL",n[n.STENCIL_PASS_DEPTH_PASS=2966]="STENCIL_PASS_DEPTH_PASS",n[n.STENCIL_REF=2967]="STENCIL_REF",n[n.STENCIL_VALUE_MASK=2963]="STENCIL_VALUE_MASK",n[n.STENCIL_WRITEMASK=2968]="STENCIL_WRITEMASK",n[n.STENCIL_BACK_FUNC=34816]="STENCIL_BACK_FUNC",n[n.STENCIL_BACK_FAIL=34817]="STENCIL_BACK_FAIL",n[n.STENCIL_BACK_PASS_DEPTH_FAIL=34818]="STENCIL_BACK_PASS_DEPTH_FAIL",n[n.STENCIL_BACK_PASS_DEPTH_PASS=34819]="STENCIL_BACK_PASS_DEPTH_PASS",n[n.STENCIL_BACK_REF=36003]="STENCIL_BACK_REF",n[n.STENCIL_BACK_VALUE_MASK=36004]="STENCIL_BACK_VALUE_MASK",n[n.STENCIL_BACK_WRITEMASK=36005]="STENCIL_BACK_WRITEMASK",n[n.VIEWPORT=2978]="VIEWPORT",n[n.SCISSOR_BOX=3088]="SCISSOR_BOX",n[n.COLOR_CLEAR_VALUE=3106]="COLOR_CLEAR_VALUE",n[n.COLOR_WRITEMASK=3107]="COLOR_WRITEMASK",n[n.UNPACK_ALIGNMENT=3317]="UNPACK_ALIGNMENT",n[n.PACK_ALIGNMENT=3333]="PACK_ALIGNMENT",n[n.MAX_TEXTURE_SIZE=3379]="MAX_TEXTURE_SIZE",n[n.MAX_VIEWPORT_DIMS=3386]="MAX_VIEWPORT_DIMS",n[n.SUBPIXEL_BITS=3408]="SUBPIXEL_BITS",n[n.RED_BITS=3410]="RED_BITS",n[n.GREEN_BITS=3411]="GREEN_BITS",n[n.BLUE_BITS=3412]="BLUE_BITS",n[n.ALPHA_BITS=3413]="ALPHA_BITS",n[n.DEPTH_BITS=3414]="DEPTH_BITS",n[n.STENCIL_BITS=3415]="STENCIL_BITS",n[n.POLYGON_OFFSET_UNITS=10752]="POLYGON_OFFSET_UNITS",n[n.POLYGON_OFFSET_FACTOR=32824]="POLYGON_OFFSET_FACTOR",n[n.TEXTURE_BINDING_2D=32873]="TEXTURE_BINDING_2D",n[n.SAMPLE_BUFFERS=32936]="SAMPLE_BUFFERS",n[n.SAMPLES=32937]="SAMPLES",n[n.SAMPLE_COVERAGE_VALUE=32938]="SAMPLE_COVERAGE_VALUE",n[n.SAMPLE_COVERAGE_INVERT=32939]="SAMPLE_COVERAGE_INVERT",n[n.COMPRESSED_TEXTURE_FORMATS=34467]="COMPRESSED_TEXTURE_FORMATS",n[n.VENDOR=7936]="VENDOR",n[n.RENDERER=7937]="RENDERER",n[n.VERSION=7938]="VERSION",n[n.IMPLEMENTATION_COLOR_READ_TYPE=35738]="IMPLEMENTATION_COLOR_READ_TYPE",n[n.IMPLEMENTATION_COLOR_READ_FORMAT=35739]="IMPLEMENTATION_COLOR_READ_FORMAT",n[n.BROWSER_DEFAULT_WEBGL=37444]="BROWSER_DEFAULT_WEBGL",n[n.STATIC_DRAW=35044]="STATIC_DRAW",n[n.STREAM_DRAW=35040]="STREAM_DRAW",n[n.DYNAMIC_DRAW=35048]="DYNAMIC_DRAW",n[n.ARRAY_BUFFER=34962]="ARRAY_BUFFER",n[n.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER",n[n.BUFFER_SIZE=34660]="BUFFER_SIZE",n[n.BUFFER_USAGE=34661]="BUFFER_USAGE",n[n.CURRENT_VERTEX_ATTRIB=34342]="CURRENT_VERTEX_ATTRIB",n[n.VERTEX_ATTRIB_ARRAY_ENABLED=34338]="VERTEX_ATTRIB_ARRAY_ENABLED",n[n.VERTEX_ATTRIB_ARRAY_SIZE=34339]="VERTEX_ATTRIB_ARRAY_SIZE",n[n.VERTEX_ATTRIB_ARRAY_STRIDE=34340]="VERTEX_ATTRIB_ARRAY_STRIDE",n[n.VERTEX_ATTRIB_ARRAY_TYPE=34341]="VERTEX_ATTRIB_ARRAY_TYPE",n[n.VERTEX_ATTRIB_ARRAY_NORMALIZED=34922]="VERTEX_ATTRIB_ARRAY_NORMALIZED",n[n.VERTEX_ATTRIB_ARRAY_POINTER=34373]="VERTEX_ATTRIB_ARRAY_POINTER",n[n.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING=34975]="VERTEX_ATTRIB_ARRAY_BUFFER_BINDING",n[n.CULL_FACE=2884]="CULL_FACE",n[n.FRONT=1028]="FRONT",n[n.BACK=1029]="BACK",n[n.FRONT_AND_BACK=1032]="FRONT_AND_BACK",n[n.BLEND=3042]="BLEND",n[n.DEPTH_TEST=2929]="DEPTH_TEST",n[n.DITHER=3024]="DITHER",n[n.POLYGON_OFFSET_FILL=32823]="POLYGON_OFFSET_FILL",n[n.SAMPLE_ALPHA_TO_COVERAGE=32926]="SAMPLE_ALPHA_TO_COVERAGE",n[n.SAMPLE_COVERAGE=32928]="SAMPLE_COVERAGE",n[n.SCISSOR_TEST=3089]="SCISSOR_TEST",n[n.STENCIL_TEST=2960]="STENCIL_TEST",n[n.NO_ERROR=0]="NO_ERROR",n[n.INVALID_ENUM=1280]="INVALID_ENUM",n[n.INVALID_VALUE=1281]="INVALID_VALUE",n[n.INVALID_OPERATION=1282]="INVALID_OPERATION",n[n.OUT_OF_MEMORY=1285]="OUT_OF_MEMORY",n[n.CONTEXT_LOST_WEBGL=37442]="CONTEXT_LOST_WEBGL",n[n.CW=2304]="CW",n[n.CCW=2305]="CCW",n[n.DONT_CARE=4352]="DONT_CARE",n[n.FASTEST=4353]="FASTEST",n[n.NICEST=4354]="NICEST",n[n.GENERATE_MIPMAP_HINT=33170]="GENERATE_MIPMAP_HINT",n[n.BYTE=5120]="BYTE",n[n.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",n[n.SHORT=5122]="SHORT",n[n.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",n[n.INT=5124]="INT",n[n.UNSIGNED_INT=5125]="UNSIGNED_INT",n[n.FLOAT=5126]="FLOAT",n[n.DOUBLE=5130]="DOUBLE",n[n.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",n[n.ALPHA=6406]="ALPHA",n[n.RGB=6407]="RGB",n[n.RGBA=6408]="RGBA",n[n.LUMINANCE=6409]="LUMINANCE",n[n.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",n[n.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",n[n.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",n[n.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",n[n.FRAGMENT_SHADER=35632]="FRAGMENT_SHADER",n[n.VERTEX_SHADER=35633]="VERTEX_SHADER",n[n.COMPILE_STATUS=35713]="COMPILE_STATUS",n[n.DELETE_STATUS=35712]="DELETE_STATUS",n[n.LINK_STATUS=35714]="LINK_STATUS",n[n.VALIDATE_STATUS=35715]="VALIDATE_STATUS",n[n.ATTACHED_SHADERS=35717]="ATTACHED_SHADERS",n[n.ACTIVE_ATTRIBUTES=35721]="ACTIVE_ATTRIBUTES",n[n.ACTIVE_UNIFORMS=35718]="ACTIVE_UNIFORMS",n[n.MAX_VERTEX_ATTRIBS=34921]="MAX_VERTEX_ATTRIBS",n[n.MAX_VERTEX_UNIFORM_VECTORS=36347]="MAX_VERTEX_UNIFORM_VECTORS",n[n.MAX_VARYING_VECTORS=36348]="MAX_VARYING_VECTORS",n[n.MAX_COMBINED_TEXTURE_IMAGE_UNITS=35661]="MAX_COMBINED_TEXTURE_IMAGE_UNITS",n[n.MAX_VERTEX_TEXTURE_IMAGE_UNITS=35660]="MAX_VERTEX_TEXTURE_IMAGE_UNITS",n[n.MAX_TEXTURE_IMAGE_UNITS=34930]="MAX_TEXTURE_IMAGE_UNITS",n[n.MAX_FRAGMENT_UNIFORM_VECTORS=36349]="MAX_FRAGMENT_UNIFORM_VECTORS",n[n.SHADER_TYPE=35663]="SHADER_TYPE",n[n.SHADING_LANGUAGE_VERSION=35724]="SHADING_LANGUAGE_VERSION",n[n.CURRENT_PROGRAM=35725]="CURRENT_PROGRAM",n[n.NEVER=512]="NEVER",n[n.LESS=513]="LESS",n[n.EQUAL=514]="EQUAL",n[n.LEQUAL=515]="LEQUAL",n[n.GREATER=516]="GREATER",n[n.NOTEQUAL=517]="NOTEQUAL",n[n.GEQUAL=518]="GEQUAL",n[n.ALWAYS=519]="ALWAYS",n[n.KEEP=7680]="KEEP",n[n.REPLACE=7681]="REPLACE",n[n.INCR=7682]="INCR",n[n.DECR=7683]="DECR",n[n.INVERT=5386]="INVERT",n[n.INCR_WRAP=34055]="INCR_WRAP",n[n.DECR_WRAP=34056]="DECR_WRAP",n[n.NEAREST=9728]="NEAREST",n[n.LINEAR=9729]="LINEAR",n[n.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",n[n.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",n[n.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",n[n.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR",n[n.TEXTURE_MAG_FILTER=10240]="TEXTURE_MAG_FILTER",n[n.TEXTURE_MIN_FILTER=10241]="TEXTURE_MIN_FILTER",n[n.TEXTURE_WRAP_S=10242]="TEXTURE_WRAP_S",n[n.TEXTURE_WRAP_T=10243]="TEXTURE_WRAP_T",n[n.TEXTURE_2D=3553]="TEXTURE_2D",n[n.TEXTURE=5890]="TEXTURE",n[n.TEXTURE_CUBE_MAP=34067]="TEXTURE_CUBE_MAP",n[n.TEXTURE_BINDING_CUBE_MAP=34068]="TEXTURE_BINDING_CUBE_MAP",n[n.TEXTURE_CUBE_MAP_POSITIVE_X=34069]="TEXTURE_CUBE_MAP_POSITIVE_X",n[n.TEXTURE_CUBE_MAP_NEGATIVE_X=34070]="TEXTURE_CUBE_MAP_NEGATIVE_X",n[n.TEXTURE_CUBE_MAP_POSITIVE_Y=34071]="TEXTURE_CUBE_MAP_POSITIVE_Y",n[n.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072]="TEXTURE_CUBE_MAP_NEGATIVE_Y",n[n.TEXTURE_CUBE_MAP_POSITIVE_Z=34073]="TEXTURE_CUBE_MAP_POSITIVE_Z",n[n.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074]="TEXTURE_CUBE_MAP_NEGATIVE_Z",n[n.MAX_CUBE_MAP_TEXTURE_SIZE=34076]="MAX_CUBE_MAP_TEXTURE_SIZE",n[n.TEXTURE0=33984]="TEXTURE0",n[n.ACTIVE_TEXTURE=34016]="ACTIVE_TEXTURE",n[n.REPEAT=10497]="REPEAT",n[n.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",n[n.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",n[n.TEXTURE_WIDTH=4096]="TEXTURE_WIDTH",n[n.TEXTURE_HEIGHT=4097]="TEXTURE_HEIGHT",n[n.FLOAT_VEC2=35664]="FLOAT_VEC2",n[n.FLOAT_VEC3=35665]="FLOAT_VEC3",n[n.FLOAT_VEC4=35666]="FLOAT_VEC4",n[n.INT_VEC2=35667]="INT_VEC2",n[n.INT_VEC3=35668]="INT_VEC3",n[n.INT_VEC4=35669]="INT_VEC4",n[n.BOOL=35670]="BOOL",n[n.BOOL_VEC2=35671]="BOOL_VEC2",n[n.BOOL_VEC3=35672]="BOOL_VEC3",n[n.BOOL_VEC4=35673]="BOOL_VEC4",n[n.FLOAT_MAT2=35674]="FLOAT_MAT2",n[n.FLOAT_MAT3=35675]="FLOAT_MAT3",n[n.FLOAT_MAT4=35676]="FLOAT_MAT4",n[n.SAMPLER_2D=35678]="SAMPLER_2D",n[n.SAMPLER_CUBE=35680]="SAMPLER_CUBE",n[n.LOW_FLOAT=36336]="LOW_FLOAT",n[n.MEDIUM_FLOAT=36337]="MEDIUM_FLOAT",n[n.HIGH_FLOAT=36338]="HIGH_FLOAT",n[n.LOW_INT=36339]="LOW_INT",n[n.MEDIUM_INT=36340]="MEDIUM_INT",n[n.HIGH_INT=36341]="HIGH_INT",n[n.FRAMEBUFFER=36160]="FRAMEBUFFER",n[n.RENDERBUFFER=36161]="RENDERBUFFER",n[n.RGBA4=32854]="RGBA4",n[n.RGB5_A1=32855]="RGB5_A1",n[n.RGB565=36194]="RGB565",n[n.DEPTH_COMPONENT16=33189]="DEPTH_COMPONENT16",n[n.STENCIL_INDEX=6401]="STENCIL_INDEX",n[n.STENCIL_INDEX8=36168]="STENCIL_INDEX8",n[n.DEPTH_STENCIL=34041]="DEPTH_STENCIL",n[n.RENDERBUFFER_WIDTH=36162]="RENDERBUFFER_WIDTH",n[n.RENDERBUFFER_HEIGHT=36163]="RENDERBUFFER_HEIGHT",n[n.RENDERBUFFER_INTERNAL_FORMAT=36164]="RENDERBUFFER_INTERNAL_FORMAT",n[n.RENDERBUFFER_RED_SIZE=36176]="RENDERBUFFER_RED_SIZE",n[n.RENDERBUFFER_GREEN_SIZE=36177]="RENDERBUFFER_GREEN_SIZE",n[n.RENDERBUFFER_BLUE_SIZE=36178]="RENDERBUFFER_BLUE_SIZE",n[n.RENDERBUFFER_ALPHA_SIZE=36179]="RENDERBUFFER_ALPHA_SIZE",n[n.RENDERBUFFER_DEPTH_SIZE=36180]="RENDERBUFFER_DEPTH_SIZE",n[n.RENDERBUFFER_STENCIL_SIZE=36181]="RENDERBUFFER_STENCIL_SIZE",n[n.FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE=36048]="FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE",n[n.FRAMEBUFFER_ATTACHMENT_OBJECT_NAME=36049]="FRAMEBUFFER_ATTACHMENT_OBJECT_NAME",n[n.FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL=36050]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL",n[n.FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE=36051]="FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE",n[n.COLOR_ATTACHMENT0=36064]="COLOR_ATTACHMENT0",n[n.DEPTH_ATTACHMENT=36096]="DEPTH_ATTACHMENT",n[n.STENCIL_ATTACHMENT=36128]="STENCIL_ATTACHMENT",n[n.DEPTH_STENCIL_ATTACHMENT=33306]="DEPTH_STENCIL_ATTACHMENT",n[n.NONE=0]="NONE",n[n.FRAMEBUFFER_COMPLETE=36053]="FRAMEBUFFER_COMPLETE",n[n.FRAMEBUFFER_INCOMPLETE_ATTACHMENT=36054]="FRAMEBUFFER_INCOMPLETE_ATTACHMENT",n[n.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT=36055]="FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT",n[n.FRAMEBUFFER_INCOMPLETE_DIMENSIONS=36057]="FRAMEBUFFER_INCOMPLETE_DIMENSIONS",n[n.FRAMEBUFFER_UNSUPPORTED=36061]="FRAMEBUFFER_UNSUPPORTED",n[n.FRAMEBUFFER_BINDING=36006]="FRAMEBUFFER_BINDING",n[n.RENDERBUFFER_BINDING=36007]="RENDERBUFFER_BINDING",n[n.READ_FRAMEBUFFER=36008]="READ_FRAMEBUFFER",n[n.DRAW_FRAMEBUFFER=36009]="DRAW_FRAMEBUFFER",n[n.MAX_RENDERBUFFER_SIZE=34024]="MAX_RENDERBUFFER_SIZE",n[n.INVALID_FRAMEBUFFER_OPERATION=1286]="INVALID_FRAMEBUFFER_OPERATION",n[n.UNPACK_FLIP_Y_WEBGL=37440]="UNPACK_FLIP_Y_WEBGL",n[n.UNPACK_PREMULTIPLY_ALPHA_WEBGL=37441]="UNPACK_PREMULTIPLY_ALPHA_WEBGL",n[n.UNPACK_COLORSPACE_CONVERSION_WEBGL=37443]="UNPACK_COLORSPACE_CONVERSION_WEBGL",n[n.READ_BUFFER=3074]="READ_BUFFER",n[n.UNPACK_ROW_LENGTH=3314]="UNPACK_ROW_LENGTH",n[n.UNPACK_SKIP_ROWS=3315]="UNPACK_SKIP_ROWS",n[n.UNPACK_SKIP_PIXELS=3316]="UNPACK_SKIP_PIXELS",n[n.PACK_ROW_LENGTH=3330]="PACK_ROW_LENGTH",n[n.PACK_SKIP_ROWS=3331]="PACK_SKIP_ROWS",n[n.PACK_SKIP_PIXELS=3332]="PACK_SKIP_PIXELS",n[n.TEXTURE_BINDING_3D=32874]="TEXTURE_BINDING_3D",n[n.UNPACK_SKIP_IMAGES=32877]="UNPACK_SKIP_IMAGES",n[n.UNPACK_IMAGE_HEIGHT=32878]="UNPACK_IMAGE_HEIGHT",n[n.MAX_3D_TEXTURE_SIZE=32883]="MAX_3D_TEXTURE_SIZE",n[n.MAX_ELEMENTS_VERTICES=33e3]="MAX_ELEMENTS_VERTICES",n[n.MAX_ELEMENTS_INDICES=33001]="MAX_ELEMENTS_INDICES",n[n.MAX_TEXTURE_LOD_BIAS=34045]="MAX_TEXTURE_LOD_BIAS",n[n.MAX_FRAGMENT_UNIFORM_COMPONENTS=35657]="MAX_FRAGMENT_UNIFORM_COMPONENTS",n[n.MAX_VERTEX_UNIFORM_COMPONENTS=35658]="MAX_VERTEX_UNIFORM_COMPONENTS",n[n.MAX_ARRAY_TEXTURE_LAYERS=35071]="MAX_ARRAY_TEXTURE_LAYERS",n[n.MIN_PROGRAM_TEXEL_OFFSET=35076]="MIN_PROGRAM_TEXEL_OFFSET",n[n.MAX_PROGRAM_TEXEL_OFFSET=35077]="MAX_PROGRAM_TEXEL_OFFSET",n[n.MAX_VARYING_COMPONENTS=35659]="MAX_VARYING_COMPONENTS",n[n.FRAGMENT_SHADER_DERIVATIVE_HINT=35723]="FRAGMENT_SHADER_DERIVATIVE_HINT",n[n.RASTERIZER_DISCARD=35977]="RASTERIZER_DISCARD",n[n.VERTEX_ARRAY_BINDING=34229]="VERTEX_ARRAY_BINDING",n[n.MAX_VERTEX_OUTPUT_COMPONENTS=37154]="MAX_VERTEX_OUTPUT_COMPONENTS",n[n.MAX_FRAGMENT_INPUT_COMPONENTS=37157]="MAX_FRAGMENT_INPUT_COMPONENTS",n[n.MAX_SERVER_WAIT_TIMEOUT=37137]="MAX_SERVER_WAIT_TIMEOUT",n[n.MAX_ELEMENT_INDEX=36203]="MAX_ELEMENT_INDEX",n[n.RED=6403]="RED",n[n.RGB8=32849]="RGB8",n[n.RGBA8=32856]="RGBA8",n[n.RGB10_A2=32857]="RGB10_A2",n[n.TEXTURE_3D=32879]="TEXTURE_3D",n[n.TEXTURE_WRAP_R=32882]="TEXTURE_WRAP_R",n[n.TEXTURE_MIN_LOD=33082]="TEXTURE_MIN_LOD",n[n.TEXTURE_MAX_LOD=33083]="TEXTURE_MAX_LOD",n[n.TEXTURE_BASE_LEVEL=33084]="TEXTURE_BASE_LEVEL",n[n.TEXTURE_MAX_LEVEL=33085]="TEXTURE_MAX_LEVEL",n[n.TEXTURE_COMPARE_MODE=34892]="TEXTURE_COMPARE_MODE",n[n.TEXTURE_COMPARE_FUNC=34893]="TEXTURE_COMPARE_FUNC",n[n.SRGB=35904]="SRGB",n[n.SRGB8=35905]="SRGB8",n[n.SRGB8_ALPHA8=35907]="SRGB8_ALPHA8",n[n.COMPARE_REF_TO_TEXTURE=34894]="COMPARE_REF_TO_TEXTURE",n[n.RGBA32F=34836]="RGBA32F",n[n.RGB32F=34837]="RGB32F",n[n.RGBA16F=34842]="RGBA16F",n[n.RGB16F=34843]="RGB16F",n[n.TEXTURE_2D_ARRAY=35866]="TEXTURE_2D_ARRAY",n[n.TEXTURE_BINDING_2D_ARRAY=35869]="TEXTURE_BINDING_2D_ARRAY",n[n.R11F_G11F_B10F=35898]="R11F_G11F_B10F",n[n.RGB9_E5=35901]="RGB9_E5",n[n.RGBA32UI=36208]="RGBA32UI",n[n.RGB32UI=36209]="RGB32UI",n[n.RGBA16UI=36214]="RGBA16UI",n[n.RGB16UI=36215]="RGB16UI",n[n.RGBA8UI=36220]="RGBA8UI",n[n.RGB8UI=36221]="RGB8UI",n[n.RGBA32I=36226]="RGBA32I",n[n.RGB32I=36227]="RGB32I",n[n.RGBA16I=36232]="RGBA16I",n[n.RGB16I=36233]="RGB16I",n[n.RGBA8I=36238]="RGBA8I",n[n.RGB8I=36239]="RGB8I",n[n.RED_INTEGER=36244]="RED_INTEGER",n[n.RGB_INTEGER=36248]="RGB_INTEGER",n[n.RGBA_INTEGER=36249]="RGBA_INTEGER",n[n.R8=33321]="R8",n[n.RG8=33323]="RG8",n[n.R16F=33325]="R16F",n[n.R32F=33326]="R32F",n[n.RG16F=33327]="RG16F",n[n.RG32F=33328]="RG32F",n[n.R8I=33329]="R8I",n[n.R8UI=33330]="R8UI",n[n.R16I=33331]="R16I",n[n.R16UI=33332]="R16UI",n[n.R32I=33333]="R32I",n[n.R32UI=33334]="R32UI",n[n.RG8I=33335]="RG8I",n[n.RG8UI=33336]="RG8UI",n[n.RG16I=33337]="RG16I",n[n.RG16UI=33338]="RG16UI",n[n.RG32I=33339]="RG32I",n[n.RG32UI=33340]="RG32UI",n[n.R8_SNORM=36756]="R8_SNORM",n[n.RG8_SNORM=36757]="RG8_SNORM",n[n.RGB8_SNORM=36758]="RGB8_SNORM",n[n.RGBA8_SNORM=36759]="RGBA8_SNORM",n[n.RGB10_A2UI=36975]="RGB10_A2UI",n[n.TEXTURE_IMMUTABLE_FORMAT=37167]="TEXTURE_IMMUTABLE_FORMAT",n[n.TEXTURE_IMMUTABLE_LEVELS=33503]="TEXTURE_IMMUTABLE_LEVELS",n[n.UNSIGNED_INT_2_10_10_10_REV=33640]="UNSIGNED_INT_2_10_10_10_REV",n[n.UNSIGNED_INT_10F_11F_11F_REV=35899]="UNSIGNED_INT_10F_11F_11F_REV",n[n.UNSIGNED_INT_5_9_9_9_REV=35902]="UNSIGNED_INT_5_9_9_9_REV",n[n.FLOAT_32_UNSIGNED_INT_24_8_REV=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV",n[n.UNSIGNED_INT_24_8=34042]="UNSIGNED_INT_24_8",n[n.HALF_FLOAT=5131]="HALF_FLOAT",n[n.RG=33319]="RG",n[n.RG_INTEGER=33320]="RG_INTEGER",n[n.INT_2_10_10_10_REV=36255]="INT_2_10_10_10_REV",n[n.CURRENT_QUERY=34917]="CURRENT_QUERY",n[n.QUERY_RESULT=34918]="QUERY_RESULT",n[n.QUERY_RESULT_AVAILABLE=34919]="QUERY_RESULT_AVAILABLE",n[n.ANY_SAMPLES_PASSED=35887]="ANY_SAMPLES_PASSED",n[n.ANY_SAMPLES_PASSED_CONSERVATIVE=36202]="ANY_SAMPLES_PASSED_CONSERVATIVE",n[n.MAX_DRAW_BUFFERS=34852]="MAX_DRAW_BUFFERS",n[n.DRAW_BUFFER0=34853]="DRAW_BUFFER0",n[n.DRAW_BUFFER1=34854]="DRAW_BUFFER1",n[n.DRAW_BUFFER2=34855]="DRAW_BUFFER2",n[n.DRAW_BUFFER3=34856]="DRAW_BUFFER3",n[n.DRAW_BUFFER4=34857]="DRAW_BUFFER4",n[n.DRAW_BUFFER5=34858]="DRAW_BUFFER5",n[n.DRAW_BUFFER6=34859]="DRAW_BUFFER6",n[n.DRAW_BUFFER7=34860]="DRAW_BUFFER7",n[n.DRAW_BUFFER8=34861]="DRAW_BUFFER8",n[n.DRAW_BUFFER9=34862]="DRAW_BUFFER9",n[n.DRAW_BUFFER10=34863]="DRAW_BUFFER10",n[n.DRAW_BUFFER11=34864]="DRAW_BUFFER11",n[n.DRAW_BUFFER12=34865]="DRAW_BUFFER12",n[n.DRAW_BUFFER13=34866]="DRAW_BUFFER13",n[n.DRAW_BUFFER14=34867]="DRAW_BUFFER14",n[n.DRAW_BUFFER15=34868]="DRAW_BUFFER15",n[n.MAX_COLOR_ATTACHMENTS=36063]="MAX_COLOR_ATTACHMENTS",n[n.COLOR_ATTACHMENT1=36065]="COLOR_ATTACHMENT1",n[n.COLOR_ATTACHMENT2=36066]="COLOR_ATTACHMENT2",n[n.COLOR_ATTACHMENT3=36067]="COLOR_ATTACHMENT3",n[n.COLOR_ATTACHMENT4=36068]="COLOR_ATTACHMENT4",n[n.COLOR_ATTACHMENT5=36069]="COLOR_ATTACHMENT5",n[n.COLOR_ATTACHMENT6=36070]="COLOR_ATTACHMENT6",n[n.COLOR_ATTACHMENT7=36071]="COLOR_ATTACHMENT7",n[n.COLOR_ATTACHMENT8=36072]="COLOR_ATTACHMENT8",n[n.COLOR_ATTACHMENT9=36073]="COLOR_ATTACHMENT9",n[n.COLOR_ATTACHMENT10=36074]="COLOR_ATTACHMENT10",n[n.COLOR_ATTACHMENT11=36075]="COLOR_ATTACHMENT11",n[n.COLOR_ATTACHMENT12=36076]="COLOR_ATTACHMENT12",n[n.COLOR_ATTACHMENT13=36077]="COLOR_ATTACHMENT13",n[n.COLOR_ATTACHMENT14=36078]="COLOR_ATTACHMENT14",n[n.COLOR_ATTACHMENT15=36079]="COLOR_ATTACHMENT15",n[n.SAMPLER_3D=35679]="SAMPLER_3D",n[n.SAMPLER_2D_SHADOW=35682]="SAMPLER_2D_SHADOW",n[n.SAMPLER_2D_ARRAY=36289]="SAMPLER_2D_ARRAY",n[n.SAMPLER_2D_ARRAY_SHADOW=36292]="SAMPLER_2D_ARRAY_SHADOW",n[n.SAMPLER_CUBE_SHADOW=36293]="SAMPLER_CUBE_SHADOW",n[n.INT_SAMPLER_2D=36298]="INT_SAMPLER_2D",n[n.INT_SAMPLER_3D=36299]="INT_SAMPLER_3D",n[n.INT_SAMPLER_CUBE=36300]="INT_SAMPLER_CUBE",n[n.INT_SAMPLER_2D_ARRAY=36303]="INT_SAMPLER_2D_ARRAY",n[n.UNSIGNED_INT_SAMPLER_2D=36306]="UNSIGNED_INT_SAMPLER_2D",n[n.UNSIGNED_INT_SAMPLER_3D=36307]="UNSIGNED_INT_SAMPLER_3D",n[n.UNSIGNED_INT_SAMPLER_CUBE=36308]="UNSIGNED_INT_SAMPLER_CUBE",n[n.UNSIGNED_INT_SAMPLER_2D_ARRAY=36311]="UNSIGNED_INT_SAMPLER_2D_ARRAY",n[n.MAX_SAMPLES=36183]="MAX_SAMPLES",n[n.SAMPLER_BINDING=35097]="SAMPLER_BINDING",n[n.PIXEL_PACK_BUFFER=35051]="PIXEL_PACK_BUFFER",n[n.PIXEL_UNPACK_BUFFER=35052]="PIXEL_UNPACK_BUFFER",n[n.PIXEL_PACK_BUFFER_BINDING=35053]="PIXEL_PACK_BUFFER_BINDING",n[n.PIXEL_UNPACK_BUFFER_BINDING=35055]="PIXEL_UNPACK_BUFFER_BINDING",n[n.COPY_READ_BUFFER=36662]="COPY_READ_BUFFER",n[n.COPY_WRITE_BUFFER=36663]="COPY_WRITE_BUFFER",n[n.COPY_READ_BUFFER_BINDING=36662]="COPY_READ_BUFFER_BINDING",n[n.COPY_WRITE_BUFFER_BINDING=36663]="COPY_WRITE_BUFFER_BINDING",n[n.FLOAT_MAT2x3=35685]="FLOAT_MAT2x3",n[n.FLOAT_MAT2x4=35686]="FLOAT_MAT2x4",n[n.FLOAT_MAT3x2=35687]="FLOAT_MAT3x2",n[n.FLOAT_MAT3x4=35688]="FLOAT_MAT3x4",n[n.FLOAT_MAT4x2=35689]="FLOAT_MAT4x2",n[n.FLOAT_MAT4x3=35690]="FLOAT_MAT4x3",n[n.UNSIGNED_INT_VEC2=36294]="UNSIGNED_INT_VEC2",n[n.UNSIGNED_INT_VEC3=36295]="UNSIGNED_INT_VEC3",n[n.UNSIGNED_INT_VEC4=36296]="UNSIGNED_INT_VEC4",n[n.UNSIGNED_NORMALIZED=35863]="UNSIGNED_NORMALIZED",n[n.SIGNED_NORMALIZED=36764]="SIGNED_NORMALIZED",n[n.VERTEX_ATTRIB_ARRAY_INTEGER=35069]="VERTEX_ATTRIB_ARRAY_INTEGER",n[n.VERTEX_ATTRIB_ARRAY_DIVISOR=35070]="VERTEX_ATTRIB_ARRAY_DIVISOR",n[n.TRANSFORM_FEEDBACK_BUFFER_MODE=35967]="TRANSFORM_FEEDBACK_BUFFER_MODE",n[n.MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS=35968]="MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS",n[n.TRANSFORM_FEEDBACK_VARYINGS=35971]="TRANSFORM_FEEDBACK_VARYINGS",n[n.TRANSFORM_FEEDBACK_BUFFER_START=35972]="TRANSFORM_FEEDBACK_BUFFER_START",n[n.TRANSFORM_FEEDBACK_BUFFER_SIZE=35973]="TRANSFORM_FEEDBACK_BUFFER_SIZE",n[n.TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN=35976]="TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN",n[n.MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS=35978]="MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS",n[n.MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS=35979]="MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS",n[n.INTERLEAVED_ATTRIBS=35980]="INTERLEAVED_ATTRIBS",n[n.SEPARATE_ATTRIBS=35981]="SEPARATE_ATTRIBS",n[n.TRANSFORM_FEEDBACK_BUFFER=35982]="TRANSFORM_FEEDBACK_BUFFER",n[n.TRANSFORM_FEEDBACK_BUFFER_BINDING=35983]="TRANSFORM_FEEDBACK_BUFFER_BINDING",n[n.TRANSFORM_FEEDBACK=36386]="TRANSFORM_FEEDBACK",n[n.TRANSFORM_FEEDBACK_PAUSED=36387]="TRANSFORM_FEEDBACK_PAUSED",n[n.TRANSFORM_FEEDBACK_ACTIVE=36388]="TRANSFORM_FEEDBACK_ACTIVE",n[n.TRANSFORM_FEEDBACK_BINDING=36389]="TRANSFORM_FEEDBACK_BINDING",n[n.FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING=33296]="FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING",n[n.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE",n[n.FRAMEBUFFER_ATTACHMENT_RED_SIZE=33298]="FRAMEBUFFER_ATTACHMENT_RED_SIZE",n[n.FRAMEBUFFER_ATTACHMENT_GREEN_SIZE=33299]="FRAMEBUFFER_ATTACHMENT_GREEN_SIZE",n[n.FRAMEBUFFER_ATTACHMENT_BLUE_SIZE=33300]="FRAMEBUFFER_ATTACHMENT_BLUE_SIZE",n[n.FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE=33301]="FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE",n[n.FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE=33302]="FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE",n[n.FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE=33303]="FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE",n[n.FRAMEBUFFER_DEFAULT=33304]="FRAMEBUFFER_DEFAULT",n[n.DEPTH24_STENCIL8=35056]="DEPTH24_STENCIL8",n[n.DRAW_FRAMEBUFFER_BINDING=36006]="DRAW_FRAMEBUFFER_BINDING",n[n.READ_FRAMEBUFFER_BINDING=36010]="READ_FRAMEBUFFER_BINDING",n[n.RENDERBUFFER_SAMPLES=36011]="RENDERBUFFER_SAMPLES",n[n.FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER=36052]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER",n[n.FRAMEBUFFER_INCOMPLETE_MULTISAMPLE=36182]="FRAMEBUFFER_INCOMPLETE_MULTISAMPLE",n[n.UNIFORM_BUFFER=35345]="UNIFORM_BUFFER",n[n.UNIFORM_BUFFER_BINDING=35368]="UNIFORM_BUFFER_BINDING",n[n.UNIFORM_BUFFER_START=35369]="UNIFORM_BUFFER_START",n[n.UNIFORM_BUFFER_SIZE=35370]="UNIFORM_BUFFER_SIZE",n[n.MAX_VERTEX_UNIFORM_BLOCKS=35371]="MAX_VERTEX_UNIFORM_BLOCKS",n[n.MAX_FRAGMENT_UNIFORM_BLOCKS=35373]="MAX_FRAGMENT_UNIFORM_BLOCKS",n[n.MAX_COMBINED_UNIFORM_BLOCKS=35374]="MAX_COMBINED_UNIFORM_BLOCKS",n[n.MAX_UNIFORM_BUFFER_BINDINGS=35375]="MAX_UNIFORM_BUFFER_BINDINGS",n[n.MAX_UNIFORM_BLOCK_SIZE=35376]="MAX_UNIFORM_BLOCK_SIZE",n[n.MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS=35377]="MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS",n[n.MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS=35379]="MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS",n[n.UNIFORM_BUFFER_OFFSET_ALIGNMENT=35380]="UNIFORM_BUFFER_OFFSET_ALIGNMENT",n[n.ACTIVE_UNIFORM_BLOCKS=35382]="ACTIVE_UNIFORM_BLOCKS",n[n.UNIFORM_TYPE=35383]="UNIFORM_TYPE",n[n.UNIFORM_SIZE=35384]="UNIFORM_SIZE",n[n.UNIFORM_BLOCK_INDEX=35386]="UNIFORM_BLOCK_INDEX",n[n.UNIFORM_OFFSET=35387]="UNIFORM_OFFSET",n[n.UNIFORM_ARRAY_STRIDE=35388]="UNIFORM_ARRAY_STRIDE",n[n.UNIFORM_MATRIX_STRIDE=35389]="UNIFORM_MATRIX_STRIDE",n[n.UNIFORM_IS_ROW_MAJOR=35390]="UNIFORM_IS_ROW_MAJOR",n[n.UNIFORM_BLOCK_BINDING=35391]="UNIFORM_BLOCK_BINDING",n[n.UNIFORM_BLOCK_DATA_SIZE=35392]="UNIFORM_BLOCK_DATA_SIZE",n[n.UNIFORM_BLOCK_ACTIVE_UNIFORMS=35394]="UNIFORM_BLOCK_ACTIVE_UNIFORMS",n[n.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES=35395]="UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES",n[n.UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER=35396]="UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER",n[n.UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER=35398]="UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER",n[n.OBJECT_TYPE=37138]="OBJECT_TYPE",n[n.SYNC_CONDITION=37139]="SYNC_CONDITION",n[n.SYNC_STATUS=37140]="SYNC_STATUS",n[n.SYNC_FLAGS=37141]="SYNC_FLAGS",n[n.SYNC_FENCE=37142]="SYNC_FENCE",n[n.SYNC_GPU_COMMANDS_COMPLETE=37143]="SYNC_GPU_COMMANDS_COMPLETE",n[n.UNSIGNALED=37144]="UNSIGNALED",n[n.SIGNALED=37145]="SIGNALED",n[n.ALREADY_SIGNALED=37146]="ALREADY_SIGNALED",n[n.TIMEOUT_EXPIRED=37147]="TIMEOUT_EXPIRED",n[n.CONDITION_SATISFIED=37148]="CONDITION_SATISFIED",n[n.WAIT_FAILED=37149]="WAIT_FAILED",n[n.SYNC_FLUSH_COMMANDS_BIT=1]="SYNC_FLUSH_COMMANDS_BIT",n[n.COLOR=6144]="COLOR",n[n.DEPTH=6145]="DEPTH",n[n.STENCIL=6146]="STENCIL",n[n.MIN=32775]="MIN",n[n.MAX=32776]="MAX",n[n.DEPTH_COMPONENT24=33190]="DEPTH_COMPONENT24",n[n.STREAM_READ=35041]="STREAM_READ",n[n.STREAM_COPY=35042]="STREAM_COPY",n[n.STATIC_READ=35045]="STATIC_READ",n[n.STATIC_COPY=35046]="STATIC_COPY",n[n.DYNAMIC_READ=35049]="DYNAMIC_READ",n[n.DYNAMIC_COPY=35050]="DYNAMIC_COPY",n[n.DEPTH_COMPONENT32F=36012]="DEPTH_COMPONENT32F",n[n.DEPTH32F_STENCIL8=36013]="DEPTH32F_STENCIL8",n[n.INVALID_INDEX=4294967295]="INVALID_INDEX",n[n.TIMEOUT_IGNORED=-1]="TIMEOUT_IGNORED",n[n.MAX_CLIENT_WAIT_TIMEOUT_WEBGL=37447]="MAX_CLIENT_WAIT_TIMEOUT_WEBGL",n[n.UNMASKED_VENDOR_WEBGL=37445]="UNMASKED_VENDOR_WEBGL",n[n.UNMASKED_RENDERER_WEBGL=37446]="UNMASKED_RENDERER_WEBGL",n[n.MAX_TEXTURE_MAX_ANISOTROPY_EXT=34047]="MAX_TEXTURE_MAX_ANISOTROPY_EXT",n[n.TEXTURE_MAX_ANISOTROPY_EXT=34046]="TEXTURE_MAX_ANISOTROPY_EXT",n[n.R16_EXT=33322]="R16_EXT",n[n.RG16_EXT=33324]="RG16_EXT",n[n.RGB16_EXT=32852]="RGB16_EXT",n[n.RGBA16_EXT=32859]="RGBA16_EXT",n[n.R16_SNORM_EXT=36760]="R16_SNORM_EXT",n[n.RG16_SNORM_EXT=36761]="RG16_SNORM_EXT",n[n.RGB16_SNORM_EXT=36762]="RGB16_SNORM_EXT",n[n.RGBA16_SNORM_EXT=36763]="RGBA16_SNORM_EXT",n[n.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",n[n.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",n[n.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",n[n.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",n[n.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",n[n.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",n[n.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",n[n.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",n[n.COMPRESSED_RED_RGTC1_EXT=36283]="COMPRESSED_RED_RGTC1_EXT",n[n.COMPRESSED_SIGNED_RED_RGTC1_EXT=36284]="COMPRESSED_SIGNED_RED_RGTC1_EXT",n[n.COMPRESSED_RED_GREEN_RGTC2_EXT=36285]="COMPRESSED_RED_GREEN_RGTC2_EXT",n[n.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT=36286]="COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT",n[n.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",n[n.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=36493]="COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT",n[n.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT=36494]="COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT",n[n.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT=36495]="COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT",n[n.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",n[n.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",n[n.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",n[n.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",n[n.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",n[n.COMPRESSED_RGBA8_ETC2_EAC=37493]="COMPRESSED_RGBA8_ETC2_EAC",n[n.COMPRESSED_SRGB8_ETC2=37494]="COMPRESSED_SRGB8_ETC2",n[n.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37495]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",n[n.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37496]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",n[n.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37497]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",n[n.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",n[n.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",n[n.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",n[n.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",n[n.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",n[n.COMPRESSED_RGB_ATC_WEBGL=35986]="COMPRESSED_RGB_ATC_WEBGL",n[n.COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL=35986]="COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL",n[n.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL=34798]="COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL",n[n.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",n[n.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",n[n.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",n[n.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",n[n.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",n[n.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",n[n.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",n[n.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",n[n.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",n[n.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",n[n.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",n[n.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",n[n.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",n[n.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",n[n.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",n[n.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",n[n.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",n[n.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",n[n.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",n[n.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",n[n.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",n[n.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",n[n.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",n[n.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",n[n.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",n[n.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",n[n.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",n[n.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR",n[n.QUERY_COUNTER_BITS_EXT=34916]="QUERY_COUNTER_BITS_EXT",n[n.CURRENT_QUERY_EXT=34917]="CURRENT_QUERY_EXT",n[n.QUERY_RESULT_EXT=34918]="QUERY_RESULT_EXT",n[n.QUERY_RESULT_AVAILABLE_EXT=34919]="QUERY_RESULT_AVAILABLE_EXT",n[n.TIME_ELAPSED_EXT=35007]="TIME_ELAPSED_EXT",n[n.TIMESTAMP_EXT=36392]="TIMESTAMP_EXT",n[n.GPU_DISJOINT_EXT=36795]="GPU_DISJOINT_EXT",n[n.COMPLETION_STATUS_KHR=37297]="COMPLETION_STATUS_KHR",n[n.DEPTH_CLAMP_EXT=34383]="DEPTH_CLAMP_EXT",n[n.FIRST_VERTEX_CONVENTION_WEBGL=36429]="FIRST_VERTEX_CONVENTION_WEBGL",n[n.LAST_VERTEX_CONVENTION_WEBGL=36430]="LAST_VERTEX_CONVENTION_WEBGL",n[n.PROVOKING_VERTEX_WEBL=36431]="PROVOKING_VERTEX_WEBL",n[n.POLYGON_MODE_WEBGL=2880]="POLYGON_MODE_WEBGL",n[n.POLYGON_OFFSET_LINE_WEBGL=10754]="POLYGON_OFFSET_LINE_WEBGL",n[n.LINE_WEBGL=6913]="LINE_WEBGL",n[n.FILL_WEBGL=6914]="FILL_WEBGL",n[n.MAX_CLIP_DISTANCES_WEBGL=3378]="MAX_CLIP_DISTANCES_WEBGL",n[n.MAX_CULL_DISTANCES_WEBGL=33529]="MAX_CULL_DISTANCES_WEBGL",n[n.MAX_COMBINED_CLIP_AND_CULL_DISTANCES_WEBGL=33530]="MAX_COMBINED_CLIP_AND_CULL_DISTANCES_WEBGL",n[n.CLIP_DISTANCE0_WEBGL=12288]="CLIP_DISTANCE0_WEBGL",n[n.CLIP_DISTANCE1_WEBGL=12289]="CLIP_DISTANCE1_WEBGL",n[n.CLIP_DISTANCE2_WEBGL=12290]="CLIP_DISTANCE2_WEBGL",n[n.CLIP_DISTANCE3_WEBGL=12291]="CLIP_DISTANCE3_WEBGL",n[n.CLIP_DISTANCE4_WEBGL=12292]="CLIP_DISTANCE4_WEBGL",n[n.CLIP_DISTANCE5_WEBGL=12293]="CLIP_DISTANCE5_WEBGL",n[n.CLIP_DISTANCE6_WEBGL=12294]="CLIP_DISTANCE6_WEBGL",n[n.CLIP_DISTANCE7_WEBGL=12295]="CLIP_DISTANCE7_WEBGL",n[n.POLYGON_OFFSET_CLAMP_EXT=36379]="POLYGON_OFFSET_CLAMP_EXT",n[n.LOWER_LEFT_EXT=36001]="LOWER_LEFT_EXT",n[n.UPPER_LEFT_EXT=36002]="UPPER_LEFT_EXT",n[n.NEGATIVE_ONE_TO_ONE_EXT=37726]="NEGATIVE_ONE_TO_ONE_EXT",n[n.ZERO_TO_ONE_EXT=37727]="ZERO_TO_ONE_EXT",n[n.CLIP_ORIGIN_EXT=37724]="CLIP_ORIGIN_EXT",n[n.CLIP_DEPTH_MODE_EXT=37725]="CLIP_DEPTH_MODE_EXT",n[n.SRC1_COLOR_WEBGL=35065]="SRC1_COLOR_WEBGL",n[n.SRC1_ALPHA_WEBGL=34185]="SRC1_ALPHA_WEBGL",n[n.ONE_MINUS_SRC1_COLOR_WEBGL=35066]="ONE_MINUS_SRC1_COLOR_WEBGL",n[n.ONE_MINUS_SRC1_ALPHA_WEBGL=35067]="ONE_MINUS_SRC1_ALPHA_WEBGL",n[n.MAX_DUAL_SOURCE_DRAW_BUFFERS_WEBGL=35068]="MAX_DUAL_SOURCE_DRAW_BUFFERS_WEBGL",n[n.MIRROR_CLAMP_TO_EDGE_EXT=34627]="MIRROR_CLAMP_TO_EDGE_EXT"})(Jo||(Jo={}));const Gp={3042:!1,32773:new Float32Array([0,0,0,0]),32777:32774,34877:32774,32969:1,32968:0,32971:1,32970:0,3106:new Float32Array([0,0,0,0]),3107:[!0,!0,!0,!0],2884:!1,2885:1029,2929:!1,2931:1,2932:513,2928:new Float32Array([0,1]),2930:!0,3024:!0,35725:null,36006:null,36007:null,34229:null,34964:null,2886:2305,33170:4352,2849:1,32823:!1,32824:0,10752:0,32926:!1,32928:!1,32938:1,32939:!1,3089:!1,3088:new Int32Array([0,0,1024,1024]),2960:!1,2961:0,2968:4294967295,36005:4294967295,2962:519,2967:0,2963:4294967295,34816:519,36003:0,36004:4294967295,2964:7680,2965:7680,2966:7680,34817:7680,34818:7680,34819:7680,2978:[0,0,1024,1024],36389:null,36662:null,36663:null,35053:null,35055:null,35723:4352,36010:null,35977:!1,3333:4,3317:4,37440:!1,37441:!1,37443:37444,3330:0,3332:0,3331:0,3314:0,32878:0,3316:0,3315:0,32877:0},Se=(n,t,e)=>t?n.enable(e):n.disable(e),__=(n,t,e)=>n.hint(e,t),qn=(n,t,e)=>n.pixelStorei(e,t),y_=(n,t,e)=>{const r=e===36006?36009:36008;return n.bindFramebuffer(r,t)},tl=(n,t,e)=>{const i={34964:34962,36662:36662,36663:36663,35053:35051,35055:35052}[e];n.bindBuffer(i,t)};function Af(n){return Array.isArray(n)||ArrayBuffer.isView(n)&&!(n instanceof DataView)}const WM={3042:Se,32773:(n,t)=>n.blendColor(...t),32777:"blendEquation",34877:"blendEquation",32969:"blendFunc",32968:"blendFunc",32971:"blendFunc",32970:"blendFunc",3106:(n,t)=>n.clearColor(...t),3107:(n,t)=>n.colorMask(...t),2884:Se,2885:(n,t)=>n.cullFace(t),2929:Se,2931:(n,t)=>n.clearDepth(t),2932:(n,t)=>n.depthFunc(t),2928:(n,t)=>n.depthRange(...t),2930:(n,t)=>n.depthMask(t),3024:Se,35723:__,35725:(n,t)=>n.useProgram(t),36007:(n,t)=>n.bindRenderbuffer(36161,t),36389:(n,t)=>n.bindTransformFeedback?.(36386,t),34229:(n,t)=>n.bindVertexArray(t),36006:y_,36010:y_,34964:tl,36662:tl,36663:tl,35053:tl,35055:tl,2886:(n,t)=>n.frontFace(t),33170:__,2849:(n,t)=>n.lineWidth(t),32823:Se,32824:"polygonOffset",10752:"polygonOffset",35977:Se,32926:Se,32928:Se,32938:"sampleCoverage",32939:"sampleCoverage",3089:Se,3088:(n,t)=>n.scissor(...t),2960:Se,2961:(n,t)=>n.clearStencil(t),2968:(n,t)=>n.stencilMaskSeparate(1028,t),36005:(n,t)=>n.stencilMaskSeparate(1029,t),2962:"stencilFuncFront",2967:"stencilFuncFront",2963:"stencilFuncFront",34816:"stencilFuncBack",36003:"stencilFuncBack",36004:"stencilFuncBack",2964:"stencilOpFront",2965:"stencilOpFront",2966:"stencilOpFront",34817:"stencilOpBack",34818:"stencilOpBack",34819:"stencilOpBack",2978:(n,t)=>n.viewport(...t),34383:Se,10754:Se,12288:Se,12289:Se,12290:Se,12291:Se,12292:Se,12293:Se,12294:Se,12295:Se,3333:qn,3317:qn,37440:qn,37441:qn,37443:qn,3330:qn,3332:qn,3331:qn,3314:qn,32878:qn,3316:qn,3315:qn,32877:qn,framebuffer:(n,t)=>{const e=t&&"handle"in t?t.handle:t;return n.bindFramebuffer(36160,e)},blend:(n,t)=>t?n.enable(3042):n.disable(3042),blendColor:(n,t)=>n.blendColor(...t),blendEquation:(n,t)=>{const e=typeof t=="number"?[t,t]:t;n.blendEquationSeparate(...e)},blendFunc:(n,t)=>{const e=t?.length===2?[...t,...t]:t;n.blendFuncSeparate(...e)},clearColor:(n,t)=>n.clearColor(...t),clearDepth:(n,t)=>n.clearDepth(t),clearStencil:(n,t)=>n.clearStencil(t),colorMask:(n,t)=>n.colorMask(...t),cull:(n,t)=>t?n.enable(2884):n.disable(2884),cullFace:(n,t)=>n.cullFace(t),depthTest:(n,t)=>t?n.enable(2929):n.disable(2929),depthFunc:(n,t)=>n.depthFunc(t),depthMask:(n,t)=>n.depthMask(t),depthRange:(n,t)=>n.depthRange(...t),dither:(n,t)=>t?n.enable(3024):n.disable(3024),derivativeHint:(n,t)=>{n.hint(35723,t)},frontFace:(n,t)=>n.frontFace(t),mipmapHint:(n,t)=>n.hint(33170,t),lineWidth:(n,t)=>n.lineWidth(t),polygonOffsetFill:(n,t)=>t?n.enable(32823):n.disable(32823),polygonOffset:(n,t)=>n.polygonOffset(...t),sampleCoverage:(n,t)=>n.sampleCoverage(t[0],t[1]||!1),scissorTest:(n,t)=>t?n.enable(3089):n.disable(3089),scissor:(n,t)=>n.scissor(...t),stencilTest:(n,t)=>t?n.enable(2960):n.disable(2960),stencilMask:(n,t)=>{t=Af(t)?t:[t,t];const[e,r]=t;n.stencilMaskSeparate(1028,e),n.stencilMaskSeparate(1029,r)},stencilFunc:(n,t)=>{t=Af(t)&&t.length===3?[...t,...t]:t;const[e,r,i,s,o,a]=t;n.stencilFuncSeparate(1028,e,r,i),n.stencilFuncSeparate(1029,s,o,a)},stencilOp:(n,t)=>{t=Af(t)&&t.length===3?[...t,...t]:t;const[e,r,i,s,o,a]=t;n.stencilOpSeparate(1028,e,r,i),n.stencilOpSeparate(1029,s,o,a)},viewport:(n,t)=>n.viewport(...t)};function me(n,t,e){return t[n]!==void 0?t[n]:e[n]}const HM={blendEquation:(n,t,e)=>n.blendEquationSeparate(me(32777,t,e),me(34877,t,e)),blendFunc:(n,t,e)=>n.blendFuncSeparate(me(32969,t,e),me(32968,t,e),me(32971,t,e),me(32970,t,e)),polygonOffset:(n,t,e)=>n.polygonOffset(me(32824,t,e),me(10752,t,e)),sampleCoverage:(n,t,e)=>n.sampleCoverage(me(32938,t,e),me(32939,t,e)),stencilFuncFront:(n,t,e)=>n.stencilFuncSeparate(1028,me(2962,t,e),me(2967,t,e),me(2963,t,e)),stencilFuncBack:(n,t,e)=>n.stencilFuncSeparate(1029,me(34816,t,e),me(36003,t,e),me(36004,t,e)),stencilOpFront:(n,t,e)=>n.stencilOpSeparate(1028,me(2964,t,e),me(2965,t,e),me(2966,t,e)),stencilOpBack:(n,t,e)=>n.stencilOpSeparate(1029,me(34817,t,e),me(34818,t,e),me(34819,t,e))},v_={enable:(n,t)=>n({[t]:!0}),disable:(n,t)=>n({[t]:!1}),pixelStorei:(n,t,e)=>n({[t]:e}),hint:(n,t,e)=>n({[t]:e}),useProgram:(n,t)=>n({35725:t}),bindRenderbuffer:(n,t,e)=>n({36007:e}),bindTransformFeedback:(n,t,e)=>n({36389:e}),bindVertexArray:(n,t)=>n({34229:t}),bindFramebuffer:(n,t,e)=>{switch(t){case 36160:return n({36006:e,36010:e});case 36009:return n({36006:e});case 36008:return n({36010:e});default:return null}},bindBuffer:(n,t,e)=>{const r={34962:[34964],36662:[36662],36663:[36663],35051:[35053],35052:[35055]}[t];return r?n({[r]:e}):{valueChanged:!0}},blendColor:(n,t,e,r,i)=>n({32773:new Float32Array([t,e,r,i])}),blendEquation:(n,t)=>n({32777:t,34877:t}),blendEquationSeparate:(n,t,e)=>n({32777:t,34877:e}),blendFunc:(n,t,e)=>n({32969:t,32968:e,32971:t,32970:e}),blendFuncSeparate:(n,t,e,r,i)=>n({32969:t,32968:e,32971:r,32970:i}),clearColor:(n,t,e,r,i)=>n({3106:new Float32Array([t,e,r,i])}),clearDepth:(n,t)=>n({2931:t}),clearStencil:(n,t)=>n({2961:t}),colorMask:(n,t,e,r,i)=>n({3107:[t,e,r,i]}),cullFace:(n,t)=>n({2885:t}),depthFunc:(n,t)=>n({2932:t}),depthRange:(n,t,e)=>n({2928:new Float32Array([t,e])}),depthMask:(n,t)=>n({2930:t}),frontFace:(n,t)=>n({2886:t}),lineWidth:(n,t)=>n({2849:t}),polygonOffset:(n,t,e)=>n({32824:t,10752:e}),sampleCoverage:(n,t,e)=>n({32938:t,32939:e}),scissor:(n,t,e,r,i)=>n({3088:new Int32Array([t,e,r,i])}),stencilMask:(n,t)=>n({2968:t,36005:t}),stencilMaskSeparate:(n,t,e)=>n({[t===1028?2968:36005]:e}),stencilFunc:(n,t,e,r)=>n({2962:t,2967:e,2963:r,34816:t,36003:e,36004:r}),stencilFuncSeparate:(n,t,e,r,i)=>n({[t===1028?2962:34816]:e,[t===1028?2967:36003]:r,[t===1028?2963:36004]:i}),stencilOp:(n,t,e,r)=>n({2964:t,2965:e,2966:r,34817:t,34818:e,34819:r}),stencilOpSeparate:(n,t,e,r,i)=>n({[t===1028?2964:34817]:e,[t===1028?2965:34818]:r,[t===1028?2966:34819]:i}),viewport:(n,t,e,r,i)=>n({2978:[t,e,r,i]})},fi=(n,t)=>n.isEnabled(t),b_={3042:fi,2884:fi,2929:fi,3024:fi,32823:fi,32926:fi,32928:fi,3089:fi,2960:fi,35977:fi},jM=new Set([34016,36388,36387,35983,35368,34965,35739,35738,3074,34853,34854,34855,34856,34857,34858,34859,34860,34861,34862,34863,34864,34865,34866,34867,34868,35097,32873,35869,32874,34068]);function ja(n,t){if(XM(t))return;const e={};for(const i in t){const s=Number(i),o=WM[i];o&&(typeof o=="string"?e[o]=!0:o(n,t[i],s))}const r=n.state&&n.state.cache;if(r)for(const i in e){const s=HM[i];s(n,t,r)}}function nx(n,t=Gp){if(typeof t=="number"){const i=t,s=b_[i];return s?s(n,i):n.getParameter(i)}const e=Array.isArray(t)?t:Object.keys(t),r={};for(const i of e){const s=b_[i];r[i]=s?s(n,Number(i)):n.getParameter(Number(i))}return r}function $M(n){ja(n,Gp)}function XM(n){for(const t in n)return!1;return!0}function GM(n,t){if(n===t)return!0;const e=Array.isArray(n)||ArrayBuffer.isView(n),r=Array.isArray(t)||ArrayBuffer.isView(t);if(e&&r&&n.length===t.length){for(let i=0;i<n.length;++i)if(n[i]!==t[i])return!1;return!0}return!1}class no{static get(t){return t.state}gl;program=null;stateStack=[];enable=!0;cache=null;log;initialized=!1;constructor(t,e){this.gl=t,this.log=e?.log||(()=>{}),this._updateCache=this._updateCache.bind(this),Object.seal(this)}push(t={}){this.stateStack.push({})}pop(){const t=this.stateStack[this.stateStack.length-1];ja(this.gl,t),this.stateStack.pop()}trackState(t,e){if(this.cache=e.copyState?nx(t):Object.assign({},Gp),this.initialized)throw new Error("WebGLStateTracker");this.initialized=!0,this.gl.state=this,qM(t);for(const r in v_){const i=v_[r];YM(t,r,i)}x_(t,"getParameter"),x_(t,"isEnabled")}_updateCache(t){let e=!1,r;const i=this.stateStack.length>0?this.stateStack[this.stateStack.length-1]:null;for(const s in t){const o=t[s],a=this.cache[s];GM(o,a)||(e=!0,r=a,i&&!(s in i)&&(i[s]=a),this.cache[s]=o)}return{valueChanged:e,oldValue:r}}}function x_(n,t){const e=n[t].bind(n);n[t]=function(i){if(i===void 0||jM.has(i))return e(i);const s=no.get(n);return i in s.cache||(s.cache[i]=e(i)),s.enable?s.cache[i]:e(i)},Object.defineProperty(n[t],"name",{value:`${t}-from-cache`,configurable:!1})}function YM(n,t,e){if(!n[t])return;const r=n[t].bind(n);n[t]=function(...s){const o=no.get(n),{valueChanged:a,oldValue:l}=e(o._updateCache,...s);return a&&r(...s),l},Object.defineProperty(n[t],"name",{value:`${t}-to-cache`,configurable:!1})}function qM(n){const t=n.useProgram.bind(n);n.useProgram=function(r){const i=no.get(n);i.program!==r&&(t(r),i.program=r)}}function KM(n,t,e){let r="";const i={preserveDrawingBuffer:!0,...e};let s=null;if(s||=n.getContext("webgl2",i),i.failIfMajorPerformanceCaveat&&(r||="Only software GPU is available. Set `failIfMajorPerformanceCaveat: false` to allow."),!s&&!e.failIfMajorPerformanceCaveat&&(i.failIfMajorPerformanceCaveat=!1,s=n.getContext("webgl2",i),s.luma||={},s.luma.softwareRenderer=!0),s||(s=n.getContext("webgl",{}),s&&(s=null,r||="Your browser only supports WebGL1")),!s)throw r||="Your browser does not support WebGL",new Error(`Failed to create WebGL context: ${r}`);const{onContextLost:o,onContextRestored:a}=t;return n.addEventListener("webglcontextlost",l=>o(l),!1),n.addEventListener("webglcontextrestored",l=>a(l),!1),s.luma||={},s}function ma(n,t,e){return e[t]===void 0&&(e[t]=n.getExtension(t)||null),e[t]}function ZM(n,t){const e=n.getParameter(7936),r=n.getParameter(7937);ma(n,"WEBGL_debug_renderer_info",t);const i=t.WEBGL_debug_renderer_info,s=n.getParameter(i?i.UNMASKED_VENDOR_WEBGL:7936),o=n.getParameter(i?i.UNMASKED_RENDERER_WEBGL:7937),a=s||e,l=o||r,c=n.getParameter(7938),u=rx(a,l),h=JM(a,l),f=QM(a,l);return{type:"webgl",gpu:u,gpuType:f,gpuBackend:h,vendor:a,renderer:l,version:c,shadingLanguage:"glsl",shadingLanguageVersion:300}}function rx(n,t){return/NVIDIA/i.exec(n)||/NVIDIA/i.exec(t)?"nvidia":/INTEL/i.exec(n)||/INTEL/i.exec(t)?"intel":/Apple/i.exec(n)||/Apple/i.exec(t)?"apple":/AMD/i.exec(n)||/AMD/i.exec(t)||/ATI/i.exec(n)||/ATI/i.exec(t)?"amd":/SwiftShader/i.exec(n)||/SwiftShader/i.exec(t)?"software":"unknown"}function JM(n,t){return/Metal/i.exec(n)||/Metal/i.exec(t)?"metal":/ANGLE/i.exec(n)||/ANGLE/i.exec(t)?"opengl":"unknown"}function QM(n,t){if(/SwiftShader/i.exec(n)||/SwiftShader/i.exec(t))return"cpu";switch(rx(n,t)){case"intel":return"integrated";case"software":return"cpu";case"unknown":return"unknown";default:return"discrete"}}function ix(n){switch(n){case"uint8":return 5121;case"sint8":return 5120;case"unorm8":return 5121;case"snorm8":return 5120;case"uint16":return 5123;case"sint16":return 5122;case"unorm16":return 5123;case"snorm16":return 5122;case"uint32":return 5125;case"sint32":return 5124;case"float16":return 5131;case"float32":return 5126}throw new Error(String(n))}const ul="WEBGL_compressed_texture_s3tc",hl="WEBGL_compressed_texture_s3tc_srgb",Qo="EXT_texture_compression_rgtc",ta="EXT_texture_compression_bptc",tR="WEBGL_compressed_texture_etc",eR="WEBGL_compressed_texture_astc",nR="WEBGL_compressed_texture_etc1",rR="WEBGL_compressed_texture_pvrtc",iR="WEBGL_compressed_texture_atc",E_="EXT_texture_norm16",w_="EXT_render_snorm",sR="EXT_color_buffer_float",Yp={"float32-renderable-webgl":["EXT_color_buffer_float"],"float16-renderable-webgl":["EXT_color_buffer_half_float"],"rgb9e5ufloat-renderable-webgl":["WEBGL_render_shared_exponent"],"snorm8-renderable-webgl":[w_],"norm16-renderable-webgl":[E_],"snorm16-renderable-webgl":[E_,w_],"float32-filterable":["OES_texture_float_linear"],"float16-filterable-webgl":["OES_texture_half_float_linear"],"texture-filterable-anisotropic-webgl":["EXT_texture_filter_anisotropic"],"texture-blend-float-webgl":["EXT_float_blend"],"texture-compression-bc":[ul,hl,Qo,ta],"texture-compression-bc5-webgl":[Qo],"texture-compression-bc7-webgl":[ta],"texture-compression-etc2":[tR],"texture-compression-astc":[eR],"texture-compression-etc1-webgl":[nR],"texture-compression-pvrtc-webgl":[rR],"texture-compression-atc-webgl":[iR]};function oR(n){return n in Yp}function aR(n,t,e){return(Yp[t]||[]).every(i=>ma(n,i,e))}const qp={r8unorm:{gl:33321,rb:!0},r8snorm:{gl:36756},r8uint:{gl:33330,rb:!0},r8sint:{gl:33329,rb:!0},rg8unorm:{gl:33323,rb:!0},rg8snorm:{gl:36757},rg8uint:{gl:33336,rb:!0},rg8sint:{gl:33335,rb:!0},r16uint:{gl:33332,rb:!0},r16sint:{gl:33331,rb:!0},r16float:{gl:33325,rb:!0},"r16unorm-webgl":{gl:33322,rb:!0},"r16snorm-webgl":{gl:36760},"rgba4unorm-webgl":{gl:32854,rb:!0},"rgb565unorm-webgl":{gl:36194,rb:!0},"rgb5a1unorm-webgl":{gl:32855,rb:!0},"rgb8unorm-webgl":{gl:32849},"rgb8snorm-webgl":{gl:36758},rgba8unorm:{gl:32856},"rgba8unorm-srgb":{gl:35907},rgba8snorm:{gl:36759},rgba8uint:{gl:36220},rgba8sint:{gl:36238},bgra8unorm:{},"bgra8unorm-srgb":{},rg16uint:{gl:33338},rg16sint:{gl:33337},rg16float:{gl:33327,rb:!0},"rg16unorm-webgl":{gl:33324},"rg16snorm-webgl":{gl:36761},r32uint:{gl:33334,rb:!0},r32sint:{gl:33333,rb:!0},r32float:{gl:33326},rgb9e5ufloat:{gl:35901},rg11b10ufloat:{gl:35898,rb:!0},rgb10a2unorm:{gl:32857,rb:!0},"rgb10a2uint-webgl":{gl:36975,rb:!0},"rgb16unorm-webgl":{gl:32852},"rgb16snorm-webgl":{gl:36762},rg32uint:{gl:33340,rb:!0},rg32sint:{gl:33339,rb:!0},rg32float:{gl:33328,rb:!0},rgba16uint:{gl:36214,rb:!0},rgba16sint:{gl:36232,rb:!0},rgba16float:{gl:34842},"rgba16unorm-webgl":{gl:32859,rb:!0},"rgba16snorm-webgl":{gl:36763},"rgb32float-webgl":{gl:34837,x:sR,dataFormat:6407,types:[5126]},rgba32uint:{gl:36208,rb:!0},rgba32sint:{gl:36226,rb:!0},rgba32float:{gl:34836,rb:!0},stencil8:{gl:36168,rb:!0},depth16unorm:{gl:33189,dataFormat:6402,types:[5123],rb:!0},depth24plus:{gl:33190,dataFormat:6402,types:[5125]},depth32float:{gl:36012,dataFormat:6402,types:[5126],rb:!0},"depth24plus-stencil8":{gl:35056,rb:!0,depthTexture:!0,dataFormat:34041,types:[34042]},"depth32float-stencil8":{gl:36013,dataFormat:34041,types:[36269],rb:!0},"bc1-rgb-unorm-webgl":{gl:33776,x:ul},"bc1-rgb-unorm-srgb-webgl":{gl:35916,x:hl},"bc1-rgba-unorm":{gl:33777,x:ul},"bc1-rgba-unorm-srgb":{gl:35916,x:hl},"bc2-rgba-unorm":{gl:33778,x:ul},"bc2-rgba-unorm-srgb":{gl:35918,x:hl},"bc3-rgba-unorm":{gl:33779,x:ul},"bc3-rgba-unorm-srgb":{gl:35919,x:hl},"bc4-r-unorm":{gl:36283,x:Qo},"bc4-r-snorm":{gl:36284,x:Qo},"bc5-rg-unorm":{gl:36285,x:Qo},"bc5-rg-snorm":{gl:36286,x:Qo},"bc6h-rgb-ufloat":{gl:36495,x:ta},"bc6h-rgb-float":{gl:36494,x:ta},"bc7-rgba-unorm":{gl:36492,x:ta},"bc7-rgba-unorm-srgb":{gl:36493,x:ta},"etc2-rgb8unorm":{gl:37492},"etc2-rgb8unorm-srgb":{gl:37494},"etc2-rgb8a1unorm":{gl:37496},"etc2-rgb8a1unorm-srgb":{gl:37497},"etc2-rgba8unorm":{gl:37493},"etc2-rgba8unorm-srgb":{gl:37495},"eac-r11unorm":{gl:37488},"eac-r11snorm":{gl:37489},"eac-rg11unorm":{gl:37490},"eac-rg11snorm":{gl:37491},"astc-4x4-unorm":{gl:37808},"astc-4x4-unorm-srgb":{gl:37840},"astc-5x4-unorm":{gl:37809},"astc-5x4-unorm-srgb":{gl:37841},"astc-5x5-unorm":{gl:37810},"astc-5x5-unorm-srgb":{gl:37842},"astc-6x5-unorm":{gl:37811},"astc-6x5-unorm-srgb":{gl:37843},"astc-6x6-unorm":{gl:37812},"astc-6x6-unorm-srgb":{gl:37844},"astc-8x5-unorm":{gl:37813},"astc-8x5-unorm-srgb":{gl:37845},"astc-8x6-unorm":{gl:37814},"astc-8x6-unorm-srgb":{gl:37846},"astc-8x8-unorm":{gl:37815},"astc-8x8-unorm-srgb":{gl:37847},"astc-10x5-unorm":{gl:37819},"astc-10x5-unorm-srgb":{gl:37851},"astc-10x6-unorm":{gl:37817},"astc-10x6-unorm-srgb":{gl:37849},"astc-10x8-unorm":{gl:37818},"astc-10x8-unorm-srgb":{gl:37850},"astc-10x10-unorm":{gl:37819},"astc-10x10-unorm-srgb":{gl:37851},"astc-12x10-unorm":{gl:37820},"astc-12x10-unorm-srgb":{gl:37852},"astc-12x12-unorm":{gl:37821},"astc-12x12-unorm-srgb":{gl:37853},"pvrtc-rgb4unorm-webgl":{gl:35840},"pvrtc-rgba4unorm-webgl":{gl:35842},"pvrtc-rbg2unorm-webgl":{gl:35841},"pvrtc-rgba2unorm-webgl":{gl:35843},"etc1-rbg-unorm-webgl":{gl:36196},"atc-rgb-unorm-webgl":{gl:35986},"atc-rgba-unorm-webgl":{gl:35986},"atc-rgbai-unorm-webgl":{gl:34798}};function lR(n,t,e){let r=t.create;const i=qp[t.format];return i?.gl===void 0&&(r=!1),i?.x&&(r=r&&!!ma(n,i.x,e)),{format:t.format,create:r&&t.create,render:r&&t.render,filter:r&&t.filter,blend:r&&t.blend,store:r&&t.store}}function sx(n){const t=qp[n],e=hR(n),r=Ep(n);return{internalFormat:e,format:t?.dataFormat||uR(r.channels,r.integer,r.normalized,e),type:r.dataType?ix(r.dataType):t?.types?.[0]||5121,compressed:r.compressed||!1}}function cR(n){switch(Ep(n).attachment){case"depth":return 36096;case"stencil":return 36128;case"depth-stencil":return 33306;default:throw new Error(`Not a depth stencil format: ${n}`)}}function uR(n,t,e,r){if(r===6408||r===6407)return r;switch(n){case"r":return t&&!e?36244:6403;case"rg":return t&&!e?33320:33319;case"rgb":return t&&!e?36248:6407;case"rgba":return t&&!e?36249:6408;case"bgra":throw new Error("bgra pixels not supported by WebGL");default:return 6408}}function hR(n){const e=qp[n]?.gl;if(e===void 0)throw new Error(`Unsupported texture format ${n}`);return e}const S_={"depth-clip-control":"EXT_depth_clamp","timer-query-webgl":"EXT_disjoint_timer_query_webgl2","compilation-status-async-webgl":"KHR_parallel_shader_compile","polygon-mode-webgl":"WEBGL_polygon_mode","provoking-vertex-webgl":"WEBGL_provoking_vertex","shader-clip-cull-distance-webgl":"WEBGL_clip_cull_distance","shader-noperspective-interpolation-webgl":"NV_shader_noperspective_interpolation","shader-conservative-depth-webgl":"EXT_conservative_depth"};class fR extends XT{gl;extensions;testedFeatures=new Set;constructor(t,e,r){super([],r),this.gl=t,this.extensions=e,ma(t,"EXT_color_buffer_float",e)}*[Symbol.iterator](){const t=this.getFeatures();for(const e of t)this.has(e)&&(yield e);return[]}has(t){return this.disabledFeatures?.[t]?!1:(this.testedFeatures.has(t)||(this.testedFeatures.add(t),oR(t)&&aR(this.gl,t,this.extensions)&&this.features.add(t),this.getWebGLFeature(t)&&this.features.add(t)),this.features.has(t))}initializeFeatures(){const t=this.getFeatures().filter(e=>e!=="polygon-mode-webgl");for(const e of t)this.has(e)}getFeatures(){return[...Object.keys(S_),...Object.keys(Yp)]}getWebGLFeature(t){const e=S_[t];return typeof e=="string"?!!ma(this.gl,e,this.extensions):!!e}}class dR extends $T{get maxTextureDimension1D(){return 0}get maxTextureDimension2D(){return this.getParameter(3379)}get maxTextureDimension3D(){return this.getParameter(32883)}get maxTextureArrayLayers(){return this.getParameter(35071)}get maxBindGroups(){return 0}get maxDynamicUniformBuffersPerPipelineLayout(){return 0}get maxDynamicStorageBuffersPerPipelineLayout(){return 0}get maxSampledTexturesPerShaderStage(){return this.getParameter(35660)}get maxSamplersPerShaderStage(){return this.getParameter(35661)}get maxStorageBuffersPerShaderStage(){return 0}get maxStorageTexturesPerShaderStage(){return 0}get maxUniformBuffersPerShaderStage(){return this.getParameter(35375)}get maxUniformBufferBindingSize(){return this.getParameter(35376)}get maxStorageBufferBindingSize(){return 0}get minUniformBufferOffsetAlignment(){return this.getParameter(35380)}get minStorageBufferOffsetAlignment(){return 0}get maxVertexBuffers(){return 16}get maxVertexAttributes(){return this.getParameter(34921)}get maxVertexBufferArrayStride(){return 2048}get maxInterStageShaderComponents(){return this.getParameter(35659)}get maxComputeWorkgroupStorageSize(){return 0}get maxComputeInvocationsPerWorkgroup(){return 0}get maxComputeWorkgroupSizeX(){return 0}get maxComputeWorkgroupSizeY(){return 0}get maxComputeWorkgroupSizeZ(){return 0}get maxComputeWorkgroupsPerDimension(){return 0}gl;limits={};constructor(t){super(),this.gl=t}getParameter(t){return this.limits[t]===void 0&&(this.limits[t]=this.gl.getParameter(t)),this.limits[t]||0}}class El extends wh{device;gl;handle;colorAttachments=[];depthStencilAttachment=null;constructor(t,e){super(t,e);const r=e.handle===null;this.device=t,this.gl=t.gl,this.handle=this.props.handle||r?this.props.handle:this.gl.createFramebuffer(),r||(t.setSpectorMetadata(this.handle,{id:this.props.id,props:this.props}),this.autoCreateAttachmentTextures(),this.updateAttachments())}destroy(){super.destroy(),!this.destroyed&&this.handle!==null&&this.gl.deleteFramebuffer(this.handle)}updateAttachments(){const t=this.gl.bindFramebuffer(36160,this.handle);for(let e=0;e<this.colorAttachments.length;++e){const r=this.colorAttachments[e];if(r){const i=36064+e;this._attachTextureView(i,r)}}if(this.depthStencilAttachment){const e=cR(this.depthStencilAttachment.props.format);this._attachTextureView(e,this.depthStencilAttachment)}if(this.device.props.debug){const e=this.gl.checkFramebufferStatus(36160);if(e!==36053)throw new Error(`Framebuffer ${gR(e)}`)}this.gl.bindFramebuffer(36160,t)}_attachTextureView(t,e){const{gl:r}=this.device,{texture:i}=e,s=e.props.baseMipLevel,o=e.props.baseArrayLayer;switch(r.bindTexture(i.glTarget,i.handle),i.glTarget){case 35866:case 32879:r.framebufferTextureLayer(36160,t,i.handle,s,o);break;case 34067:const a=pR(o);r.framebufferTexture2D(36160,t,a,i.handle,s);break;case 3553:r.framebufferTexture2D(36160,t,3553,i.handle,s);break;default:throw new Error("Illegal texture type")}r.bindTexture(i.glTarget,null)}}function pR(n){return n<34069?n+34069:n}function gR(n){switch(n){case 36053:return"success";case 36054:return"Mismatched attachments";case 36055:return"No attachments";case 36057:return"Height/width mismatch";case 36061:return"Unsupported or split attachments";case 36182:return"Samples mismatch";default:return`${n}`}}class mR extends wp{device;format="rgba8unorm";depthStencilFormat="depth24plus";presentationSize;_framebuffer=null;get[Symbol.toStringTag](){return"WebGLCanvasContext"}constructor(t,e){super(e),this.device=t,this.presentationSize=[-1,-1],this._setAutoCreatedCanvasId(`${this.device.id}-canvas`),this.update()}getCurrentFramebuffer(){return this.update(),this._framebuffer=this._framebuffer||new El(this.device,{handle:null}),this._framebuffer}update(){const t=this.getPixelSize();(t[0]!==this.presentationSize[0]||t[1]!==this.presentationSize[1])&&(this.presentationSize=t,this.resize())}resize(t){if(this.device.gl&&this.canvas){const e=this.getDevicePixelRatio(t?.useDevicePixels);this.setDevicePixelRatio(e,t);return}}commit(){}}async function ox(n,t){const e=document.getElementsByTagName("head")[0];if(!e)throw new Error("loadScript");const r=document.createElement("script");return r.setAttribute("type","text/javascript"),r.setAttribute("src",n),new Promise((i,s)=>{r.onload=i,r.onerror=o=>s(new Error(`Unable to load script '${n}': ${o}`)),e.appendChild(r)})}const _R=1;let Kn=null,C_=!1;const Kp={debugSpectorJS:tt.get("debug-spectorjs"),debugSpectorJSUrl:"https://cdn.jsdelivr.net/npm/spectorjs@0.9.30/dist/spector.bundle.js",gl:void 0};async function yR(n){if(!globalThis.SPECTOR)try{await ox(n.debugSpectorJSUrl||Kp.debugSpectorJSUrl)}catch(t){tt.warn(String(t))}}function vR(n){if(n={...Kp,...n},!n.debugSpectorJS)return null;if(!Kn&&globalThis.SPECTOR&&!globalThis.luma?.spector){tt.probe(_R,"SPECTOR found and initialized. Start with `luma.spector.displayUI()`")();const{Spector:t}=globalThis.SPECTOR;Kn=new t,globalThis.luma&&(globalThis.luma.spector=Kn)}if(!Kn)return null;if(C_||(C_=!0,Kn.spyCanvases(),Kn?.onCaptureStarted.add(t=>tt.info("Spector capture started:",t)()),Kn?.onCapture.add(t=>{tt.info("Spector capture complete:",t)(),Kn?.getResultUI(),Kn?.resultView.display(),Kn?.resultView.addCapture(t)})),n.gl){const t=n.gl,e=t.device;Kn?.startCapture(n.gl,500),t.device=e,new Promise(r=>setTimeout(r,2e3)).then(r=>{tt.info("Spector capture stopped after 2 seconds")(),Kn?.stopCapture()})}return Kn}const bR="https://unpkg.com/webgl-debug@2.0.1/index.js";function ax(n){return n.luma=n.luma||{},n.luma}async function xR(){To()&&!globalThis.WebGLDebugUtils&&(globalThis.global=globalThis.global||globalThis,globalThis.global.module={},await ox(bR))}function ER(n,t={}){return t.debugWebGL||t.traceWebGL?SR(n,t):wR(n)}function wR(n){const t=ax(n);return t.realContext?t.realContext:n}function SR(n,t){if(!globalThis.WebGLDebugUtils)return tt.warn("webgl-debug not loaded")(),n;const e=ax(n);if(e.debugContext)return e.debugContext;globalThis.WebGLDebugUtils.init({...Jo,...n});const r=globalThis.WebGLDebugUtils.makeDebugContext(n,CR.bind(null,t),TR.bind(null,t));for(const o in Jo)!(o in r)&&typeof Jo[o]=="number"&&(r[o]=Jo[o]);class i{}Object.setPrototypeOf(r,Object.getPrototypeOf(n)),Object.setPrototypeOf(i,r);const s=Object.create(i);return e.realContext=n,e.debugContext=s,s.debug=!0,s}function T_(n,t){t=Array.from(t).map(r=>r===void 0?"undefined":r);let e=globalThis.WebGLDebugUtils.glFunctionArgsToString(n,t);return e=`${e.slice(0,100)}${e.length>100?"...":""}`,`gl.${n}(${e})`}function CR(n,t,e,r){r=Array.from(r).map(a=>a===void 0?"undefined":a);const i=globalThis.WebGLDebugUtils.glEnumToString(t),s=globalThis.WebGLDebugUtils.glFunctionArgsToString(e,r),o=`${i} in gl.${e}(${s})`;tt.error(o)();debugger}function TR(n,t,e){let r="";tt.level>=1&&(r=T_(t,e),n.traceWebGL&&tt.log(1,r)());for(const i of e)if(i===void 0){r=r||T_(t,e);debugger}}const Mf={};function PR(n="id"){Mf[n]=Mf[n]||1;const t=Mf[n]++;return`${n}-${t}`}class wl extends Yt{device;gl;handle;glTarget;glUsage;glIndexType=5123;byteLength;bytesUsed;constructor(t,e={}){super(t,e),this.device=t,this.gl=this.device.gl;const r=typeof e=="object"?e.handle:void 0;this.handle=r||this.gl.createBuffer(),t.setSpectorMetadata(this.handle,{...this.props,data:typeof this.props.data}),this.glTarget=IR(this.props.usage),this.glUsage=AR(this.props.usage),this.glIndexType=this.props.indexType==="uint32"?5125:5123,e.data?this._initWithData(e.data,e.byteOffset,e.byteLength):this._initWithByteLength(e.byteLength||0)}_initWithData(t,e=0,r=t.byteLength+e){const i=this.glTarget;this.gl.bindBuffer(i,this.handle),this.gl.bufferData(i,r,this.glUsage),this.gl.bufferSubData(i,e,t),this.gl.bindBuffer(i,null),this.bytesUsed=r,this.byteLength=r,this._setDebugData(t,e,r),this.trackAllocatedMemory(r)}_initWithByteLength(t){let e=t;t===0&&(e=new Float32Array(0));const r=this.glTarget;return this.gl.bindBuffer(r,this.handle),this.gl.bufferData(r,e,this.glUsage),this.gl.bindBuffer(r,null),this.bytesUsed=t,this.byteLength=t,this._setDebugData(null,0,t),this.trackAllocatedMemory(t),this}destroy(){!this.destroyed&&this.handle&&(this.removeStats(),this.trackDeallocatedMemory(),this.gl.deleteBuffer(this.handle),this.destroyed=!0,this.handle=null)}write(t,e=0){this.gl.bindBuffer(36663,this.handle),this.gl.bufferSubData(36663,e,t),this.gl.bindBuffer(36663,null),this._setDebugData(t,e,t.byteLength)}async readAsync(t=0,e){return this.readSyncWebGL(t,e)}readSyncWebGL(t=0,e){e=e??this.byteLength-t;const r=new Uint8Array(e),i=0;return this.gl.bindBuffer(36662,this.handle),this.gl.getBufferSubData(36662,t,r,i,e),this.gl.bindBuffer(36662,null),this._setDebugData(r,t,e),r}}function IR(n){return n&Yt.INDEX?34963:n&Yt.VERTEX?34962:n&Yt.UNIFORM?35345:34962}function AR(n){return n&Yt.INDEX||n&Yt.VERTEX?35044:n&Yt.UNIFORM?35048:35044}function MR(n){const t=n.split(/\r?\n/),e=[];for(const r of t){if(r.length<=1)continue;const i=r.split(":");if(i.length===2){const[h,f]=i;e.push({message:f.trim(),type:P_(h),lineNum:0,linePos:0});continue}const[s,o,a,...l]=i;let c=parseInt(a,10);isNaN(c)&&(c=0);let u=parseInt(o,10);isNaN(u)&&(u=0),e.push({message:l.join(":").trim(),type:P_(s),lineNum:c,linePos:u})}return e}function P_(n){const t=["warning","error","info"],e=n.toLowerCase();return t.includes(e)?e:"info"}class RR extends Eh{device;handle;constructor(t,e){switch(super(t,e),this.device=t,this.props.stage){case"vertex":this.handle=this.props.handle||this.device.gl.createShader(35633);break;case"fragment":this.handle=this.props.handle||this.device.gl.createShader(35632);break;default:throw new Error(this.props.stage)}this._compile(this.source)}destroy(){this.handle&&(this.removeStats(),this.device.gl.deleteShader(this.handle),this.destroyed=!0)}get asyncCompilationStatus(){return this._waitForCompilationComplete().then(()=>this.compilationStatus)}async getCompilationInfo(){return await this._waitForCompilationComplete(),this.getCompilationInfoSync()}getCompilationInfoSync(){const t=this.device.gl.getShaderInfoLog(this.handle);return t?MR(t):[]}getTranslatedSource(){return this.device.getExtension("WEBGL_debug_shaders").WEBGL_debug_shaders?.getTranslatedShaderSource(this.handle)||null}async _compile(t){t=t.startsWith("#version ")?t:`#version 300 es
${t}`;const{gl:e}=this.device;if(e.shaderSource(this.handle,t),e.compileShader(this.handle),!this.device.props.debug){this.compilationStatus="pending";return}if(!this.device.features.has("compilation-status-async-webgl")){if(this._getCompilationStatus(),this.debugShader(),this.compilationStatus==="error")throw new Error(`GLSL compilation errors in ${this.props.stage} shader ${this.props.id}`);return}tt.once(1,"Shader compilation is asynchronous")(),await this._waitForCompilationComplete(),tt.info(2,`Shader ${this.id} - async compilation complete: ${this.compilationStatus}`)(),this._getCompilationStatus(),this.debugShader()}async _waitForCompilationComplete(){const t=async i=>await new Promise(s=>setTimeout(s,i));if(!this.device.features.has("compilation-status-async-webgl")){await t(10);return}const{gl:r}=this.device;for(;;){if(r.getShaderParameter(this.handle,37297))return;await t(10)}}_getCompilationStatus(){this.compilationStatus=this.device.gl.getShaderParameter(this.handle,35713)?"success":"error"}}function NR(n,t,e,r){if(kR(t))return r(n);const i=n;i.pushState();try{return OR(n,t),ja(i.gl,e),r(n)}finally{i.popState()}}function OR(n,t){const e=n,{gl:r}=e;if(t.cullMode)switch(t.cullMode){case"none":r.disable(2884);break;case"front":r.enable(2884),r.cullFace(1028);break;case"back":r.enable(2884),r.cullFace(1029);break}if(t.frontFace&&r.frontFace(ro("frontFace",t.frontFace,{ccw:2305,cw:2304})),t.unclippedDepth&&n.features.has("depth-clip-control")&&r.enable(34383),t.depthBias!==void 0&&(r.enable(32823),r.polygonOffset(t.depthBias,t.depthBiasSlopeScale||0)),t.provokingVertex&&n.features.has("provoking-vertex-webgl")){const s=e.getExtension("WEBGL_provoking_vertex").WEBGL_provoking_vertex,o=ro("provokingVertex",t.provokingVertex,{first:36429,last:36430});s?.provokingVertexWEBGL(o)}if((t.polygonMode||t.polygonOffsetLine)&&n.features.has("polygon-mode-webgl")){if(t.polygonMode){const s=e.getExtension("WEBGL_polygon_mode").WEBGL_polygon_mode,o=ro("polygonMode",t.polygonMode,{fill:6914,line:6913});s?.polygonModeWEBGL(1028,o),s?.polygonModeWEBGL(1029,o)}t.polygonOffsetLine&&r.enable(10754)}if(n.features.has("shader-clip-cull-distance-webgl")&&(t.clipDistance0&&r.enable(12288),t.clipDistance1&&r.enable(12289),t.clipDistance2&&r.enable(12290),t.clipDistance3&&r.enable(12291),t.clipDistance4&&r.enable(12292),t.clipDistance5&&r.enable(12293),t.clipDistance6&&r.enable(12294),t.clipDistance7&&r.enable(12295)),t.depthWriteEnabled!==void 0&&r.depthMask(LR("depthWriteEnabled",t.depthWriteEnabled)),t.depthCompare&&(t.depthCompare!=="always"?r.enable(2929):r.disable(2929),r.depthFunc(Rd("depthCompare",t.depthCompare))),t.stencilWriteMask){const i=t.stencilWriteMask;r.stencilMaskSeparate(1028,i),r.stencilMaskSeparate(1029,i)}if(t.stencilReadMask&&tt.warn("stencilReadMask not supported under WebGL"),t.stencilCompare){const i=t.stencilReadMask||4294967295,s=Rd("depthCompare",t.stencilCompare);t.stencilCompare!=="always"?r.enable(2960):r.disable(2960),r.stencilFuncSeparate(1028,s,0,i),r.stencilFuncSeparate(1029,s,0,i)}if(t.stencilPassOperation&&t.stencilFailOperation&&t.stencilDepthFailOperation){const i=Rf("stencilPassOperation",t.stencilPassOperation),s=Rf("stencilFailOperation",t.stencilFailOperation),o=Rf("stencilDepthFailOperation",t.stencilDepthFailOperation);r.stencilOpSeparate(1028,s,o,i),r.stencilOpSeparate(1029,s,o,i)}switch(t.blend){case!0:r.enable(3042);break;case!1:r.disable(3042);break}if(t.blendColorOperation||t.blendAlphaOperation){const i=I_("blendColorOperation",t.blendColorOperation||"add"),s=I_("blendAlphaOperation",t.blendAlphaOperation||"add");r.blendEquationSeparate(i,s);const o=Lc("blendColorSrcFactor",t.blendColorSrcFactor||"one"),a=Lc("blendColorDstFactor",t.blendColorDstFactor||"zero"),l=Lc("blendAlphaSrcFactor",t.blendAlphaSrcFactor||"one"),c=Lc("blendAlphaDstFactor",t.blendAlphaDstFactor||"zero");r.blendFuncSeparate(o,a,l,c)}}function Rd(n,t){return ro(n,t,{never:512,less:513,equal:514,"less-equal":515,greater:516,"not-equal":517,"greater-equal":518,always:519})}function Rf(n,t){return ro(n,t,{keep:7680,zero:0,replace:7681,invert:5386,"increment-clamp":7682,"decrement-clamp":7683,"increment-wrap":34055,"decrement-wrap":34056})}function I_(n,t){return ro(n,t,{add:32774,subtract:32778,"reverse-subtract":32779,min:32775,max:32776})}function Lc(n,t){return ro(n,t,{one:1,zero:0,"src-color":768,"one-minus-src-color":769,"dst-color":774,"one-minus-dst-color":775,"src-alpha":770,"one-minus-src-alpha":771,"dst-alpha":772,"one-minus-dst-alpha":773,"src-alpha-saturated":776,"constant-color":32769,"one-minus-constant-color":32770,"constant-alpha":32771,"one-minus-constant-alpha":32772})}function DR(n,t){return`Illegal parameter ${t} for ${n}`}function ro(n,t,e){if(!(t in e))throw new Error(DR(n,t));return e[t]}function LR(n,t){return t}function kR(n){let t=!0;for(const e in n){t=!1;break}return t}function lx(n){const t={};return n.addressModeU&&(t[10242]=Nf(n.addressModeU)),n.addressModeV&&(t[10243]=Nf(n.addressModeV)),n.addressModeW&&(t[32882]=Nf(n.addressModeW)),n.magFilter&&(t[10240]=Nd(n.magFilter)),(n.minFilter||n.mipmapFilter)&&(t[10241]=FR(n.minFilter||"linear",n.mipmapFilter)),n.lodMinClamp!==void 0&&(t[33082]=n.lodMinClamp),n.lodMaxClamp!==void 0&&(t[33083]=n.lodMaxClamp),n.type==="comparison-sampler"&&(t[34892]=34894),n.compare&&(t[34893]=Rd("compare",n.compare)),n.maxAnisotropy&&(t[34046]=n.maxAnisotropy),t}function Nf(n){switch(n){case"clamp-to-edge":return 33071;case"repeat":return 10497;case"mirror-repeat":return 33648}}function Nd(n){switch(n){case"nearest":return 9728;case"linear":return 9729}}function FR(n,t="none"){if(!t)return Nd(n);switch(t){case"none":return Nd(n);case"nearest":return n==="nearest"?9984:9986;case"linear":return n==="nearest"?9985:9987}}class Od extends Pl{device;handle;parameters;constructor(t,e){super(t,e),this.device=t,this.parameters=lx(e),this.handle=this.handle||this.device.gl.createSampler(),this._setSamplerParameters(this.parameters)}destroy(){this.handle&&(this.device.gl.deleteSampler(this.handle),this.handle=void 0)}toString(){return`Sampler(${this.id},${JSON.stringify(this.props)})`}_setSamplerParameters(t){for(const[e,r]of Object.entries(t)){const i=Number(e);switch(i){case 33082:case 33083:this.device.gl.samplerParameterf(this.handle,i,r);break;default:this.device.gl.samplerParameteri(this.handle,i,r);break}}}}class ea extends xh{device;gl;handle;texture;constructor(t,e){super(t,{...jt.defaultProps,...e}),this.device=t,this.gl=this.device.gl,this.handle=null,this.texture=e.texture}}const BR="Failed to deduce GL constant from typed array";function UR(n){switch(ArrayBuffer.isView(n)?n.constructor:n){case Float32Array:return 5126;case Uint16Array:return 5123;case Uint32Array:return 5125;case Uint8Array:return 5121;case Uint8ClampedArray:return 5121;case Int8Array:return 5120;case Int16Array:return 5122;case Int32Array:return 5124;default:throw new Error(BR)}}function VR(n,t){const{clamped:e=!0}=t||{};switch(n){case 5126:return Float32Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return e?Uint8ClampedArray:Uint8Array;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Failed to deduce typed array type from GL constant")}}function cx(n){switch(n){case 6406:case 33326:case 6403:case 36244:return 1;case 33339:case 33340:case 33328:case 33320:case 33319:return 2;case 6407:case 36248:case 34837:return 3;case 6408:case 36249:case 34836:return 4;default:return 0}}function zR(n){switch(n){case 5121:return 1;case 33635:case 32819:case 32820:return 2;case 5126:return 4;default:return 0}}function ju(n,t,e){if(WR(t))return e(n);const{nocatch:r=!0}=t,i=no.get(n);i.push(),ja(n,t);let s;if(r)s=e(n),i.pop();else try{s=e(n)}finally{i.pop()}return s}function WR(n){for(const t in n)return!1;return!0}function HR(n,t,e){const{dimension:r,width:i,height:s,depth:o=0}=e,{glInternalFormat:a}=e,l=e.glTarget;switch(r){case"2d-array":case"3d":n.texStorage3D(l,t,a,i,s,o);break;default:n.texStorage2D(l,t,a,i,s)}}function A_(n,t,e,r){const{width:i,height:s}=r,{dimension:o,depth:a=0,mipLevel:l=0}=r,{x:c=0,y:u=0,z:h=0}=r,{glFormat:f,glType:d}=r,p=ux(r.glTarget,o,a),_=r.flipY?{37440:!0}:{};ju(n,_,()=>{switch(o){case"2d-array":case"3d":n.bindTexture(p,t),n.texSubImage3D(p,l,c,u,h,i,s,a,f,d,e),n.bindTexture(p,null);break;case"2d":case"cube":n.bindTexture(p,t),n.texSubImage2D(p,l,c,u,i,s,f,d,e),n.bindTexture(p,null);break;default:throw new Error(o)}})}function M_(n,t,e){const{dimension:r,width:i,height:s,depth:o=0,mipLevel:a=0,byteOffset:l=0}=e,{x:c=0,y:u=0,z:h=0}=e,{glFormat:f,glType:d,compressed:p}=e,_=ux(e.glTarget,r,o);switch(r){case"2d-array":case"3d":p?n.compressedTexSubImage3D(_,a,c,u,h,i,s,o,f,t,l):n.texSubImage3D(_,a,c,u,h,i,s,o,f,d,t,l);break;case"2d":case"cube":p?n.compressedTexSubImage2D(_,a,c,u,i,s,f,t,l):n.texSubImage2D(_,a,c,u,i,s,f,d,t,l);break;default:throw new Error(r)}}function jR(n){switch(n){case"1d":break;case"2d":return 3553;case"3d":return 32879;case"cube":return 34067;case"2d-array":return 35866}throw new Error(n)}function ux(n,t,e){return t==="cube"?34069+e:n}function $R(n,t){const{sourceX:e=0,sourceY:r=0,sourceAttachment:i=0}=t||{};let{target:s=null,sourceWidth:o,sourceHeight:a,sourceDepth:l,sourceFormat:c,sourceType:u}=t||{};const{framebuffer:h,deleteFramebuffer:f}=hx(n),{gl:d,handle:p}=h;o||=h.width,a||=h.height;const _=h.colorAttachments[i]?.texture;if(!_)throw new Error(`Invalid framebuffer attachment ${i}`);l=_?.depth||1,c||=_?.glFormat||6408,u||=_?.glType||5121,s=YR(s,u,c,o,a),u=u||UR(s);const v=d.bindFramebuffer(36160,p);return d.readBuffer(36064+i),d.readPixels(e,r,o,a,c,u,s),d.readBuffer(36064),d.bindFramebuffer(36160,v||null),f&&h.destroy(),s}function XR(n,t){const{target:e,sourceX:r=0,sourceY:i=0,sourceFormat:s=6408,targetByteOffset:o=0}=t||{};let{sourceWidth:a,sourceHeight:l,sourceType:c}=t||{};const{framebuffer:u,deleteFramebuffer:h}=hx(n);a=a||u.width,l=l||u.height;const f=u;c=c||5121;let d=e;if(!d){const _=cx(s),v=zR(c),E=o+a*l*_*v;d=f.device.createBuffer({byteLength:E})}const p=n.device.createCommandEncoder();return p.copyTextureToBuffer({sourceTexture:n,width:a,height:l,origin:[r,i],destinationBuffer:d,byteOffset:o}),p.destroy(),h&&u.destroy(),d}function hx(n){return n instanceof wh?{framebuffer:n,deleteFramebuffer:!1}:{framebuffer:GR(n),deleteFramebuffer:!0}}function GR(n,t){const{device:e,width:r,height:i,id:s}=n;return e.createFramebuffer({...t,id:`framebuffer-for-${s}`,width:r,height:i,colorAttachments:[n]})}function YR(n,t,e,r,i,s){if(n)return n;t||=5121;const o=VR(t,{clamped:!1}),a=cx(e);return new o(r*i*a)}class Sl extends jt{device;gl;handle;sampler=void 0;view=void 0;mipmaps;compressed;glTarget;glFormat;glType;glInternalFormat;textureUnit=0;constructor(t,e){super(t,e);const r={...this.props};r.data=e.data,this.device=t,this.gl=this.device.gl,this.glTarget=jR(this.props.dimension);const i=sx(this.props.format);this.glInternalFormat=i.internalFormat,this.glFormat=i.format,this.glType=i.type,this.compressed=i.compressed,this.mipmaps=!!this.props.mipmaps,this._initialize(r),Object.seal(this)}_initialize(t){this.handle=this.props.handle||this.gl.createTexture(),this.device.setSpectorMetadata(this.handle,{...this.props,data:t.data});let{width:e,height:r}=t;if(!e||!r){const i=jt.getTextureDataSize(t.data);e=i?.width||1,r=i?.height||1}if(this.width=e,this.height=r,this.depth=t.depth,this.setSampler(t.sampler),this.view=new ea(this.device,{...this.props,texture:this}),this.bind(),HR(this.gl,this.mipLevels,this),t.data)switch(t.dimension){case"1d":this.setTexture1DData(t.data);break;case"2d":this.setTexture2DData(t.data);break;case"3d":this.setTexture3DData(t.data);break;case"cube":this.setTextureCubeData(t.data);break;case"2d-array":this.setTextureArrayData(t.data);break;case"cube-array":this.setTextureCubeArrayData(t.data);break;default:throw new Error(t.dimension)}this.mipmaps&&this.generateMipmap()}destroy(){this.handle&&(this.gl.deleteTexture(this.handle),this.removeStats(),this.trackDeallocatedMemory("Texture"),this.destroyed=!0)}createView(t){return new ea(this.device,{...t,texture:this})}setSampler(t={}){let e;t instanceof Od?(this.sampler=t,e=t.props):(this.sampler=new Od(this.device,t),e=t);const r=lx(e);this._setSamplerParameters(r)}generateMipmap(t){if(!(!(this.device.isTextureFormatRenderable(this.props.format)&&this.device.isTextureFormatFilterable(this.props.format))&&(tt.warn(`${this} is not renderable or filterable, may not be able to generate mipmaps`)(),!t?.force)))try{this.gl.bindTexture(this.glTarget,this.handle),this.gl.generateMipmap(this.glTarget)}catch(r){tt.warn(`Error generating mipmap for ${this}: ${r.message}`)()}finally{this.gl.bindTexture(this.glTarget,null)}}copyExternalImage(t){const e=jt.getExternalImageSize(t.image),r={...jt.defaultCopyExternalImageOptions,...e,...t},{image:i,depth:s,mipLevel:o,x:a,y:l,z:c,flipY:u}=r;let{width:h,height:f}=r;const{dimension:d,glTarget:p,glFormat:_,glInternalFormat:v,glType:E}=this;if(h=Math.min(h,this.width-a),f=Math.min(f,this.height-l),t.sourceX||t.sourceY)throw new Error("WebGL does not support sourceX/sourceY)");return A_(this.device.gl,this.handle,i,{dimension:d,mipLevel:o,x:a,y:l,z:c,width:h,height:f,depth:s,glFormat:_,glType:E,glTarget:p,flipY:u}),{width:r.width,height:r.height}}setTexture1DData(t){throw new Error("setTexture1DData not supported in WebGL.")}setTexture2DData(t,e=0){this.bind();const r=jt.normalizeTextureData(t,this);r.length>1&&this.props.mipmaps!==!1&&tt.warn(`Texture ${this.id} mipmap and multiple LODs.`)();for(let i=0;i<r.length;i++){const s=r[i];this._setMipLevel(e,i,s)}this.unbind()}setTexture3DData(t){if(this.props.dimension!=="3d")throw new Error(this.id);ArrayBuffer.isView(t)&&(this.bind(),M_(this.device.gl,t,this),this.unbind())}setTextureCubeData(t,e=0){if(this.props.dimension!=="cube")throw new Error(this.id);for(const r of jt.CubeFaces)this.setTextureCubeFaceData(t[r],r)}setTextureArrayData(t){throw this.props.dimension!=="2d-array"?new Error(this.id):new Error("setTextureArrayData not implemented.")}setTextureCubeArrayData(t){throw new Error("setTextureCubeArrayData not supported in WebGL2.")}setTextureCubeFaceData(t,e,r=0){Array.isArray(t)&&t.length>1&&this.props.mipmaps!==!1&&tt.warn(`${this.id} has mipmap and multiple LODs.`)();const i=jt.CubeFaces.indexOf(e);this.setTexture2DData(t,i)}update(){throw new Error("Texture.update() not implemented. Use ExternalTexture")}setImageDataForFace(t){const{face:e,width:r,height:i,pixels:s,data:o,format:a=6408,type:l=5121}=t,{gl:c}=this,u=s||o;this.bind(),u instanceof Promise?u.then(h=>this.setImageDataForFace(Object.assign({},t,{face:e,data:h,pixels:h}))):this.width||this.height?c.texImage2D(e,0,a,r,i,0,a,l,u):c.texImage2D(e,0,a,a,l,u)}_getImageDataMap(t){for(let e=0;e<jt.CubeFaces.length;++e){const r=jt.CubeFaces[e];t[r]&&(t[34069+e]=t[r],delete t[r])}return t}_setSamplerParameters(t){tt.log(1,`${this.id} sampler parameters`,this.device.getGLKeys(t))(),this.gl.bindTexture(this.glTarget,this.handle);for(const[e,r]of Object.entries(t)){const i=Number(e),s=r;switch(i){case 33082:case 33083:this.gl.texParameterf(this.glTarget,i,s);break;case 10241:this.gl.texParameteri(this.glTarget,i,s);break;case 10242:case 10243:this.gl.texParameteri(this.glTarget,i,s);break;case 34046:this.device.features.has("texture-filterable-anisotropic-webgl")&&this.gl.texParameteri(this.glTarget,i,s);break;default:this.gl.texParameteri(this.glTarget,i,s);break}}this.gl.bindTexture(this.glTarget,null)}_setMipLevel(t,e,r,i=this.glTarget){if(jt.isExternalImage(r)){A_(this.device.gl,this.handle,r,{...this,depth:t,mipLevel:e,glTarget:i,flipY:this.props.flipY});return}if(jt.isTextureLevelData(r)){M_(this.device.gl,r.data,{...this,depth:t,mipLevel:e,glTarget:i});return}throw new Error("Texture: invalid image data")}getActiveUnit(){return this.gl.getParameter(34016)-33984}bind(t){const{gl:e}=this;return t!==void 0&&(this.textureUnit=t,e.activeTexture(33984+t)),e.bindTexture(this.glTarget,this.handle),t}unbind(t){const{gl:e}=this;return t!==void 0&&(this.textureUnit=t,e.activeTexture(33984+t)),e.bindTexture(this.glTarget,null),t}}const qR=[1,2,4,8];class KR extends Zs{device;glParameters;constructor(t,e){super(t,e),this.device=t;let r;if(!e?.parameters?.viewport)if(e?.framebuffer){const{width:s,height:o}=e.framebuffer;r=[0,0,s,o]}else{const[s,o]=t.getCanvasContext().getDrawingBufferSize();r=[0,0,s,o]}if(this.device.pushState(),this.setParameters({viewport:r,...this.props.parameters}),this.props.framebuffer?.handle)if(this.props.framebuffer){const s=this.props.framebuffer.colorAttachments.map((o,a)=>36064+a);this.device.gl.drawBuffers(s)}else this.device.gl.drawBuffers([1029]);this.clear()}end(){this.device.popState()}pushDebugGroup(t){}popDebugGroup(){}insertDebugMarker(t){}setParameters(t={}){const e={...this.glParameters};e.framebuffer=this.props.framebuffer||null,this.props.depthReadOnly&&(e.depthMask=!this.props.depthReadOnly),e.stencilMask=this.props.stencilReadOnly?0:1,e[35977]=this.props.discard,t.viewport&&(t.viewport.length>=6?(e.viewport=t.viewport.slice(0,4),e.depthRange=[t.viewport[4],t.viewport[5]]):e.viewport=t.viewport),t.scissorRect&&(e.scissorTest=!0,e.scissor=t.scissorRect),t.blendConstant&&(e.blendColor=t.blendConstant),t.stencilReference&&(console.warn("RenderPassParameters.stencilReference not yet implemented in WebGL"),t[2967]=t.stencilReference),t.colorMask&&(e.colorMask=qR.map(r=>!!(r&t.colorMask))),this.glParameters=e,ja(this.device.gl,e)}beginOcclusionQuery(t){this.props.occlusionQuerySet?.beginOcclusionQuery()}endOcclusionQuery(){this.props.occlusionQuerySet?.endOcclusionQuery()}clear(){const t={...this.glParameters};let e=0;this.props.clearColors&&this.props.clearColors.forEach((r,i)=>{r&&this.clearColorBuffer(i,r)}),this.props.clearColor!==!1&&this.props.clearColors===void 0&&(e|=16384,t.clearColor=this.props.clearColor),this.props.clearDepth!==!1&&(e|=256,t.clearDepth=this.props.clearDepth),this.props.clearStencil!==!1&&(e|=1024,t.clearStencil=this.props.clearStencil),e!==0&&ju(this.device.gl,t,()=>{this.device.gl.clear(e)})}clearColorBuffer(t=0,e=[0,0,0,0]){ju(this.device.gl,{framebuffer:this.props.framebuffer},()=>{switch(e.constructor){case Int8Array:case Int16Array:case Int32Array:this.device.gl.clearBufferiv(6144,t,e);break;case Uint8Array:case Uint8ClampedArray:case Uint16Array:case Uint32Array:this.device.gl.clearBufferuiv(6144,t,e);break;case Float32Array:this.device.gl.clearBufferfv(6144,t,e);break;default:throw new Error("clearColorBuffer: color must be typed array")}})}}function ZR(n){return JR.includes(n)}const JR=[35678,35680,35679,35682,36289,36292,36293,36298,36299,36300,36303,36306,36307,36308,36311],fx={5126:[5126,1,"float","f32","float32"],35664:[5126,2,"vec2","vec2<f32>","float32x2"],35665:[5126,3,"vec3","vec3<f32>","float32x3"],35666:[5126,4,"vec4","vec4<f32>","float32x4"],5124:[5124,1,"int","i32","sint32"],35667:[5124,2,"ivec2","vec2<i32>","sint32x2"],35668:[5124,3,"ivec3","vec3<i32>","sint32x3"],35669:[5124,4,"ivec4","vec4<i32>","sint32x4"],5125:[5125,1,"uint","u32","uint32"],36294:[5125,2,"uvec2","vec2<u32>","uint32x2"],36295:[5125,3,"uvec3","vec3<u32>","uint32x3"],36296:[5125,4,"uvec4","vec4<u32>","uint32x4"],35670:[5126,1,"bool","f32","float32"],35671:[5126,2,"bvec2","vec2<f32>","float32x2"],35672:[5126,3,"bvec3","vec3<f32>","float32x3"],35673:[5126,4,"bvec4","vec4<f32>","float32x4"],35674:[5126,8,"mat2","mat2x2<f32>"],35685:[5126,8,"mat2x3","mat2x3<f32>"],35686:[5126,8,"mat2x4","mat2x4<f32>"],35687:[5126,12,"mat3x2","mat3x2<f32>"],35675:[5126,12,"mat3","mat3x3<f32>"],35688:[5126,12,"mat3x4","mat3x4<f32>"],35689:[5126,16,"mat4x2","mat4x2<f32>"],35690:[5126,16,"mat4x3","mat4x3<f32>"],35676:[5126,16,"mat4","mat4x4<f32>"]};function dx(n){const t=fx[n];if(!t)throw new Error("uniform");const[e,r,,i]=t;return{format:i,components:r,glType:e}}function QR(n){const t=fx[n];if(!t)throw new Error("attribute");const[,e,,r,i]=t;return{attributeType:r,vertexFormat:i,components:e}}function tN(n,t){const e={attributes:[],bindings:[]};e.attributes=eN(n,t);const r=iN(n,t);for(const a of r){const l=a.uniforms.map(c=>({name:c.name,format:c.format,byteOffset:c.byteOffset,byteStride:c.byteStride,arrayLength:c.arrayLength}));e.bindings.push({type:"uniform",name:a.name,group:0,location:a.location,visibility:(a.vertex?1:0)&(a.fragment?2:0),minBindingSize:a.byteLength,uniforms:l})}const i=rN(n,t);let s=0;for(const a of i)if(ZR(a.type)){const{viewDimension:l,sampleType:c}=oN(a.type);e.bindings.push({type:"texture",name:a.name,group:0,location:s,viewDimension:l,sampleType:c}),a.textureUnit=s,s+=1}i.length&&(e.uniforms=i);const o=nN(n,t);return o?.length&&(e.varyings=o),e}function eN(n,t){const e=[],r=n.getProgramParameter(t,35721);for(let i=0;i<r;i++){const s=n.getActiveAttrib(t,i);if(!s)throw new Error("activeInfo");const{name:o,type:a}=s,l=n.getAttribLocation(t,o);if(l>=0){const{attributeType:c}=QR(a),u=/instance/i.test(o)?"instance":"vertex";e.push({name:o,location:l,stepMode:u,type:c})}}return e.sort((i,s)=>i.location-s.location),e}function nN(n,t){const e=[],r=n.getProgramParameter(t,35971);for(let i=0;i<r;i++){const s=n.getTransformFeedbackVarying(t,i);if(!s)throw new Error("activeInfo");const{name:o,type:a,size:l}=s,{glType:c,components:u}=dx(a),h={location:i,name:o,type:c,size:l*u};e.push(h)}return e.sort((i,s)=>i.location-s.location),e}function rN(n,t){const e=[],r=n.getProgramParameter(t,35718);for(let i=0;i<r;i++){const s=n.getActiveUniform(t,i);if(!s)throw new Error("activeInfo");const{name:o,size:a,type:l}=s,{name:c,isArray:u}=aN(o);let h=n.getUniformLocation(t,c);const f={location:h,name:c,size:a,type:l,isArray:u};if(e.push(f),f.size>1)for(let d=0;d<f.size;d++){const p=`${c}[${d}]`;h=n.getUniformLocation(t,p);const _={...f,name:p,location:h};e.push(_)}}return e}function iN(n,t){const e=(s,o)=>n.getActiveUniformBlockParameter(t,s,o),r=[],i=n.getProgramParameter(t,35382);for(let s=0;s<i;s++){const o={name:n.getActiveUniformBlockName(t,s)||"",location:e(s,35391),byteLength:e(s,35392),vertex:e(s,35396),fragment:e(s,35398),uniformCount:e(s,35394),uniforms:[]},a=e(s,35395)||[],l=n.getActiveUniforms(t,a,35383),c=n.getActiveUniforms(t,a,35384),u=n.getActiveUniforms(t,a,35387),h=n.getActiveUniforms(t,a,35388);for(let f=0;f<o.uniformCount;++f){const d=n.getActiveUniform(t,a[f]);if(!d)throw new Error("activeInfo");o.uniforms.push({name:d.name,format:dx(l[f]).format,type:l[f],arrayLength:c[f],byteOffset:u[f],byteStride:h[f]})}r.push(o)}return r.sort((s,o)=>s.location-o.location),r}const sN={35678:["2d","float"],35680:["cube","float"],35679:["3d","float"],35682:["3d","depth"],36289:["2d-array","float"],36292:["2d-array","depth"],36293:["cube","float"],36298:["2d","sint"],36299:["3d","sint"],36300:["cube","sint"],36303:["2d-array","uint"],36306:["2d","uint"],36307:["3d","uint"],36308:["cube","uint"],36311:["2d-array","uint"]};function oN(n){const t=sN[n];if(!t)throw new Error("sampler");const[e,r]=t;return{viewDimension:e,sampleType:r}}function aN(n){if(n[n.length-1]!=="]")return{name:n,length:1,isArray:!1};const e=/([^[]*)(\[[0-9]+\])?/.exec(n);if(!e||e.length<2)throw new Error(`Failed to parse GLSL uniform name ${n}`);return{name:e[1],length:e[2]?1:0,isArray:!!e[2]}}function lN(n,t,e,r){const i=n;let s=r;s===!0&&(s=1),s===!1&&(s=0);const o=typeof s=="number"?[s]:s;switch(e){case 35678:case 35680:case 35679:case 35682:case 36289:case 36292:case 36293:case 36298:case 36299:case 36300:case 36303:case 36306:case 36307:case 36308:case 36311:if(typeof r!="number")throw new Error("samplers must be set to integers");return n.uniform1i(t,r);case 5126:return n.uniform1fv(t,o);case 35664:return n.uniform2fv(t,o);case 35665:return n.uniform3fv(t,o);case 35666:return n.uniform4fv(t,o);case 5124:return n.uniform1iv(t,o);case 35667:return n.uniform2iv(t,o);case 35668:return n.uniform3iv(t,o);case 35669:return n.uniform4iv(t,o);case 35670:return n.uniform1iv(t,o);case 35671:return n.uniform2iv(t,o);case 35672:return n.uniform3iv(t,o);case 35673:return n.uniform4iv(t,o);case 5125:return i.uniform1uiv(t,o,1);case 36294:return i.uniform2uiv(t,o,2);case 36295:return i.uniform3uiv(t,o,3);case 36296:return i.uniform4uiv(t,o,4);case 35674:return n.uniformMatrix2fv(t,!1,o);case 35675:return n.uniformMatrix3fv(t,!1,o);case 35676:return n.uniformMatrix4fv(t,!1,o);case 35685:return i.uniformMatrix2x3fv(t,!1,o);case 35686:return i.uniformMatrix2x4fv(t,!1,o);case 35687:return i.uniformMatrix3x2fv(t,!1,o);case 35688:return i.uniformMatrix3x4fv(t,!1,o);case 35689:return i.uniformMatrix4x2fv(t,!1,o);case 35690:return i.uniformMatrix4x3fv(t,!1,o)}throw new Error("Illegal uniform")}function cN(n){return Yb(n)!==null||typeof n=="number"||typeof n=="boolean"}function uN(n){const t={bindings:{},uniforms:{}};return Object.keys(n).forEach(e=>{const r=n[e];cN(r)?t.uniforms[e]=r:t.bindings[e]=r}),t}function hN(n){switch(n){case"point-list":return 0;case"line-list":return 1;case"line-strip":return 3;case"triangle-list":return 4;case"triangle-strip":return 5;default:throw new Error(n)}}function fN(n){switch(n){case"point-list":return 0;case"line-list":return 1;case"line-strip":return 1;case"triangle-list":return 4;case"triangle-strip":return 4;default:throw new Error(n)}}const R_=4;class dN extends la{device;handle;vs;fs;introspectedLayout;uniforms={};bindings={};varyings=null;_uniformCount=0;_uniformSetters={};constructor(t,e){super(t,e),this.device=t,this.handle=this.props.handle||this.device.gl.createProgram(),this.device.setSpectorMetadata(this.handle,{id:this.props.id}),this.vs=e.vs,this.fs=e.fs;const{varyings:r,bufferMode:i=35981}=e;r&&r.length>0&&(this.varyings=r,this.device.gl.transformFeedbackVaryings(this.handle,r,i)),this._linkShaders(),tt.time(1,`RenderPipeline ${this.id} - shaderLayout introspection`)(),this.introspectedLayout=tN(this.device.gl,this.handle),tt.timeEnd(1,`RenderPipeline ${this.id} - shaderLayout introspection`)(),this.shaderLayout=pN(this.introspectedLayout,e.shaderLayout)}destroy(){this.handle&&(this.device.gl.deleteProgram(this.handle),this.destroyed=!0)}setBindings(t,e){for(const[r,i]of Object.entries(t)){const s=this.shaderLayout.bindings.find(o=>o.name===r)||this.shaderLayout.bindings.find(o=>o.name===`${r}Uniforms`);if(!s){const o=this.shaderLayout.bindings.map(a=>`"${a.name}"`).join(", ");e?.disableWarnings||tt.warn(`No binding "${r}" in render pipeline "${this.id}", expected one of ${o}`,i)();continue}switch(i||tt.warn(`Unsetting binding "${r}" in render pipeline "${this.id}"`)(),s.type){case"uniform":if(!(i instanceof wl)&&!(i.buffer instanceof wl))throw new Error("buffer value");break;case"texture":if(!(i instanceof ea||i instanceof Sl||i instanceof El))throw new Error("texture value");break;case"sampler":tt.warn(`Ignoring sampler ${r}`)();break;default:throw new Error(s.type)}this.bindings[r]=i}}draw(t){const{renderPass:e,parameters:r=this.props.parameters,topology:i=this.props.topology,vertexArray:s,vertexCount:o,instanceCount:a,isInstanced:l=!1,firstVertex:c=0,transformFeedback:u}=t,h=hN(i),f=!!s.indexBuffer,d=s.indexBuffer?.glIndexType;if(this.linkStatus!=="success")return tt.info(2,`RenderPipeline:${this.id}.draw() aborted - waiting for shader linking`)(),!1;if(!this._areTexturesRenderable())return tt.info(2,`RenderPipeline:${this.id}.draw() aborted - textures not yet loaded`)(),!1;this.device.gl.useProgram(this.handle),s.bindBeforeRender(e),u&&u.begin(this.props.topology),this._applyBindings(),this._applyUniforms();const p=e;return NR(this.device,r,p.glParameters,()=>{f&&l?this.device.gl.drawElementsInstanced(h,o||0,d,c,a||0):f?this.device.gl.drawElements(h,o||0,d,c):l?this.device.gl.drawArraysInstanced(h,c,o||0,a||0):this.device.gl.drawArrays(h,c,o||0),u&&u.end()}),s.unbindAfterRender(e),!0}setUniformsWebGL(t){const{bindings:e}=uN(t);Object.keys(e).forEach(r=>{tt.warn(`Unsupported value "${JSON.stringify(e[r])}" used in setUniforms() for key ${r}. Use setBindings() instead?`)()}),Object.assign(this.uniforms,t)}async _linkShaders(){const{gl:t}=this.device;if(t.attachShader(this.handle,this.vs.handle),t.attachShader(this.handle,this.fs.handle),tt.time(R_,`linkProgram for ${this.id}`)(),t.linkProgram(this.handle),tt.timeEnd(R_,`linkProgram for ${this.id}`)(),tt.level,!this.device.features.has("compilation-status-async-webgl")){const r=this._getLinkStatus();this._reportLinkStatus(r);return}tt.once(1,"RenderPipeline linking is asynchronous")(),await this._waitForLinkComplete(),tt.info(2,`RenderPipeline ${this.id} - async linking complete: ${this.linkStatus}`)();const e=this._getLinkStatus();this._reportLinkStatus(e)}async _reportLinkStatus(t){switch(t){case"success":return;default:switch(this.vs.compilationStatus){case"error":throw this.vs.debugShader(),new Error(`Error during compilation of shader ${this.vs.id}`);case"pending":this.vs.asyncCompilationStatus.then(()=>this.vs.debugShader());break}switch(this.fs?.compilationStatus){case"error":throw this.fs.debugShader(),new Error(`Error during compilation of shader ${this.fs.id}`);case"pending":this.fs.asyncCompilationStatus.then(()=>this.fs.debugShader());break}const e=this.device.gl.getProgramInfoLog(this.handle);throw new Error(`Error during ${t}: ${e}`)}}_getLinkStatus(){const{gl:t}=this.device;return t.getProgramParameter(this.handle,35714)?(t.validateProgram(this.handle),t.getProgramParameter(this.handle,35715)?(this.linkStatus="success","success"):(this.linkStatus="error","validation")):(this.linkStatus="error","linking")}async _waitForLinkComplete(){const t=async i=>await new Promise(s=>setTimeout(s,i));if(!this.device.features.has("compilation-status-async-webgl")){await t(10);return}const{gl:r}=this.device;for(;;){if(r.getProgramParameter(this.handle,37297))return;await t(10)}}_areTexturesRenderable(){let t=!0;for(const e of this.shaderLayout.bindings)!this.bindings[e.name]&&!this.bindings[e.name.replace(/Uniforms$/,"")]&&(tt.warn(`Binding ${e.name} not found in ${this.id}`)(),t=!1);return t}_applyBindings(){if(this.linkStatus!=="success")return;const{gl:t}=this.device;t.useProgram(this.handle);let e=0,r=0;for(const i of this.shaderLayout.bindings){const s=this.bindings[i.name]||this.bindings[i.name.replace(/Uniforms$/,"")];if(!s)throw new Error(`No value for binding ${i.name} in ${this.id}`);switch(i.type){case"uniform":const{name:o}=i,a=t.getUniformBlockIndex(this.handle,o);if(a===4294967295)throw new Error(`Invalid uniform block name ${o}`);t.uniformBlockBinding(this.handle,r,a),s instanceof wl?t.bindBufferBase(35345,r,s.handle):t.bindBufferRange(35345,r,s.buffer.handle,s.offset||0,s.size||s.buffer.byteLength-s.offset),r+=1;break;case"texture":if(!(s instanceof ea||s instanceof Sl||s instanceof El))throw new Error("texture");let l;if(s instanceof ea)l=s.texture;else if(s instanceof Sl)l=s;else if(s instanceof El&&s.colorAttachments[0]instanceof ea)tt.warn("Passing framebuffer in texture binding may be deprecated. Use fbo.colorAttachments[0] instead")(),l=s.colorAttachments[0].texture;else throw new Error("No texture");t.activeTexture(33984+e),t.bindTexture(l.glTarget,l.handle),e+=1;break;case"sampler":break;case"storage":case"read-only-storage":throw new Error(`binding type '${i.type}' not supported in WebGL`)}}}_applyUniforms(){for(const t of this.shaderLayout.uniforms||[]){const{name:e,location:r,type:i,textureUnit:s}=t,o=this.uniforms[e]??s;o!==void 0&&lN(this.device.gl,r,i,o)}}}function pN(n,t){const e={...n,attributes:n.attributes.map(r=>({...r}))};for(const r of t?.attributes||[]){const i=e.attributes.find(s=>s.name===r.name);i?(i.type=r.type||i.type,i.stepMode=r.stepMode||i.stepMode):tt.warn(`shader layout attribute ${r.name} not present in shader`)}return e}class gN extends Cp{device;commands=[];constructor(t){super(t,{}),this.device=t}submitCommands(t=this.commands){for(const e of t)switch(e.name){case"copy-buffer-to-buffer":mN(this.device,e.options);break;case"copy-buffer-to-texture":_N(this.device,e.options);break;case"copy-texture-to-buffer":yN(this.device,e.options);break;case"copy-texture-to-texture":vN(this.device,e.options);break;default:throw new Error(e.name)}}}function mN(n,t){const e=t.sourceBuffer,r=t.destinationBuffer;n.gl.bindBuffer(36662,e.handle),n.gl.bindBuffer(36663,r.handle),n.gl.copyBufferSubData(36662,36663,t.sourceOffset??0,t.destinationOffset??0,t.size),n.gl.bindBuffer(36662,null),n.gl.bindBuffer(36663,null)}function _N(n,t){throw new Error("Not implemented")}function yN(n,t){const{sourceTexture:e,mipLevel:r=0,aspect:i="all",width:s=t.sourceTexture.width,height:o=t.sourceTexture.height,depthOrArrayLayers:a=0,origin:l=[0,0],destinationBuffer:c,byteOffset:u=0,bytesPerRow:h,rowsPerImage:f}=t;if(i!=="all")throw new Error("aspect not supported in WebGL");if(r!==0||a!==0||h||f)throw new Error("not implemented");const{framebuffer:d,destroyFramebuffer:p}=px(e);let _;try{const v=c,E=s||d.width,m=o||d.height,g=sx(d.colorAttachments[0].texture.props.format),y=g.format,b=g.type;n.gl.bindBuffer(35051,v.handle),_=n.gl.bindFramebuffer(36160,d.handle),n.gl.readPixels(l[0],l[1],E,m,y,b,u)}finally{n.gl.bindBuffer(35051,null),_!==void 0&&n.gl.bindFramebuffer(36160,_),p&&d.destroy()}}function vN(n,t){const{sourceTexture:e,destinationMipLevel:r=0,origin:i=[0,0],destinationOrigin:s=[0,0],destinationTexture:o}=t;let{width:a=t.destinationTexture.width,height:l=t.destinationTexture.height}=t;const{framebuffer:c,destroyFramebuffer:u}=px(e),[h,f]=i,[d,p,_]=s,v=n.gl.bindFramebuffer(36160,c.handle);let E=null,m;if(o instanceof Sl)E=o,a=Number.isFinite(a)?a:E.width,l=Number.isFinite(l)?l:E.height,E.bind(0),m=E.glTarget;else throw new Error("invalid destination");switch(m){case 3553:case 34067:n.gl.copyTexSubImage2D(m,r,d,p,h,f,a,l);break;case 35866:case 32879:n.gl.copyTexSubImage3D(m,r,d,p,_,h,f,a,l);break}E&&E.unbind(),n.gl.bindFramebuffer(36160,v),u&&c.destroy()}function px(n){if(n instanceof jt){const{width:t,height:e,id:r}=n;return{framebuffer:n.device.createFramebuffer({id:`framebuffer-for-${r}`,width:t,height:e,colorAttachments:[n]}),destroyFramebuffer:!0}}return{framebuffer:n,destroyFramebuffer:!1}}class bN extends Sp{device;commandBuffer;constructor(t,e){super(t,e),this.device=t,this.commandBuffer=new gN(t)}destroy(){}finish(){this.commandBuffer.submitCommands()}copyBufferToBuffer(t){this.commandBuffer.commands.push({name:"copy-buffer-to-buffer",options:t})}copyBufferToTexture(t){this.commandBuffer.commands.push({name:"copy-buffer-to-texture",options:t})}copyTextureToBuffer(t){this.commandBuffer.commands.push({name:"copy-texture-to-buffer",options:t})}copyTextureToTexture(t){this.commandBuffer.commands.push({name:"copy-texture-to-texture",options:t})}pushDebugGroup(t){}popDebugGroup(){}insertDebugMarker(t){}resolveQuerySet(t,e,r){}}function xN(n){const{target:t,source:e,start:r=0,count:i=1}=n,s=e.length,o=i*s;let a=0;for(let l=r;a<s;a++)t[l++]=e[a];for(;a<o;)a<o-a?(t.copyWithin(r+a,r,r+a),a*=2):(t.copyWithin(r+a,r,r+o-a),a=o);return n.target}class Zp extends Tp{get[Symbol.toStringTag](){return"VertexArray"}device;handle;buffer=null;bufferValue=null;static isConstantAttributeZeroSupported(t){return L1()==="Chrome"}constructor(t,e){super(t,e),this.device=t,this.handle=this.device.gl.createVertexArray()}destroy(){super.destroy(),this.buffer&&this.buffer?.destroy(),this.handle&&(this.device.gl.deleteVertexArray(this.handle),this.handle=void 0)}setIndexBuffer(t){const e=t;if(e&&e.glTarget!==34963)throw new Error("Use .setBuffer()");this.device.gl.bindVertexArray(this.handle),this.device.gl.bindBuffer(34963,e?e.handle:null),this.indexBuffer=e,this.device.gl.bindVertexArray(null)}setBuffer(t,e){const r=e;if(r.glTarget===34963)throw new Error("Use .setIndexBuffer()");const{size:i,type:s,stride:o,offset:a,normalized:l,integer:c,divisor:u}=this._getAccessor(t);this.device.gl.bindVertexArray(this.handle),this.device.gl.bindBuffer(34962,r.handle),c?this.device.gl.vertexAttribIPointer(t,i,s,o,a):this.device.gl.vertexAttribPointer(t,i,s,l,o,a),this.device.gl.bindBuffer(34962,null),this.device.gl.enableVertexAttribArray(t),this.device.gl.vertexAttribDivisor(t,u||0),this.attributes[t]=r,this.device.gl.bindVertexArray(null)}setConstantWebGL(t,e){this._enable(t,!1),this.attributes[t]=e}bindBeforeRender(){this.device.gl.bindVertexArray(this.handle),this._applyConstantAttributes()}unbindAfterRender(){this.device.gl.bindVertexArray(null)}_applyConstantAttributes(){for(let t=0;t<this.maxVertexAttributes;++t){const e=this.attributes[t];ArrayBuffer.isView(e)&&this.device.setConstantAttributeWebGL(t,e)}}_getAccessor(t){const e=this.attributeInfos[t];if(!e)throw new Error(`Unknown attribute location ${t}`);const r=ix(e.bufferDataType);return{size:e.bufferComponents,type:r,stride:e.byteStride,offset:e.byteOffset,normalized:e.normalized,integer:e.integer,divisor:e.stepMode==="instance"?1:0}}_enable(t,e=!0){const i=Zp.isConstantAttributeZeroSupported(this.device)||t!==0;(e||i)&&(t=Number(t),this.device.gl.bindVertexArray(this.handle),e?this.device.gl.enableVertexAttribArray(t):this.device.gl.disableVertexAttribArray(t),this.device.gl.bindVertexArray(null))}getConstantBuffer(t,e){const r=EN(e),i=r.byteLength*t,s=r.length*t;if(this.buffer&&i!==this.buffer.byteLength)throw new Error(`Buffer size is immutable, byte length ${i} !== ${this.buffer.byteLength}.`);let o=!this.buffer;if(this.buffer=this.buffer||this.device.createBuffer({byteLength:i}),o=o||!wN(r,this.bufferValue),o){const a=xP(e.constructor,s);xN({target:a,source:r,start:0,count:s}),this.buffer.write(a),this.bufferValue=e}return this.buffer}}function EN(n){return Array.isArray(n)?new Float32Array(n):n}function wN(n,t){if(!n||!t||n.length!==t.length||n.constructor!==t.constructor)return!1;for(let e=0;e<n.length;++e)if(n[e]!==t[e])return!1;return!0}class SN extends Pp{device;gl;handle;layout;buffers={};unusedBuffers={};bindOnUse=!0;_bound=!1;constructor(t,e){super(t,e),this.device=t,this.gl=t.gl,this.handle=this.props.handle||this.gl.createTransformFeedback(),this.layout=this.props.layout,e.buffers&&this.setBuffers(e.buffers),Object.seal(this)}destroy(){this.gl.deleteTransformFeedback(this.handle),super.destroy()}begin(t="point-list"){this.gl.bindTransformFeedback(36386,this.handle),this.bindOnUse&&this._bindBuffers(),this.gl.beginTransformFeedback(fN(t))}end(){this.gl.endTransformFeedback(),this.bindOnUse&&this._unbindBuffers(),this.gl.bindTransformFeedback(36386,null)}setBuffers(t){this.buffers={},this.unusedBuffers={},this.bind(()=>{for(const e in t)this.setBuffer(e,t[e])})}setBuffer(t,e){const r=this._getVaryingIndex(t),{buffer:i,byteLength:s,byteOffset:o}=this._getBufferRange(e);if(r<0){this.unusedBuffers[t]=i,tt.warn(`${this.id} unusedBuffers varying buffer ${t}`)();return}this.buffers[r]={buffer:i,byteLength:s,byteOffset:o},this.bindOnUse||this._bindBuffer(r,i,o,s)}getBuffer(t){if(N_(t))return this.buffers[t]||null;const e=this._getVaryingIndex(t);return e>=0?this.buffers[e]:null}bind(t=this.handle){if(typeof t!="function")return this.gl.bindTransformFeedback(36386,t),this;let e;return this._bound?e=t():(this.gl.bindTransformFeedback(36386,this.handle),this._bound=!0,e=t(),this._bound=!1,this.gl.bindTransformFeedback(36386,null)),e}unbind(){this.bind(null)}_getBufferRange(t){if(t instanceof wl)return{buffer:t,byteOffset:0,byteLength:t.byteLength};const{buffer:e,byteOffset:r=0,byteLength:i=t.buffer.byteLength}=t;return{buffer:e,byteOffset:r,byteLength:i}}_getVaryingIndex(t){if(N_(t))return Number(t);for(const e of this.layout.varyings)if(t===e.name)return e.location;return-1}_bindBuffers(){for(const t in this.buffers){const{buffer:e,byteLength:r,byteOffset:i}=this._getBufferRange(this.buffers[t]);this._bindBuffer(Number(t),e,i,r)}}_unbindBuffers(){for(const t in this.buffers)this.gl.bindBufferBase(35982,Number(t),null)}_bindBuffer(t,e,r=0,i){const s=e&&e.handle;!s||i===void 0?this.gl.bindBufferBase(35982,t,s):this.gl.bindBufferRange(35982,t,s,r,i)}}function N_(n){return typeof n=="number"?Number.isInteger(n):/^\d+$/.test(n)}class CN extends Ip{device;handle;target=null;_queryPending=!1;_pollingPromise=null;get[Symbol.toStringTag](){return"Query"}constructor(t,e){if(super(t,e),this.device=t,e.count>1)throw new Error("WebGL QuerySet can only have one value");this.handle=this.device.gl.createQuery(),Object.seal(this)}destroy(){this.device.gl.deleteQuery(this.handle)}beginTimestampQuery(){return this._begin(35007)}endTimestampQuery(){this._end()}beginOcclusionQuery(t){return this._begin(t?.conservative?36202:35887)}endOcclusionQuery(){this._end()}beginTransformFeedbackQuery(){return this._begin(35976)}endTransformFeedbackQuery(){this._end()}async resolveQuery(){return[await this.pollQuery()]}_begin(t){this._queryPending||(this.target=t,this.device.gl.beginQuery(this.target,this.handle))}_end(){this._queryPending||this.target&&(this.device.gl.endQuery(this.target),this.target=null,this._queryPending=!0)}isResultAvailable(){if(!this._queryPending)return!1;const t=this.device.gl.getQueryParameter(this.handle,34919);return t&&(this._queryPending=!1),t}isTimerDisjoint(){return this.device.gl.getParameter(36795)}getResult(){return this.device.gl.getQueryParameter(this.handle,34918)}getTimerMilliseconds(){return this.getResult()/1e6}pollQuery(t=Number.POSITIVE_INFINITY){if(this._pollingPromise)return this._pollingPromise;let e=0;return this._pollingPromise=new Promise((r,i)=>{const s=()=>{this.isResultAvailable()?(r(this.getResult()),this._pollingPromise=null):e++>t?(i("Timed out"),this._pollingPromise=null):requestAnimationFrame(s)};requestAnimationFrame(s)}),this._pollingPromise}}class ys extends Es{type="webgl";handle;features;limits;info;canvasContext;lost;_resolveContextLost;gl;debug=!1;_canvasSizeInfo={clientWidth:0,clientHeight:0,devicePixelRatio:1};_extensions={};_polyfilled=!1;spectorJS;constructor(t){super({...t,id:t.id||PR("webgl-device")});const e=Es._getCanvasContextProps(t);if(!e)throw new Error("WebGLDevice requires props.createCanvasContext to be set");let r=e.canvas?.gl?.device;if(r)throw new Error(`WebGL context already attached to device ${r.id}`);this.canvasContext=new mR(this,e),this.lost=new Promise(u=>{this._resolveContextLost=u});const i={...t.webgl};e.alphaMode==="premultiplied"&&(i.premultipliedAlpha=!0),t.powerPreference!==void 0&&(i.powerPreference=t.powerPreference);const o=this.props._handle||KM(this.canvasContext.canvas,{onContextLost:u=>this._resolveContextLost?.({reason:"destroyed",message:"Entered sleep mode, or too many apps or browser tabs are using the GPU."}),onContextRestored:u=>console.log("WebGL context restored")},i);if(!o)throw new Error("WebGL context creation failed");if(r=o.device,r){if(t._reuseDevices)return tt.log(1,`Not creating a new Device, instead returning a reference to Device ${r.id} already attached to WebGL context`,r)(),r._reused=!0,r;throw new Error(`WebGL context already attached to device ${r.id}`)}this.handle=o,this.gl=o,this.spectorJS=vR({...this.props,gl:this.handle}),this.gl.device=this,this.gl._version=2,this.info=ZM(this.gl,this._extensions),this.limits=new dR(this.gl),this.features=new fR(this.gl,this._extensions,this.props._disabledFeatures),this.props._initializeFeatures&&this.features.initializeFeatures(),e.autoResize!==!1&&this.canvasContext.resize(),new no(this.gl,{log:(...u)=>tt.log(1,...u)()}).trackState(this.gl,{copyState:!1});const l=t.debugWebGL||t.debug,c=t.debugWebGL;l&&(this.gl=ER(this.gl,{debugWebGL:l,traceWebGL:c}),tt.warn("WebGL debug mode activated. Performance reduced.")(),t.debugWebGL&&(tt.level=Math.max(tt.level,1)))}destroy(){!this.props._reuseDevices&&!this._reused&&delete this.gl.device}get isLost(){return this.gl.isContextLost()}createCanvasContext(t){throw new Error("WebGL only supports a single canvas")}createBuffer(t){const e=this._normalizeBufferProps(t);return new wl(this,e)}createTexture(t){return new Sl(this,t)}createExternalTexture(t){throw new Error("createExternalTexture() not implemented")}createSampler(t){return new Od(this,t)}createShader(t){return new RR(this,t)}createFramebuffer(t){return new El(this,t)}createVertexArray(t){return new Zp(this,t)}createTransformFeedback(t){return new SN(this,t)}createQuerySet(t){return new CN(this,t)}createRenderPipeline(t){return new dN(this,t)}beginRenderPass(t){return new KR(this,t)}createComputePipeline(t){throw new Error("ComputePipeline not supported in WebGL")}beginComputePass(t){throw new Error("ComputePass not supported in WebGL")}renderPass=null;createCommandEncoder(t={}){return new bN(this,t)}submit(){this.renderPass?.end(),this.renderPass=null}readPixelsToArrayWebGL(t,e){return $R(t,e)}readPixelsToBufferWebGL(t,e){return XR(t,e)}setParametersWebGL(t){ja(this.gl,t)}getParametersWebGL(t){return nx(this.gl,t)}withParametersWebGL(t,e){return ju(this.gl,t,e)}resetWebGL(){tt.warn("WebGLDevice.resetWebGL is deprecated, use only for debugging")(),$M(this.gl)}_getDeviceSpecificTextureFormatCapabilities(t){return lR(this.gl,t,this._extensions)}loseDevice(){let t=!1;const r=this.getExtension("WEBGL_lose_context").WEBGL_lose_context;return r&&(t=!0,r.loseContext()),this._resolveContextLost?.({reason:"destroyed",message:"Application triggered context loss"}),t}pushState(){no.get(this.gl).push()}popState(){no.get(this.gl).pop()}setSpectorMetadata(t,e){t.__SPECTOR_Metadata=e}getGLKey(t,e){const r=Number(t);for(const i in this.gl)if(this.gl[i]===r)return`GL.${i}`;return e?.emptyIfUnknown?"":String(t)}getGLKeys(t){const e={emptyIfUnknown:!0};return Object.entries(t).reduce((r,[i,s])=>(r[`${i}:${this.getGLKey(i,e)}`]=`${s}:${this.getGLKey(s,e)}`,r),{})}_constants;setConstantAttributeWebGL(t,e){const r=this.limits.maxVertexAttributes;this._constants=this._constants||new Array(r).fill(null);const i=this._constants[t];switch(i&&AN(i,e)&&tt.info(1,`setConstantAttributeWebGL(${t}) could have been skipped, value unchanged`)(),this._constants[t]=e,e.constructor){case Float32Array:TN(this,t,e);break;case Int32Array:PN(this,t,e);break;case Uint32Array:IN(this,t,e);break;default:throw new Error("constant")}}getExtension(t){return ma(this.gl,t,this._extensions),this._extensions}}function TN(n,t,e){switch(e.length){case 1:n.gl.vertexAttrib1fv(t,e);break;case 2:n.gl.vertexAttrib2fv(t,e);break;case 3:n.gl.vertexAttrib3fv(t,e);break;case 4:n.gl.vertexAttrib4fv(t,e);break}}function PN(n,t,e){n.gl.vertexAttribI4iv(t,e)}function IN(n,t,e){n.gl.vertexAttribI4uiv(t,e)}function AN(n,t){if(!n||!t||n.length!==t.length||n.constructor!==t.constructor)return!1;for(let e=0;e<n.length;++e)if(n[e]!==t[e])return!1;return!0}const MN={WEBGL_depth_texture:{UNSIGNED_INT_24_8_WEBGL:34042},OES_element_index_uint:{},OES_texture_float:{},OES_texture_half_float:{HALF_FLOAT_OES:5131},EXT_color_buffer_float:{},OES_standard_derivatives:{FRAGMENT_SHADER_DERIVATIVE_HINT_OES:35723},EXT_frag_depth:{},EXT_blend_minmax:{MIN_EXT:32775,MAX_EXT:32776},EXT_shader_texture_lod:{}},RN=n=>({drawBuffersWEBGL(t){return n.drawBuffers(t)},COLOR_ATTACHMENT0_WEBGL:36064,COLOR_ATTACHMENT1_WEBGL:36065,COLOR_ATTACHMENT2_WEBGL:36066,COLOR_ATTACHMENT3_WEBGL:36067}),NN=n=>({VERTEX_ARRAY_BINDING_OES:34229,createVertexArrayOES(){return n.createVertexArray()},deleteVertexArrayOES(t){return n.deleteVertexArray(t)},isVertexArrayOES(t){return n.isVertexArray(t)},bindVertexArrayOES(t){return n.bindVertexArray(t)}}),ON=n=>({VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE:35070,drawArraysInstancedANGLE(...t){return n.drawArraysInstanced(...t)},drawElementsInstancedANGLE(...t){return n.drawElementsInstanced(...t)},vertexAttribDivisorANGLE(...t){return n.vertexAttribDivisor(...t)}});function DN(n=!0){const t=HTMLCanvasElement.prototype;if(!n&&t.originalGetContext){t.getContext=t.originalGetContext,t.originalGetContext=void 0;return}t.originalGetContext=t.getContext,t.getContext=function(e,r){if(e==="webgl"||e==="experimental-webgl"){const i=this.originalGetContext("webgl2",r);return i instanceof HTMLElement&&LN(i),i}return this.originalGetContext(e,r)}}function LN(n){n.getExtension("EXT_color_buffer_float");const t={...MN,WEBGL_disjoint_timer_query:n.getExtension("EXT_disjoint_timer_query_webgl2"),WEBGL_draw_buffers:RN(n),OES_vertex_array_object:NN(n),ANGLE_instanced_arrays:ON(n)},e=n.getExtension;n.getExtension=function(i){const s=e.call(n,i);return s||(i in t?t[i]:null)};const r=n.getSupportedExtensions;n.getSupportedExtensions=function(){return(r.apply(n)||[])?.concat(Object.keys(t))}}const kc=1;class kN extends ZT{type="webgl";constructor(){super(),Es.defaultProps={...Es.defaultProps,...Kp},ys.adapter=this}isSupported(){return typeof WebGL2RenderingContext<"u"}enforceWebGL2(t){DN(t)}async attach(t){if(t instanceof ys)return t;if(t?.device instanceof Es)return t.device;if(!FN(t))throw new Error("Invalid WebGL2RenderingContext");return new ys({_handle:t,createCanvasContext:{canvas:t.canvas,autoResize:!1}})}async create(t={}){tt.groupCollapsed(kc,"WebGLDevice created")();const e=[];(t.debugWebGL||t.debug)&&e.push(xR()),t.debugSpectorJS&&e.push(yR(t));const r=await Promise.allSettled(e);for(const o of r)o.status==="rejected"&&tt.error(`Failed to initialize debug libraries ${o.reason}`)();const i=new ys(t),s=`${i._reused?"Reusing":"Created"} device with WebGL2 ${i.debug?"debug ":""}context: ${i.info.vendor}, ${i.info.renderer} for canvas: ${i.canvasContext.id}`;return tt.probe(kc,s)(),tt.table(kc,i.info)(),tt.groupEnd(kc)(),i}}function FN(n){return typeof WebGL2RenderingContext<"u"&&n instanceof WebGL2RenderingContext?!0:!!(n&&Number.isFinite(n._version))}const O_=new kN;function ls(){}const BN=({isDragging:n})=>n?"grabbing":"grab",gx={id:"",width:"100%",height:"100%",style:null,viewState:null,initialViewState:null,pickingRadius:0,layerFilter:null,parameters:{},parent:null,device:null,deviceProps:{},gl:null,canvas:null,layers:[],effects:[],views:null,controller:null,useDevicePixels:!0,touchAction:"none",eventRecognizerOptions:{},_framebuffer:null,_animate:!1,_pickable:!0,_typedArrayManagerProps:{},_customRender:null,widgets:[],onDeviceInitialized:ls,onWebGLInitialized:ls,onResize:ls,onViewStateChange:ls,onInteractionStateChange:ls,onBeforeRender:ls,onAfterRender:ls,onLoad:ls,onError:n=>It.error(n.message,n.cause)(),onHover:null,onClick:null,onDragStart:null,onDrag:null,onDragEnd:null,_onMetrics:null,getCursor:BN,getTooltip:null,debug:!1,drawPickingColors:!1};class Jp{constructor(t){this.width=0,this.height=0,this.userData={},this.device=null,this.canvas=null,this.viewManager=null,this.layerManager=null,this.effectManager=null,this.deckRenderer=null,this.deckPicker=null,this.eventManager=null,this.widgetManager=null,this.tooltip=null,this.animationLoop=null,this.cursorState={isHovering:!1,isDragging:!1},this.stats=new yh({id:"deck.gl"}),this.metrics={fps:0,setPropsTime:0,updateAttributesTime:0,framesRedrawn:0,pickTime:0,pickCount:0,gpuTime:0,gpuTimePerFrame:0,cpuTime:0,cpuTimePerFrame:0,bufferMemory:0,textureMemory:0,renderbufferMemory:0,gpuMemory:0},this._metricsCounter=0,this._needsRedraw="Initial render",this._pickRequest={mode:"hover",x:-1,y:-1,radius:0,event:null},this._lastPointerDownInfo=null,this._onPointerMove=r=>{const{_pickRequest:i}=this;if(r.type==="pointerleave")i.x=-1,i.y=-1,i.radius=0;else{if(r.leftButton||r.rightButton)return;{const s=r.offsetCenter;if(!s)return;i.x=s.x,i.y=s.y,i.radius=this.props.pickingRadius}}this.layerManager&&(this.layerManager.context.mousePosition={x:i.x,y:i.y}),i.event=r},this._onEvent=r=>{const i=wd[r.type],s=r.offsetCenter;if(!i||!s||!this.layerManager)return;const o=this.layerManager.getLayers(),a=this.deckPicker.getLastPickedObject({x:s.x,y:s.y,layers:o,viewports:this.getViewports(s)},this._lastPointerDownInfo),{layer:l}=a,c=l&&(l[i]||l.props[i]),u=this.props[i];let h=!1;c&&(h=c.call(l,a,r)),h||(u?.(a,r),this.widgetManager.onEvent(a,r))},this._onPointerDown=r=>{if(this.device?.type==="webgpu")return;const i=r.offsetCenter,s=this._pick("pickObject","pickObject Time",{x:i.x,y:i.y,radius:this.props.pickingRadius});this._lastPointerDownInfo=s.result[0]||s.emptyInfo},this.props={...gx,...t},t=this.props,t.viewState&&t.initialViewState&&It.warn("View state tracking is disabled. Use either `initialViewState` for auto update or `viewState` for manual update.")(),this.viewState=this.props.initialViewState,t.device&&(this.device=t.device);let e=this.device;!e&&t.gl&&(t.gl instanceof WebGLRenderingContext&&It.error("WebGL1 context not supported.")(),e=O_.attach(t.gl)),e||(e=dd.createDevice({type:"best-available",_reuseDevices:!0,adapters:[O_],...t.deviceProps,createCanvasContext:{canvas:this._createCanvas(t),useDevicePixels:this.props.useDevicePixels,autoResize:!1}})),this.animationLoop=this._createAnimationLoop(e,t),this.setProps(t),t._typedArrayManagerProps&&da.setOptions(t._typedArrayManagerProps),this.animationLoop.start()}finalize(){this.animationLoop?.stop(),this.animationLoop?.destroy(),this.animationLoop=null,this._lastPointerDownInfo=null,this.layerManager?.finalize(),this.layerManager=null,this.viewManager?.finalize(),this.viewManager=null,this.effectManager?.finalize(),this.effectManager=null,this.deckRenderer?.finalize(),this.deckRenderer=null,this.deckPicker?.finalize(),this.deckPicker=null,this.eventManager?.destroy(),this.eventManager=null,this.widgetManager?.finalize(),this.widgetManager=null,!this.props.canvas&&!this.props.device&&!this.props.gl&&this.canvas&&(this.canvas.parentElement?.removeChild(this.canvas),this.canvas=null)}setProps(t){this.stats.get("setProps Time").timeStart(),"onLayerHover"in t&&It.removed("onLayerHover","onHover")(),"onLayerClick"in t&&It.removed("onLayerClick","onClick")(),t.initialViewState&&!xr(this.props.initialViewState,t.initialViewState,3)&&(this.viewState=t.initialViewState),Object.assign(this.props,t),this._setCanvasSize(this.props);const e=Object.create(this.props);Object.assign(e,{views:this._getViews(),width:this.width,height:this.height,viewState:this._getViewState()}),this.animationLoop?.setProps(e),this.layerManager&&(this.viewManager.setProps(e),this.layerManager.activateViewport(this.getViewports()[0]),this.layerManager.setProps(e),this.effectManager.setProps(e),this.deckRenderer.setProps(e),this.deckPicker.setProps(e),this.widgetManager.setProps(e)),this.stats.get("setProps Time").timeEnd()}needsRedraw(t={clearRedrawFlags:!1}){if(!this.layerManager)return!1;if(this.props._animate)return"Deck._animate";let e=this._needsRedraw;t.clearRedrawFlags&&(this._needsRedraw=!1);const r=this.viewManager.needsRedraw(t),i=this.layerManager.needsRedraw(t),s=this.effectManager.needsRedraw(t),o=this.deckRenderer.needsRedraw(t);return e=e||r||i||s||o,e}redraw(t){if(!this.layerManager)return;let e=this.needsRedraw({clearRedrawFlags:!0});e=t||e,e&&(this.stats.get("Redraw Count").incrementCount(),this.props._customRender?this.props._customRender(e):this._drawLayers(e))}get isInitialized(){return this.viewManager!==null}getViews(){return an(this.viewManager),this.viewManager.views}getViewports(t){return an(this.viewManager),this.viewManager.getViewports(t)}getCanvas(){return this.canvas}pickObject(t){const e=this._pick("pickObject","pickObject Time",t).result;return e.length?e[0]:null}pickMultipleObjects(t){return t.depth=t.depth||10,this._pick("pickObject","pickMultipleObjects Time",t).result}pickObjects(t){return this._pick("pickObjects","pickObjects Time",t)}_addResources(t,e=!1){for(const r in t)this.layerManager.resourceManager.add({resourceId:r,data:t[r],forceUpdate:e})}_removeResources(t){for(const e of t)this.layerManager.resourceManager.remove(e)}_addDefaultEffect(t){this.effectManager.addDefaultEffect(t)}_addDefaultShaderModule(t){this.layerManager.addDefaultShaderModule(t)}_removeDefaultShaderModule(t){this.layerManager?.removeDefaultShaderModule(t)}_pick(t,e,r){an(this.deckPicker);const{stats:i}=this;i.get("Pick Count").incrementCount(),i.get(e).timeStart();const s=this.deckPicker[t]({layers:this.layerManager.getLayers(r),views:this.viewManager.getViews(),viewports:this.getViewports(r),onViewportActive:this.layerManager.activateViewport,effects:this.effectManager.getEffects(),...r});return i.get(e).timeEnd(),s}_createCanvas(t){let e=t.canvas;return typeof e=="string"&&(e=document.getElementById(e),an(e)),e||(e=document.createElement("canvas"),e.id=t.id||"deckgl-overlay",(t.parent||document.body).appendChild(e)),Object.assign(e.style,t.style),e}_setCanvasSize(t){if(!this.canvas)return;const{width:e,height:r}=t;if(e||e===0){const i=Number.isFinite(e)?`${e}px`:e;this.canvas.style.width=i}if(r||r===0){const i=Number.isFinite(r)?`${r}px`:r;this.canvas.style.position=t.style?.position||"absolute",this.canvas.style.height=i}}_updateCanvasSize(){const{canvas:t}=this;if(!t)return;const e=t.clientWidth??t.width,r=t.clientHeight??t.height;(e!==this.width||r!==this.height)&&(this.width=e,this.height=r,this.viewManager?.setProps({width:e,height:r}),this.layerManager?.activateViewport(this.getViewports()[0]),this.props.onResize({width:e,height:r}))}_createAnimationLoop(t,e){const{gl:r,onError:i,useDevicePixels:s}=e;return new V3({device:t,useDevicePixels:s,autoResizeDrawingBuffer:!r,autoResizeViewport:!1,onInitialize:o=>this._setDevice(o.device),onRender:this._onRenderFrame.bind(this),onError:i})}_getViewState(){return this.props.viewState||this.viewState}_getViews(){const{views:t}=this.props,e=Array.isArray(t)?t:t?[t]:[new Xp({id:"default-view"})];return e.length&&this.props.controller&&(e[0].props.controller=this.props.controller),e}_onContextLost(){const{onError:t}=this.props;this.animationLoop&&t&&t(new Error("WebGL context is lost"))}_pickAndCallback(){if(this.device?.type==="webgpu")return;const{_pickRequest:t}=this;if(t.event){const{result:e,emptyInfo:r}=this._pick("pickObject","pickObject Time",t);this.cursorState.isHovering=e.length>0;let i=r,s=!1;for(const o of e)i=o,s=o.layer?.onHover(o,t.event)||s;s||(this.props.onHover?.(i,t.event),this.widgetManager.onHover(i,t.event)),t.event=null}}_updateCursor(){const t=this.props.parent||this.canvas;t&&(t.style.cursor=this.props.getCursor(this.cursorState))}_setDevice(t){if(this.device=t,!this.animationLoop)return;this.canvas||(this.canvas=this.device.canvasContext?.canvas),this.device.type==="webgl"&&this.device.setParametersWebGL({blend:!0,blendFunc:[770,771,1,771],polygonOffsetFill:!0,depthTest:!0,depthFunc:515}),this.props.onDeviceInitialized(this.device),this.device.type==="webgl"&&this.props.onWebGLInitialized(this.device.gl);const e=new Gb;e.play(),this.animationLoop.attachTimeline(e),this.eventManager=new m2(this.props.parent||this.canvas,{touchAction:this.props.touchAction,recognizers:Object.keys(Qm).map(i=>{const[s,o,a,l]=Qm[i],c=this.props.eventRecognizerOptions?.[i],u={...o,...c,event:i};return{recognizer:new s(u),recognizeWith:a,requestFailure:l}}),events:{pointerdown:this._onPointerDown,pointermove:this._onPointerMove,pointerleave:this._onPointerMove}});for(const i in wd)this.eventManager.on(i,this._onEvent);this.viewManager=new uM({timeline:e,eventManager:this.eventManager,onViewStateChange:this._onViewStateChange.bind(this),onInteractionStateChange:this._onInteractionStateChange.bind(this),views:this._getViews(),viewState:this._getViewState(),width:this.width,height:this.height});const r=this.viewManager.getViewports()[0];this.layerManager=new cM(this.device,{deck:this,stats:this.stats,viewport:r,timeline:e}),this.effectManager=new PM({deck:this,device:this.device}),this.deckRenderer=new MM(this.device),this.deckPicker=new kM(this.device),this.widgetManager=new UM({deck:this,parentElement:this.canvas?.parentElement}),this.widgetManager.addDefault(new zM),this.setProps(this.props),this._updateCanvasSize(),this.props.onLoad()}_drawLayers(t,e){const{device:r,gl:i}=this.layerManager.context;this.props.onBeforeRender({device:r,gl:i});const s={target:this.props._framebuffer,layers:this.layerManager.getLayers(),viewports:this.viewManager.getViewports(),onViewportActive:this.layerManager.activateViewport,views:this.viewManager.getViews(),pass:"screen",effects:this.effectManager.getEffects(),...e};this.deckRenderer?.renderLayers(s),s.pass==="screen"&&this.widgetManager.onRedraw({viewports:s.viewports,layers:s.layers}),this.props.onAfterRender({device:r,gl:i})}_onRenderFrame(){this._getFrameStats(),this._metricsCounter++%60===0&&(this._getMetrics(),this.stats.reset(),It.table(4,this.metrics)(),this.props._onMetrics&&this.props._onMetrics(this.metrics)),this._updateCanvasSize(),this._updateCursor(),this.layerManager.updateLayers(),this.device?.type!=="webgpu"&&this._pickAndCallback(),this.redraw(),this.viewManager&&this.viewManager.updateViewStates()}_onViewStateChange(t){const e=this.props.onViewStateChange(t)||t.viewState;this.viewState&&(this.viewState={...this.viewState,[t.viewId]:e},this.props.viewState||this.viewManager&&this.viewManager.setProps({viewState:this.viewState}))}_onInteractionStateChange(t){this.cursorState.isDragging=t.isDragging||!1,this.props.onInteractionStateChange(t)}_getFrameStats(){const{stats:t}=this;t.get("frameRate").timeEnd(),t.get("frameRate").timeStart();const e=this.animationLoop.stats;t.get("GPU Time").addTime(e.get("GPU Time").lastTiming),t.get("CPU Time").addTime(e.get("CPU Time").lastTiming)}_getMetrics(){const{metrics:t,stats:e}=this;t.fps=e.get("frameRate").getHz(),t.setPropsTime=e.get("setProps Time").time,t.updateAttributesTime=e.get("Update Attributes").time,t.framesRedrawn=e.get("Redraw Count").count,t.pickTime=e.get("pickObject Time").time+e.get("pickMultipleObjects Time").time+e.get("pickObjects Time").time,t.pickCount=e.get("Pick Count").count,t.gpuTime=e.get("GPU Time").time,t.cpuTime=e.get("CPU Time").time,t.gpuTimePerFrame=e.get("GPU Time").getAverageTime(),t.cpuTimePerFrame=e.get("CPU Time").getAverageTime();const r=dd.stats.get("Memory Usage");t.bufferMemory=r.get("Buffer Memory").count,t.textureMemory=r.get("Texture Memory").count,t.renderbufferMemory=r.get("Renderbuffer Memory").count,t.gpuMemory=r.get("GPU Memory").count}}Jp.defaultProps=gx;Jp.VERSION=nT;function UN(n){switch(n){case"float64":return Float64Array;case"uint8":case"unorm8":return Uint8ClampedArray;default:return $0(n)}}const VN=j0;function Fc(n,t,e){const r=e==="webgpu"&&t.type==="uint8"?"unorm8":t.type;return{attribute:n,format:t.size>1?`${r}x${t.size}`:t.type,byteOffset:t.offset||0}}function Qs(n){return n.stride||n.size*n.bytesPerElement}function zN(n,t){return n.type===t.type&&n.size===t.size&&Qs(n)===Qs(t)&&(n.offset||0)===(t.offset||0)}function Dd(n,t){t.offset&&It.removed("shaderAttribute.offset","vertexOffset, elementOffset")();const e=Qs(n),r=t.vertexOffset!==void 0?t.vertexOffset:n.vertexOffset||0,i=t.elementOffset||0,s=r*e+i*n.bytesPerElement+(n.offset||0);return{...t,offset:s,stride:e}}function WN(n,t){const e=Dd(n,t);return{high:e,low:{...e,offset:e.offset+n.size*4}}}class HN{constructor(t,e,r){this._buffer=null,this.device=t,this.id=e.id||"",this.size=e.size||1;const i=e.logicalType||e.type,s=i==="float64";let{defaultValue:o}=e;o=Number.isFinite(o)?[o]:o||new Array(this.size).fill(0);let a;s?a="float32":!i&&e.isIndexed?a="uint32":a=i||"float32";let l=UN(i||a);this.doublePrecision=s,s&&e.fp64===!1&&(l=Float32Array),this.value=null,this.settings={...e,defaultType:l,defaultValue:o,logicalType:i,type:a,normalized:a.includes("norm"),size:this.size,bytesPerElement:l.BYTES_PER_ELEMENT},this.state={...r,externalBuffer:null,bufferAccessor:this.settings,allocatedValue:null,numInstances:0,bounds:null,constant:!1}}get isConstant(){return this.state.constant}get buffer(){return this._buffer}get byteOffset(){const t=this.getAccessor();return t.vertexOffset?t.vertexOffset*Qs(t):0}get numInstances(){return this.state.numInstances}set numInstances(t){this.state.numInstances=t}delete(){this._buffer&&(this._buffer.delete(),this._buffer=null),da.release(this.state.allocatedValue)}getBuffer(){return this.state.constant?null:this.state.externalBuffer||this._buffer}getValue(t=this.id,e=null){const r={};if(this.state.constant){const i=this.value;if(e){const s=Dd(this.getAccessor(),e),o=s.offset/i.BYTES_PER_ELEMENT,a=s.size||this.size;r[t]=i.subarray(o,o+a)}else r[t]=i}else r[t]=this.getBuffer();return this.doublePrecision&&(this.value instanceof Float64Array?r[`${t}64Low`]=r[t]:r[`${t}64Low`]=new Float32Array(this.size)),r}_getBufferLayout(t=this.id,e=null){const r=this.getAccessor(),i=[],s={name:this.id,byteStride:Qs(r),attributes:i};if(this.doublePrecision){const o=WN(r,e||{});i.push(Fc(t,{...r,...o.high},this.device.type),Fc(`${t}64Low`,{...r,...o.low},this.device.type))}else if(e){const o=Dd(r,e);i.push(Fc(t,{...r,...o},this.device.type))}else i.push(Fc(t,r,this.device.type));return s}setAccessor(t){this.state.bufferAccessor=t}getAccessor(){return this.state.bufferAccessor}getBounds(){if(this.state.bounds)return this.state.bounds;let t=null;if(this.state.constant&&this.value){const e=Array.from(this.value);t=[e,e]}else{const{value:e,numInstances:r,size:i}=this,s=r*i;if(e&&s&&e.length>=s){const o=new Array(i).fill(1/0),a=new Array(i).fill(-1/0);for(let l=0;l<s;)for(let c=0;c<i;c++){const u=e[l++];u<o[c]&&(o[c]=u),u>a[c]&&(a[c]=u)}t=[o,a]}}return this.state.bounds=t,t}setData(t){const{state:e}=this;let r;ArrayBuffer.isView(t)?r={value:t}:t instanceof Yt?r={buffer:t}:r=t;const i={...this.settings,...r};if(ArrayBuffer.isView(r.value)){if(!r.type)if(this.doublePrecision&&r.value instanceof Float64Array)i.type="float32";else{const o=VN(r.value);i.type=i.normalized?o.replace("int","norm"):o}i.bytesPerElement=r.value.BYTES_PER_ELEMENT,i.stride=Qs(i)}if(e.bounds=null,r.constant){let s=r.value;if(s=this._normalizeValue(s,[],0),this.settings.normalized&&(s=this.normalizeConstant(s)),!(!e.constant||!this._areValuesEqual(s,this.value)))return!1;e.externalBuffer=null,e.constant=!0,this.value=ArrayBuffer.isView(s)?s:new Float32Array(s)}else if(r.buffer){const s=r.buffer;e.externalBuffer=s,e.constant=!1,this.value=r.value||null}else if(r.value){this._checkExternalBuffer(r);let s=r.value;e.externalBuffer=null,e.constant=!1,this.value=s;let{buffer:o}=this;const a=Qs(i),l=(i.vertexOffset||0)*a;if(this.doublePrecision&&s instanceof Float64Array&&(s=wf(s,i)),this.settings.isIndexed){const u=this.settings.defaultType;s.constructor!==u&&(s=new u(s))}const c=s.byteLength+l+a*2;(!o||o.byteLength<c)&&(o=this._createBuffer(c)),o.write(s,l)}return this.setAccessor(i),!0}updateSubBuffer(t={}){this.state.bounds=null;const e=this.value,{startOffset:r=0,endOffset:i}=t;this.buffer.write(this.doublePrecision&&e instanceof Float64Array?wf(e,{size:this.size,startIndex:r,endIndex:i}):e.subarray(r,i),r*e.BYTES_PER_ELEMENT+this.byteOffset)}allocate(t,e=!1){const{state:r}=this,i=r.allocatedValue,s=da.allocate(i,t+1,{size:this.size,type:this.settings.defaultType,copy:e});this.value=s;const{byteOffset:o}=this;let{buffer:a}=this;return(!a||a.byteLength<s.byteLength+o)&&(a=this._createBuffer(s.byteLength+o),e&&i&&a.write(i instanceof Float64Array?wf(i,this):i,o)),r.allocatedValue=s,r.constant=!1,r.externalBuffer=null,this.setAccessor(this.settings),!0}_checkExternalBuffer(t){const{value:e}=t;if(!ArrayBuffer.isView(e))throw new Error(`Attribute ${this.id} value is not TypedArray`);const r=this.settings.defaultType;let i=!1;if(this.doublePrecision&&(i=e.BYTES_PER_ELEMENT<4),i)throw new Error(`Attribute ${this.id} does not support ${e.constructor.name}`);!(e instanceof r)&&this.settings.normalized&&!("normalized"in t)&&It.warn(`Attribute ${this.id} is normalized`)()}normalizeConstant(t){switch(this.settings.type){case"snorm8":return new Float32Array(t).map(e=>(e+128)/255*2-1);case"snorm16":return new Float32Array(t).map(e=>(e+32768)/65535*2-1);case"unorm8":return new Float32Array(t).map(e=>e/255);case"unorm16":return new Float32Array(t).map(e=>e/65535);default:return t}}_normalizeValue(t,e,r){const{defaultValue:i,size:s}=this.settings;if(Number.isFinite(t))return e[r]=t,e;if(!t){let o=s;for(;--o>=0;)e[r+o]=i[o];return e}switch(s){case 4:e[r+3]=Number.isFinite(t[3])?t[3]:i[3];case 3:e[r+2]=Number.isFinite(t[2])?t[2]:i[2];case 2:e[r+1]=Number.isFinite(t[1])?t[1]:i[1];case 1:e[r+0]=Number.isFinite(t[0])?t[0]:i[0];break;default:let o=s;for(;--o>=0;)e[r+o]=Number.isFinite(t[o])?t[o]:i[o]}return e}_areValuesEqual(t,e){if(!t||!e)return!1;const{size:r}=this;for(let i=0;i<r;i++)if(t[i]!==e[i])return!1;return!0}_createBuffer(t){this._buffer&&this._buffer.destroy();const{isIndexed:e,type:r}=this.settings;return this._buffer=this.device.createBuffer({...this._buffer?.props,id:this.id,usage:(e?Yt.INDEX:Yt.VERTEX)|Yt.COPY_DST,indexType:e?r:void 0,byteLength:t}),this._buffer}}const D_=[],L_=[];function Ph(n,t=0,e=1/0){let r=D_;const i={index:-1,data:n,target:[]};return n?typeof n[Symbol.iterator]=="function"?r=n:n.length>0&&(L_.length=n.length,r=L_):r=D_,(t>0||Number.isFinite(e))&&(r=(Array.isArray(r)?r:Array.from(r)).slice(t,e),i.index=t-1),{iterable:r,objectInfo:i}}function mx(n){return n&&n[Symbol.asyncIterator]}function _x(n,t){const{size:e,stride:r,offset:i,startIndices:s,nested:o}=t,a=n.BYTES_PER_ELEMENT,l=r?r/a:e,c=i?i/a:0,u=Math.floor((n.length-c)/l);return(h,{index:f,target:d})=>{if(!s){const E=f*l+c;for(let m=0;m<e;m++)d[m]=n[E+m];return d}const p=s[f],_=s[f+1]||u;let v;if(o){v=new Array(_-p);for(let E=p;E<_;E++){const m=E*l+c;d=new Array(e);for(let g=0;g<e;g++)d[g]=n[m+g];v[E-p]=d}}else if(l===e)v=n.subarray(p*e+c,_*e+c);else{v=new n.constructor((_-p)*e);let E=0;for(let m=p;m<_;m++){const g=m*l+c;for(let y=0;y<e;y++)v[E++]=n[g+y]}}return v}}const jN=[],cu=[[0,1/0]];function $N(n,t){if(n===cu||(t[0]<0&&(t[0]=0),t[0]>=t[1]))return n;const e=[],r=n.length;let i=0;for(let s=0;s<r;s++){const o=n[s];o[1]<t[0]?(e.push(o),i=s+1):o[0]>t[1]?e.push(o):t=[Math.min(o[0],t[0]),Math.max(o[1],t[1])]}return e.splice(i,0,t),e}const XN={interpolation:{duration:0,easing:n=>n},spring:{stiffness:.05,damping:.5}};function yx(n,t){if(!n)return null;Number.isFinite(n)&&(n={type:"interpolation",duration:n});const e=n.type||"interpolation";return{...XN[e],...t,...n,type:e}}class vx extends HN{constructor(t,e){super(t,e,{startIndices:null,lastExternalBuffer:null,binaryValue:null,binaryAccessor:null,needsUpdate:!0,needsRedraw:!1,layoutChanged:!1,updateRanges:cu}),this.constant=!1,this.settings.update=e.update||(e.accessor?this._autoUpdater:void 0),Object.seal(this.settings),Object.seal(this.state),this._validateAttributeUpdaters()}get startIndices(){return this.state.startIndices}set startIndices(t){this.state.startIndices=t}needsUpdate(){return this.state.needsUpdate}needsRedraw({clearChangedFlags:t=!1}={}){const e=this.state.needsRedraw;return this.state.needsRedraw=e&&!t,e}layoutChanged(){return this.state.layoutChanged}setAccessor(t){var e;(e=this.state).layoutChanged||(e.layoutChanged=!zN(t,this.getAccessor())),super.setAccessor(t)}getUpdateTriggers(){const{accessor:t}=this.settings;return[this.id].concat(typeof t!="function"&&t||[])}supportsTransition(){return!!this.settings.transition}getTransitionSetting(t){if(!t||!this.supportsTransition())return null;const{accessor:e}=this.settings,r=this.settings.transition,i=Array.isArray(e)?t[e.find(s=>t[s])]:t[e];return yx(i,r)}setNeedsUpdate(t=this.id,e){if(this.state.needsUpdate=this.state.needsUpdate||t,this.setNeedsRedraw(t),e){const{startRow:r=0,endRow:i=1/0}=e;this.state.updateRanges=$N(this.state.updateRanges,[r,i])}else this.state.updateRanges=cu}clearNeedsUpdate(){this.state.needsUpdate=!1,this.state.updateRanges=jN}setNeedsRedraw(t=this.id){this.state.needsRedraw=this.state.needsRedraw||t}allocate(t){const{state:e,settings:r}=this;return r.noAlloc?!1:r.update?(super.allocate(t,e.updateRanges!==cu),!0):!1}updateBuffer({numInstances:t,data:e,props:r,context:i}){if(!this.needsUpdate())return!1;const{state:{updateRanges:s},settings:{update:o,noAlloc:a}}=this;let l=!0;if(o){for(const[c,u]of s)o.call(i,this,{data:e,startRow:c,endRow:u,props:r,numInstances:t});if(this.value)if(this.constant||!this.buffer||this.buffer.byteLength<this.value.byteLength+this.byteOffset)this.setData({value:this.value,constant:this.constant}),this.constant=!1;else for(const[c,u]of s){const h=Number.isFinite(c)?this.getVertexOffset(c):0,f=Number.isFinite(u)?this.getVertexOffset(u):a||!Number.isFinite(t)?this.value.length:t*this.size;super.updateSubBuffer({startOffset:h,endOffset:f})}this._checkAttributeArray()}else l=!1;return this.clearNeedsUpdate(),this.setNeedsRedraw(),l}setConstantValue(t){return this.device.type==="webgpu"||t===void 0||typeof t=="function"?!1:(this.setData({constant:!0,value:t})&&this.setNeedsRedraw(),this.clearNeedsUpdate(),!0)}setExternalBuffer(t){const{state:e}=this;return t?(this.clearNeedsUpdate(),e.lastExternalBuffer===t||(e.lastExternalBuffer=t,this.setNeedsRedraw(),this.setData(t)),!0):(e.lastExternalBuffer=null,!1)}setBinaryValue(t,e=null){const{state:r,settings:i}=this;if(!t)return r.binaryValue=null,r.binaryAccessor=null,!1;if(i.noAlloc)return!1;if(r.binaryValue===t)return this.clearNeedsUpdate(),!0;if(r.binaryValue=t,this.setNeedsRedraw(),i.transform||e!==this.startIndices){ArrayBuffer.isView(t)&&(t={value:t});const o=t;an(ArrayBuffer.isView(o.value),`invalid ${i.accessor}`);const a=!!o.size&&o.size!==this.size;return r.binaryAccessor=_x(o.value,{size:o.size||this.size,stride:o.stride,offset:o.offset,startIndices:e,nested:a}),!1}return this.clearNeedsUpdate(),this.setData(t),!0}getVertexOffset(t){const{startIndices:e}=this;return(e?t<e.length?e[t]:this.numInstances:t)*this.size}getValue(){const t=this.settings.shaderAttributes,e=super.getValue();if(!t)return e;for(const r in t)Object.assign(e,super.getValue(r,t[r]));return e}getBufferLayout(t){this.state.layoutChanged=!1;const e=this.settings.shaderAttributes,r=super._getBufferLayout(),{stepMode:i}=this.settings;if(i==="dynamic"?r.stepMode=t?t.isInstanced?"instance":"vertex":"instance":r.stepMode=i??"vertex",!e)return r;for(const s in e){const o=super._getBufferLayout(s,e[s]);r.attributes.push(...o.attributes)}return r}_autoUpdater(t,{data:e,startRow:r,endRow:i,props:s,numInstances:o}){if(t.constant&&this.context.device.type!=="webgpu")return;const{settings:a,state:l,value:c,size:u,startIndices:h}=t,{accessor:f,transform:d}=a;let p=l.binaryAccessor||(typeof f=="function"?f:s[f]);typeof p!="function"&&(p=()=>p),an(typeof p=="function",`accessor "${f}" is not a function`);let _=t.getVertexOffset(r);const{iterable:v,objectInfo:E}=Ph(e,r,i);for(const m of v){E.index++;let g=p(m,E);if(d&&(g=d.call(this,g)),h){const y=(E.index<h.length-1?h[E.index+1]:o)-h[E.index];if(g&&Array.isArray(g[0])){let b=_;for(const x of g)t._normalizeValue(x,c,b),b+=u}else g&&g.length>u?c.set(g,_):(t._normalizeValue(g,E.target,0),iM({target:c,source:E.target,start:_,count:y}));_+=y*u}else t._normalizeValue(g,c,_),_+=u}}_validateAttributeUpdaters(){const{settings:t}=this;if(!(t.noAlloc||typeof t.update=="function"))throw new Error(`Attribute ${this.id} missing update or accessor`)}_checkAttributeArray(){const{value:t}=this,e=Math.min(4,this.size);if(t&&t.length>=e){let r=!0;switch(e){case 4:r=r&&Number.isFinite(t[3]);case 3:r=r&&Number.isFinite(t[2]);case 2:r=r&&Number.isFinite(t[1]);case 1:r=r&&Number.isFinite(t[0]);break;default:r=!1}if(!r)throw new Error(`Illegal attribute generated for ${this.id}`)}}}function Of(n){const{source:t,target:e,start:r=0,size:i,getData:s}=n,o=n.end||e.length,a=t.length,l=o-r;if(a>l){e.set(t.subarray(0,l),r);return}if(e.set(t,r),!s)return;let c=a;for(;c<l;){const u=s(c,t);for(let h=0;h<i;h++)e[r+c]=u[h]||0,c++}}function GN({source:n,target:t,size:e,getData:r,sourceStartIndices:i,targetStartIndices:s}){if(!i||!s)return Of({source:n,target:t,size:e,getData:r}),t;let o=0,a=0;const l=r&&((u,h)=>r(u+a,h)),c=Math.min(i.length,s.length);for(let u=1;u<c;u++){const h=i[u]*e,f=s[u]*e;Of({source:n.subarray(o,h),target:t,start:a,end:f,size:e,getData:l}),o=h,a=f}return a<t.length&&Of({source:[],target:t,start:a,size:e,getData:l}),t}function YN(n){const{device:t,settings:e,value:r}=n,i=new vx(t,e);return i.setData({value:r instanceof Float64Array?new Float64Array(0):new Float32Array(0),normalized:e.normalized}),i}function bx(n){switch(n){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error(`No defined attribute type for size "${n}"`)}}function xx(n){switch(n){case 1:return"float32";case 2:return"float32x2";case 3:return"float32x3";case 4:return"float32x4";default:throw new Error("invalid type size")}}function Ex(n){n.push(n.shift())}function qN(n,t){const{doublePrecision:e,settings:r,value:i,size:s}=n,o=e&&i instanceof Float64Array?2:1;let a=0;const{shaderAttributes:l}=n.settings;if(l)for(const c of Object.values(l))a=Math.max(a,c.vertexOffset??0);return(r.noAlloc?i.length:(t+a)*s)*o}function wx({device:n,source:t,target:e}){return(!e||e.byteLength<t.byteLength)&&(e?.destroy(),e=n.createBuffer({byteLength:t.byteLength,usage:t.usage})),e}function Sx({device:n,buffer:t,attribute:e,fromLength:r,toLength:i,fromStartIndices:s,getData:o=a=>a}){const a=e.doublePrecision&&e.value instanceof Float64Array?2:1,l=e.size*a,c=e.byteOffset,u=e.settings.bytesPerElement<4?c/e.settings.bytesPerElement*4:c,h=e.startIndices,f=s&&h,d=e.isConstant;if(!f&&t&&r>=i)return t;const p=e.value instanceof Float64Array?Float32Array:e.value.constructor,_=d?e.value:new p(e.getBuffer().readSyncWebGL(c,i*p.BYTES_PER_ELEMENT).buffer);if(e.settings.normalized&&!d){const g=o;o=(y,b)=>e.normalizeConstant(g(y,b))}const v=d?(g,y)=>o(_,y):(g,y)=>o(_.subarray(g+c,g+c+l),y),E=t?new Float32Array(t.readSyncWebGL(u,r*4).buffer):new Float32Array(0),m=new Float32Array(i);return GN({source:E,target:m,sourceStartIndices:s,targetStartIndices:h,size:l,getData:v}),(!t||t.byteLength<m.byteLength+u)&&(t?.destroy(),t=n.createBuffer({byteLength:m.byteLength+u,usage:35050})),t.write(m,u),t}class Cx{constructor({device:t,attribute:e,timeline:r}){this.buffers=[],this.currentLength=0,this.device=t,this.transition=new Th(r),this.attribute=e,this.attributeInTransition=YN(e),this.currentStartIndices=e.startIndices}get inProgress(){return this.transition.inProgress}start(t,e,r=1/0){this.settings=t,this.currentStartIndices=this.attribute.startIndices,this.currentLength=qN(this.attribute,e),this.transition.start({...t,duration:r})}update(){const t=this.transition.update();return t&&this.onUpdate(),t}setBuffer(t){this.attributeInTransition.setData({buffer:t,normalized:this.attribute.settings.normalized,value:this.attributeInTransition.value})}cancel(){this.transition.cancel()}delete(){this.cancel();for(const t of this.buffers)t.destroy();this.buffers.length=0}}class KN extends Cx{constructor({device:t,attribute:e,timeline:r}){super({device:t,attribute:e,timeline:r}),this.type="interpolation",this.transform=tO(t,e)}start(t,e){const r=this.currentLength,i=this.currentStartIndices;if(super.start(t,e,t.duration),t.duration<=0){this.transition.cancel();return}const{buffers:s,attribute:o}=this;Ex(s),s[0]=Sx({device:this.device,buffer:s[0],attribute:o,fromLength:r,toLength:this.currentLength,fromStartIndices:i,getData:t.enter}),s[1]=wx({device:this.device,source:s[0],target:s[1]}),this.setBuffer(s[1]);const{transform:a}=this,l=a.model;let c=Math.floor(this.currentLength/o.size);Tx(o)&&(c/=2),l.setVertexCount(c),o.isConstant?(l.setAttributes({aFrom:s[0]}),l.setConstantAttributes({aTo:o.value})):l.setAttributes({aFrom:s[0],aTo:o.getBuffer()}),a.transformFeedback.setBuffers({vCurrent:s[1]})}onUpdate(){const{duration:t,easing:e}=this.settings,{time:r}=this.transition;let i=r/t;e&&(i=e(i));const{model:s}=this.transform,o={time:i};s.shaderInputs.setProps({interpolation:o}),this.transform.run({discard:!0})}delete(){super.delete(),this.transform.destroy()}}const ZN=`uniform interpolationUniforms {
  float time;
} interpolation;
`,k_={name:"interpolation",vs:ZN,uniformTypes:{time:"f32"}},JN=`#version 300 es
#define SHADER_NAME interpolation-transition-vertex-shader

in ATTRIBUTE_TYPE aFrom;
in ATTRIBUTE_TYPE aTo;
out ATTRIBUTE_TYPE vCurrent;

void main(void) {
  vCurrent = mix(aFrom, aTo, interpolation.time);
  gl_Position = vec4(0.0);
}
`,QN=`#version 300 es
#define SHADER_NAME interpolation-transition-vertex-shader

in ATTRIBUTE_TYPE aFrom;
in ATTRIBUTE_TYPE aFrom64Low;
in ATTRIBUTE_TYPE aTo;
in ATTRIBUTE_TYPE aTo64Low;
out ATTRIBUTE_TYPE vCurrent;
out ATTRIBUTE_TYPE vCurrent64Low;

vec2 mix_fp64(vec2 a, vec2 b, float x) {
  vec2 range = sub_fp64(b, a);
  return sum_fp64(a, mul_fp64(range, vec2(x, 0.0)));
}

void main(void) {
  for (int i=0; i<ATTRIBUTE_SIZE; i++) {
    vec2 value = mix_fp64(vec2(aFrom[i], aFrom64Low[i]), vec2(aTo[i], aTo64Low[i]), interpolation.time);
    vCurrent[i] = value.x;
    vCurrent64Low[i] = value.y;
  }
  gl_Position = vec4(0.0);
}
`;function Tx(n){return n.doublePrecision&&n.value instanceof Float64Array}function tO(n,t){const e=t.size,r=bx(e),i=xx(e),s=t.getBufferLayout();return Tx(t)?new pa(n,{vs:QN,bufferLayout:[{name:"aFrom",byteStride:8*e,attributes:[{attribute:"aFrom",format:i,byteOffset:0},{attribute:"aFrom64Low",format:i,byteOffset:4*e}]},{name:"aTo",byteStride:8*e,attributes:[{attribute:"aTo",format:i,byteOffset:0},{attribute:"aTo64Low",format:i,byteOffset:4*e}]}],modules:[oA,k_],defines:{ATTRIBUTE_TYPE:r,ATTRIBUTE_SIZE:e},moduleSettings:{},varyings:["vCurrent","vCurrent64Low"],bufferMode:35980,disableWarnings:!0}):new pa(n,{vs:JN,bufferLayout:[{name:"aFrom",format:i},{name:"aTo",format:s.attributes[0].format}],modules:[k_],defines:{ATTRIBUTE_TYPE:r},varyings:["vCurrent"],disableWarnings:!0})}class eO extends Cx{constructor({device:t,attribute:e,timeline:r}){super({device:t,attribute:e,timeline:r}),this.type="spring",this.texture=aO(t),this.framebuffer=lO(t,this.texture),this.transform=oO(t,e)}start(t,e){const r=this.currentLength,i=this.currentStartIndices;super.start(t,e);const{buffers:s,attribute:o}=this;for(let l=0;l<2;l++)s[l]=Sx({device:this.device,buffer:s[l],attribute:o,fromLength:r,toLength:this.currentLength,fromStartIndices:i,getData:t.enter});s[2]=wx({device:this.device,source:s[0],target:s[2]}),this.setBuffer(s[1]);const{model:a}=this.transform;a.setVertexCount(Math.floor(this.currentLength/o.size)),o.isConstant?a.setConstantAttributes({aTo:o.value}):a.setAttributes({aTo:o.getBuffer()})}onUpdate(){const{buffers:t,transform:e,framebuffer:r,transition:i}=this,s=this.settings;e.model.setAttributes({aPrev:t[0],aCur:t[1]}),e.transformFeedback.setBuffers({vNext:t[2]});const o={stiffness:s.stiffness,damping:s.damping};e.model.shaderInputs.setProps({spring:o}),e.run({framebuffer:r,discard:!1,parameters:{viewport:[0,0,1,1]},clearColor:[0,0,0,0]}),Ex(t),this.setBuffer(t[1]),this.device.readPixelsToArrayWebGL(r)[0]>0||i.end()}delete(){super.delete(),this.transform.destroy(),this.texture.destroy(),this.framebuffer.destroy()}}const nO=`uniform springUniforms {
  float damping;
  float stiffness;
} spring;
`,rO={name:"spring",vs:nO,uniformTypes:{damping:"f32",stiffness:"f32"}},iO=`#version 300 es
#define SHADER_NAME spring-transition-vertex-shader

#define EPSILON 0.00001

in ATTRIBUTE_TYPE aPrev;
in ATTRIBUTE_TYPE aCur;
in ATTRIBUTE_TYPE aTo;
out ATTRIBUTE_TYPE vNext;
out float vIsTransitioningFlag;

ATTRIBUTE_TYPE getNextValue(ATTRIBUTE_TYPE cur, ATTRIBUTE_TYPE prev, ATTRIBUTE_TYPE dest) {
  ATTRIBUTE_TYPE velocity = cur - prev;
  ATTRIBUTE_TYPE delta = dest - cur;
  ATTRIBUTE_TYPE force = delta * spring.stiffness;
  ATTRIBUTE_TYPE resistance = velocity * spring.damping;
  return force - resistance + velocity + cur;
}

void main(void) {
  bool isTransitioning = length(aCur - aPrev) > EPSILON || length(aTo - aCur) > EPSILON;
  vIsTransitioningFlag = isTransitioning ? 1.0 : 0.0;

  vNext = getNextValue(aCur, aPrev, aTo);
  gl_Position = vec4(0, 0, 0, 1);
  gl_PointSize = 100.0;
}
`,sO=`#version 300 es
#define SHADER_NAME spring-transition-is-transitioning-fragment-shader

in float vIsTransitioningFlag;

out vec4 fragColor;

void main(void) {
  if (vIsTransitioningFlag == 0.0) {
    discard;
  }
  fragColor = vec4(1.0);
}`;function oO(n,t){const e=bx(t.size),r=xx(t.size);return new pa(n,{vs:iO,fs:sO,bufferLayout:[{name:"aPrev",format:r},{name:"aCur",format:r},{name:"aTo",format:t.getBufferLayout().attributes[0].format}],varyings:["vNext"],modules:[rO],defines:{ATTRIBUTE_TYPE:e},parameters:{depthCompare:"always",blendColorOperation:"max",blendColorSrcFactor:"one",blendColorDstFactor:"one",blendAlphaOperation:"max",blendAlphaSrcFactor:"one",blendAlphaDstFactor:"one"}})}function aO(n){return n.createTexture({data:new Uint8Array(4),format:"rgba8unorm",mipmaps:!1,width:1,height:1})}function lO(n,t){return n.createFramebuffer({id:"spring-transition-is-transitioning-framebuffer",width:1,height:1,colorAttachments:[t]})}const cO={interpolation:KN,spring:eO};class uO{constructor(t,{id:e,timeline:r}){if(!t)throw new Error("AttributeTransitionManager is constructed without device");this.id=e,this.device=t,this.timeline=r,this.transitions={},this.needsRedraw=!1,this.numInstances=1}finalize(){for(const t in this.transitions)this._removeTransition(t)}update({attributes:t,transitions:e,numInstances:r}){this.numInstances=r||1;for(const i in t){const s=t[i],o=s.getTransitionSetting(e);o&&this._updateAttribute(i,s,o)}for(const i in this.transitions){const s=t[i];(!s||!s.getTransitionSetting(e))&&this._removeTransition(i)}}hasAttribute(t){const e=this.transitions[t];return e&&e.inProgress}getAttributes(){const t={};for(const e in this.transitions){const r=this.transitions[e];r.inProgress&&(t[e]=r.attributeInTransition)}return t}run(){if(this.numInstances===0)return!1;for(const e in this.transitions)this.transitions[e].update()&&(this.needsRedraw=!0);const t=this.needsRedraw;return this.needsRedraw=!1,t}_removeTransition(t){this.transitions[t].delete(),delete this.transitions[t]}_updateAttribute(t,e,r){const i=this.transitions[t];let s=!i||i.type!==r.type;if(s){i&&this._removeTransition(t);const o=cO[r.type];o?this.transitions[t]=new o({attribute:e,timeline:this.timeline,device:this.device}):(It.error(`unsupported transition type '${r.type}'`)(),s=!1)}(s||e.needsRedraw())&&(this.needsRedraw=!0,this.transitions[t].start(r,this.numInstances))}}const F_="attributeManager.invalidate",hO="attributeManager.updateStart",fO="attributeManager.updateEnd",dO="attribute.updateStart",pO="attribute.allocate",gO="attribute.updateEnd";class mO{constructor(t,{id:e="attribute-manager",stats:r,timeline:i}={}){this.mergeBoundsMemoized=sc(P3),this.id=e,this.device=t,this.attributes={},this.updateTriggers={},this.needsRedraw=!0,this.userData={},this.stats=r,this.attributeTransitionManager=new uO(t,{id:`${e}-transitions`,timeline:i}),Object.seal(this)}finalize(){for(const t in this.attributes)this.attributes[t].delete();this.attributeTransitionManager.finalize()}getNeedsRedraw(t={clearRedrawFlags:!1}){const e=this.needsRedraw;return this.needsRedraw=this.needsRedraw&&!t.clearRedrawFlags,e&&this.id}setNeedsRedraw(){this.needsRedraw=!0}add(t){this._add(t)}addInstanced(t){this._add(t,{stepMode:"instance"})}remove(t){for(const e of t)this.attributes[e]!==void 0&&(this.attributes[e].delete(),delete this.attributes[e])}invalidate(t,e){const r=this._invalidateTrigger(t,e);_n(F_,this,t,r)}invalidateAll(t){for(const e in this.attributes)this.attributes[e].setNeedsUpdate(e,t);_n(F_,this,"all")}update({data:t,numInstances:e,startIndices:r=null,transitions:i,props:s={},buffers:o={},context:a={}}){let l=!1;_n(hO,this),this.stats&&this.stats.get("Update Attributes").timeStart();for(const c in this.attributes){const u=this.attributes[c],h=u.settings.accessor;u.startIndices=r,u.numInstances=e,s[c]&&It.removed(`props.${c}`,`data.attributes.${c}`)(),u.setExternalBuffer(o[c])||u.setBinaryValue(typeof h=="string"?o[h]:void 0,t.startIndices)||typeof h=="string"&&!o[h]&&u.setConstantValue(s[h])||u.needsUpdate()&&(l=!0,this._updateAttribute({attribute:u,numInstances:e,data:t,props:s,context:a})),this.needsRedraw=this.needsRedraw||u.needsRedraw()}l&&_n(fO,this,e),this.stats&&this.stats.get("Update Attributes").timeEnd(),this.attributeTransitionManager.update({attributes:this.attributes,numInstances:e,transitions:i})}updateTransition(){const{attributeTransitionManager:t}=this,e=t.run();return this.needsRedraw=this.needsRedraw||e,e}getAttributes(){return{...this.attributes,...this.attributeTransitionManager.getAttributes()}}getBounds(t){const e=t.map(r=>this.attributes[r]?.getBounds());return this.mergeBoundsMemoized(e)}getChangedAttributes(t={clearChangedFlags:!1}){const{attributes:e,attributeTransitionManager:r}=this,i={...r.getAttributes()};for(const s in e){const o=e[s];o.needsRedraw(t)&&!r.hasAttribute(s)&&(i[s]=o)}return i}getBufferLayouts(t){return Object.values(this.getAttributes()).map(e=>e.getBufferLayout(t))}_add(t,e){for(const r in t){const i=t[r],s={...i,id:r,size:i.isIndexed&&1||i.size||1,...e};this.attributes[r]=new vx(this.device,s)}this._mapUpdateTriggersToAttributes()}_mapUpdateTriggersToAttributes(){const t={};for(const e in this.attributes)this.attributes[e].getUpdateTriggers().forEach(i=>{t[i]||(t[i]=[]),t[i].push(e)});this.updateTriggers=t}_invalidateTrigger(t,e){const{attributes:r,updateTriggers:i}=this,s=i[t];return s&&s.forEach(o=>{const a=r[o];a&&a.setNeedsUpdate(a.id,e)}),s}_updateAttribute(t){const{attribute:e,numInstances:r}=t;if(_n(dO,e),e.constant){e.setConstantValue(e.value);return}e.allocate(r)&&_n(pO,e,r),e.updateBuffer(t)&&(this.needsRedraw=!0,_n(gO,e,r))}}class _O extends Th{get value(){return this._value}_onUpdate(){const{time:t,settings:{fromValue:e,toValue:r,duration:i,easing:s}}=this,o=s(t/i);this._value=Fu(e,r,o)}}const B_=1e-5;function U_(n,t,e,r,i){const s=t-n,a=(e-t)*i,l=-s*r;return a+l+s+t}function yO(n,t,e,r,i){if(Array.isArray(e)){const s=[];for(let o=0;o<e.length;o++)s[o]=U_(n[o],t[o],e[o],r,i);return s}return U_(n,t,e,r,i)}function V_(n,t){if(Array.isArray(n)){let e=0;for(let r=0;r<n.length;r++){const i=n[r]-t[r];e+=i*i}return Math.sqrt(e)}return Math.abs(n-t)}class vO extends Th{get value(){return this._currValue}_onUpdate(){const{fromValue:t,toValue:e,damping:r,stiffness:i}=this.settings,{_prevValue:s=t,_currValue:o=t}=this;let a=yO(s,o,e,r,i);const l=V_(a,e),c=V_(a,o);l<B_&&c<B_&&(a=e,this.end()),this._prevValue=o,this._currValue=a}}const bO={interpolation:_O,spring:vO};class xO{constructor(t){this.transitions=new Map,this.timeline=t}get active(){return this.transitions.size>0}add(t,e,r,i){const{transitions:s}=this;if(s.has(t)){const l=s.get(t),{value:c=l.settings.fromValue}=l;e=c,this.remove(t)}if(i=yx(i),!i)return;const o=bO[i.type];if(!o){It.error(`unsupported transition type '${i.type}'`)();return}const a=new o(this.timeline);a.start({...i,fromValue:e,toValue:r}),s.set(t,a)}remove(t){const{transitions:e}=this;e.has(t)&&(e.get(t).cancel(),e.delete(t))}update(){const t={};for(const[e,r]of this.transitions)r.update(),t[e]=r.value,r.inProgress||this.remove(e);return t}clear(){for(const t of this.transitions.keys())this.remove(t)}}function EO(n){const t=n[Ss];for(const e in t){const r=t[e],{validate:i}=r;if(i&&!i(n[e],r))throw new Error(`Invalid prop ${e}: ${n[e]}`)}}function wO(n,t){const e=Px({newProps:n,oldProps:t,propTypes:n[Ss],ignoreProps:{data:null,updateTriggers:null,extensions:null,transitions:null}}),r=CO(n,t);let i=!1;return r||(i=TO(n,t)),{dataChanged:r,propsChanged:e,updateTriggersChanged:i,extensionsChanged:PO(n,t),transitionsChanged:SO(n,t)}}function SO(n,t){if(!n.transitions)return!1;const e={},r=n[Ss];let i=!1;for(const s in n.transitions){const o=r[s],a=o&&o.type;(a==="number"||a==="color"||a==="array")&&Ld(n[s],t[s],o)&&(e[s]=!0,i=!0)}return i?e:!1}function Px({newProps:n,oldProps:t,ignoreProps:e={},propTypes:r={},triggerName:i="props"}){if(t===n)return!1;if(typeof n!="object"||n===null)return`${i} changed shallowly`;if(typeof t!="object"||t===null)return`${i} changed shallowly`;for(const s of Object.keys(n))if(!(s in e)){if(!(s in t))return`${i}.${s} added`;const o=Ld(n[s],t[s],r[s]);if(o)return`${i}.${s} ${o}`}for(const s of Object.keys(t))if(!(s in e)){if(!(s in n))return`${i}.${s} dropped`;if(!Object.hasOwnProperty.call(n,s)){const o=Ld(n[s],t[s],r[s]);if(o)return`${i}.${s} ${o}`}}return!1}function Ld(n,t,e){let r=e&&e.equal;return r&&!r(n,t,e)||!r&&(r=n&&t&&n.equals,r&&!r.call(n,t))?"changed deeply":!r&&t!==n?"changed shallowly":null}function CO(n,t){if(t===null)return"oldProps is null, initial diff";let e=!1;const{dataComparator:r,_dataDiff:i}=n;return r?r(n.data,t.data)||(e="Data comparator detected a change"):n.data!==t.data&&(e="A new data container was supplied"),e&&i&&(e=i(n.data,t.data)||e),e}function TO(n,t){if(t===null)return{all:!0};if("all"in n.updateTriggers&&z_(n,t,"all"))return{all:!0};const e={};let r=!1;for(const i in n.updateTriggers)i!=="all"&&z_(n,t,i)&&(e[i]=!0,r=!0);return r?e:!1}function PO(n,t){if(t===null)return!0;const e=t.extensions,{extensions:r}=n;if(r===e)return!1;if(!e||!r||r.length!==e.length)return!0;for(let i=0;i<r.length;i++)if(!r[i].equals(e[i]))return!0;return!1}function z_(n,t,e){let r=n.updateTriggers[e];r=r??{};let i=t.updateTriggers[e];return i=i??{},Px({oldProps:i,newProps:r,triggerName:e})}const IO="count(): argument not an object",AO="count(): argument not a container";function MO(n){if(!NO(n))throw new Error(IO);if(typeof n.count=="function")return n.count();if(Number.isFinite(n.size))return n.size;if(Number.isFinite(n.length))return n.length;if(RO(n))return Object.keys(n).length;throw new Error(AO)}function RO(n){return n!==null&&typeof n=="object"&&n.constructor===Object}function NO(n){return n!==null&&typeof n=="object"}function $u(n,t){if(!t)return n;const e={...n,...t};if("defines"in t&&(e.defines={...n.defines,...t.defines}),"modules"in t&&(e.modules=(n.modules||[]).concat(t.modules),t.modules.some(r=>r.name==="project64"))){const r=e.modules.findIndex(i=>i.name==="project32");r>=0&&e.modules.splice(r,1)}if("inject"in t)if(!n.inject)e.inject=t.inject;else{const r={...n.inject};for(const i in t.inject)r[i]=(r[i]||"")+t.inject[i];e.inject=r}return e}const OO={minFilter:"linear",mipmapFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},kd={};function DO(n,t,e,r){if(e instanceof jt)return e;e.constructor&&e.constructor.name!=="Object"&&(e={data:e});let i=null;e.compressed&&(i={minFilter:"linear",mipmapFilter:e.data.length>1?"nearest":"linear"});const s=t.createTexture({...e,sampler:{...OO,...i,...r},mipmaps:!0});return kd[s.id]=n,s}function LO(n,t){!t||!(t instanceof jt)||kd[t.id]===n&&(t.delete(),delete kd[t.id])}const kO={boolean:{validate(n,t){return!0},equal(n,t,e){return!!n==!!t}},number:{validate(n,t){return Number.isFinite(n)&&(!("max"in t)||n<=t.max)&&(!("min"in t)||n>=t.min)}},color:{validate(n,t){return t.optional&&!n||Fd(n)&&(n.length===3||n.length===4)},equal(n,t,e){return xr(n,t,1)}},accessor:{validate(n,t){const e=Xu(n);return e==="function"||e===Xu(t.value)},equal(n,t,e){return typeof t=="function"?!0:xr(n,t,1)}},array:{validate(n,t){return t.optional&&!n||Fd(n)},equal(n,t,e){const{compare:r}=e,i=Number.isInteger(r)?r:r?1:0;return r?xr(n,t,i):n===t}},object:{equal(n,t,e){if(e.ignore)return!0;const{compare:r}=e,i=Number.isInteger(r)?r:r?1:0;return r?xr(n,t,i):n===t}},function:{validate(n,t){return t.optional&&!n||typeof n=="function"},equal(n,t,e){return!e.compare&&e.ignore!==!1||n===t}},data:{transform:(n,t,e)=>{if(!n)return n;const{dataTransform:r}=e.props;return r?r(n):typeof n.shape=="string"&&n.shape.endsWith("-table")&&Array.isArray(n.data)?n.data:n}},image:{transform:(n,t,e)=>{const r=e.context;return!r||!r.device?null:DO(e.id,r.device,n,{...t.parameters,...e.props.textureParameters})},release:(n,t,e)=>{LO(e.id,n)}}};function FO(n){const t={},e={},r={};for(const[i,s]of Object.entries(n)){const o=s?.deprecatedFor;if(o)r[i]=Array.isArray(o)?o:[o];else{const a=BO(i,s);t[i]=a,e[i]=a.value}}return{propTypes:t,defaultProps:e,deprecatedProps:r}}function BO(n,t){switch(Xu(t)){case"object":return el(n,t);case"array":return el(n,{type:"array",value:t,compare:!1});case"boolean":return el(n,{type:"boolean",value:t});case"number":return el(n,{type:"number",value:t});case"function":return el(n,{type:"function",value:t,compare:!0});default:return{name:n,type:"unknown",value:t}}}function el(n,t){return"type"in t?{name:n,...kO[t.type],...t}:"value"in t?{name:n,type:Xu(t.value),...t}:{name:n,type:"object",value:t}}function Fd(n){return Array.isArray(n)||ArrayBuffer.isView(n)}function Xu(n){return Fd(n)?"array":n===null?"null":typeof n}function UO(n,t){let e;for(let s=t.length-1;s>=0;s--){const o=t[s];"extensions"in o&&(e=o.extensions)}const r=Bd(n.constructor,e),i=Object.create(r);i[Hu]=n,i[co]={},i[_s]={};for(let s=0;s<t.length;++s){const o=t[s];for(const a in o)i[a]=o[a]}return Object.freeze(i),i}const VO="_mergedDefaultProps";function Bd(n,t){if(!(n instanceof Ih.constructor))return{};let e=VO;if(t)for(const i of t){const s=i.constructor;s&&(e+=`:${s.extensionName||s.name}`)}const r=Ix(n,e);return r||(n[e]=zO(n,t||[]))}function zO(n,t){if(!n.prototype)return null;const r=Object.getPrototypeOf(n),i=Bd(r),s=Ix(n,"defaultProps")||{},o=FO(s),a=Object.assign(Object.create(null),i,o.defaultProps),l=Object.assign(Object.create(null),i?.[Ss],o.propTypes),c=Object.assign(Object.create(null),i?.[If],o.deprecatedProps);for(const u of t){const h=Bd(u.constructor);h&&(Object.assign(a,h),Object.assign(l,h[Ss]),Object.assign(c,h[If]))}return WO(a,n),jO(a,l),HO(a,c),a[Ss]=l,a[If]=c,t.length===0&&!Qp(n,"_propTypes")&&(n._propTypes=l),a}function WO(n,t){const e=XO(t);Object.defineProperties(n,{id:{writable:!0,value:e}})}function HO(n,t){for(const e in t)Object.defineProperty(n,e,{enumerable:!1,set(r){const i=`${this.id}: ${e}`;for(const s of t[e])Qp(this,s)||(this[s]=r);It.deprecated(i,t[e].join("/"))()}})}function jO(n,t){const e={},r={};for(const i in t){const s=t[i],{name:o,value:a}=s;s.async&&(e[o]=a,r[o]=$O(o))}n[sa]=e,n[co]={},Object.defineProperties(n,r)}function $O(n){return{enumerable:!0,set(t){typeof t=="string"||t instanceof Promise||mx(t)?this[co][n]=t:this[_s][n]=t},get(){if(this[_s]){if(n in this[_s])return this[_s][n]||this[sa][n];if(n in this[co]){const t=this[Hu]&&this[Hu].internalState;if(t&&t.hasAsyncProp(n))return t.getAsyncProp(n)||this[sa][n]}}return this[sa][n]}}}function Qp(n,t){return Object.prototype.hasOwnProperty.call(n,t)}function Ix(n,t){return Qp(n,t)&&n[t]}function XO(n){const t=n.componentName;return t||It.warn(`${n.name}.componentName not specified`)(),t||n.name}let GO=0;class Ih{constructor(...t){this.props=UO(this,t),this.id=this.props.id,this.count=GO++}clone(t){const{props:e}=this,r={};for(const i in e[sa])i in e[_s]?r[i]=e[_s][i]:i in e[co]&&(r[i]=e[co][i]);return new this.constructor({...e,...r,...t})}}Ih.componentName="Component";Ih.defaultProps={};const YO=Object.freeze({});class qO{constructor(t){this.component=t,this.asyncProps={},this.onAsyncPropUpdated=()=>{},this.oldProps=null,this.oldAsyncProps=null}finalize(){for(const t in this.asyncProps){const e=this.asyncProps[t];e&&e.type&&e.type.release&&e.type.release(e.resolvedValue,e.type,this.component)}this.asyncProps={},this.component=null,this.resetOldProps()}getOldProps(){return this.oldAsyncProps||this.oldProps||YO}resetOldProps(){this.oldAsyncProps=null,this.oldProps=this.component?this.component.props:null}hasAsyncProp(t){return t in this.asyncProps}getAsyncProp(t){const e=this.asyncProps[t];return e&&e.resolvedValue}isAsyncPropLoading(t){if(t){const e=this.asyncProps[t];return!!(e&&e.pendingLoadCount>0&&e.pendingLoadCount!==e.resolvedLoadCount)}for(const e in this.asyncProps)if(this.isAsyncPropLoading(e))return!0;return!1}reloadAsyncProp(t,e){this._watchPromise(t,Promise.resolve(e))}setAsyncProps(t){this.component=t[Hu]||this.component;const e=t[_s]||{},r=t[co]||t,i=t[sa]||{};for(const s in e){const o=e[s];this._createAsyncPropData(s,i[s]),this._updateAsyncProp(s,o),e[s]=this.getAsyncProp(s)}for(const s in r){const o=r[s];this._createAsyncPropData(s,i[s]),this._updateAsyncProp(s,o)}}_fetch(t,e){return null}_onResolve(t,e){}_onError(t,e){}_updateAsyncProp(t,e){if(this._didAsyncInputValueChange(t,e)){if(typeof e=="string"&&(e=this._fetch(t,e)),e instanceof Promise){this._watchPromise(t,e);return}if(mx(e)){this._resolveAsyncIterable(t,e);return}this._setPropValue(t,e)}}_freezeAsyncOldProps(){if(!this.oldAsyncProps&&this.oldProps){this.oldAsyncProps=Object.create(this.oldProps);for(const t in this.asyncProps)Object.defineProperty(this.oldAsyncProps,t,{enumerable:!0,value:this.oldProps[t]})}}_didAsyncInputValueChange(t,e){const r=this.asyncProps[t];return e===r.resolvedValue||e===r.lastValue?!1:(r.lastValue=e,!0)}_setPropValue(t,e){this._freezeAsyncOldProps();const r=this.asyncProps[t];r&&(e=this._postProcessValue(r,e),r.resolvedValue=e,r.pendingLoadCount++,r.resolvedLoadCount=r.pendingLoadCount)}_setAsyncPropValue(t,e,r){const i=this.asyncProps[t];i&&r>=i.resolvedLoadCount&&e!==void 0&&(this._freezeAsyncOldProps(),i.resolvedValue=e,i.resolvedLoadCount=r,this.onAsyncPropUpdated(t,e))}_watchPromise(t,e){const r=this.asyncProps[t];if(r){r.pendingLoadCount++;const i=r.pendingLoadCount;e.then(s=>{this.component&&(s=this._postProcessValue(r,s),this._setAsyncPropValue(t,s,i),this._onResolve(t,s))}).catch(s=>{this._onError(t,s)})}}async _resolveAsyncIterable(t,e){if(t!=="data"){this._setPropValue(t,e);return}const r=this.asyncProps[t];if(!r)return;r.pendingLoadCount++;const i=r.pendingLoadCount;let s=[],o=0;for await(const a of e){if(!this.component)return;const{dataTransform:l}=this.component.props;l?s=l(a,s):s=s.concat(a),Object.defineProperty(s,"__diff",{enumerable:!1,value:[{startRow:o,endRow:s.length}]}),o=s.length,this._setAsyncPropValue(t,s,i)}this._onResolve(t,s)}_postProcessValue(t,e){const r=t.type;return r&&this.component&&(r.release&&r.release(t.resolvedValue,r,this.component),r.transform)?r.transform(e,r,this.component):e}_createAsyncPropData(t,e){if(!this.asyncProps[t]){const i=this.component&&this.component.props[Ss];this.asyncProps[t]={type:i&&i[t],lastValue:null,resolvedValue:e,pendingLoadCount:0,resolvedLoadCount:0}}}}class KO extends qO{constructor({attributeManager:t,layer:e}){super(e),this.attributeManager=t,this.needsRedraw=!0,this.needsUpdate=!0,this.subLayers=null,this.usesPickingColorCache=!1}get layer(){return this.component}_fetch(t,e){const r=this.layer,i=r?.props.fetch;return i?i(e,{propName:t,layer:r}):super._fetch(t,e)}_onResolve(t,e){const r=this.layer;if(r){const i=r.props.onDataLoad;t==="data"&&i&&i(e,{propName:t,layer:r})}}_onError(t,e){const r=this.layer;r&&r.raiseError(e,`loading ${t} of ${this.layer}`)}}const ZO="layer.changeFlag",JO="layer.initialize",QO="layer.update",tD="layer.finalize",eD="layer.matched",W_=2**24-1,nD=Object.freeze([]),rD=sc(({oldViewport:n,viewport:t})=>n.equals(t));let Wr=new Uint8ClampedArray(0);const iD={data:{type:"data",value:nD,async:!0},dataComparator:{type:"function",value:null,optional:!0},_dataDiff:{type:"function",value:n=>n&&n.__diff,optional:!0},dataTransform:{type:"function",value:null,optional:!0},onDataLoad:{type:"function",value:null,optional:!0},onError:{type:"function",value:null,optional:!0},fetch:{type:"function",value:(n,{propName:t,layer:e,loaders:r,loadOptions:i,signal:s})=>{const{resourceManager:o}=e.context;i=i||e.getLoadOptions(),r=r||e.props.loaders,s&&(i={...i,fetch:{...i?.fetch,signal:s}});let a=o.contains(n);return!a&&!i&&(o.add({resourceId:n,data:Pu(n,r),persistent:!1}),a=!0),a?o.subscribe({resourceId:n,onChange:l=>e.internalState?.reloadAsyncProp(t,l),consumerId:e.id,requestId:t}):Pu(n,r,i)}},updateTriggers:{},visible:!0,pickable:!1,opacity:{type:"number",min:0,max:1,value:1},operation:"draw",onHover:{type:"function",value:null,optional:!0},onClick:{type:"function",value:null,optional:!0},onDragStart:{type:"function",value:null,optional:!0},onDrag:{type:"function",value:null,optional:!0},onDragEnd:{type:"function",value:null,optional:!0},coordinateSystem:At.DEFAULT,coordinateOrigin:{type:"array",value:[0,0,0],compare:!0},modelMatrix:{type:"array",value:null,compare:!0,optional:!0},wrapLongitude:!1,positionFormat:"XYZ",colorFormat:"RGBA",parameters:{type:"object",value:{},optional:!0,compare:2},loadOptions:{type:"object",value:null,optional:!0,ignore:!0},transitions:null,extensions:[],loaders:{type:"array",value:[],optional:!0,ignore:!0},getPolygonOffset:{type:"function",value:({layerIndex:n})=>[0,-n*100]},highlightedObjectIndex:null,autoHighlight:!1,highlightColor:{type:"accessor",value:[0,0,128,128]}};class zs extends Ih{constructor(){super(...arguments),this.internalState=null,this.lifecycle=Yo.NO_STATE,this.parent=null}static get componentName(){return Object.prototype.hasOwnProperty.call(this,"layerName")?this.layerName:""}get root(){let t=this;for(;t.parent;)t=t.parent;return t}toString(){return`${this.constructor.layerName||this.constructor.name}({id: '${this.props.id}'})`}project(t){an(this.internalState);const e=this.internalState.viewport||this.context.viewport,r=Xb(t,{viewport:e,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem}),[i,s,o]=Wb(r,e.pixelProjectionMatrix);return t.length===2?[i,s]:[i,s,o]}unproject(t){return an(this.internalState),(this.internalState.viewport||this.context.viewport).unproject(t)}projectPosition(t,e){an(this.internalState);const r=this.internalState.viewport||this.context.viewport;return O3(t,{viewport:r,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem,...e})}get isComposite(){return!1}get isDrawable(){return!0}setState(t){this.setChangeFlags({stateChanged:!0}),Object.assign(this.state,t),this.setNeedsRedraw()}setNeedsRedraw(){this.internalState&&(this.internalState.needsRedraw=!0)}setNeedsUpdate(){this.internalState&&(this.context.layerManager.setNeedsUpdate(String(this)),this.internalState.needsUpdate=!0)}get isLoaded(){return this.internalState?!this.internalState.isAsyncPropLoading():!1}get wrapLongitude(){return this.props.wrapLongitude}isPickable(){return this.props.pickable&&this.props.visible}getModels(){const t=this.state;return t&&(t.models||t.model&&[t.model])||[]}setShaderModuleProps(...t){for(const e of this.getModels())e.shaderInputs.setProps(...t)}getAttributeManager(){return this.internalState&&this.internalState.attributeManager}getCurrentLayer(){return this.internalState&&this.internalState.layer}getLoadOptions(){return this.props.loadOptions}use64bitPositions(){const{coordinateSystem:t}=this.props;return t===At.DEFAULT||t===At.LNGLAT||t===At.CARTESIAN}onHover(t,e){return this.props.onHover&&this.props.onHover(t,e)||!1}onClick(t,e){return this.props.onClick&&this.props.onClick(t,e)||!1}nullPickingColor(){return[0,0,0]}encodePickingColor(t,e=[]){return e[0]=t+1&255,e[1]=t+1>>8&255,e[2]=t+1>>8>>8&255,e}decodePickingColor(t){an(t instanceof Uint8Array);const[e,r,i]=t;return e+r*256+i*65536-1}getNumInstances(){return Number.isFinite(this.props.numInstances)?this.props.numInstances:this.state&&this.state.numInstances!==void 0?this.state.numInstances:MO(this.props.data)}getStartIndices(){return this.props.startIndices?this.props.startIndices:this.state&&this.state.startIndices?this.state.startIndices:null}getBounds(){return this.getAttributeManager()?.getBounds(["positions","instancePositions"])}getShaders(t){t=$u(t,{disableWarnings:!0,modules:this.context.defaultShaderModules});for(const e of this.props.extensions)t=$u(t,e.getShaders.call(this,e));return t}shouldUpdateState(t){return t.changeFlags.propsOrDataChanged}updateState(t){const e=this.getAttributeManager(),{dataChanged:r}=t.changeFlags;if(r&&e)if(Array.isArray(r))for(const i of r)e.invalidateAll(i);else e.invalidateAll();if(e){const{props:i}=t,s=this.internalState.hasPickingBuffer,o=Number.isInteger(i.highlightedObjectIndex)||i.pickable||i.extensions.some(a=>a.getNeedsPickingBuffer.call(this,a));if(s!==o){this.internalState.hasPickingBuffer=o;const{pickingColors:a,instancePickingColors:l}=e.attributes,c=a||l;c&&(o&&c.constant&&(c.constant=!1,e.invalidate(c.id)),!c.value&&!o&&(c.constant=!0,c.value=[0,0,0]))}}}finalizeState(t){for(const r of this.getModels())r.destroy();const e=this.getAttributeManager();e&&e.finalize(),this.context&&this.context.resourceManager.unsubscribe({consumerId:this.id}),this.internalState&&(this.internalState.uniformTransitions.clear(),this.internalState.finalize())}draw(t){for(const e of this.getModels())e.draw(t.renderPass)}getPickingInfo({info:t,mode:e,sourceLayer:r}){const{index:i}=t;return i>=0&&Array.isArray(this.props.data)&&(t.object=this.props.data[i]),t}raiseError(t,e){e&&(t=new Error(`${e}: ${t.message}`,{cause:t})),this.props.onError?.(t)||this.context?.onError?.(t,this)}getNeedsRedraw(t={clearRedrawFlags:!1}){return this._getNeedsRedraw(t)}needsUpdate(){return this.internalState?this.internalState.needsUpdate||this.hasUniformTransition()||this.shouldUpdateState(this._getUpdateParams()):!1}hasUniformTransition(){return this.internalState?.uniformTransitions.active||!1}activateViewport(t){if(!this.internalState)return;const e=this.internalState.viewport;this.internalState.viewport=t,(!e||!rD({oldViewport:e,viewport:t}))&&(this.setChangeFlags({viewportChanged:!0}),this.isComposite?this.needsUpdate()&&this.setNeedsUpdate():this._update())}invalidateAttribute(t="all"){const e=this.getAttributeManager();e&&(t==="all"?e.invalidateAll():e.invalidate(t))}updateAttributes(t){let e=!1;for(const r in t)t[r].layoutChanged()&&(e=!0);for(const r of this.getModels())this._setModelAttributes(r,t,e)}_updateAttributes(){const t=this.getAttributeManager();if(!t)return;const e=this.props,r=this.getNumInstances(),i=this.getStartIndices();t.update({data:e.data,numInstances:r,startIndices:i,props:e,transitions:e.transitions,buffers:e.data.attributes,context:this});const s=t.getChangedAttributes({clearChangedFlags:!0});this.updateAttributes(s)}_updateAttributeTransition(){const t=this.getAttributeManager();t&&t.updateTransition()}_updateUniformTransition(){const{uniformTransitions:t}=this.internalState;if(t.active){const e=t.update(),r=Object.create(this.props);for(const i in e)Object.defineProperty(r,i,{value:e[i]});return r}return this.props}calculateInstancePickingColors(t,{numInstances:e}){if(t.constant)return;const r=Math.floor(Wr.length/4);if(this.internalState.usesPickingColorCache=!0,r<e){e>W_&&It.warn("Layer has too many data objects. Picking might not be able to distinguish all objects.")(),Wr=da.allocate(Wr,e,{size:4,copy:!0,maxCount:Math.max(e,W_)});const i=Math.floor(Wr.length/4),s=[0,0,0];for(let o=r;o<i;o++)this.encodePickingColor(o,s),Wr[o*4+0]=s[0],Wr[o*4+1]=s[1],Wr[o*4+2]=s[2],Wr[o*4+3]=0}t.value=Wr.subarray(0,e*4)}_setModelAttributes(t,e,r=!1){if(!Object.keys(e).length)return;if(r){const a=this.getAttributeManager();t.setBufferLayout(a.getBufferLayouts(t)),e=a.getAttributes()}const i=t.userData?.excludeAttributes||{},s={},o={};for(const a in e){if(i[a])continue;const l=e[a].getValue();for(const c in l){const u=l[c];u instanceof Yt?e[a].settings.isIndexed?t.setIndexBuffer(u):s[c]=u:u&&(o[c]=u)}}t.setAttributes(s),t.setConstantAttributes(o)}disablePickingIndex(t){const e=this.props.data;if(!("attributes"in e)){this._disablePickingIndex(t);return}const{pickingColors:r,instancePickingColors:i}=this.getAttributeManager().attributes,s=r||i,o=s&&e.attributes&&e.attributes[s.id];if(o&&o.value){const a=o.value,l=this.encodePickingColor(t);for(let c=0;c<e.length;c++){const u=s.getVertexOffset(c);a[u]===l[0]&&a[u+1]===l[1]&&a[u+2]===l[2]&&this._disablePickingIndex(c)}}else this._disablePickingIndex(t)}_disablePickingIndex(t){const{pickingColors:e,instancePickingColors:r}=this.getAttributeManager().attributes,i=e||r;if(!i)return;const s=i.getVertexOffset(t),o=i.getVertexOffset(t+1);i.buffer.write(new Uint8Array(o-s),s)}restorePickingColors(){const{pickingColors:t,instancePickingColors:e}=this.getAttributeManager().attributes,r=t||e;r&&(this.internalState.usesPickingColorCache&&r.value.buffer!==Wr.buffer&&(r.value=Wr.subarray(0,r.value.length)),r.updateSubBuffer({startOffset:0}))}_initialize(){an(!this.internalState),an(Number.isFinite(this.props.coordinateSystem)),_n(JO,this);const t=this._getAttributeManager();t&&t.addInstanced({instancePickingColors:{type:"uint8",size:4,noAlloc:!0,update:this.calculateInstancePickingColors}}),this.internalState=new KO({attributeManager:t,layer:this}),this._clearChangeFlags(),this.state={},Object.defineProperty(this.state,"attributeManager",{get:()=>(It.deprecated("layer.state.attributeManager","layer.getAttributeManager()")(),t)}),this.internalState.uniformTransitions=new xO(this.context.timeline),this.internalState.onAsyncPropUpdated=this._onAsyncPropUpdated.bind(this),this.internalState.setAsyncProps(this.props),this.initializeState(this.context);for(const e of this.props.extensions)e.initializeState.call(this,this.context,e);this.setChangeFlags({dataChanged:"init",propsChanged:"init",viewportChanged:!0,extensionsChanged:!0}),this._update()}_transferState(t){_n(eD,this,this===t);const{state:e,internalState:r}=t;this!==t&&(this.internalState=r,this.state=e,this.internalState.setAsyncProps(this.props),this._diffProps(this.props,this.internalState.getOldProps()))}_update(){const t=this.needsUpdate();if(_n(QO,this,t),!t)return;const e=this.props,r=this.context,i=this.internalState,s=r.viewport,o=this._updateUniformTransition();i.propsInTransition=o,r.viewport=i.viewport||s,this.props=o;try{const a=this._getUpdateParams(),l=this.getModels();if(r.device)this.updateState(a);else try{this.updateState(a)}catch{}for(const u of this.props.extensions)u.updateState.call(this,a,u);this.setNeedsRedraw(),this._updateAttributes();const c=this.getModels()[0]!==l[0];this._postUpdate(a,c)}finally{r.viewport=s,this.props=e,this._clearChangeFlags(),i.needsUpdate=!1,i.resetOldProps()}}_finalize(){_n(tD,this),this.finalizeState(this.context);for(const t of this.props.extensions)t.finalizeState.call(this,this.context,t)}_drawLayer({renderPass:t,shaderModuleProps:e=null,uniforms:r={},parameters:i={}}){this._updateAttributeTransition();const s=this.props,o=this.context;this.props=this.internalState.propsInTransition||s;try{e&&this.setShaderModuleProps(e);const{getPolygonOffset:a}=this.props,l=a&&a(r)||[0,0];o.device instanceof ys&&o.device.setParametersWebGL({polygonOffset:l});for(const c of this.getModels())c.device.type==="webgpu"?c.setParameters({...c.parameters,...i}):c.setParameters(i);if(o.device instanceof ys)o.device.withParametersWebGL(i,()=>{const c={renderPass:t,shaderModuleProps:e,uniforms:r,parameters:i,context:o};for(const u of this.props.extensions)u.draw.call(this,c,u);this.draw(c)});else{const c={renderPass:t,shaderModuleProps:e,uniforms:r,parameters:i,context:o};for(const u of this.props.extensions)u.draw.call(this,c,u);this.draw(c)}}finally{this.props=s}}getChangeFlags(){return this.internalState?.changeFlags}setChangeFlags(t){if(!this.internalState)return;const{changeFlags:e}=this.internalState;for(const i in t)if(t[i]){let s=!1;switch(i){case"dataChanged":const o=t[i],a=e[i];o&&Array.isArray(a)&&(e.dataChanged=Array.isArray(o)?a.concat(o):o,s=!0);default:e[i]||(e[i]=t[i],s=!0)}s&&_n(ZO,this,i,t)}const r=!!(e.dataChanged||e.updateTriggersChanged||e.propsChanged||e.extensionsChanged);e.propsOrDataChanged=r,e.somethingChanged=r||e.viewportChanged||e.stateChanged}_clearChangeFlags(){this.internalState.changeFlags={dataChanged:!1,propsChanged:!1,updateTriggersChanged:!1,viewportChanged:!1,stateChanged:!1,extensionsChanged:!1,propsOrDataChanged:!1,somethingChanged:!1}}_diffProps(t,e){const r=wO(t,e);if(r.updateTriggersChanged)for(const i in r.updateTriggersChanged)r.updateTriggersChanged[i]&&this.invalidateAttribute(i);if(r.transitionsChanged)for(const i in r.transitionsChanged)this.internalState.uniformTransitions.add(i,e[i],t[i],t.transitions?.[i]);return this.setChangeFlags(r)}validateProps(){EO(this.props)}updateAutoHighlight(t){this.props.autoHighlight&&!Number.isInteger(this.props.highlightedObjectIndex)&&this._updateAutoHighlight(t)}_updateAutoHighlight(t){const e={highlightedObjectColor:t.picked?t.color:null},{highlightColor:r}=this.props;t.picked&&typeof r=="function"&&(e.highlightColor=r(t)),this.setShaderModuleProps({picking:e}),this.setNeedsRedraw()}_getAttributeManager(){const t=this.context;return new mO(t.device,{id:this.props.id,stats:t.stats,timeline:t.timeline})}_postUpdate(t,e){const{props:r,oldProps:i}=t,s=this.state.model;s?.isInstanced&&s.setInstanceCount(this.getNumInstances());const{autoHighlight:o,highlightedObjectIndex:a,highlightColor:l}=r;if(e||i.autoHighlight!==o||i.highlightedObjectIndex!==a||i.highlightColor!==l){const c={};Array.isArray(l)&&(c.highlightColor=l),(e||i.autoHighlight!==o||a!==i.highlightedObjectIndex)&&(c.highlightedObjectColor=Number.isFinite(a)&&a>=0?this.encodePickingColor(a):null),this.setShaderModuleProps({picking:c})}}_getUpdateParams(){return{props:this.props,oldProps:this.internalState.getOldProps(),context:this.context,changeFlags:this.internalState.changeFlags}}_getNeedsRedraw(t){if(!this.internalState)return!1;let e=!1;e=e||this.internalState.needsRedraw&&this.id;const r=this.getAttributeManager(),i=r?r.getNeedsRedraw(t):!1;if(e=e||i,e)for(const s of this.props.extensions)s.onNeedsRedraw.call(this,s);return this.internalState.needsRedraw=this.internalState.needsRedraw&&!t.clearRedrawFlags,e}_onAsyncPropUpdated(){this._diffProps(this.props,this.internalState.getOldProps()),this.setNeedsUpdate()}}zs.defaultProps=iD;zs.layerName="Layer";const sD="compositeLayer.renderLayers";class cc extends zs{get isComposite(){return!0}get isDrawable(){return!1}get isLoaded(){return super.isLoaded&&this.getSubLayers().every(t=>t.isLoaded)}getSubLayers(){return this.internalState&&this.internalState.subLayers||[]}initializeState(t){}setState(t){super.setState(t),this.setNeedsUpdate()}getPickingInfo({info:t}){const{object:e}=t;return e&&e.__source&&e.__source.parent&&e.__source.parent.id===this.id&&(t.object=e.__source.object,t.index=e.__source.index),t}filterSubLayer(t){return!0}shouldRenderSubLayer(t,e){return e&&e.length}getSubLayerClass(t,e){const{_subLayerProps:r}=this.props;return r&&r[t]&&r[t].type||e}getSubLayerRow(t,e,r){return t.__source={parent:this,object:e,index:r},t}getSubLayerAccessor(t){if(typeof t=="function"){const e={index:-1,data:this.props.data,target:[]};return(r,i)=>r&&r.__source?(e.index=r.__source.index,t(r.__source.object,e)):t(r,i)}return t}getSubLayerProps(t={}){const{opacity:e,pickable:r,visible:i,parameters:s,getPolygonOffset:o,highlightedObjectIndex:a,autoHighlight:l,highlightColor:c,coordinateSystem:u,coordinateOrigin:h,wrapLongitude:f,positionFormat:d,modelMatrix:p,extensions:_,fetch:v,operation:E,_subLayerProps:m}=this.props,g={id:"",updateTriggers:{},opacity:e,pickable:r,visible:i,parameters:s,getPolygonOffset:o,highlightedObjectIndex:a,autoHighlight:l,highlightColor:c,coordinateSystem:u,coordinateOrigin:h,wrapLongitude:f,positionFormat:d,modelMatrix:p,extensions:_,fetch:v,operation:E},y=m&&t.id&&m[t.id],b=y&&y.updateTriggers,x=t.id||"sublayer";if(y){const w=this.props[Ss],S=t.type?t.type._propTypes:{};for(const I in y){const T=S[I]||w[I];T&&T.type==="accessor"&&(y[I]=this.getSubLayerAccessor(y[I]))}}Object.assign(g,t,y),g.id=`${this.props.id}-${x}`,g.updateTriggers={all:this.props.updateTriggers?.all,...t.updateTriggers,...b};for(const w of _){const S=w.getSubLayerProps.call(this,w);S&&Object.assign(g,S,{updateTriggers:Object.assign(g.updateTriggers,S.updateTriggers)})}return g}_updateAutoHighlight(t){for(const e of this.getSubLayers())e.updateAutoHighlight(t)}_getAttributeManager(){return null}_postUpdate(t,e){let r=this.internalState.subLayers;const i=!r||this.needsUpdate();if(i){const s=this.renderLayers();r=$p(s,Boolean),this.internalState.subLayers=r}_n(sD,this,i,r);for(const s of r)s.parent=this}}cc.layerName="CompositeLayer";class tg{static get componentName(){return Object.prototype.hasOwnProperty.call(this,"extensionName")?this.extensionName:""}constructor(t){t&&(this.opts=t)}equals(t){return this===t?!0:this.constructor===t.constructor&&xr(this.opts,t.opts,1)}getShaders(t){return null}getSubLayerProps(t){const{defaultProps:e}=t.constructor,r={updateTriggers:{}};for(const i in e)if(i in this.props){const s=e[i],o=this.props[i];r[i]=o,s&&s.type==="accessor"&&(r.updateTriggers[i]=this.props.updateTriggers[i],typeof o=="function"&&(r[i]=this.getSubLayerAccessor(o)))}return r}initializeState(t,e){}updateState(t,e){}onNeedsRedraw(t){}getNeedsPickingBuffer(t){return!1}draw(t,e){}finalizeState(t,e){}}tg.defaultProps={};tg.extensionName="LayerExtension";class Ax{constructor(t){this.indexStarts=[0],this.vertexStarts=[0],this.vertexCount=0,this.instanceCount=0;const{attributes:e={}}=t;this.typedArrayManager=da,this.attributes={},this._attributeDefs=e,this.opts=t,this.updateGeometry(t)}updateGeometry(t){Object.assign(this.opts,t);const{data:e,buffers:r={},getGeometry:i,geometryBuffer:s,positionFormat:o,dataChanged:a,normalize:l=!0}=this.opts;if(this.data=e,this.getGeometry=i,this.positionSize=s&&s.size||(o==="XY"?2:3),this.buffers=r,this.normalize=l,s&&(an(e.startIndices),this.getGeometry=this.getGeometryFromBuffer(s),l||(r.vertexPositions=s)),this.geometryBuffer=r.vertexPositions,Array.isArray(a))for(const c of a)this._rebuildGeometry(c);else this._rebuildGeometry()}updatePartialGeometry({startRow:t,endRow:e}){this._rebuildGeometry({startRow:t,endRow:e})}getGeometryFromBuffer(t){const e=t.value||t;return ArrayBuffer.isView(e)?_x(e,{size:this.positionSize,offset:t.offset,stride:t.stride,startIndices:this.data.startIndices}):null}_allocate(t,e){const{attributes:r,buffers:i,_attributeDefs:s,typedArrayManager:o}=this;for(const a in s)if(a in i)o.release(r[a]),r[a]=null;else{const l=s[a];l.copy=e,r[a]=o.allocate(r[a],t,l)}}_forEachGeometry(t,e,r){const{data:i,getGeometry:s}=this,{iterable:o,objectInfo:a}=Ph(i,e,r);for(const l of o){a.index++;const c=s?s(l,a):null;t(c,a.index)}}_rebuildGeometry(t){if(!this.data)return;let{indexStarts:e,vertexStarts:r,instanceCount:i}=this;const{data:s,geometryBuffer:o}=this,{startRow:a=0,endRow:l=1/0}=t||{},c={};if(t||(e=[0],r=[0]),this.normalize||!o)this._forEachGeometry((h,f)=>{const d=h&&this.normalizeGeometry(h);c[f]=d,r[f+1]=r[f]+(d?this.getGeometrySize(d):0)},a,l),i=r[r.length-1];else if(r=s.startIndices,i=r[s.length]||0,ArrayBuffer.isView(o))i=i||o.length/this.positionSize;else if(o instanceof Yt){const h=this.positionSize*4;i=i||o.byteLength/h}else if(o.buffer){const h=o.stride||this.positionSize*4;i=i||o.buffer.byteLength/h}else if(o.value){const h=o.value,f=o.stride/h.BYTES_PER_ELEMENT||this.positionSize;i=i||h.length/f}this._allocate(i,!!t),this.indexStarts=e,this.vertexStarts=r,this.instanceCount=i;const u={};this._forEachGeometry((h,f)=>{const d=c[f]||h;u.vertexStart=r[f],u.indexStart=e[f];const p=f<r.length-1?r[f+1]:i;u.geometrySize=p-r[f],u.geometryIndex=f,this.updateGeometryAttributes(d,u)},a,l),this.vertexCount=e[e.length-1]}}const H_=`uniform iconUniforms {
  float sizeScale;
  vec2 iconsTextureDim;
  float sizeMinPixels;
  float sizeMaxPixels;
  bool billboard;
  highp int sizeUnits;
  float alphaCutoff;
} icon;
`,oD={name:"icon",vs:H_,fs:H_,uniformTypes:{sizeScale:"f32",iconsTextureDim:"vec2<f32>",sizeMinPixels:"f32",sizeMaxPixels:"f32",billboard:"f32",sizeUnits:"i32",alphaCutoff:"f32"}},aD=`#version 300 es
#define SHADER_NAME icon-layer-vertex-shader
in vec2 positions;
in vec3 instancePositions;
in vec3 instancePositions64Low;
in float instanceSizes;
in float instanceAngles;
in vec4 instanceColors;
in vec3 instancePickingColors;
in vec4 instanceIconFrames;
in float instanceColorModes;
in vec2 instanceOffsets;
in vec2 instancePixelOffset;
out float vColorMode;
out vec4 vColor;
out vec2 vTextureCoords;
out vec2 uv;
vec2 rotate_by_angle(vec2 vertex, float angle) {
float angle_radian = angle * PI / 180.0;
float cos_angle = cos(angle_radian);
float sin_angle = sin(angle_radian);
mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);
return rotationMatrix * vertex;
}
void main(void) {
geometry.worldPosition = instancePositions;
geometry.uv = positions;
geometry.pickingColor = instancePickingColors;
uv = positions;
vec2 iconSize = instanceIconFrames.zw;
float sizePixels = clamp(
project_size_to_pixel(instanceSizes * icon.sizeScale, icon.sizeUnits),
icon.sizeMinPixels, icon.sizeMaxPixels
);
float instanceScale = iconSize.y == 0.0 ? 0.0 : sizePixels / iconSize.y;
vec2 pixelOffset = positions / 2.0 * iconSize + instanceOffsets;
pixelOffset = rotate_by_angle(pixelOffset, instanceAngles) * instanceScale;
pixelOffset += instancePixelOffset;
pixelOffset.y *= -1.0;
if (icon.billboard)  {
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
vec3 offset = vec3(pixelOffset, 0.0);
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
} else {
vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);
DECKGL_FILTER_SIZE(offset_common, geometry);
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
}
vTextureCoords = mix(
instanceIconFrames.xy,
instanceIconFrames.xy + iconSize,
(positions.xy + 1.0) / 2.0
) / icon.iconsTextureDim;
vColor = instanceColors;
DECKGL_FILTER_COLOR(vColor, geometry);
vColorMode = instanceColorModes;
}
`,lD=`#version 300 es
#define SHADER_NAME icon-layer-fragment-shader
precision highp float;
uniform sampler2D iconsTexture;
in float vColorMode;
in vec4 vColor;
in vec2 vTextureCoords;
in vec2 uv;
out vec4 fragColor;
void main(void) {
geometry.uv = uv;
vec4 texColor = texture(iconsTexture, vTextureCoords);
vec3 color = mix(texColor.rgb, vColor.rgb, vColorMode);
float a = texColor.a * layer.opacity * vColor.a;
if (a < icon.alphaCutoff) {
discard;
}
fragColor = vec4(color, a);
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,cD=1024,uD=4,j_=()=>{},$_={minFilter:"linear",mipmapFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},hD={x:0,y:0,width:0,height:0};function fD(n){return Math.pow(2,Math.ceil(Math.log2(n)))}function dD(n,t,e,r){const i=Math.min(e/t.width,r/t.height),s=Math.floor(t.width*i),o=Math.floor(t.height*i);return i===1?{image:t,width:s,height:o}:(n.canvas.height=o,n.canvas.width=s,n.clearRect(0,0,s,o),n.drawImage(t,0,0,t.width,t.height,0,0,s,o),{image:n.canvas,width:s,height:o})}function Rl(n){return n&&(n.id||n.url)}function pD(n,t,e,r){const{width:i,height:s,device:o}=n,a=o.createTexture({format:"rgba8unorm",width:t,height:e,sampler:r,mipmaps:!0}),l=o.createCommandEncoder();return l.copyTextureToTexture({sourceTexture:n,destinationTexture:a,width:i,height:s}),l.finish(),n.destroy(),a}function X_(n,t,e){for(let r=0;r<t.length;r++){const{icon:i,xOffset:s}=t[r],o=Rl(i);n[o]={...i,x:s,y:e}}}function gD({icons:n,buffer:t,mapping:e={},xOffset:r=0,yOffset:i=0,rowHeight:s=0,canvasWidth:o}){let a=[];for(let l=0;l<n.length;l++){const c=n[l],u=Rl(c);if(!e[u]){const{height:h,width:f}=c;r+f+t>o&&(X_(e,a,i),r=0,i=s+i+t,s=0,a=[]),a.push({icon:c,xOffset:r}),r=r+f+t,s=Math.max(s,h)}}return a.length>0&&X_(e,a,i),{mapping:e,rowHeight:s,xOffset:r,yOffset:i,canvasWidth:o,canvasHeight:fD(s+i+t)}}function mD(n,t,e){if(!n||!t)return null;e=e||{};const r={},{iterable:i,objectInfo:s}=Ph(n);for(const o of i){s.index++;const a=t(o,s),l=Rl(a);if(!a)throw new Error("Icon is missing.");if(!a.url)throw new Error("Icon url is missing.");!r[l]&&(!e[l]||a.url!==e[l].url)&&(r[l]={...a,source:o,sourceIndex:s.index})}return r}class _D{constructor(t,{onUpdate:e=j_,onError:r=j_}){this._loadOptions=null,this._texture=null,this._externalTexture=null,this._mapping={},this._samplerParameters=null,this._pendingCount=0,this._autoPacking=!1,this._xOffset=0,this._yOffset=0,this._rowHeight=0,this._buffer=uD,this._canvasWidth=cD,this._canvasHeight=0,this._canvas=null,this.device=t,this.onUpdate=e,this.onError=r}finalize(){this._texture?.delete()}getTexture(){return this._texture||this._externalTexture}getIconMapping(t){const e=this._autoPacking?Rl(t):t;return this._mapping[e]||hD}setProps({loadOptions:t,autoPacking:e,iconAtlas:r,iconMapping:i,textureParameters:s}){t&&(this._loadOptions=t),e!==void 0&&(this._autoPacking=e),i&&(this._mapping=i),r&&(this._texture?.delete(),this._texture=null,this._externalTexture=r),s&&(this._samplerParameters=s)}get isLoaded(){return this._pendingCount===0}packIcons(t,e){if(!this._autoPacking||typeof document>"u")return;const r=Object.values(mD(t,e,this._mapping)||{});if(r.length>0){const{mapping:i,xOffset:s,yOffset:o,rowHeight:a,canvasHeight:l}=gD({icons:r,buffer:this._buffer,canvasWidth:this._canvasWidth,mapping:this._mapping,rowHeight:this._rowHeight,xOffset:this._xOffset,yOffset:this._yOffset});this._rowHeight=a,this._mapping=i,this._xOffset=s,this._yOffset=o,this._canvasHeight=l,this._texture||(this._texture=this.device.createTexture({format:"rgba8unorm",width:this._canvasWidth,height:this._canvasHeight,sampler:this._samplerParameters||$_,mipmaps:!0})),this._texture.height!==this._canvasHeight&&(this._texture=pD(this._texture,this._canvasWidth,this._canvasHeight,this._samplerParameters||$_)),this.onUpdate(),this._canvas=this._canvas||document.createElement("canvas"),this._loadIcons(r)}}_loadIcons(t){const e=this._canvas.getContext("2d",{willReadFrequently:!0});for(const r of t)this._pendingCount++,Pu(r.url,this._loadOptions).then(i=>{const s=Rl(r),o=this._mapping[s],{x:a,y:l,width:c,height:u}=o,{image:h,width:f,height:d}=dD(e,i,c,u);this._texture?.copyExternalImage({image:h,x:a+(c-f)/2,y:l+(u-d)/2,width:f,height:d}),o.width=f,o.height=d,this._texture.generateMipmap(),this.onUpdate()}).catch(i=>{this.onError({url:r.url,source:r.source,sourceIndex:r.sourceIndex,loadOptions:this._loadOptions,error:i})}).finally(()=>{this._pendingCount--})}}const Mx=[0,0,0,255],yD={iconAtlas:{type:"image",value:null,async:!0},iconMapping:{type:"object",value:{},async:!0},sizeScale:{type:"number",value:1,min:0},billboard:!0,sizeUnits:"pixels",sizeMinPixels:{type:"number",min:0,value:0},sizeMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},alphaCutoff:{type:"number",value:.05,min:0,max:1},getPosition:{type:"accessor",value:n=>n.position},getIcon:{type:"accessor",value:n=>n.icon},getColor:{type:"accessor",value:Mx},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},onIconError:{type:"function",value:null,optional:!0},textureParameters:{type:"object",ignore:!0,value:null}};class uc extends zs{getShaders(){return super.getShaders({vs:aD,fs:lD,modules:[oc,ac,oD]})}initializeState(){this.state={iconManager:new _D(this.context.device,{onUpdate:this._onUpdate.bind(this),onError:this._onError.bind(this)})},this.getAttributeManager().addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceOffsets:{size:2,accessor:"getIcon",transform:this.getInstanceOffset},instanceIconFrames:{size:4,accessor:"getIcon",transform:this.getInstanceIconFrame},instanceColorModes:{size:1,type:"uint8",accessor:"getIcon",transform:this.getInstanceColorMode},instanceColors:{size:this.props.colorFormat.length,type:"unorm8",transition:!0,accessor:"getColor",defaultValue:Mx},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instancePixelOffset:{size:2,transition:!0,accessor:"getPixelOffset"}})}updateState(t){super.updateState(t);const{props:e,oldProps:r,changeFlags:i}=t,s=this.getAttributeManager(),{iconAtlas:o,iconMapping:a,data:l,getIcon:c,textureParameters:u}=e,{iconManager:h}=this.state;if(typeof o=="string")return;const f=o||this.internalState.isAsyncPropLoading("iconAtlas");h.setProps({loadOptions:e.loadOptions,autoPacking:!f,iconAtlas:o,iconMapping:f?a:null,textureParameters:u}),f?r.iconMapping!==e.iconMapping&&s.invalidate("getIcon"):(i.dataChanged||i.updateTriggersChanged&&(i.updateTriggersChanged.all||i.updateTriggersChanged.getIcon))&&h.packIcons(l,c),i.extensionsChanged&&(this.state.model?.destroy(),this.state.model=this._getModel(),s.invalidateAll())}get isLoaded(){return super.isLoaded&&this.state.iconManager.isLoaded}finalizeState(t){super.finalizeState(t),this.state.iconManager.finalize()}draw({uniforms:t}){const{sizeScale:e,sizeMinPixels:r,sizeMaxPixels:i,sizeUnits:s,billboard:o,alphaCutoff:a}=this.props,{iconManager:l}=this.state,c=l.getTexture();if(c){const u=this.state.model,h={iconsTexture:c,iconsTextureDim:[c.width,c.height],sizeUnits:Gi[s],sizeScale:e,sizeMinPixels:r,sizeMaxPixels:i,billboard:o,alphaCutoff:a};u.shaderInputs.setProps({icon:h}),u.draw(this.context.renderPass)}}_getModel(){const t=[-1,-1,1,-1,-1,1,1,1];return new qr(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new ga({topology:"triangle-strip",attributes:{positions:{size:2,value:new Float32Array(t)}}}),isInstanced:!0})}_onUpdate(){this.setNeedsRedraw()}_onError(t){const e=this.getCurrentLayer()?.props.onIconError;e?e(t):It.error(t.error.message)()}getInstanceOffset(t){const{width:e,height:r,anchorX:i=e/2,anchorY:s=r/2}=this.state.iconManager.getIconMapping(t);return[e/2-i,r/2-s]}getInstanceColorMode(t){return this.state.iconManager.getIconMapping(t).mask?1:0}getInstanceIconFrame(t){const{x:e,y:r,width:i,height:s}=this.state.iconManager.getIconMapping(t);return[e,r,i,s]}}uc.defaultProps=yD;uc.layerName="IconLayer";const G_=`uniform scatterplotUniforms {
  float radiusScale;
  float radiusMinPixels;
  float radiusMaxPixels;
  float lineWidthScale;
  float lineWidthMinPixels;
  float lineWidthMaxPixels;
  float stroked;
  float filled;
  bool antialiasing;
  bool billboard;
  highp int radiusUnits;
  highp int lineWidthUnits;
} scatterplot;
`,vD={name:"scatterplot",vs:G_,fs:G_,source:"",uniformTypes:{radiusScale:"f32",radiusMinPixels:"f32",radiusMaxPixels:"f32",lineWidthScale:"f32",lineWidthMinPixels:"f32",lineWidthMaxPixels:"f32",stroked:"f32",filled:"f32",antialiasing:"f32",billboard:"f32",radiusUnits:"i32",lineWidthUnits:"i32"}},bD=`#version 300 es
#define SHADER_NAME scatterplot-layer-vertex-shader
in vec3 positions;
in vec3 instancePositions;
in vec3 instancePositions64Low;
in float instanceRadius;
in float instanceLineWidths;
in vec4 instanceFillColors;
in vec4 instanceLineColors;
in vec3 instancePickingColors;
out vec4 vFillColor;
out vec4 vLineColor;
out vec2 unitPosition;
out float innerUnitRadius;
out float outerRadiusPixels;
void main(void) {
geometry.worldPosition = instancePositions;
outerRadiusPixels = clamp(
project_size_to_pixel(scatterplot.radiusScale * instanceRadius, scatterplot.radiusUnits),
scatterplot.radiusMinPixels, scatterplot.radiusMaxPixels
);
float lineWidthPixels = clamp(
project_size_to_pixel(scatterplot.lineWidthScale * instanceLineWidths, scatterplot.lineWidthUnits),
scatterplot.lineWidthMinPixels, scatterplot.lineWidthMaxPixels
);
outerRadiusPixels += scatterplot.stroked * lineWidthPixels / 2.0;
float edgePadding = scatterplot.antialiasing ? (outerRadiusPixels + SMOOTH_EDGE_RADIUS) / outerRadiusPixels : 1.0;
unitPosition = edgePadding * positions.xy;
geometry.uv = unitPosition;
geometry.pickingColor = instancePickingColors;
innerUnitRadius = 1.0 - scatterplot.stroked * lineWidthPixels / outerRadiusPixels;
if (scatterplot.billboard) {
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
vec3 offset = edgePadding * positions * outerRadiusPixels;
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
} else {
vec3 offset = edgePadding * positions * project_pixel_size(outerRadiusPixels);
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset, geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
}
vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * layer.opacity);
DECKGL_FILTER_COLOR(vFillColor, geometry);
vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * layer.opacity);
DECKGL_FILTER_COLOR(vLineColor, geometry);
}
`,xD=`#version 300 es
#define SHADER_NAME scatterplot-layer-fragment-shader
precision highp float;
in vec4 vFillColor;
in vec4 vLineColor;
in vec2 unitPosition;
in float innerUnitRadius;
in float outerRadiusPixels;
out vec4 fragColor;
void main(void) {
geometry.uv = unitPosition;
float distToCenter = length(unitPosition) * outerRadiusPixels;
float inCircle = scatterplot.antialiasing ?
smoothedge(distToCenter, outerRadiusPixels) :
step(distToCenter, outerRadiusPixels);
if (inCircle == 0.0) {
discard;
}
if (scatterplot.stroked > 0.5) {
float isLine = scatterplot.antialiasing ?
smoothedge(innerUnitRadius * outerRadiusPixels, distToCenter) :
step(innerUnitRadius * outerRadiusPixels, distToCenter);
if (scatterplot.filled > 0.5) {
fragColor = mix(vFillColor, vLineColor, isLine);
} else {
if (isLine == 0.0) {
discard;
}
fragColor = vec4(vLineColor.rgb, vLineColor.a * isLine);
}
} else if (scatterplot.filled < 0.5) {
discard;
} else {
fragColor = vFillColor;
}
fragColor.a *= inCircle;
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,ED=`// TODO(ibgreen): Hack for Layer uniforms (move to new "color" module?)

struct LayerUniforms {
  opacity: f32,
};

var<private> layer: LayerUniforms = LayerUniforms(1.0);
// @group(0) @binding(1) var<uniform> layer: LayerUniforms;

// Main shaders

struct ScatterplotUniforms {
  radiusScale: f32,
  radiusMinPixels: f32,
  radiusMaxPixels: f32,
  lineWidthScale: f32,
  lineWidthMinPixels: f32,
  lineWidthMaxPixels: f32,
  stroked: f32,
  filled: i32,
  antialiasing: i32,
  billboard: i32,
  radiusUnits: i32,
  lineWidthUnits: i32,
};

struct ConstantAttributeUniforms {
 instancePositions: vec3<f32>,
 instancePositions64Low: vec3<f32>,
 instanceRadius: f32,
 instanceLineWidths: f32,
 instanceFillColors: vec4<f32>,
 instanceLineColors: vec4<f32>,
 instancePickingColors: vec3<f32>,

 instancePositionsConstant: i32,
 instancePositions64LowConstant: i32,
 instanceRadiusConstant: i32,
 instanceLineWidthsConstant: i32,
 instanceFillColorsConstant: i32,
 instanceLineColorsConstant: i32,
 instancePickingColorsConstant: i32
};

@group(0) @binding(2) var<uniform> scatterplot: ScatterplotUniforms;

struct ConstantAttributes {
  instancePositions: vec3<f32>,
  instancePositions64Low: vec3<f32>,
  instanceRadius: f32,
  instanceLineWidths: f32,
  instanceFillColors: vec4<f32>,
  instanceLineColors: vec4<f32>,
  instancePickingColors: vec3<f32>
};

const constants = ConstantAttributes(
  vec3<f32>(0.0),
  vec3<f32>(0.0),
  0.0,
  0.0,
  vec4<f32>(0.0, 0.0, 0.0, 1.0),
  vec4<f32>(0.0, 0.0, 0.0, 1.0),
  vec3<f32>(0.0)
);

struct Attributes {
  @builtin(instance_index) instanceIndex : u32,
  @builtin(vertex_index) vertexIndex : u32,
  @location(0) positions: vec3<f32>,
  @location(1) instancePositions: vec3<f32>,
  @location(2) instancePositions64Low: vec3<f32>,
  @location(3) instanceRadius: f32,
  @location(4) instanceLineWidths: f32,
  @location(5) instanceFillColors: vec4<f32>,
  @location(6) instanceLineColors: vec4<f32>,
  @location(7) instancePickingColors: vec3<f32>
};

struct Varyings {
  @builtin(position) position: vec4<f32>,
  @location(0) vFillColor: vec4<f32>,
  @location(1) vLineColor: vec4<f32>,
  @location(2) unitPosition: vec2<f32>,
  @location(3) innerUnitRadius: f32,
  @location(4) outerRadiusPixels: f32,
};

@vertex
fn vertexMain(attributes: Attributes) -> Varyings {
  var varyings: Varyings;

  // Draw an inline geometry constant array clip space triangle to verify that rendering works.
  // var positions = array<vec2<f32>, 3>(vec2(0.0, 0.5), vec2(-0.5, -0.5), vec2(0.5, -0.5));
  // if (attributes.instanceIndex == 0) {
  //   varyings.position = vec4<f32>(positions[attributes.vertexIndex], 0.0, 1.0);
  //   return varyings;
  // }

  // var geometry: Geometry;
  // geometry.worldPosition = instancePositions;

  // Multiply out radius and clamp to limits
  varyings.outerRadiusPixels = clamp(
    project_unit_size_to_pixel(scatterplot.radiusScale * attributes.instanceRadius, scatterplot.radiusUnits),
    scatterplot.radiusMinPixels, scatterplot.radiusMaxPixels
  );

  // Multiply out line width and clamp to limits
  let lineWidthPixels = clamp(
    project_unit_size_to_pixel(scatterplot.lineWidthScale * attributes.instanceLineWidths, scatterplot.lineWidthUnits),
    scatterplot.lineWidthMinPixels, scatterplot.lineWidthMaxPixels
  );

  // outer radius needs to offset by half stroke width
  varyings.outerRadiusPixels += scatterplot.stroked * lineWidthPixels / 2.0;
  // Expand geometry to accommodate edge smoothing
  let edgePadding = select(
    (varyings.outerRadiusPixels + SMOOTH_EDGE_RADIUS) / varyings.outerRadiusPixels,
    1.0,
    scatterplot.antialiasing != 0
  );

  // position on the containing square in [-1, 1] space
  varyings.unitPosition = edgePadding * attributes.positions.xy;
  geometry.uv = varyings.unitPosition;
  geometry.pickingColor = attributes.instancePickingColors;

  varyings.innerUnitRadius = 1.0 - scatterplot.stroked * lineWidthPixels / varyings.outerRadiusPixels;

  if (scatterplot.billboard != 0) {
    varyings.position = project_position_to_clipspace(attributes.instancePositions, attributes.instancePositions64Low, vec3<f32>(0.0)); // TODO , geometry.position);
    // DECKGL_FILTER_GL_POSITION(varyings.position, geometry);
    let offset = attributes.positions; // * edgePadding * varyings.outerRadiusPixels;
    // DECKGL_FILTER_SIZE(offset, geometry);
    let clipPixels = project_pixel_size_to_clipspace(offset.xy);
    varyings.position.x = clipPixels.x;
    varyings.position.y = clipPixels.y;
  } else {
    let offset = edgePadding * attributes.positions * project_pixel_size_float(varyings.outerRadiusPixels);
    // DECKGL_FILTER_SIZE(offset, geometry);
    varyings.position = project_position_to_clipspace(attributes.instancePositions, attributes.instancePositions64Low, offset); // TODO , geometry.position);
    // DECKGL_FILTER_GL_POSITION(varyings.position, geometry);
  }

  // Apply opacity to instance color, or return instance picking color
  varyings.vFillColor = vec4<f32>(attributes.instanceFillColors.rgb, attributes.instanceFillColors.a * layer.opacity);
  // DECKGL_FILTER_COLOR(varyings.vFillColor, geometry);
  varyings.vLineColor = vec4<f32>(attributes.instanceLineColors.rgb, attributes.instanceLineColors.a * layer.opacity);
  // DECKGL_FILTER_COLOR(varyings.vLineColor, geometry);

  return varyings;
}

@fragment
fn fragmentMain(varyings: Varyings) -> @location(0) vec4<f32> {
  // var geometry: Geometry;
  // geometry.uv = unitPosition;

  let distToCenter = length(varyings.unitPosition) * varyings.outerRadiusPixels;
  let inCircle = select(
    smoothedge(distToCenter, varyings.outerRadiusPixels),
    step(distToCenter, varyings.outerRadiusPixels),
    scatterplot.antialiasing != 0
  );

  if (inCircle == 0.0) {
    // discard;
  }

  var fragColor: vec4<f32>;

  if (scatterplot.stroked != 0) {
    let isLine = select(
      smoothedge(varyings.innerUnitRadius * varyings.outerRadiusPixels, distToCenter),
      step(varyings.innerUnitRadius * varyings.outerRadiusPixels, distToCenter),
      scatterplot.antialiasing != 0
    );

    if (scatterplot.filled != 0) {
      fragColor = mix(varyings.vFillColor, varyings.vLineColor, isLine);
    } else {
      if (isLine == 0.0) {
        // discard;
      }
      fragColor = vec4<f32>(varyings.vLineColor.rgb, varyings.vLineColor.a * isLine);
    }
  } else if (scatterplot.filled == 0) {
    // discard;
  } else {
    fragColor = varyings.vFillColor;
  }

  fragColor.a *= inCircle;
  // DECKGL_FILTER_COLOR(fragColor, geometry);

  return fragColor;
  // return vec4<f32>(0, 0, 1, 1);
}
`,Y_=[0,0,0,255],wD={radiusUnits:"meters",radiusScale:{type:"number",min:0,value:1},radiusMinPixels:{type:"number",min:0,value:0},radiusMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},lineWidthUnits:"meters",lineWidthScale:{type:"number",min:0,value:1},lineWidthMinPixels:{type:"number",min:0,value:0},lineWidthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},stroked:!1,filled:!0,billboard:!1,antialiasing:!0,getPosition:{type:"accessor",value:n=>n.position},getRadius:{type:"accessor",value:1},getFillColor:{type:"accessor",value:Y_},getLineColor:{type:"accessor",value:Y_},getLineWidth:{type:"accessor",value:1},strokeWidth:{deprecatedFor:"getLineWidth"},outline:{deprecatedFor:"stroked"},getColor:{deprecatedFor:["getFillColor","getLineColor"]}};class io extends zs{getShaders(){return super.getShaders({vs:bD,fs:xD,source:ED,modules:[oc,ac,vD]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceRadius:{size:1,transition:!0,accessor:"getRadius",defaultValue:1},instanceFillColors:{size:this.props.colorFormat.length,transition:!0,type:"unorm8",accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:this.props.colorFormat.length,transition:!0,type:"unorm8",accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(t){super.updateState(t),t.changeFlags.extensionsChanged&&(this.state.model?.destroy(),this.state.model=this._getModel(),this.getAttributeManager().invalidateAll())}draw({uniforms:t}){const{radiusUnits:e,radiusScale:r,radiusMinPixels:i,radiusMaxPixels:s,stroked:o,filled:a,billboard:l,antialiasing:c,lineWidthUnits:u,lineWidthScale:h,lineWidthMinPixels:f,lineWidthMaxPixels:d}=this.props,p={stroked:o,filled:a,billboard:l,antialiasing:c,radiusUnits:Gi[e],radiusScale:r,radiusMinPixels:i,radiusMaxPixels:s,lineWidthUnits:Gi[u],lineWidthScale:h,lineWidthMinPixels:f,lineWidthMaxPixels:d},_=this.state.model;_.shaderInputs.setProps({scatterplot:p}),_.draw(this.context.renderPass)}_getModel(){const t=[-1,-1,0,1,-1,0,-1,1,0,1,1,0];return new qr(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new ga({topology:"triangle-strip",attributes:{positions:{size:3,value:new Float32Array(t)}}}),isInstanced:!0})}}io.defaultProps=wD;io.layerName="ScatterplotLayer";const Rx={CLOCKWISE:1,COUNTER_CLOCKWISE:-1};function Nx(n,t,e={}){return SD(n,e)!==t?(TD(n,e),!0):!1}function SD(n,t={}){return Math.sign(CD(n,t))}const q_={x:0,y:1,z:2};function CD(n,t={}){const{start:e=0,end:r=n.length,plane:i="xy"}=t,s=t.size||2;let o=0;const a=q_[i[0]],l=q_[i[1]];for(let c=e,u=r-s;c<r;c+=s)o+=(n[c+a]-n[u+a])*(n[c+l]+n[u+l]),u=c;return o/2}function TD(n,t){const{start:e=0,end:r=n.length,size:i=2}=t,s=(r-e)/i,o=Math.floor(s/2);for(let a=0;a<o;++a){const l=e+a*i,c=e+(s-1-a)*i;for(let u=0;u<i;++u){const h=n[l+u];n[l+u]=n[c+u],n[c+u]=h}}}function Xr(n,t){const e=t.length,r=n.length;if(r>0){let i=!0;for(let s=0;s<e;s++)if(n[r-e+s]!==t[s]){i=!1;break}if(i)return!1}for(let i=0;i<e;i++)n[r+i]=t[i];return!0}function Ud(n,t){const e=t.length;for(let r=0;r<e;r++)n[r]=t[r]}function Nl(n,t,e,r,i=[]){const s=r+t*e;for(let o=0;o<e;o++)i[o]=n[s+o];return i}function Vd(n,t,e,r,i=[]){let s,o;if(e&8)s=(r[3]-n[1])/(t[1]-n[1]),o=3;else if(e&4)s=(r[1]-n[1])/(t[1]-n[1]),o=1;else if(e&2)s=(r[2]-n[0])/(t[0]-n[0]),o=2;else if(e&1)s=(r[0]-n[0])/(t[0]-n[0]),o=0;else return null;for(let a=0;a<n.length;a++)i[a]=(o&1)===a?r[o]:s*(t[a]-n[a])+n[a];return i}function uu(n,t){let e=0;return n[0]<t[0]?e|=1:n[0]>t[2]&&(e|=2),n[1]<t[1]?e|=4:n[1]>t[3]&&(e|=8),e}function Ox(n,t){const{size:e=2,broken:r=!1,gridResolution:i=10,gridOffset:s=[0,0],startIndex:o=0,endIndex:a=n.length}=t||{},l=(a-o)/e;let c=[];const u=[c],h=Nl(n,0,e,o);let f,d;const p=Lx(h,i,s,[]),_=[];Xr(c,h);for(let v=1;v<l;v++){for(f=Nl(n,v,e,o,f),d=uu(f,p);d;){Vd(h,f,d,p,_);const E=uu(_,p);E&&(Vd(h,_,E,p,_),d=E),Xr(c,_),Ud(h,_),ID(p,i,d),r&&c.length>e&&(c=[],u.push(c),Xr(c,h)),d=uu(f,p)}Xr(c,f),Ud(h,f)}return r?u:u[0]}const K_=0,PD=1;function Dx(n,t=null,e){if(!n.length)return[];const{size:r=2,gridResolution:i=10,gridOffset:s=[0,0],edgeTypes:o=!1}=e||{},a=[],l=[{pos:n,types:o?new Array(n.length/r).fill(PD):null,holes:t||[]}],c=[[],[]];let u=[];for(;l.length;){const{pos:h,types:f,holes:d}=l.shift();AD(h,r,d[0]||h.length,c),u=Lx(c[0],i,s,u);const p=uu(c[1],u);if(p){let _=Z_(h,f,r,0,d[0]||h.length,u,p);const v={pos:_[0].pos,types:_[0].types,holes:[]},E={pos:_[1].pos,types:_[1].types,holes:[]};l.push(v,E);for(let m=0;m<d.length;m++)_=Z_(h,f,r,d[m],d[m+1]||h.length,u,p),_[0]&&(v.holes.push(v.pos.length),v.pos=Bc(v.pos,_[0].pos),o&&(v.types=Bc(v.types,_[0].types))),_[1]&&(E.holes.push(E.pos.length),E.pos=Bc(E.pos,_[1].pos),o&&(E.types=Bc(E.types,_[1].types)))}else{const _={positions:h};o&&(_.edgeTypes=f),d.length&&(_.holeIndices=d),a.push(_)}}return a}function Z_(n,t,e,r,i,s,o){const a=(i-r)/e,l=[],c=[],u=[],h=[],f=[];let d,p,_;const v=Nl(n,a-1,e,r);let E=Math.sign(o&8?v[1]-s[3]:v[0]-s[2]),m=t&&t[a-1],g=0,y=0;for(let b=0;b<a;b++)d=Nl(n,b,e,r,d),p=Math.sign(o&8?d[1]-s[3]:d[0]-s[2]),_=t&&t[r/e+b],p&&E&&E!==p&&(Vd(v,d,o,s,f),Xr(l,f)&&u.push(m),Xr(c,f)&&h.push(m)),p<=0?(Xr(l,d)&&u.push(_),g-=p):u.length&&(u[u.length-1]=K_),p>=0?(Xr(c,d)&&h.push(_),y+=p):h.length&&(h[h.length-1]=K_),Ud(v,d),E=p,m=_;return[g?{pos:l,types:t&&u}:null,y?{pos:c,types:t&&h}:null]}function Lx(n,t,e,r){const i=Math.floor((n[0]-e[0])/t)*t+e[0],s=Math.floor((n[1]-e[1])/t)*t+e[1];return r[0]=i,r[1]=s,r[2]=i+t,r[3]=s+t,r}function ID(n,t,e){e&8?(n[1]+=t,n[3]+=t):e&4?(n[1]-=t,n[3]-=t):e&2?(n[0]+=t,n[2]+=t):e&1&&(n[0]-=t,n[2]-=t)}function AD(n,t,e,r){let i=1/0,s=-1/0,o=1/0,a=-1/0;for(let l=0;l<e;l+=t){const c=n[l],u=n[l+1];i=c<i?c:i,s=c>s?c:s,o=u<o?u:o,a=u>a?u:a}return r[0][0]=i,r[0][1]=o,r[1][0]=s,r[1][1]=a,r}function Bc(n,t){for(let e=0;e<t.length;e++)n.push(t[e]);return n}const MD=85.051129;function RD(n,t){const{size:e=2,startIndex:r=0,endIndex:i=n.length,normalize:s=!0}=t||{},o=n.slice(r,i);kx(o,e,0,i-r);const a=Ox(o,{size:e,broken:!0,gridResolution:360,gridOffset:[-180,-180]});if(s)for(const l of a)Fx(l,e);return a}function ND(n,t=null,e){const{size:r=2,normalize:i=!0,edgeTypes:s=!1}=e||{};t=t||[];const o=[],a=[];let l=0,c=0;for(let h=0;h<=t.length;h++){const f=t[h]||n.length,d=c,p=OD(n,r,l,f);for(let _=p;_<f;_++)o[c++]=n[_];for(let _=l;_<p;_++)o[c++]=n[_];kx(o,r,d,c),DD(o,r,d,c,e?.maxLatitude),l=f,a[h]=c}a.pop();const u=Dx(o,a,{size:r,gridResolution:360,gridOffset:[-180,-180],edgeTypes:s});if(i)for(const h of u)Fx(h.positions,r);return u}function OD(n,t,e,r){let i=-1,s=-1;for(let o=e+1;o<r;o+=t){const a=Math.abs(n[o]);a>i&&(i=a,s=o-1)}return s}function DD(n,t,e,r,i=MD){const s=n[e],o=n[r-t];if(Math.abs(s-o)>180){const a=Nl(n,0,t,e);a[0]+=Math.round((o-s)/360)*360,Xr(n,a),a[1]=Math.sign(a[1])*i,Xr(n,a),a[0]=s,Xr(n,a)}}function kx(n,t,e,r){let i=n[0],s;for(let o=e;o<r;o+=t){s=n[o];const a=s-i;(a>180||a<-180)&&(s-=Math.round(a/360)*360),n[o]=i=s}}function Fx(n,t){let e;const r=n.length/t;for(let s=0;s<r&&(e=n[s*t],(e+180)%360===0);s++);const i=-Math.round(e/360)*360;if(i!==0)for(let s=0;s<r;s++)n[s*t]+=i}function LD(n,t,e,r){let i;if(Array.isArray(n[0])){const s=n.length*t;i=new Array(s);for(let o=0;o<n.length;o++)for(let a=0;a<t;a++)i[o*t+a]=n[o][a]||0}else i=n;return e?Ox(i,{size:t,gridResolution:e}):r?RD(i,{size:t}):i}const kD=1,FD=2,Df=4;class BD extends Ax{constructor(t){super({...t,attributes:{positions:{size:3,padding:18,initialize:!0,type:t.fp64?Float64Array:Float32Array},segmentTypes:{size:1,type:Uint8ClampedArray}}})}get(t){return this.attributes[t]}getGeometryFromBuffer(t){return this.normalize?super.getGeometryFromBuffer(t):null}normalizeGeometry(t){return this.normalize?LD(t,this.positionSize,this.opts.resolution,this.opts.wrapLongitude):t}getGeometrySize(t){if(J_(t)){let r=0;for(const i of t)r+=this.getGeometrySize(i);return r}const e=this.getPathLength(t);return e<2?0:this.isClosed(t)?e<3?0:e+2:e}updateGeometryAttributes(t,e){if(e.geometrySize!==0)if(t&&J_(t))for(const r of t){const i=this.getGeometrySize(r);e.geometrySize=i,this.updateGeometryAttributes(r,e),e.vertexStart+=i}else this._updateSegmentTypes(t,e),this._updatePositions(t,e)}_updateSegmentTypes(t,e){const r=this.attributes.segmentTypes,i=t?this.isClosed(t):!1,{vertexStart:s,geometrySize:o}=e;r.fill(0,s,s+o),i?(r[s]=Df,r[s+o-2]=Df):(r[s]+=kD,r[s+o-2]+=FD),r[s+o-1]=Df}_updatePositions(t,e){const{positions:r}=this.attributes;if(!r||!t)return;const{vertexStart:i,geometrySize:s}=e,o=new Array(3);for(let a=i,l=0;l<s;a++,l++)this.getPointOnPath(t,l,o),r[a*3]=o[0],r[a*3+1]=o[1],r[a*3+2]=o[2]}getPathLength(t){return t.length/this.positionSize}getPointOnPath(t,e,r=[]){const{positionSize:i}=this;e*i>=t.length&&(e+=1-t.length/i);const s=e*i;return r[0]=t[s],r[1]=t[s+1],r[2]=i===3&&t[s+2]||0,r}isClosed(t){if(!this.normalize)return!!this.opts.loop;const{positionSize:e}=this,r=t.length-e;return t[0]===t[r]&&t[1]===t[r+1]&&(e===2||t[2]===t[r+2])}}function J_(n){return Array.isArray(n[0])}const Q_=`uniform pathUniforms {
  float widthScale;
  float widthMinPixels;
  float widthMaxPixels;
  float jointType;
  float capType;
  float miterLimit;
  bool billboard;
  highp int widthUnits;
} path;
`,UD={name:"path",vs:Q_,fs:Q_,uniformTypes:{widthScale:"f32",widthMinPixels:"f32",widthMaxPixels:"f32",jointType:"f32",capType:"f32",miterLimit:"f32",billboard:"f32",widthUnits:"i32"}},VD=`#version 300 es
#define SHADER_NAME path-layer-vertex-shader
in vec2 positions;
in float instanceTypes;
in vec3 instanceStartPositions;
in vec3 instanceEndPositions;
in vec3 instanceLeftPositions;
in vec3 instanceRightPositions;
in vec3 instanceLeftPositions64Low;
in vec3 instanceStartPositions64Low;
in vec3 instanceEndPositions64Low;
in vec3 instanceRightPositions64Low;
in float instanceStrokeWidths;
in vec4 instanceColors;
in vec3 instancePickingColors;
uniform float opacity;
out vec4 vColor;
out vec2 vCornerOffset;
out float vMiterLength;
out vec2 vPathPosition;
out float vPathLength;
out float vJointType;
const float EPSILON = 0.001;
const vec3 ZERO_OFFSET = vec3(0.0);
float flipIfTrue(bool flag) {
return -(float(flag) * 2. - 1.);
}
vec3 getLineJoinOffset(
vec3 prevPoint, vec3 currPoint, vec3 nextPoint,
vec2 width
) {
bool isEnd = positions.x > 0.0;
float sideOfPath = positions.y;
float isJoint = float(sideOfPath == 0.0);
vec3 deltaA3 = (currPoint - prevPoint);
vec3 deltaB3 = (nextPoint - currPoint);
mat3 rotationMatrix;
bool needsRotation = !path.billboard && project_needs_rotation(currPoint, rotationMatrix);
if (needsRotation) {
deltaA3 = deltaA3 * rotationMatrix;
deltaB3 = deltaB3 * rotationMatrix;
}
vec2 deltaA = deltaA3.xy / width;
vec2 deltaB = deltaB3.xy / width;
float lenA = length(deltaA);
float lenB = length(deltaB);
vec2 dirA = lenA > 0. ? normalize(deltaA) : vec2(0.0, 0.0);
vec2 dirB = lenB > 0. ? normalize(deltaB) : vec2(0.0, 0.0);
vec2 perpA = vec2(-dirA.y, dirA.x);
vec2 perpB = vec2(-dirB.y, dirB.x);
vec2 tangent = dirA + dirB;
tangent = length(tangent) > 0. ? normalize(tangent) : perpA;
vec2 miterVec = vec2(-tangent.y, tangent.x);
vec2 dir = isEnd ? dirA : dirB;
vec2 perp = isEnd ? perpA : perpB;
float L = isEnd ? lenA : lenB;
float sinHalfA = abs(dot(miterVec, perp));
float cosHalfA = abs(dot(dirA, miterVec));
float turnDirection = flipIfTrue(dirA.x * dirB.y >= dirA.y * dirB.x);
float cornerPosition = sideOfPath * turnDirection;
float miterSize = 1.0 / max(sinHalfA, EPSILON);
miterSize = mix(
min(miterSize, max(lenA, lenB) / max(cosHalfA, EPSILON)),
miterSize,
step(0.0, cornerPosition)
);
vec2 offsetVec = mix(miterVec * miterSize, perp, step(0.5, cornerPosition))
* (sideOfPath + isJoint * turnDirection);
bool isStartCap = lenA == 0.0 || (!isEnd && (instanceTypes == 1.0 || instanceTypes == 3.0));
bool isEndCap = lenB == 0.0 || (isEnd && (instanceTypes == 2.0 || instanceTypes == 3.0));
bool isCap = isStartCap || isEndCap;
if (isCap) {
offsetVec = mix(perp * sideOfPath, dir * path.capType * 4.0 * flipIfTrue(isStartCap), isJoint);
vJointType = path.capType;
} else {
vJointType = path.jointType;
}
vPathLength = L;
vCornerOffset = offsetVec;
vMiterLength = dot(vCornerOffset, miterVec * turnDirection);
vMiterLength = isCap ? isJoint : vMiterLength;
vec2 offsetFromStartOfPath = vCornerOffset + deltaA * float(isEnd);
vPathPosition = vec2(
dot(offsetFromStartOfPath, perp),
dot(offsetFromStartOfPath, dir)
);
geometry.uv = vPathPosition;
float isValid = step(instanceTypes, 3.5);
vec3 offset = vec3(offsetVec * width * isValid, 0.0);
if (needsRotation) {
offset = rotationMatrix * offset;
}
return offset;
}
void clipLine(inout vec4 position, vec4 refPosition) {
if (position.w < EPSILON) {
float r = (EPSILON - refPosition.w) / (position.w - refPosition.w);
position = refPosition + (position - refPosition) * r;
}
}
void main() {
geometry.pickingColor = instancePickingColors;
vColor = vec4(instanceColors.rgb, instanceColors.a * layer.opacity);
float isEnd = positions.x;
vec3 prevPosition = mix(instanceLeftPositions, instanceStartPositions, isEnd);
vec3 prevPosition64Low = mix(instanceLeftPositions64Low, instanceStartPositions64Low, isEnd);
vec3 currPosition = mix(instanceStartPositions, instanceEndPositions, isEnd);
vec3 currPosition64Low = mix(instanceStartPositions64Low, instanceEndPositions64Low, isEnd);
vec3 nextPosition = mix(instanceEndPositions, instanceRightPositions, isEnd);
vec3 nextPosition64Low = mix(instanceEndPositions64Low, instanceRightPositions64Low, isEnd);
geometry.worldPosition = currPosition;
vec2 widthPixels = vec2(clamp(
project_size_to_pixel(instanceStrokeWidths * path.widthScale, path.widthUnits),
path.widthMinPixels, path.widthMaxPixels) / 2.0);
vec3 width;
if (path.billboard) {
vec4 prevPositionScreen = project_position_to_clipspace(prevPosition, prevPosition64Low, ZERO_OFFSET);
vec4 currPositionScreen = project_position_to_clipspace(currPosition, currPosition64Low, ZERO_OFFSET, geometry.position);
vec4 nextPositionScreen = project_position_to_clipspace(nextPosition, nextPosition64Low, ZERO_OFFSET);
clipLine(prevPositionScreen, currPositionScreen);
clipLine(nextPositionScreen, currPositionScreen);
clipLine(currPositionScreen, mix(nextPositionScreen, prevPositionScreen, isEnd));
width = vec3(widthPixels, 0.0);
DECKGL_FILTER_SIZE(width, geometry);
vec3 offset = getLineJoinOffset(
prevPositionScreen.xyz / prevPositionScreen.w,
currPositionScreen.xyz / currPositionScreen.w,
nextPositionScreen.xyz / nextPositionScreen.w,
project_pixel_size_to_clipspace(width.xy)
);
DECKGL_FILTER_GL_POSITION(currPositionScreen, geometry);
gl_Position = vec4(currPositionScreen.xyz + offset * currPositionScreen.w, currPositionScreen.w);
} else {
prevPosition = project_position(prevPosition, prevPosition64Low);
currPosition = project_position(currPosition, currPosition64Low);
nextPosition = project_position(nextPosition, nextPosition64Low);
width = vec3(project_pixel_size(widthPixels), 0.0);
DECKGL_FILTER_SIZE(width, geometry);
vec3 offset = getLineJoinOffset(prevPosition, currPosition, nextPosition, width.xy);
geometry.position = vec4(currPosition + offset, 1.0);
gl_Position = project_common_position_to_clipspace(geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
}
DECKGL_FILTER_COLOR(vColor, geometry);
}
`,zD=`#version 300 es
#define SHADER_NAME path-layer-fragment-shader
precision highp float;
in vec4 vColor;
in vec2 vCornerOffset;
in float vMiterLength;
in vec2 vPathPosition;
in float vPathLength;
in float vJointType;
out vec4 fragColor;
void main(void) {
geometry.uv = vPathPosition;
if (vPathPosition.y < 0.0 || vPathPosition.y > vPathLength) {
if (vJointType > 0.5 && length(vCornerOffset) > 1.0) {
discard;
}
if (vJointType < 0.5 && vMiterLength > path.miterLimit + 1.0) {
discard;
}
}
fragColor = vColor;
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,Bx=[0,0,0,255],WD={widthUnits:"meters",widthScale:{type:"number",min:0,value:1},widthMinPixels:{type:"number",min:0,value:0},widthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},jointRounded:!1,capRounded:!1,miterLimit:{type:"number",min:0,value:4},billboard:!1,_pathType:null,getPath:{type:"accessor",value:n=>n.path},getColor:{type:"accessor",value:Bx},getWidth:{type:"accessor",value:1},rounded:{deprecatedFor:["jointRounded","capRounded"]}},Lf={enter:(n,t)=>t.length?t.subarray(t.length-n.length):n};class $a extends zs{getShaders(){return super.getShaders({vs:VD,fs:zD,modules:[oc,ac,UD]})}get wrapLongitude(){return!1}getBounds(){return this.getAttributeManager()?.getBounds(["vertexPositions"])}initializeState(){this.getAttributeManager().addInstanced({vertexPositions:{size:3,vertexOffset:1,type:"float64",fp64:this.use64bitPositions(),transition:Lf,accessor:"getPath",update:this.calculatePositions,noAlloc:!0,shaderAttributes:{instanceLeftPositions:{vertexOffset:0},instanceStartPositions:{vertexOffset:1},instanceEndPositions:{vertexOffset:2},instanceRightPositions:{vertexOffset:3}}},instanceTypes:{size:1,type:"uint8",update:this.calculateSegmentTypes,noAlloc:!0},instanceStrokeWidths:{size:1,accessor:"getWidth",transition:Lf,defaultValue:1},instanceColors:{size:this.props.colorFormat.length,type:"unorm8",accessor:"getColor",transition:Lf,defaultValue:Bx},instancePickingColors:{size:4,type:"uint8",accessor:(r,{index:i,target:s})=>this.encodePickingColor(r&&r.__source?r.__source.index:i,s)}}),this.setState({pathTesselator:new BD({fp64:this.use64bitPositions()})})}updateState(t){super.updateState(t);const{props:e,changeFlags:r}=t,i=this.getAttributeManager();if(r.dataChanged||r.updateTriggersChanged&&(r.updateTriggersChanged.all||r.updateTriggersChanged.getPath)){const{pathTesselator:o}=this.state,a=e.data.attributes||{};o.updateGeometry({data:e.data,geometryBuffer:a.getPath,buffers:a,normalize:!e._pathType,loop:e._pathType==="loop",getGeometry:e.getPath,positionFormat:e.positionFormat,wrapLongitude:e.wrapLongitude,resolution:this.context.viewport.resolution,dataChanged:r.dataChanged}),this.setState({numInstances:o.instanceCount,startIndices:o.vertexStarts}),r.dataChanged||i.invalidateAll()}r.extensionsChanged&&(this.state.model?.destroy(),this.state.model=this._getModel(),i.invalidateAll())}getPickingInfo(t){const e=super.getPickingInfo(t),{index:r}=e,i=this.props.data;return i[0]&&i[0].__source&&(e.object=i.find(s=>s.__source.index===r)),e}disablePickingIndex(t){const e=this.props.data;if(e[0]&&e[0].__source)for(let r=0;r<e.length;r++)e[r].__source.index===t&&this._disablePickingIndex(r);else super.disablePickingIndex(t)}draw({uniforms:t}){const{jointRounded:e,capRounded:r,billboard:i,miterLimit:s,widthUnits:o,widthScale:a,widthMinPixels:l,widthMaxPixels:c}=this.props,u=this.state.model,h={jointType:Number(e),capType:Number(r),billboard:i,widthUnits:Gi[o],widthScale:a,miterLimit:s,widthMinPixels:l,widthMaxPixels:c};u.shaderInputs.setProps({path:h}),u.draw(this.context.renderPass)}_getModel(){const t=[0,1,2,1,4,2,1,3,4,3,5,4],e=[0,0,0,-1,0,1,1,-1,1,1,1,0];return new qr(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new ga({topology:"triangle-list",attributes:{indices:new Uint16Array(t),positions:{value:new Float32Array(e),size:2}}}),isInstanced:!0})}calculatePositions(t){const{pathTesselator:e}=this.state;t.startIndices=e.vertexStarts,t.value=e.get("positions")}calculateSegmentTypes(t){const{pathTesselator:e}=this.state;t.startIndices=e.vertexStarts,t.value=e.get("segmentTypes")}}$a.defaultProps=WD;$a.layerName="PathLayer";var Uc={exports:{}},ty;function HD(){if(ty)return Uc.exports;ty=1,Uc.exports=n,Uc.exports.default=n;function n(C,R,D){D=D||2;var H=R&&R.length,K=H?R[0]*D:C.length,G=t(C,0,K,D,!0),Y=[];if(!G||G.next===G.prev)return Y;var J,ut,at,Ft,Et,ht,Gt;if(H&&(G=l(C,R,G,D)),C.length>80*D){J=at=C[0],ut=Ft=C[1];for(var Rt=D;Rt<K;Rt+=D)Et=C[Rt],ht=C[Rt+1],Et<J&&(J=Et),ht<ut&&(ut=ht),Et>at&&(at=Et),ht>Ft&&(Ft=ht);Gt=Math.max(at-J,Ft-ut),Gt=Gt!==0?32767/Gt:0}return r(G,Y,D,J,ut,Gt,0),Y}function t(C,R,D,H,K){var G,Y;if(K===V(C,R,D,H)>0)for(G=R;G<D;G+=H)Y=L(G,C[G],C[G+1],Y);else for(G=D-H;G>=R;G-=H)Y=L(G,C[G],C[G+1],Y);return Y&&y(Y,Y.next)&&(O(Y),Y=Y.next),Y}function e(C,R){if(!C)return C;R||(R=C);var D=C,H;do if(H=!1,!D.steiner&&(y(D,D.next)||g(D.prev,D,D.next)===0)){if(O(D),D=R=D.prev,D===D.next)break;H=!0}else D=D.next;while(H||D!==R);return R}function r(C,R,D,H,K,G,Y){if(C){!Y&&G&&d(C,H,K,G);for(var J=C,ut,at;C.prev!==C.next;){if(ut=C.prev,at=C.next,G?s(C,H,K,G):i(C)){R.push(ut.i/D|0),R.push(C.i/D|0),R.push(at.i/D|0),O(C),C=at.next,J=at.next;continue}if(C=at,C===J){Y?Y===1?(C=o(e(C),R,D),r(C,R,D,H,K,G,2)):Y===2&&a(C,R,D,H,K,G):r(e(C),R,D,H,K,G,1);break}}}}function i(C){var R=C.prev,D=C,H=C.next;if(g(R,D,H)>=0)return!1;for(var K=R.x,G=D.x,Y=H.x,J=R.y,ut=D.y,at=H.y,Ft=K<G?K<Y?K:Y:G<Y?G:Y,Et=J<ut?J<at?J:at:ut<at?ut:at,ht=K>G?K>Y?K:Y:G>Y?G:Y,Gt=J>ut?J>at?J:at:ut>at?ut:at,Rt=H.next;Rt!==R;){if(Rt.x>=Ft&&Rt.x<=ht&&Rt.y>=Et&&Rt.y<=Gt&&E(K,J,G,ut,Y,at,Rt.x,Rt.y)&&g(Rt.prev,Rt,Rt.next)>=0)return!1;Rt=Rt.next}return!0}function s(C,R,D,H){var K=C.prev,G=C,Y=C.next;if(g(K,G,Y)>=0)return!1;for(var J=K.x,ut=G.x,at=Y.x,Ft=K.y,Et=G.y,ht=Y.y,Gt=J<ut?J<at?J:at:ut<at?ut:at,Rt=Ft<Et?Ft<ht?Ft:ht:Et<ht?Et:ht,ui=J>ut?J>at?J:at:ut>at?ut:at,$s=Ft>Et?Ft>ht?Ft:ht:Et>ht?Et:ht,Bi=_(Gt,Rt,R,D,H),vc=_(ui,$s,R,D,H),Dt=C.prevZ,Lt=C.nextZ;Dt&&Dt.z>=Bi&&Lt&&Lt.z<=vc;){if(Dt.x>=Gt&&Dt.x<=ui&&Dt.y>=Rt&&Dt.y<=$s&&Dt!==K&&Dt!==Y&&E(J,Ft,ut,Et,at,ht,Dt.x,Dt.y)&&g(Dt.prev,Dt,Dt.next)>=0||(Dt=Dt.prevZ,Lt.x>=Gt&&Lt.x<=ui&&Lt.y>=Rt&&Lt.y<=$s&&Lt!==K&&Lt!==Y&&E(J,Ft,ut,Et,at,ht,Lt.x,Lt.y)&&g(Lt.prev,Lt,Lt.next)>=0))return!1;Lt=Lt.nextZ}for(;Dt&&Dt.z>=Bi;){if(Dt.x>=Gt&&Dt.x<=ui&&Dt.y>=Rt&&Dt.y<=$s&&Dt!==K&&Dt!==Y&&E(J,Ft,ut,Et,at,ht,Dt.x,Dt.y)&&g(Dt.prev,Dt,Dt.next)>=0)return!1;Dt=Dt.prevZ}for(;Lt&&Lt.z<=vc;){if(Lt.x>=Gt&&Lt.x<=ui&&Lt.y>=Rt&&Lt.y<=$s&&Lt!==K&&Lt!==Y&&E(J,Ft,ut,Et,at,ht,Lt.x,Lt.y)&&g(Lt.prev,Lt,Lt.next)>=0)return!1;Lt=Lt.nextZ}return!0}function o(C,R,D){var H=C;do{var K=H.prev,G=H.next.next;!y(K,G)&&b(K,H,H.next,G)&&I(K,G)&&I(G,K)&&(R.push(K.i/D|0),R.push(H.i/D|0),R.push(G.i/D|0),O(H),O(H.next),H=C=G),H=H.next}while(H!==C);return e(H)}function a(C,R,D,H,K,G){var Y=C;do{for(var J=Y.next.next;J!==Y.prev;){if(Y.i!==J.i&&m(Y,J)){var ut=M(Y,J);Y=e(Y,Y.next),ut=e(ut,ut.next),r(Y,R,D,H,K,G,0),r(ut,R,D,H,K,G,0);return}J=J.next}Y=Y.next}while(Y!==C)}function l(C,R,D,H){var K=[],G,Y,J,ut,at;for(G=0,Y=R.length;G<Y;G++)J=R[G]*H,ut=G<Y-1?R[G+1]*H:C.length,at=t(C,J,ut,H,!1),at===at.next&&(at.steiner=!0),K.push(v(at));for(K.sort(c),G=0;G<K.length;G++)D=u(K[G],D);return D}function c(C,R){return C.x-R.x}function u(C,R){var D=h(C,R);if(!D)return R;var H=M(D,C);return e(H,H.next),e(D,D.next)}function h(C,R){var D=R,H=C.x,K=C.y,G=-1/0,Y;do{if(K<=D.y&&K>=D.next.y&&D.next.y!==D.y){var J=D.x+(K-D.y)*(D.next.x-D.x)/(D.next.y-D.y);if(J<=H&&J>G&&(G=J,Y=D.x<D.next.x?D:D.next,J===H))return Y}D=D.next}while(D!==R);if(!Y)return null;var ut=Y,at=Y.x,Ft=Y.y,Et=1/0,ht;D=Y;do H>=D.x&&D.x>=at&&H!==D.x&&E(K<Ft?H:G,K,at,Ft,K<Ft?G:H,K,D.x,D.y)&&(ht=Math.abs(K-D.y)/(H-D.x),I(D,C)&&(ht<Et||ht===Et&&(D.x>Y.x||D.x===Y.x&&f(Y,D)))&&(Y=D,Et=ht)),D=D.next;while(D!==ut);return Y}function f(C,R){return g(C.prev,C,R.prev)<0&&g(R.next,C,C.next)<0}function d(C,R,D,H){var K=C;do K.z===0&&(K.z=_(K.x,K.y,R,D,H)),K.prevZ=K.prev,K.nextZ=K.next,K=K.next;while(K!==C);K.prevZ.nextZ=null,K.prevZ=null,p(K)}function p(C){var R,D,H,K,G,Y,J,ut,at=1;do{for(D=C,C=null,G=null,Y=0;D;){for(Y++,H=D,J=0,R=0;R<at&&(J++,H=H.nextZ,!!H);R++);for(ut=at;J>0||ut>0&&H;)J!==0&&(ut===0||!H||D.z<=H.z)?(K=D,D=D.nextZ,J--):(K=H,H=H.nextZ,ut--),G?G.nextZ=K:C=K,K.prevZ=G,G=K;D=H}G.nextZ=null,at*=2}while(Y>1);return C}function _(C,R,D,H,K){return C=(C-D)*K|0,R=(R-H)*K|0,C=(C|C<<8)&16711935,C=(C|C<<4)&252645135,C=(C|C<<2)&858993459,C=(C|C<<1)&1431655765,R=(R|R<<8)&16711935,R=(R|R<<4)&252645135,R=(R|R<<2)&858993459,R=(R|R<<1)&1431655765,C|R<<1}function v(C){var R=C,D=C;do(R.x<D.x||R.x===D.x&&R.y<D.y)&&(D=R),R=R.next;while(R!==C);return D}function E(C,R,D,H,K,G,Y,J){return(K-Y)*(R-J)>=(C-Y)*(G-J)&&(C-Y)*(H-J)>=(D-Y)*(R-J)&&(D-Y)*(G-J)>=(K-Y)*(H-J)}function m(C,R){return C.next.i!==R.i&&C.prev.i!==R.i&&!S(C,R)&&(I(C,R)&&I(R,C)&&T(C,R)&&(g(C.prev,C,R.prev)||g(C,R.prev,R))||y(C,R)&&g(C.prev,C,C.next)>0&&g(R.prev,R,R.next)>0)}function g(C,R,D){return(R.y-C.y)*(D.x-R.x)-(R.x-C.x)*(D.y-R.y)}function y(C,R){return C.x===R.x&&C.y===R.y}function b(C,R,D,H){var K=w(g(C,R,D)),G=w(g(C,R,H)),Y=w(g(D,H,C)),J=w(g(D,H,R));return!!(K!==G&&Y!==J||K===0&&x(C,D,R)||G===0&&x(C,H,R)||Y===0&&x(D,C,H)||J===0&&x(D,R,H))}function x(C,R,D){return R.x<=Math.max(C.x,D.x)&&R.x>=Math.min(C.x,D.x)&&R.y<=Math.max(C.y,D.y)&&R.y>=Math.min(C.y,D.y)}function w(C){return C>0?1:C<0?-1:0}function S(C,R){var D=C;do{if(D.i!==C.i&&D.next.i!==C.i&&D.i!==R.i&&D.next.i!==R.i&&b(D,D.next,C,R))return!0;D=D.next}while(D!==C);return!1}function I(C,R){return g(C.prev,C,C.next)<0?g(C,R,C.next)>=0&&g(C,C.prev,R)>=0:g(C,R,C.prev)<0||g(C,C.next,R)<0}function T(C,R){var D=C,H=!1,K=(C.x+R.x)/2,G=(C.y+R.y)/2;do D.y>G!=D.next.y>G&&D.next.y!==D.y&&K<(D.next.x-D.x)*(G-D.y)/(D.next.y-D.y)+D.x&&(H=!H),D=D.next;while(D!==C);return H}function M(C,R){var D=new P(C.i,C.x,C.y),H=new P(R.i,R.x,R.y),K=C.next,G=R.prev;return C.next=R,R.prev=C,D.next=K,K.prev=D,H.next=D,D.prev=H,G.next=H,H.prev=G,H}function L(C,R,D,H){var K=new P(C,R,D);return H?(K.next=H.next,K.prev=H,H.next.prev=K,H.next=K):(K.prev=K,K.next=K),K}function O(C){C.next.prev=C.prev,C.prev.next=C.next,C.prevZ&&(C.prevZ.nextZ=C.nextZ),C.nextZ&&(C.nextZ.prevZ=C.prevZ)}function P(C,R,D){this.i=C,this.x=R,this.y=D,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}n.deviation=function(C,R,D,H){var K=R&&R.length,G=K?R[0]*D:C.length,Y=Math.abs(V(C,0,G,D));if(K)for(var J=0,ut=R.length;J<ut;J++){var at=R[J]*D,Ft=J<ut-1?R[J+1]*D:C.length;Y-=Math.abs(V(C,at,Ft,D))}var Et=0;for(J=0;J<H.length;J+=3){var ht=H[J]*D,Gt=H[J+1]*D,Rt=H[J+2]*D;Et+=Math.abs((C[ht]-C[Rt])*(C[Gt+1]-C[ht+1])-(C[ht]-C[Gt])*(C[Rt+1]-C[ht+1]))}return Y===0&&Et===0?0:Math.abs((Et-Y)/Y)};function V(C,R,D,H){for(var K=0,G=R,Y=D-H;G<D;G+=H)K+=(C[Y]-C[G])*(C[G+1]+C[Y+1]),Y=G;return K}return n.flatten=function(C){for(var R=C[0][0].length,D={vertices:[],holes:[],dimensions:R},H=0,K=0;K<C.length;K++){for(var G=0;G<C[K].length;G++)for(var Y=0;Y<R;Y++)D.vertices.push(C[K][G][Y]);K>0&&(H+=C[K-1].length,D.holes.push(H))}return D},Uc.exports}var jD=HD();const $D=_h(jD),Vc=Rx.CLOCKWISE,ey=Rx.COUNTER_CLOCKWISE,vs={};function XD(n){if(n=n&&n.positions||n,!Array.isArray(n)&&!ArrayBuffer.isView(n))throw new Error("invalid polygon")}function fl(n){return"positions"in n?n.positions:n}function hu(n){return"holeIndices"in n?n.holeIndices:null}function GD(n){return Array.isArray(n[0])}function YD(n){return n.length>=1&&n[0].length>=2&&Number.isFinite(n[0][0])}function qD(n){const t=n[0],e=n[n.length-1];return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]}function KD(n,t,e,r){for(let i=0;i<t;i++)if(n[e+i]!==n[r-t+i])return!1;return!0}function ny(n,t,e,r,i){let s=t;const o=e.length;for(let a=0;a<o;a++)for(let l=0;l<r;l++)n[s++]=e[a][l]||0;if(!qD(e))for(let a=0;a<r;a++)n[s++]=e[0][a]||0;return vs.start=t,vs.end=s,vs.size=r,Nx(n,i,vs),s}function ry(n,t,e,r,i=0,s,o){s=s||e.length;const a=s-i;if(a<=0)return t;let l=t;for(let c=0;c<a;c++)n[l++]=e[i+c];if(!KD(e,r,i,s))for(let c=0;c<r;c++)n[l++]=e[i+c];return vs.start=t,vs.end=l,vs.size=r,Nx(n,o,vs),l}function ZD(n,t){XD(n);const e=[],r=[];if("positions"in n){const{positions:i,holeIndices:s}=n;if(s){let o=0;for(let a=0;a<=s.length;a++)o=ry(e,o,i,t,s[a-1],s[a],a===0?Vc:ey),r.push(o);return r.pop(),{positions:e,holeIndices:r}}n=i}if(!GD(n))return ry(e,0,n,t,0,e.length,Vc),e;if(!YD(n)){let i=0;for(const[s,o]of n.entries())i=ny(e,i,o,t,s===0?Vc:ey),r.push(i);return r.pop(),{positions:e,holeIndices:r}}return ny(e,0,n,t,Vc),e}function kf(n,t,e){const r=n.length/3;let i=0;for(let s=0;s<r;s++){const o=(s+1)%r;i+=n[s*3+t]*n[o*3+e],i-=n[o*3+t]*n[s*3+e]}return Math.abs(i/2)}function iy(n,t,e,r){const i=n.length/3;for(let s=0;s<i;s++){const o=s*3,a=n[o+0],l=n[o+1],c=n[o+2];n[o+t]=a,n[o+e]=l,n[o+r]=c}}function JD(n,t,e,r){let i=hu(n);i&&(i=i.map(a=>a/t));let s=fl(n);const o=r&&t===3;if(e){const a=s.length;s=s.slice();const l=[];for(let c=0;c<a;c+=t){l[0]=s[c],l[1]=s[c+1],o&&(l[2]=s[c+2]);const u=e(l);s[c]=u[0],s[c+1]=u[1],o&&(s[c+2]=u[2])}}if(o){const a=kf(s,0,1),l=kf(s,0,2),c=kf(s,1,2);if(!a&&!l&&!c)return[];a>l&&a>c||(l>c?(e||(s=s.slice()),iy(s,0,2,1)):(e||(s=s.slice()),iy(s,2,0,1)))}return $D(s,i,t)}class QD extends Ax{constructor(t){const{fp64:e,IndexType:r=Uint32Array}=t;super({...t,attributes:{positions:{size:3,type:e?Float64Array:Float32Array},vertexValid:{type:Uint16Array,size:1},indices:{type:r,size:1}}})}get(t){const{attributes:e}=this;return t==="indices"?e.indices&&e.indices.subarray(0,this.vertexCount):e[t]}updateGeometry(t){super.updateGeometry(t);const e=this.buffers.indices;if(e)this.vertexCount=(e.value||e).length;else if(this.data&&!this.getGeometry)throw new Error("missing indices buffer")}normalizeGeometry(t){if(this.normalize){const e=ZD(t,this.positionSize);return this.opts.resolution?Dx(fl(e),hu(e),{size:this.positionSize,gridResolution:this.opts.resolution,edgeTypes:!0}):this.opts.wrapLongitude?ND(fl(e),hu(e),{size:this.positionSize,maxLatitude:86,edgeTypes:!0}):e}return t}getGeometrySize(t){if(sy(t)){let e=0;for(const r of t)e+=this.getGeometrySize(r);return e}return fl(t).length/this.positionSize}getGeometryFromBuffer(t){return this.normalize||!this.buffers.indices?super.getGeometryFromBuffer(t):null}updateGeometryAttributes(t,e){if(t&&sy(t))for(const r of t){const i=this.getGeometrySize(r);e.geometrySize=i,this.updateGeometryAttributes(r,e),e.vertexStart+=i,e.indexStart=this.indexStarts[e.geometryIndex+1]}else{const r=t;this._updateIndices(r,e),this._updatePositions(r,e),this._updateVertexValid(r,e)}}_updateIndices(t,{geometryIndex:e,vertexStart:r,indexStart:i}){const{attributes:s,indexStarts:o,typedArrayManager:a}=this;let l=s.indices;if(!l||!t)return;let c=i;const u=JD(t,this.positionSize,this.opts.preproject,this.opts.full3d);l=a.allocate(l,i+u.length,{copy:!0});for(let h=0;h<u.length;h++)l[c++]=u[h]+r;o[e+1]=i+u.length,s.indices=l}_updatePositions(t,{vertexStart:e,geometrySize:r}){const{attributes:{positions:i},positionSize:s}=this;if(!i||!t)return;const o=fl(t);for(let a=e,l=0;l<r;a++,l++){const c=o[l*s],u=o[l*s+1],h=s>2?o[l*s+2]:0;i[a*3]=c,i[a*3+1]=u,i[a*3+2]=h}}_updateVertexValid(t,{vertexStart:e,geometrySize:r}){const{positionSize:i}=this,s=this.attributes.vertexValid,o=t&&hu(t);if(t&&t.edgeTypes?s.set(t.edgeTypes,e):s.fill(1,e,e+r),o)for(let a=0;a<o.length;a++)s[e+o[a]/i-1]=0;s[e+r-1]=0}}function sy(n){return Array.isArray(n)&&n.length>0&&!Number.isFinite(n[0])}const oy=`uniform solidPolygonUniforms {
  bool extruded;
  bool isWireframe;
  float elevationScale;
} solidPolygon;
`,tL={name:"solidPolygon",vs:oy,fs:oy,uniformTypes:{extruded:"f32",isWireframe:"f32",elevationScale:"f32"}},Ux=`in vec4 fillColors;
in vec4 lineColors;
in vec3 pickingColors;
out vec4 vColor;
struct PolygonProps {
vec3 positions;
vec3 positions64Low;
vec3 normal;
float elevations;
};
vec3 project_offset_normal(vec3 vector) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSETS) {
return normalize(vector * project.commonUnitsPerWorldUnit);
}
return project_normal(vector);
}
void calculatePosition(PolygonProps props) {
vec3 pos = props.positions;
vec3 pos64Low = props.positions64Low;
vec3 normal = props.normal;
vec4 colors = solidPolygon.isWireframe ? lineColors : fillColors;
geometry.worldPosition = props.positions;
geometry.pickingColor = pickingColors;
if (solidPolygon.extruded) {
pos.z += props.elevations * solidPolygon.elevationScale;
}
gl_Position = project_position_to_clipspace(pos, pos64Low, vec3(0.), geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
if (solidPolygon.extruded) {
#ifdef IS_SIDE_VERTEX
normal = project_offset_normal(normal);
#else
normal = project_normal(normal);
#endif
geometry.normal = normal;
vec3 lightColor = lighting_getLightColor(colors.rgb, project.cameraPosition, geometry.position.xyz, geometry.normal);
vColor = vec4(lightColor, colors.a * layer.opacity);
} else {
vColor = vec4(colors.rgb, colors.a * layer.opacity);
}
DECKGL_FILTER_COLOR(vColor, geometry);
}
`,eL=`#version 300 es
#define SHADER_NAME solid-polygon-layer-vertex-shader
in vec3 vertexPositions;
in vec3 vertexPositions64Low;
in float elevations;
${Ux}
void main(void) {
PolygonProps props;
props.positions = vertexPositions;
props.positions64Low = vertexPositions64Low;
props.elevations = elevations;
props.normal = vec3(0.0, 0.0, 1.0);
calculatePosition(props);
}
`,nL=`#version 300 es
#define SHADER_NAME solid-polygon-layer-vertex-shader-side
#define IS_SIDE_VERTEX
in vec2 positions;
in vec3 vertexPositions;
in vec3 nextVertexPositions;
in vec3 vertexPositions64Low;
in vec3 nextVertexPositions64Low;
in float elevations;
in float instanceVertexValid;
${Ux}
void main(void) {
if(instanceVertexValid < 0.5){
gl_Position = vec4(0.);
return;
}
PolygonProps props;
vec3 pos;
vec3 pos64Low;
vec3 nextPos;
vec3 nextPos64Low;
#if RING_WINDING_ORDER_CW == 1
pos = vertexPositions;
pos64Low = vertexPositions64Low;
nextPos = nextVertexPositions;
nextPos64Low = nextVertexPositions64Low;
#else
pos = nextVertexPositions;
pos64Low = nextVertexPositions64Low;
nextPos = vertexPositions;
nextPos64Low = vertexPositions64Low;
#endif
props.positions = mix(pos, nextPos, positions.x);
props.positions64Low = mix(pos64Low, nextPos64Low, positions.x);
props.normal = vec3(
pos.y - nextPos.y + (pos64Low.y - nextPos64Low.y),
nextPos.x - pos.x + (nextPos64Low.x - pos64Low.x),
0.0);
props.elevations = elevations * positions.y;
calculatePosition(props);
}
`,rL=`#version 300 es
#define SHADER_NAME solid-polygon-layer-fragment-shader
precision highp float;
in vec4 vColor;
out vec4 fragColor;
void main(void) {
fragColor = vColor;
geometry.uv = vec2(0.);
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,Gu=[0,0,0,255],iL={filled:!0,extruded:!1,wireframe:!1,_normalize:!0,_windingOrder:"CW",_full3d:!1,elevationScale:{type:"number",min:0,value:1},getPolygon:{type:"accessor",value:n=>n.polygon},getElevation:{type:"accessor",value:1e3},getFillColor:{type:"accessor",value:Gu},getLineColor:{type:"accessor",value:Gu},material:!0},zc={enter:(n,t)=>t.length?t.subarray(t.length-n.length):n};class eg extends zs{getShaders(t){return super.getShaders({vs:t==="top"?eL:nL,fs:rL,defines:{RING_WINDING_ORDER_CW:!this.props._normalize&&this.props._windingOrder==="CCW"?0:1},modules:[oc,Pb,ac,tL]})}get wrapLongitude(){return!1}getBounds(){return this.getAttributeManager()?.getBounds(["vertexPositions"])}initializeState(){const{viewport:t}=this.context;let{coordinateSystem:e}=this.props;const{_full3d:r}=this.props;t.isGeospatial&&e===At.DEFAULT&&(e=At.LNGLAT);let i;e===At.LNGLAT&&(r?i=t.projectPosition.bind(t):i=t.projectFlat.bind(t)),this.setState({numInstances:0,polygonTesselator:new QD({preproject:i,fp64:this.use64bitPositions(),IndexType:Uint32Array})});const s=this.getAttributeManager(),o=!0;s.remove(["instancePickingColors"]),s.add({indices:{size:1,isIndexed:!0,update:this.calculateIndices,noAlloc:o},vertexPositions:{size:3,type:"float64",stepMode:"dynamic",fp64:this.use64bitPositions(),transition:zc,accessor:"getPolygon",update:this.calculatePositions,noAlloc:o,shaderAttributes:{nextVertexPositions:{vertexOffset:1}}},instanceVertexValid:{size:1,type:"uint16",stepMode:"instance",update:this.calculateVertexValid,noAlloc:o},elevations:{size:1,stepMode:"dynamic",transition:zc,accessor:"getElevation"},fillColors:{size:this.props.colorFormat.length,type:"unorm8",stepMode:"dynamic",transition:zc,accessor:"getFillColor",defaultValue:Gu},lineColors:{size:this.props.colorFormat.length,type:"unorm8",stepMode:"dynamic",transition:zc,accessor:"getLineColor",defaultValue:Gu},pickingColors:{size:4,type:"uint8",stepMode:"dynamic",accessor:(a,{index:l,target:c})=>this.encodePickingColor(a&&a.__source?a.__source.index:l,c)}})}getPickingInfo(t){const e=super.getPickingInfo(t),{index:r}=e,i=this.props.data;return i[0]&&i[0].__source&&(e.object=i.find(s=>s.__source.index===r)),e}disablePickingIndex(t){const e=this.props.data;if(e[0]&&e[0].__source)for(let r=0;r<e.length;r++)e[r].__source.index===t&&this._disablePickingIndex(r);else super.disablePickingIndex(t)}draw({uniforms:t}){const{extruded:e,filled:r,wireframe:i,elevationScale:s}=this.props,{topModel:o,sideModel:a,wireframeModel:l,polygonTesselator:c}=this.state,u={extruded:!!e,elevationScale:s,isWireframe:!1};l&&i&&(l.setInstanceCount(c.instanceCount-1),l.shaderInputs.setProps({solidPolygon:{...u,isWireframe:!0}}),l.draw(this.context.renderPass)),a&&r&&(a.setInstanceCount(c.instanceCount-1),a.shaderInputs.setProps({solidPolygon:u}),a.draw(this.context.renderPass)),o&&r&&(o.setVertexCount(c.vertexCount),o.shaderInputs.setProps({solidPolygon:u}),o.draw(this.context.renderPass))}updateState(t){super.updateState(t),this.updateGeometry(t);const{props:e,oldProps:r,changeFlags:i}=t,s=this.getAttributeManager();(i.extensionsChanged||e.filled!==r.filled||e.extruded!==r.extruded)&&(this.state.models?.forEach(a=>a.destroy()),this.setState(this._getModels()),s.invalidateAll())}updateGeometry({props:t,oldProps:e,changeFlags:r}){if(r.dataChanged||r.updateTriggersChanged&&(r.updateTriggersChanged.all||r.updateTriggersChanged.getPolygon)){const{polygonTesselator:s}=this.state,o=t.data.attributes||{};s.updateGeometry({data:t.data,normalize:t._normalize,geometryBuffer:o.getPolygon,buffers:o,getGeometry:t.getPolygon,positionFormat:t.positionFormat,wrapLongitude:t.wrapLongitude,resolution:this.context.viewport.resolution,fp64:this.use64bitPositions(),dataChanged:r.dataChanged,full3d:t._full3d}),this.setState({numInstances:s.instanceCount,startIndices:s.vertexStarts}),r.dataChanged||this.getAttributeManager().invalidateAll()}}_getModels(){const{id:t,filled:e,extruded:r}=this.props;let i,s,o;if(e){const a=this.getShaders("top");a.defines.NON_INSTANCED_MODEL=1;const l=this.getAttributeManager().getBufferLayouts({isInstanced:!1});i=new qr(this.context.device,{...a,id:`${t}-top`,topology:"triangle-list",bufferLayout:l,isIndexed:!0,userData:{excludeAttributes:{instanceVertexValid:!0}}})}if(r){const a=this.getAttributeManager().getBufferLayouts({isInstanced:!0});s=new qr(this.context.device,{...this.getShaders("side"),id:`${t}-side`,bufferLayout:a,geometry:new ga({topology:"triangle-strip",attributes:{positions:{size:2,value:new Float32Array([1,0,0,0,1,1,0,1])}}}),isInstanced:!0,userData:{excludeAttributes:{indices:!0}}}),o=new qr(this.context.device,{...this.getShaders("side"),id:`${t}-wireframe`,bufferLayout:a,geometry:new ga({topology:"line-strip",attributes:{positions:{size:2,value:new Float32Array([1,0,0,0,0,1,1,1])}}}),isInstanced:!0,userData:{excludeAttributes:{indices:!0}}})}return{models:[s,o,i].filter(Boolean),topModel:i,sideModel:s,wireframeModel:o}}calculateIndices(t){const{polygonTesselator:e}=this.state;t.startIndices=e.indexStarts,t.value=e.get("indices")}calculatePositions(t){const{polygonTesselator:e}=this.state;t.startIndices=e.vertexStarts,t.value=e.get("positions")}calculateVertexValid(t){t.value=this.state.polygonTesselator.get("vertexValid")}}eg.defaultProps=iL;eg.layerName="SolidPolygonLayer";function sL({data:n,getIndex:t,dataRange:e,replace:r}){const{startRow:i=0,endRow:s=1/0}=e,o=n.length;let a=o,l=o;for(let f=0;f<o;f++){const d=t(n[f]);if(a>f&&d>=i&&(a=f),d>=s){l=f;break}}let c=a;const h=l-a!==r.length?n.slice(l):void 0;for(let f=0;f<r.length;f++)n[c++]=r[f];if(h){for(let f=0;f<h.length;f++)n[c++]=h[f];n.length=c}return{startRow:a,endRow:a+r.length}}function oL(n,t){if(!n)return null;const e="startIndices"in n?n.startIndices[t]:t,r=n.featureIds.value[e];return e!==-1?aL(n,r,e):null}function aL(n,t,e){const r={properties:{...n.properties[t]}};for(const i in n.numericProps)r.properties[i]=n.numericProps[i].value[e];return r}function lL(n,t){const e={points:null,lines:null,polygons:null};for(const r in e){const i=n[r].globalFeatureIds.value;e[r]=new Uint8ClampedArray(i.length*4);const s=[];for(let o=0;o<i.length;o++)t(i[o],s),e[r][o*4+0]=s[0],e[r][o*4+1]=s[1],e[r][o*4+2]=s[2],e[r][o*4+3]=255}return e}const ay=`uniform sdfUniforms {
  float gamma;
  bool enabled;
  float buffer;
  float outlineBuffer;
  vec4 outlineColor;
} sdf;
`,cL={name:"sdf",vs:ay,fs:ay,uniformTypes:{gamma:"f32",enabled:"f32",buffer:"f32",outlineBuffer:"f32",outlineColor:"vec4<f32>"}},uL=`#version 300 es
#define SHADER_NAME multi-icon-layer-fragment-shader
precision highp float;
uniform sampler2D iconsTexture;
in vec4 vColor;
in vec2 vTextureCoords;
in vec2 uv;
out vec4 fragColor;
void main(void) {
geometry.uv = uv;
if (!bool(picking.isActive)) {
float alpha = texture(iconsTexture, vTextureCoords).a;
vec4 color = vColor;
if (sdf.enabled) {
float distance = alpha;
alpha = smoothstep(sdf.buffer - sdf.gamma, sdf.buffer + sdf.gamma, distance);
if (sdf.outlineBuffer > 0.0) {
float inFill = alpha;
float inBorder = smoothstep(sdf.outlineBuffer - sdf.gamma, sdf.outlineBuffer + sdf.gamma, distance);
color = mix(sdf.outlineColor, vColor, inFill);
alpha = inBorder;
}
}
float a = alpha * color.a;
if (a < icon.alphaCutoff) {
discard;
}
fragColor = vec4(color.rgb, a * layer.opacity);
}
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,Ff=192/256,ly=[],hL={getIconOffsets:{type:"accessor",value:n=>n.offsets},alphaCutoff:.001,smoothing:.1,outlineWidth:0,outlineColor:{type:"color",value:[0,0,0,255]}};class ng extends uc{getShaders(){const t=super.getShaders();return{...t,modules:[...t.modules,cL],fs:uL}}initializeState(){super.initializeState(),this.getAttributeManager().addInstanced({instanceOffsets:{size:2,accessor:"getIconOffsets"},instancePickingColors:{type:"uint8",size:3,accessor:(e,{index:r,target:i})=>this.encodePickingColor(r,i)}})}updateState(t){super.updateState(t);const{props:e,oldProps:r}=t;let{outlineColor:i}=e;i!==r.outlineColor&&(i=i.map(s=>s/255),i[3]=Number.isFinite(i[3])?i[3]:1,this.setState({outlineColor:i})),!e.sdf&&e.outlineWidth&&It.warn(`${this.id}: fontSettings.sdf is required to render outline`)()}draw(t){const{sdf:e,smoothing:r,outlineWidth:i}=this.props,{outlineColor:s}=this.state,o=i?Math.max(r,Ff*(1-i)):-1,a=this.state.model,l={buffer:Ff,outlineBuffer:o,gamma:r,enabled:!!e,outlineColor:s};if(a.shaderInputs.setProps({sdf:l}),super.draw(t),e&&i){const{iconManager:c}=this.state;c.getTexture()&&(a.shaderInputs.setProps({sdf:{...l,outlineBuffer:Ff}}),a.draw(this.context.renderPass))}}getInstanceOffset(t){return t?Array.from(t).flatMap(e=>super.getInstanceOffset(e)):ly}getInstanceColorMode(t){return 1}getInstanceIconFrame(t){return t?Array.from(t).flatMap(e=>super.getInstanceIconFrame(e)):ly}}ng.defaultProps=hL;ng.layerName="MultiIconLayer";const Yu=1e20;class fL{constructor({fontSize:t=24,buffer:e=3,radius:r=8,cutoff:i=.25,fontFamily:s="sans-serif",fontWeight:o="normal",fontStyle:a="normal"}={}){this.buffer=e,this.cutoff=i,this.radius=r;const l=this.size=t+e*4,c=this._createCanvas(l),u=this.ctx=c.getContext("2d",{willReadFrequently:!0});u.font=`${a} ${o} ${t}px ${s}`,u.textBaseline="alphabetic",u.textAlign="left",u.fillStyle="black",this.gridOuter=new Float64Array(l*l),this.gridInner=new Float64Array(l*l),this.f=new Float64Array(l),this.z=new Float64Array(l+1),this.v=new Uint16Array(l)}_createCanvas(t){const e=document.createElement("canvas");return e.width=e.height=t,e}draw(t){const{width:e,actualBoundingBoxAscent:r,actualBoundingBoxDescent:i,actualBoundingBoxLeft:s,actualBoundingBoxRight:o}=this.ctx.measureText(t),a=Math.ceil(r),l=0,c=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(o-s))),u=Math.min(this.size-this.buffer,a+Math.ceil(i)),h=c+2*this.buffer,f=u+2*this.buffer,d=Math.max(h*f,0),p=new Uint8ClampedArray(d),_={data:p,width:h,height:f,glyphWidth:c,glyphHeight:u,glyphTop:a,glyphLeft:l,glyphAdvance:e};if(c===0||u===0)return _;const{ctx:v,buffer:E,gridInner:m,gridOuter:g}=this;v.clearRect(E,E,c,u),v.fillText(t,E,E+a);const y=v.getImageData(E,E,c,u);g.fill(Yu,0,d),m.fill(0,0,d);for(let b=0;b<u;b++)for(let x=0;x<c;x++){const w=y.data[4*(b*c+x)+3]/255;if(w===0)continue;const S=(b+E)*h+x+E;if(w===1)g[S]=0,m[S]=Yu;else{const I=.5-w;g[S]=I>0?I*I:0,m[S]=I<0?I*I:0}}cy(g,0,0,h,f,h,this.f,this.v,this.z),cy(m,E,E,c,u,h,this.f,this.v,this.z);for(let b=0;b<d;b++){const x=Math.sqrt(g[b])-Math.sqrt(m[b]);p[b]=Math.round(255-255*(x/this.radius+this.cutoff))}return _}}function cy(n,t,e,r,i,s,o,a,l){for(let c=t;c<t+r;c++)uy(n,e*s+c,s,i,o,a,l);for(let c=e;c<e+i;c++)uy(n,c*s+t,1,r,o,a,l)}function uy(n,t,e,r,i,s,o){s[0]=0,o[0]=-1e20,o[1]=Yu,i[0]=n[t];for(let a=1,l=0,c=0;a<r;a++){i[a]=n[t+a*e];const u=a*a;do{const h=s[l];c=(i[a]-i[h]+u-h*h)/(a-h)/2}while(c<=o[l]&&--l>-1);l++,s[l]=a,o[l]=c,o[l+1]=Yu}for(let a=0,l=0;a<r;a++){for(;o[l+1]<a;)l++;const c=s[l],u=a-c;n[t+a*e]=i[c]+u*u}}const dL=32,pL=[];function gL(n){return Math.pow(2,Math.ceil(Math.log2(n)))}function mL({characterSet:n,getFontWidth:t,fontHeight:e,buffer:r,maxCanvasWidth:i,mapping:s={},xOffset:o=0,yOffset:a=0}){let l=0,c=o;const u=e+r*2;for(const h of n)if(!s[h]){const f=t(h);c+f+r*2>i&&(c=0,l++),s[h]={x:c+r,y:a+l*u+r,width:f,height:u,layoutWidth:f,layoutHeight:e},c+=f+r*2}return{mapping:s,xOffset:c,yOffset:a+l*u,canvasHeight:gL(a+(l+1)*u)}}function Vx(n,t,e,r){let i=0;for(let s=t;s<e;s++){const o=n[s];i+=r[o]?.layoutWidth||0}return i}function zx(n,t,e,r,i,s){let o=t,a=0;for(let l=t;l<e;l++){const c=Vx(n,l,l+1,i);a+c>r&&(o<l&&s.push(l),o=l,a=0),a+=c}return a}function _L(n,t,e,r,i,s){let o=t,a=t,l=t,c=0;for(let u=t;u<e;u++)if((n[u]===" "||n[u+1]===" "||u+1===e)&&(l=u+1),l>a){let h=Vx(n,a,l,i);c+h>r&&(o<a&&(s.push(a),o=a,c=0),h>r&&(h=zx(n,a,l,r,i,s),o=s[s.length-1])),a=l,c+=h}return c}function yL(n,t,e,r,i=0,s){s===void 0&&(s=n.length);const o=[];return t==="break-all"?zx(n,i,s,e,r,o):_L(n,i,s,e,r,o),o}function vL(n,t,e,r,i,s){let o=0,a=0;for(let l=t;l<e;l++){const c=n[l],u=r[c];u?(a||(a=u.layoutHeight),i[l]=o+u.layoutWidth/2,o+=u.layoutWidth):(It.warn(`Missing character: ${c} (${c.codePointAt(0)})`)(),i[l]=o,o+=dL)}s[0]=o,s[1]=a}function bL(n,t,e,r,i){const s=Array.from(n),o=s.length,a=new Array(o),l=new Array(o),c=new Array(o),u=(e==="break-word"||e==="break-all")&&isFinite(r)&&r>0,h=[0,0],f=[0,0];let d=0,p=0,_=0;for(let v=0;v<=o;v++){const E=s[v];if((E===`
`||v===o)&&(_=v),_>p){const m=u?yL(s,e,r,i,p,_):pL;for(let g=0;g<=m.length;g++){const y=g===0?p:m[g-1],b=g<m.length?m[g]:_;vL(s,y,b,i,a,f);for(let x=y;x<b;x++){a[x]-f[0]/2;const w=s[x],S=i[w]?.layoutOffsetY||0;l[x]=d+f[1]/2+S,c[x]=f[0]}d=d+f[1]*t,h[0]=Math.max(h[0],f[0])}p=_}E===`
`&&(a[p]=0,l[p]=0,c[p]=0,p++)}return h[1]=d,{x:a,y:l,rowWidth:c,size:h}}function xL({value:n,length:t,stride:e,offset:r,startIndices:i,characterSet:s}){const o=n.BYTES_PER_ELEMENT,a=e?e/o:1,l=r?r/o:0,c=i[t]||Math.ceil((n.length-l)/a),u=s&&new Set,h=new Array(t);let f=n;if(a>1||l>0){const d=n.constructor;f=new d(c);for(let p=0;p<c;p++)f[p]=n[p*a+l]}for(let d=0;d<t;d++){const p=i[d],_=i[d+1]||c,v=f.subarray(p,_);h[d]=String.fromCodePoint.apply(null,v),u&&v.forEach(u.add,u)}if(u)for(const d of u)s.add(String.fromCodePoint(d));return{texts:h,characterCount:c}}class Wx{constructor(t=5){this._cache={},this._order=[],this.limit=t}get(t){const e=this._cache[t];return e&&(this._deleteOrder(t),this._appendOrder(t)),e}set(t,e){this._cache[t]?(this.delete(t),this._cache[t]=e,this._appendOrder(t)):(Object.keys(this._cache).length===this.limit&&this.delete(this._order[0]),this._cache[t]=e,this._appendOrder(t))}delete(t){this._cache[t]&&(delete this._cache[t],this._deleteOrder(t))}_deleteOrder(t){const e=this._order.indexOf(t);e>=0&&this._order.splice(e,1)}_appendOrder(t){this._order.push(t)}}function EL(){const n=[];for(let t=32;t<128;t++)n.push(String.fromCharCode(t));return n}const oa={fontFamily:"Monaco, monospace",fontWeight:"normal",characterSet:EL(),fontSize:64,buffer:4,sdf:!1,cutoff:.25,radius:12,smoothing:.1},hy=1024,fy=.9,dy=1.2,Hx=3;let qu=new Wx(Hx);function wL(n,t){let e;typeof t=="string"?e=new Set(Array.from(t)):e=new Set(t);const r=qu.get(n);if(!r)return e;for(const i in r.mapping)e.has(i)&&e.delete(i);return e}function SL(n,t){for(let e=0;e<n.length;e++)t.data[4*e+3]=n[e]}function py(n,t,e,r){n.font=`${r} ${e}px ${t}`,n.fillStyle="#000",n.textBaseline="alphabetic",n.textAlign="left"}function CL(n){It.assert(Number.isFinite(n)&&n>=Hx,"Invalid cache limit"),qu=new Wx(n)}class TL{constructor(){this.props={...oa}}get atlas(){return this._atlas}get mapping(){return this._atlas&&this._atlas.mapping}get scale(){const{fontSize:t,buffer:e}=this.props;return(t*dy+e*2)/t}setProps(t={}){Object.assign(this.props,t),this._key=this._getKey();const e=wL(this._key,this.props.characterSet),r=qu.get(this._key);if(r&&e.size===0){this._atlas!==r&&(this._atlas=r);return}const i=this._generateFontAtlas(e,r);this._atlas=i,qu.set(this._key,i)}_generateFontAtlas(t,e){const{fontFamily:r,fontWeight:i,fontSize:s,buffer:o,sdf:a,radius:l,cutoff:c}=this.props;let u=e&&e.data;u||(u=document.createElement("canvas"),u.width=hy);const h=u.getContext("2d",{willReadFrequently:!0});py(h,r,s,i);const{mapping:f,canvasHeight:d,xOffset:p,yOffset:_}=mL({getFontWidth:v=>h.measureText(v).width,fontHeight:s*dy,buffer:o,characterSet:t,maxCanvasWidth:hy,...e&&{mapping:e.mapping,xOffset:e.xOffset,yOffset:e.yOffset}});if(u.height!==d){const v=h.getImageData(0,0,u.width,u.height);u.height=d,h.putImageData(v,0,0)}if(py(h,r,s,i),a){const v=new fL({fontSize:s,buffer:o,radius:l,cutoff:c,fontFamily:r,fontWeight:`${i}`});for(const E of t){const{data:m,width:g,height:y,glyphTop:b}=v.draw(E);f[E].width=g,f[E].layoutOffsetY=s*fy-b;const x=h.createImageData(g,y);SL(m,x),h.putImageData(x,f[E].x,f[E].y)}}else for(const v of t)h.fillText(v,f[v].x,f[v].y+o+s*fy);return{xOffset:p,yOffset:_,mapping:f,data:u,width:u.width,height:u.height}}_getKey(){const{fontFamily:t,fontWeight:e,fontSize:r,buffer:i,sdf:s,radius:o,cutoff:a}=this.props;return s?`${t} ${e} ${r} ${i} ${o} ${a}`:`${t} ${e} ${r} ${i}`}}const gy=`uniform textBackgroundUniforms {
  bool billboard;
  float sizeScale;
  float sizeMinPixels;
  float sizeMaxPixels;
  vec4 borderRadius;
  vec4 padding;
  highp int sizeUnits;
  bool stroked;
} textBackground;
`,PL={name:"textBackground",vs:gy,fs:gy,uniformTypes:{billboard:"f32",sizeScale:"f32",sizeMinPixels:"f32",sizeMaxPixels:"f32",borderRadius:"vec4<f32>",padding:"vec4<f32>",sizeUnits:"i32",stroked:"f32"}},IL=`#version 300 es
#define SHADER_NAME text-background-layer-vertex-shader
in vec2 positions;
in vec3 instancePositions;
in vec3 instancePositions64Low;
in vec4 instanceRects;
in float instanceSizes;
in float instanceAngles;
in vec2 instancePixelOffsets;
in float instanceLineWidths;
in vec4 instanceFillColors;
in vec4 instanceLineColors;
in vec3 instancePickingColors;
out vec4 vFillColor;
out vec4 vLineColor;
out float vLineWidth;
out vec2 uv;
out vec2 dimensions;
vec2 rotate_by_angle(vec2 vertex, float angle) {
float angle_radian = radians(angle);
float cos_angle = cos(angle_radian);
float sin_angle = sin(angle_radian);
mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);
return rotationMatrix * vertex;
}
void main(void) {
geometry.worldPosition = instancePositions;
geometry.uv = positions;
geometry.pickingColor = instancePickingColors;
uv = positions;
vLineWidth = instanceLineWidths;
float sizePixels = clamp(
project_size_to_pixel(instanceSizes * textBackground.sizeScale, textBackground.sizeUnits),
textBackground.sizeMinPixels, textBackground.sizeMaxPixels
);
dimensions = instanceRects.zw * sizePixels + textBackground.padding.xy + textBackground.padding.zw;
vec2 pixelOffset = (positions * instanceRects.zw + instanceRects.xy) * sizePixels + mix(-textBackground.padding.xy, textBackground.padding.zw, positions);
pixelOffset = rotate_by_angle(pixelOffset, instanceAngles);
pixelOffset += instancePixelOffsets;
pixelOffset.y *= -1.0;
if (textBackground.billboard)  {
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
vec3 offset = vec3(pixelOffset, 0.0);
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
} else {
vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);
DECKGL_FILTER_SIZE(offset_common, geometry);
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
}
vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * layer.opacity);
DECKGL_FILTER_COLOR(vFillColor, geometry);
vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * layer.opacity);
DECKGL_FILTER_COLOR(vLineColor, geometry);
}
`,AL=`#version 300 es
#define SHADER_NAME text-background-layer-fragment-shader
precision highp float;
in vec4 vFillColor;
in vec4 vLineColor;
in float vLineWidth;
in vec2 uv;
in vec2 dimensions;
out vec4 fragColor;
float round_rect(vec2 p, vec2 size, vec4 radii) {
vec2 pixelPositionCB = (p - 0.5) * size;
vec2 sizeCB = size * 0.5;
float maxBorderRadius = min(size.x, size.y) * 0.5;
vec4 borderRadius = vec4(min(radii, maxBorderRadius));
borderRadius.xy =
(pixelPositionCB.x > 0.0) ? borderRadius.xy : borderRadius.zw;
borderRadius.x = (pixelPositionCB.y > 0.0) ? borderRadius.x : borderRadius.y;
vec2 q = abs(pixelPositionCB) - sizeCB + borderRadius.x;
return -(min(max(q.x, q.y), 0.0) + length(max(q, 0.0)) - borderRadius.x);
}
float rect(vec2 p, vec2 size) {
vec2 pixelPosition = p * size;
return min(min(pixelPosition.x, size.x - pixelPosition.x),
min(pixelPosition.y, size.y - pixelPosition.y));
}
vec4 get_stroked_fragColor(float dist) {
float isBorder = smoothedge(dist, vLineWidth);
return mix(vFillColor, vLineColor, isBorder);
}
void main(void) {
geometry.uv = uv;
if (textBackground.borderRadius != vec4(0.0)) {
float distToEdge = round_rect(uv, dimensions, textBackground.borderRadius);
if (textBackground.stroked) {
fragColor = get_stroked_fragColor(distToEdge);
} else {
fragColor = vFillColor;
}
float shapeAlpha = smoothedge(-distToEdge, 0.0);
fragColor.a *= shapeAlpha;
} else {
if (textBackground.stroked) {
float distToEdge = rect(uv, dimensions);
fragColor = get_stroked_fragColor(distToEdge);
} else {
fragColor = vFillColor;
}
}
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,ML={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,borderRadius:{type:"object",value:0},padding:{type:"array",value:[0,0,0,0]},getPosition:{type:"accessor",value:n=>n.position},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},getBoundingRect:{type:"accessor",value:[0,0,0,0]},getFillColor:{type:"accessor",value:[0,0,0,255]},getLineColor:{type:"accessor",value:[0,0,0,255]},getLineWidth:{type:"accessor",value:1}};class rg extends zs{getShaders(){return super.getShaders({vs:IL,fs:AL,modules:[oc,ac,PL]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instanceRects:{size:4,accessor:"getBoundingRect"},instancePixelOffsets:{size:2,transition:!0,accessor:"getPixelOffset"},instanceFillColors:{size:4,transition:!0,type:"unorm8",accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:4,transition:!0,type:"unorm8",accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(t){super.updateState(t);const{changeFlags:e}=t;e.extensionsChanged&&(this.state.model?.destroy(),this.state.model=this._getModel(),this.getAttributeManager().invalidateAll())}draw({uniforms:t}){const{billboard:e,sizeScale:r,sizeUnits:i,sizeMinPixels:s,sizeMaxPixels:o,getLineWidth:a}=this.props;let{padding:l,borderRadius:c}=this.props;l.length<4&&(l=[l[0],l[1],l[0],l[1]]),Array.isArray(c)||(c=[c,c,c,c]);const u=this.state.model,h={billboard:e,stroked:!!a,borderRadius:c,padding:l,sizeUnits:Gi[i],sizeScale:r,sizeMinPixels:s,sizeMaxPixels:o};u.shaderInputs.setProps({textBackground:h}),u.draw(this.context.renderPass)}_getModel(){const t=[0,0,1,0,0,1,1,1];return new qr(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new ga({topology:"triangle-strip",vertexCount:4,attributes:{positions:{size:2,value:new Float32Array(t)}}}),isInstanced:!0})}}rg.defaultProps=ML;rg.layerName="TextBackgroundLayer";const my={start:1,middle:0,end:-1},_y={top:1,center:0,bottom:-1},Bf=[0,0,0,255],RL=1,NL={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,background:!1,getBackgroundColor:{type:"accessor",value:[255,255,255,255]},getBorderColor:{type:"accessor",value:Bf},getBorderWidth:{type:"accessor",value:0},backgroundBorderRadius:{type:"object",value:0},backgroundPadding:{type:"array",value:[0,0,0,0]},characterSet:{type:"object",value:oa.characterSet},fontFamily:oa.fontFamily,fontWeight:oa.fontWeight,lineHeight:RL,outlineWidth:{type:"number",value:0,min:0},outlineColor:{type:"color",value:Bf},fontSettings:{type:"object",value:{},compare:1},wordBreak:"break-word",maxWidth:{type:"number",value:-1},getText:{type:"accessor",value:n=>n.text},getPosition:{type:"accessor",value:n=>n.position},getColor:{type:"accessor",value:Bf},getSize:{type:"accessor",value:32},getAngle:{type:"accessor",value:0},getTextAnchor:{type:"accessor",value:"middle"},getAlignmentBaseline:{type:"accessor",value:"center"},getPixelOffset:{type:"accessor",value:[0,0]},backgroundColor:{deprecatedFor:["background","getBackgroundColor"]}};class Ah extends cc{constructor(){super(...arguments),this.getBoundingRect=(t,e)=>{let{size:[r,i]}=this.transformParagraph(t,e);const{fontSize:s}=this.state.fontAtlasManager.props;r/=s,i/=s;const{getTextAnchor:o,getAlignmentBaseline:a}=this.props,l=my[typeof o=="function"?o(t,e):o],c=_y[typeof a=="function"?a(t,e):a];return[(l-1)*r/2,(c-1)*i/2,r,i]},this.getIconOffsets=(t,e)=>{const{getTextAnchor:r,getAlignmentBaseline:i}=this.props,{x:s,y:o,rowWidth:a,size:[l,c]}=this.transformParagraph(t,e),u=my[typeof r=="function"?r(t,e):r],h=_y[typeof i=="function"?i(t,e):i],f=s.length,d=new Array(f*2);let p=0;for(let _=0;_<f;_++){const v=(1-u)*(l-a[_])/2;d[p++]=(u-1)*l/2+v+s[_],d[p++]=(h-1)*c/2+o[_]}return d}}initializeState(){this.state={styleVersion:0,fontAtlasManager:new TL},this.props.maxWidth>0&&It.once(1,"v8.9 breaking change: TextLayer maxWidth is now relative to text size")()}updateState(t){const{props:e,oldProps:r,changeFlags:i}=t;(i.dataChanged||i.updateTriggersChanged&&(i.updateTriggersChanged.all||i.updateTriggersChanged.getText))&&this._updateText(),(this._updateFontAtlas()||e.lineHeight!==r.lineHeight||e.wordBreak!==r.wordBreak||e.maxWidth!==r.maxWidth)&&this.setState({styleVersion:this.state.styleVersion+1})}getPickingInfo({info:t}){return t.object=t.index>=0?this.props.data[t.index]:null,t}_updateFontAtlas(){const{fontSettings:t,fontFamily:e,fontWeight:r}=this.props,{fontAtlasManager:i,characterSet:s}=this.state,o={...t,characterSet:s,fontFamily:e,fontWeight:r};if(!i.mapping)return i.setProps(o),!0;for(const a in o)if(o[a]!==i.props[a])return i.setProps(o),!0;return!1}_updateText(){const{data:t,characterSet:e}=this.props,r=t.attributes?.getText;let{getText:i}=this.props,s=t.startIndices,o;const a=e==="auto"&&new Set;if(r&&s){const{texts:l,characterCount:c}=xL({...ArrayBuffer.isView(r)?{value:r}:r,length:t.length,startIndices:s,characterSet:a});o=c,i=(u,{index:h})=>l[h]}else{const{iterable:l,objectInfo:c}=Ph(t);s=[0],o=0;for(const u of l){c.index++;const h=Array.from(i(u,c)||"");a&&h.forEach(a.add,a),o+=h.length,s.push(o)}}this.setState({getText:i,startIndices:s,numInstances:o,characterSet:a||e})}transformParagraph(t,e){const{fontAtlasManager:r}=this.state,i=r.mapping,s=this.state.getText,{wordBreak:o,lineHeight:a,maxWidth:l}=this.props,c=s(t,e)||"";return bL(c,a,o,l*r.props.fontSize,i)}renderLayers(){const{startIndices:t,numInstances:e,getText:r,fontAtlasManager:{scale:i,atlas:s,mapping:o},styleVersion:a}=this.state,{data:l,_dataDiff:c,getPosition:u,getColor:h,getSize:f,getAngle:d,getPixelOffset:p,getBackgroundColor:_,getBorderColor:v,getBorderWidth:E,backgroundBorderRadius:m,backgroundPadding:g,background:y,billboard:b,fontSettings:x,outlineWidth:w,outlineColor:S,sizeScale:I,sizeUnits:T,sizeMinPixels:M,sizeMaxPixels:L,transitions:O,updateTriggers:P}=this.props,V=this.getSubLayerClass("characters",ng),C=this.getSubLayerClass("background",rg);return[y&&new C({getFillColor:_,getLineColor:v,getLineWidth:E,borderRadius:m,padding:g,getPosition:u,getSize:f,getAngle:d,getPixelOffset:p,billboard:b,sizeScale:I,sizeUnits:T,sizeMinPixels:M,sizeMaxPixels:L,transitions:O&&{getPosition:O.getPosition,getAngle:O.getAngle,getSize:O.getSize,getFillColor:O.getBackgroundColor,getLineColor:O.getBorderColor,getLineWidth:O.getBorderWidth,getPixelOffset:O.getPixelOffset}},this.getSubLayerProps({id:"background",updateTriggers:{getPosition:P.getPosition,getAngle:P.getAngle,getSize:P.getSize,getFillColor:P.getBackgroundColor,getLineColor:P.getBorderColor,getLineWidth:P.getBorderWidth,getPixelOffset:P.getPixelOffset,getBoundingRect:{getText:P.getText,getTextAnchor:P.getTextAnchor,getAlignmentBaseline:P.getAlignmentBaseline,styleVersion:a}}}),{data:l.attributes&&l.attributes.background?{length:l.length,attributes:l.attributes.background}:l,_dataDiff:c,autoHighlight:!1,getBoundingRect:this.getBoundingRect}),new V({sdf:x.sdf,smoothing:Number.isFinite(x.smoothing)?x.smoothing:oa.smoothing,outlineWidth:w/(x.radius||oa.radius),outlineColor:S,iconAtlas:s,iconMapping:o,getPosition:u,getColor:h,getSize:f,getAngle:d,getPixelOffset:p,billboard:b,sizeScale:I*i,sizeUnits:T,sizeMinPixels:M*i,sizeMaxPixels:L*i,transitions:O&&{getPosition:O.getPosition,getAngle:O.getAngle,getColor:O.getColor,getSize:O.getSize,getPixelOffset:O.getPixelOffset}},this.getSubLayerProps({id:"characters",updateTriggers:{all:P.getText,getPosition:P.getPosition,getAngle:P.getAngle,getColor:P.getColor,getSize:P.getSize,getPixelOffset:P.getPixelOffset,getIconOffsets:{getTextAnchor:P.getTextAnchor,getAlignmentBaseline:P.getAlignmentBaseline,styleVersion:a}}}),{data:l,_dataDiff:c,startIndices:t,numInstances:e,getIconOffsets:this.getIconOffsets,getIcon:r})]}static set fontAtlasCacheLimit(t){CL(t)}}Ah.defaultProps=NL;Ah.layerName="TextLayer";const fu={circle:{type:io,props:{filled:"filled",stroked:"stroked",lineWidthMaxPixels:"lineWidthMaxPixels",lineWidthMinPixels:"lineWidthMinPixels",lineWidthScale:"lineWidthScale",lineWidthUnits:"lineWidthUnits",pointRadiusMaxPixels:"radiusMaxPixels",pointRadiusMinPixels:"radiusMinPixels",pointRadiusScale:"radiusScale",pointRadiusUnits:"radiusUnits",pointAntialiasing:"antialiasing",pointBillboard:"billboard",getFillColor:"getFillColor",getLineColor:"getLineColor",getLineWidth:"getLineWidth",getPointRadius:"getRadius"}},icon:{type:uc,props:{iconAtlas:"iconAtlas",iconMapping:"iconMapping",iconSizeMaxPixels:"sizeMaxPixels",iconSizeMinPixels:"sizeMinPixels",iconSizeScale:"sizeScale",iconSizeUnits:"sizeUnits",iconAlphaCutoff:"alphaCutoff",iconBillboard:"billboard",getIcon:"getIcon",getIconAngle:"getAngle",getIconColor:"getColor",getIconPixelOffset:"getPixelOffset",getIconSize:"getSize"}},text:{type:Ah,props:{textSizeMaxPixels:"sizeMaxPixels",textSizeMinPixels:"sizeMinPixels",textSizeScale:"sizeScale",textSizeUnits:"sizeUnits",textBackground:"background",textBackgroundPadding:"backgroundPadding",textFontFamily:"fontFamily",textFontWeight:"fontWeight",textLineHeight:"lineHeight",textMaxWidth:"maxWidth",textOutlineColor:"outlineColor",textOutlineWidth:"outlineWidth",textWordBreak:"wordBreak",textCharacterSet:"characterSet",textBillboard:"billboard",textFontSettings:"fontSettings",getText:"getText",getTextAngle:"getAngle",getTextColor:"getColor",getTextPixelOffset:"getPixelOffset",getTextSize:"getSize",getTextAnchor:"getTextAnchor",getTextAlignmentBaseline:"getAlignmentBaseline",getTextBackgroundColor:"getBackgroundColor",getTextBorderColor:"getBorderColor",getTextBorderWidth:"getBorderWidth"}}},du={type:$a,props:{lineWidthUnits:"widthUnits",lineWidthScale:"widthScale",lineWidthMinPixels:"widthMinPixels",lineWidthMaxPixels:"widthMaxPixels",lineJointRounded:"jointRounded",lineCapRounded:"capRounded",lineMiterLimit:"miterLimit",lineBillboard:"billboard",getLineColor:"getColor",getLineWidth:"getWidth"}},zd={type:eg,props:{extruded:"extruded",filled:"filled",wireframe:"wireframe",elevationScale:"elevationScale",material:"material",_full3d:"_full3d",getElevation:"getElevation",getFillColor:"getFillColor",getLineColor:"getLineColor"}};function nl({type:n,props:t}){const e={};for(const r in t)e[r]=n.defaultProps[t[r]];return e}function Uf(n,t){const{transitions:e,updateTriggers:r}=n.props,i={updateTriggers:{},transitions:e&&{getPosition:e.geometry}};for(const s in t){const o=t[s];let a=n.props[s];s.startsWith("get")&&(a=n.getSubLayerAccessor(a),i.updateTriggers[o]=r[s],e&&(i.transitions[o]=e[s])),i[o]=a}return i}function OL(n){if(Array.isArray(n))return n;switch(It.assert(n.type,"GeoJSON does not have type"),n.type){case"Feature":return[n];case"FeatureCollection":return It.assert(Array.isArray(n.features),"GeoJSON does not have features array"),n.features;default:return[{geometry:n}]}}function yy(n,t,e={}){const r={pointFeatures:[],lineFeatures:[],polygonFeatures:[],polygonOutlineFeatures:[]},{startRow:i=0,endRow:s=n.length}=e;for(let o=i;o<s;o++){const a=n[o],{geometry:l}=a;if(l)if(l.type==="GeometryCollection"){It.assert(Array.isArray(l.geometries),"GeoJSON does not have geometries array");const{geometries:c}=l;for(let u=0;u<c.length;u++){const h=c[u];vy(h,r,t,a,o)}}else vy(l,r,t,a,o)}return r}function vy(n,t,e,r,i){const{type:s,coordinates:o}=n,{pointFeatures:a,lineFeatures:l,polygonFeatures:c,polygonOutlineFeatures:u}=t;if(!LL(s,o)){It.warn(`${s} coordinates are malformed`)();return}switch(s){case"Point":a.push(e({geometry:n},r,i));break;case"MultiPoint":o.forEach(h=>{a.push(e({geometry:{type:"Point",coordinates:h}},r,i))});break;case"LineString":l.push(e({geometry:n},r,i));break;case"MultiLineString":o.forEach(h=>{l.push(e({geometry:{type:"LineString",coordinates:h}},r,i))});break;case"Polygon":c.push(e({geometry:n},r,i)),o.forEach(h=>{u.push(e({geometry:{type:"LineString",coordinates:h}},r,i))});break;case"MultiPolygon":o.forEach(h=>{c.push(e({geometry:{type:"Polygon",coordinates:h}},r,i)),h.forEach(f=>{u.push(e({geometry:{type:"LineString",coordinates:f}},r,i))})});break}}const DL={Point:1,MultiPoint:2,LineString:2,MultiLineString:3,Polygon:3,MultiPolygon:4};function LL(n,t){let e=DL[n];for(It.assert(e,`Unknown GeoJSON type ${n}`);t&&--e>0;)t=t[0];return t&&Number.isFinite(t[0])}function jx(){return{points:{},lines:{},polygons:{},polygonsOutline:{}}}function Wc(n){return n.geometry.coordinates}function kL(n,t){const e=jx(),{pointFeatures:r,lineFeatures:i,polygonFeatures:s,polygonOutlineFeatures:o}=n;return e.points.data=r,e.points._dataDiff=t.pointFeatures&&(()=>t.pointFeatures),e.points.getPosition=Wc,e.lines.data=i,e.lines._dataDiff=t.lineFeatures&&(()=>t.lineFeatures),e.lines.getPath=Wc,e.polygons.data=s,e.polygons._dataDiff=t.polygonFeatures&&(()=>t.polygonFeatures),e.polygons.getPolygon=Wc,e.polygonsOutline.data=o,e.polygonsOutline._dataDiff=t.polygonOutlineFeatures&&(()=>t.polygonOutlineFeatures),e.polygonsOutline.getPath=Wc,e}function FL(n,t){const e=jx(),{points:r,lines:i,polygons:s}=n,o=lL(n,t);return e.points.data={length:r.positions.value.length/r.positions.size,attributes:{...r.attributes,getPosition:r.positions,instancePickingColors:{size:4,value:o.points}},properties:r.properties,numericProps:r.numericProps,featureIds:r.featureIds},e.lines.data={length:i.pathIndices.value.length-1,startIndices:i.pathIndices.value,attributes:{...i.attributes,getPath:i.positions,instancePickingColors:{size:4,value:o.lines}},properties:i.properties,numericProps:i.numericProps,featureIds:i.featureIds},e.lines._pathType="open",e.polygons.data={length:s.polygonIndices.value.length-1,startIndices:s.polygonIndices.value,attributes:{...s.attributes,getPolygon:s.positions,pickingColors:{size:4,value:o.polygons}},properties:s.properties,numericProps:s.numericProps,featureIds:s.featureIds},e.polygons._normalize=!1,s.triangles&&(e.polygons.data.attributes.indices=s.triangles.value),e.polygonsOutline.data={length:s.primitivePolygonIndices.value.length-1,startIndices:s.primitivePolygonIndices.value,attributes:{...s.attributes,getPath:s.positions,instancePickingColors:{size:4,value:o.polygons}},properties:s.properties,numericProps:s.numericProps,featureIds:s.featureIds},e.polygonsOutline._pathType="open",e}const BL=["points","linestrings","polygons"],UL={...nl(fu.circle),...nl(fu.icon),...nl(fu.text),...nl(du),...nl(zd),stroked:!0,filled:!0,extruded:!1,wireframe:!1,_full3d:!1,iconAtlas:{type:"object",value:null},iconMapping:{type:"object",value:{}},getIcon:{type:"accessor",value:n=>n.properties.icon},getText:{type:"accessor",value:n=>n.properties.text},pointType:"circle",getRadius:{deprecatedFor:"getPointRadius"}};class Ol extends cc{initializeState(){this.state={layerProps:{},features:{},featuresDiff:{}}}updateState({props:t,changeFlags:e}){if(!e.dataChanged)return;const{data:r}=this.props,i=r&&"points"in r&&"polygons"in r&&"lines"in r;this.setState({binary:i}),i?this._updateStateBinary({props:t,changeFlags:e}):this._updateStateJSON({props:t,changeFlags:e})}_updateStateBinary({props:t,changeFlags:e}){const r=FL(t.data,this.encodePickingColor);this.setState({layerProps:r})}_updateStateJSON({props:t,changeFlags:e}){const r=OL(t.data),i=this.getSubLayerRow.bind(this);let s={};const o={};if(Array.isArray(e.dataChanged)){const l=this.state.features;for(const c in l)s[c]=l[c].slice(),o[c]=[];for(const c of e.dataChanged){const u=yy(r,i,c);for(const h in l)o[h].push(sL({data:s[h],getIndex:f=>f.__source.index,dataRange:c,replace:u[h]}))}}else s=yy(r,i);const a=kL(s,o);this.setState({features:s,featuresDiff:o,layerProps:a})}getPickingInfo(t){const e=super.getPickingInfo(t),{index:r,sourceLayer:i}=e;return e.featureType=BL.find(s=>i.id.startsWith(`${this.id}-${s}-`)),r>=0&&i.id.startsWith(`${this.id}-points-text`)&&this.state.binary&&(e.index=this.props.data.points.globalFeatureIds.value[r]),e}_updateAutoHighlight(t){const e=`${this.id}-points-`,r=t.featureType==="points";for(const i of this.getSubLayers())i.id.startsWith(e)===r&&i.updateAutoHighlight(t)}_renderPolygonLayer(){const{extruded:t,wireframe:e}=this.props,{layerProps:r}=this.state,i="polygons-fill",s=this.shouldRenderSubLayer(i,r.polygons?.data)&&this.getSubLayerClass(i,zd.type);if(s){const o=Uf(this,zd.props),a=t&&e;return a||delete o.getLineColor,o.updateTriggers.lineColors=a,new s(o,this.getSubLayerProps({id:i,updateTriggers:o.updateTriggers}),r.polygons)}return null}_renderLineLayers(){const{extruded:t,stroked:e}=this.props,{layerProps:r}=this.state,i="polygons-stroke",s="linestrings",o=!t&&e&&this.shouldRenderSubLayer(i,r.polygonsOutline?.data)&&this.getSubLayerClass(i,du.type),a=this.shouldRenderSubLayer(s,r.lines?.data)&&this.getSubLayerClass(s,du.type);if(o||a){const l=Uf(this,du.props);return[o&&new o(l,this.getSubLayerProps({id:i,updateTriggers:l.updateTriggers}),r.polygonsOutline),a&&new a(l,this.getSubLayerProps({id:s,updateTriggers:l.updateTriggers}),r.lines)]}return null}_renderPointLayers(){const{pointType:t}=this.props,{layerProps:e,binary:r}=this.state;let{highlightedObjectIndex:i}=this.props;!r&&Number.isFinite(i)&&(i=e.points.data.findIndex(a=>a.__source.index===i));const s=new Set(t.split("+")),o=[];for(const a of s){const l=`points-${a}`,c=fu[a],u=c&&this.shouldRenderSubLayer(l,e.points?.data)&&this.getSubLayerClass(l,c.type);if(u){const h=Uf(this,c.props);let f=e.points;if(a==="text"&&r){const{instancePickingColors:d,...p}=f.data.attributes;f={...f,data:{...f.data,attributes:p}}}o.push(new u(h,this.getSubLayerProps({id:l,updateTriggers:h.updateTriggers,highlightedObjectIndex:i}),f))}}return o}renderLayers(){const{extruded:t}=this.props,e=this._renderPolygonLayer(),r=this._renderLineLayers(),i=this._renderPointLayers();return[!t&&e,r,i,t&&e]}getSubLayerAccessor(t){const{binary:e}=this.state;return!e||typeof t!="function"?super.getSubLayerAccessor(t):(r,i)=>{const{data:s,index:o}=i,a=oL(s,o);return t(a,i)}}}Ol.layerName="GeoJsonLayer";Ol.defaultProps=UL;const VL={inject:{"vs:#decl":`
in vec2 instanceDashArrays;
in float instanceDashOffsets;
out vec2 vDashArray;
out float vDashOffset;
`,"vs:#main-end":`
vDashArray = instanceDashArrays;
vDashOffset = instanceDashOffsets / width.x;
`,"fs:#decl":`
uniform pathStyleUniforms {
float dashAlignMode;
bool dashGapPickable;
} pathStyle;
in vec2 vDashArray;
in float vDashOffset;
`,"fs:#main-start":`
float solidLength = vDashArray.x;
float gapLength = vDashArray.y;
float unitLength = solidLength + gapLength;
float offset;
if (unitLength > 0.0) {
if (pathStyle.dashAlignMode == 0.0) {
offset = vDashOffset;
} else {
unitLength = vPathLength / round(vPathLength / unitLength);
offset = solidLength / 2.0;
}
float unitOffset = mod(vPathPosition.y + offset, unitLength);
if (gapLength > 0.0 && unitOffset > solidLength) {
if (path.capType <= 0.5) {
if (!(pathStyle.dashGapPickable && bool(picking.isActive))) {
discard;
}
} else {
float distToEnd = length(vec2(
min(unitOffset - solidLength, unitLength - unitOffset),
vPathPosition.x
));
if (distToEnd > 1.0) {
if (!(pathStyle.dashGapPickable && bool(picking.isActive))) {
discard;
}
}
}
}
}
`}},zL={inject:{"vs:#decl":`
in float instanceOffsets;
`,"vs:DECKGL_FILTER_SIZE":`
float offsetWidth = abs(instanceOffsets * 2.0) + 1.0;
size *= offsetWidth;
`,"vs:#main-end":`
float offsetWidth = abs(instanceOffsets * 2.0) + 1.0;
float offsetDir = sign(instanceOffsets);
vPathPosition.x = (vPathPosition.x + offsetDir) * offsetWidth - offsetDir;
vPathPosition.y *= offsetWidth;
vPathLength *= offsetWidth;
`,"fs:#main-start":`
float isInside;
isInside = step(-1.0, vPathPosition.x) * step(vPathPosition.x, 1.0);
if (isInside == 0.0) {
discard;
}
`}},WL={getDashArray:{type:"accessor",value:[0,0]},getOffset:{type:"accessor",value:0},dashJustified:!1,dashGapPickable:!1};class Ku extends tg{constructor({dash:t=!1,offset:e=!1,highPrecisionDash:r=!1}={}){super({dash:t||r,offset:e,highPrecisionDash:r})}isEnabled(t){return"pathTesselator"in t.state}getShaders(t){if(!t.isEnabled(this))return null;let e={};t.opts.dash&&(e=$u(e,VL)),t.opts.offset&&(e=$u(e,zL));const{inject:r}=e;return{modules:[{name:"pathStyle",inject:r,uniformTypes:{dashAlignMode:"f32",dashGapPickable:"i32"}}]}}initializeState(t,e){const r=this.getAttributeManager();!r||!e.isEnabled(this)||(e.opts.dash&&r.addInstanced({instanceDashArrays:{size:2,accessor:"getDashArray"},instanceDashOffsets:e.opts.highPrecisionDash?{size:1,accessor:"getPath",transform:e.getDashOffsets.bind(this)}:{size:1,update:i=>{i.constant=!0,i.value=[0]}}}),e.opts.offset&&r.addInstanced({instanceOffsets:{size:1,accessor:"getOffset"}}))}updateState(t,e){if(e.isEnabled(this)&&e.opts.dash){const r={dashAlignMode:this.props.dashJustified?1:0,dashGapPickable:!!this.props.dashGapPickable};this.setShaderModuleProps({pathStyle:r})}}getDashOffsets(t){const e=[0],r=this.props.positionFormat==="XY"?2:3,i=Array.isArray(t[0]),s=i?t.length:t.length/r;let o,a;for(let l=0;l<s-1;l++)o=i?t[l]:t.slice(l*r,l*r+r),o=this.projectPosition(o),l>0&&(e[l]=e[l-1]+NI(a,o)),a=o;return e[s-1]=0,e}}Ku.defaultProps=WL;Ku.extensionName="PathStyleExtension";const by=85.05113;function xy(n,t,e,r){if(e){if(e.userData._googleMap===n)return e;Wd(e)}const i={click:null,rightclick:null,dblclick:null,mousemove:null,mouseout:null},s=new Jp({...r,useDevicePixels:r.interleaved?!0:r.useDevicePixels,style:r.interleaved?null:{pointerEvents:"none"},parent:HL(t,r.style),views:new Xp({repeat:!0}),initialViewState:{longitude:0,latitude:0,zoom:1},controller:!1});for(const o in i)i[o]=n.addListener(o,a=>XL(s,o,a));return s.userData._googleMap=n,s.userData._eventListeners=i,s}function HL(n,t){const e=document.createElement("div");return e.style.position="absolute",Object.assign(e.style,t),"getPanes"in n?n.getPanes()?.overlayLayer.appendChild(e):n.getMap()?.getDiv().appendChild(e),e}function Wd(n){const{_eventListeners:t}=n.userData;for(const e in t)t[e]&&t[e].remove();n.finalize()}function jL(n,t){const{width:e,height:r}=$x(n),i=t.getProjection(),s=n.getBounds();if(!s)return{width:e,height:r,left:0,top:0};const o=s.getNorthEast(),a=s.getSouthWest(),l=i.fromLatLngToDivPixel(o),c=i.fromLatLngToDivPixel(a),u=Vf(i,e/2,r/2),h=new google.maps.LatLng(0,u[0]),f=i.fromLatLngToContainerPixel(h),d=i.fromLatLngToDivPixel(h);if(!l||!c||!d||!f)return{width:e,height:r,left:0,top:0};const p=Math.round(d.x-f.x);let _=d.y-f.y;const v=Vf(i,e/2,0),E=Vf(i,e/2,r);let m=u[1];const g=u[0];if(Math.abs(m)>by){m=m>0?by:-85.05113;const I=new google.maps.LatLng(m,g),T=i.fromLatLngToContainerPixel(I);_+=T.y-r/2}_=Math.round(_);let b=180*new gf(v).sub(E).verticalAngle()/Math.PI;b<0&&(b+=360);const x=n.getHeading()||0;let w=n.getZoom()-1,S;if(b===0)S=r?(c.y-l.y)/r:1;else if(b===x){const I=new gf([l.x,l.y]).sub([c.x,c.y]).len(),T=new gf([e,-r]).len();S=T?I/T:1}return w+=Math.log2(S||1),{width:e,height:r,left:p,top:_,zoom:w,bearing:b,pitch:n.getTilt(),latitude:m,longitude:g}}function Ey(n,t){const{width:e,height:r}=$x(n),{center:i,heading:s,tilt:o,zoom:a}=t.getCameraParams(),l=25,c=r?e/r:1,f=new Jr().perspective({fovy:l*Math.PI/180,aspect:c,near:.75,far:3e14}),d=.5*f[5];return{width:e,height:r,viewState:{altitude:d,bearing:s,latitude:i.lat(),longitude:i.lng(),pitch:o,projectionMatrix:f,repeat:!0,zoom:a-1}}}function $x(n){const t=n.getDiv().firstChild;return{width:t.offsetWidth,height:t.offsetHeight}}function Vf(n,t,e){const r=new google.maps.Point(t,e),i=n.fromContainerPixelToLatLng(r);return[i.lng(),i.lat()]}function $L(n,t){if(n.pixel)return n.pixel;const e=t.getViewports()[0].project([n.latLng.lng(),n.latLng.lat()]);return{x:e[0],y:e[1]}}function XL(n,t,e){if(!n.isInitialized)return;const r={type:t,offsetCenter:$L(e,n),srcEvent:e};switch(t){case"click":case"rightclick":r.type="click",r.tapCount=1,n._onPointerDown(r),n._onEvent(r);break;case"dblclick":r.type="click",r.tapCount=2,n._onEvent(r);break;case"mousemove":r.type="pointermove",n._onPointerMove(r);break;case"mouseout":r.type="pointerleave",n._onPointerMove(r);break;default:return}}const GL=()=>!1,YL={depthMask:!0,depthTest:!0,blend:!0,blendFunc:[770,771,1,771],blendEquation:32774};function wy(){}const qL={interleaved:!0};class KL{constructor(t){this.props={},this._map=null,this._deck=null,this._overlay=null,this.setProps({...qL,...t})}setMap(t){if(t===this._map)return;const{VECTOR:e,UNINITIALIZED:r}=google.maps.RenderingType;this._map&&(!t&&this._map.getRenderingType()===e&&this.props.interleaved&&this._overlay.requestRedraw(),this._overlay?.setMap(null),this._map=null),t&&(this._map=t,t.getRenderingType()!==r?this._createOverlay(t):t.addListener("renderingtype_changed",()=>{this._createOverlay(t)}))}setProps(t){if(Object.assign(this.props,t),this._deck){const e=this._deck.getCanvas();if(t.style&&e?.parentElement){const r=e.parentElement.style;Object.assign(r,t.style),t.style=null}this._deck.setProps(t)}}pickObject(t){return this._deck&&this._deck.pickObject(t)}pickMultipleObjects(t){return this._deck&&this._deck.pickMultipleObjects(t)}pickObjects(t){return this._deck&&this._deck.pickObjects(t)}finalize(){this.setMap(null),this._deck&&(Wd(this._deck),this._deck=null)}_createOverlay(t){const{interleaved:e}=this.props,{VECTOR:r,UNINITIALIZED:i}=google.maps.RenderingType,s=t.getRenderingType();if(s===i)return;const a=s===r&&google.maps.WebGLOverlayView?google.maps.WebGLOverlayView:google.maps.OverlayView,l=new a;l instanceof google.maps.WebGLOverlayView?(e?(l.onAdd=wy,l.onContextRestored=this._onContextRestored.bind(this),l.onDraw=this._onDrawVectorInterleaved.bind(this)):(l.onAdd=this._onAdd.bind(this),l.onContextRestored=wy,l.onDraw=this._onDrawVectorOverlay.bind(this)),l.onContextLost=this._onContextLost.bind(this)):(l.onAdd=this._onAdd.bind(this),l.draw=this._onDrawRaster.bind(this)),l.onRemove=this._onRemove.bind(this),this._overlay=l,this._overlay.setMap(t)}_onAdd(){this._deck=xy(this._map,this._overlay,this._deck,this.props)}_onContextRestored({gl:t}){if(!this._map||!this._overlay)return;const e=()=>{this._overlay&&this._overlay.requestRedraw()},r=xy(this._map,this._overlay,this._deck,{gl:t,_customRender:e,...this.props});this._deck=r;const i=r.animationLoop;i._renderFrame=()=>{const s=t.getParameter(34964);r.device.withParametersWebGL({},()=>{i.props.onRender(i.animationProps)}),t.bindBuffer(34962,s)}}_onContextLost(){this._deck&&(Wd(this._deck),this._deck=null)}_onRemove(){this._deck?.setProps({layerFilter:GL})}_onDrawRaster(){if(!this._deck||!this._map)return;const t=this._deck,{width:e,height:r,left:i,top:s,...o}=jL(this._map,this._overlay),l=t.getCanvas()?.parentElement||t.props.parent;if(l){const u=l.style;u.left=`${i}px`,u.top=`${s}px`}t.setProps({width:e,height:r,viewState:{altitude:1e4,...o}}),t.redraw()}_onDrawVectorInterleaved({gl:t,transformer:e}){if(!this._deck||!this._map)return;const r=this._deck;if(r.setProps({...Ey(this._map,e),width:null,height:null}),r.isInitialized){const i=r.device;if(i instanceof ys){const s=i.getParametersWebGL(36006);r.setProps({_framebuffer:s})}i.getDefaultCanvasContext().resize(),r.needsRedraw({clearRedrawFlags:!0}),i instanceof ys&&(i.setParametersWebGL({viewport:[0,0,t.canvas.width,t.canvas.height],scissor:[0,0,t.canvas.width,t.canvas.height],stencilFunc:[519,0,255,519,0,255]}),i.withParametersWebGL(YL,()=>{r._drawLayers("google-vector",{clearCanvas:!1})}))}}_onDrawVectorOverlay({transformer:t}){if(!this._deck||!this._map)return;const e=this._deck;e.setProps({...Ey(this._map,t)}),e.redraw()}}const Sy={apiAtlasUrl:"src/assets/atlas",apiControllers:{},getAtlasDefinition:async function(n){const t=new AbortController,[e,r]=ve(),[i,s]=ve(),o=`${this.apiAtlasUrl}/${n}`;return await fetch(o,{headers:{"Content-Type":"application/json"},method:"GET",signal:t.signal}).then(a=>a.json()).then(a=>{r(a)}).catch(a=>{s(a),alert("[FATAL ERROR] Cannot Retrieve Atlas Definition");let l={};r(l),console.log("Error",l)}),e()}},ZL={getIconMappingFromTexPackerJSONHash:function(n,t=!1){let e={};for(let r in n.frames)e[r]={...n.frames[r].frame,mask:t,width:n.frames[r].frame.w,height:n.frames[r].frame.h},delete e[r].h,delete e[r].w;return console.log("Generated Atlasmap",e),e}},JL={apiDataUrl:"src/assets/json",apiControllers:{},getMapData:async function(n){const t=new AbortController,[e,r]=ve(),[i,s]=ve(),o=`${this.apiDataUrl}/${n}`;return await fetch(o,{headers:{"Content-Type":"application/json"},method:"GET",signal:t.signal}).then(a=>a.json()).then(a=>{r(a)}).catch(a=>{s(a),alert("[FATAL ERROR] Cannot Retrieve Atlas Definition");let l={};r(l),console.log("Error",l)}),e()}};var nn=63710088e-1,Xx={centimeters:nn*100,centimetres:nn*100,degrees:nn/111325,feet:nn*3.28084,inches:nn*39.37,kilometers:nn/1e3,kilometres:nn/1e3,meters:nn,metres:nn,miles:nn/1609.344,millimeters:nn*1e3,millimetres:nn*1e3,nauticalmiles:nn/1852,radians:1,yards:nn*1.0936};function Pr(n,t,e){e===void 0&&(e={});var r={type:"Feature"};return(e.id===0||e.id)&&(r.id=e.id),e.bbox&&(r.bbox=e.bbox),r.properties=t||{},r.geometry=n,r}function wt(n,t,e){if(e===void 0&&(e={}),!n)throw new Error("coordinates is required");if(!Array.isArray(n))throw new Error("coordinates must be an Array");if(n.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!Ju(n[0])||!Ju(n[1]))throw new Error("coordinates must contain numbers");var r={type:"Point",coordinates:n};return Pr(r,t,e)}function uo(n,t,e){e===void 0&&(e={});for(var r=0,i=n;r<i.length;r++){var s=i[r];if(s.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");for(var o=0;o<s[s.length-1].length;o++)if(s[s.length-1][o]!==s[0][o])throw new Error("First and last Position are not equivalent.")}var a={type:"Polygon",coordinates:n};return Pr(a,t,e)}function Nn(n,t,e){if(e===void 0&&(e={}),n.length<2)throw new Error("coordinates must be an array of two or more positions");var r={type:"LineString",coordinates:n};return Pr(r,t,e)}function Ir(n,t){t===void 0&&(t={});var e={type:"FeatureCollection"};return t.id&&(e.id=t.id),t.bbox&&(e.bbox=t.bbox),e.features=n,e}function QL(n,t,e){e===void 0&&(e={});var r={type:"MultiLineString",coordinates:n};return Pr(r,t,e)}function ig(n,t,e){e===void 0&&(e={});var r={type:"MultiPolygon",coordinates:n};return Pr(r,t,e)}function sg(n,t){t===void 0&&(t="kilometers");var e=Xx[t];if(!e)throw new Error(t+" units is invalid");return n*e}function og(n,t){t===void 0&&(t="kilometers");var e=Xx[t];if(!e)throw new Error(t+" units is invalid");return n/e}function Zu(n){var t=n%(2*Math.PI);return t*180/Math.PI}function cn(n){var t=n%360;return t*Math.PI/180}function ag(n,t,e){if(t===void 0&&(t="kilometers"),e===void 0&&(e="kilometers"),!(n>=0))throw new Error("length must be a positive number");return sg(og(n,t),e)}function Ju(n){return!isNaN(n)&&n!==null&&!Array.isArray(n)}function Mh(n){return!!n&&n.constructor===Object}function Ws(n,t,e){if(n!==null)for(var r,i,s,o,a,l,c,u=0,h=0,f,d=n.type,p=d==="FeatureCollection",_=d==="Feature",v=p?n.features.length:1,E=0;E<v;E++){c=p?n.features[E].geometry:_?n.geometry:n,f=c?c.type==="GeometryCollection":!1,a=f?c.geometries.length:1;for(var m=0;m<a;m++){var g=0,y=0;if(o=f?c.geometries[m]:c,o!==null){l=o.coordinates;var b=o.type;switch(u=e&&(b==="Polygon"||b==="MultiPolygon")?1:0,b){case null:break;case"Point":if(t(l,h,E,g,y)===!1)return!1;h++,g++;break;case"LineString":case"MultiPoint":for(r=0;r<l.length;r++){if(t(l[r],h,E,g,y)===!1)return!1;h++,b==="MultiPoint"&&g++}b==="LineString"&&g++;break;case"Polygon":case"MultiLineString":for(r=0;r<l.length;r++){for(i=0;i<l[r].length-u;i++){if(t(l[r][i],h,E,g,y)===!1)return!1;h++}b==="MultiLineString"&&g++,b==="Polygon"&&y++}b==="Polygon"&&g++;break;case"MultiPolygon":for(r=0;r<l.length;r++){for(y=0,i=0;i<l[r].length;i++){for(s=0;s<l[r][i].length-u;s++){if(t(l[r][i][s],h,E,g,y)===!1)return!1;h++}y++}g++}break;case"GeometryCollection":for(r=0;r<o.geometries.length;r++)if(Ws(o.geometries[r],t,e)===!1)return!1;break;default:throw new Error("Unknown Geometry Type")}}}}}function ho(n,t){if(n.type==="Feature")t(n,0);else if(n.type==="FeatureCollection")for(var e=0;e<n.features.length&&t(n.features[e],e)!==!1;e++);}function Xa(n,t){var e,r,i,s,o,a,l,c,u,h,f=0,d=n.type==="FeatureCollection",p=n.type==="Feature",_=d?n.features.length:1;for(e=0;e<_;e++){for(a=d?n.features[e].geometry:p?n.geometry:n,c=d?n.features[e].properties:p?n.properties:{},u=d?n.features[e].bbox:p?n.bbox:void 0,h=d?n.features[e].id:p?n.id:void 0,l=a?a.type==="GeometryCollection":!1,o=l?a.geometries.length:1,i=0;i<o;i++){if(s=l?a.geometries[i]:a,s===null){if(t(null,f,c,u,h)===!1)return!1;continue}switch(s.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":{if(t(s,f,c,u,h)===!1)return!1;break}case"GeometryCollection":{for(r=0;r<s.geometries.length;r++)if(t(s.geometries[r],f,c,u,h)===!1)return!1;break}default:throw new Error("Unknown Geometry Type")}}f++}}function tk(n,t,e){var r=e;return Xa(n,function(i,s,o,a,l){r=t(r,i,s,o,a,l)}),r}function Rh(n,t){Xa(n,function(e,r,i,s,o){var a=e===null?null:e.type;switch(a){case null:case"Point":case"LineString":case"Polygon":return t(Pr(e,i,{bbox:s,id:o}),r,0)===!1?!1:void 0}var l;switch(a){case"MultiPoint":l="Point";break;case"MultiLineString":l="LineString";break;case"MultiPolygon":l="Polygon";break}for(var c=0;c<e.coordinates.length;c++){var u=e.coordinates[c],h={type:l,coordinates:u};if(t(Pr(h,i),r,c)===!1)return!1}})}function ek(n,t){Rh(n,function(e,r,i){var s=0;if(e.geometry){var o=e.geometry.type;if(!(o==="Point"||o==="MultiPoint")){var a,l=0,c=0,u=0;if(Ws(e,function(h,f,d,p,_){if(a===void 0||r>l||p>c||_>u){a=h,l=r,c=p,u=_,s=0;return}var v=Nn([a,h],e.properties);if(t(v,r,i,_,s)===!1)return!1;s++,a=h})===!1)return!1}}})}function _a(n){var t=[1/0,1/0,-1/0,-1/0];return Ws(n,function(e){t[0]>e[0]&&(t[0]=e[0]),t[1]>e[1]&&(t[1]=e[1]),t[2]<e[0]&&(t[2]=e[0]),t[3]<e[1]&&(t[3]=e[1])}),t}_a.default=_a;function Ao(n,t){t===void 0&&(t={});var e=Number(n[0]),r=Number(n[1]),i=Number(n[2]),s=Number(n[3]);if(n.length===6)throw new Error("@turf/bbox-polygon does not support BBox with 6 positions");var o=[e,r],a=[e,s],l=[i,s],c=[i,r];return uo([[o,c,l,a,o]],t.properties,{bbox:n,id:t.id})}function lg(n,t){t===void 0&&(t={});var e=_a(n),r=(e[0]+e[2])/2,i=(e[1]+e[3])/2;return wt([r,i],t.properties,t)}"fill"in Array.prototype||Object.defineProperty(Array.prototype,"fill",{configurable:!0,value:function(t){if(this===void 0||this===null)throw new TypeError(this+" is not an object");var e=Object(this),r=Math.max(Math.min(e.length,9007199254740991),0)||0,i=1 in arguments&&parseInt(Number(arguments[1]),10)||0;i=i<0?Math.max(r+i,0):Math.min(i,r);var s=2 in arguments&&arguments[2]!==void 0?parseInt(Number(arguments[2]),10)||0:r;for(s=s<0?Math.max(r+arguments[2],0):Math.min(s,r);i<s;)e[i]=t,++i;return e},writable:!0});Number.isFinite=Number.isFinite||function(n){return typeof n=="number"&&isFinite(n)};Number.isInteger=Number.isInteger||function(n){return typeof n=="number"&&isFinite(n)&&Math.floor(n)===n};Number.parseFloat=Number.parseFloat||parseFloat;Number.isNaN=Number.isNaN||function(n){return n!==n};Math.trunc=Math.trunc||function(n){return n<0?Math.ceil(n):Math.floor(n)};var fo=function(){};fo.prototype.interfaces_=function(){return[]};fo.prototype.getClass=function(){return fo};fo.prototype.equalsWithTolerance=function(t,e,r){return Math.abs(t-e)<=r};var Xt=function(n){function t(e){n.call(this,e),this.name="IllegalArgumentException",this.message=e,this.stack=new n().stack}return n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t,t}(Error),dt=function(){},Gx={MAX_VALUE:{configurable:!0}};dt.isNaN=function(t){return Number.isNaN(t)};dt.doubleToLongBits=function(t){return t};dt.longBitsToDouble=function(t){return t};dt.isInfinite=function(t){return!Number.isFinite(t)};Gx.MAX_VALUE.get=function(){return Number.MAX_VALUE};Object.defineProperties(dt,Gx);var Gn=function(){},Nh=function(){},ya=function(){};function Yn(){}var z=function n(){if(this.x=null,this.y=null,this.z=null,arguments.length===0)this.x=0,this.y=0,this.z=n.NULL_ORDINATE;else if(arguments.length===1){var t=arguments[0];this.x=t.x,this.y=t.y,this.z=t.z}else arguments.length===2?(this.x=arguments[0],this.y=arguments[1],this.z=n.NULL_ORDINATE):arguments.length===3&&(this.x=arguments[0],this.y=arguments[1],this.z=arguments[2])},Mo={DimensionalComparator:{configurable:!0},serialVersionUID:{configurable:!0},NULL_ORDINATE:{configurable:!0},X:{configurable:!0},Y:{configurable:!0},Z:{configurable:!0}};z.prototype.setOrdinate=function(t,e){switch(t){case z.X:this.x=e;break;case z.Y:this.y=e;break;case z.Z:this.z=e;break;default:throw new Xt("Invalid ordinate index: "+t)}};z.prototype.equals2D=function(){if(arguments.length===1){var t=arguments[0];return!(this.x!==t.x||this.y!==t.y)}else if(arguments.length===2){var e=arguments[0],r=arguments[1];return!(!fo.equalsWithTolerance(this.x,e.x,r)||!fo.equalsWithTolerance(this.y,e.y,r))}};z.prototype.getOrdinate=function(t){switch(t){case z.X:return this.x;case z.Y:return this.y;case z.Z:return this.z}throw new Xt("Invalid ordinate index: "+t)};z.prototype.equals3D=function(t){return this.x===t.x&&this.y===t.y&&(this.z===t.z||dt.isNaN(this.z))&&dt.isNaN(t.z)};z.prototype.equals=function(t){return t instanceof z?this.equals2D(t):!1};z.prototype.equalInZ=function(t,e){return fo.equalsWithTolerance(this.z,t.z,e)};z.prototype.compareTo=function(t){var e=t;return this.x<e.x?-1:this.x>e.x?1:this.y<e.y?-1:this.y>e.y?1:0};z.prototype.clone=function(){};z.prototype.copy=function(){return new z(this)};z.prototype.toString=function(){return"("+this.x+", "+this.y+", "+this.z+")"};z.prototype.distance3D=function(t){var e=this.x-t.x,r=this.y-t.y,i=this.z-t.z;return Math.sqrt(e*e+r*r+i*i)};z.prototype.distance=function(t){var e=this.x-t.x,r=this.y-t.y;return Math.sqrt(e*e+r*r)};z.prototype.hashCode=function(){var t=17;return t=37*t+z.hashCode(this.x),t=37*t+z.hashCode(this.y),t};z.prototype.setCoordinate=function(t){this.x=t.x,this.y=t.y,this.z=t.z};z.prototype.interfaces_=function(){return[Gn,Nh,Yn]};z.prototype.getClass=function(){return z};z.hashCode=function(){if(arguments.length===1){var t=arguments[0],e=dt.doubleToLongBits(t);return Math.trunc((e^e)>>>32)}};Mo.DimensionalComparator.get=function(){return Hi};Mo.serialVersionUID.get=function(){return 6683108902428367e3};Mo.NULL_ORDINATE.get=function(){return dt.NaN};Mo.X.get=function(){return 0};Mo.Y.get=function(){return 1};Mo.Z.get=function(){return 2};Object.defineProperties(z,Mo);var Hi=function(t){if(this._dimensionsToTest=2,arguments.length!==0){if(arguments.length===1){var e=arguments[0];if(e!==2&&e!==3)throw new Xt("only 2 or 3 dimensions may be specified");this._dimensionsToTest=e}}};Hi.prototype.compare=function(t,e){var r=t,i=e,s=Hi.compare(r.x,i.x);if(s!==0)return s;var o=Hi.compare(r.y,i.y);if(o!==0)return o;if(this._dimensionsToTest<=2)return 0;var a=Hi.compare(r.z,i.z);return a};Hi.prototype.interfaces_=function(){return[ya]};Hi.prototype.getClass=function(){return Hi};Hi.compare=function(t,e){return t<e?-1:t>e?1:dt.isNaN(t)?dt.isNaN(e)?0:-1:dt.isNaN(e)?1:0};var va=function(){};va.prototype.create=function(){};va.prototype.interfaces_=function(){return[]};va.prototype.getClass=function(){return va};var j=function(){},hc={INTERIOR:{configurable:!0},BOUNDARY:{configurable:!0},EXTERIOR:{configurable:!0},NONE:{configurable:!0}};j.prototype.interfaces_=function(){return[]};j.prototype.getClass=function(){return j};j.toLocationSymbol=function(t){switch(t){case j.EXTERIOR:return"e";case j.BOUNDARY:return"b";case j.INTERIOR:return"i";case j.NONE:return"-"}throw new Xt("Unknown location value: "+t)};hc.INTERIOR.get=function(){return 0};hc.BOUNDARY.get=function(){return 1};hc.EXTERIOR.get=function(){return 2};hc.NONE.get=function(){return-1};Object.defineProperties(j,hc);var ct=function(n,t){return n.interfaces_&&n.interfaces_().indexOf(t)>-1},On=function(){},Yx={LOG_10:{configurable:!0}};On.prototype.interfaces_=function(){return[]};On.prototype.getClass=function(){return On};On.log10=function(t){var e=Math.log(t);return dt.isInfinite(e)||dt.isNaN(e)?e:e/On.LOG_10};On.min=function(t,e,r,i){var s=t;return e<s&&(s=e),r<s&&(s=r),i<s&&(s=i),s};On.clamp=function(){if(typeof arguments[2]=="number"&&typeof arguments[0]=="number"&&typeof arguments[1]=="number"){var t=arguments[0],e=arguments[1],r=arguments[2];return t<e?e:t>r?r:t}else if(Number.isInteger(arguments[2])&&Number.isInteger(arguments[0])&&Number.isInteger(arguments[1])){var i=arguments[0],s=arguments[1],o=arguments[2];return i<s?s:i>o?o:i}};On.wrap=function(t,e){return t<0?e- -t%e:t%e};On.max=function(){if(arguments.length===3){var t=arguments[0],e=arguments[1],r=arguments[2],i=t;return e>i&&(i=e),r>i&&(i=r),i}else if(arguments.length===4){var s=arguments[0],o=arguments[1],a=arguments[2],l=arguments[3],c=s;return o>c&&(c=o),a>c&&(c=a),l>c&&(c=l),c}};On.average=function(t,e){return(t+e)/2};Yx.LOG_10.get=function(){return Math.log(10)};Object.defineProperties(On,Yx);var Vr=function(t){this.str=t};Vr.prototype.append=function(t){this.str+=t};Vr.prototype.setCharAt=function(t,e){this.str=this.str.substr(0,t)+e+this.str.substr(t+1)};Vr.prototype.toString=function(t){return this.str};var Ar=function(t){this.value=t};Ar.prototype.intValue=function(){return this.value};Ar.prototype.compareTo=function(t){return this.value<t?-1:this.value>t?1:0};Ar.isNaN=function(t){return Number.isNaN(t)};var Dl=function(){};Dl.isWhitespace=function(t){return t<=32&&t>=0||t===127};Dl.toUpperCase=function(t){return t.toUpperCase()};var X=function n(){if(this._hi=0,this._lo=0,arguments.length===0)this.init(0);else if(arguments.length===1){if(typeof arguments[0]=="number"){var t=arguments[0];this.init(t)}else if(arguments[0]instanceof n){var e=arguments[0];this.init(e)}else if(typeof arguments[0]=="string"){var r=arguments[0];n.call(this,n.parse(r))}}else if(arguments.length===2){var i=arguments[0],s=arguments[1];this.init(i,s)}},ur={PI:{configurable:!0},TWO_PI:{configurable:!0},PI_2:{configurable:!0},E:{configurable:!0},NaN:{configurable:!0},EPS:{configurable:!0},SPLIT:{configurable:!0},MAX_PRINT_DIGITS:{configurable:!0},TEN:{configurable:!0},ONE:{configurable:!0},SCI_NOT_EXPONENT_CHAR:{configurable:!0},SCI_NOT_ZERO:{configurable:!0}};X.prototype.le=function(t){return(this._hi<t._hi||this._hi===t._hi)&&this._lo<=t._lo};X.prototype.extractSignificantDigits=function(t,e){var r=this.abs(),i=X.magnitude(r._hi),s=X.TEN.pow(i);r=r.divide(s),r.gt(X.TEN)?(r=r.divide(X.TEN),i+=1):r.lt(X.ONE)&&(r=r.multiply(X.TEN),i-=1);for(var o=i+1,a=new Vr,l=X.MAX_PRINT_DIGITS-1,c=0;c<=l;c++){t&&c===o&&a.append(".");var u=Math.trunc(r._hi);if(u<0)break;var h=!1,f=0;u>9?(h=!0,f="9"):f="0"+u,a.append(f),r=r.subtract(X.valueOf(u)).multiply(X.TEN),h&&r.selfAdd(X.TEN);var d=!0,p=X.magnitude(r._hi);if(p<0&&Math.abs(p)>=l-c&&(d=!1),!d)break}return e[0]=i,a.toString()};X.prototype.sqr=function(){return this.multiply(this)};X.prototype.doubleValue=function(){return this._hi+this._lo};X.prototype.subtract=function(){if(arguments[0]instanceof X){var t=arguments[0];return this.add(t.negate())}else if(typeof arguments[0]=="number"){var e=arguments[0];return this.add(-e)}};X.prototype.equals=function(){if(arguments.length===1){var t=arguments[0];return this._hi===t._hi&&this._lo===t._lo}};X.prototype.isZero=function(){return this._hi===0&&this._lo===0};X.prototype.selfSubtract=function(){if(arguments[0]instanceof X){var t=arguments[0];return this.isNaN()?this:this.selfAdd(-t._hi,-t._lo)}else if(typeof arguments[0]=="number"){var e=arguments[0];return this.isNaN()?this:this.selfAdd(-e,0)}};X.prototype.getSpecialNumberString=function(){return this.isZero()?"0.0":this.isNaN()?"NaN ":null};X.prototype.min=function(t){return this.le(t)?this:t};X.prototype.selfDivide=function(){if(arguments.length===1){if(arguments[0]instanceof X){var t=arguments[0];return this.selfDivide(t._hi,t._lo)}else if(typeof arguments[0]=="number"){var e=arguments[0];return this.selfDivide(e,0)}}else if(arguments.length===2){var r=arguments[0],i=arguments[1],s=null,o=null,a=null,l=null,c=null,u=null,h=null,f=null;return c=this._hi/r,u=X.SPLIT*c,s=u-c,f=X.SPLIT*r,s=u-s,o=c-s,a=f-r,h=c*r,a=f-a,l=r-a,f=s*a-h+s*l+o*a+o*l,u=(this._hi-h-f+this._lo-c*i)/r,f=c+u,this._hi=f,this._lo=c-f+u,this}};X.prototype.dump=function(){return"DD<"+this._hi+", "+this._lo+">"};X.prototype.divide=function(){if(arguments[0]instanceof X){var t=arguments[0],e=null,r=null,i=null,s=null,o=null,a=null,l=null,c=null;o=this._hi/t._hi,a=X.SPLIT*o,e=a-o,c=X.SPLIT*t._hi,e=a-e,r=o-e,i=c-t._hi,l=o*t._hi,i=c-i,s=t._hi-i,c=e*i-l+e*s+r*i+r*s,a=(this._hi-l-c+this._lo-o*t._lo)/t._hi,c=o+a;var u=c,h=o-c+a;return new X(u,h)}else if(typeof arguments[0]=="number"){var f=arguments[0];return dt.isNaN(f)?X.createNaN():X.copy(this).selfDivide(f,0)}};X.prototype.ge=function(t){return(this._hi>t._hi||this._hi===t._hi)&&this._lo>=t._lo};X.prototype.pow=function(t){if(t===0)return X.valueOf(1);var e=new X(this),r=X.valueOf(1),i=Math.abs(t);if(i>1)for(;i>0;)i%2===1&&r.selfMultiply(e),i/=2,i>0&&(e=e.sqr());else r=e;return t<0?r.reciprocal():r};X.prototype.ceil=function(){if(this.isNaN())return X.NaN;var t=Math.ceil(this._hi),e=0;return t===this._hi&&(e=Math.ceil(this._lo)),new X(t,e)};X.prototype.compareTo=function(t){var e=t;return this._hi<e._hi?-1:this._hi>e._hi?1:this._lo<e._lo?-1:this._lo>e._lo?1:0};X.prototype.rint=function(){if(this.isNaN())return this;var t=this.add(.5);return t.floor()};X.prototype.setValue=function(){if(arguments[0]instanceof X){var t=arguments[0];return this.init(t),this}else if(typeof arguments[0]=="number"){var e=arguments[0];return this.init(e),this}};X.prototype.max=function(t){return this.ge(t)?this:t};X.prototype.sqrt=function(){if(this.isZero())return X.valueOf(0);if(this.isNegative())return X.NaN;var t=1/Math.sqrt(this._hi),e=this._hi*t,r=X.valueOf(e),i=this.subtract(r.sqr()),s=i._hi*(t*.5);return r.add(s)};X.prototype.selfAdd=function(){if(arguments.length===1){if(arguments[0]instanceof X){var t=arguments[0];return this.selfAdd(t._hi,t._lo)}else if(typeof arguments[0]=="number"){var e=arguments[0],r=null,i=null,s=null,o=null,a=null,l=null;return s=this._hi+e,a=s-this._hi,o=s-a,o=e-a+(this._hi-o),l=o+this._lo,r=s+l,i=l+(s-r),this._hi=r+i,this._lo=i+(r-this._hi),this}}else if(arguments.length===2){var c=arguments[0],u=arguments[1],h=null,f=null,d=null,p=null,_=null,v=null,E=null,m=null;_=this._hi+c,d=this._lo+u,E=_-this._hi,m=d-this._lo,v=_-E,p=d-m,v=c-E+(this._hi-v),p=u-m+(this._lo-p),E=v+d,h=_+E,f=E+(_-h),E=p+f;var g=h+E,y=E+(h-g);return this._hi=g,this._lo=y,this}};X.prototype.selfMultiply=function(){if(arguments.length===1){if(arguments[0]instanceof X){var t=arguments[0];return this.selfMultiply(t._hi,t._lo)}else if(typeof arguments[0]=="number"){var e=arguments[0];return this.selfMultiply(e,0)}}else if(arguments.length===2){var r=arguments[0],i=arguments[1],s=null,o=null,a=null,l=null,c=null,u=null;c=X.SPLIT*this._hi,s=c-this._hi,u=X.SPLIT*r,s=c-s,o=this._hi-s,a=u-r,c=this._hi*r,a=u-a,l=r-a,u=s*a-c+s*l+o*a+o*l+(this._hi*i+this._lo*r);var h=c+u;s=c-h;var f=u+s;return this._hi=h,this._lo=f,this}};X.prototype.selfSqr=function(){return this.selfMultiply(this)};X.prototype.floor=function(){if(this.isNaN())return X.NaN;var t=Math.floor(this._hi),e=0;return t===this._hi&&(e=Math.floor(this._lo)),new X(t,e)};X.prototype.negate=function(){return this.isNaN()?this:new X(-this._hi,-this._lo)};X.prototype.clone=function(){};X.prototype.multiply=function(){if(arguments[0]instanceof X){var t=arguments[0];return t.isNaN()?X.createNaN():X.copy(this).selfMultiply(t)}else if(typeof arguments[0]=="number"){var e=arguments[0];return dt.isNaN(e)?X.createNaN():X.copy(this).selfMultiply(e,0)}};X.prototype.isNaN=function(){return dt.isNaN(this._hi)};X.prototype.intValue=function(){return Math.trunc(this._hi)};X.prototype.toString=function(){var t=X.magnitude(this._hi);return t>=-3&&t<=20?this.toStandardNotation():this.toSciNotation()};X.prototype.toStandardNotation=function(){var t=this.getSpecialNumberString();if(t!==null)return t;var e=new Array(1).fill(null),r=this.extractSignificantDigits(!0,e),i=e[0]+1,s=r;if(r.charAt(0)===".")s="0"+r;else if(i<0)s="0."+X.stringOfChar("0",-i)+r;else if(r.indexOf(".")===-1){var o=i-r.length,a=X.stringOfChar("0",o);s=r+a+".0"}return this.isNegative()?"-"+s:s};X.prototype.reciprocal=function(){var t=null,e=null,r=null,i=null,s=null,o=null,a=null,l=null;s=1/this._hi,o=X.SPLIT*s,t=o-s,l=X.SPLIT*this._hi,t=o-t,e=s-t,r=l-this._hi,a=s*this._hi,r=l-r,i=this._hi-r,l=t*r-a+t*i+e*r+e*i,o=(1-a-l-s*this._lo)/this._hi;var c=s+o,u=s-c+o;return new X(c,u)};X.prototype.toSciNotation=function(){if(this.isZero())return X.SCI_NOT_ZERO;var t=this.getSpecialNumberString();if(t!==null)return t;var e=new Array(1).fill(null),r=this.extractSignificantDigits(!1,e),i=X.SCI_NOT_EXPONENT_CHAR+e[0];if(r.charAt(0)==="0")throw new Error("Found leading zero: "+r);var s="";r.length>1&&(s=r.substring(1));var o=r.charAt(0)+"."+s;return this.isNegative()?"-"+o+i:o+i};X.prototype.abs=function(){return this.isNaN()?X.NaN:this.isNegative()?this.negate():new X(this)};X.prototype.isPositive=function(){return(this._hi>0||this._hi===0)&&this._lo>0};X.prototype.lt=function(t){return(this._hi<t._hi||this._hi===t._hi)&&this._lo<t._lo};X.prototype.add=function(){if(arguments[0]instanceof X){var t=arguments[0];return X.copy(this).selfAdd(t)}else if(typeof arguments[0]=="number"){var e=arguments[0];return X.copy(this).selfAdd(e)}};X.prototype.init=function(){if(arguments.length===1){if(typeof arguments[0]=="number"){var t=arguments[0];this._hi=t,this._lo=0}else if(arguments[0]instanceof X){var e=arguments[0];this._hi=e._hi,this._lo=e._lo}}else if(arguments.length===2){var r=arguments[0],i=arguments[1];this._hi=r,this._lo=i}};X.prototype.gt=function(t){return(this._hi>t._hi||this._hi===t._hi)&&this._lo>t._lo};X.prototype.isNegative=function(){return(this._hi<0||this._hi===0)&&this._lo<0};X.prototype.trunc=function(){return this.isNaN()?X.NaN:this.isPositive()?this.floor():this.ceil()};X.prototype.signum=function(){return this._hi>0?1:this._hi<0?-1:this._lo>0?1:this._lo<0?-1:0};X.prototype.interfaces_=function(){return[Yn,Gn,Nh]};X.prototype.getClass=function(){return X};X.sqr=function(t){return X.valueOf(t).selfMultiply(t)};X.valueOf=function(){if(typeof arguments[0]=="string"){var t=arguments[0];return X.parse(t)}else if(typeof arguments[0]=="number"){var e=arguments[0];return new X(e)}};X.sqrt=function(t){return X.valueOf(t).sqrt()};X.parse=function(t){for(var e=0,r=t.length;Dl.isWhitespace(t.charAt(e));)e++;var i=!1;if(e<r){var s=t.charAt(e);(s==="-"||s==="+")&&(e++,s==="-"&&(i=!0))}for(var o=new X,a=0,l=0,c=0;!(e>=r);){var u=t.charAt(e);if(e++,Dl.isDigit(u)){var h=u-"0";o.selfMultiply(X.TEN),o.selfAdd(h),a++;continue}if(u==="."){l=a;continue}if(u==="e"||u==="E"){var f=t.substring(e);try{c=Ar.parseInt(f)}catch(E){throw E instanceof Error?new Error("Invalid exponent "+f+" in string "+t):E}finally{}break}throw new Error("Unexpected character '"+u+"' at position "+e+" in string "+t)}var d=o,p=a-l-c;if(p===0)d=o;else if(p>0){var _=X.TEN.pow(p);d=o.divide(_)}else if(p<0){var v=X.TEN.pow(-p);d=o.multiply(v)}return i?d.negate():d};X.createNaN=function(){return new X(dt.NaN,dt.NaN)};X.copy=function(t){return new X(t)};X.magnitude=function(t){var e=Math.abs(t),r=Math.log(e)/Math.log(10),i=Math.trunc(Math.floor(r)),s=Math.pow(10,i);return s*10<=e&&(i+=1),i};X.stringOfChar=function(t,e){for(var r=new Vr,i=0;i<e;i++)r.append(t);return r.toString()};ur.PI.get=function(){return new X(3.141592653589793,12246467991473532e-32)};ur.TWO_PI.get=function(){return new X(6.283185307179586,24492935982947064e-32)};ur.PI_2.get=function(){return new X(1.5707963267948966,6123233995736766e-32)};ur.E.get=function(){return new X(2.718281828459045,14456468917292502e-32)};ur.NaN.get=function(){return new X(dt.NaN,dt.NaN)};ur.EPS.get=function(){return 123259516440783e-46};ur.SPLIT.get=function(){return 134217729};ur.MAX_PRINT_DIGITS.get=function(){return 32};ur.TEN.get=function(){return X.valueOf(10)};ur.ONE.get=function(){return X.valueOf(1)};ur.SCI_NOT_EXPONENT_CHAR.get=function(){return"E"};ur.SCI_NOT_ZERO.get=function(){return"0.0E0"};Object.defineProperties(X,ur);var ln=function(){},qx={DP_SAFE_EPSILON:{configurable:!0}};ln.prototype.interfaces_=function(){return[]};ln.prototype.getClass=function(){return ln};ln.orientationIndex=function(t,e,r){var i=ln.orientationIndexFilter(t,e,r);if(i<=1)return i;var s=X.valueOf(e.x).selfAdd(-t.x),o=X.valueOf(e.y).selfAdd(-t.y),a=X.valueOf(r.x).selfAdd(-e.x),l=X.valueOf(r.y).selfAdd(-e.y);return s.selfMultiply(l).selfSubtract(o.selfMultiply(a)).signum()};ln.signOfDet2x2=function(t,e,r,i){var s=t.multiply(i).selfSubtract(e.multiply(r));return s.signum()};ln.intersection=function(t,e,r,i){var s=X.valueOf(i.y).selfSubtract(r.y).selfMultiply(X.valueOf(e.x).selfSubtract(t.x)),o=X.valueOf(i.x).selfSubtract(r.x).selfMultiply(X.valueOf(e.y).selfSubtract(t.y)),a=s.subtract(o),l=X.valueOf(i.x).selfSubtract(r.x).selfMultiply(X.valueOf(t.y).selfSubtract(r.y)),c=X.valueOf(i.y).selfSubtract(r.y).selfMultiply(X.valueOf(t.x).selfSubtract(r.x)),u=l.subtract(c),h=u.selfDivide(a).doubleValue(),f=X.valueOf(t.x).selfAdd(X.valueOf(e.x).selfSubtract(t.x).selfMultiply(h)).doubleValue(),d=X.valueOf(e.x).selfSubtract(t.x).selfMultiply(X.valueOf(t.y).selfSubtract(r.y)),p=X.valueOf(e.y).selfSubtract(t.y).selfMultiply(X.valueOf(t.x).selfSubtract(r.x)),_=d.subtract(p),v=_.selfDivide(a).doubleValue(),E=X.valueOf(r.y).selfAdd(X.valueOf(i.y).selfSubtract(r.y).selfMultiply(v)).doubleValue();return new z(f,E)};ln.orientationIndexFilter=function(t,e,r){var i=null,s=(t.x-r.x)*(e.y-r.y),o=(t.y-r.y)*(e.x-r.x),a=s-o;if(s>0){if(o<=0)return ln.signum(a);i=s+o}else if(s<0){if(o>=0)return ln.signum(a);i=-s-o}else return ln.signum(a);var l=ln.DP_SAFE_EPSILON*i;return a>=l||-a>=l?ln.signum(a):2};ln.signum=function(t){return t>0?1:t<0?-1:0};qx.DP_SAFE_EPSILON.get=function(){return 1e-15};Object.defineProperties(ln,qx);var xt=function(){},fc={X:{configurable:!0},Y:{configurable:!0},Z:{configurable:!0},M:{configurable:!0}};fc.X.get=function(){return 0};fc.Y.get=function(){return 1};fc.Z.get=function(){return 2};fc.M.get=function(){return 3};xt.prototype.setOrdinate=function(t,e,r){};xt.prototype.size=function(){};xt.prototype.getOrdinate=function(t,e){};xt.prototype.getCoordinate=function(){};xt.prototype.getCoordinateCopy=function(t){};xt.prototype.getDimension=function(){};xt.prototype.getX=function(t){};xt.prototype.clone=function(){};xt.prototype.expandEnvelope=function(t){};xt.prototype.copy=function(){};xt.prototype.getY=function(t){};xt.prototype.toCoordinateArray=function(){};xt.prototype.interfaces_=function(){return[Nh]};xt.prototype.getClass=function(){return xt};Object.defineProperties(xt,fc);var Kx=function(){},Ga=function(n){function t(){n.call(this,"Projective point not representable on the Cartesian plane.")}return n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t,t.prototype.interfaces_=function(){return[]},t.prototype.getClass=function(){return t},t}(Kx),De=function(){};De.arraycopy=function(t,e,r,i,s){for(var o=0,a=e;a<e+s;a++)r[i+o]=t[a],o++};De.getProperty=function(t){return{"line.separator":`
`}[t]};var Qn=function n(){if(this.x=null,this.y=null,this.w=null,arguments.length===0)this.x=0,this.y=0,this.w=1;else if(arguments.length===1){var t=arguments[0];this.x=t.x,this.y=t.y,this.w=1}else if(arguments.length===2){if(typeof arguments[0]=="number"&&typeof arguments[1]=="number"){var e=arguments[0],r=arguments[1];this.x=e,this.y=r,this.w=1}else if(arguments[0]instanceof n&&arguments[1]instanceof n){var i=arguments[0],s=arguments[1];this.x=i.y*s.w-s.y*i.w,this.y=s.x*i.w-i.x*s.w,this.w=i.x*s.y-s.x*i.y}else if(arguments[0]instanceof z&&arguments[1]instanceof z){var o=arguments[0],a=arguments[1];this.x=o.y-a.y,this.y=a.x-o.x,this.w=o.x*a.y-a.x*o.y}}else if(arguments.length===3){var l=arguments[0],c=arguments[1],u=arguments[2];this.x=l,this.y=c,this.w=u}else if(arguments.length===4){var h=arguments[0],f=arguments[1],d=arguments[2],p=arguments[3],_=h.y-f.y,v=f.x-h.x,E=h.x*f.y-f.x*h.y,m=d.y-p.y,g=p.x-d.x,y=d.x*p.y-p.x*d.y;this.x=v*y-g*E,this.y=m*E-_*y,this.w=_*g-m*v}};Qn.prototype.getY=function(){var t=this.y/this.w;if(dt.isNaN(t)||dt.isInfinite(t))throw new Ga;return t};Qn.prototype.getX=function(){var t=this.x/this.w;if(dt.isNaN(t)||dt.isInfinite(t))throw new Ga;return t};Qn.prototype.getCoordinate=function(){var t=new z;return t.x=this.getX(),t.y=this.getY(),t};Qn.prototype.interfaces_=function(){return[]};Qn.prototype.getClass=function(){return Qn};Qn.intersection=function(t,e,r,i){var s=t.y-e.y,o=e.x-t.x,a=t.x*e.y-e.x*t.y,l=r.y-i.y,c=i.x-r.x,u=r.x*i.y-i.x*r.y,h=o*u-c*a,f=l*a-s*u,d=s*c-l*o,p=h/d,_=f/d;if(dt.isNaN(p)||dt.isInfinite(p)||dt.isNaN(_)||dt.isInfinite(_))throw new Ga;return new z(p,_)};var st=function n(){if(this._minx=null,this._maxx=null,this._miny=null,this._maxy=null,arguments.length===0)this.init();else if(arguments.length===1){if(arguments[0]instanceof z){var t=arguments[0];this.init(t.x,t.x,t.y,t.y)}else if(arguments[0]instanceof n){var e=arguments[0];this.init(e)}}else if(arguments.length===2){var r=arguments[0],i=arguments[1];this.init(r.x,i.x,r.y,i.y)}else if(arguments.length===4){var s=arguments[0],o=arguments[1],a=arguments[2],l=arguments[3];this.init(s,o,a,l)}},Zx={serialVersionUID:{configurable:!0}};st.prototype.getArea=function(){return this.getWidth()*this.getHeight()};st.prototype.equals=function(t){if(!(t instanceof st))return!1;var e=t;return this.isNull()?e.isNull():this._maxx===e.getMaxX()&&this._maxy===e.getMaxY()&&this._minx===e.getMinX()&&this._miny===e.getMinY()};st.prototype.intersection=function(t){if(this.isNull()||t.isNull()||!this.intersects(t))return new st;var e=this._minx>t._minx?this._minx:t._minx,r=this._miny>t._miny?this._miny:t._miny,i=this._maxx<t._maxx?this._maxx:t._maxx,s=this._maxy<t._maxy?this._maxy:t._maxy;return new st(e,i,r,s)};st.prototype.isNull=function(){return this._maxx<this._minx};st.prototype.getMaxX=function(){return this._maxx};st.prototype.covers=function(){if(arguments.length===1){if(arguments[0]instanceof z){var t=arguments[0];return this.covers(t.x,t.y)}else if(arguments[0]instanceof st){var e=arguments[0];return this.isNull()||e.isNull()?!1:e.getMinX()>=this._minx&&e.getMaxX()<=this._maxx&&e.getMinY()>=this._miny&&e.getMaxY()<=this._maxy}}else if(arguments.length===2){var r=arguments[0],i=arguments[1];return this.isNull()?!1:r>=this._minx&&r<=this._maxx&&i>=this._miny&&i<=this._maxy}};st.prototype.intersects=function(){if(arguments.length===1){if(arguments[0]instanceof st){var t=arguments[0];return this.isNull()||t.isNull()?!1:!(t._minx>this._maxx||t._maxx<this._minx||t._miny>this._maxy||t._maxy<this._miny)}else if(arguments[0]instanceof z){var e=arguments[0];return this.intersects(e.x,e.y)}}else if(arguments.length===2){var r=arguments[0],i=arguments[1];return this.isNull()?!1:!(r>this._maxx||r<this._minx||i>this._maxy||i<this._miny)}};st.prototype.getMinY=function(){return this._miny};st.prototype.getMinX=function(){return this._minx};st.prototype.expandToInclude=function(){if(arguments.length===1){if(arguments[0]instanceof z){var t=arguments[0];this.expandToInclude(t.x,t.y)}else if(arguments[0]instanceof st){var e=arguments[0];if(e.isNull())return null;this.isNull()?(this._minx=e.getMinX(),this._maxx=e.getMaxX(),this._miny=e.getMinY(),this._maxy=e.getMaxY()):(e._minx<this._minx&&(this._minx=e._minx),e._maxx>this._maxx&&(this._maxx=e._maxx),e._miny<this._miny&&(this._miny=e._miny),e._maxy>this._maxy&&(this._maxy=e._maxy))}}else if(arguments.length===2){var r=arguments[0],i=arguments[1];this.isNull()?(this._minx=r,this._maxx=r,this._miny=i,this._maxy=i):(r<this._minx&&(this._minx=r),r>this._maxx&&(this._maxx=r),i<this._miny&&(this._miny=i),i>this._maxy&&(this._maxy=i))}};st.prototype.minExtent=function(){if(this.isNull())return 0;var t=this.getWidth(),e=this.getHeight();return t<e?t:e};st.prototype.getWidth=function(){return this.isNull()?0:this._maxx-this._minx};st.prototype.compareTo=function(t){var e=t;return this.isNull()?e.isNull()?0:-1:e.isNull()?1:this._minx<e._minx?-1:this._minx>e._minx?1:this._miny<e._miny?-1:this._miny>e._miny?1:this._maxx<e._maxx?-1:this._maxx>e._maxx?1:this._maxy<e._maxy?-1:this._maxy>e._maxy?1:0};st.prototype.translate=function(t,e){if(this.isNull())return null;this.init(this.getMinX()+t,this.getMaxX()+t,this.getMinY()+e,this.getMaxY()+e)};st.prototype.toString=function(){return"Env["+this._minx+" : "+this._maxx+", "+this._miny+" : "+this._maxy+"]"};st.prototype.setToNull=function(){this._minx=0,this._maxx=-1,this._miny=0,this._maxy=-1};st.prototype.getHeight=function(){return this.isNull()?0:this._maxy-this._miny};st.prototype.maxExtent=function(){if(this.isNull())return 0;var t=this.getWidth(),e=this.getHeight();return t>e?t:e};st.prototype.expandBy=function(){if(arguments.length===1){var t=arguments[0];this.expandBy(t,t)}else if(arguments.length===2){var e=arguments[0],r=arguments[1];if(this.isNull())return null;this._minx-=e,this._maxx+=e,this._miny-=r,this._maxy+=r,(this._minx>this._maxx||this._miny>this._maxy)&&this.setToNull()}};st.prototype.contains=function(){if(arguments.length===1){if(arguments[0]instanceof st){var t=arguments[0];return this.covers(t)}else if(arguments[0]instanceof z){var e=arguments[0];return this.covers(e)}}else if(arguments.length===2){var r=arguments[0],i=arguments[1];return this.covers(r,i)}};st.prototype.centre=function(){return this.isNull()?null:new z((this.getMinX()+this.getMaxX())/2,(this.getMinY()+this.getMaxY())/2)};st.prototype.init=function(){if(arguments.length===0)this.setToNull();else if(arguments.length===1){if(arguments[0]instanceof z){var t=arguments[0];this.init(t.x,t.x,t.y,t.y)}else if(arguments[0]instanceof st){var e=arguments[0];this._minx=e._minx,this._maxx=e._maxx,this._miny=e._miny,this._maxy=e._maxy}}else if(arguments.length===2){var r=arguments[0],i=arguments[1];this.init(r.x,i.x,r.y,i.y)}else if(arguments.length===4){var s=arguments[0],o=arguments[1],a=arguments[2],l=arguments[3];s<o?(this._minx=s,this._maxx=o):(this._minx=o,this._maxx=s),a<l?(this._miny=a,this._maxy=l):(this._miny=l,this._maxy=a)}};st.prototype.getMaxY=function(){return this._maxy};st.prototype.distance=function(t){if(this.intersects(t))return 0;var e=0;this._maxx<t._minx?e=t._minx-this._maxx:this._minx>t._maxx&&(e=this._minx-t._maxx);var r=0;return this._maxy<t._miny?r=t._miny-this._maxy:this._miny>t._maxy&&(r=this._miny-t._maxy),e===0?r:r===0?e:Math.sqrt(e*e+r*r)};st.prototype.hashCode=function(){var t=17;return t=37*t+z.hashCode(this._minx),t=37*t+z.hashCode(this._maxx),t=37*t+z.hashCode(this._miny),t=37*t+z.hashCode(this._maxy),t};st.prototype.interfaces_=function(){return[Gn,Yn]};st.prototype.getClass=function(){return st};st.intersects=function(){if(arguments.length===3){var t=arguments[0],e=arguments[1],r=arguments[2];return r.x>=(t.x<e.x?t.x:e.x)&&r.x<=(t.x>e.x?t.x:e.x)&&r.y>=(t.y<e.y?t.y:e.y)&&r.y<=(t.y>e.y?t.y:e.y)}else if(arguments.length===4){var i=arguments[0],s=arguments[1],o=arguments[2],a=arguments[3],l=Math.min(o.x,a.x),c=Math.max(o.x,a.x),u=Math.min(i.x,s.x),h=Math.max(i.x,s.x);return!(u>c||h<l||(l=Math.min(o.y,a.y),c=Math.max(o.y,a.y),u=Math.min(i.y,s.y),h=Math.max(i.y,s.y),u>c)||h<l)}};Zx.serialVersionUID.get=function(){return 5873921885273102e3};Object.defineProperties(st,Zx);var gr={typeStr:/^\s*(\w+)\s*\(\s*(.*)\s*\)\s*$/,emptyTypeStr:/^\s*(\w+)\s*EMPTY\s*$/,spaces:/\s+/,parenComma:/\)\s*,\s*\(/,doubleParenComma:/\)\s*\)\s*,\s*\(\s*\(/,trimParens:/^\s*\(?(.*?)\)?\s*$/},Oh=function(t){this.geometryFactory=t||new _t};Oh.prototype.read=function(t){var e,r,i;t=t.replace(/[\n\r]/g," ");var s=gr.typeStr.exec(t);if(t.search("EMPTY")!==-1&&(s=gr.emptyTypeStr.exec(t),s[2]=void 0),s&&(r=s[1].toLowerCase(),i=s[2],na[r]&&(e=na[r].apply(this,[i]))),e===void 0)throw new Error("Could not parse WKT "+t);return e};Oh.prototype.write=function(t){return this.extractGeometry(t)};Oh.prototype.extractGeometry=function(t){var e=t.getGeometryType().toLowerCase();if(!mi[e])return null;var r=e.toUpperCase(),i;return t.isEmpty()?i=r+" EMPTY":i=r+"("+mi[e].apply(this,[t])+")",i};var mi={coordinate:function(t){return t.x+" "+t.y},point:function(t){return mi.coordinate.call(this,t._coordinates._coordinates[0])},multipoint:function(t){for(var e=this,r=[],i=0,s=t._geometries.length;i<s;++i)r.push("("+mi.point.apply(e,[t._geometries[i]])+")");return r.join(",")},linestring:function(t){for(var e=this,r=[],i=0,s=t._points._coordinates.length;i<s;++i)r.push(mi.coordinate.apply(e,[t._points._coordinates[i]]));return r.join(",")},linearring:function(t){for(var e=this,r=[],i=0,s=t._points._coordinates.length;i<s;++i)r.push(mi.coordinate.apply(e,[t._points._coordinates[i]]));return r.join(",")},multilinestring:function(t){for(var e=this,r=[],i=0,s=t._geometries.length;i<s;++i)r.push("("+mi.linestring.apply(e,[t._geometries[i]])+")");return r.join(",")},polygon:function(t){var e=this,r=[];r.push("("+mi.linestring.apply(this,[t._shell])+")");for(var i=0,s=t._holes.length;i<s;++i)r.push("("+mi.linestring.apply(e,[t._holes[i]])+")");return r.join(",")},multipolygon:function(t){for(var e=this,r=[],i=0,s=t._geometries.length;i<s;++i)r.push("("+mi.polygon.apply(e,[t._geometries[i]])+")");return r.join(",")},geometrycollection:function(t){for(var e=this,r=[],i=0,s=t._geometries.length;i<s;++i)r.push(e.extractGeometry(t._geometries[i]));return r.join(",")}},na={point:function(t){if(t===void 0)return this.geometryFactory.createPoint();var e=t.trim().split(gr.spaces);return this.geometryFactory.createPoint(new z(Number.parseFloat(e[0]),Number.parseFloat(e[1])))},multipoint:function(t){var e=this;if(t===void 0)return this.geometryFactory.createMultiPoint();for(var r,i=t.trim().split(","),s=[],o=0,a=i.length;o<a;++o)r=i[o].replace(gr.trimParens,"$1"),s.push(na.point.apply(e,[r]));return this.geometryFactory.createMultiPoint(s)},linestring:function(t){if(t===void 0)return this.geometryFactory.createLineString();for(var e=t.trim().split(","),r=[],i,s=0,o=e.length;s<o;++s)i=e[s].trim().split(gr.spaces),r.push(new z(Number.parseFloat(i[0]),Number.parseFloat(i[1])));return this.geometryFactory.createLineString(r)},linearring:function(t){if(t===void 0)return this.geometryFactory.createLinearRing();for(var e=t.trim().split(","),r=[],i,s=0,o=e.length;s<o;++s)i=e[s].trim().split(gr.spaces),r.push(new z(Number.parseFloat(i[0]),Number.parseFloat(i[1])));return this.geometryFactory.createLinearRing(r)},multilinestring:function(t){var e=this;if(t===void 0)return this.geometryFactory.createMultiLineString();for(var r,i=t.trim().split(gr.parenComma),s=[],o=0,a=i.length;o<a;++o)r=i[o].replace(gr.trimParens,"$1"),s.push(na.linestring.apply(e,[r]));return this.geometryFactory.createMultiLineString(s)},polygon:function(t){var e=this;if(t===void 0)return this.geometryFactory.createPolygon();for(var r,i,s,o=t.trim().split(gr.parenComma),a,l=[],c=0,u=o.length;c<u;++c)r=o[c].replace(gr.trimParens,"$1"),i=na.linestring.apply(e,[r]),s=e.geometryFactory.createLinearRing(i._points),c===0?a=s:l.push(s);return this.geometryFactory.createPolygon(a,l)},multipolygon:function(t){var e=this;if(t===void 0)return this.geometryFactory.createMultiPolygon();for(var r,i=t.trim().split(gr.doubleParenComma),s=[],o=0,a=i.length;o<a;++o)r=i[o].replace(gr.trimParens,"$1"),s.push(na.polygon.apply(e,[r]));return this.geometryFactory.createMultiPolygon(s)},geometrycollection:function(t){var e=this;if(t===void 0)return this.geometryFactory.createGeometryCollection();t=t.replace(/,\s*([A-Za-z])/g,"|$1");for(var r=t.trim().split("|"),i=[],s=0,o=r.length;s<o;++s)i.push(e.read(r[s]));return this.geometryFactory.createGeometryCollection(i)}},er=function(t){this.parser=new Oh(t)};er.prototype.write=function(t){return this.parser.write(t)};er.toLineString=function(t,e){if(arguments.length!==2)throw new Error("Not implemented");return"LINESTRING ( "+t.x+" "+t.y+", "+e.x+" "+e.y+" )"};var Pi=function(n){function t(e){n.call(this,e),this.name="RuntimeException",this.message=e,this.stack=new n().stack}return n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t,t}(Error),Qu=function(n){function t(){if(n.call(this),arguments.length===0)n.call(this);else if(arguments.length===1){var e=arguments[0];n.call(this,e)}}return n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t,t.prototype.interfaces_=function(){return[]},t.prototype.getClass=function(){return t},t}(Pi),mt=function(){};mt.prototype.interfaces_=function(){return[]};mt.prototype.getClass=function(){return mt};mt.shouldNeverReachHere=function(){if(arguments.length===0)mt.shouldNeverReachHere(null);else if(arguments.length===1){var t=arguments[0];throw new Qu("Should never reach here"+(t!==null?": "+t:""))}};mt.isTrue=function(){var t,e;if(arguments.length===1)t=arguments[0],mt.isTrue(t,null);else if(arguments.length===2&&(t=arguments[0],e=arguments[1],!t))throw e===null?new Qu:new Qu(e)};mt.equals=function(){var t,e,r;if(arguments.length===2)t=arguments[0],e=arguments[1],mt.equals(t,e,null);else if(arguments.length===3&&(t=arguments[0],e=arguments[1],r=arguments[2],!e.equals(t)))throw new Qu("Expected "+t+" but encountered "+e+(r!==null?": "+r:""))};var qt=function(){this._result=null,this._inputLines=Array(2).fill().map(function(){return Array(2)}),this._intPt=new Array(2).fill(null),this._intLineIndex=null,this._isProper=null,this._pa=null,this._pb=null,this._precisionModel=null,this._intPt[0]=new z,this._intPt[1]=new z,this._pa=this._intPt[0],this._pb=this._intPt[1],this._result=0},Ro={DONT_INTERSECT:{configurable:!0},DO_INTERSECT:{configurable:!0},COLLINEAR:{configurable:!0},NO_INTERSECTION:{configurable:!0},POINT_INTERSECTION:{configurable:!0},COLLINEAR_INTERSECTION:{configurable:!0}};qt.prototype.getIndexAlongSegment=function(t,e){return this.computeIntLineIndex(),this._intLineIndex[t][e]};qt.prototype.getTopologySummary=function(){var t=new Vr;return this.isEndPoint()&&t.append(" endpoint"),this._isProper&&t.append(" proper"),this.isCollinear()&&t.append(" collinear"),t.toString()};qt.prototype.computeIntersection=function(t,e,r,i){this._inputLines[0][0]=t,this._inputLines[0][1]=e,this._inputLines[1][0]=r,this._inputLines[1][1]=i,this._result=this.computeIntersect(t,e,r,i)};qt.prototype.getIntersectionNum=function(){return this._result};qt.prototype.computeIntLineIndex=function(){if(arguments.length===0)this._intLineIndex===null&&(this._intLineIndex=Array(2).fill().map(function(){return Array(2)}),this.computeIntLineIndex(0),this.computeIntLineIndex(1));else if(arguments.length===1){var t=arguments[0],e=this.getEdgeDistance(t,0),r=this.getEdgeDistance(t,1);e>r?(this._intLineIndex[t][0]=0,this._intLineIndex[t][1]=1):(this._intLineIndex[t][0]=1,this._intLineIndex[t][1]=0)}};qt.prototype.isProper=function(){return this.hasIntersection()&&this._isProper};qt.prototype.setPrecisionModel=function(t){this._precisionModel=t};qt.prototype.isInteriorIntersection=function(){var t=this;if(arguments.length===0)return!!(this.isInteriorIntersection(0)||this.isInteriorIntersection(1));if(arguments.length===1){for(var e=arguments[0],r=0;r<this._result;r++)if(!(t._intPt[r].equals2D(t._inputLines[e][0])||t._intPt[r].equals2D(t._inputLines[e][1])))return!0;return!1}};qt.prototype.getIntersection=function(t){return this._intPt[t]};qt.prototype.isEndPoint=function(){return this.hasIntersection()&&!this._isProper};qt.prototype.hasIntersection=function(){return this._result!==qt.NO_INTERSECTION};qt.prototype.getEdgeDistance=function(t,e){var r=qt.computeEdgeDistance(this._intPt[e],this._inputLines[t][0],this._inputLines[t][1]);return r};qt.prototype.isCollinear=function(){return this._result===qt.COLLINEAR_INTERSECTION};qt.prototype.toString=function(){return er.toLineString(this._inputLines[0][0],this._inputLines[0][1])+" - "+er.toLineString(this._inputLines[1][0],this._inputLines[1][1])+this.getTopologySummary()};qt.prototype.getEndpoint=function(t,e){return this._inputLines[t][e]};qt.prototype.isIntersection=function(t){for(var e=this,r=0;r<this._result;r++)if(e._intPt[r].equals2D(t))return!0;return!1};qt.prototype.getIntersectionAlongSegment=function(t,e){return this.computeIntLineIndex(),this._intPt[this._intLineIndex[t][e]]};qt.prototype.interfaces_=function(){return[]};qt.prototype.getClass=function(){return qt};qt.computeEdgeDistance=function(t,e,r){var i=Math.abs(r.x-e.x),s=Math.abs(r.y-e.y),o=-1;if(t.equals(e))o=0;else if(t.equals(r))i>s?o=i:o=s;else{var a=Math.abs(t.x-e.x),l=Math.abs(t.y-e.y);i>s?o=a:o=l,o===0&&!t.equals(e)&&(o=Math.max(a,l))}return mt.isTrue(!(o===0&&!t.equals(e)),"Bad distance calculation"),o};qt.nonRobustComputeEdgeDistance=function(t,e,r){var i=t.x-e.x,s=t.y-e.y,o=Math.sqrt(i*i+s*s);return mt.isTrue(!(o===0&&!t.equals(e)),"Invalid distance calculation"),o};Ro.DONT_INTERSECT.get=function(){return 0};Ro.DO_INTERSECT.get=function(){return 1};Ro.COLLINEAR.get=function(){return 2};Ro.NO_INTERSECTION.get=function(){return 0};Ro.POINT_INTERSECTION.get=function(){return 1};Ro.COLLINEAR_INTERSECTION.get=function(){return 2};Object.defineProperties(qt,Ro);var Hs=function(n){function t(){n.apply(this,arguments)}return n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t,t.prototype.isInSegmentEnvelopes=function(r){var i=new st(this._inputLines[0][0],this._inputLines[0][1]),s=new st(this._inputLines[1][0],this._inputLines[1][1]);return i.contains(r)&&s.contains(r)},t.prototype.computeIntersection=function(){if(arguments.length===3){var r=arguments[0],i=arguments[1],s=arguments[2];if(this._isProper=!1,st.intersects(i,s,r)&&rt.orientationIndex(i,s,r)===0&&rt.orientationIndex(s,i,r)===0)return this._isProper=!0,(r.equals(i)||r.equals(s))&&(this._isProper=!1),this._result=n.POINT_INTERSECTION,null;this._result=n.NO_INTERSECTION}else return n.prototype.computeIntersection.apply(this,arguments)},t.prototype.normalizeToMinimum=function(r,i,s,o,a){a.x=this.smallestInAbsValue(r.x,i.x,s.x,o.x),a.y=this.smallestInAbsValue(r.y,i.y,s.y,o.y),r.x-=a.x,r.y-=a.y,i.x-=a.x,i.y-=a.y,s.x-=a.x,s.y-=a.y,o.x-=a.x,o.y-=a.y},t.prototype.safeHCoordinateIntersection=function(r,i,s,o){var a=null;try{a=Qn.intersection(r,i,s,o)}catch(l){if(l instanceof Ga)a=t.nearestEndpoint(r,i,s,o);else throw l}finally{}return a},t.prototype.intersection=function(r,i,s,o){var a=this.intersectionWithNormalization(r,i,s,o);return this.isInSegmentEnvelopes(a)||(a=new z(t.nearestEndpoint(r,i,s,o))),this._precisionModel!==null&&this._precisionModel.makePrecise(a),a},t.prototype.smallestInAbsValue=function(r,i,s,o){var a=r,l=Math.abs(a);return Math.abs(i)<l&&(a=i,l=Math.abs(i)),Math.abs(s)<l&&(a=s,l=Math.abs(s)),Math.abs(o)<l&&(a=o),a},t.prototype.checkDD=function(r,i,s,o,a){var l=ln.intersection(r,i,s,o),c=this.isInSegmentEnvelopes(l);De.out.println("DD in env = "+c+"  --------------------- "+l),a.distance(l)>1e-4&&De.out.println("Distance = "+a.distance(l))},t.prototype.intersectionWithNormalization=function(r,i,s,o){var a=new z(r),l=new z(i),c=new z(s),u=new z(o),h=new z;this.normalizeToEnvCentre(a,l,c,u,h);var f=this.safeHCoordinateIntersection(a,l,c,u);return f.x+=h.x,f.y+=h.y,f},t.prototype.computeCollinearIntersection=function(r,i,s,o){var a=st.intersects(r,i,s),l=st.intersects(r,i,o),c=st.intersects(s,o,r),u=st.intersects(s,o,i);return a&&l?(this._intPt[0]=s,this._intPt[1]=o,n.COLLINEAR_INTERSECTION):c&&u?(this._intPt[0]=r,this._intPt[1]=i,n.COLLINEAR_INTERSECTION):a&&c?(this._intPt[0]=s,this._intPt[1]=r,s.equals(r)&&!l&&!u?n.POINT_INTERSECTION:n.COLLINEAR_INTERSECTION):a&&u?(this._intPt[0]=s,this._intPt[1]=i,s.equals(i)&&!l&&!c?n.POINT_INTERSECTION:n.COLLINEAR_INTERSECTION):l&&c?(this._intPt[0]=o,this._intPt[1]=r,o.equals(r)&&!a&&!u?n.POINT_INTERSECTION:n.COLLINEAR_INTERSECTION):l&&u?(this._intPt[0]=o,this._intPt[1]=i,o.equals(i)&&!a&&!c?n.POINT_INTERSECTION:n.COLLINEAR_INTERSECTION):n.NO_INTERSECTION},t.prototype.normalizeToEnvCentre=function(r,i,s,o,a){var l=r.x<i.x?r.x:i.x,c=r.y<i.y?r.y:i.y,u=r.x>i.x?r.x:i.x,h=r.y>i.y?r.y:i.y,f=s.x<o.x?s.x:o.x,d=s.y<o.y?s.y:o.y,p=s.x>o.x?s.x:o.x,_=s.y>o.y?s.y:o.y,v=l>f?l:f,E=u<p?u:p,m=c>d?c:d,g=h<_?h:_,y=(v+E)/2,b=(m+g)/2;a.x=y,a.y=b,r.x-=a.x,r.y-=a.y,i.x-=a.x,i.y-=a.y,s.x-=a.x,s.y-=a.y,o.x-=a.x,o.y-=a.y},t.prototype.computeIntersect=function(r,i,s,o){if(this._isProper=!1,!st.intersects(r,i,s,o))return n.NO_INTERSECTION;var a=rt.orientationIndex(r,i,s),l=rt.orientationIndex(r,i,o);if(a>0&&l>0||a<0&&l<0)return n.NO_INTERSECTION;var c=rt.orientationIndex(s,o,r),u=rt.orientationIndex(s,o,i);if(c>0&&u>0||c<0&&u<0)return n.NO_INTERSECTION;var h=a===0&&l===0&&c===0&&u===0;return h?this.computeCollinearIntersection(r,i,s,o):(a===0||l===0||c===0||u===0?(this._isProper=!1,r.equals2D(s)||r.equals2D(o)?this._intPt[0]=r:i.equals2D(s)||i.equals2D(o)?this._intPt[0]=i:a===0?this._intPt[0]=new z(s):l===0?this._intPt[0]=new z(o):c===0?this._intPt[0]=new z(r):u===0&&(this._intPt[0]=new z(i))):(this._isProper=!0,this._intPt[0]=this.intersection(r,i,s,o)),n.POINT_INTERSECTION)},t.prototype.interfaces_=function(){return[]},t.prototype.getClass=function(){return t},t.nearestEndpoint=function(r,i,s,o){var a=r,l=rt.distancePointLine(r,s,o),c=rt.distancePointLine(i,s,o);return c<l&&(l=c,a=i),c=rt.distancePointLine(s,r,i),c<l&&(l=c,a=s),c=rt.distancePointLine(o,r,i),c<l&&(l=c,a=o),a},t}(qt),po=function(){};po.prototype.interfaces_=function(){return[]};po.prototype.getClass=function(){return po};po.orientationIndex=function(t,e,r){var i=e.x-t.x,s=e.y-t.y,o=r.x-e.x,a=r.y-e.y;return po.signOfDet2x2(i,s,o,a)};po.signOfDet2x2=function(t,e,r,i){var s=null,o=null,a=null;if(s=1,t===0||i===0)return e===0||r===0?0:e>0?r>0?-s:s:r>0?s:-s;if(e===0||r===0)return i>0?t>0?s:-s:t>0?-s:s;if(e>0?i>0?e<=i||(s=-s,o=t,t=r,r=o,o=e,e=i,i=o):e<=-i?(s=-s,r=-r,i=-i):(o=t,t=-r,r=o,o=e,e=-i,i=o):i>0?-e<=i?(s=-s,t=-t,e=-e):(o=-t,t=r,r=o,o=-e,e=i,i=o):e>=i?(t=-t,e=-e,r=-r,i=-i):(s=-s,o=-t,t=-r,r=o,o=-e,e=-i,i=o),t>0)if(r>0){if(!(t<=r))return s}else return s;else{if(r>0)return-s;if(t>=r)s=-s,t=-t,r=-r;else return-s}for(;;){if(a=Math.floor(r/t),r=r-a*t,i=i-a*e,i<0)return-s;if(i>e)return s;if(t>r+r){if(e<i+i)return s}else{if(e>i+i)return-s;r=t-r,i=e-i,s=-s}if(i===0)return r===0?0:-s;if(r===0||(a=Math.floor(t/r),t=t-a*r,e=e-a*i,e<0))return s;if(e>i)return-s;if(r>t+t){if(i<e+e)return-s}else{if(i>e+e)return s;t=r-t,e=i-e,s=-s}if(e===0)return t===0?0:s;if(t===0)return-s}};var Sr=function(){this._p=null,this._crossingCount=0,this._isPointOnSegment=!1;var t=arguments[0];this._p=t};Sr.prototype.countSegment=function(t,e){if(t.x<this._p.x&&e.x<this._p.x)return null;if(this._p.x===e.x&&this._p.y===e.y)return this._isPointOnSegment=!0,null;if(t.y===this._p.y&&e.y===this._p.y){var r=t.x,i=e.x;return r>i&&(r=e.x,i=t.x),this._p.x>=r&&this._p.x<=i&&(this._isPointOnSegment=!0),null}if(t.y>this._p.y&&e.y<=this._p.y||e.y>this._p.y&&t.y<=this._p.y){var s=t.x-this._p.x,o=t.y-this._p.y,a=e.x-this._p.x,l=e.y-this._p.y,c=po.signOfDet2x2(s,o,a,l);if(c===0)return this._isPointOnSegment=!0,null;l<o&&(c=-c),c>0&&this._crossingCount++}};Sr.prototype.isPointInPolygon=function(){return this.getLocation()!==j.EXTERIOR};Sr.prototype.getLocation=function(){return this._isPointOnSegment?j.BOUNDARY:this._crossingCount%2===1?j.INTERIOR:j.EXTERIOR};Sr.prototype.isOnSegment=function(){return this._isPointOnSegment};Sr.prototype.interfaces_=function(){return[]};Sr.prototype.getClass=function(){return Sr};Sr.locatePointInRing=function(){if(arguments[0]instanceof z&&ct(arguments[1],xt)){for(var t=arguments[0],e=arguments[1],r=new Sr(t),i=new z,s=new z,o=1;o<e.size();o++)if(e.getCoordinate(o,i),e.getCoordinate(o-1,s),r.countSegment(i,s),r.isOnSegment())return r.getLocation();return r.getLocation()}else if(arguments[0]instanceof z&&arguments[1]instanceof Array){for(var a=arguments[0],l=arguments[1],c=new Sr(a),u=1;u<l.length;u++){var h=l[u],f=l[u-1];if(c.countSegment(h,f),c.isOnSegment())return c.getLocation()}return c.getLocation()}};var rt=function(){},No={CLOCKWISE:{configurable:!0},RIGHT:{configurable:!0},COUNTERCLOCKWISE:{configurable:!0},LEFT:{configurable:!0},COLLINEAR:{configurable:!0},STRAIGHT:{configurable:!0}};rt.prototype.interfaces_=function(){return[]};rt.prototype.getClass=function(){return rt};rt.orientationIndex=function(t,e,r){return ln.orientationIndex(t,e,r)};rt.signedArea=function(){if(arguments[0]instanceof Array){var t=arguments[0];if(t.length<3)return 0;for(var e=0,r=t[0].x,i=1;i<t.length-1;i++){var s=t[i].x-r,o=t[i+1].y,a=t[i-1].y;e+=s*(a-o)}return e/2}else if(ct(arguments[0],xt)){var l=arguments[0],c=l.size();if(c<3)return 0;var u=new z,h=new z,f=new z;l.getCoordinate(0,h),l.getCoordinate(1,f);var d=h.x;f.x-=d;for(var p=0,_=1;_<c-1;_++)u.y=h.y,h.x=f.x,h.y=f.y,l.getCoordinate(_+1,f),f.x-=d,p+=h.x*(u.y-f.y);return p/2}};rt.distanceLineLine=function(t,e,r,i){if(t.equals(e))return rt.distancePointLine(t,r,i);if(r.equals(i))return rt.distancePointLine(i,t,e);var s=!1;if(!st.intersects(t,e,r,i))s=!0;else{var o=(e.x-t.x)*(i.y-r.y)-(e.y-t.y)*(i.x-r.x);if(o===0)s=!0;else{var a=(t.y-r.y)*(i.x-r.x)-(t.x-r.x)*(i.y-r.y),l=(t.y-r.y)*(e.x-t.x)-(t.x-r.x)*(e.y-t.y),c=l/o,u=a/o;(u<0||u>1||c<0||c>1)&&(s=!0)}}return s?On.min(rt.distancePointLine(t,r,i),rt.distancePointLine(e,r,i),rt.distancePointLine(r,t,e),rt.distancePointLine(i,t,e)):0};rt.isPointInRing=function(t,e){return rt.locatePointInRing(t,e)!==j.EXTERIOR};rt.computeLength=function(t){var e=t.size();if(e<=1)return 0;var r=0,i=new z;t.getCoordinate(0,i);for(var s=i.x,o=i.y,a=1;a<e;a++){t.getCoordinate(a,i);var l=i.x,c=i.y,u=l-s,h=c-o;r+=Math.sqrt(u*u+h*h),s=l,o=c}return r};rt.isCCW=function(t){var e=t.length-1;if(e<3)throw new Xt("Ring has fewer than 4 points, so orientation cannot be determined");for(var r=t[0],i=0,s=1;s<=e;s++){var o=t[s];o.y>r.y&&(r=o,i=s)}var a=i;do a=a-1,a<0&&(a=e);while(t[a].equals2D(r)&&a!==i);var l=i;do l=(l+1)%e;while(t[l].equals2D(r)&&l!==i);var c=t[a],u=t[l];if(c.equals2D(r)||u.equals2D(r)||c.equals2D(u))return!1;var h=rt.computeOrientation(c,r,u),f=!1;return h===0?f=c.x>u.x:f=h>0,f};rt.locatePointInRing=function(t,e){return Sr.locatePointInRing(t,e)};rt.distancePointLinePerpendicular=function(t,e,r){var i=(r.x-e.x)*(r.x-e.x)+(r.y-e.y)*(r.y-e.y),s=((e.y-t.y)*(r.x-e.x)-(e.x-t.x)*(r.y-e.y))/i;return Math.abs(s)*Math.sqrt(i)};rt.computeOrientation=function(t,e,r){return rt.orientationIndex(t,e,r)};rt.distancePointLine=function(){if(arguments.length===2){var t=arguments[0],e=arguments[1];if(e.length===0)throw new Xt("Line array must contain at least one vertex");for(var r=t.distance(e[0]),i=0;i<e.length-1;i++){var s=rt.distancePointLine(t,e[i],e[i+1]);s<r&&(r=s)}return r}else if(arguments.length===3){var o=arguments[0],a=arguments[1],l=arguments[2];if(a.x===l.x&&a.y===l.y)return o.distance(a);var c=(l.x-a.x)*(l.x-a.x)+(l.y-a.y)*(l.y-a.y),u=((o.x-a.x)*(l.x-a.x)+(o.y-a.y)*(l.y-a.y))/c;if(u<=0)return o.distance(a);if(u>=1)return o.distance(l);var h=((a.y-o.y)*(l.x-a.x)-(a.x-o.x)*(l.y-a.y))/c;return Math.abs(h)*Math.sqrt(c)}};rt.isOnLine=function(t,e){for(var r=new Hs,i=1;i<e.length;i++){var s=e[i-1],o=e[i];if(r.computeIntersection(t,s,o),r.hasIntersection())return!0}return!1};No.CLOCKWISE.get=function(){return-1};No.RIGHT.get=function(){return rt.CLOCKWISE};No.COUNTERCLOCKWISE.get=function(){return 1};No.LEFT.get=function(){return rt.COUNTERCLOCKWISE};No.COLLINEAR.get=function(){return 0};No.STRAIGHT.get=function(){return rt.COLLINEAR};Object.defineProperties(rt,No);var Ii=function(){};Ii.prototype.filter=function(t){};Ii.prototype.interfaces_=function(){return[]};Ii.prototype.getClass=function(){return Ii};var lt=function(){var t=arguments[0];this._envelope=null,this._factory=null,this._SRID=null,this._userData=null,this._factory=t,this._SRID=t.getSRID()},ci={serialVersionUID:{configurable:!0},SORTINDEX_POINT:{configurable:!0},SORTINDEX_MULTIPOINT:{configurable:!0},SORTINDEX_LINESTRING:{configurable:!0},SORTINDEX_LINEARRING:{configurable:!0},SORTINDEX_MULTILINESTRING:{configurable:!0},SORTINDEX_POLYGON:{configurable:!0},SORTINDEX_MULTIPOLYGON:{configurable:!0},SORTINDEX_GEOMETRYCOLLECTION:{configurable:!0},geometryChangedFilter:{configurable:!0}};lt.prototype.isGeometryCollection=function(){return this.getSortIndex()===lt.SORTINDEX_GEOMETRYCOLLECTION};lt.prototype.getFactory=function(){return this._factory};lt.prototype.getGeometryN=function(t){return this};lt.prototype.getArea=function(){return 0};lt.prototype.isRectangle=function(){return!1};lt.prototype.equals=function(){if(arguments[0]instanceof lt){var t=arguments[0];return t===null?!1:this.equalsTopo(t)}else if(arguments[0]instanceof Object){var e=arguments[0];if(!(e instanceof lt))return!1;var r=e;return this.equalsExact(r)}};lt.prototype.equalsExact=function(t){return this===t||this.equalsExact(t,0)};lt.prototype.geometryChanged=function(){this.apply(lt.geometryChangedFilter)};lt.prototype.geometryChangedAction=function(){this._envelope=null};lt.prototype.equalsNorm=function(t){return t===null?!1:this.norm().equalsExact(t.norm())};lt.prototype.getLength=function(){return 0};lt.prototype.getNumGeometries=function(){return 1};lt.prototype.compareTo=function(){if(arguments.length===1){var t=arguments[0],e=t;return this.getSortIndex()!==e.getSortIndex()?this.getSortIndex()-e.getSortIndex():this.isEmpty()&&e.isEmpty()?0:this.isEmpty()?-1:e.isEmpty()?1:this.compareToSameClass(t)}else if(arguments.length===2){var r=arguments[0],i=arguments[1];return this.getSortIndex()!==r.getSortIndex()?this.getSortIndex()-r.getSortIndex():this.isEmpty()&&r.isEmpty()?0:this.isEmpty()?-1:r.isEmpty()?1:this.compareToSameClass(r,i)}};lt.prototype.getUserData=function(){return this._userData};lt.prototype.getSRID=function(){return this._SRID};lt.prototype.getEnvelope=function(){return this.getFactory().toGeometry(this.getEnvelopeInternal())};lt.prototype.checkNotGeometryCollection=function(t){if(t.getSortIndex()===lt.SORTINDEX_GEOMETRYCOLLECTION)throw new Xt("This method does not support GeometryCollection arguments")};lt.prototype.equal=function(t,e,r){return r===0?t.equals(e):t.distance(e)<=r};lt.prototype.norm=function(){var t=this.copy();return t.normalize(),t};lt.prototype.getPrecisionModel=function(){return this._factory.getPrecisionModel()};lt.prototype.getEnvelopeInternal=function(){return this._envelope===null&&(this._envelope=this.computeEnvelopeInternal()),new st(this._envelope)};lt.prototype.setSRID=function(t){this._SRID=t};lt.prototype.setUserData=function(t){this._userData=t};lt.prototype.compare=function(t,e){for(var r=t.iterator(),i=e.iterator();r.hasNext()&&i.hasNext();){var s=r.next(),o=i.next(),a=s.compareTo(o);if(a!==0)return a}return r.hasNext()?1:i.hasNext()?-1:0};lt.prototype.hashCode=function(){return this.getEnvelopeInternal().hashCode()};lt.prototype.isGeometryCollectionOrDerived=function(){return this.getSortIndex()===lt.SORTINDEX_GEOMETRYCOLLECTION||this.getSortIndex()===lt.SORTINDEX_MULTIPOINT||this.getSortIndex()===lt.SORTINDEX_MULTILINESTRING||this.getSortIndex()===lt.SORTINDEX_MULTIPOLYGON};lt.prototype.interfaces_=function(){return[Nh,Gn,Yn]};lt.prototype.getClass=function(){return lt};lt.hasNonEmptyElements=function(t){for(var e=0;e<t.length;e++)if(!t[e].isEmpty())return!0;return!1};lt.hasNullElements=function(t){for(var e=0;e<t.length;e++)if(t[e]===null)return!0;return!1};ci.serialVersionUID.get=function(){return 8763622679187377e3};ci.SORTINDEX_POINT.get=function(){return 0};ci.SORTINDEX_MULTIPOINT.get=function(){return 1};ci.SORTINDEX_LINESTRING.get=function(){return 2};ci.SORTINDEX_LINEARRING.get=function(){return 3};ci.SORTINDEX_MULTILINESTRING.get=function(){return 4};ci.SORTINDEX_POLYGON.get=function(){return 5};ci.SORTINDEX_MULTIPOLYGON.get=function(){return 6};ci.SORTINDEX_GEOMETRYCOLLECTION.get=function(){return 7};ci.geometryChangedFilter.get=function(){return cg};Object.defineProperties(lt,ci);var cg=function(){};cg.interfaces_=function(){return[Ii]};cg.filter=function(t){t.geometryChangedAction()};var Qr=function(){};Qr.prototype.filter=function(t){};Qr.prototype.interfaces_=function(){return[]};Qr.prototype.getClass=function(){return Qr};var jn=function(){},ki={Mod2BoundaryNodeRule:{configurable:!0},EndPointBoundaryNodeRule:{configurable:!0},MultiValentEndPointBoundaryNodeRule:{configurable:!0},MonoValentEndPointBoundaryNodeRule:{configurable:!0},MOD2_BOUNDARY_RULE:{configurable:!0},ENDPOINT_BOUNDARY_RULE:{configurable:!0},MULTIVALENT_ENDPOINT_BOUNDARY_RULE:{configurable:!0},MONOVALENT_ENDPOINT_BOUNDARY_RULE:{configurable:!0},OGC_SFS_BOUNDARY_RULE:{configurable:!0}};jn.prototype.isInBoundary=function(t){};jn.prototype.interfaces_=function(){return[]};jn.prototype.getClass=function(){return jn};ki.Mod2BoundaryNodeRule.get=function(){return ba};ki.EndPointBoundaryNodeRule.get=function(){return xa};ki.MultiValentEndPointBoundaryNodeRule.get=function(){return Ea};ki.MonoValentEndPointBoundaryNodeRule.get=function(){return wa};ki.MOD2_BOUNDARY_RULE.get=function(){return new ba};ki.ENDPOINT_BOUNDARY_RULE.get=function(){return new xa};ki.MULTIVALENT_ENDPOINT_BOUNDARY_RULE.get=function(){return new Ea};ki.MONOVALENT_ENDPOINT_BOUNDARY_RULE.get=function(){return new wa};ki.OGC_SFS_BOUNDARY_RULE.get=function(){return jn.MOD2_BOUNDARY_RULE};Object.defineProperties(jn,ki);var ba=function(){};ba.prototype.isInBoundary=function(t){return t%2===1};ba.prototype.interfaces_=function(){return[jn]};ba.prototype.getClass=function(){return ba};var xa=function(){};xa.prototype.isInBoundary=function(t){return t>0};xa.prototype.interfaces_=function(){return[jn]};xa.prototype.getClass=function(){return xa};var Ea=function(){};Ea.prototype.isInBoundary=function(t){return t>1};Ea.prototype.interfaces_=function(){return[jn]};Ea.prototype.getClass=function(){return Ea};var wa=function(){};wa.prototype.isInBoundary=function(t){return t===1};wa.prototype.interfaces_=function(){return[jn]};wa.prototype.getClass=function(){return wa};var he=function(){};he.prototype.add=function(){};he.prototype.addAll=function(){};he.prototype.isEmpty=function(){};he.prototype.iterator=function(){};he.prototype.size=function(){};he.prototype.toArray=function(){};he.prototype.remove=function(){};function ug(n){this.message=n||""}ug.prototype=new Error;ug.prototype.name="IndexOutOfBoundsException";var Ya=function(){};Ya.prototype.hasNext=function(){};Ya.prototype.next=function(){};Ya.prototype.remove=function(){};var tr=function(n){function t(){n.apply(this,arguments)}return n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t,t.prototype.get=function(){},t.prototype.set=function(){},t.prototype.isEmpty=function(){},t}(he);function qa(n){this.message=n||""}qa.prototype=new Error;qa.prototype.name="NoSuchElementException";var et=function(n){function t(){n.call(this),this.array_=[],arguments[0]instanceof he&&this.addAll(arguments[0])}return n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t,t.prototype.ensureCapacity=function(){},t.prototype.interfaces_=function(){return[n,he]},t.prototype.add=function(r){return arguments.length===1?this.array_.push(r):this.array_.splice(arguments[0],arguments[1]),!0},t.prototype.clear=function(){this.array_=[]},t.prototype.addAll=function(r){for(var i=this,s=r.iterator();s.hasNext();)i.add(s.next());return!0},t.prototype.set=function(r,i){var s=this.array_[r];return this.array_[r]=i,s},t.prototype.iterator=function(){return new nk(this)},t.prototype.get=function(r){if(r<0||r>=this.size())throw new ug;return this.array_[r]},t.prototype.isEmpty=function(){return this.array_.length===0},t.prototype.size=function(){return this.array_.length},t.prototype.toArray=function(){for(var r=this,i=[],s=0,o=this.array_.length;s<o;s++)i.push(r.array_[s]);return i},t.prototype.remove=function(r){for(var i=this,s=!1,o=0,a=this.array_.length;o<a;o++)if(i.array_[o]===r){i.array_.splice(o,1),s=!0;break}return s},t}(tr),nk=function(n){function t(e){n.call(this),this.arrayList_=e,this.position_=0}return n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t,t.prototype.next=function(){if(this.position_===this.arrayList_.size())throw new qa;return this.arrayList_.get(this.position_++)},t.prototype.hasNext=function(){return this.position_<this.arrayList_.size()},t.prototype.set=function(r){return this.arrayList_.set(this.position_-1,r)},t.prototype.remove=function(){this.arrayList_.remove(this.arrayList_.get(this.position_))},t}(Ya),dc=function(n){function t(){if(n.call(this),arguments.length!==0){if(arguments.length===1){var r=arguments[0];this.ensureCapacity(r.length),this.add(r,!0)}else if(arguments.length===2){var i=arguments[0],s=arguments[1];this.ensureCapacity(i.length),this.add(i,s)}}}n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t;var e={coordArrayType:{configurable:!0}};return e.coordArrayType.get=function(){return new Array(0).fill(null)},t.prototype.getCoordinate=function(i){return this.get(i)},t.prototype.addAll=function(){var i=this;if(arguments.length===2){for(var s=arguments[0],o=arguments[1],a=!1,l=s.iterator();l.hasNext();)i.add(l.next(),o),a=!0;return a}else return n.prototype.addAll.apply(this,arguments)},t.prototype.clone=function(){for(var i=this,s=n.prototype.clone.call(this),o=0;o<this.size();o++)s.add(o,i.get(o).copy());return s},t.prototype.toCoordinateArray=function(){return this.toArray(t.coordArrayType)},t.prototype.add=function(){var i=this;if(arguments.length===1){var s=arguments[0];n.prototype.add.call(this,s)}else if(arguments.length===2){if(arguments[0]instanceof Array&&typeof arguments[1]=="boolean"){var o=arguments[0],a=arguments[1];return this.add(o,a,!0),!0}else if(arguments[0]instanceof z&&typeof arguments[1]=="boolean"){var l=arguments[0],c=arguments[1];if(!c&&this.size()>=1){var u=this.get(this.size()-1);if(u.equals2D(l))return null}n.prototype.add.call(this,l)}else if(arguments[0]instanceof Object&&typeof arguments[1]=="boolean"){var h=arguments[0],f=arguments[1];return this.add(h,f),!0}}else if(arguments.length===3){if(typeof arguments[2]=="boolean"&&arguments[0]instanceof Array&&typeof arguments[1]=="boolean"){var d=arguments[0],p=arguments[1],_=arguments[2];if(_)for(var v=0;v<d.length;v++)i.add(d[v],p);else for(var E=d.length-1;E>=0;E--)i.add(d[E],p);return!0}else if(typeof arguments[2]=="boolean"&&Number.isInteger(arguments[0])&&arguments[1]instanceof z){var m=arguments[0],g=arguments[1],y=arguments[2];if(!y){var b=this.size();if(b>0){if(m>0){var x=this.get(m-1);if(x.equals2D(g))return null}if(m<b){var w=this.get(m);if(w.equals2D(g))return null}}}n.prototype.add.call(this,m,g)}}else if(arguments.length===4){var S=arguments[0],I=arguments[1],T=arguments[2],M=arguments[3],L=1;T>M&&(L=-1);for(var O=T;O!==M;O+=L)i.add(S[O],I);return!0}},t.prototype.closeRing=function(){this.size()>0&&this.add(new z(this.get(0)),!1)},t.prototype.interfaces_=function(){return[]},t.prototype.getClass=function(){return t},Object.defineProperties(t,e),t}(et),yt=function(){},Dh={ForwardComparator:{configurable:!0},BidirectionalComparator:{configurable:!0},coordArrayType:{configurable:!0}};Dh.ForwardComparator.get=function(){return Ll};Dh.BidirectionalComparator.get=function(){return Sa};Dh.coordArrayType.get=function(){return new Array(0).fill(null)};yt.prototype.interfaces_=function(){return[]};yt.prototype.getClass=function(){return yt};yt.isRing=function(t){return!(t.length<4||!t[0].equals2D(t[t.length-1]))};yt.ptNotInList=function(t,e){for(var r=0;r<t.length;r++){var i=t[r];if(yt.indexOf(i,e)<0)return i}return null};yt.scroll=function(t,e){var r=yt.indexOf(e,t);if(r<0)return null;var i=new Array(t.length).fill(null);De.arraycopy(t,r,i,0,t.length-r),De.arraycopy(t,0,i,t.length-r,r),De.arraycopy(i,0,t,0,t.length)};yt.equals=function(){if(arguments.length===2){var t=arguments[0],e=arguments[1];if(t===e)return!0;if(t===null||e===null||t.length!==e.length)return!1;for(var r=0;r<t.length;r++)if(!t[r].equals(e[r]))return!1;return!0}else if(arguments.length===3){var i=arguments[0],s=arguments[1],o=arguments[2];if(i===s)return!0;if(i===null||s===null||i.length!==s.length)return!1;for(var a=0;a<i.length;a++)if(o.compare(i[a],s[a])!==0)return!1;return!0}};yt.intersection=function(t,e){for(var r=new dc,i=0;i<t.length;i++)e.intersects(t[i])&&r.add(t[i],!0);return r.toCoordinateArray()};yt.hasRepeatedPoints=function(t){for(var e=1;e<t.length;e++)if(t[e-1].equals(t[e]))return!0;return!1};yt.removeRepeatedPoints=function(t){if(!yt.hasRepeatedPoints(t))return t;var e=new dc(t,!1);return e.toCoordinateArray()};yt.reverse=function(t){for(var e=t.length-1,r=Math.trunc(e/2),i=0;i<=r;i++){var s=t[i];t[i]=t[e-i],t[e-i]=s}};yt.removeNull=function(t){for(var e=0,r=0;r<t.length;r++)t[r]!==null&&e++;var i=new Array(e).fill(null);if(e===0)return i;for(var s=0,o=0;o<t.length;o++)t[o]!==null&&(i[s++]=t[o]);return i};yt.copyDeep=function(){if(arguments.length===1){for(var t=arguments[0],e=new Array(t.length).fill(null),r=0;r<t.length;r++)e[r]=new z(t[r]);return e}else if(arguments.length===5)for(var i=arguments[0],s=arguments[1],o=arguments[2],a=arguments[3],l=arguments[4],c=0;c<l;c++)o[a+c]=new z(i[s+c])};yt.isEqualReversed=function(t,e){for(var r=0;r<t.length;r++){var i=t[r],s=e[t.length-r-1];if(i.compareTo(s)!==0)return!1}return!0};yt.envelope=function(t){for(var e=new st,r=0;r<t.length;r++)e.expandToInclude(t[r]);return e};yt.toCoordinateArray=function(t){return t.toArray(yt.coordArrayType)};yt.atLeastNCoordinatesOrNothing=function(t,e){return e.length>=t?e:[]};yt.indexOf=function(t,e){for(var r=0;r<e.length;r++)if(t.equals(e[r]))return r;return-1};yt.increasingDirection=function(t){for(var e=0;e<Math.trunc(t.length/2);e++){var r=t.length-1-e,i=t[e].compareTo(t[r]);if(i!==0)return i}return 1};yt.compare=function(t,e){for(var r=0;r<t.length&&r<e.length;){var i=t[r].compareTo(e[r]);if(i!==0)return i;r++}return r<e.length?-1:r<t.length?1:0};yt.minCoordinate=function(t){for(var e=null,r=0;r<t.length;r++)(e===null||e.compareTo(t[r])>0)&&(e=t[r]);return e};yt.extract=function(t,e,r){e=On.clamp(e,0,t.length),r=On.clamp(r,-1,t.length);var i=r-e+1;r<0&&(i=0),e>=t.length&&(i=0),r<e&&(i=0);var s=new Array(i).fill(null);if(i===0)return s;for(var o=0,a=e;a<=r;a++)s[o++]=t[a];return s};Object.defineProperties(yt,Dh);var Ll=function(){};Ll.prototype.compare=function(t,e){var r=t,i=e;return yt.compare(r,i)};Ll.prototype.interfaces_=function(){return[ya]};Ll.prototype.getClass=function(){return Ll};var Sa=function(){};Sa.prototype.compare=function(t,e){var r=t,i=e;if(r.length<i.length)return-1;if(r.length>i.length)return 1;if(r.length===0)return 0;var s=yt.compare(r,i),o=yt.isEqualReversed(r,i);return o?0:s};Sa.prototype.OLDcompare=function(t,e){var r=t,i=e;if(r.length<i.length)return-1;if(r.length>i.length)return 1;if(r.length===0)return 0;for(var s=yt.increasingDirection(r),o=yt.increasingDirection(i),a=s>0?0:r.length-1,l=o>0?0:r.length-1,c=0;c<r.length;c++){var u=r[a].compareTo(i[l]);if(u!==0)return u;a+=s,l+=o}return 0};Sa.prototype.interfaces_=function(){return[ya]};Sa.prototype.getClass=function(){return Sa};var Oo=function(){};Oo.prototype.get=function(){};Oo.prototype.put=function(){};Oo.prototype.size=function(){};Oo.prototype.values=function(){};Oo.prototype.entrySet=function(){};var rk=function(n){function t(){n.apply(this,arguments)}return n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t,t}(Oo);function pc(n){this.message=n||""}pc.prototype=new Error;pc.prototype.name="OperationNotSupported";function Lh(){}Lh.prototype=new he;Lh.prototype.contains=function(){};var hg=function(n){function t(){n.call(this),this.array_=[],arguments[0]instanceof he&&this.addAll(arguments[0])}return n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t,t.prototype.contains=function(r){for(var i=this,s=0,o=this.array_.length;s<o;s++){var a=i.array_[s];if(a===r)return!0}return!1},t.prototype.add=function(r){return this.contains(r)?!1:(this.array_.push(r),!0)},t.prototype.addAll=function(r){for(var i=this,s=r.iterator();s.hasNext();)i.add(s.next());return!0},t.prototype.remove=function(r){throw new Error},t.prototype.size=function(){return this.array_.length},t.prototype.isEmpty=function(){return this.array_.length===0},t.prototype.toArray=function(){for(var r=this,i=[],s=0,o=this.array_.length;s<o;s++)i.push(r.array_[s]);return i},t.prototype.iterator=function(){return new ik(this)},t}(Lh),ik=function(n){function t(e){n.call(this),this.hashSet_=e,this.position_=0}return n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t,t.prototype.next=function(){if(this.position_===this.hashSet_.size())throw new qa;return this.hashSet_.array_[this.position_++]},t.prototype.hasNext=function(){return this.position_<this.hashSet_.size()},t.prototype.remove=function(){throw new pc},t}(Ya),vi=0,cs=1;function Cy(n){return n===null?vi:n.color}function Ut(n){return n===null?null:n.parent}function di(n,t){n!==null&&(n.color=t)}function zf(n){return n===null?null:n.left}function Ty(n){return n===null?null:n.right}function We(){this.root_=null,this.size_=0}We.prototype=new rk;We.prototype.get=function(n){for(var t=this.root_;t!==null;){var e=n.compareTo(t.key);if(e<0)t=t.left;else if(e>0)t=t.right;else return t.value}return null};We.prototype.put=function(n,t){if(this.root_===null)return this.root_={key:n,value:t,left:null,right:null,parent:null,color:vi,getValue:function(){return this.value},getKey:function(){return this.key}},this.size_=1,null;var e=this.root_,r,i;do if(r=e,i=n.compareTo(e.key),i<0)e=e.left;else if(i>0)e=e.right;else{var s=e.value;return e.value=t,s}while(e!==null);var o={key:n,left:null,right:null,value:t,parent:r,color:vi,getValue:function(){return this.value},getKey:function(){return this.key}};return i<0?r.left=o:r.right=o,this.fixAfterInsertion(o),this.size_++,null};We.prototype.fixAfterInsertion=function(n){var t=this;for(n.color=cs;n!=null&&n!==this.root_&&n.parent.color===cs;)if(Ut(n)===zf(Ut(Ut(n)))){var e=Ty(Ut(Ut(n)));Cy(e)===cs?(di(Ut(n),vi),di(e,vi),di(Ut(Ut(n)),cs),n=Ut(Ut(n))):(n===Ty(Ut(n))&&(n=Ut(n),t.rotateLeft(n)),di(Ut(n),vi),di(Ut(Ut(n)),cs),t.rotateRight(Ut(Ut(n))))}else{var r=zf(Ut(Ut(n)));Cy(r)===cs?(di(Ut(n),vi),di(r,vi),di(Ut(Ut(n)),cs),n=Ut(Ut(n))):(n===zf(Ut(n))&&(n=Ut(n),t.rotateRight(n)),di(Ut(n),vi),di(Ut(Ut(n)),cs),t.rotateLeft(Ut(Ut(n))))}this.root_.color=vi};We.prototype.values=function(){var n=new et,t=this.getFirstEntry();if(t!==null)for(n.add(t.value);(t=We.successor(t))!==null;)n.add(t.value);return n};We.prototype.entrySet=function(){var n=new hg,t=this.getFirstEntry();if(t!==null)for(n.add(t);(t=We.successor(t))!==null;)n.add(t);return n};We.prototype.rotateLeft=function(n){if(n!=null){var t=n.right;n.right=t.left,t.left!=null&&(t.left.parent=n),t.parent=n.parent,n.parent===null?this.root_=t:n.parent.left===n?n.parent.left=t:n.parent.right=t,t.left=n,n.parent=t}};We.prototype.rotateRight=function(n){if(n!=null){var t=n.left;n.left=t.right,t.right!=null&&(t.right.parent=n),t.parent=n.parent,n.parent===null?this.root_=t:n.parent.right===n?n.parent.right=t:n.parent.left=t,t.right=n,n.parent=t}};We.prototype.getFirstEntry=function(){var n=this.root_;if(n!=null)for(;n.left!=null;)n=n.left;return n};We.successor=function(n){if(n===null)return null;if(n.right!==null){for(var t=n.right;t.left!==null;)t=t.left;return t}else{for(var e=n.parent,r=n;e!==null&&r===e.right;)r=e,e=e.parent;return e}};We.prototype.size=function(){return this.size_};var kl=function(){};kl.prototype.interfaces_=function(){return[]};kl.prototype.getClass=function(){return kl};function Jx(){}Jx.prototype=new Lh;function Mr(){this.array_=[],arguments[0]instanceof he&&this.addAll(arguments[0])}Mr.prototype=new Jx;Mr.prototype.contains=function(n){for(var t=this,e=0,r=this.array_.length;e<r;e++){var i=t.array_[e];if(i.compareTo(n)===0)return!0}return!1};Mr.prototype.add=function(n){var t=this;if(this.contains(n))return!1;for(var e=0,r=this.array_.length;e<r;e++){var i=t.array_[e];if(i.compareTo(n)===1)return t.array_.splice(e,0,n),!0}return this.array_.push(n),!0};Mr.prototype.addAll=function(n){for(var t=this,e=n.iterator();e.hasNext();)t.add(e.next());return!0};Mr.prototype.remove=function(n){throw new pc};Mr.prototype.size=function(){return this.array_.length};Mr.prototype.isEmpty=function(){return this.array_.length===0};Mr.prototype.toArray=function(){for(var n=this,t=[],e=0,r=this.array_.length;e<r;e++)t.push(n.array_[e]);return t};Mr.prototype.iterator=function(){return new kh(this)};var kh=function(n){this.treeSet_=n,this.position_=0};kh.prototype.next=function(){if(this.position_===this.treeSet_.size())throw new qa;return this.treeSet_.array_[this.position_++]};kh.prototype.hasNext=function(){return this.position_<this.treeSet_.size()};kh.prototype.remove=function(){throw new pc};var Cs=function(){};Cs.sort=function(){var t=arguments[0],e,r,i,s;if(arguments.length===1)s=function(a,l){return a.compareTo(l)},t.sort(s);else if(arguments.length===2)i=arguments[1],s=function(a,l){return i.compare(a,l)},t.sort(s);else if(arguments.length===3){r=t.slice(arguments[1],arguments[2]),r.sort();var o=t.slice(0,arguments[1]).concat(r,t.slice(arguments[2],t.length));for(t.splice(0,t.length),e=0;e<o.length;e++)t.push(o[e])}else if(arguments.length===4)for(r=t.slice(arguments[1],arguments[2]),i=arguments[3],s=function(a,l){return i.compare(a,l)},r.sort(s),o=t.slice(0,arguments[1]).concat(r,t.slice(arguments[2],t.length)),t.splice(0,t.length),e=0;e<o.length;e++)t.push(o[e])};Cs.asList=function(t){for(var e=new et,r=0,i=t.length;r<i;r++)e.add(t[r]);return e};var St=function(){},hr={P:{configurable:!0},L:{configurable:!0},A:{configurable:!0},FALSE:{configurable:!0},TRUE:{configurable:!0},DONTCARE:{configurable:!0},SYM_FALSE:{configurable:!0},SYM_TRUE:{configurable:!0},SYM_DONTCARE:{configurable:!0},SYM_P:{configurable:!0},SYM_L:{configurable:!0},SYM_A:{configurable:!0}};hr.P.get=function(){return 0};hr.L.get=function(){return 1};hr.A.get=function(){return 2};hr.FALSE.get=function(){return-1};hr.TRUE.get=function(){return-2};hr.DONTCARE.get=function(){return-3};hr.SYM_FALSE.get=function(){return"F"};hr.SYM_TRUE.get=function(){return"T"};hr.SYM_DONTCARE.get=function(){return"*"};hr.SYM_P.get=function(){return"0"};hr.SYM_L.get=function(){return"1"};hr.SYM_A.get=function(){return"2"};St.prototype.interfaces_=function(){return[]};St.prototype.getClass=function(){return St};St.toDimensionSymbol=function(t){switch(t){case St.FALSE:return St.SYM_FALSE;case St.TRUE:return St.SYM_TRUE;case St.DONTCARE:return St.SYM_DONTCARE;case St.P:return St.SYM_P;case St.L:return St.SYM_L;case St.A:return St.SYM_A}throw new Xt("Unknown dimension value: "+t)};St.toDimensionValue=function(t){switch(Dl.toUpperCase(t)){case St.SYM_FALSE:return St.FALSE;case St.SYM_TRUE:return St.TRUE;case St.SYM_DONTCARE:return St.DONTCARE;case St.SYM_P:return St.P;case St.SYM_L:return St.L;case St.SYM_A:return St.A}throw new Xt("Unknown dimension symbol: "+t)};Object.defineProperties(St,hr);var Rr=function(){};Rr.prototype.filter=function(t){};Rr.prototype.interfaces_=function(){return[]};Rr.prototype.getClass=function(){return Rr};var nr=function(){};nr.prototype.filter=function(t,e){};nr.prototype.isDone=function(){};nr.prototype.isGeometryChanged=function(){};nr.prototype.interfaces_=function(){return[]};nr.prototype.getClass=function(){return nr};var Je=function(n){function t(r,i){if(n.call(this,i),this._geometries=r||[],n.hasNullElements(this._geometries))throw new Xt("geometries must not contain null elements")}n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t;var e={serialVersionUID:{configurable:!0}};return t.prototype.computeEnvelopeInternal=function(){for(var i=this,s=new st,o=0;o<this._geometries.length;o++)s.expandToInclude(i._geometries[o].getEnvelopeInternal());return s},t.prototype.getGeometryN=function(i){return this._geometries[i]},t.prototype.getSortIndex=function(){return n.SORTINDEX_GEOMETRYCOLLECTION},t.prototype.getCoordinates=function(){for(var i=this,s=new Array(this.getNumPoints()).fill(null),o=-1,a=0;a<this._geometries.length;a++)for(var l=i._geometries[a].getCoordinates(),c=0;c<l.length;c++)o++,s[o]=l[c];return s},t.prototype.getArea=function(){for(var i=this,s=0,o=0;o<this._geometries.length;o++)s+=i._geometries[o].getArea();return s},t.prototype.equalsExact=function(){var i=this;if(arguments.length===2){var s=arguments[0],o=arguments[1];if(!this.isEquivalentClass(s))return!1;var a=s;if(this._geometries.length!==a._geometries.length)return!1;for(var l=0;l<this._geometries.length;l++)if(!i._geometries[l].equalsExact(a._geometries[l],o))return!1;return!0}else return n.prototype.equalsExact.apply(this,arguments)},t.prototype.normalize=function(){for(var i=this,s=0;s<this._geometries.length;s++)i._geometries[s].normalize();Cs.sort(this._geometries)},t.prototype.getCoordinate=function(){return this.isEmpty()?null:this._geometries[0].getCoordinate()},t.prototype.getBoundaryDimension=function(){for(var i=this,s=St.FALSE,o=0;o<this._geometries.length;o++)s=Math.max(s,i._geometries[o].getBoundaryDimension());return s},t.prototype.getDimension=function(){for(var i=this,s=St.FALSE,o=0;o<this._geometries.length;o++)s=Math.max(s,i._geometries[o].getDimension());return s},t.prototype.getLength=function(){for(var i=this,s=0,o=0;o<this._geometries.length;o++)s+=i._geometries[o].getLength();return s},t.prototype.getNumPoints=function(){for(var i=this,s=0,o=0;o<this._geometries.length;o++)s+=i._geometries[o].getNumPoints();return s},t.prototype.getNumGeometries=function(){return this._geometries.length},t.prototype.reverse=function(){for(var i=this,s=this._geometries.length,o=new Array(s).fill(null),a=0;a<this._geometries.length;a++)o[a]=i._geometries[a].reverse();return this.getFactory().createGeometryCollection(o)},t.prototype.compareToSameClass=function(){var i=this;if(arguments.length===1){var s=arguments[0],o=new Mr(Cs.asList(this._geometries)),a=new Mr(Cs.asList(s._geometries));return this.compare(o,a)}else if(arguments.length===2){for(var l=arguments[0],c=arguments[1],u=l,h=this.getNumGeometries(),f=u.getNumGeometries(),d=0;d<h&&d<f;){var p=i.getGeometryN(d),_=u.getGeometryN(d),v=p.compareToSameClass(_,c);if(v!==0)return v;d++}return d<h?1:d<f?-1:0}},t.prototype.apply=function(){var i=this;if(ct(arguments[0],Qr))for(var s=arguments[0],o=0;o<this._geometries.length;o++)i._geometries[o].apply(s);else if(ct(arguments[0],nr)){var a=arguments[0];if(this._geometries.length===0)return null;for(var l=0;l<this._geometries.length&&(i._geometries[l].apply(a),!a.isDone());l++);a.isGeometryChanged()&&this.geometryChanged()}else if(ct(arguments[0],Rr)){var c=arguments[0];c.filter(this);for(var u=0;u<this._geometries.length;u++)i._geometries[u].apply(c)}else if(ct(arguments[0],Ii)){var h=arguments[0];h.filter(this);for(var f=0;f<this._geometries.length;f++)i._geometries[f].apply(h)}},t.prototype.getBoundary=function(){return this.checkNotGeometryCollection(this),mt.shouldNeverReachHere(),null},t.prototype.clone=function(){var i=this,s=n.prototype.clone.call(this);s._geometries=new Array(this._geometries.length).fill(null);for(var o=0;o<this._geometries.length;o++)s._geometries[o]=i._geometries[o].clone();return s},t.prototype.getGeometryType=function(){return"GeometryCollection"},t.prototype.copy=function(){for(var i=this,s=new Array(this._geometries.length).fill(null),o=0;o<s.length;o++)s[o]=i._geometries[o].copy();return new t(s,this._factory)},t.prototype.isEmpty=function(){for(var i=this,s=0;s<this._geometries.length;s++)if(!i._geometries[s].isEmpty())return!1;return!0},t.prototype.interfaces_=function(){return[]},t.prototype.getClass=function(){return t},e.serialVersionUID.get=function(){return-5694727726395021e3},Object.defineProperties(t,e),t}(lt),Ms=function(n){function t(){n.apply(this,arguments)}n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t;var e={serialVersionUID:{configurable:!0}};return t.prototype.getSortIndex=function(){return lt.SORTINDEX_MULTILINESTRING},t.prototype.equalsExact=function(){if(arguments.length===2){var i=arguments[0],s=arguments[1];return this.isEquivalentClass(i)?n.prototype.equalsExact.call(this,i,s):!1}else return n.prototype.equalsExact.apply(this,arguments)},t.prototype.getBoundaryDimension=function(){return this.isClosed()?St.FALSE:0},t.prototype.isClosed=function(){var i=this;if(this.isEmpty())return!1;for(var s=0;s<this._geometries.length;s++)if(!i._geometries[s].isClosed())return!1;return!0},t.prototype.getDimension=function(){return 1},t.prototype.reverse=function(){for(var i=this,s=this._geometries.length,o=new Array(s).fill(null),a=0;a<this._geometries.length;a++)o[s-1-a]=i._geometries[a].reverse();return this.getFactory().createMultiLineString(o)},t.prototype.getBoundary=function(){return new zn(this).getBoundary()},t.prototype.getGeometryType=function(){return"MultiLineString"},t.prototype.copy=function(){for(var i=this,s=new Array(this._geometries.length).fill(null),o=0;o<s.length;o++)s[o]=i._geometries[o].copy();return new t(s,this._factory)},t.prototype.interfaces_=function(){return[kl]},t.prototype.getClass=function(){return t},e.serialVersionUID.get=function(){return 8166665132445434e3},Object.defineProperties(t,e),t}(Je),zn=function(){if(this._geom=null,this._geomFact=null,this._bnRule=null,this._endpointMap=null,arguments.length===1){var t=arguments[0],e=jn.MOD2_BOUNDARY_RULE;this._geom=t,this._geomFact=t.getFactory(),this._bnRule=e}else if(arguments.length===2){var r=arguments[0],i=arguments[1];this._geom=r,this._geomFact=r.getFactory(),this._bnRule=i}};zn.prototype.boundaryMultiLineString=function(t){if(this._geom.isEmpty())return this.getEmptyMultiPoint();var e=this.computeBoundaryCoordinates(t);return e.length===1?this._geomFact.createPoint(e[0]):this._geomFact.createMultiPointFromCoords(e)};zn.prototype.getBoundary=function(){return this._geom instanceof Jt?this.boundaryLineString(this._geom):this._geom instanceof Ms?this.boundaryMultiLineString(this._geom):this._geom.getBoundary()};zn.prototype.boundaryLineString=function(t){if(this._geom.isEmpty())return this.getEmptyMultiPoint();if(t.isClosed()){var e=this._bnRule.isInBoundary(2);return e?t.getStartPoint():this._geomFact.createMultiPoint()}return this._geomFact.createMultiPoint([t.getStartPoint(),t.getEndPoint()])};zn.prototype.getEmptyMultiPoint=function(){return this._geomFact.createMultiPoint()};zn.prototype.computeBoundaryCoordinates=function(t){var e=this,r=new et;this._endpointMap=new We;for(var i=0;i<t.getNumGeometries();i++){var s=t.getGeometryN(i);s.getNumPoints()!==0&&(e.addEndpoint(s.getCoordinateN(0)),e.addEndpoint(s.getCoordinateN(s.getNumPoints()-1)))}for(var o=this._endpointMap.entrySet().iterator();o.hasNext();){var a=o.next(),l=a.getValue(),c=l.count;e._bnRule.isInBoundary(c)&&r.add(a.getKey())}return yt.toCoordinateArray(r)};zn.prototype.addEndpoint=function(t){var e=this._endpointMap.get(t);e===null&&(e=new th,this._endpointMap.put(t,e)),e.count++};zn.prototype.interfaces_=function(){return[]};zn.prototype.getClass=function(){return zn};zn.getBoundary=function(){if(arguments.length===1){var t=arguments[0],e=new zn(t);return e.getBoundary()}else if(arguments.length===2){var r=arguments[0],i=arguments[1],s=new zn(r,i);return s.getBoundary()}};var th=function(){this.count=null};th.prototype.interfaces_=function(){return[]};th.prototype.getClass=function(){return th};function sk(){}function ok(){}var ak=function(){};function lk(){}function ck(){}function uk(){}var Wn=function(){},fg={NEWLINE:{configurable:!0},SIMPLE_ORDINATE_FORMAT:{configurable:!0}};Wn.prototype.interfaces_=function(){return[]};Wn.prototype.getClass=function(){return Wn};Wn.chars=function(t,e){for(var r=new Array(e).fill(null),i=0;i<e;i++)r[i]=t;return String(r)};Wn.getStackTrace=function(){if(arguments.length===1){var t=arguments[0],e=new lk,r=new sk;return t.printStackTrace(r),e.toString()}else if(arguments.length===2){var i=arguments[0],s=arguments[1],o="";new ok(Wn.getStackTrace(i));for(var a=new uk,l=0;l<s;l++)try{o+=a.readLine()+Wn.NEWLINE}catch(c){if(c instanceof ck)mt.shouldNeverReachHere();else throw c}finally{}return o}};Wn.split=function(t,e){for(var r=e.length,i=new et,s=""+t,o=s.indexOf(e);o>=0;){var a=s.substring(0,o);i.add(a),s=s.substring(o+r),o=s.indexOf(e)}s.length>0&&i.add(s);for(var l=new Array(i.size()).fill(null),c=0;c<l.length;c++)l[c]=i.get(c);return l};Wn.toString=function(){if(arguments.length===1){var t=arguments[0];return Wn.SIMPLE_ORDINATE_FORMAT.format(t)}};Wn.spaces=function(t){return Wn.chars(" ",t)};fg.NEWLINE.get=function(){return De.getProperty("line.separator")};fg.SIMPLE_ORDINATE_FORMAT.get=function(){return new ak};Object.defineProperties(Wn,fg);var re=function(){};re.prototype.interfaces_=function(){return[]};re.prototype.getClass=function(){return re};re.copyCoord=function(t,e,r,i){for(var s=Math.min(t.getDimension(),r.getDimension()),o=0;o<s;o++)r.setOrdinate(i,o,t.getOrdinate(e,o))};re.isRing=function(t){var e=t.size();return e===0?!0:e<=3?!1:t.getOrdinate(0,xt.X)===t.getOrdinate(e-1,xt.X)&&t.getOrdinate(0,xt.Y)===t.getOrdinate(e-1,xt.Y)};re.isEqual=function(t,e){var r=t.size(),i=e.size();if(r!==i)return!1;for(var s=Math.min(t.getDimension(),e.getDimension()),o=0;o<r;o++)for(var a=0;a<s;a++){var l=t.getOrdinate(o,a),c=e.getOrdinate(o,a);if(t.getOrdinate(o,a)!==e.getOrdinate(o,a)&&!(dt.isNaN(l)&&dt.isNaN(c)))return!1}return!0};re.extend=function(t,e,r){var i=t.create(r,e.getDimension()),s=e.size();if(re.copy(e,0,i,0,s),s>0)for(var o=s;o<r;o++)re.copy(e,s-1,i,o,1);return i};re.reverse=function(t){for(var e=t.size()-1,r=Math.trunc(e/2),i=0;i<=r;i++)re.swap(t,i,e-i)};re.swap=function(t,e,r){if(e===r)return null;for(var i=0;i<t.getDimension();i++){var s=t.getOrdinate(e,i);t.setOrdinate(e,i,t.getOrdinate(r,i)),t.setOrdinate(r,i,s)}};re.copy=function(t,e,r,i,s){for(var o=0;o<s;o++)re.copyCoord(t,e+o,r,i+o)};re.toString=function(){if(arguments.length===1){var t=arguments[0],e=t.size();if(e===0)return"()";var r=t.getDimension(),i=new Vr;i.append("(");for(var s=0;s<e;s++){s>0&&i.append(" ");for(var o=0;o<r;o++)o>0&&i.append(","),i.append(Wn.toString(t.getOrdinate(s,o)))}return i.append(")"),i.toString()}};re.ensureValidRing=function(t,e){var r=e.size();if(r===0)return e;if(r<=3)return re.createClosedRing(t,e,4);var i=e.getOrdinate(0,xt.X)===e.getOrdinate(r-1,xt.X)&&e.getOrdinate(0,xt.Y)===e.getOrdinate(r-1,xt.Y);return i?e:re.createClosedRing(t,e,r+1)};re.createClosedRing=function(t,e,r){var i=t.create(r,e.getDimension()),s=e.size();re.copy(e,0,i,0,s);for(var o=s;o<r;o++)re.copy(e,0,i,o,1);return i};var Jt=function(n){function t(r,i){n.call(this,i),this._points=null,this.init(r)}n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t;var e={serialVersionUID:{configurable:!0}};return t.prototype.computeEnvelopeInternal=function(){return this.isEmpty()?new st:this._points.expandEnvelope(new st)},t.prototype.isRing=function(){return this.isClosed()&&this.isSimple()},t.prototype.getSortIndex=function(){return n.SORTINDEX_LINESTRING},t.prototype.getCoordinates=function(){return this._points.toCoordinateArray()},t.prototype.equalsExact=function(){var i=this;if(arguments.length===2){var s=arguments[0],o=arguments[1];if(!this.isEquivalentClass(s))return!1;var a=s;if(this._points.size()!==a._points.size())return!1;for(var l=0;l<this._points.size();l++)if(!i.equal(i._points.getCoordinate(l),a._points.getCoordinate(l),o))return!1;return!0}else return n.prototype.equalsExact.apply(this,arguments)},t.prototype.normalize=function(){for(var i=this,s=0;s<Math.trunc(this._points.size()/2);s++){var o=i._points.size()-1-s;if(!i._points.getCoordinate(s).equals(i._points.getCoordinate(o)))return i._points.getCoordinate(s).compareTo(i._points.getCoordinate(o))>0&&re.reverse(i._points),null}},t.prototype.getCoordinate=function(){return this.isEmpty()?null:this._points.getCoordinate(0)},t.prototype.getBoundaryDimension=function(){return this.isClosed()?St.FALSE:0},t.prototype.isClosed=function(){return this.isEmpty()?!1:this.getCoordinateN(0).equals2D(this.getCoordinateN(this.getNumPoints()-1))},t.prototype.getEndPoint=function(){return this.isEmpty()?null:this.getPointN(this.getNumPoints()-1)},t.prototype.getDimension=function(){return 1},t.prototype.getLength=function(){return rt.computeLength(this._points)},t.prototype.getNumPoints=function(){return this._points.size()},t.prototype.reverse=function(){var i=this._points.copy();re.reverse(i);var s=this.getFactory().createLineString(i);return s},t.prototype.compareToSameClass=function(){var i=this;if(arguments.length===1){for(var s=arguments[0],o=s,a=0,l=0;a<this._points.size()&&l<o._points.size();){var c=i._points.getCoordinate(a).compareTo(o._points.getCoordinate(l));if(c!==0)return c;a++,l++}return a<this._points.size()?1:l<o._points.size()?-1:0}else if(arguments.length===2){var u=arguments[0],h=arguments[1],f=u;return h.compare(this._points,f._points)}},t.prototype.apply=function(){var i=this;if(ct(arguments[0],Qr))for(var s=arguments[0],o=0;o<this._points.size();o++)s.filter(i._points.getCoordinate(o));else if(ct(arguments[0],nr)){var a=arguments[0];if(this._points.size()===0)return null;for(var l=0;l<this._points.size()&&(a.filter(i._points,l),!a.isDone());l++);a.isGeometryChanged()&&this.geometryChanged()}else if(ct(arguments[0],Rr)){var c=arguments[0];c.filter(this)}else if(ct(arguments[0],Ii)){var u=arguments[0];u.filter(this)}},t.prototype.getBoundary=function(){return new zn(this).getBoundary()},t.prototype.isEquivalentClass=function(i){return i instanceof t},t.prototype.clone=function(){var i=n.prototype.clone.call(this);return i._points=this._points.clone(),i},t.prototype.getCoordinateN=function(i){return this._points.getCoordinate(i)},t.prototype.getGeometryType=function(){return"LineString"},t.prototype.copy=function(){return new t(this._points.copy(),this._factory)},t.prototype.getCoordinateSequence=function(){return this._points},t.prototype.isEmpty=function(){return this._points.size()===0},t.prototype.init=function(i){if(i===null&&(i=this.getFactory().getCoordinateSequenceFactory().create([])),i.size()===1)throw new Xt("Invalid number of points in LineString (found "+i.size()+" - must be 0 or >= 2)");this._points=i},t.prototype.isCoordinate=function(i){for(var s=this,o=0;o<this._points.size();o++)if(s._points.getCoordinate(o).equals(i))return!0;return!1},t.prototype.getStartPoint=function(){return this.isEmpty()?null:this.getPointN(0)},t.prototype.getPointN=function(i){return this.getFactory().createPoint(this._points.getCoordinate(i))},t.prototype.interfaces_=function(){return[kl]},t.prototype.getClass=function(){return t},e.serialVersionUID.get=function(){return 0x2b2b51ba435c8e00},Object.defineProperties(t,e),t}(lt),Fl=function(){};Fl.prototype.interfaces_=function(){return[]};Fl.prototype.getClass=function(){return Fl};var bn=function(n){function t(r,i){n.call(this,i),this._coordinates=r||null,this.init(this._coordinates)}n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t;var e={serialVersionUID:{configurable:!0}};return t.prototype.computeEnvelopeInternal=function(){if(this.isEmpty())return new st;var i=new st;return i.expandToInclude(this._coordinates.getX(0),this._coordinates.getY(0)),i},t.prototype.getSortIndex=function(){return n.SORTINDEX_POINT},t.prototype.getCoordinates=function(){return this.isEmpty()?[]:[this.getCoordinate()]},t.prototype.equalsExact=function(){if(arguments.length===2){var i=arguments[0],s=arguments[1];return this.isEquivalentClass(i)?this.isEmpty()&&i.isEmpty()?!0:this.isEmpty()!==i.isEmpty()?!1:this.equal(i.getCoordinate(),this.getCoordinate(),s):!1}else return n.prototype.equalsExact.apply(this,arguments)},t.prototype.normalize=function(){},t.prototype.getCoordinate=function(){return this._coordinates.size()!==0?this._coordinates.getCoordinate(0):null},t.prototype.getBoundaryDimension=function(){return St.FALSE},t.prototype.getDimension=function(){return 0},t.prototype.getNumPoints=function(){return this.isEmpty()?0:1},t.prototype.reverse=function(){return this.copy()},t.prototype.getX=function(){if(this.getCoordinate()===null)throw new Error("getX called on empty Point");return this.getCoordinate().x},t.prototype.compareToSameClass=function(){if(arguments.length===1){var i=arguments[0],s=i;return this.getCoordinate().compareTo(s.getCoordinate())}else if(arguments.length===2){var o=arguments[0],a=arguments[1],l=o;return a.compare(this._coordinates,l._coordinates)}},t.prototype.apply=function(){if(ct(arguments[0],Qr)){var i=arguments[0];if(this.isEmpty())return null;i.filter(this.getCoordinate())}else if(ct(arguments[0],nr)){var s=arguments[0];if(this.isEmpty())return null;s.filter(this._coordinates,0),s.isGeometryChanged()&&this.geometryChanged()}else if(ct(arguments[0],Rr)){var o=arguments[0];o.filter(this)}else if(ct(arguments[0],Ii)){var a=arguments[0];a.filter(this)}},t.prototype.getBoundary=function(){return this.getFactory().createGeometryCollection(null)},t.prototype.clone=function(){var i=n.prototype.clone.call(this);return i._coordinates=this._coordinates.clone(),i},t.prototype.getGeometryType=function(){return"Point"},t.prototype.copy=function(){return new t(this._coordinates.copy(),this._factory)},t.prototype.getCoordinateSequence=function(){return this._coordinates},t.prototype.getY=function(){if(this.getCoordinate()===null)throw new Error("getY called on empty Point");return this.getCoordinate().y},t.prototype.isEmpty=function(){return this._coordinates.size()===0},t.prototype.init=function(i){i===null&&(i=this.getFactory().getCoordinateSequenceFactory().create([])),mt.isTrue(i.size()<=1),this._coordinates=i},t.prototype.isSimple=function(){return!0},t.prototype.interfaces_=function(){return[Fl]},t.prototype.getClass=function(){return t},e.serialVersionUID.get=function(){return 4902022702746615e3},Object.defineProperties(t,e),t}(lt),qi=function(){};qi.prototype.interfaces_=function(){return[]};qi.prototype.getClass=function(){return qi};var ge=function(n){function t(r,i,s){if(n.call(this,s),this._shell=null,this._holes=null,r===null&&(r=this.getFactory().createLinearRing()),i===null&&(i=[]),n.hasNullElements(i))throw new Xt("holes must not contain null elements");if(r.isEmpty()&&n.hasNonEmptyElements(i))throw new Xt("shell is empty but holes are not");this._shell=r,this._holes=i}n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t;var e={serialVersionUID:{configurable:!0}};return t.prototype.computeEnvelopeInternal=function(){return this._shell.getEnvelopeInternal()},t.prototype.getSortIndex=function(){return n.SORTINDEX_POLYGON},t.prototype.getCoordinates=function(){var i=this;if(this.isEmpty())return[];for(var s=new Array(this.getNumPoints()).fill(null),o=-1,a=this._shell.getCoordinates(),l=0;l<a.length;l++)o++,s[o]=a[l];for(var c=0;c<this._holes.length;c++)for(var u=i._holes[c].getCoordinates(),h=0;h<u.length;h++)o++,s[o]=u[h];return s},t.prototype.getArea=function(){var i=this,s=0;s+=Math.abs(rt.signedArea(this._shell.getCoordinateSequence()));for(var o=0;o<this._holes.length;o++)s-=Math.abs(rt.signedArea(i._holes[o].getCoordinateSequence()));return s},t.prototype.isRectangle=function(){if(this.getNumInteriorRing()!==0||this._shell===null||this._shell.getNumPoints()!==5)return!1;for(var i=this._shell.getCoordinateSequence(),s=this.getEnvelopeInternal(),o=0;o<5;o++){var a=i.getX(o);if(!(a===s.getMinX()||a===s.getMaxX()))return!1;var l=i.getY(o);if(!(l===s.getMinY()||l===s.getMaxY()))return!1}for(var c=i.getX(0),u=i.getY(0),h=1;h<=4;h++){var f=i.getX(h),d=i.getY(h),p=f!==c,_=d!==u;if(p===_)return!1;c=f,u=d}return!0},t.prototype.equalsExact=function(){var i=this;if(arguments.length===2){var s=arguments[0],o=arguments[1];if(!this.isEquivalentClass(s))return!1;var a=s,l=this._shell,c=a._shell;if(!l.equalsExact(c,o)||this._holes.length!==a._holes.length)return!1;for(var u=0;u<this._holes.length;u++)if(!i._holes[u].equalsExact(a._holes[u],o))return!1;return!0}else return n.prototype.equalsExact.apply(this,arguments)},t.prototype.normalize=function(){var i=this;if(arguments.length===0){this.normalize(this._shell,!0);for(var s=0;s<this._holes.length;s++)i.normalize(i._holes[s],!1);Cs.sort(this._holes)}else if(arguments.length===2){var o=arguments[0],a=arguments[1];if(o.isEmpty())return null;var l=new Array(o.getCoordinates().length-1).fill(null);De.arraycopy(o.getCoordinates(),0,l,0,l.length);var c=yt.minCoordinate(o.getCoordinates());yt.scroll(l,c),De.arraycopy(l,0,o.getCoordinates(),0,l.length),o.getCoordinates()[l.length]=l[0],rt.isCCW(o.getCoordinates())===a&&yt.reverse(o.getCoordinates())}},t.prototype.getCoordinate=function(){return this._shell.getCoordinate()},t.prototype.getNumInteriorRing=function(){return this._holes.length},t.prototype.getBoundaryDimension=function(){return 1},t.prototype.getDimension=function(){return 2},t.prototype.getLength=function(){var i=this,s=0;s+=this._shell.getLength();for(var o=0;o<this._holes.length;o++)s+=i._holes[o].getLength();return s},t.prototype.getNumPoints=function(){for(var i=this,s=this._shell.getNumPoints(),o=0;o<this._holes.length;o++)s+=i._holes[o].getNumPoints();return s},t.prototype.reverse=function(){var i=this,s=this.copy();s._shell=this._shell.copy().reverse(),s._holes=new Array(this._holes.length).fill(null);for(var o=0;o<this._holes.length;o++)s._holes[o]=i._holes[o].copy().reverse();return s},t.prototype.convexHull=function(){return this.getExteriorRing().convexHull()},t.prototype.compareToSameClass=function(){var i=this;if(arguments.length===1){var s=arguments[0],o=this._shell,a=s._shell;return o.compareToSameClass(a)}else if(arguments.length===2){var l=arguments[0],c=arguments[1],u=l,h=this._shell,f=u._shell,d=h.compareToSameClass(f,c);if(d!==0)return d;for(var p=this.getNumInteriorRing(),_=u.getNumInteriorRing(),v=0;v<p&&v<_;){var E=i.getInteriorRingN(v),m=u.getInteriorRingN(v),g=E.compareToSameClass(m,c);if(g!==0)return g;v++}return v<p?1:v<_?-1:0}},t.prototype.apply=function(i){var s=this;if(ct(i,Qr)){this._shell.apply(i);for(var o=0;o<this._holes.length;o++)s._holes[o].apply(i)}else if(ct(i,nr)){if(this._shell.apply(i),!i.isDone())for(var a=0;a<this._holes.length&&(s._holes[a].apply(i),!i.isDone());a++);i.isGeometryChanged()&&this.geometryChanged()}else if(ct(i,Rr))i.filter(this);else if(ct(i,Ii)){i.filter(this),this._shell.apply(i);for(var l=0;l<this._holes.length;l++)s._holes[l].apply(i)}},t.prototype.getBoundary=function(){var i=this;if(this.isEmpty())return this.getFactory().createMultiLineString();var s=new Array(this._holes.length+1).fill(null);s[0]=this._shell;for(var o=0;o<this._holes.length;o++)s[o+1]=i._holes[o];return s.length<=1?this.getFactory().createLinearRing(s[0].getCoordinateSequence()):this.getFactory().createMultiLineString(s)},t.prototype.clone=function(){var i=this,s=n.prototype.clone.call(this);s._shell=this._shell.clone(),s._holes=new Array(this._holes.length).fill(null);for(var o=0;o<this._holes.length;o++)s._holes[o]=i._holes[o].clone();return s},t.prototype.getGeometryType=function(){return"Polygon"},t.prototype.copy=function(){for(var i=this,s=this._shell.copy(),o=new Array(this._holes.length).fill(null),a=0;a<o.length;a++)o[a]=i._holes[a].copy();return new t(s,o,this._factory)},t.prototype.getExteriorRing=function(){return this._shell},t.prototype.isEmpty=function(){return this._shell.isEmpty()},t.prototype.getInteriorRingN=function(i){return this._holes[i]},t.prototype.interfaces_=function(){return[qi]},t.prototype.getClass=function(){return t},e.serialVersionUID.get=function(){return-0x307ffefd8dc97200},Object.defineProperties(t,e),t}(lt),Ca=function(n){function t(){n.apply(this,arguments)}n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t;var e={serialVersionUID:{configurable:!0}};return t.prototype.getSortIndex=function(){return lt.SORTINDEX_MULTIPOINT},t.prototype.isValid=function(){return!0},t.prototype.equalsExact=function(){if(arguments.length===2){var i=arguments[0],s=arguments[1];return this.isEquivalentClass(i)?n.prototype.equalsExact.call(this,i,s):!1}else return n.prototype.equalsExact.apply(this,arguments)},t.prototype.getCoordinate=function(){if(arguments.length===1){var i=arguments[0];return this._geometries[i].getCoordinate()}else return n.prototype.getCoordinate.apply(this,arguments)},t.prototype.getBoundaryDimension=function(){return St.FALSE},t.prototype.getDimension=function(){return 0},t.prototype.getBoundary=function(){return this.getFactory().createGeometryCollection(null)},t.prototype.getGeometryType=function(){return"MultiPoint"},t.prototype.copy=function(){for(var i=this,s=new Array(this._geometries.length).fill(null),o=0;o<s.length;o++)s[o]=i._geometries[o].copy();return new t(s,this._factory)},t.prototype.interfaces_=function(){return[Fl]},t.prototype.getClass=function(){return t},e.serialVersionUID.get=function(){return-8048474874175356e3},Object.defineProperties(t,e),t}(Je),ti=function(n){function t(r,i){r instanceof z&&i instanceof _t&&(r=i.getCoordinateSequenceFactory().create(r)),n.call(this,r,i),this.validateConstruction()}n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t;var e={MINIMUM_VALID_SIZE:{configurable:!0},serialVersionUID:{configurable:!0}};return t.prototype.getSortIndex=function(){return lt.SORTINDEX_LINEARRING},t.prototype.getBoundaryDimension=function(){return St.FALSE},t.prototype.isClosed=function(){return this.isEmpty()?!0:n.prototype.isClosed.call(this)},t.prototype.reverse=function(){var i=this._points.copy();re.reverse(i);var s=this.getFactory().createLinearRing(i);return s},t.prototype.validateConstruction=function(){if(!this.isEmpty()&&!n.prototype.isClosed.call(this))throw new Xt("Points of LinearRing do not form a closed linestring");if(this.getCoordinateSequence().size()>=1&&this.getCoordinateSequence().size()<t.MINIMUM_VALID_SIZE)throw new Xt("Invalid number of points in LinearRing (found "+this.getCoordinateSequence().size()+" - must be 0 or >= 4)")},t.prototype.getGeometryType=function(){return"LinearRing"},t.prototype.copy=function(){return new t(this._points.copy(),this._factory)},t.prototype.interfaces_=function(){return[]},t.prototype.getClass=function(){return t},e.MINIMUM_VALID_SIZE.get=function(){return 4},e.serialVersionUID.get=function(){return-0x3b229e262367a600},Object.defineProperties(t,e),t}(Jt),Kr=function(n){function t(){n.apply(this,arguments)}n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t;var e={serialVersionUID:{configurable:!0}};return t.prototype.getSortIndex=function(){return lt.SORTINDEX_MULTIPOLYGON},t.prototype.equalsExact=function(){if(arguments.length===2){var i=arguments[0],s=arguments[1];return this.isEquivalentClass(i)?n.prototype.equalsExact.call(this,i,s):!1}else return n.prototype.equalsExact.apply(this,arguments)},t.prototype.getBoundaryDimension=function(){return 1},t.prototype.getDimension=function(){return 2},t.prototype.reverse=function(){for(var i=this,s=this._geometries.length,o=new Array(s).fill(null),a=0;a<this._geometries.length;a++)o[a]=i._geometries[a].reverse();return this.getFactory().createMultiPolygon(o)},t.prototype.getBoundary=function(){var i=this;if(this.isEmpty())return this.getFactory().createMultiLineString();for(var s=new et,o=0;o<this._geometries.length;o++)for(var a=i._geometries[o],l=a.getBoundary(),c=0;c<l.getNumGeometries();c++)s.add(l.getGeometryN(c));var u=new Array(s.size()).fill(null);return this.getFactory().createMultiLineString(s.toArray(u))},t.prototype.getGeometryType=function(){return"MultiPolygon"},t.prototype.copy=function(){for(var i=this,s=new Array(this._geometries.length).fill(null),o=0;o<s.length;o++)s[o]=i._geometries[o].copy();return new t(s,this._factory)},t.prototype.interfaces_=function(){return[qi]},t.prototype.getClass=function(){return t},e.serialVersionUID.get=function(){return-0x7a5aa1369171980},Object.defineProperties(t,e),t}(Je),$n=function(t){this._factory=t||null,this._isUserDataCopied=!1},Fh={NoOpGeometryOperation:{configurable:!0},CoordinateOperation:{configurable:!0},CoordinateSequenceOperation:{configurable:!0}};$n.prototype.setCopyUserData=function(t){this._isUserDataCopied=t};$n.prototype.edit=function(t,e){if(t===null)return null;var r=this.editInternal(t,e);return this._isUserDataCopied&&r.setUserData(t.getUserData()),r};$n.prototype.editInternal=function(t,e){return this._factory===null&&(this._factory=t.getFactory()),t instanceof Je?this.editGeometryCollection(t,e):t instanceof ge?this.editPolygon(t,e):t instanceof bn?e.edit(t,this._factory):t instanceof Jt?e.edit(t,this._factory):(mt.shouldNeverReachHere("Unsupported Geometry class: "+t.getClass().getName()),null)};$n.prototype.editGeometryCollection=function(t,e){for(var r=this,i=e.edit(t,this._factory),s=new et,o=0;o<i.getNumGeometries();o++){var a=r.edit(i.getGeometryN(o),e);a===null||a.isEmpty()||s.add(a)}return i.getClass()===Ca?this._factory.createMultiPoint(s.toArray([])):i.getClass()===Ms?this._factory.createMultiLineString(s.toArray([])):i.getClass()===Kr?this._factory.createMultiPolygon(s.toArray([])):this._factory.createGeometryCollection(s.toArray([]))};$n.prototype.editPolygon=function(t,e){var r=this,i=e.edit(t,this._factory);if(i===null&&(i=this._factory.createPolygon(null)),i.isEmpty())return i;var s=this.edit(i.getExteriorRing(),e);if(s===null||s.isEmpty())return this._factory.createPolygon();for(var o=new et,a=0;a<i.getNumInteriorRing();a++){var l=r.edit(i.getInteriorRingN(a),e);l===null||l.isEmpty()||o.add(l)}return this._factory.createPolygon(s,o.toArray([]))};$n.prototype.interfaces_=function(){return[]};$n.prototype.getClass=function(){return $n};$n.GeometryEditorOperation=function(){};Fh.NoOpGeometryOperation.get=function(){return Bl};Fh.CoordinateOperation.get=function(){return Ul};Fh.CoordinateSequenceOperation.get=function(){return Vl};Object.defineProperties($n,Fh);var Bl=function(){};Bl.prototype.edit=function(t,e){return t};Bl.prototype.interfaces_=function(){return[$n.GeometryEditorOperation]};Bl.prototype.getClass=function(){return Bl};var Ul=function(){};Ul.prototype.edit=function(t,e){var r=this.editCoordinates(t.getCoordinates(),t);return r===null?t:t instanceof ti?e.createLinearRing(r):t instanceof Jt?e.createLineString(r):t instanceof bn?r.length>0?e.createPoint(r[0]):e.createPoint():t};Ul.prototype.interfaces_=function(){return[$n.GeometryEditorOperation]};Ul.prototype.getClass=function(){return Ul};var Vl=function(){};Vl.prototype.edit=function(t,e){return t instanceof ti?e.createLinearRing(this.edit(t.getCoordinateSequence(),t)):t instanceof Jt?e.createLineString(this.edit(t.getCoordinateSequence(),t)):t instanceof bn?e.createPoint(this.edit(t.getCoordinateSequence(),t)):t};Vl.prototype.interfaces_=function(){return[$n.GeometryEditorOperation]};Vl.prototype.getClass=function(){return Vl};var ee=function(){var t=this;if(this._dimension=3,this._coordinates=null,arguments.length===1){if(arguments[0]instanceof Array)this._coordinates=arguments[0],this._dimension=3;else if(Number.isInteger(arguments[0])){var e=arguments[0];this._coordinates=new Array(e).fill(null);for(var r=0;r<e;r++)t._coordinates[r]=new z}else if(ct(arguments[0],xt)){var i=arguments[0];if(i===null)return this._coordinates=new Array(0).fill(null),null;this._dimension=i.getDimension(),this._coordinates=new Array(i.size()).fill(null);for(var s=0;s<this._coordinates.length;s++)t._coordinates[s]=i.getCoordinateCopy(s)}}else if(arguments.length===2){if(arguments[0]instanceof Array&&Number.isInteger(arguments[1])){var o=arguments[0],a=arguments[1];this._coordinates=o,this._dimension=a,o===null&&(this._coordinates=new Array(0).fill(null))}else if(Number.isInteger(arguments[0])&&Number.isInteger(arguments[1])){var l=arguments[0],c=arguments[1];this._coordinates=new Array(l).fill(null),this._dimension=c;for(var u=0;u<l;u++)t._coordinates[u]=new z}}},Qx={serialVersionUID:{configurable:!0}};ee.prototype.setOrdinate=function(t,e,r){switch(e){case xt.X:this._coordinates[t].x=r;break;case xt.Y:this._coordinates[t].y=r;break;case xt.Z:this._coordinates[t].z=r;break;default:throw new Xt("invalid ordinateIndex")}};ee.prototype.size=function(){return this._coordinates.length};ee.prototype.getOrdinate=function(t,e){switch(e){case xt.X:return this._coordinates[t].x;case xt.Y:return this._coordinates[t].y;case xt.Z:return this._coordinates[t].z}return dt.NaN};ee.prototype.getCoordinate=function(){if(arguments.length===1){var t=arguments[0];return this._coordinates[t]}else if(arguments.length===2){var e=arguments[0],r=arguments[1];r.x=this._coordinates[e].x,r.y=this._coordinates[e].y,r.z=this._coordinates[e].z}};ee.prototype.getCoordinateCopy=function(t){return new z(this._coordinates[t])};ee.prototype.getDimension=function(){return this._dimension};ee.prototype.getX=function(t){return this._coordinates[t].x};ee.prototype.clone=function(){for(var t=this,e=new Array(this.size()).fill(null),r=0;r<this._coordinates.length;r++)e[r]=t._coordinates[r].clone();return new ee(e,this._dimension)};ee.prototype.expandEnvelope=function(t){for(var e=this,r=0;r<this._coordinates.length;r++)t.expandToInclude(e._coordinates[r]);return t};ee.prototype.copy=function(){for(var t=this,e=new Array(this.size()).fill(null),r=0;r<this._coordinates.length;r++)e[r]=t._coordinates[r].copy();return new ee(e,this._dimension)};ee.prototype.toString=function(){var t=this;if(this._coordinates.length>0){var e=new Vr(17*this._coordinates.length);e.append("("),e.append(this._coordinates[0]);for(var r=1;r<this._coordinates.length;r++)e.append(", "),e.append(t._coordinates[r]);return e.append(")"),e.toString()}else return"()"};ee.prototype.getY=function(t){return this._coordinates[t].y};ee.prototype.toCoordinateArray=function(){return this._coordinates};ee.prototype.interfaces_=function(){return[xt,Yn]};ee.prototype.getClass=function(){return ee};Qx.serialVersionUID.get=function(){return-0xcb44a778db18e00};Object.defineProperties(ee,Qx);var ei=function(){},dg={serialVersionUID:{configurable:!0},instanceObject:{configurable:!0}};ei.prototype.readResolve=function(){return ei.instance()};ei.prototype.create=function(){if(arguments.length===1){if(arguments[0]instanceof Array){var t=arguments[0];return new ee(t)}else if(ct(arguments[0],xt)){var e=arguments[0];return new ee(e)}}else if(arguments.length===2){var r=arguments[0],i=arguments[1];return i>3&&(i=3),i<2?new ee(r):new ee(r,i)}};ei.prototype.interfaces_=function(){return[va,Yn]};ei.prototype.getClass=function(){return ei};ei.instance=function(){return ei.instanceObject};dg.serialVersionUID.get=function(){return-0x38e49fa6cf6f2e00};dg.instanceObject.get=function(){return new ei};Object.defineProperties(ei,dg);var tE=function(n){function t(){n.call(this),this.map_=new Map}return n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t,t.prototype.get=function(r){return this.map_.get(r)||null},t.prototype.put=function(r,i){return this.map_.set(r,i),i},t.prototype.values=function(){for(var r=new et,i=this.map_.values(),s=i.next();!s.done;)r.add(s.value),s=i.next();return r},t.prototype.entrySet=function(){var r=new hg;return this.map_.entries().forEach(function(i){return r.add(i)}),r},t.prototype.size=function(){return this.map_.size()},t}(Oo),Tt=function n(){if(this._modelType=null,this._scale=null,arguments.length===0)this._modelType=n.FLOATING;else if(arguments.length===1){if(arguments[0]instanceof Nr){var t=arguments[0];this._modelType=t,t===n.FIXED&&this.setScale(1)}else if(typeof arguments[0]=="number"){var e=arguments[0];this._modelType=n.FIXED,this.setScale(e)}else if(arguments[0]instanceof n){var r=arguments[0];this._modelType=r._modelType,this._scale=r._scale}}},pg={serialVersionUID:{configurable:!0},maximumPreciseValue:{configurable:!0}};Tt.prototype.equals=function(t){if(!(t instanceof Tt))return!1;var e=t;return this._modelType===e._modelType&&this._scale===e._scale};Tt.prototype.compareTo=function(t){var e=t,r=this.getMaximumSignificantDigits(),i=e.getMaximumSignificantDigits();return new Ar(r).compareTo(new Ar(i))};Tt.prototype.getScale=function(){return this._scale};Tt.prototype.isFloating=function(){return this._modelType===Tt.FLOATING||this._modelType===Tt.FLOATING_SINGLE};Tt.prototype.getType=function(){return this._modelType};Tt.prototype.toString=function(){var t="UNKNOWN";return this._modelType===Tt.FLOATING?t="Floating":this._modelType===Tt.FLOATING_SINGLE?t="Floating-Single":this._modelType===Tt.FIXED&&(t="Fixed (Scale="+this.getScale()+")"),t};Tt.prototype.makePrecise=function(){if(typeof arguments[0]=="number"){var t=arguments[0];if(dt.isNaN(t))return t;if(this._modelType===Tt.FLOATING_SINGLE){var e=t;return e}return this._modelType===Tt.FIXED?Math.round(t*this._scale)/this._scale:t}else if(arguments[0]instanceof z){var r=arguments[0];if(this._modelType===Tt.FLOATING)return null;r.x=this.makePrecise(r.x),r.y=this.makePrecise(r.y)}};Tt.prototype.getMaximumSignificantDigits=function(){var t=16;return this._modelType===Tt.FLOATING?t=16:this._modelType===Tt.FLOATING_SINGLE?t=6:this._modelType===Tt.FIXED&&(t=1+Math.trunc(Math.ceil(Math.log(this.getScale())/Math.log(10)))),t};Tt.prototype.setScale=function(t){this._scale=Math.abs(t)};Tt.prototype.interfaces_=function(){return[Yn,Gn]};Tt.prototype.getClass=function(){return Tt};Tt.mostPrecise=function(t,e){return t.compareTo(e)>=0?t:e};pg.serialVersionUID.get=function(){return 7777263578777804e3};pg.maximumPreciseValue.get=function(){return 9007199254740992};Object.defineProperties(Tt,pg);var Nr=function n(t){this._name=t||null,n.nameToTypeMap.put(t,this)},gg={serialVersionUID:{configurable:!0},nameToTypeMap:{configurable:!0}};Nr.prototype.readResolve=function(){return Nr.nameToTypeMap.get(this._name)};Nr.prototype.toString=function(){return this._name};Nr.prototype.interfaces_=function(){return[Yn]};Nr.prototype.getClass=function(){return Nr};gg.serialVersionUID.get=function(){return-552860263173159e4};gg.nameToTypeMap.get=function(){return new tE};Object.defineProperties(Nr,gg);Tt.Type=Nr;Tt.FIXED=new Nr("FIXED");Tt.FLOATING=new Nr("FLOATING");Tt.FLOATING_SINGLE=new Nr("FLOATING SINGLE");var _t=function n(){this._precisionModel=new Tt,this._SRID=0,this._coordinateSequenceFactory=n.getDefaultCoordinateSequenceFactory(),arguments.length===0||(arguments.length===1?ct(arguments[0],va)?this._coordinateSequenceFactory=arguments[0]:arguments[0]instanceof Tt&&(this._precisionModel=arguments[0]):arguments.length===2?(this._precisionModel=arguments[0],this._SRID=arguments[1]):arguments.length===3&&(this._precisionModel=arguments[0],this._SRID=arguments[1],this._coordinateSequenceFactory=arguments[2]))},eE={serialVersionUID:{configurable:!0}};_t.prototype.toGeometry=function(t){return t.isNull()?this.createPoint(null):t.getMinX()===t.getMaxX()&&t.getMinY()===t.getMaxY()?this.createPoint(new z(t.getMinX(),t.getMinY())):t.getMinX()===t.getMaxX()||t.getMinY()===t.getMaxY()?this.createLineString([new z(t.getMinX(),t.getMinY()),new z(t.getMaxX(),t.getMaxY())]):this.createPolygon(this.createLinearRing([new z(t.getMinX(),t.getMinY()),new z(t.getMinX(),t.getMaxY()),new z(t.getMaxX(),t.getMaxY()),new z(t.getMaxX(),t.getMinY()),new z(t.getMinX(),t.getMinY())]),null)};_t.prototype.createLineString=function(t){if(t){if(t instanceof Array)return new Jt(this.getCoordinateSequenceFactory().create(t),this);if(ct(t,xt))return new Jt(t,this)}else return new Jt(this.getCoordinateSequenceFactory().create([]),this)};_t.prototype.createMultiLineString=function(){if(arguments.length===0)return new Ms(null,this);if(arguments.length===1){var t=arguments[0];return new Ms(t,this)}};_t.prototype.buildGeometry=function(t){for(var e=null,r=!1,i=!1,s=t.iterator();s.hasNext();){var o=s.next(),a=o.getClass();e===null&&(e=a),a!==e&&(r=!0),o.isGeometryCollectionOrDerived()&&(i=!0)}if(e===null)return this.createGeometryCollection();if(r||i)return this.createGeometryCollection(_t.toGeometryArray(t));var l=t.iterator().next(),c=t.size()>1;if(c){if(l instanceof ge)return this.createMultiPolygon(_t.toPolygonArray(t));if(l instanceof Jt)return this.createMultiLineString(_t.toLineStringArray(t));if(l instanceof bn)return this.createMultiPoint(_t.toPointArray(t));mt.shouldNeverReachHere("Unhandled class: "+l.getClass().getName())}return l};_t.prototype.createMultiPointFromCoords=function(t){return this.createMultiPoint(t!==null?this.getCoordinateSequenceFactory().create(t):null)};_t.prototype.createPoint=function(){if(arguments.length===0)return this.createPoint(this.getCoordinateSequenceFactory().create([]));if(arguments.length===1){if(arguments[0]instanceof z){var t=arguments[0];return this.createPoint(t!==null?this.getCoordinateSequenceFactory().create([t]):null)}else if(ct(arguments[0],xt)){var e=arguments[0];return new bn(e,this)}}};_t.prototype.getCoordinateSequenceFactory=function(){return this._coordinateSequenceFactory};_t.prototype.createPolygon=function(){if(arguments.length===0)return new ge(null,null,this);if(arguments.length===1){if(ct(arguments[0],xt)){var t=arguments[0];return this.createPolygon(this.createLinearRing(t))}else if(arguments[0]instanceof Array){var e=arguments[0];return this.createPolygon(this.createLinearRing(e))}else if(arguments[0]instanceof ti){var r=arguments[0];return this.createPolygon(r,null)}}else if(arguments.length===2){var i=arguments[0],s=arguments[1];return new ge(i,s,this)}};_t.prototype.getSRID=function(){return this._SRID};_t.prototype.createGeometryCollection=function(){if(arguments.length===0)return new Je(null,this);if(arguments.length===1){var t=arguments[0];return new Je(t,this)}};_t.prototype.createGeometry=function(t){var e=new $n(this);return e.edit(t,{edit:function(){if(arguments.length===2){var r=arguments[0];return this._coordinateSequenceFactory.create(r)}}})};_t.prototype.getPrecisionModel=function(){return this._precisionModel};_t.prototype.createLinearRing=function(){if(arguments.length===0)return this.createLinearRing(this.getCoordinateSequenceFactory().create([]));if(arguments.length===1){if(arguments[0]instanceof Array){var t=arguments[0];return this.createLinearRing(t!==null?this.getCoordinateSequenceFactory().create(t):null)}else if(ct(arguments[0],xt)){var e=arguments[0];return new ti(e,this)}}};_t.prototype.createMultiPolygon=function(){if(arguments.length===0)return new Kr(null,this);if(arguments.length===1){var t=arguments[0];return new Kr(t,this)}};_t.prototype.createMultiPoint=function(){var t=this;if(arguments.length===0)return new Ca(null,this);if(arguments.length===1){if(arguments[0]instanceof Array){var e=arguments[0];return new Ca(e,this)}else if(arguments[0]instanceof Array){var r=arguments[0];return this.createMultiPoint(r!==null?this.getCoordinateSequenceFactory().create(r):null)}else if(ct(arguments[0],xt)){var i=arguments[0];if(i===null)return this.createMultiPoint(new Array(0).fill(null));for(var s=new Array(i.size()).fill(null),o=0;o<i.size();o++){var a=t.getCoordinateSequenceFactory().create(1,i.getDimension());re.copy(i,o,a,0,1),s[o]=t.createPoint(a)}return this.createMultiPoint(s)}}};_t.prototype.interfaces_=function(){return[Yn]};_t.prototype.getClass=function(){return _t};_t.toMultiPolygonArray=function(t){var e=new Array(t.size()).fill(null);return t.toArray(e)};_t.toGeometryArray=function(t){if(t===null)return null;var e=new Array(t.size()).fill(null);return t.toArray(e)};_t.getDefaultCoordinateSequenceFactory=function(){return ei.instance()};_t.toMultiLineStringArray=function(t){var e=new Array(t.size()).fill(null);return t.toArray(e)};_t.toLineStringArray=function(t){var e=new Array(t.size()).fill(null);return t.toArray(e)};_t.toMultiPointArray=function(t){var e=new Array(t.size()).fill(null);return t.toArray(e)};_t.toLinearRingArray=function(t){var e=new Array(t.size()).fill(null);return t.toArray(e)};_t.toPointArray=function(t){var e=new Array(t.size()).fill(null);return t.toArray(e)};_t.toPolygonArray=function(t){var e=new Array(t.size()).fill(null);return t.toArray(e)};_t.createPointFromInternalCoord=function(t,e){return e.getPrecisionModel().makePrecise(t),e.getFactory().createPoint(t)};eE.serialVersionUID.get=function(){return-6820524753094096e3};Object.defineProperties(_t,eE);var hk=["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon"],Bh=function(t){this.geometryFactory=t||new _t};Bh.prototype.read=function(t){var e;typeof t=="string"?e=JSON.parse(t):e=t;var r=e.type;if(!_r[r])throw new Error("Unknown GeoJSON type: "+e.type);return hk.indexOf(r)!==-1?_r[r].apply(this,[e.coordinates]):r==="GeometryCollection"?_r[r].apply(this,[e.geometries]):_r[r].apply(this,[e])};Bh.prototype.write=function(t){var e=t.getGeometryType();if(!_i[e])throw new Error("Geometry is not supported");return _i[e].apply(this,[t])};var _r={Feature:function(n){var t={};for(var e in n)t[e]=n[e];if(n.geometry){var r=n.geometry.type;if(!_r[r])throw new Error("Unknown GeoJSON type: "+n.type);t.geometry=this.read(n.geometry)}return n.bbox&&(t.bbox=_r.bbox.apply(this,[n.bbox])),t},FeatureCollection:function(n){var t=this,e={};if(n.features){e.features=[];for(var r=0;r<n.features.length;++r)e.features.push(t.read(n.features[r]))}return n.bbox&&(e.bbox=this.parse.bbox.apply(this,[n.bbox])),e},coordinates:function(n){for(var t=[],e=0;e<n.length;++e){var r=n[e];t.push(new z(r[0],r[1]))}return t},bbox:function(n){return this.geometryFactory.createLinearRing([new z(n[0],n[1]),new z(n[2],n[1]),new z(n[2],n[3]),new z(n[0],n[3]),new z(n[0],n[1])])},Point:function(n){var t=new z(n[0],n[1]);return this.geometryFactory.createPoint(t)},MultiPoint:function(n){for(var t=this,e=[],r=0;r<n.length;++r)e.push(_r.Point.apply(t,[n[r]]));return this.geometryFactory.createMultiPoint(e)},LineString:function(n){var t=_r.coordinates.apply(this,[n]);return this.geometryFactory.createLineString(t)},MultiLineString:function(n){for(var t=this,e=[],r=0;r<n.length;++r)e.push(_r.LineString.apply(t,[n[r]]));return this.geometryFactory.createMultiLineString(e)},Polygon:function(n){for(var t=this,e=_r.coordinates.apply(this,[n[0]]),r=this.geometryFactory.createLinearRing(e),i=[],s=1;s<n.length;++s){var o=n[s],a=_r.coordinates.apply(t,[o]),l=t.geometryFactory.createLinearRing(a);i.push(l)}return this.geometryFactory.createPolygon(r,i)},MultiPolygon:function(n){for(var t=this,e=[],r=0;r<n.length;++r){var i=n[r];e.push(_r.Polygon.apply(t,[i]))}return this.geometryFactory.createMultiPolygon(e)},GeometryCollection:function(n){for(var t=this,e=[],r=0;r<n.length;++r){var i=n[r];e.push(t.read(i))}return this.geometryFactory.createGeometryCollection(e)}},_i={coordinate:function(n){return[n.x,n.y]},Point:function(n){var t=_i.coordinate.apply(this,[n.getCoordinate()]);return{type:"Point",coordinates:t}},MultiPoint:function(n){for(var t=this,e=[],r=0;r<n._geometries.length;++r){var i=n._geometries[r],s=_i.Point.apply(t,[i]);e.push(s.coordinates)}return{type:"MultiPoint",coordinates:e}},LineString:function(n){for(var t=this,e=[],r=n.getCoordinates(),i=0;i<r.length;++i){var s=r[i];e.push(_i.coordinate.apply(t,[s]))}return{type:"LineString",coordinates:e}},MultiLineString:function(n){for(var t=this,e=[],r=0;r<n._geometries.length;++r){var i=n._geometries[r],s=_i.LineString.apply(t,[i]);e.push(s.coordinates)}return{type:"MultiLineString",coordinates:e}},Polygon:function(n){var t=this,e=[],r=_i.LineString.apply(this,[n._shell]);e.push(r.coordinates);for(var i=0;i<n._holes.length;++i){var s=n._holes[i],o=_i.LineString.apply(t,[s]);e.push(o.coordinates)}return{type:"Polygon",coordinates:e}},MultiPolygon:function(n){for(var t=this,e=[],r=0;r<n._geometries.length;++r){var i=n._geometries[r],s=_i.Polygon.apply(t,[i]);e.push(s.coordinates)}return{type:"MultiPolygon",coordinates:e}},GeometryCollection:function(n){for(var t=this,e=[],r=0;r<n._geometries.length;++r){var i=n._geometries[r],s=i.getGeometryType();e.push(_i[s].apply(t,[i]))}return{type:"GeometryCollection",geometries:e}}},mg=function(t){this.geometryFactory=t||new _t,this.precisionModel=this.geometryFactory.getPrecisionModel(),this.parser=new Bh(this.geometryFactory)};mg.prototype.read=function(t){var e=this.parser.read(t);return this.precisionModel.getType()===Tt.FIXED&&this.reducePrecision(e),e};mg.prototype.reducePrecision=function(t){var e=this,r,i;if(t.coordinate)this.precisionModel.makePrecise(t.coordinate);else if(t.points)for(r=0,i=t.points.length;r<i;r++)e.precisionModel.makePrecise(t.points[r]);else if(t.geometries)for(r=0,i=t.geometries.length;r<i;r++)e.reducePrecision(t.geometries[r])};var nE=function(){this.parser=new Bh(this.geometryFactory)};nE.prototype.write=function(t){return this.parser.write(t)};var Q=function(){},Uh={ON:{configurable:!0},LEFT:{configurable:!0},RIGHT:{configurable:!0}};Q.prototype.interfaces_=function(){return[]};Q.prototype.getClass=function(){return Q};Q.opposite=function(t){return t===Q.LEFT?Q.RIGHT:t===Q.RIGHT?Q.LEFT:t};Uh.ON.get=function(){return 0};Uh.LEFT.get=function(){return 1};Uh.RIGHT.get=function(){return 2};Object.defineProperties(Q,Uh);function Vh(n){this.message=n||""}Vh.prototype=new Error;Vh.prototype.name="EmptyStackException";function zr(){this.array_=[]}zr.prototype=new tr;zr.prototype.add=function(n){return this.array_.push(n),!0};zr.prototype.get=function(n){if(n<0||n>=this.size())throw new Error;return this.array_[n]};zr.prototype.push=function(n){return this.array_.push(n),n};zr.prototype.pop=function(n){if(this.array_.length===0)throw new Vh;return this.array_.pop()};zr.prototype.peek=function(){if(this.array_.length===0)throw new Vh;return this.array_[this.array_.length-1]};zr.prototype.empty=function(){return this.array_.length===0};zr.prototype.isEmpty=function(){return this.empty()};zr.prototype.search=function(n){return this.array_.indexOf(n)};zr.prototype.size=function(){return this.array_.length};zr.prototype.toArray=function(){for(var n=this,t=[],e=0,r=this.array_.length;e<r;e++)t.push(n.array_[e]);return t};var Or=function(){this._minIndex=-1,this._minCoord=null,this._minDe=null,this._orientedDe=null};Or.prototype.getCoordinate=function(){return this._minCoord};Or.prototype.getRightmostSide=function(t,e){var r=this.getRightmostSideOfSegment(t,e);return r<0&&(r=this.getRightmostSideOfSegment(t,e-1)),r<0&&(this._minCoord=null,this.checkForRightmostCoordinate(t)),r};Or.prototype.findRightmostEdgeAtVertex=function(){var t=this._minDe.getEdge().getCoordinates();mt.isTrue(this._minIndex>0&&this._minIndex<t.length,"rightmost point expected to be interior vertex of edge");var e=t[this._minIndex-1],r=t[this._minIndex+1],i=rt.computeOrientation(this._minCoord,r,e),s=!1;(e.y<this._minCoord.y&&r.y<this._minCoord.y&&i===rt.COUNTERCLOCKWISE||e.y>this._minCoord.y&&r.y>this._minCoord.y&&i===rt.CLOCKWISE)&&(s=!0),s&&(this._minIndex=this._minIndex-1)};Or.prototype.getRightmostSideOfSegment=function(t,e){var r=t.getEdge(),i=r.getCoordinates();if(e<0||e+1>=i.length||i[e].y===i[e+1].y)return-1;var s=Q.LEFT;return i[e].y<i[e+1].y&&(s=Q.RIGHT),s};Or.prototype.getEdge=function(){return this._orientedDe};Or.prototype.checkForRightmostCoordinate=function(t){for(var e=this,r=t.getEdge().getCoordinates(),i=0;i<r.length-1;i++)(e._minCoord===null||r[i].x>e._minCoord.x)&&(e._minDe=t,e._minIndex=i,e._minCoord=r[i])};Or.prototype.findRightmostEdgeAtNode=function(){var t=this._minDe.getNode(),e=t.getEdges();this._minDe=e.getRightmostEdge(),this._minDe.isForward()||(this._minDe=this._minDe.getSym(),this._minIndex=this._minDe.getEdge().getCoordinates().length-1)};Or.prototype.findEdge=function(t){for(var e=this,r=t.iterator();r.hasNext();){var i=r.next();i.isForward()&&e.checkForRightmostCoordinate(i)}mt.isTrue(this._minIndex!==0||this._minCoord.equals(this._minDe.getCoordinate()),"inconsistency in rightmost processing"),this._minIndex===0?this.findRightmostEdgeAtNode():this.findRightmostEdgeAtVertex(),this._orientedDe=this._minDe;var s=this.getRightmostSide(this._minDe,this._minIndex);s===Q.LEFT&&(this._orientedDe=this._minDe.getSym())};Or.prototype.interfaces_=function(){return[]};Or.prototype.getClass=function(){return Or};var Ai=function(n){function t(e,r){n.call(this,t.msgWithCoord(e,r)),this.pt=r?new z(r):null,this.name="TopologyException"}return n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t,t.prototype.getCoordinate=function(){return this.pt},t.prototype.interfaces_=function(){return[]},t.prototype.getClass=function(){return t},t.msgWithCoord=function(r,i){return i?r:r+" [ "+i+" ]"},t}(Pi),zh=function(){this.array_=[]};zh.prototype.addLast=function(t){this.array_.push(t)};zh.prototype.removeFirst=function(){return this.array_.shift()};zh.prototype.isEmpty=function(){return this.array_.length===0};var Qe=function(){this._finder=null,this._dirEdgeList=new et,this._nodes=new et,this._rightMostCoord=null,this._env=null,this._finder=new Or};Qe.prototype.clearVisitedEdges=function(){for(var t=this._dirEdgeList.iterator();t.hasNext();){var e=t.next();e.setVisited(!1)}};Qe.prototype.getRightmostCoordinate=function(){return this._rightMostCoord};Qe.prototype.computeNodeDepth=function(t){for(var e=this,r=null,i=t.getEdges().iterator();i.hasNext();){var s=i.next();if(s.isVisited()||s.getSym().isVisited()){r=s;break}}if(r===null)throw new Ai("unable to find edge to compute depths at "+t.getCoordinate());t.getEdges().computeDepths(r);for(var o=t.getEdges().iterator();o.hasNext();){var a=o.next();a.setVisited(!0),e.copySymDepths(a)}};Qe.prototype.computeDepth=function(t){this.clearVisitedEdges();var e=this._finder.getEdge();e.setEdgeDepths(Q.RIGHT,t),this.copySymDepths(e),this.computeDepths(e)};Qe.prototype.create=function(t){this.addReachable(t),this._finder.findEdge(this._dirEdgeList),this._rightMostCoord=this._finder.getCoordinate()};Qe.prototype.findResultEdges=function(){for(var t=this._dirEdgeList.iterator();t.hasNext();){var e=t.next();e.getDepth(Q.RIGHT)>=1&&e.getDepth(Q.LEFT)<=0&&!e.isInteriorAreaEdge()&&e.setInResult(!0)}};Qe.prototype.computeDepths=function(t){var e=this,r=new hg,i=new zh,s=t.getNode();for(i.addLast(s),r.add(s),t.setVisited(!0);!i.isEmpty();){var o=i.removeFirst();r.add(o),e.computeNodeDepth(o);for(var a=o.getEdges().iterator();a.hasNext();){var l=a.next(),c=l.getSym();if(!c.isVisited()){var u=c.getNode();r.contains(u)||(i.addLast(u),r.add(u))}}}};Qe.prototype.compareTo=function(t){var e=t;return this._rightMostCoord.x<e._rightMostCoord.x?-1:this._rightMostCoord.x>e._rightMostCoord.x?1:0};Qe.prototype.getEnvelope=function(){if(this._env===null){for(var t=new st,e=this._dirEdgeList.iterator();e.hasNext();)for(var r=e.next(),i=r.getEdge().getCoordinates(),s=0;s<i.length-1;s++)t.expandToInclude(i[s]);this._env=t}return this._env};Qe.prototype.addReachable=function(t){var e=this,r=new zr;for(r.add(t);!r.empty();){var i=r.pop();e.add(i,r)}};Qe.prototype.copySymDepths=function(t){var e=t.getSym();e.setDepth(Q.LEFT,t.getDepth(Q.RIGHT)),e.setDepth(Q.RIGHT,t.getDepth(Q.LEFT))};Qe.prototype.add=function(t,e){var r=this;t.setVisited(!0),this._nodes.add(t);for(var i=t.getEdges().iterator();i.hasNext();){var s=i.next();r._dirEdgeList.add(s);var o=s.getSym(),a=o.getNode();a.isVisited()||e.push(a)}};Qe.prototype.getNodes=function(){return this._nodes};Qe.prototype.getDirectedEdges=function(){return this._dirEdgeList};Qe.prototype.interfaces_=function(){return[Gn]};Qe.prototype.getClass=function(){return Qe};var Vt=function n(){var t=this;if(this.location=null,arguments.length===1){if(arguments[0]instanceof Array){var e=arguments[0];this.init(e.length)}else if(Number.isInteger(arguments[0])){var r=arguments[0];this.init(1),this.location[Q.ON]=r}else if(arguments[0]instanceof n){var i=arguments[0];if(this.init(i.location.length),i!==null)for(var s=0;s<this.location.length;s++)t.location[s]=i.location[s]}}else if(arguments.length===3){var o=arguments[0],a=arguments[1],l=arguments[2];this.init(3),this.location[Q.ON]=o,this.location[Q.LEFT]=a,this.location[Q.RIGHT]=l}};Vt.prototype.setAllLocations=function(t){for(var e=this,r=0;r<this.location.length;r++)e.location[r]=t};Vt.prototype.isNull=function(){for(var t=this,e=0;e<this.location.length;e++)if(t.location[e]!==j.NONE)return!1;return!0};Vt.prototype.setAllLocationsIfNull=function(t){for(var e=this,r=0;r<this.location.length;r++)e.location[r]===j.NONE&&(e.location[r]=t)};Vt.prototype.isLine=function(){return this.location.length===1};Vt.prototype.merge=function(t){var e=this;if(t.location.length>this.location.length){var r=new Array(3).fill(null);r[Q.ON]=this.location[Q.ON],r[Q.LEFT]=j.NONE,r[Q.RIGHT]=j.NONE,this.location=r}for(var i=0;i<this.location.length;i++)e.location[i]===j.NONE&&i<t.location.length&&(e.location[i]=t.location[i])};Vt.prototype.getLocations=function(){return this.location};Vt.prototype.flip=function(){if(this.location.length<=1)return null;var t=this.location[Q.LEFT];this.location[Q.LEFT]=this.location[Q.RIGHT],this.location[Q.RIGHT]=t};Vt.prototype.toString=function(){var t=new Vr;return this.location.length>1&&t.append(j.toLocationSymbol(this.location[Q.LEFT])),t.append(j.toLocationSymbol(this.location[Q.ON])),this.location.length>1&&t.append(j.toLocationSymbol(this.location[Q.RIGHT])),t.toString()};Vt.prototype.setLocations=function(t,e,r){this.location[Q.ON]=t,this.location[Q.LEFT]=e,this.location[Q.RIGHT]=r};Vt.prototype.get=function(t){return t<this.location.length?this.location[t]:j.NONE};Vt.prototype.isArea=function(){return this.location.length>1};Vt.prototype.isAnyNull=function(){for(var t=this,e=0;e<this.location.length;e++)if(t.location[e]===j.NONE)return!0;return!1};Vt.prototype.setLocation=function(){if(arguments.length===1){var t=arguments[0];this.setLocation(Q.ON,t)}else if(arguments.length===2){var e=arguments[0],r=arguments[1];this.location[e]=r}};Vt.prototype.init=function(t){this.location=new Array(t).fill(null),this.setAllLocations(j.NONE)};Vt.prototype.isEqualOnSide=function(t,e){return this.location[e]===t.location[e]};Vt.prototype.allPositionsEqual=function(t){for(var e=this,r=0;r<this.location.length;r++)if(e.location[r]!==t)return!1;return!0};Vt.prototype.interfaces_=function(){return[]};Vt.prototype.getClass=function(){return Vt};var Mt=function n(){if(this.elt=new Array(2).fill(null),arguments.length===1){if(Number.isInteger(arguments[0])){var t=arguments[0];this.elt[0]=new Vt(t),this.elt[1]=new Vt(t)}else if(arguments[0]instanceof n){var e=arguments[0];this.elt[0]=new Vt(e.elt[0]),this.elt[1]=new Vt(e.elt[1])}}else if(arguments.length===2){var r=arguments[0],i=arguments[1];this.elt[0]=new Vt(j.NONE),this.elt[1]=new Vt(j.NONE),this.elt[r].setLocation(i)}else if(arguments.length===3){var s=arguments[0],o=arguments[1],a=arguments[2];this.elt[0]=new Vt(s,o,a),this.elt[1]=new Vt(s,o,a)}else if(arguments.length===4){var l=arguments[0],c=arguments[1],u=arguments[2],h=arguments[3];this.elt[0]=new Vt(j.NONE,j.NONE,j.NONE),this.elt[1]=new Vt(j.NONE,j.NONE,j.NONE),this.elt[l].setLocations(c,u,h)}};Mt.prototype.getGeometryCount=function(){var t=0;return this.elt[0].isNull()||t++,this.elt[1].isNull()||t++,t};Mt.prototype.setAllLocations=function(t,e){this.elt[t].setAllLocations(e)};Mt.prototype.isNull=function(t){return this.elt[t].isNull()};Mt.prototype.setAllLocationsIfNull=function(){if(arguments.length===1){var t=arguments[0];this.setAllLocationsIfNull(0,t),this.setAllLocationsIfNull(1,t)}else if(arguments.length===2){var e=arguments[0],r=arguments[1];this.elt[e].setAllLocationsIfNull(r)}};Mt.prototype.isLine=function(t){return this.elt[t].isLine()};Mt.prototype.merge=function(t){for(var e=this,r=0;r<2;r++)e.elt[r]===null&&t.elt[r]!==null?e.elt[r]=new Vt(t.elt[r]):e.elt[r].merge(t.elt[r])};Mt.prototype.flip=function(){this.elt[0].flip(),this.elt[1].flip()};Mt.prototype.getLocation=function(){if(arguments.length===1){var t=arguments[0];return this.elt[t].get(Q.ON)}else if(arguments.length===2){var e=arguments[0],r=arguments[1];return this.elt[e].get(r)}};Mt.prototype.toString=function(){var t=new Vr;return this.elt[0]!==null&&(t.append("A:"),t.append(this.elt[0].toString())),this.elt[1]!==null&&(t.append(" B:"),t.append(this.elt[1].toString())),t.toString()};Mt.prototype.isArea=function(){if(arguments.length===0)return this.elt[0].isArea()||this.elt[1].isArea();if(arguments.length===1){var t=arguments[0];return this.elt[t].isArea()}};Mt.prototype.isAnyNull=function(t){return this.elt[t].isAnyNull()};Mt.prototype.setLocation=function(){if(arguments.length===2){var t=arguments[0],e=arguments[1];this.elt[t].setLocation(Q.ON,e)}else if(arguments.length===3){var r=arguments[0],i=arguments[1],s=arguments[2];this.elt[r].setLocation(i,s)}};Mt.prototype.isEqualOnSide=function(t,e){return this.elt[0].isEqualOnSide(t.elt[0],e)&&this.elt[1].isEqualOnSide(t.elt[1],e)};Mt.prototype.allPositionsEqual=function(t,e){return this.elt[t].allPositionsEqual(e)};Mt.prototype.toLine=function(t){this.elt[t].isArea()&&(this.elt[t]=new Vt(this.elt[t].location[0]))};Mt.prototype.interfaces_=function(){return[]};Mt.prototype.getClass=function(){return Mt};Mt.toLineLabel=function(t){for(var e=new Mt(j.NONE),r=0;r<2;r++)e.setLocation(r,t.getLocation(r));return e};var le=function(){this._startDe=null,this._maxNodeDegree=-1,this._edges=new et,this._pts=new et,this._label=new Mt(j.NONE),this._ring=null,this._isHole=null,this._shell=null,this._holes=new et,this._geometryFactory=null;var t=arguments[0],e=arguments[1];this._geometryFactory=e,this.computePoints(t),this.computeRing()};le.prototype.computeRing=function(){var t=this;if(this._ring!==null)return null;for(var e=new Array(this._pts.size()).fill(null),r=0;r<this._pts.size();r++)e[r]=t._pts.get(r);this._ring=this._geometryFactory.createLinearRing(e),this._isHole=rt.isCCW(this._ring.getCoordinates())};le.prototype.isIsolated=function(){return this._label.getGeometryCount()===1};le.prototype.computePoints=function(t){var e=this;this._startDe=t;var r=t,i=!0;do{if(r===null)throw new Ai("Found null DirectedEdge");if(r.getEdgeRing()===e)throw new Ai("Directed Edge visited twice during ring-building at "+r.getCoordinate());e._edges.add(r);var s=r.getLabel();mt.isTrue(s.isArea()),e.mergeLabel(s),e.addPoints(r.getEdge(),r.isForward(),i),i=!1,e.setEdgeRing(r,e),r=e.getNext(r)}while(r!==this._startDe)};le.prototype.getLinearRing=function(){return this._ring};le.prototype.getCoordinate=function(t){return this._pts.get(t)};le.prototype.computeMaxNodeDegree=function(){var t=this;this._maxNodeDegree=0;var e=this._startDe;do{var r=e.getNode(),i=r.getEdges().getOutgoingDegree(t);i>t._maxNodeDegree&&(t._maxNodeDegree=i),e=t.getNext(e)}while(e!==this._startDe);this._maxNodeDegree*=2};le.prototype.addPoints=function(t,e,r){var i=this,s=t.getCoordinates();if(e){var o=1;r&&(o=0);for(var a=o;a<s.length;a++)i._pts.add(s[a])}else{var l=s.length-2;r&&(l=s.length-1);for(var c=l;c>=0;c--)i._pts.add(s[c])}};le.prototype.isHole=function(){return this._isHole};le.prototype.setInResult=function(){var t=this._startDe;do t.getEdge().setInResult(!0),t=t.getNext();while(t!==this._startDe)};le.prototype.containsPoint=function(t){var e=this.getLinearRing(),r=e.getEnvelopeInternal();if(!r.contains(t)||!rt.isPointInRing(t,e.getCoordinates()))return!1;for(var i=this._holes.iterator();i.hasNext();){var s=i.next();if(s.containsPoint(t))return!1}return!0};le.prototype.addHole=function(t){this._holes.add(t)};le.prototype.isShell=function(){return this._shell===null};le.prototype.getLabel=function(){return this._label};le.prototype.getEdges=function(){return this._edges};le.prototype.getMaxNodeDegree=function(){return this._maxNodeDegree<0&&this.computeMaxNodeDegree(),this._maxNodeDegree};le.prototype.getShell=function(){return this._shell};le.prototype.mergeLabel=function(){if(arguments.length===1){var t=arguments[0];this.mergeLabel(t,0),this.mergeLabel(t,1)}else if(arguments.length===2){var e=arguments[0],r=arguments[1],i=e.getLocation(r,Q.RIGHT);if(i===j.NONE)return null;if(this._label.getLocation(r)===j.NONE)return this._label.setLocation(r,i),null}};le.prototype.setShell=function(t){this._shell=t,t!==null&&t.addHole(this)};le.prototype.toPolygon=function(t){for(var e=this,r=new Array(this._holes.size()).fill(null),i=0;i<this._holes.size();i++)r[i]=e._holes.get(i).getLinearRing();var s=t.createPolygon(this.getLinearRing(),r);return s};le.prototype.interfaces_=function(){return[]};le.prototype.getClass=function(){return le};var fk=function(n){function t(){var e=arguments[0],r=arguments[1];n.call(this,e,r)}return n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t,t.prototype.setEdgeRing=function(r,i){r.setMinEdgeRing(i)},t.prototype.getNext=function(r){return r.getNextMin()},t.prototype.interfaces_=function(){return[]},t.prototype.getClass=function(){return t},t}(le),dk=function(n){function t(){var e=arguments[0],r=arguments[1];n.call(this,e,r)}return n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t,t.prototype.buildMinimalRings=function(){var r=this,i=new et,s=this._startDe;do{if(s.getMinEdgeRing()===null){var o=new fk(s,r._geometryFactory);i.add(o)}s=s.getNext()}while(s!==this._startDe);return i},t.prototype.setEdgeRing=function(r,i){r.setEdgeRing(i)},t.prototype.linkDirectedEdgesForMinimalEdgeRings=function(){var r=this,i=this._startDe;do{var s=i.getNode();s.getEdges().linkMinimalDirectedEdges(r),i=i.getNext()}while(i!==this._startDe)},t.prototype.getNext=function(r){return r.getNext()},t.prototype.interfaces_=function(){return[]},t.prototype.getClass=function(){return t},t}(le),Dn=function(){if(this._label=null,this._isInResult=!1,this._isCovered=!1,this._isCoveredSet=!1,this._isVisited=!1,arguments.length!==0){if(arguments.length===1){var t=arguments[0];this._label=t}}};Dn.prototype.setVisited=function(t){this._isVisited=t};Dn.prototype.setInResult=function(t){this._isInResult=t};Dn.prototype.isCovered=function(){return this._isCovered};Dn.prototype.isCoveredSet=function(){return this._isCoveredSet};Dn.prototype.setLabel=function(t){this._label=t};Dn.prototype.getLabel=function(){return this._label};Dn.prototype.setCovered=function(t){this._isCovered=t,this._isCoveredSet=!0};Dn.prototype.updateIM=function(t){mt.isTrue(this._label.getGeometryCount()>=2,"found partial label"),this.computeIM(t)};Dn.prototype.isInResult=function(){return this._isInResult};Dn.prototype.isVisited=function(){return this._isVisited};Dn.prototype.interfaces_=function(){return[]};Dn.prototype.getClass=function(){return Dn};var Wh=function(n){function t(){n.call(this),this._coord=null,this._edges=null;var e=arguments[0],r=arguments[1];this._coord=e,this._edges=r,this._label=new Mt(0,j.NONE)}return n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t,t.prototype.isIncidentEdgeInResult=function(){for(var r=this.getEdges().getEdges().iterator();r.hasNext();){var i=r.next();if(i.getEdge().isInResult())return!0}return!1},t.prototype.isIsolated=function(){return this._label.getGeometryCount()===1},t.prototype.getCoordinate=function(){return this._coord},t.prototype.print=function(r){r.println("node "+this._coord+" lbl: "+this._label)},t.prototype.computeIM=function(r){},t.prototype.computeMergedLocation=function(r,i){var s=j.NONE;if(s=this._label.getLocation(i),!r.isNull(i)){var o=r.getLocation(i);s!==j.BOUNDARY&&(s=o)}return s},t.prototype.setLabel=function(){if(arguments.length===2){var r=arguments[0],i=arguments[1];this._label===null?this._label=new Mt(r,i):this._label.setLocation(r,i)}else return n.prototype.setLabel.apply(this,arguments)},t.prototype.getEdges=function(){return this._edges},t.prototype.mergeLabel=function(){var r=this;if(arguments[0]instanceof t){var i=arguments[0];this.mergeLabel(i._label)}else if(arguments[0]instanceof Mt)for(var s=arguments[0],o=0;o<2;o++){var a=r.computeMergedLocation(s,o),l=r._label.getLocation(o);l===j.NONE&&r._label.setLocation(o,a)}},t.prototype.add=function(r){this._edges.insert(r),r.setNode(this)},t.prototype.setLabelBoundary=function(r){if(this._label===null)return null;var i=j.NONE;this._label!==null&&(i=this._label.getLocation(r));var s=null;switch(i){case j.BOUNDARY:s=j.INTERIOR;break;case j.INTERIOR:s=j.BOUNDARY;break;default:s=j.BOUNDARY;break}this._label.setLocation(r,s)},t.prototype.interfaces_=function(){return[]},t.prototype.getClass=function(){return t},t}(Dn),Dr=function(){this.nodeMap=new We,this.nodeFact=null;var t=arguments[0];this.nodeFact=t};Dr.prototype.find=function(t){return this.nodeMap.get(t)};Dr.prototype.addNode=function(){if(arguments[0]instanceof z){var t=arguments[0],e=this.nodeMap.get(t);return e===null&&(e=this.nodeFact.createNode(t),this.nodeMap.put(t,e)),e}else if(arguments[0]instanceof Wh){var r=arguments[0],i=this.nodeMap.get(r.getCoordinate());return i===null?(this.nodeMap.put(r.getCoordinate(),r),r):(i.mergeLabel(r),i)}};Dr.prototype.print=function(t){for(var e=this.iterator();e.hasNext();){var r=e.next();r.print(t)}};Dr.prototype.iterator=function(){return this.nodeMap.values().iterator()};Dr.prototype.values=function(){return this.nodeMap.values()};Dr.prototype.getBoundaryNodes=function(t){for(var e=new et,r=this.iterator();r.hasNext();){var i=r.next();i.getLabel().getLocation(t)===j.BOUNDARY&&e.add(i)}return e};Dr.prototype.add=function(t){var e=t.getCoordinate(),r=this.addNode(e);r.add(t)};Dr.prototype.interfaces_=function(){return[]};Dr.prototype.getClass=function(){return Dr};var Ot=function(){},gc={NE:{configurable:!0},NW:{configurable:!0},SW:{configurable:!0},SE:{configurable:!0}};Ot.prototype.interfaces_=function(){return[]};Ot.prototype.getClass=function(){return Ot};Ot.isNorthern=function(t){return t===Ot.NE||t===Ot.NW};Ot.isOpposite=function(t,e){if(t===e)return!1;var r=(t-e+4)%4;return r===2};Ot.commonHalfPlane=function(t,e){if(t===e)return t;var r=(t-e+4)%4;if(r===2)return-1;var i=t<e?t:e,s=t>e?t:e;return i===0&&s===3?3:i};Ot.isInHalfPlane=function(t,e){return e===Ot.SE?t===Ot.SE||t===Ot.SW:t===e||t===e+1};Ot.quadrant=function(){if(typeof arguments[0]=="number"&&typeof arguments[1]=="number"){var t=arguments[0],e=arguments[1];if(t===0&&e===0)throw new Xt("Cannot compute the quadrant for point ( "+t+", "+e+" )");return t>=0?e>=0?Ot.NE:Ot.SE:e>=0?Ot.NW:Ot.SW}else if(arguments[0]instanceof z&&arguments[1]instanceof z){var r=arguments[0],i=arguments[1];if(i.x===r.x&&i.y===r.y)throw new Xt("Cannot compute the quadrant for two identical points "+r);return i.x>=r.x?i.y>=r.y?Ot.NE:Ot.SE:i.y>=r.y?Ot.NW:Ot.SW}};gc.NE.get=function(){return 0};gc.NW.get=function(){return 1};gc.SW.get=function(){return 2};gc.SE.get=function(){return 3};Object.defineProperties(Ot,gc);var He=function(){if(this._edge=null,this._label=null,this._node=null,this._p0=null,this._p1=null,this._dx=null,this._dy=null,this._quadrant=null,arguments.length===1){var t=arguments[0];this._edge=t}else if(arguments.length===3){var e=arguments[0],r=arguments[1],i=arguments[2],s=null;this._edge=e,this.init(r,i),this._label=s}else if(arguments.length===4){var o=arguments[0],a=arguments[1],l=arguments[2],c=arguments[3];this._edge=o,this.init(a,l),this._label=c}};He.prototype.compareDirection=function(t){return this._dx===t._dx&&this._dy===t._dy?0:this._quadrant>t._quadrant?1:this._quadrant<t._quadrant?-1:rt.computeOrientation(t._p0,t._p1,this._p1)};He.prototype.getDy=function(){return this._dy};He.prototype.getCoordinate=function(){return this._p0};He.prototype.setNode=function(t){this._node=t};He.prototype.print=function(t){var e=Math.atan2(this._dy,this._dx),r=this.getClass().getName(),i=r.lastIndexOf("."),s=r.substring(i+1);t.print("  "+s+": "+this._p0+" - "+this._p1+" "+this._quadrant+":"+e+"   "+this._label)};He.prototype.compareTo=function(t){var e=t;return this.compareDirection(e)};He.prototype.getDirectedCoordinate=function(){return this._p1};He.prototype.getDx=function(){return this._dx};He.prototype.getLabel=function(){return this._label};He.prototype.getEdge=function(){return this._edge};He.prototype.getQuadrant=function(){return this._quadrant};He.prototype.getNode=function(){return this._node};He.prototype.toString=function(){var t=Math.atan2(this._dy,this._dx),e=this.getClass().getName(),r=e.lastIndexOf("."),i=e.substring(r+1);return"  "+i+": "+this._p0+" - "+this._p1+" "+this._quadrant+":"+t+"   "+this._label};He.prototype.computeLabel=function(t){};He.prototype.init=function(t,e){this._p0=t,this._p1=e,this._dx=e.x-t.x,this._dy=e.y-t.y,this._quadrant=Ot.quadrant(this._dx,this._dy),mt.isTrue(!(this._dx===0&&this._dy===0),"EdgeEnd with identical endpoints found")};He.prototype.interfaces_=function(){return[Gn]};He.prototype.getClass=function(){return He};var Hd=function(n){function t(){var e=arguments[0],r=arguments[1];if(n.call(this,e),this._isForward=null,this._isInResult=!1,this._isVisited=!1,this._sym=null,this._next=null,this._nextMin=null,this._edgeRing=null,this._minEdgeRing=null,this._depth=[0,-999,-999],this._isForward=r,r)this.init(e.getCoordinate(0),e.getCoordinate(1));else{var i=e.getNumPoints()-1;this.init(e.getCoordinate(i),e.getCoordinate(i-1))}this.computeDirectedLabel()}return n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t,t.prototype.getNextMin=function(){return this._nextMin},t.prototype.getDepth=function(r){return this._depth[r]},t.prototype.setVisited=function(r){this._isVisited=r},t.prototype.computeDirectedLabel=function(){this._label=new Mt(this._edge.getLabel()),this._isForward||this._label.flip()},t.prototype.getNext=function(){return this._next},t.prototype.setDepth=function(r,i){if(this._depth[r]!==-999&&this._depth[r]!==i)throw new Ai("assigned depths do not match",this.getCoordinate());this._depth[r]=i},t.prototype.isInteriorAreaEdge=function(){for(var r=this,i=!0,s=0;s<2;s++)r._label.isArea(s)&&r._label.getLocation(s,Q.LEFT)===j.INTERIOR&&r._label.getLocation(s,Q.RIGHT)===j.INTERIOR||(i=!1);return i},t.prototype.setNextMin=function(r){this._nextMin=r},t.prototype.print=function(r){n.prototype.print.call(this,r),r.print(" "+this._depth[Q.LEFT]+"/"+this._depth[Q.RIGHT]),r.print(" ("+this.getDepthDelta()+")"),this._isInResult&&r.print(" inResult")},t.prototype.setMinEdgeRing=function(r){this._minEdgeRing=r},t.prototype.isLineEdge=function(){var r=this._label.isLine(0)||this._label.isLine(1),i=!this._label.isArea(0)||this._label.allPositionsEqual(0,j.EXTERIOR),s=!this._label.isArea(1)||this._label.allPositionsEqual(1,j.EXTERIOR);return r&&i&&s},t.prototype.setEdgeRing=function(r){this._edgeRing=r},t.prototype.getMinEdgeRing=function(){return this._minEdgeRing},t.prototype.getDepthDelta=function(){var r=this._edge.getDepthDelta();return this._isForward||(r=-r),r},t.prototype.setInResult=function(r){this._isInResult=r},t.prototype.getSym=function(){return this._sym},t.prototype.isForward=function(){return this._isForward},t.prototype.getEdge=function(){return this._edge},t.prototype.printEdge=function(r){this.print(r),r.print(" "),this._isForward?this._edge.print(r):this._edge.printReverse(r)},t.prototype.setSym=function(r){this._sym=r},t.prototype.setVisitedEdge=function(r){this.setVisited(r),this._sym.setVisited(r)},t.prototype.setEdgeDepths=function(r,i){var s=this.getEdge().getDepthDelta();this._isForward||(s=-s);var o=1;r===Q.LEFT&&(o=-1);var a=Q.opposite(r),l=s*o,c=i+l;this.setDepth(r,i),this.setDepth(a,c)},t.prototype.getEdgeRing=function(){return this._edgeRing},t.prototype.isInResult=function(){return this._isInResult},t.prototype.setNext=function(r){this._next=r},t.prototype.isVisited=function(){return this._isVisited},t.prototype.interfaces_=function(){return[]},t.prototype.getClass=function(){return t},t.depthFactor=function(r,i){return r===j.EXTERIOR&&i===j.INTERIOR?1:r===j.INTERIOR&&i===j.EXTERIOR?-1:0},t}(He),Ta=function(){};Ta.prototype.createNode=function(t){return new Wh(t,null)};Ta.prototype.interfaces_=function(){return[]};Ta.prototype.getClass=function(){return Ta};var Kt=function(){if(this._edges=new et,this._nodes=null,this._edgeEndList=new et,arguments.length===0)this._nodes=new Dr(new Ta);else if(arguments.length===1){var t=arguments[0];this._nodes=new Dr(t)}};Kt.prototype.printEdges=function(t){var e=this;t.println("Edges:");for(var r=0;r<this._edges.size();r++){t.println("edge "+r+":");var i=e._edges.get(r);i.print(t),i.eiList.print(t)}};Kt.prototype.find=function(t){return this._nodes.find(t)};Kt.prototype.addNode=function(){if(arguments[0]instanceof Wh){var t=arguments[0];return this._nodes.addNode(t)}else if(arguments[0]instanceof z){var e=arguments[0];return this._nodes.addNode(e)}};Kt.prototype.getNodeIterator=function(){return this._nodes.iterator()};Kt.prototype.linkResultDirectedEdges=function(){for(var t=this._nodes.iterator();t.hasNext();){var e=t.next();e.getEdges().linkResultDirectedEdges()}};Kt.prototype.debugPrintln=function(t){De.out.println(t)};Kt.prototype.isBoundaryNode=function(t,e){var r=this._nodes.find(e);if(r===null)return!1;var i=r.getLabel();return i!==null&&i.getLocation(t)===j.BOUNDARY};Kt.prototype.linkAllDirectedEdges=function(){for(var t=this._nodes.iterator();t.hasNext();){var e=t.next();e.getEdges().linkAllDirectedEdges()}};Kt.prototype.matchInSameDirection=function(t,e,r,i){return t.equals(r)?rt.computeOrientation(t,e,i)===rt.COLLINEAR&&Ot.quadrant(t,e)===Ot.quadrant(r,i):!1};Kt.prototype.getEdgeEnds=function(){return this._edgeEndList};Kt.prototype.debugPrint=function(t){De.out.print(t)};Kt.prototype.getEdgeIterator=function(){return this._edges.iterator()};Kt.prototype.findEdgeInSameDirection=function(t,e){for(var r=this,i=0;i<this._edges.size();i++){var s=r._edges.get(i),o=s.getCoordinates();if(r.matchInSameDirection(t,e,o[0],o[1])||r.matchInSameDirection(t,e,o[o.length-1],o[o.length-2]))return s}return null};Kt.prototype.insertEdge=function(t){this._edges.add(t)};Kt.prototype.findEdgeEnd=function(t){for(var e=this.getEdgeEnds().iterator();e.hasNext();){var r=e.next();if(r.getEdge()===t)return r}return null};Kt.prototype.addEdges=function(t){for(var e=this,r=t.iterator();r.hasNext();){var i=r.next();e._edges.add(i);var s=new Hd(i,!0),o=new Hd(i,!1);s.setSym(o),o.setSym(s),e.add(s),e.add(o)}};Kt.prototype.add=function(t){this._nodes.add(t),this._edgeEndList.add(t)};Kt.prototype.getNodes=function(){return this._nodes.values()};Kt.prototype.findEdge=function(t,e){for(var r=this,i=0;i<this._edges.size();i++){var s=r._edges.get(i),o=s.getCoordinates();if(t.equals(o[0])&&e.equals(o[1]))return s}return null};Kt.prototype.interfaces_=function(){return[]};Kt.prototype.getClass=function(){return Kt};Kt.linkResultDirectedEdges=function(t){for(var e=t.iterator();e.hasNext();){var r=e.next();r.getEdges().linkResultDirectedEdges()}};var xn=function(){this._geometryFactory=null,this._shellList=new et;var t=arguments[0];this._geometryFactory=t};xn.prototype.sortShellsAndHoles=function(t,e,r){for(var i=t.iterator();i.hasNext();){var s=i.next();s.isHole()?r.add(s):e.add(s)}};xn.prototype.computePolygons=function(t){for(var e=this,r=new et,i=t.iterator();i.hasNext();){var s=i.next(),o=s.toPolygon(e._geometryFactory);r.add(o)}return r};xn.prototype.placeFreeHoles=function(t,e){for(var r=this,i=e.iterator();i.hasNext();){var s=i.next();if(s.getShell()===null){var o=r.findEdgeRingContaining(s,t);if(o===null)throw new Ai("unable to assign hole to a shell",s.getCoordinate(0));s.setShell(o)}}};xn.prototype.buildMinimalEdgeRings=function(t,e,r){for(var i=this,s=new et,o=t.iterator();o.hasNext();){var a=o.next();if(a.getMaxNodeDegree()>2){a.linkDirectedEdgesForMinimalEdgeRings();var l=a.buildMinimalRings(),c=i.findShell(l);c!==null?(i.placePolygonHoles(c,l),e.add(c)):r.addAll(l)}else s.add(a)}return s};xn.prototype.containsPoint=function(t){for(var e=this._shellList.iterator();e.hasNext();){var r=e.next();if(r.containsPoint(t))return!0}return!1};xn.prototype.buildMaximalEdgeRings=function(t){for(var e=this,r=new et,i=t.iterator();i.hasNext();){var s=i.next();if(s.isInResult()&&s.getLabel().isArea()&&s.getEdgeRing()===null){var o=new dk(s,e._geometryFactory);r.add(o),o.setInResult()}}return r};xn.prototype.placePolygonHoles=function(t,e){for(var r=e.iterator();r.hasNext();){var i=r.next();i.isHole()&&i.setShell(t)}};xn.prototype.getPolygons=function(){var t=this.computePolygons(this._shellList);return t};xn.prototype.findEdgeRingContaining=function(t,e){for(var r=t.getLinearRing(),i=r.getEnvelopeInternal(),s=r.getCoordinateN(0),o=null,a=null,l=e.iterator();l.hasNext();){var c=l.next(),u=c.getLinearRing(),h=u.getEnvelopeInternal();o!==null&&(a=o.getLinearRing().getEnvelopeInternal());var f=!1;h.contains(i)&&rt.isPointInRing(s,u.getCoordinates())&&(f=!0),f&&(o===null||a.contains(h))&&(o=c)}return o};xn.prototype.findShell=function(t){for(var e=0,r=null,i=t.iterator();i.hasNext();){var s=i.next();s.isHole()||(r=s,e++)}return mt.isTrue(e<=1,"found two shells in MinimalEdgeRing list"),r};xn.prototype.add=function(){if(arguments.length===1){var t=arguments[0];this.add(t.getEdgeEnds(),t.getNodes())}else if(arguments.length===2){var e=arguments[0],r=arguments[1];Kt.linkResultDirectedEdges(r);var i=this.buildMaximalEdgeRings(e),s=new et,o=this.buildMinimalEdgeRings(i,this._shellList,s);this.sortShellsAndHoles(o,this._shellList,s),this.placeFreeHoles(this._shellList,s)}};xn.prototype.interfaces_=function(){return[]};xn.prototype.getClass=function(){return xn};var Pa=function(){};Pa.prototype.getBounds=function(){};Pa.prototype.interfaces_=function(){return[]};Pa.prototype.getClass=function(){return Pa};var rr=function(){this._bounds=null,this._item=null;var t=arguments[0],e=arguments[1];this._bounds=t,this._item=e};rr.prototype.getItem=function(){return this._item};rr.prototype.getBounds=function(){return this._bounds};rr.prototype.interfaces_=function(){return[Pa,Yn]};rr.prototype.getClass=function(){return rr};var Mi=function(){this._size=null,this._items=null,this._size=0,this._items=new et,this._items.add(null)};Mi.prototype.poll=function(){if(this.isEmpty())return null;var t=this._items.get(1);return this._items.set(1,this._items.get(this._size)),this._size-=1,this.reorder(1),t};Mi.prototype.size=function(){return this._size};Mi.prototype.reorder=function(t){for(var e=this,r=null,i=this._items.get(t);t*2<=this._size&&(r=t*2,r!==e._size&&e._items.get(r+1).compareTo(e._items.get(r))<0&&r++,e._items.get(r).compareTo(i)<0);t=r)e._items.set(t,e._items.get(r));this._items.set(t,i)};Mi.prototype.clear=function(){this._size=0,this._items.clear()};Mi.prototype.isEmpty=function(){return this._size===0};Mi.prototype.add=function(t){var e=this;this._items.add(null),this._size+=1;var r=this._size;for(this._items.set(0,t);t.compareTo(this._items.get(Math.trunc(r/2)))<0;r/=2)e._items.set(r,e._items.get(Math.trunc(r/2)));this._items.set(r,t)};Mi.prototype.interfaces_=function(){return[]};Mi.prototype.getClass=function(){return Mi};var Ki=function(){};Ki.prototype.visitItem=function(t){};Ki.prototype.interfaces_=function(){return[]};Ki.prototype.getClass=function(){return Ki};var go=function(){};go.prototype.insert=function(t,e){};go.prototype.remove=function(t,e){};go.prototype.query=function(){};go.prototype.interfaces_=function(){return[]};go.prototype.getClass=function(){return go};var pe=function(){if(this._childBoundables=new et,this._bounds=null,this._level=null,arguments.length!==0){if(arguments.length===1){var t=arguments[0];this._level=t}}},rE={serialVersionUID:{configurable:!0}};pe.prototype.getLevel=function(){return this._level};pe.prototype.size=function(){return this._childBoundables.size()};pe.prototype.getChildBoundables=function(){return this._childBoundables};pe.prototype.addChildBoundable=function(t){mt.isTrue(this._bounds===null),this._childBoundables.add(t)};pe.prototype.isEmpty=function(){return this._childBoundables.isEmpty()};pe.prototype.getBounds=function(){return this._bounds===null&&(this._bounds=this.computeBounds()),this._bounds};pe.prototype.interfaces_=function(){return[Pa,Yn]};pe.prototype.getClass=function(){return pe};rE.serialVersionUID.get=function(){return 6493722185909574e3};Object.defineProperties(pe,rE);var ir=function(){};ir.reverseOrder=function(){return{compare:function(e,r){return r.compareTo(e)}}};ir.min=function(t){return ir.sort(t),t.get(0)};ir.sort=function(t,e){var r=t.toArray();e?Cs.sort(r,e):Cs.sort(r);for(var i=t.iterator(),s=0,o=r.length;s<o;s++)i.next(),i.set(r[s])};ir.singletonList=function(t){var e=new et;return e.add(t),e};var oe=function(){this._boundable1=null,this._boundable2=null,this._distance=null,this._itemDistance=null;var t=arguments[0],e=arguments[1],r=arguments[2];this._boundable1=t,this._boundable2=e,this._itemDistance=r,this._distance=this.distance()};oe.prototype.expandToQueue=function(t,e){var r=oe.isComposite(this._boundable1),i=oe.isComposite(this._boundable2);if(r&&i)return oe.area(this._boundable1)>oe.area(this._boundable2)?(this.expand(this._boundable1,this._boundable2,t,e),null):(this.expand(this._boundable2,this._boundable1,t,e),null);if(r)return this.expand(this._boundable1,this._boundable2,t,e),null;if(i)return this.expand(this._boundable2,this._boundable1,t,e),null;throw new Xt("neither boundable is composite")};oe.prototype.isLeaves=function(){return!(oe.isComposite(this._boundable1)||oe.isComposite(this._boundable2))};oe.prototype.compareTo=function(t){var e=t;return this._distance<e._distance?-1:this._distance>e._distance?1:0};oe.prototype.expand=function(t,e,r,i){for(var s=this,o=t.getChildBoundables(),a=o.iterator();a.hasNext();){var l=a.next(),c=new oe(l,e,s._itemDistance);c.getDistance()<i&&r.add(c)}};oe.prototype.getBoundable=function(t){return t===0?this._boundable1:this._boundable2};oe.prototype.getDistance=function(){return this._distance};oe.prototype.distance=function(){return this.isLeaves()?this._itemDistance.distance(this._boundable1,this._boundable2):this._boundable1.getBounds().distance(this._boundable2.getBounds())};oe.prototype.interfaces_=function(){return[Gn]};oe.prototype.getClass=function(){return oe};oe.area=function(t){return t.getBounds().getArea()};oe.isComposite=function(t){return t instanceof pe};var be=function n(){if(this._root=null,this._built=!1,this._itemBoundables=new et,this._nodeCapacity=null,arguments.length===0){var t=n.DEFAULT_NODE_CAPACITY;this._nodeCapacity=t}else if(arguments.length===1){var e=arguments[0];mt.isTrue(e>1,"Node capacity must be greater than 1"),this._nodeCapacity=e}},Hh={IntersectsOp:{configurable:!0},serialVersionUID:{configurable:!0},DEFAULT_NODE_CAPACITY:{configurable:!0}};be.prototype.getNodeCapacity=function(){return this._nodeCapacity};be.prototype.lastNode=function(t){return t.get(t.size()-1)};be.prototype.size=function(){var t=this;if(arguments.length===0)return this.isEmpty()?0:(this.build(),this.size(this._root));if(arguments.length===1){for(var e=arguments[0],r=0,i=e.getChildBoundables().iterator();i.hasNext();){var s=i.next();s instanceof pe?r+=t.size(s):s instanceof rr&&(r+=1)}return r}};be.prototype.removeItem=function(t,e){for(var r=null,i=t.getChildBoundables().iterator();i.hasNext();){var s=i.next();s instanceof rr&&s.getItem()===e&&(r=s)}return r!==null?(t.getChildBoundables().remove(r),!0):!1};be.prototype.itemsTree=function(){var t=this;if(arguments.length===0){this.build();var e=this.itemsTree(this._root);return e===null?new et:e}else if(arguments.length===1){for(var r=arguments[0],i=new et,s=r.getChildBoundables().iterator();s.hasNext();){var o=s.next();if(o instanceof pe){var a=t.itemsTree(o);a!==null&&i.add(a)}else o instanceof rr?i.add(o.getItem()):mt.shouldNeverReachHere()}return i.size()<=0?null:i}};be.prototype.insert=function(t,e){mt.isTrue(!this._built,"Cannot insert items into an STR packed R-tree after it has been built."),this._itemBoundables.add(new rr(t,e))};be.prototype.boundablesAtLevel=function(){var t=this;if(arguments.length===1){var e=arguments[0],r=new et;return this.boundablesAtLevel(e,this._root,r),r}else if(arguments.length===3){var i=arguments[0],s=arguments[1],o=arguments[2];if(mt.isTrue(i>-2),s.getLevel()===i)return o.add(s),null;for(var a=s.getChildBoundables().iterator();a.hasNext();){var l=a.next();l instanceof pe?t.boundablesAtLevel(i,l,o):(mt.isTrue(l instanceof rr),i===-1&&o.add(l))}return null}};be.prototype.query=function(){var t=this;if(arguments.length===1){var e=arguments[0];this.build();var r=new et;return this.isEmpty()||this.getIntersectsOp().intersects(this._root.getBounds(),e)&&this.query(e,this._root,r),r}else if(arguments.length===2){var i=arguments[0],s=arguments[1];if(this.build(),this.isEmpty())return null;this.getIntersectsOp().intersects(this._root.getBounds(),i)&&this.query(i,this._root,s)}else if(arguments.length===3){if(ct(arguments[2],Ki)&&arguments[0]instanceof Object&&arguments[1]instanceof pe)for(var o=arguments[0],a=arguments[1],l=arguments[2],c=a.getChildBoundables(),u=0;u<c.size();u++){var h=c.get(u);t.getIntersectsOp().intersects(h.getBounds(),o)&&(h instanceof pe?t.query(o,h,l):h instanceof rr?l.visitItem(h.getItem()):mt.shouldNeverReachHere())}else if(ct(arguments[2],tr)&&arguments[0]instanceof Object&&arguments[1]instanceof pe)for(var f=arguments[0],d=arguments[1],p=arguments[2],_=d.getChildBoundables(),v=0;v<_.size();v++){var E=_.get(v);t.getIntersectsOp().intersects(E.getBounds(),f)&&(E instanceof pe?t.query(f,E,p):E instanceof rr?p.add(E.getItem()):mt.shouldNeverReachHere())}}};be.prototype.build=function(){if(this._built)return null;this._root=this._itemBoundables.isEmpty()?this.createNode(0):this.createHigherLevels(this._itemBoundables,-1),this._itemBoundables=null,this._built=!0};be.prototype.getRoot=function(){return this.build(),this._root};be.prototype.remove=function(){var t=this;if(arguments.length===2){var e=arguments[0],r=arguments[1];return this.build(),this.getIntersectsOp().intersects(this._root.getBounds(),e)?this.remove(e,this._root,r):!1}else if(arguments.length===3){var i=arguments[0],s=arguments[1],o=arguments[2],a=this.removeItem(s,o);if(a)return!0;for(var l=null,c=s.getChildBoundables().iterator();c.hasNext();){var u=c.next();if(t.getIntersectsOp().intersects(u.getBounds(),i)&&u instanceof pe&&(a=t.remove(i,u,o),a)){l=u;break}}return l!==null&&l.getChildBoundables().isEmpty()&&s.getChildBoundables().remove(l),a}};be.prototype.createHigherLevels=function(t,e){mt.isTrue(!t.isEmpty());var r=this.createParentBoundables(t,e+1);return r.size()===1?r.get(0):this.createHigherLevels(r,e+1)};be.prototype.depth=function(){var t=this;if(arguments.length===0)return this.isEmpty()?0:(this.build(),this.depth(this._root));if(arguments.length===1){for(var e=arguments[0],r=0,i=e.getChildBoundables().iterator();i.hasNext();){var s=i.next();if(s instanceof pe){var o=t.depth(s);o>r&&(r=o)}}return r+1}};be.prototype.createParentBoundables=function(t,e){var r=this;mt.isTrue(!t.isEmpty());var i=new et;i.add(this.createNode(e));var s=new et(t);ir.sort(s,this.getComparator());for(var o=s.iterator();o.hasNext();){var a=o.next();r.lastNode(i).getChildBoundables().size()===r.getNodeCapacity()&&i.add(r.createNode(e)),r.lastNode(i).addChildBoundable(a)}return i};be.prototype.isEmpty=function(){return this._built?this._root.isEmpty():this._itemBoundables.isEmpty()};be.prototype.interfaces_=function(){return[Yn]};be.prototype.getClass=function(){return be};be.compareDoubles=function(t,e){return t>e?1:t<e?-1:0};Hh.IntersectsOp.get=function(){return pk};Hh.serialVersionUID.get=function(){return-3886435814360241e3};Hh.DEFAULT_NODE_CAPACITY.get=function(){return 10};Object.defineProperties(be,Hh);var pk=function(){},Ia=function(){};Ia.prototype.distance=function(t,e){};Ia.prototype.interfaces_=function(){return[]};Ia.prototype.getClass=function(){return Ia};var iE=function(n){function t(r){r=r||t.DEFAULT_NODE_CAPACITY,n.call(this,r)}n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t;var e={STRtreeNode:{configurable:!0},serialVersionUID:{configurable:!0},xComparator:{configurable:!0},yComparator:{configurable:!0},intersectsOp:{configurable:!0},DEFAULT_NODE_CAPACITY:{configurable:!0}};return t.prototype.createParentBoundablesFromVerticalSlices=function(i,s){var o=this;mt.isTrue(i.length>0);for(var a=new et,l=0;l<i.length;l++)a.addAll(o.createParentBoundablesFromVerticalSlice(i[l],s));return a},t.prototype.createNode=function(i){return new Py(i)},t.prototype.size=function(){return arguments.length===0?n.prototype.size.call(this):n.prototype.size.apply(this,arguments)},t.prototype.insert=function(){if(arguments.length===2){var i=arguments[0],s=arguments[1];if(i.isNull())return null;n.prototype.insert.call(this,i,s)}else return n.prototype.insert.apply(this,arguments)},t.prototype.getIntersectsOp=function(){return t.intersectsOp},t.prototype.verticalSlices=function(i,s){for(var o=Math.trunc(Math.ceil(i.size()/s)),a=new Array(s).fill(null),l=i.iterator(),c=0;c<s;c++){a[c]=new et;for(var u=0;l.hasNext()&&u<o;){var h=l.next();a[c].add(h),u++}}return a},t.prototype.query=function(){if(arguments.length===1){var i=arguments[0];return n.prototype.query.call(this,i)}else if(arguments.length===2){var s=arguments[0],o=arguments[1];n.prototype.query.call(this,s,o)}else if(arguments.length===3){if(ct(arguments[2],Ki)&&arguments[0]instanceof Object&&arguments[1]instanceof pe){var a=arguments[0],l=arguments[1],c=arguments[2];n.prototype.query.call(this,a,l,c)}else if(ct(arguments[2],tr)&&arguments[0]instanceof Object&&arguments[1]instanceof pe){var u=arguments[0],h=arguments[1],f=arguments[2];n.prototype.query.call(this,u,h,f)}}},t.prototype.getComparator=function(){return t.yComparator},t.prototype.createParentBoundablesFromVerticalSlice=function(i,s){return n.prototype.createParentBoundables.call(this,i,s)},t.prototype.remove=function(){if(arguments.length===2){var i=arguments[0],s=arguments[1];return n.prototype.remove.call(this,i,s)}else return n.prototype.remove.apply(this,arguments)},t.prototype.depth=function(){return arguments.length===0?n.prototype.depth.call(this):n.prototype.depth.apply(this,arguments)},t.prototype.createParentBoundables=function(i,s){mt.isTrue(!i.isEmpty());var o=Math.trunc(Math.ceil(i.size()/this.getNodeCapacity())),a=new et(i);ir.sort(a,t.xComparator);var l=this.verticalSlices(a,Math.trunc(Math.ceil(Math.sqrt(o))));return this.createParentBoundablesFromVerticalSlices(l,s)},t.prototype.nearestNeighbour=function(){if(arguments.length===1){if(ct(arguments[0],Ia)){var i=arguments[0],s=new oe(this.getRoot(),this.getRoot(),i);return this.nearestNeighbour(s)}else if(arguments[0]instanceof oe){var o=arguments[0];return this.nearestNeighbour(o,dt.POSITIVE_INFINITY)}}else if(arguments.length===2){if(arguments[0]instanceof t&&ct(arguments[1],Ia)){var a=arguments[0],l=arguments[1],c=new oe(this.getRoot(),a.getRoot(),l);return this.nearestNeighbour(c)}else if(arguments[0]instanceof oe&&typeof arguments[1]=="number"){var u=arguments[0],h=arguments[1],f=h,d=null,p=new Mi;for(p.add(u);!p.isEmpty()&&f>0;){var _=p.poll(),v=_.getDistance();if(v>=f)break;_.isLeaves()?(f=v,d=_):_.expandToQueue(p,f)}return[d.getBoundable(0).getItem(),d.getBoundable(1).getItem()]}}else if(arguments.length===3){var E=arguments[0],m=arguments[1],g=arguments[2],y=new rr(E,m),b=new oe(this.getRoot(),y,g);return this.nearestNeighbour(b)[0]}},t.prototype.interfaces_=function(){return[go,Yn]},t.prototype.getClass=function(){return t},t.centreX=function(i){return t.avg(i.getMinX(),i.getMaxX())},t.avg=function(i,s){return(i+s)/2},t.centreY=function(i){return t.avg(i.getMinY(),i.getMaxY())},e.STRtreeNode.get=function(){return Py},e.serialVersionUID.get=function(){return 0x39920f7d5f261e0},e.xComparator.get=function(){return{interfaces_:function(){return[ya]},compare:function(r,i){return n.compareDoubles(t.centreX(r.getBounds()),t.centreX(i.getBounds()))}}},e.yComparator.get=function(){return{interfaces_:function(){return[ya]},compare:function(r,i){return n.compareDoubles(t.centreY(r.getBounds()),t.centreY(i.getBounds()))}}},e.intersectsOp.get=function(){return{interfaces_:function(){return[n.IntersectsOp]},intersects:function(r,i){return r.intersects(i)}}},e.DEFAULT_NODE_CAPACITY.get=function(){return 10},Object.defineProperties(t,e),t}(be),Py=function(n){function t(){var e=arguments[0];n.call(this,e)}return n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t,t.prototype.computeBounds=function(){for(var r=null,i=this.getChildBoundables().iterator();i.hasNext();){var s=i.next();r===null?r=new st(s.getBounds()):r.expandToInclude(s.getBounds())}return r},t.prototype.interfaces_=function(){return[]},t.prototype.getClass=function(){return t},t}(pe),rn=function(){};rn.prototype.interfaces_=function(){return[]};rn.prototype.getClass=function(){return rn};rn.relativeSign=function(t,e){return t<e?-1:t>e?1:0};rn.compare=function(t,e,r){if(e.equals2D(r))return 0;var i=rn.relativeSign(e.x,r.x),s=rn.relativeSign(e.y,r.y);switch(t){case 0:return rn.compareValue(i,s);case 1:return rn.compareValue(s,i);case 2:return rn.compareValue(s,-i);case 3:return rn.compareValue(-i,s);case 4:return rn.compareValue(-i,-s);case 5:return rn.compareValue(-s,-i);case 6:return rn.compareValue(-s,i);case 7:return rn.compareValue(i,-s)}return mt.shouldNeverReachHere("invalid octant value"),0};rn.compareValue=function(t,e){return t<0?-1:t>0?1:e<0?-1:e>0?1:0};var Zi=function(){this._segString=null,this.coord=null,this.segmentIndex=null,this._segmentOctant=null,this._isInterior=null;var t=arguments[0],e=arguments[1],r=arguments[2],i=arguments[3];this._segString=t,this.coord=new z(e),this.segmentIndex=r,this._segmentOctant=i,this._isInterior=!e.equals2D(t.getCoordinate(r))};Zi.prototype.getCoordinate=function(){return this.coord};Zi.prototype.print=function(t){t.print(this.coord),t.print(" seg # = "+this.segmentIndex)};Zi.prototype.compareTo=function(t){var e=t;return this.segmentIndex<e.segmentIndex?-1:this.segmentIndex>e.segmentIndex?1:this.coord.equals2D(e.coord)?0:rn.compare(this._segmentOctant,this.coord,e.coord)};Zi.prototype.isEndPoint=function(t){return this.segmentIndex===0&&!this._isInterior||this.segmentIndex===t};Zi.prototype.isInterior=function(){return this._isInterior};Zi.prototype.interfaces_=function(){return[Gn]};Zi.prototype.getClass=function(){return Zi};var tn=function(){this._nodeMap=new We,this._edge=null;var t=arguments[0];this._edge=t};tn.prototype.getSplitCoordinates=function(){var t=this,e=new dc;this.addEndpoints();for(var r=this.iterator(),i=r.next();r.hasNext();){var s=r.next();t.addEdgeCoordinates(i,s,e),i=s}return e.toCoordinateArray()};tn.prototype.addCollapsedNodes=function(){var t=this,e=new et;this.findCollapsesFromInsertedNodes(e),this.findCollapsesFromExistingVertices(e);for(var r=e.iterator();r.hasNext();){var i=r.next().intValue();t.add(t._edge.getCoordinate(i),i)}};tn.prototype.print=function(t){t.println("Intersections:");for(var e=this.iterator();e.hasNext();){var r=e.next();r.print(t)}};tn.prototype.findCollapsesFromExistingVertices=function(t){for(var e=this,r=0;r<this._edge.size()-2;r++){var i=e._edge.getCoordinate(r),s=e._edge.getCoordinate(r+2);i.equals2D(s)&&t.add(new Ar(r+1))}};tn.prototype.addEdgeCoordinates=function(t,e,r){var i=this,s=this._edge.getCoordinate(e.segmentIndex),o=e.isInterior()||!e.coord.equals2D(s);r.add(new z(t.coord),!1);for(var a=t.segmentIndex+1;a<=e.segmentIndex;a++)r.add(i._edge.getCoordinate(a));o&&r.add(new z(e.coord))};tn.prototype.iterator=function(){return this._nodeMap.values().iterator()};tn.prototype.addSplitEdges=function(t){var e=this;this.addEndpoints(),this.addCollapsedNodes();for(var r=this.iterator(),i=r.next();r.hasNext();){var s=r.next(),o=e.createSplitEdge(i,s);t.add(o),i=s}};tn.prototype.findCollapseIndex=function(t,e,r){if(!t.coord.equals2D(e.coord))return!1;var i=e.segmentIndex-t.segmentIndex;return e.isInterior()||i--,i===1?(r[0]=t.segmentIndex+1,!0):!1};tn.prototype.findCollapsesFromInsertedNodes=function(t){for(var e=this,r=new Array(1).fill(null),i=this.iterator(),s=i.next();i.hasNext();){var o=i.next(),a=e.findCollapseIndex(s,o,r);a&&t.add(new Ar(r[0])),s=o}};tn.prototype.getEdge=function(){return this._edge};tn.prototype.addEndpoints=function(){var t=this._edge.size()-1;this.add(this._edge.getCoordinate(0),0),this.add(this._edge.getCoordinate(t),t)};tn.prototype.createSplitEdge=function(t,e){var r=this,i=e.segmentIndex-t.segmentIndex+2,s=this._edge.getCoordinate(e.segmentIndex),o=e.isInterior()||!e.coord.equals2D(s);o||i--;var a=new Array(i).fill(null),l=0;a[l++]=new z(t.coord);for(var c=t.segmentIndex+1;c<=e.segmentIndex;c++)a[l++]=r._edge.getCoordinate(c);return o&&(a[l]=new z(e.coord)),new ie(a,this._edge.getData())};tn.prototype.add=function(t,e){var r=new Zi(this._edge,t,e,this._edge.getSegmentOctant(e)),i=this._nodeMap.get(r);return i!==null?(mt.isTrue(i.coord.equals2D(t),"Found equal nodes with different coordinates"),i):(this._nodeMap.put(r,r),r)};tn.prototype.checkSplitEdgesCorrectness=function(t){var e=this._edge.getCoordinates(),r=t.get(0),i=r.getCoordinate(0);if(!i.equals2D(e[0]))throw new Pi("bad split edge start point at "+i);var s=t.get(t.size()-1),o=s.getCoordinates(),a=o[o.length-1];if(!a.equals2D(e[e.length-1]))throw new Pi("bad split edge end point at "+a)};tn.prototype.interfaces_=function(){return[]};tn.prototype.getClass=function(){return tn};var mo=function(){};mo.prototype.interfaces_=function(){return[]};mo.prototype.getClass=function(){return mo};mo.octant=function(){if(typeof arguments[0]=="number"&&typeof arguments[1]=="number"){var t=arguments[0],e=arguments[1];if(t===0&&e===0)throw new Xt("Cannot compute the octant for point ( "+t+", "+e+" )");var r=Math.abs(t),i=Math.abs(e);return t>=0?e>=0?r>=i?0:1:r>=i?7:6:e>=0?r>=i?3:2:r>=i?4:5}else if(arguments[0]instanceof z&&arguments[1]instanceof z){var s=arguments[0],o=arguments[1],a=o.x-s.x,l=o.y-s.y;if(a===0&&l===0)throw new Xt("Cannot compute the octant for two identical points "+s);return mo.octant(a,l)}};var ni=function(){};ni.prototype.getCoordinates=function(){};ni.prototype.size=function(){};ni.prototype.getCoordinate=function(t){};ni.prototype.isClosed=function(){};ni.prototype.setData=function(t){};ni.prototype.getData=function(){};ni.prototype.interfaces_=function(){return[]};ni.prototype.getClass=function(){return ni};var zl=function(){};zl.prototype.addIntersection=function(t,e){};zl.prototype.interfaces_=function(){return[ni]};zl.prototype.getClass=function(){return zl};var ie=function(){this._nodeList=new tn(this),this._pts=null,this._data=null;var t=arguments[0],e=arguments[1];this._pts=t,this._data=e};ie.prototype.getCoordinates=function(){return this._pts};ie.prototype.size=function(){return this._pts.length};ie.prototype.getCoordinate=function(t){return this._pts[t]};ie.prototype.isClosed=function(){return this._pts[0].equals(this._pts[this._pts.length-1])};ie.prototype.getSegmentOctant=function(t){return t===this._pts.length-1?-1:this.safeOctant(this.getCoordinate(t),this.getCoordinate(t+1))};ie.prototype.setData=function(t){this._data=t};ie.prototype.safeOctant=function(t,e){return t.equals2D(e)?0:mo.octant(t,e)};ie.prototype.getData=function(){return this._data};ie.prototype.addIntersection=function(){if(arguments.length===2){var t=arguments[0],e=arguments[1];this.addIntersectionNode(t,e)}else if(arguments.length===4){var r=arguments[0],i=arguments[1],s=arguments[3],o=new z(r.getIntersection(s));this.addIntersection(o,i)}};ie.prototype.toString=function(){return er.toLineString(new ee(this._pts))};ie.prototype.getNodeList=function(){return this._nodeList};ie.prototype.addIntersectionNode=function(t,e){var r=e,i=r+1;if(i<this._pts.length){var s=this._pts[i];t.equals2D(s)&&(r=i)}var o=this._nodeList.add(t,r);return o};ie.prototype.addIntersections=function(t,e,r){for(var i=this,s=0;s<t.getIntersectionNum();s++)i.addIntersection(t,e,r,s)};ie.prototype.interfaces_=function(){return[zl]};ie.prototype.getClass=function(){return ie};ie.getNodedSubstrings=function(){if(arguments.length===1){var t=arguments[0],e=new et;return ie.getNodedSubstrings(t,e),e}else if(arguments.length===2)for(var r=arguments[0],i=arguments[1],s=r.iterator();s.hasNext();){var o=s.next();o.getNodeList().addSplitEdges(i)}};var ot=function(){if(this.p0=null,this.p1=null,arguments.length===0)this.p0=new z,this.p1=new z;else if(arguments.length===1){var t=arguments[0];this.p0=new z(t.p0),this.p1=new z(t.p1)}else if(arguments.length===2)this.p0=arguments[0],this.p1=arguments[1];else if(arguments.length===4){var e=arguments[0],r=arguments[1],i=arguments[2],s=arguments[3];this.p0=new z(e,r),this.p1=new z(i,s)}},sE={serialVersionUID:{configurable:!0}};ot.prototype.minX=function(){return Math.min(this.p0.x,this.p1.x)};ot.prototype.orientationIndex=function(){if(arguments[0]instanceof ot){var t=arguments[0],e=rt.orientationIndex(this.p0,this.p1,t.p0),r=rt.orientationIndex(this.p0,this.p1,t.p1);return e>=0&&r>=0||e<=0&&r<=0?Math.max(e,r):0}else if(arguments[0]instanceof z){var i=arguments[0];return rt.orientationIndex(this.p0,this.p1,i)}};ot.prototype.toGeometry=function(t){return t.createLineString([this.p0,this.p1])};ot.prototype.isVertical=function(){return this.p0.x===this.p1.x};ot.prototype.equals=function(t){if(!(t instanceof ot))return!1;var e=t;return this.p0.equals(e.p0)&&this.p1.equals(e.p1)};ot.prototype.intersection=function(t){var e=new Hs;return e.computeIntersection(this.p0,this.p1,t.p0,t.p1),e.hasIntersection()?e.getIntersection(0):null};ot.prototype.project=function(){if(arguments[0]instanceof z){var t=arguments[0];if(t.equals(this.p0)||t.equals(this.p1))return new z(t);var e=this.projectionFactor(t),r=new z;return r.x=this.p0.x+e*(this.p1.x-this.p0.x),r.y=this.p0.y+e*(this.p1.y-this.p0.y),r}else if(arguments[0]instanceof ot){var i=arguments[0],s=this.projectionFactor(i.p0),o=this.projectionFactor(i.p1);if(s>=1&&o>=1||s<=0&&o<=0)return null;var a=this.project(i.p0);s<0&&(a=this.p0),s>1&&(a=this.p1);var l=this.project(i.p1);return o<0&&(l=this.p0),o>1&&(l=this.p1),new ot(a,l)}};ot.prototype.normalize=function(){this.p1.compareTo(this.p0)<0&&this.reverse()};ot.prototype.angle=function(){return Math.atan2(this.p1.y-this.p0.y,this.p1.x-this.p0.x)};ot.prototype.getCoordinate=function(t){return t===0?this.p0:this.p1};ot.prototype.distancePerpendicular=function(t){return rt.distancePointLinePerpendicular(t,this.p0,this.p1)};ot.prototype.minY=function(){return Math.min(this.p0.y,this.p1.y)};ot.prototype.midPoint=function(){return ot.midPoint(this.p0,this.p1)};ot.prototype.projectionFactor=function(t){if(t.equals(this.p0))return 0;if(t.equals(this.p1))return 1;var e=this.p1.x-this.p0.x,r=this.p1.y-this.p0.y,i=e*e+r*r;if(i<=0)return dt.NaN;var s=((t.x-this.p0.x)*e+(t.y-this.p0.y)*r)/i;return s};ot.prototype.closestPoints=function(t){var e=this.intersection(t);if(e!==null)return[e,e];var r=new Array(2).fill(null),i=dt.MAX_VALUE,s=null,o=this.closestPoint(t.p0);i=o.distance(t.p0),r[0]=o,r[1]=t.p0;var a=this.closestPoint(t.p1);s=a.distance(t.p1),s<i&&(i=s,r[0]=a,r[1]=t.p1);var l=t.closestPoint(this.p0);s=l.distance(this.p0),s<i&&(i=s,r[0]=this.p0,r[1]=l);var c=t.closestPoint(this.p1);return s=c.distance(this.p1),s<i&&(i=s,r[0]=this.p1,r[1]=c),r};ot.prototype.closestPoint=function(t){var e=this.projectionFactor(t);if(e>0&&e<1)return this.project(t);var r=this.p0.distance(t),i=this.p1.distance(t);return r<i?this.p0:this.p1};ot.prototype.maxX=function(){return Math.max(this.p0.x,this.p1.x)};ot.prototype.getLength=function(){return this.p0.distance(this.p1)};ot.prototype.compareTo=function(t){var e=t,r=this.p0.compareTo(e.p0);return r!==0?r:this.p1.compareTo(e.p1)};ot.prototype.reverse=function(){var t=this.p0;this.p0=this.p1,this.p1=t};ot.prototype.equalsTopo=function(t){return this.p0.equals(t.p0)&&(this.p1.equals(t.p1)||this.p0.equals(t.p1))&&this.p1.equals(t.p0)};ot.prototype.lineIntersection=function(t){try{var e=Qn.intersection(this.p0,this.p1,t.p0,t.p1);return e}catch(r){if(!(r instanceof Ga))throw r}finally{}return null};ot.prototype.maxY=function(){return Math.max(this.p0.y,this.p1.y)};ot.prototype.pointAlongOffset=function(t,e){var r=this.p0.x+t*(this.p1.x-this.p0.x),i=this.p0.y+t*(this.p1.y-this.p0.y),s=this.p1.x-this.p0.x,o=this.p1.y-this.p0.y,a=Math.sqrt(s*s+o*o),l=0,c=0;if(e!==0){if(a<=0)throw new Error("Cannot compute offset from zero-length line segment");l=e*s/a,c=e*o/a}var u=r-c,h=i+l,f=new z(u,h);return f};ot.prototype.setCoordinates=function(){if(arguments.length===1){var t=arguments[0];this.setCoordinates(t.p0,t.p1)}else if(arguments.length===2){var e=arguments[0],r=arguments[1];this.p0.x=e.x,this.p0.y=e.y,this.p1.x=r.x,this.p1.y=r.y}};ot.prototype.segmentFraction=function(t){var e=this.projectionFactor(t);return e<0?e=0:(e>1||dt.isNaN(e))&&(e=1),e};ot.prototype.toString=function(){return"LINESTRING( "+this.p0.x+" "+this.p0.y+", "+this.p1.x+" "+this.p1.y+")"};ot.prototype.isHorizontal=function(){return this.p0.y===this.p1.y};ot.prototype.distance=function(){if(arguments[0]instanceof ot){var t=arguments[0];return rt.distanceLineLine(this.p0,this.p1,t.p0,t.p1)}else if(arguments[0]instanceof z){var e=arguments[0];return rt.distancePointLine(e,this.p0,this.p1)}};ot.prototype.pointAlong=function(t){var e=new z;return e.x=this.p0.x+t*(this.p1.x-this.p0.x),e.y=this.p0.y+t*(this.p1.y-this.p0.y),e};ot.prototype.hashCode=function(){var t=dt.doubleToLongBits(this.p0.x);t^=dt.doubleToLongBits(this.p0.y)*31;var e=Math.trunc(t)^Math.trunc(t>>32),r=dt.doubleToLongBits(this.p1.x);r^=dt.doubleToLongBits(this.p1.y)*31;var i=Math.trunc(r)^Math.trunc(r>>32);return e^i};ot.prototype.interfaces_=function(){return[Gn,Yn]};ot.prototype.getClass=function(){return ot};ot.midPoint=function(t,e){return new z((t.x+e.x)/2,(t.y+e.y)/2)};sE.serialVersionUID.get=function(){return 0x2d2172135f411c00};Object.defineProperties(ot,sE);var Wl=function(){this.tempEnv1=new st,this.tempEnv2=new st,this._overlapSeg1=new ot,this._overlapSeg2=new ot};Wl.prototype.overlap=function(){if(arguments.length!==2){if(arguments.length===4){var t=arguments[0],e=arguments[1],r=arguments[2],i=arguments[3];t.getLineSegment(e,this._overlapSeg1),r.getLineSegment(i,this._overlapSeg2),this.overlap(this._overlapSeg1,this._overlapSeg2)}}};Wl.prototype.interfaces_=function(){return[]};Wl.prototype.getClass=function(){return Wl};var En=function(){this._pts=null,this._start=null,this._end=null,this._env=null,this._context=null,this._id=null;var t=arguments[0],e=arguments[1],r=arguments[2],i=arguments[3];this._pts=t,this._start=e,this._end=r,this._context=i};En.prototype.getLineSegment=function(t,e){e.p0=this._pts[t],e.p1=this._pts[t+1]};En.prototype.computeSelect=function(t,e,r,i){var s=this._pts[e],o=this._pts[r];if(i.tempEnv1.init(s,o),r-e===1)return i.select(this,e),null;if(!t.intersects(i.tempEnv1))return null;var a=Math.trunc((e+r)/2);e<a&&this.computeSelect(t,e,a,i),a<r&&this.computeSelect(t,a,r,i)};En.prototype.getCoordinates=function(){for(var t=this,e=new Array(this._end-this._start+1).fill(null),r=0,i=this._start;i<=this._end;i++)e[r++]=t._pts[i];return e};En.prototype.computeOverlaps=function(t,e){this.computeOverlapsInternal(this._start,this._end,t,t._start,t._end,e)};En.prototype.setId=function(t){this._id=t};En.prototype.select=function(t,e){this.computeSelect(t,this._start,this._end,e)};En.prototype.getEnvelope=function(){if(this._env===null){var t=this._pts[this._start],e=this._pts[this._end];this._env=new st(t,e)}return this._env};En.prototype.getEndIndex=function(){return this._end};En.prototype.getStartIndex=function(){return this._start};En.prototype.getContext=function(){return this._context};En.prototype.getId=function(){return this._id};En.prototype.computeOverlapsInternal=function(t,e,r,i,s,o){var a=this._pts[t],l=this._pts[e],c=r._pts[i],u=r._pts[s];if(e-t===1&&s-i===1)return o.overlap(this,t,r,i),null;if(o.tempEnv1.init(a,l),o.tempEnv2.init(c,u),!o.tempEnv1.intersects(o.tempEnv2))return null;var h=Math.trunc((t+e)/2),f=Math.trunc((i+s)/2);t<h&&(i<f&&this.computeOverlapsInternal(t,h,r,i,f,o),f<s&&this.computeOverlapsInternal(t,h,r,f,s,o)),h<e&&(i<f&&this.computeOverlapsInternal(h,e,r,i,f,o),f<s&&this.computeOverlapsInternal(h,e,r,f,s,o))};En.prototype.interfaces_=function(){return[]};En.prototype.getClass=function(){return En};var Cr=function(){};Cr.prototype.interfaces_=function(){return[]};Cr.prototype.getClass=function(){return Cr};Cr.getChainStartIndices=function(t){var e=0,r=new et;r.add(new Ar(e));do{var i=Cr.findChainEnd(t,e);r.add(new Ar(i)),e=i}while(e<t.length-1);var s=Cr.toIntArray(r);return s};Cr.findChainEnd=function(t,e){for(var r=e;r<t.length-1&&t[r].equals2D(t[r+1]);)r++;if(r>=t.length-1)return t.length-1;for(var i=Ot.quadrant(t[r],t[r+1]),s=e+1;s<t.length;){if(!t[s-1].equals2D(t[s])){var o=Ot.quadrant(t[s-1],t[s]);if(o!==i)break}s++}return s-1};Cr.getChains=function(){if(arguments.length===1){var t=arguments[0];return Cr.getChains(t,null)}else if(arguments.length===2){for(var e=arguments[0],r=arguments[1],i=new et,s=Cr.getChainStartIndices(e),o=0;o<s.length-1;o++){var a=new En(e,s[o],s[o+1],r);i.add(a)}return i}};Cr.toIntArray=function(t){for(var e=new Array(t.size()).fill(null),r=0;r<e.length;r++)e[r]=t.get(r).intValue();return e};var Rs=function(){};Rs.prototype.computeNodes=function(t){};Rs.prototype.getNodedSubstrings=function(){};Rs.prototype.interfaces_=function(){return[]};Rs.prototype.getClass=function(){return Rs};var Hl=function(){if(this._segInt=null,arguments.length!==0){if(arguments.length===1){var t=arguments[0];this.setSegmentIntersector(t)}}};Hl.prototype.setSegmentIntersector=function(t){this._segInt=t};Hl.prototype.interfaces_=function(){return[Rs]};Hl.prototype.getClass=function(){return Hl};var _g=function(n){function t(r){r?n.call(this,r):n.call(this),this._monoChains=new et,this._index=new iE,this._idCounter=0,this._nodedSegStrings=null,this._nOverlaps=0}n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t;var e={SegmentOverlapAction:{configurable:!0}};return t.prototype.getMonotoneChains=function(){return this._monoChains},t.prototype.getNodedSubstrings=function(){return ie.getNodedSubstrings(this._nodedSegStrings)},t.prototype.getIndex=function(){return this._index},t.prototype.add=function(i){for(var s=this,o=Cr.getChains(i.getCoordinates(),i),a=o.iterator();a.hasNext();){var l=a.next();l.setId(s._idCounter++),s._index.insert(l.getEnvelope(),l),s._monoChains.add(l)}},t.prototype.computeNodes=function(i){var s=this;this._nodedSegStrings=i;for(var o=i.iterator();o.hasNext();)s.add(o.next());this.intersectChains()},t.prototype.intersectChains=function(){for(var i=this,s=new Iy(this._segInt),o=this._monoChains.iterator();o.hasNext();)for(var a=o.next(),l=i._index.query(a.getEnvelope()),c=l.iterator();c.hasNext();){var u=c.next();if(u.getId()>a.getId()&&(a.computeOverlaps(u,s),i._nOverlaps++),i._segInt.isDone())return null}},t.prototype.interfaces_=function(){return[]},t.prototype.getClass=function(){return t},e.SegmentOverlapAction.get=function(){return Iy},Object.defineProperties(t,e),t}(Hl),Iy=function(n){function t(){n.call(this),this._si=null;var e=arguments[0];this._si=e}return n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t,t.prototype.overlap=function(){if(arguments.length===4){var r=arguments[0],i=arguments[1],s=arguments[2],o=arguments[3],a=r.getContext(),l=s.getContext();this._si.processIntersections(a,i,l,o)}else return n.prototype.overlap.apply(this,arguments)},t.prototype.interfaces_=function(){return[]},t.prototype.getClass=function(){return t},t}(Wl),Ct=function n(){if(this._quadrantSegments=n.DEFAULT_QUADRANT_SEGMENTS,this._endCapStyle=n.CAP_ROUND,this._joinStyle=n.JOIN_ROUND,this._mitreLimit=n.DEFAULT_MITRE_LIMIT,this._isSingleSided=!1,this._simplifyFactor=n.DEFAULT_SIMPLIFY_FACTOR,arguments.length!==0){if(arguments.length===1){var t=arguments[0];this.setQuadrantSegments(t)}else if(arguments.length===2){var e=arguments[0],r=arguments[1];this.setQuadrantSegments(e),this.setEndCapStyle(r)}else if(arguments.length===4){var i=arguments[0],s=arguments[1],o=arguments[2],a=arguments[3];this.setQuadrantSegments(i),this.setEndCapStyle(s),this.setJoinStyle(o),this.setMitreLimit(a)}}},Fi={CAP_ROUND:{configurable:!0},CAP_FLAT:{configurable:!0},CAP_SQUARE:{configurable:!0},JOIN_ROUND:{configurable:!0},JOIN_MITRE:{configurable:!0},JOIN_BEVEL:{configurable:!0},DEFAULT_QUADRANT_SEGMENTS:{configurable:!0},DEFAULT_MITRE_LIMIT:{configurable:!0},DEFAULT_SIMPLIFY_FACTOR:{configurable:!0}};Ct.prototype.getEndCapStyle=function(){return this._endCapStyle};Ct.prototype.isSingleSided=function(){return this._isSingleSided};Ct.prototype.setQuadrantSegments=function(t){this._quadrantSegments=t,this._quadrantSegments===0&&(this._joinStyle=Ct.JOIN_BEVEL),this._quadrantSegments<0&&(this._joinStyle=Ct.JOIN_MITRE,this._mitreLimit=Math.abs(this._quadrantSegments)),t<=0&&(this._quadrantSegments=1),this._joinStyle!==Ct.JOIN_ROUND&&(this._quadrantSegments=Ct.DEFAULT_QUADRANT_SEGMENTS)};Ct.prototype.getJoinStyle=function(){return this._joinStyle};Ct.prototype.setJoinStyle=function(t){this._joinStyle=t};Ct.prototype.setSimplifyFactor=function(t){this._simplifyFactor=t<0?0:t};Ct.prototype.getSimplifyFactor=function(){return this._simplifyFactor};Ct.prototype.getQuadrantSegments=function(){return this._quadrantSegments};Ct.prototype.setEndCapStyle=function(t){this._endCapStyle=t};Ct.prototype.getMitreLimit=function(){return this._mitreLimit};Ct.prototype.setMitreLimit=function(t){this._mitreLimit=t};Ct.prototype.setSingleSided=function(t){this._isSingleSided=t};Ct.prototype.interfaces_=function(){return[]};Ct.prototype.getClass=function(){return Ct};Ct.bufferDistanceError=function(t){var e=Math.PI/2/t;return 1-Math.cos(e/2)};Fi.CAP_ROUND.get=function(){return 1};Fi.CAP_FLAT.get=function(){return 2};Fi.CAP_SQUARE.get=function(){return 3};Fi.JOIN_ROUND.get=function(){return 1};Fi.JOIN_MITRE.get=function(){return 2};Fi.JOIN_BEVEL.get=function(){return 3};Fi.DEFAULT_QUADRANT_SEGMENTS.get=function(){return 8};Fi.DEFAULT_MITRE_LIMIT.get=function(){return 5};Fi.DEFAULT_SIMPLIFY_FACTOR.get=function(){return .01};Object.defineProperties(Ct,Fi);var Qt=function(t){this._distanceTol=null,this._isDeleted=null,this._angleOrientation=rt.COUNTERCLOCKWISE,this._inputLine=t||null},mc={INIT:{configurable:!0},DELETE:{configurable:!0},KEEP:{configurable:!0},NUM_PTS_TO_CHECK:{configurable:!0}};Qt.prototype.isDeletable=function(t,e,r,i){var s=this._inputLine[t],o=this._inputLine[e],a=this._inputLine[r];return!this.isConcave(s,o,a)||!this.isShallow(s,o,a,i)?!1:this.isShallowSampled(s,o,t,r,i)};Qt.prototype.deleteShallowConcavities=function(){for(var t=this,e=1,r=this.findNextNonDeletedIndex(e),i=this.findNextNonDeletedIndex(r),s=!1;i<this._inputLine.length;){var o=!1;t.isDeletable(e,r,i,t._distanceTol)&&(t._isDeleted[r]=Qt.DELETE,o=!0,s=!0),o?e=i:e=r,r=t.findNextNonDeletedIndex(e),i=t.findNextNonDeletedIndex(r)}return s};Qt.prototype.isShallowConcavity=function(t,e,r,i){var s=rt.computeOrientation(t,e,r),o=s===this._angleOrientation;if(!o)return!1;var a=rt.distancePointLine(e,t,r);return a<i};Qt.prototype.isShallowSampled=function(t,e,r,i,s){var o=this,a=Math.trunc((i-r)/Qt.NUM_PTS_TO_CHECK);a<=0&&(a=1);for(var l=r;l<i;l+=a)if(!o.isShallow(t,e,o._inputLine[l],s))return!1;return!0};Qt.prototype.isConcave=function(t,e,r){var i=rt.computeOrientation(t,e,r),s=i===this._angleOrientation;return s};Qt.prototype.simplify=function(t){var e=this;this._distanceTol=Math.abs(t),t<0&&(this._angleOrientation=rt.CLOCKWISE),this._isDeleted=new Array(this._inputLine.length).fill(null);var r=!1;do r=e.deleteShallowConcavities();while(r);return this.collapseLine()};Qt.prototype.findNextNonDeletedIndex=function(t){for(var e=t+1;e<this._inputLine.length&&this._isDeleted[e]===Qt.DELETE;)e++;return e};Qt.prototype.isShallow=function(t,e,r,i){var s=rt.distancePointLine(e,t,r);return s<i};Qt.prototype.collapseLine=function(){for(var t=this,e=new dc,r=0;r<this._inputLine.length;r++)t._isDeleted[r]!==Qt.DELETE&&e.add(t._inputLine[r]);return e.toCoordinateArray()};Qt.prototype.interfaces_=function(){return[]};Qt.prototype.getClass=function(){return Qt};Qt.simplify=function(t,e){var r=new Qt(t);return r.simplify(e)};mc.INIT.get=function(){return 0};mc.DELETE.get=function(){return 1};mc.KEEP.get=function(){return 1};mc.NUM_PTS_TO_CHECK.get=function(){return 10};Object.defineProperties(Qt,mc);var Ln=function(){this._ptList=null,this._precisionModel=null,this._minimimVertexDistance=0,this._ptList=new et},oE={COORDINATE_ARRAY_TYPE:{configurable:!0}};Ln.prototype.getCoordinates=function(){var t=this._ptList.toArray(Ln.COORDINATE_ARRAY_TYPE);return t};Ln.prototype.setPrecisionModel=function(t){this._precisionModel=t};Ln.prototype.addPt=function(t){var e=new z(t);if(this._precisionModel.makePrecise(e),this.isRedundant(e))return null;this._ptList.add(e)};Ln.prototype.revere=function(){};Ln.prototype.addPts=function(t,e){var r=this;if(e)for(var i=0;i<t.length;i++)r.addPt(t[i]);else for(var s=t.length-1;s>=0;s--)r.addPt(t[s])};Ln.prototype.isRedundant=function(t){if(this._ptList.size()<1)return!1;var e=this._ptList.get(this._ptList.size()-1),r=t.distance(e);return r<this._minimimVertexDistance};Ln.prototype.toString=function(){var t=new _t,e=t.createLineString(this.getCoordinates());return e.toString()};Ln.prototype.closeRing=function(){if(this._ptList.size()<1)return null;var t=new z(this._ptList.get(0)),e=this._ptList.get(this._ptList.size()-1);if(t.equals(e))return null;this._ptList.add(t)};Ln.prototype.setMinimumVertexDistance=function(t){this._minimimVertexDistance=t};Ln.prototype.interfaces_=function(){return[]};Ln.prototype.getClass=function(){return Ln};oE.COORDINATE_ARRAY_TYPE.get=function(){return new Array(0).fill(null)};Object.defineProperties(Ln,oE);var bt=function(){},Do={PI_TIMES_2:{configurable:!0},PI_OVER_2:{configurable:!0},PI_OVER_4:{configurable:!0},COUNTERCLOCKWISE:{configurable:!0},CLOCKWISE:{configurable:!0},NONE:{configurable:!0}};bt.prototype.interfaces_=function(){return[]};bt.prototype.getClass=function(){return bt};bt.toDegrees=function(t){return t*180/Math.PI};bt.normalize=function(t){for(;t>Math.PI;)t-=bt.PI_TIMES_2;for(;t<=-Math.PI;)t+=bt.PI_TIMES_2;return t};bt.angle=function(){if(arguments.length===1){var t=arguments[0];return Math.atan2(t.y,t.x)}else if(arguments.length===2){var e=arguments[0],r=arguments[1],i=r.x-e.x,s=r.y-e.y;return Math.atan2(s,i)}};bt.isAcute=function(t,e,r){var i=t.x-e.x,s=t.y-e.y,o=r.x-e.x,a=r.y-e.y,l=i*o+s*a;return l>0};bt.isObtuse=function(t,e,r){var i=t.x-e.x,s=t.y-e.y,o=r.x-e.x,a=r.y-e.y,l=i*o+s*a;return l<0};bt.interiorAngle=function(t,e,r){var i=bt.angle(e,t),s=bt.angle(e,r);return Math.abs(s-i)};bt.normalizePositive=function(t){if(t<0){for(;t<0;)t+=bt.PI_TIMES_2;t>=bt.PI_TIMES_2&&(t=0)}else{for(;t>=bt.PI_TIMES_2;)t-=bt.PI_TIMES_2;t<0&&(t=0)}return t};bt.angleBetween=function(t,e,r){var i=bt.angle(e,t),s=bt.angle(e,r);return bt.diff(i,s)};bt.diff=function(t,e){var r=null;return t<e?r=e-t:r=t-e,r>Math.PI&&(r=2*Math.PI-r),r};bt.toRadians=function(t){return t*Math.PI/180};bt.getTurn=function(t,e){var r=Math.sin(e-t);return r>0?bt.COUNTERCLOCKWISE:r<0?bt.CLOCKWISE:bt.NONE};bt.angleBetweenOriented=function(t,e,r){var i=bt.angle(e,t),s=bt.angle(e,r),o=s-i;return o<=-Math.PI?o+bt.PI_TIMES_2:o>Math.PI?o-bt.PI_TIMES_2:o};Do.PI_TIMES_2.get=function(){return 2*Math.PI};Do.PI_OVER_2.get=function(){return Math.PI/2};Do.PI_OVER_4.get=function(){return Math.PI/4};Do.COUNTERCLOCKWISE.get=function(){return rt.COUNTERCLOCKWISE};Do.CLOCKWISE.get=function(){return rt.CLOCKWISE};Do.NONE.get=function(){return rt.COLLINEAR};Object.defineProperties(bt,Do);var Wt=function n(){this._maxCurveSegmentError=0,this._filletAngleQuantum=null,this._closingSegLengthFactor=1,this._segList=null,this._distance=0,this._precisionModel=null,this._bufParams=null,this._li=null,this._s0=null,this._s1=null,this._s2=null,this._seg0=new ot,this._seg1=new ot,this._offset0=new ot,this._offset1=new ot,this._side=0,this._hasNarrowConcaveAngle=!1;var t=arguments[0],e=arguments[1],r=arguments[2];this._precisionModel=t,this._bufParams=e,this._li=new Hs,this._filletAngleQuantum=Math.PI/2/e.getQuadrantSegments(),e.getQuadrantSegments()>=8&&e.getJoinStyle()===Ct.JOIN_ROUND&&(this._closingSegLengthFactor=n.MAX_CLOSING_SEG_LEN_FACTOR),this.init(r)},_c={OFFSET_SEGMENT_SEPARATION_FACTOR:{configurable:!0},INSIDE_TURN_VERTEX_SNAP_DISTANCE_FACTOR:{configurable:!0},CURVE_VERTEX_SNAP_DISTANCE_FACTOR:{configurable:!0},MAX_CLOSING_SEG_LEN_FACTOR:{configurable:!0}};Wt.prototype.addNextSegment=function(t,e){if(this._s0=this._s1,this._s1=this._s2,this._s2=t,this._seg0.setCoordinates(this._s0,this._s1),this.computeOffsetSegment(this._seg0,this._side,this._distance,this._offset0),this._seg1.setCoordinates(this._s1,this._s2),this.computeOffsetSegment(this._seg1,this._side,this._distance,this._offset1),this._s1.equals(this._s2))return null;var r=rt.computeOrientation(this._s0,this._s1,this._s2),i=r===rt.CLOCKWISE&&this._side===Q.LEFT||r===rt.COUNTERCLOCKWISE&&this._side===Q.RIGHT;r===0?this.addCollinear(e):i?this.addOutsideTurn(r,e):this.addInsideTurn(r,e)};Wt.prototype.addLineEndCap=function(t,e){var r=new ot(t,e),i=new ot;this.computeOffsetSegment(r,Q.LEFT,this._distance,i);var s=new ot;this.computeOffsetSegment(r,Q.RIGHT,this._distance,s);var o=e.x-t.x,a=e.y-t.y,l=Math.atan2(a,o);switch(this._bufParams.getEndCapStyle()){case Ct.CAP_ROUND:this._segList.addPt(i.p1),this.addFilletArc(e,l+Math.PI/2,l-Math.PI/2,rt.CLOCKWISE,this._distance),this._segList.addPt(s.p1);break;case Ct.CAP_FLAT:this._segList.addPt(i.p1),this._segList.addPt(s.p1);break;case Ct.CAP_SQUARE:var c=new z;c.x=Math.abs(this._distance)*Math.cos(l),c.y=Math.abs(this._distance)*Math.sin(l);var u=new z(i.p1.x+c.x,i.p1.y+c.y),h=new z(s.p1.x+c.x,s.p1.y+c.y);this._segList.addPt(u),this._segList.addPt(h);break}};Wt.prototype.getCoordinates=function(){var t=this._segList.getCoordinates();return t};Wt.prototype.addMitreJoin=function(t,e,r,i){var s=!0,o=null;try{o=Qn.intersection(e.p0,e.p1,r.p0,r.p1);var a=i<=0?1:o.distance(t)/Math.abs(i);a>this._bufParams.getMitreLimit()&&(s=!1)}catch(l){if(l instanceof Ga)o=new z(0,0),s=!1;else throw l}finally{}s?this._segList.addPt(o):this.addLimitedMitreJoin(e,r,i,this._bufParams.getMitreLimit())};Wt.prototype.addFilletCorner=function(t,e,r,i,s){var o=e.x-t.x,a=e.y-t.y,l=Math.atan2(a,o),c=r.x-t.x,u=r.y-t.y,h=Math.atan2(u,c);i===rt.CLOCKWISE?l<=h&&(l+=2*Math.PI):l>=h&&(l-=2*Math.PI),this._segList.addPt(e),this.addFilletArc(t,l,h,i,s),this._segList.addPt(r)};Wt.prototype.addOutsideTurn=function(t,e){if(this._offset0.p1.distance(this._offset1.p0)<this._distance*Wt.OFFSET_SEGMENT_SEPARATION_FACTOR)return this._segList.addPt(this._offset0.p1),null;this._bufParams.getJoinStyle()===Ct.JOIN_MITRE?this.addMitreJoin(this._s1,this._offset0,this._offset1,this._distance):this._bufParams.getJoinStyle()===Ct.JOIN_BEVEL?this.addBevelJoin(this._offset0,this._offset1):(e&&this._segList.addPt(this._offset0.p1),this.addFilletCorner(this._s1,this._offset0.p1,this._offset1.p0,t,this._distance),this._segList.addPt(this._offset1.p0))};Wt.prototype.createSquare=function(t){this._segList.addPt(new z(t.x+this._distance,t.y+this._distance)),this._segList.addPt(new z(t.x+this._distance,t.y-this._distance)),this._segList.addPt(new z(t.x-this._distance,t.y-this._distance)),this._segList.addPt(new z(t.x-this._distance,t.y+this._distance)),this._segList.closeRing()};Wt.prototype.addSegments=function(t,e){this._segList.addPts(t,e)};Wt.prototype.addFirstSegment=function(){this._segList.addPt(this._offset1.p0)};Wt.prototype.addLastSegment=function(){this._segList.addPt(this._offset1.p1)};Wt.prototype.initSideSegments=function(t,e,r){this._s1=t,this._s2=e,this._side=r,this._seg1.setCoordinates(t,e),this.computeOffsetSegment(this._seg1,r,this._distance,this._offset1)};Wt.prototype.addLimitedMitreJoin=function(t,e,r,i){var s=this._seg0.p1,o=bt.angle(s,this._seg0.p0),a=bt.angleBetweenOriented(this._seg0.p0,s,this._seg1.p1),l=a/2,c=bt.normalize(o+l),u=bt.normalize(c+Math.PI),h=i*r,f=h*Math.abs(Math.sin(l)),d=r-f,p=s.x+h*Math.cos(u),_=s.y+h*Math.sin(u),v=new z(p,_),E=new ot(s,v),m=E.pointAlongOffset(1,d),g=E.pointAlongOffset(1,-d);this._side===Q.LEFT?(this._segList.addPt(m),this._segList.addPt(g)):(this._segList.addPt(g),this._segList.addPt(m))};Wt.prototype.computeOffsetSegment=function(t,e,r,i){var s=e===Q.LEFT?1:-1,o=t.p1.x-t.p0.x,a=t.p1.y-t.p0.y,l=Math.sqrt(o*o+a*a),c=s*r*o/l,u=s*r*a/l;i.p0.x=t.p0.x-u,i.p0.y=t.p0.y+c,i.p1.x=t.p1.x-u,i.p1.y=t.p1.y+c};Wt.prototype.addFilletArc=function(t,e,r,i,s){var o=this,a=i===rt.CLOCKWISE?-1:1,l=Math.abs(e-r),c=Math.trunc(l/this._filletAngleQuantum+.5);if(c<1)return null;for(var u=0,h=l/c,f=u,d=new z;f<l;){var p=e+a*f;d.x=t.x+s*Math.cos(p),d.y=t.y+s*Math.sin(p),o._segList.addPt(d),f+=h}};Wt.prototype.addInsideTurn=function(t,e){if(this._li.computeIntersection(this._offset0.p0,this._offset0.p1,this._offset1.p0,this._offset1.p1),this._li.hasIntersection())this._segList.addPt(this._li.getIntersection(0));else if(this._hasNarrowConcaveAngle=!0,this._offset0.p1.distance(this._offset1.p0)<this._distance*Wt.INSIDE_TURN_VERTEX_SNAP_DISTANCE_FACTOR)this._segList.addPt(this._offset0.p1);else{if(this._segList.addPt(this._offset0.p1),this._closingSegLengthFactor>0){var r=new z((this._closingSegLengthFactor*this._offset0.p1.x+this._s1.x)/(this._closingSegLengthFactor+1),(this._closingSegLengthFactor*this._offset0.p1.y+this._s1.y)/(this._closingSegLengthFactor+1));this._segList.addPt(r);var i=new z((this._closingSegLengthFactor*this._offset1.p0.x+this._s1.x)/(this._closingSegLengthFactor+1),(this._closingSegLengthFactor*this._offset1.p0.y+this._s1.y)/(this._closingSegLengthFactor+1));this._segList.addPt(i)}else this._segList.addPt(this._s1);this._segList.addPt(this._offset1.p0)}};Wt.prototype.createCircle=function(t){var e=new z(t.x+this._distance,t.y);this._segList.addPt(e),this.addFilletArc(t,0,2*Math.PI,-1,this._distance),this._segList.closeRing()};Wt.prototype.addBevelJoin=function(t,e){this._segList.addPt(t.p1),this._segList.addPt(e.p0)};Wt.prototype.init=function(t){this._distance=t,this._maxCurveSegmentError=t*(1-Math.cos(this._filletAngleQuantum/2)),this._segList=new Ln,this._segList.setPrecisionModel(this._precisionModel),this._segList.setMinimumVertexDistance(t*Wt.CURVE_VERTEX_SNAP_DISTANCE_FACTOR)};Wt.prototype.addCollinear=function(t){this._li.computeIntersection(this._s0,this._s1,this._s1,this._s2);var e=this._li.getIntersectionNum();e>=2&&(this._bufParams.getJoinStyle()===Ct.JOIN_BEVEL||this._bufParams.getJoinStyle()===Ct.JOIN_MITRE?(t&&this._segList.addPt(this._offset0.p1),this._segList.addPt(this._offset1.p0)):this.addFilletCorner(this._s1,this._offset0.p1,this._offset1.p0,rt.CLOCKWISE,this._distance))};Wt.prototype.closeRing=function(){this._segList.closeRing()};Wt.prototype.hasNarrowConcaveAngle=function(){return this._hasNarrowConcaveAngle};Wt.prototype.interfaces_=function(){return[]};Wt.prototype.getClass=function(){return Wt};_c.OFFSET_SEGMENT_SEPARATION_FACTOR.get=function(){return .001};_c.INSIDE_TURN_VERTEX_SNAP_DISTANCE_FACTOR.get=function(){return .001};_c.CURVE_VERTEX_SNAP_DISTANCE_FACTOR.get=function(){return 1e-6};_c.MAX_CLOSING_SEG_LEN_FACTOR.get=function(){return 80};Object.defineProperties(Wt,_c);var un=function(){this._distance=0,this._precisionModel=null,this._bufParams=null;var t=arguments[0],e=arguments[1];this._precisionModel=t,this._bufParams=e};un.prototype.getOffsetCurve=function(t,e){if(this._distance=e,e===0)return null;var r=e<0,i=Math.abs(e),s=this.getSegGen(i);t.length<=1?this.computePointCurve(t[0],s):this.computeOffsetCurve(t,r,s);var o=s.getCoordinates();return r&&yt.reverse(o),o};un.prototype.computeSingleSidedBufferCurve=function(t,e,r){var i=this.simplifyTolerance(this._distance);if(e){r.addSegments(t,!0);var s=Qt.simplify(t,-i),o=s.length-1;r.initSideSegments(s[o],s[o-1],Q.LEFT),r.addFirstSegment();for(var a=o-2;a>=0;a--)r.addNextSegment(s[a],!0)}else{r.addSegments(t,!1);var l=Qt.simplify(t,i),c=l.length-1;r.initSideSegments(l[0],l[1],Q.LEFT),r.addFirstSegment();for(var u=2;u<=c;u++)r.addNextSegment(l[u],!0)}r.addLastSegment(),r.closeRing()};un.prototype.computeRingBufferCurve=function(t,e,r){var i=this.simplifyTolerance(this._distance);e===Q.RIGHT&&(i=-i);var s=Qt.simplify(t,i),o=s.length-1;r.initSideSegments(s[o-1],s[0],e);for(var a=1;a<=o;a++){var l=a!==1;r.addNextSegment(s[a],l)}r.closeRing()};un.prototype.computeLineBufferCurve=function(t,e){var r=this.simplifyTolerance(this._distance),i=Qt.simplify(t,r),s=i.length-1;e.initSideSegments(i[0],i[1],Q.LEFT);for(var o=2;o<=s;o++)e.addNextSegment(i[o],!0);e.addLastSegment(),e.addLineEndCap(i[s-1],i[s]);var a=Qt.simplify(t,-r),l=a.length-1;e.initSideSegments(a[l],a[l-1],Q.LEFT);for(var c=l-2;c>=0;c--)e.addNextSegment(a[c],!0);e.addLastSegment(),e.addLineEndCap(a[1],a[0]),e.closeRing()};un.prototype.computePointCurve=function(t,e){switch(this._bufParams.getEndCapStyle()){case Ct.CAP_ROUND:e.createCircle(t);break;case Ct.CAP_SQUARE:e.createSquare(t);break}};un.prototype.getLineCurve=function(t,e){if(this._distance=e,e<0&&!this._bufParams.isSingleSided()||e===0)return null;var r=Math.abs(e),i=this.getSegGen(r);if(t.length<=1)this.computePointCurve(t[0],i);else if(this._bufParams.isSingleSided()){var s=e<0;this.computeSingleSidedBufferCurve(t,s,i)}else this.computeLineBufferCurve(t,i);var o=i.getCoordinates();return o};un.prototype.getBufferParameters=function(){return this._bufParams};un.prototype.simplifyTolerance=function(t){return t*this._bufParams.getSimplifyFactor()};un.prototype.getRingCurve=function(t,e,r){if(this._distance=r,t.length<=2)return this.getLineCurve(t,r);if(r===0)return un.copyCoordinates(t);var i=this.getSegGen(r);return this.computeRingBufferCurve(t,e,i),i.getCoordinates()};un.prototype.computeOffsetCurve=function(t,e,r){var i=this.simplifyTolerance(this._distance);if(e){var s=Qt.simplify(t,-i),o=s.length-1;r.initSideSegments(s[o],s[o-1],Q.LEFT),r.addFirstSegment();for(var a=o-2;a>=0;a--)r.addNextSegment(s[a],!0)}else{var l=Qt.simplify(t,i),c=l.length-1;r.initSideSegments(l[0],l[1],Q.LEFT),r.addFirstSegment();for(var u=2;u<=c;u++)r.addNextSegment(l[u],!0)}r.addLastSegment()};un.prototype.getSegGen=function(t){return new Wt(this._precisionModel,this._bufParams,t)};un.prototype.interfaces_=function(){return[]};un.prototype.getClass=function(){return un};un.copyCoordinates=function(t){for(var e=new Array(t.length).fill(null),r=0;r<e.length;r++)e[r]=new z(t[r]);return e};var _o=function(){this._subgraphs=null,this._seg=new ot,this._cga=new rt;var t=arguments[0];this._subgraphs=t},aE={DepthSegment:{configurable:!0}};_o.prototype.findStabbedSegments=function(){var t=this;if(arguments.length===1){for(var e=arguments[0],r=new et,i=this._subgraphs.iterator();i.hasNext();){var s=i.next(),o=s.getEnvelope();e.y<o.getMinY()||e.y>o.getMaxY()||t.findStabbedSegments(e,s.getDirectedEdges(),r)}return r}else if(arguments.length===3){if(ct(arguments[2],tr)&&arguments[0]instanceof z&&arguments[1]instanceof Hd)for(var a=arguments[0],l=arguments[1],c=arguments[2],u=l.getEdge().getCoordinates(),h=0;h<u.length-1;h++){t._seg.p0=u[h],t._seg.p1=u[h+1],t._seg.p0.y>t._seg.p1.y&&t._seg.reverse();var f=Math.max(t._seg.p0.x,t._seg.p1.x);if(!(f<a.x)&&!t._seg.isHorizontal()&&!(a.y<t._seg.p0.y||a.y>t._seg.p1.y)&&rt.computeOrientation(t._seg.p0,t._seg.p1,a)!==rt.RIGHT){var d=l.getDepth(Q.LEFT);t._seg.p0.equals(u[h])||(d=l.getDepth(Q.RIGHT));var p=new Ns(t._seg,d);c.add(p)}}else if(ct(arguments[2],tr)&&arguments[0]instanceof z&&ct(arguments[1],tr))for(var _=arguments[0],v=arguments[1],E=arguments[2],m=v.iterator();m.hasNext();){var g=m.next();g.isForward()&&t.findStabbedSegments(_,g,E)}}};_o.prototype.getDepth=function(t){var e=this.findStabbedSegments(t);if(e.size()===0)return 0;var r=ir.min(e);return r._leftDepth};_o.prototype.interfaces_=function(){return[]};_o.prototype.getClass=function(){return _o};aE.DepthSegment.get=function(){return Ns};Object.defineProperties(_o,aE);var Ns=function(){this._upwardSeg=null,this._leftDepth=null;var t=arguments[0],e=arguments[1];this._upwardSeg=new ot(t),this._leftDepth=e};Ns.prototype.compareTo=function(t){var e=t;if(this._upwardSeg.minX()>=e._upwardSeg.maxX())return 1;if(this._upwardSeg.maxX()<=e._upwardSeg.minX())return-1;var r=this._upwardSeg.orientationIndex(e._upwardSeg);return r!==0||(r=-1*e._upwardSeg.orientationIndex(this._upwardSeg),r!==0)?r:this._upwardSeg.compareTo(e._upwardSeg)};Ns.prototype.compareX=function(t,e){var r=t.p0.compareTo(e.p0);return r!==0?r:t.p1.compareTo(e.p1)};Ns.prototype.toString=function(){return this._upwardSeg.toString()};Ns.prototype.interfaces_=function(){return[Gn]};Ns.prototype.getClass=function(){return Ns};var Pt=function(t,e,r){this.p0=t||null,this.p1=e||null,this.p2=r||null};Pt.prototype.area=function(){return Pt.area(this.p0,this.p1,this.p2)};Pt.prototype.signedArea=function(){return Pt.signedArea(this.p0,this.p1,this.p2)};Pt.prototype.interpolateZ=function(t){if(t===null)throw new Xt("Supplied point is null.");return Pt.interpolateZ(t,this.p0,this.p1,this.p2)};Pt.prototype.longestSideLength=function(){return Pt.longestSideLength(this.p0,this.p1,this.p2)};Pt.prototype.isAcute=function(){return Pt.isAcute(this.p0,this.p1,this.p2)};Pt.prototype.circumcentre=function(){return Pt.circumcentre(this.p0,this.p1,this.p2)};Pt.prototype.area3D=function(){return Pt.area3D(this.p0,this.p1,this.p2)};Pt.prototype.centroid=function(){return Pt.centroid(this.p0,this.p1,this.p2)};Pt.prototype.inCentre=function(){return Pt.inCentre(this.p0,this.p1,this.p2)};Pt.prototype.interfaces_=function(){return[]};Pt.prototype.getClass=function(){return Pt};Pt.area=function(t,e,r){return Math.abs(((r.x-t.x)*(e.y-t.y)-(e.x-t.x)*(r.y-t.y))/2)};Pt.signedArea=function(t,e,r){return((r.x-t.x)*(e.y-t.y)-(e.x-t.x)*(r.y-t.y))/2};Pt.det=function(t,e,r,i){return t*i-e*r};Pt.interpolateZ=function(t,e,r,i){var s=e.x,o=e.y,a=r.x-s,l=i.x-s,c=r.y-o,u=i.y-o,h=a*u-l*c,f=t.x-s,d=t.y-o,p=(u*f-l*d)/h,_=(-c*f+a*d)/h,v=e.z+p*(r.z-e.z)+_*(i.z-e.z);return v};Pt.longestSideLength=function(t,e,r){var i=t.distance(e),s=e.distance(r),o=r.distance(t),a=i;return s>a&&(a=s),o>a&&(a=o),a};Pt.isAcute=function(t,e,r){return!(!bt.isAcute(t,e,r)||!bt.isAcute(e,r,t)||!bt.isAcute(r,t,e))};Pt.circumcentre=function(t,e,r){var i=r.x,s=r.y,o=t.x-i,a=t.y-s,l=e.x-i,c=e.y-s,u=2*Pt.det(o,a,l,c),h=Pt.det(a,o*o+a*a,c,l*l+c*c),f=Pt.det(o,o*o+a*a,l,l*l+c*c),d=i-h/u,p=s+f/u;return new z(d,p)};Pt.perpendicularBisector=function(t,e){var r=e.x-t.x,i=e.y-t.y,s=new Qn(t.x+r/2,t.y+i/2,1),o=new Qn(t.x-i+r/2,t.y+r+i/2,1);return new Qn(s,o)};Pt.angleBisector=function(t,e,r){var i=e.distance(t),s=e.distance(r),o=i/(i+s),a=r.x-t.x,l=r.y-t.y,c=new z(t.x+o*a,t.y+o*l);return c};Pt.area3D=function(t,e,r){var i=e.x-t.x,s=e.y-t.y,o=e.z-t.z,a=r.x-t.x,l=r.y-t.y,c=r.z-t.z,u=s*c-o*l,h=o*a-i*c,f=i*l-s*a,d=u*u+h*h+f*f,p=Math.sqrt(d)/2;return p};Pt.centroid=function(t,e,r){var i=(t.x+e.x+r.x)/3,s=(t.y+e.y+r.y)/3;return new z(i,s)};Pt.inCentre=function(t,e,r){var i=e.distance(r),s=t.distance(r),o=t.distance(e),a=i+s+o,l=(i*t.x+s*e.x+o*r.x)/a,c=(i*t.y+s*e.y+o*r.y)/a;return new z(l,c)};var Xn=function(){this._inputGeom=null,this._distance=null,this._curveBuilder=null,this._curveList=new et;var t=arguments[0],e=arguments[1],r=arguments[2];this._inputGeom=t,this._distance=e,this._curveBuilder=r};Xn.prototype.addPoint=function(t){if(this._distance<=0)return null;var e=t.getCoordinates(),r=this._curveBuilder.getLineCurve(e,this._distance);this.addCurve(r,j.EXTERIOR,j.INTERIOR)};Xn.prototype.addPolygon=function(t){var e=this,r=this._distance,i=Q.LEFT;this._distance<0&&(r=-this._distance,i=Q.RIGHT);var s=t.getExteriorRing(),o=yt.removeRepeatedPoints(s.getCoordinates());if(this._distance<0&&this.isErodedCompletely(s,this._distance)||this._distance<=0&&o.length<3)return null;this.addPolygonRing(o,r,i,j.EXTERIOR,j.INTERIOR);for(var a=0;a<t.getNumInteriorRing();a++){var l=t.getInteriorRingN(a),c=yt.removeRepeatedPoints(l.getCoordinates());e._distance>0&&e.isErodedCompletely(l,-e._distance)||e.addPolygonRing(c,r,Q.opposite(i),j.INTERIOR,j.EXTERIOR)}};Xn.prototype.isTriangleErodedCompletely=function(t,e){var r=new Pt(t[0],t[1],t[2]),i=r.inCentre(),s=rt.distancePointLine(i,r.p0,r.p1);return s<Math.abs(e)};Xn.prototype.addLineString=function(t){if(this._distance<=0&&!this._curveBuilder.getBufferParameters().isSingleSided())return null;var e=yt.removeRepeatedPoints(t.getCoordinates()),r=this._curveBuilder.getLineCurve(e,this._distance);this.addCurve(r,j.EXTERIOR,j.INTERIOR)};Xn.prototype.addCurve=function(t,e,r){if(t===null||t.length<2)return null;var i=new ie(t,new Mt(0,j.BOUNDARY,e,r));this._curveList.add(i)};Xn.prototype.getCurves=function(){return this.add(this._inputGeom),this._curveList};Xn.prototype.addPolygonRing=function(t,e,r,i,s){if(e===0&&t.length<ti.MINIMUM_VALID_SIZE)return null;var o=i,a=s;t.length>=ti.MINIMUM_VALID_SIZE&&rt.isCCW(t)&&(o=s,a=i,r=Q.opposite(r));var l=this._curveBuilder.getRingCurve(t,r,e);this.addCurve(l,o,a)};Xn.prototype.add=function(t){if(t.isEmpty())return null;t instanceof ge?this.addPolygon(t):t instanceof Jt?this.addLineString(t):t instanceof bn?this.addPoint(t):t instanceof Ca?this.addCollection(t):t instanceof Ms?this.addCollection(t):t instanceof Kr?this.addCollection(t):t instanceof Je&&this.addCollection(t)};Xn.prototype.isErodedCompletely=function(t,e){var r=t.getCoordinates();if(r.length<4)return e<0;if(r.length===4)return this.isTriangleErodedCompletely(r,e);var i=t.getEnvelopeInternal(),s=Math.min(i.getHeight(),i.getWidth());return e<0&&2*Math.abs(e)>s};Xn.prototype.addCollection=function(t){for(var e=this,r=0;r<t.getNumGeometries();r++){var i=t.getGeometryN(r);e.add(i)}};Xn.prototype.interfaces_=function(){return[]};Xn.prototype.getClass=function(){return Xn};var Aa=function(){};Aa.prototype.locate=function(t){};Aa.prototype.interfaces_=function(){return[]};Aa.prototype.getClass=function(){return Aa};var Zr=function(){this._parent=null,this._atStart=null,this._max=null,this._index=null,this._subcollectionIterator=null;var t=arguments[0];this._parent=t,this._atStart=!0,this._index=0,this._max=t.getNumGeometries()};Zr.prototype.next=function(){if(this._atStart)return this._atStart=!1,Zr.isAtomic(this._parent)&&this._index++,this._parent;if(this._subcollectionIterator!==null){if(this._subcollectionIterator.hasNext())return this._subcollectionIterator.next();this._subcollectionIterator=null}if(this._index>=this._max)throw new qa;var t=this._parent.getGeometryN(this._index++);return t instanceof Je?(this._subcollectionIterator=new Zr(t),this._subcollectionIterator.next()):t};Zr.prototype.remove=function(){throw new Error(this.getClass().getName())};Zr.prototype.hasNext=function(){if(this._atStart)return!0;if(this._subcollectionIterator!==null){if(this._subcollectionIterator.hasNext())return!0;this._subcollectionIterator=null}return!(this._index>=this._max)};Zr.prototype.interfaces_=function(){return[Ya]};Zr.prototype.getClass=function(){return Zr};Zr.isAtomic=function(t){return!(t instanceof Je)};var Rn=function(){this._geom=null;var t=arguments[0];this._geom=t};Rn.prototype.locate=function(t){return Rn.locate(t,this._geom)};Rn.prototype.interfaces_=function(){return[Aa]};Rn.prototype.getClass=function(){return Rn};Rn.isPointInRing=function(t,e){return e.getEnvelopeInternal().intersects(t)?rt.isPointInRing(t,e.getCoordinates()):!1};Rn.containsPointInPolygon=function(t,e){if(e.isEmpty())return!1;var r=e.getExteriorRing();if(!Rn.isPointInRing(t,r))return!1;for(var i=0;i<e.getNumInteriorRing();i++){var s=e.getInteriorRingN(i);if(Rn.isPointInRing(t,s))return!1}return!0};Rn.containsPoint=function(t,e){if(e instanceof ge)return Rn.containsPointInPolygon(t,e);if(e instanceof Je)for(var r=new Zr(e);r.hasNext();){var i=r.next();if(i!==e&&Rn.containsPoint(t,i))return!0}return!1};Rn.locate=function(t,e){return e.isEmpty()?j.EXTERIOR:Rn.containsPoint(t,e)?j.INTERIOR:j.EXTERIOR};var je=function(){this._edgeMap=new We,this._edgeList=null,this._ptInAreaLocation=[j.NONE,j.NONE]};je.prototype.getNextCW=function(t){this.getEdges();var e=this._edgeList.indexOf(t),r=e-1;return e===0&&(r=this._edgeList.size()-1),this._edgeList.get(r)};je.prototype.propagateSideLabels=function(t){for(var e=j.NONE,r=this.iterator();r.hasNext();){var i=r.next(),s=i.getLabel();s.isArea(t)&&s.getLocation(t,Q.LEFT)!==j.NONE&&(e=s.getLocation(t,Q.LEFT))}if(e===j.NONE)return null;for(var o=e,a=this.iterator();a.hasNext();){var l=a.next(),c=l.getLabel();if(c.getLocation(t,Q.ON)===j.NONE&&c.setLocation(t,Q.ON,o),c.isArea(t)){var u=c.getLocation(t,Q.LEFT),h=c.getLocation(t,Q.RIGHT);if(h!==j.NONE){if(h!==o)throw new Ai("side location conflict",l.getCoordinate());u===j.NONE&&mt.shouldNeverReachHere("found single null side (at "+l.getCoordinate()+")"),o=u}else mt.isTrue(c.getLocation(t,Q.LEFT)===j.NONE,"found single null side"),c.setLocation(t,Q.RIGHT,o),c.setLocation(t,Q.LEFT,o)}}};je.prototype.getCoordinate=function(){var t=this.iterator();if(!t.hasNext())return null;var e=t.next();return e.getCoordinate()};je.prototype.print=function(t){De.out.println("EdgeEndStar:   "+this.getCoordinate());for(var e=this.iterator();e.hasNext();){var r=e.next();r.print(t)}};je.prototype.isAreaLabelsConsistent=function(t){return this.computeEdgeEndLabels(t.getBoundaryNodeRule()),this.checkAreaLabelsConsistent(0)};je.prototype.checkAreaLabelsConsistent=function(t){var e=this.getEdges();if(e.size()<=0)return!0;var r=e.size()-1,i=e.get(r).getLabel(),s=i.getLocation(t,Q.LEFT);mt.isTrue(s!==j.NONE,"Found unlabelled area edge");for(var o=s,a=this.iterator();a.hasNext();){var l=a.next(),c=l.getLabel();mt.isTrue(c.isArea(t),"Found non-area edge");var u=c.getLocation(t,Q.LEFT),h=c.getLocation(t,Q.RIGHT);if(u===h||h!==o)return!1;o=u}return!0};je.prototype.findIndex=function(t){var e=this;this.iterator();for(var r=0;r<this._edgeList.size();r++){var i=e._edgeList.get(r);if(i===t)return r}return-1};je.prototype.iterator=function(){return this.getEdges().iterator()};je.prototype.getEdges=function(){return this._edgeList===null&&(this._edgeList=new et(this._edgeMap.values())),this._edgeList};je.prototype.getLocation=function(t,e,r){return this._ptInAreaLocation[t]===j.NONE&&(this._ptInAreaLocation[t]=Rn.locate(e,r[t].getGeometry())),this._ptInAreaLocation[t]};je.prototype.toString=function(){var t=new Vr;t.append("EdgeEndStar:   "+this.getCoordinate()),t.append(`
`);for(var e=this.iterator();e.hasNext();){var r=e.next();t.append(r),t.append(`
`)}return t.toString()};je.prototype.computeEdgeEndLabels=function(t){for(var e=this.iterator();e.hasNext();){var r=e.next();r.computeLabel(t)}};je.prototype.computeLabelling=function(t){var e=this;this.computeEdgeEndLabels(t[0].getBoundaryNodeRule()),this.propagateSideLabels(0),this.propagateSideLabels(1);for(var r=[!1,!1],i=this.iterator();i.hasNext();)for(var s=i.next(),o=s.getLabel(),a=0;a<2;a++)o.isLine(a)&&o.getLocation(a)===j.BOUNDARY&&(r[a]=!0);for(var l=this.iterator();l.hasNext();)for(var c=l.next(),u=c.getLabel(),h=0;h<2;h++)if(u.isAnyNull(h)){var f=j.NONE;if(r[h])f=j.EXTERIOR;else{var d=c.getCoordinate();f=e.getLocation(h,d,t)}u.setAllLocationsIfNull(h,f)}};je.prototype.getDegree=function(){return this._edgeMap.size()};je.prototype.insertEdgeEnd=function(t,e){this._edgeMap.put(t,e),this._edgeList=null};je.prototype.interfaces_=function(){return[]};je.prototype.getClass=function(){return je};var gk=function(n){function t(){n.call(this),this._resultAreaEdgeList=null,this._label=null,this._SCANNING_FOR_INCOMING=1,this._LINKING_TO_OUTGOING=2}return n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t,t.prototype.linkResultDirectedEdges=function(){var r=this;this.getResultAreaEdges();for(var i=null,s=null,o=this._SCANNING_FOR_INCOMING,a=0;a<this._resultAreaEdgeList.size();a++){var l=r._resultAreaEdgeList.get(a),c=l.getSym();if(l.getLabel().isArea())switch(i===null&&l.isInResult()&&(i=l),o){case r._SCANNING_FOR_INCOMING:if(!c.isInResult())continue;s=c,o=r._LINKING_TO_OUTGOING;break;case r._LINKING_TO_OUTGOING:if(!l.isInResult())continue;s.setNext(l),o=r._SCANNING_FOR_INCOMING;break}}if(o===this._LINKING_TO_OUTGOING){if(i===null)throw new Ai("no outgoing dirEdge found",this.getCoordinate());mt.isTrue(i.isInResult(),"unable to link last incoming dirEdge"),s.setNext(i)}},t.prototype.insert=function(r){var i=r;this.insertEdgeEnd(i,i)},t.prototype.getRightmostEdge=function(){var r=this.getEdges(),i=r.size();if(i<1)return null;var s=r.get(0);if(i===1)return s;var o=r.get(i-1),a=s.getQuadrant(),l=o.getQuadrant();return Ot.isNorthern(a)&&Ot.isNorthern(l)?s:!Ot.isNorthern(a)&&!Ot.isNorthern(l)?o:s.getDy()!==0?s:o.getDy()!==0?o:(mt.shouldNeverReachHere("found two horizontal edges incident on node"),null)},t.prototype.print=function(r){De.out.println("DirectedEdgeStar: "+this.getCoordinate());for(var i=this.iterator();i.hasNext();){var s=i.next();r.print("out "),s.print(r),r.println(),r.print("in "),s.getSym().print(r),r.println()}},t.prototype.getResultAreaEdges=function(){var r=this;if(this._resultAreaEdgeList!==null)return this._resultAreaEdgeList;this._resultAreaEdgeList=new et;for(var i=this.iterator();i.hasNext();){var s=i.next();(s.isInResult()||s.getSym().isInResult())&&r._resultAreaEdgeList.add(s)}return this._resultAreaEdgeList},t.prototype.updateLabelling=function(r){for(var i=this.iterator();i.hasNext();){var s=i.next(),o=s.getLabel();o.setAllLocationsIfNull(0,r.getLocation(0)),o.setAllLocationsIfNull(1,r.getLocation(1))}},t.prototype.linkAllDirectedEdges=function(){var r=this;this.getEdges();for(var i=null,s=null,o=this._edgeList.size()-1;o>=0;o--){var a=r._edgeList.get(o),l=a.getSym();s===null&&(s=l),i!==null&&l.setNext(i),i=a}s.setNext(i)},t.prototype.computeDepths=function(){var r=this;if(arguments.length===1){var i=arguments[0],s=this.findIndex(i),o=i.getDepth(Q.LEFT),a=i.getDepth(Q.RIGHT),l=this.computeDepths(s+1,this._edgeList.size(),o),c=this.computeDepths(0,s,l);if(c!==a)throw new Ai("depth mismatch at "+i.getCoordinate())}else if(arguments.length===3){for(var u=arguments[0],h=arguments[1],f=arguments[2],d=f,p=u;p<h;p++){var _=r._edgeList.get(p);_.setEdgeDepths(Q.RIGHT,d),d=_.getDepth(Q.LEFT)}return d}},t.prototype.mergeSymLabels=function(){for(var r=this.iterator();r.hasNext();){var i=r.next(),s=i.getLabel();s.merge(i.getSym().getLabel())}},t.prototype.linkMinimalDirectedEdges=function(r){for(var i=this,s=null,o=null,a=this._SCANNING_FOR_INCOMING,l=this._resultAreaEdgeList.size()-1;l>=0;l--){var c=i._resultAreaEdgeList.get(l),u=c.getSym();switch(s===null&&c.getEdgeRing()===r&&(s=c),a){case i._SCANNING_FOR_INCOMING:if(u.getEdgeRing()!==r)continue;o=u,a=i._LINKING_TO_OUTGOING;break;case i._LINKING_TO_OUTGOING:if(c.getEdgeRing()!==r)continue;o.setNextMin(c),a=i._SCANNING_FOR_INCOMING;break}}a===this._LINKING_TO_OUTGOING&&(mt.isTrue(s!==null,"found null for first outgoing dirEdge"),mt.isTrue(s.getEdgeRing()===r,"unable to link last incoming dirEdge"),o.setNextMin(s))},t.prototype.getOutgoingDegree=function(){if(arguments.length===0){for(var r=0,i=this.iterator();i.hasNext();){var s=i.next();s.isInResult()&&r++}return r}else if(arguments.length===1){for(var o=arguments[0],a=0,l=this.iterator();l.hasNext();){var c=l.next();c.getEdgeRing()===o&&a++}return a}},t.prototype.getLabel=function(){return this._label},t.prototype.findCoveredLineEdges=function(){for(var r=j.NONE,i=this.iterator();i.hasNext();){var s=i.next(),o=s.getSym();if(!s.isLineEdge()){if(s.isInResult()){r=j.INTERIOR;break}if(o.isInResult()){r=j.EXTERIOR;break}}}if(r===j.NONE)return null;for(var a=r,l=this.iterator();l.hasNext();){var c=l.next(),u=c.getSym();c.isLineEdge()?c.getEdge().setCovered(a===j.INTERIOR):(c.isInResult()&&(a=j.EXTERIOR),u.isInResult()&&(a=j.INTERIOR))}},t.prototype.computeLabelling=function(r){var i=this;n.prototype.computeLabelling.call(this,r),this._label=new Mt(j.NONE);for(var s=this.iterator();s.hasNext();)for(var o=s.next(),a=o.getEdge(),l=a.getLabel(),c=0;c<2;c++){var u=l.getLocation(c);(u===j.INTERIOR||u===j.BOUNDARY)&&i._label.setLocation(c,j.INTERIOR)}},t.prototype.interfaces_=function(){return[]},t.prototype.getClass=function(){return t},t}(je),lE=function(n){function t(){n.apply(this,arguments)}return n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t,t.prototype.createNode=function(r){return new Wh(r,new gk)},t.prototype.interfaces_=function(){return[]},t.prototype.getClass=function(){return t},t}(Ta),Ji=function n(){this._pts=null,this._orientation=null;var t=arguments[0];this._pts=t,this._orientation=n.orientation(t)};Ji.prototype.compareTo=function(t){var e=t,r=Ji.compareOriented(this._pts,this._orientation,e._pts,e._orientation);return r};Ji.prototype.interfaces_=function(){return[Gn]};Ji.prototype.getClass=function(){return Ji};Ji.orientation=function(t){return yt.increasingDirection(t)===1};Ji.compareOriented=function(t,e,r,i){for(var s=e?1:-1,o=i?1:-1,a=e?t.length:-1,l=i?r.length:-1,c=e?0:t.length-1,u=i?0:r.length-1;;){var h=t[c].compareTo(r[u]);if(h!==0)return h;c+=s,u+=o;var f=c===a,d=u===l;if(f&&!d)return-1;if(!f&&d)return 1;if(f&&d)return 0}};var sr=function(){this._edges=new et,this._ocaMap=new We};sr.prototype.print=function(t){var e=this;t.print("MULTILINESTRING ( ");for(var r=0;r<this._edges.size();r++){var i=e._edges.get(r);r>0&&t.print(","),t.print("(");for(var s=i.getCoordinates(),o=0;o<s.length;o++)o>0&&t.print(","),t.print(s[o].x+" "+s[o].y);t.println(")")}t.print(")  ")};sr.prototype.addAll=function(t){for(var e=this,r=t.iterator();r.hasNext();)e.add(r.next())};sr.prototype.findEdgeIndex=function(t){for(var e=this,r=0;r<this._edges.size();r++)if(e._edges.get(r).equals(t))return r;return-1};sr.prototype.iterator=function(){return this._edges.iterator()};sr.prototype.getEdges=function(){return this._edges};sr.prototype.get=function(t){return this._edges.get(t)};sr.prototype.findEqualEdge=function(t){var e=new Ji(t.getCoordinates()),r=this._ocaMap.get(e);return r};sr.prototype.add=function(t){this._edges.add(t);var e=new Ji(t.getCoordinates());this._ocaMap.put(e,t)};sr.prototype.interfaces_=function(){return[]};sr.prototype.getClass=function(){return sr};var Os=function(){};Os.prototype.processIntersections=function(t,e,r,i){};Os.prototype.isDone=function(){};Os.prototype.interfaces_=function(){return[]};Os.prototype.getClass=function(){return Os};var kn=function(){this._hasIntersection=!1,this._hasProper=!1,this._hasProperInterior=!1,this._hasInterior=!1,this._properIntersectionPoint=null,this._li=null,this._isSelfIntersection=null,this.numIntersections=0,this.numInteriorIntersections=0,this.numProperIntersections=0,this.numTests=0;var t=arguments[0];this._li=t};kn.prototype.isTrivialIntersection=function(t,e,r,i){if(t===r&&this._li.getIntersectionNum()===1){if(kn.isAdjacentSegments(e,i))return!0;if(t.isClosed()){var s=t.size()-1;if(e===0&&i===s||i===0&&e===s)return!0}}return!1};kn.prototype.getProperIntersectionPoint=function(){return this._properIntersectionPoint};kn.prototype.hasProperInteriorIntersection=function(){return this._hasProperInterior};kn.prototype.getLineIntersector=function(){return this._li};kn.prototype.hasProperIntersection=function(){return this._hasProper};kn.prototype.processIntersections=function(t,e,r,i){if(t===r&&e===i)return null;this.numTests++;var s=t.getCoordinates()[e],o=t.getCoordinates()[e+1],a=r.getCoordinates()[i],l=r.getCoordinates()[i+1];this._li.computeIntersection(s,o,a,l),this._li.hasIntersection()&&(this.numIntersections++,this._li.isInteriorIntersection()&&(this.numInteriorIntersections++,this._hasInterior=!0),this.isTrivialIntersection(t,e,r,i)||(this._hasIntersection=!0,t.addIntersections(this._li,e,0),r.addIntersections(this._li,i,1),this._li.isProper()&&(this.numProperIntersections++,this._hasProper=!0,this._hasProperInterior=!0)))};kn.prototype.hasIntersection=function(){return this._hasIntersection};kn.prototype.isDone=function(){return!1};kn.prototype.hasInteriorIntersection=function(){return this._hasInterior};kn.prototype.interfaces_=function(){return[Os]};kn.prototype.getClass=function(){return kn};kn.isAdjacentSegments=function(t,e){return Math.abs(t-e)===1};var Lr=function(){this.coord=null,this.segmentIndex=null,this.dist=null;var t=arguments[0],e=arguments[1],r=arguments[2];this.coord=new z(t),this.segmentIndex=e,this.dist=r};Lr.prototype.getSegmentIndex=function(){return this.segmentIndex};Lr.prototype.getCoordinate=function(){return this.coord};Lr.prototype.print=function(t){t.print(this.coord),t.print(" seg # = "+this.segmentIndex),t.println(" dist = "+this.dist)};Lr.prototype.compareTo=function(t){var e=t;return this.compare(e.segmentIndex,e.dist)};Lr.prototype.isEndPoint=function(t){return this.segmentIndex===0&&this.dist===0||this.segmentIndex===t};Lr.prototype.toString=function(){return this.coord+" seg # = "+this.segmentIndex+" dist = "+this.dist};Lr.prototype.getDistance=function(){return this.dist};Lr.prototype.compare=function(t,e){return this.segmentIndex<t?-1:this.segmentIndex>t?1:this.dist<e?-1:this.dist>e?1:0};Lr.prototype.interfaces_=function(){return[Gn]};Lr.prototype.getClass=function(){return Lr};var ri=function(){this._nodeMap=new We,this.edge=null;var t=arguments[0];this.edge=t};ri.prototype.print=function(t){t.println("Intersections:");for(var e=this.iterator();e.hasNext();){var r=e.next();r.print(t)}};ri.prototype.iterator=function(){return this._nodeMap.values().iterator()};ri.prototype.addSplitEdges=function(t){var e=this;this.addEndpoints();for(var r=this.iterator(),i=r.next();r.hasNext();){var s=r.next(),o=e.createSplitEdge(i,s);t.add(o),i=s}};ri.prototype.addEndpoints=function(){var t=this.edge.pts.length-1;this.add(this.edge.pts[0],0,0),this.add(this.edge.pts[t],t,0)};ri.prototype.createSplitEdge=function(t,e){var r=this,i=e.segmentIndex-t.segmentIndex+2,s=this.edge.pts[e.segmentIndex],o=e.dist>0||!e.coord.equals2D(s);o||i--;var a=new Array(i).fill(null),l=0;a[l++]=new z(t.coord);for(var c=t.segmentIndex+1;c<=e.segmentIndex;c++)a[l++]=r.edge.pts[c];return o&&(a[l]=e.coord),new eh(a,new Mt(this.edge._label))};ri.prototype.add=function(t,e,r){var i=new Lr(t,e,r),s=this._nodeMap.get(i);return s!==null?s:(this._nodeMap.put(i,i),i)};ri.prototype.isIntersection=function(t){for(var e=this.iterator();e.hasNext();){var r=e.next();if(r.coord.equals(t))return!0}return!1};ri.prototype.interfaces_=function(){return[]};ri.prototype.getClass=function(){return ri};var Ds=function(){};Ds.prototype.getChainStartIndices=function(t){var e=this,r=0,i=new et;i.add(new Ar(r));do{var s=e.findChainEnd(t,r);i.add(new Ar(s)),r=s}while(r<t.length-1);var o=Ds.toIntArray(i);return o};Ds.prototype.findChainEnd=function(t,e){for(var r=Ot.quadrant(t[e],t[e+1]),i=e+1;i<t.length;){var s=Ot.quadrant(t[i-1],t[i]);if(s!==r)break;i++}return i-1};Ds.prototype.interfaces_=function(){return[]};Ds.prototype.getClass=function(){return Ds};Ds.toIntArray=function(t){for(var e=new Array(t.size()).fill(null),r=0;r<e.length;r++)e[r]=t.get(r).intValue();return e};var Ri=function(){this.e=null,this.pts=null,this.startIndex=null,this.env1=new st,this.env2=new st;var t=arguments[0];this.e=t,this.pts=t.getCoordinates();var e=new Ds;this.startIndex=e.getChainStartIndices(this.pts)};Ri.prototype.getCoordinates=function(){return this.pts};Ri.prototype.getMaxX=function(t){var e=this.pts[this.startIndex[t]].x,r=this.pts[this.startIndex[t+1]].x;return e>r?e:r};Ri.prototype.getMinX=function(t){var e=this.pts[this.startIndex[t]].x,r=this.pts[this.startIndex[t+1]].x;return e<r?e:r};Ri.prototype.computeIntersectsForChain=function(){if(arguments.length===4){var t=arguments[0],e=arguments[1],r=arguments[2],i=arguments[3];this.computeIntersectsForChain(this.startIndex[t],this.startIndex[t+1],e,e.startIndex[r],e.startIndex[r+1],i)}else if(arguments.length===6){var s=arguments[0],o=arguments[1],a=arguments[2],l=arguments[3],c=arguments[4],u=arguments[5],h=this.pts[s],f=this.pts[o],d=a.pts[l],p=a.pts[c];if(o-s===1&&c-l===1)return u.addIntersections(this.e,s,a.e,l),null;if(this.env1.init(h,f),this.env2.init(d,p),!this.env1.intersects(this.env2))return null;var _=Math.trunc((s+o)/2),v=Math.trunc((l+c)/2);s<_&&(l<v&&this.computeIntersectsForChain(s,_,a,l,v,u),v<c&&this.computeIntersectsForChain(s,_,a,v,c,u)),_<o&&(l<v&&this.computeIntersectsForChain(_,o,a,l,v,u),v<c&&this.computeIntersectsForChain(_,o,a,v,c,u))}};Ri.prototype.getStartIndexes=function(){return this.startIndex};Ri.prototype.computeIntersects=function(t,e){for(var r=this,i=0;i<this.startIndex.length-1;i++)for(var s=0;s<t.startIndex.length-1;s++)r.computeIntersectsForChain(i,t,s,e)};Ri.prototype.interfaces_=function(){return[]};Ri.prototype.getClass=function(){return Ri};var Oe=function n(){var t=this;this._depth=Array(2).fill().map(function(){return Array(3)});for(var e=0;e<2;e++)for(var r=0;r<3;r++)t._depth[e][r]=n.NULL_VALUE},cE={NULL_VALUE:{configurable:!0}};Oe.prototype.getDepth=function(t,e){return this._depth[t][e]};Oe.prototype.setDepth=function(t,e,r){this._depth[t][e]=r};Oe.prototype.isNull=function(){var t=this;if(arguments.length===0){for(var e=0;e<2;e++)for(var r=0;r<3;r++)if(t._depth[e][r]!==Oe.NULL_VALUE)return!1;return!0}else if(arguments.length===1){var i=arguments[0];return this._depth[i][1]===Oe.NULL_VALUE}else if(arguments.length===2){var s=arguments[0],o=arguments[1];return this._depth[s][o]===Oe.NULL_VALUE}};Oe.prototype.normalize=function(){for(var t=this,e=0;e<2;e++)if(!t.isNull(e)){var r=t._depth[e][1];t._depth[e][2]<r&&(r=t._depth[e][2]),r<0&&(r=0);for(var i=1;i<3;i++){var s=0;t._depth[e][i]>r&&(s=1),t._depth[e][i]=s}}};Oe.prototype.getDelta=function(t){return this._depth[t][Q.RIGHT]-this._depth[t][Q.LEFT]};Oe.prototype.getLocation=function(t,e){return this._depth[t][e]<=0?j.EXTERIOR:j.INTERIOR};Oe.prototype.toString=function(){return"A: "+this._depth[0][1]+","+this._depth[0][2]+" B: "+this._depth[1][1]+","+this._depth[1][2]};Oe.prototype.add=function(){var t=this;if(arguments.length===1)for(var e=arguments[0],r=0;r<2;r++)for(var i=1;i<3;i++){var s=e.getLocation(r,i);(s===j.EXTERIOR||s===j.INTERIOR)&&(t.isNull(r,i)?t._depth[r][i]=Oe.depthAtLocation(s):t._depth[r][i]+=Oe.depthAtLocation(s))}else if(arguments.length===3){var o=arguments[0],a=arguments[1],l=arguments[2];l===j.INTERIOR&&this._depth[o][a]++}};Oe.prototype.interfaces_=function(){return[]};Oe.prototype.getClass=function(){return Oe};Oe.depthAtLocation=function(t){return t===j.EXTERIOR?0:t===j.INTERIOR?1:Oe.NULL_VALUE};cE.NULL_VALUE.get=function(){return-1};Object.defineProperties(Oe,cE);var eh=function(n){function t(){if(n.call(this),this.pts=null,this._env=null,this.eiList=new ri(this),this._name=null,this._mce=null,this._isIsolated=!0,this._depth=new Oe,this._depthDelta=0,arguments.length===1){var e=arguments[0];t.call(this,e,null)}else if(arguments.length===2){var r=arguments[0],i=arguments[1];this.pts=r,this._label=i}}return n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t,t.prototype.getDepth=function(){return this._depth},t.prototype.getCollapsedEdge=function(){var r=new Array(2).fill(null);r[0]=this.pts[0],r[1]=this.pts[1];var i=new t(r,Mt.toLineLabel(this._label));return i},t.prototype.isIsolated=function(){return this._isIsolated},t.prototype.getCoordinates=function(){return this.pts},t.prototype.setIsolated=function(r){this._isIsolated=r},t.prototype.setName=function(r){this._name=r},t.prototype.equals=function(r){var i=this;if(!(r instanceof t))return!1;var s=r;if(this.pts.length!==s.pts.length)return!1;for(var o=!0,a=!0,l=this.pts.length,c=0;c<this.pts.length;c++)if(i.pts[c].equals2D(s.pts[c])||(o=!1),i.pts[c].equals2D(s.pts[--l])||(a=!1),!o&&!a)return!1;return!0},t.prototype.getCoordinate=function(){if(arguments.length===0)return this.pts.length>0?this.pts[0]:null;if(arguments.length===1){var r=arguments[0];return this.pts[r]}},t.prototype.print=function(r){var i=this;r.print("edge "+this._name+": "),r.print("LINESTRING (");for(var s=0;s<this.pts.length;s++)s>0&&r.print(","),r.print(i.pts[s].x+" "+i.pts[s].y);r.print(")  "+this._label+" "+this._depthDelta)},t.prototype.computeIM=function(r){t.updateIM(this._label,r)},t.prototype.isCollapsed=function(){return!this._label.isArea()||this.pts.length!==3?!1:!!this.pts[0].equals(this.pts[2])},t.prototype.isClosed=function(){return this.pts[0].equals(this.pts[this.pts.length-1])},t.prototype.getMaximumSegmentIndex=function(){return this.pts.length-1},t.prototype.getDepthDelta=function(){return this._depthDelta},t.prototype.getNumPoints=function(){return this.pts.length},t.prototype.printReverse=function(r){var i=this;r.print("edge "+this._name+": ");for(var s=this.pts.length-1;s>=0;s--)r.print(i.pts[s]+" ");r.println("")},t.prototype.getMonotoneChainEdge=function(){return this._mce===null&&(this._mce=new Ri(this)),this._mce},t.prototype.getEnvelope=function(){var r=this;if(this._env===null){this._env=new st;for(var i=0;i<this.pts.length;i++)r._env.expandToInclude(r.pts[i])}return this._env},t.prototype.addIntersection=function(r,i,s,o){var a=new z(r.getIntersection(o)),l=i,c=r.getEdgeDistance(s,o),u=l+1;if(u<this.pts.length){var h=this.pts[u];a.equals2D(h)&&(l=u,c=0)}this.eiList.add(a,l,c)},t.prototype.toString=function(){var r=this,i=new Vr;i.append("edge "+this._name+": "),i.append("LINESTRING (");for(var s=0;s<this.pts.length;s++)s>0&&i.append(","),i.append(r.pts[s].x+" "+r.pts[s].y);return i.append(")  "+this._label+" "+this._depthDelta),i.toString()},t.prototype.isPointwiseEqual=function(r){var i=this;if(this.pts.length!==r.pts.length)return!1;for(var s=0;s<this.pts.length;s++)if(!i.pts[s].equals2D(r.pts[s]))return!1;return!0},t.prototype.setDepthDelta=function(r){this._depthDelta=r},t.prototype.getEdgeIntersectionList=function(){return this.eiList},t.prototype.addIntersections=function(r,i,s){for(var o=this,a=0;a<r.getIntersectionNum();a++)o.addIntersection(r,i,s,a)},t.prototype.interfaces_=function(){return[]},t.prototype.getClass=function(){return t},t.updateIM=function(){if(arguments.length===2){var r=arguments[0],i=arguments[1];i.setAtLeastIfValid(r.getLocation(0,Q.ON),r.getLocation(1,Q.ON),1),r.isArea()&&(i.setAtLeastIfValid(r.getLocation(0,Q.LEFT),r.getLocation(1,Q.LEFT),2),i.setAtLeastIfValid(r.getLocation(0,Q.RIGHT),r.getLocation(1,Q.RIGHT),2))}else return n.prototype.updateIM.apply(this,arguments)},t}(Dn),Ze=function(t){this._workingPrecisionModel=null,this._workingNoder=null,this._geomFact=null,this._graph=null,this._edgeList=new sr,this._bufParams=t||null};Ze.prototype.setWorkingPrecisionModel=function(t){this._workingPrecisionModel=t};Ze.prototype.insertUniqueEdge=function(t){var e=this._edgeList.findEqualEdge(t);if(e!==null){var r=e.getLabel(),i=t.getLabel();e.isPointwiseEqual(t)||(i=new Mt(t.getLabel()),i.flip()),r.merge(i);var s=Ze.depthDelta(i),o=e.getDepthDelta(),a=o+s;e.setDepthDelta(a)}else this._edgeList.add(t),t.setDepthDelta(Ze.depthDelta(t.getLabel()))};Ze.prototype.buildSubgraphs=function(t,e){for(var r=new et,i=t.iterator();i.hasNext();){var s=i.next(),o=s.getRightmostCoordinate(),a=new _o(r),l=a.getDepth(o);s.computeDepth(l),s.findResultEdges(),r.add(s),e.add(s.getDirectedEdges(),s.getNodes())}};Ze.prototype.createSubgraphs=function(t){for(var e=new et,r=t.getNodes().iterator();r.hasNext();){var i=r.next();if(!i.isVisited()){var s=new Qe;s.create(i),e.add(s)}}return ir.sort(e,ir.reverseOrder()),e};Ze.prototype.createEmptyResultGeometry=function(){var t=this._geomFact.createPolygon();return t};Ze.prototype.getNoder=function(t){if(this._workingNoder!==null)return this._workingNoder;var e=new _g,r=new Hs;return r.setPrecisionModel(t),e.setSegmentIntersector(new kn(r)),e};Ze.prototype.buffer=function(t,e){var r=this._workingPrecisionModel;r===null&&(r=t.getPrecisionModel()),this._geomFact=t.getFactory();var i=new un(r,this._bufParams),s=new Xn(t,e,i),o=s.getCurves();if(o.size()<=0)return this.createEmptyResultGeometry();this.computeNodedEdges(o,r),this._graph=new Kt(new lE),this._graph.addEdges(this._edgeList.getEdges());var a=this.createSubgraphs(this._graph),l=new xn(this._geomFact);this.buildSubgraphs(a,l);var c=l.getPolygons();if(c.size()<=0)return this.createEmptyResultGeometry();var u=this._geomFact.buildGeometry(c);return u};Ze.prototype.computeNodedEdges=function(t,e){var r=this,i=this.getNoder(e);i.computeNodes(t);for(var s=i.getNodedSubstrings(),o=s.iterator();o.hasNext();){var a=o.next(),l=a.getCoordinates();if(!(l.length===2&&l[0].equals2D(l[1]))){var c=a.getData(),u=new eh(a.getCoordinates(),new Mt(c));r.insertUniqueEdge(u)}}};Ze.prototype.setNoder=function(t){this._workingNoder=t};Ze.prototype.interfaces_=function(){return[]};Ze.prototype.getClass=function(){return Ze};Ze.depthDelta=function(t){var e=t.getLocation(0,Q.LEFT),r=t.getLocation(0,Q.RIGHT);return e===j.INTERIOR&&r===j.EXTERIOR?1:e===j.EXTERIOR&&r===j.INTERIOR?-1:0};Ze.convertSegStrings=function(t){for(var e=new _t,r=new et;t.hasNext();){var i=t.next(),s=e.createLineString(i.getCoordinates());r.add(s)}return e.buildGeometry(r)};var Qi=function(){if(this._noder=null,this._scaleFactor=null,this._offsetX=null,this._offsetY=null,this._isScaled=!1,arguments.length===2){var t=arguments[0],e=arguments[1];this._noder=t,this._scaleFactor=e,this._offsetX=0,this._offsetY=0,this._isScaled=!this.isIntegerPrecision()}else if(arguments.length===4){var r=arguments[0],i=arguments[1],s=arguments[2],o=arguments[3];this._noder=r,this._scaleFactor=i,this._offsetX=s,this._offsetY=o,this._isScaled=!this.isIntegerPrecision()}};Qi.prototype.rescale=function(){var t=this;if(ct(arguments[0],he))for(var e=arguments[0],r=e.iterator();r.hasNext();){var i=r.next();t.rescale(i.getCoordinates())}else if(arguments[0]instanceof Array){for(var s=arguments[0],o=0;o<s.length;o++)s[o].x=s[o].x/t._scaleFactor+t._offsetX,s[o].y=s[o].y/t._scaleFactor+t._offsetY;s.length===2&&s[0].equals2D(s[1])&&De.out.println(s)}};Qi.prototype.scale=function(){var t=this;if(ct(arguments[0],he)){for(var e=arguments[0],r=new et,i=e.iterator();i.hasNext();){var s=i.next();r.add(new ie(t.scale(s.getCoordinates()),s.getData()))}return r}else if(arguments[0]instanceof Array){for(var o=arguments[0],a=new Array(o.length).fill(null),l=0;l<o.length;l++)a[l]=new z(Math.round((o[l].x-t._offsetX)*t._scaleFactor),Math.round((o[l].y-t._offsetY)*t._scaleFactor),o[l].z);var c=yt.removeRepeatedPoints(a);return c}};Qi.prototype.isIntegerPrecision=function(){return this._scaleFactor===1};Qi.prototype.getNodedSubstrings=function(){var t=this._noder.getNodedSubstrings();return this._isScaled&&this.rescale(t),t};Qi.prototype.computeNodes=function(t){var e=t;this._isScaled&&(e=this.scale(t)),this._noder.computeNodes(e)};Qi.prototype.interfaces_=function(){return[Rs]};Qi.prototype.getClass=function(){return Qi};var kr=function(){this._li=new Hs,this._segStrings=null;var t=arguments[0];this._segStrings=t},uE={fact:{configurable:!0}};kr.prototype.checkEndPtVertexIntersections=function(){var t=this;if(arguments.length===0)for(var e=this._segStrings.iterator();e.hasNext();){var r=e.next(),i=r.getCoordinates();t.checkEndPtVertexIntersections(i[0],t._segStrings),t.checkEndPtVertexIntersections(i[i.length-1],t._segStrings)}else if(arguments.length===2){for(var s=arguments[0],o=arguments[1],a=o.iterator();a.hasNext();)for(var l=a.next(),c=l.getCoordinates(),u=1;u<c.length-1;u++)if(c[u].equals(s))throw new Pi("found endpt/interior pt intersection at index "+u+" :pt "+s)}};kr.prototype.checkInteriorIntersections=function(){var t=this;if(arguments.length===0)for(var e=this._segStrings.iterator();e.hasNext();)for(var r=e.next(),i=this._segStrings.iterator();i.hasNext();){var s=i.next();t.checkInteriorIntersections(r,s)}else if(arguments.length===2)for(var o=arguments[0],a=arguments[1],l=o.getCoordinates(),c=a.getCoordinates(),u=0;u<l.length-1;u++)for(var h=0;h<c.length-1;h++)t.checkInteriorIntersections(o,u,a,h);else if(arguments.length===4){var f=arguments[0],d=arguments[1],p=arguments[2],_=arguments[3];if(f===p&&d===_)return null;var v=f.getCoordinates()[d],E=f.getCoordinates()[d+1],m=p.getCoordinates()[_],g=p.getCoordinates()[_+1];if(this._li.computeIntersection(v,E,m,g),this._li.hasIntersection()&&(this._li.isProper()||this.hasInteriorIntersection(this._li,v,E)||this.hasInteriorIntersection(this._li,m,g)))throw new Pi("found non-noded intersection at "+v+"-"+E+" and "+m+"-"+g)}};kr.prototype.checkValid=function(){this.checkEndPtVertexIntersections(),this.checkInteriorIntersections(),this.checkCollapses()};kr.prototype.checkCollapses=function(){var t=this;if(arguments.length===0)for(var e=this._segStrings.iterator();e.hasNext();){var r=e.next();t.checkCollapses(r)}else if(arguments.length===1)for(var i=arguments[0],s=i.getCoordinates(),o=0;o<s.length-2;o++)t.checkCollapse(s[o],s[o+1],s[o+2])};kr.prototype.hasInteriorIntersection=function(t,e,r){for(var i=0;i<t.getIntersectionNum();i++){var s=t.getIntersection(i);if(!(s.equals(e)||s.equals(r)))return!0}return!1};kr.prototype.checkCollapse=function(t,e,r){if(t.equals(r))throw new Pi("found non-noded collapse at "+kr.fact.createLineString([t,e,r]))};kr.prototype.interfaces_=function(){return[]};kr.prototype.getClass=function(){return kr};uE.fact.get=function(){return new _t};Object.defineProperties(kr,uE);var hn=function(){this._li=null,this._pt=null,this._originalPt=null,this._ptScaled=null,this._p0Scaled=null,this._p1Scaled=null,this._scaleFactor=null,this._minx=null,this._maxx=null,this._miny=null,this._maxy=null,this._corner=new Array(4).fill(null),this._safeEnv=null;var t=arguments[0],e=arguments[1],r=arguments[2];if(this._originalPt=t,this._pt=t,this._scaleFactor=e,this._li=r,e<=0)throw new Xt("Scale factor must be non-zero");e!==1&&(this._pt=new z(this.scale(t.x),this.scale(t.y)),this._p0Scaled=new z,this._p1Scaled=new z),this.initCorners(this._pt)},hE={SAFE_ENV_EXPANSION_FACTOR:{configurable:!0}};hn.prototype.intersectsScaled=function(t,e){var r=Math.min(t.x,e.x),i=Math.max(t.x,e.x),s=Math.min(t.y,e.y),o=Math.max(t.y,e.y),a=this._maxx<r||this._minx>i||this._maxy<s||this._miny>o;if(a)return!1;var l=this.intersectsToleranceSquare(t,e);return mt.isTrue(!(a&&l),"Found bad envelope test"),l};hn.prototype.initCorners=function(t){var e=.5;this._minx=t.x-e,this._maxx=t.x+e,this._miny=t.y-e,this._maxy=t.y+e,this._corner[0]=new z(this._maxx,this._maxy),this._corner[1]=new z(this._minx,this._maxy),this._corner[2]=new z(this._minx,this._miny),this._corner[3]=new z(this._maxx,this._miny)};hn.prototype.intersects=function(t,e){return this._scaleFactor===1?this.intersectsScaled(t,e):(this.copyScaled(t,this._p0Scaled),this.copyScaled(e,this._p1Scaled),this.intersectsScaled(this._p0Scaled,this._p1Scaled))};hn.prototype.scale=function(t){return Math.round(t*this._scaleFactor)};hn.prototype.getCoordinate=function(){return this._originalPt};hn.prototype.copyScaled=function(t,e){e.x=this.scale(t.x),e.y=this.scale(t.y)};hn.prototype.getSafeEnvelope=function(){if(this._safeEnv===null){var t=hn.SAFE_ENV_EXPANSION_FACTOR/this._scaleFactor;this._safeEnv=new st(this._originalPt.x-t,this._originalPt.x+t,this._originalPt.y-t,this._originalPt.y+t)}return this._safeEnv};hn.prototype.intersectsPixelClosure=function(t,e){return this._li.computeIntersection(t,e,this._corner[0],this._corner[1]),!!(this._li.hasIntersection()||(this._li.computeIntersection(t,e,this._corner[1],this._corner[2]),this._li.hasIntersection())||(this._li.computeIntersection(t,e,this._corner[2],this._corner[3]),this._li.hasIntersection())||(this._li.computeIntersection(t,e,this._corner[3],this._corner[0]),this._li.hasIntersection()))};hn.prototype.intersectsToleranceSquare=function(t,e){var r=!1,i=!1;return this._li.computeIntersection(t,e,this._corner[0],this._corner[1]),!!(this._li.isProper()||(this._li.computeIntersection(t,e,this._corner[1],this._corner[2]),this._li.isProper())||(this._li.hasIntersection()&&(r=!0),this._li.computeIntersection(t,e,this._corner[2],this._corner[3]),this._li.isProper())||(this._li.hasIntersection()&&(i=!0),this._li.computeIntersection(t,e,this._corner[3],this._corner[0]),this._li.isProper())||r&&i||t.equals(this._pt)||e.equals(this._pt))};hn.prototype.addSnappedNode=function(t,e){var r=t.getCoordinate(e),i=t.getCoordinate(e+1);return this.intersects(r,i)?(t.addIntersection(this.getCoordinate(),e),!0):!1};hn.prototype.interfaces_=function(){return[]};hn.prototype.getClass=function(){return hn};hE.SAFE_ENV_EXPANSION_FACTOR.get=function(){return .75};Object.defineProperties(hn,hE);var jl=function(){this.tempEnv1=new st,this.selectedSegment=new ot};jl.prototype.select=function(){if(arguments.length!==1){if(arguments.length===2){var t=arguments[0],e=arguments[1];t.getLineSegment(e,this.selectedSegment),this.select(this.selectedSegment)}}};jl.prototype.interfaces_=function(){return[]};jl.prototype.getClass=function(){return jl};var Ma=function(){this._index=null;var t=arguments[0];this._index=t},fE={HotPixelSnapAction:{configurable:!0}};Ma.prototype.snap=function(){if(arguments.length===1){var t=arguments[0];return this.snap(t,null,-1)}else if(arguments.length===3){var e=arguments[0],r=arguments[1],i=arguments[2],s=e.getSafeEnvelope(),o=new dE(e,r,i);return this._index.query(s,{interfaces_:function(){return[Ki]},visitItem:function(a){var l=a;l.select(s,o)}}),o.isNodeAdded()}};Ma.prototype.interfaces_=function(){return[]};Ma.prototype.getClass=function(){return Ma};fE.HotPixelSnapAction.get=function(){return dE};Object.defineProperties(Ma,fE);var dE=function(n){function t(){n.call(this),this._hotPixel=null,this._parentEdge=null,this._hotPixelVertexIndex=null,this._isNodeAdded=!1;var e=arguments[0],r=arguments[1],i=arguments[2];this._hotPixel=e,this._parentEdge=r,this._hotPixelVertexIndex=i}return n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t,t.prototype.isNodeAdded=function(){return this._isNodeAdded},t.prototype.select=function(){if(arguments.length===2){var r=arguments[0],i=arguments[1],s=r.getContext();if(this._parentEdge!==null&&s===this._parentEdge&&i===this._hotPixelVertexIndex)return null;this._isNodeAdded=this._hotPixel.addSnappedNode(s,i)}else return n.prototype.select.apply(this,arguments)},t.prototype.interfaces_=function(){return[]},t.prototype.getClass=function(){return t},t}(jl),yo=function(){this._li=null,this._interiorIntersections=null;var t=arguments[0];this._li=t,this._interiorIntersections=new et};yo.prototype.processIntersections=function(t,e,r,i){var s=this;if(t===r&&e===i)return null;var o=t.getCoordinates()[e],a=t.getCoordinates()[e+1],l=r.getCoordinates()[i],c=r.getCoordinates()[i+1];if(this._li.computeIntersection(o,a,l,c),this._li.hasIntersection()&&this._li.isInteriorIntersection()){for(var u=0;u<this._li.getIntersectionNum();u++)s._interiorIntersections.add(s._li.getIntersection(u));t.addIntersections(this._li,e,0),r.addIntersections(this._li,i,1)}};yo.prototype.isDone=function(){return!1};yo.prototype.getInteriorIntersections=function(){return this._interiorIntersections};yo.prototype.interfaces_=function(){return[Os]};yo.prototype.getClass=function(){return yo};var ii=function(){this._pm=null,this._li=null,this._scaleFactor=null,this._noder=null,this._pointSnapper=null,this._nodedSegStrings=null;var t=arguments[0];this._pm=t,this._li=new Hs,this._li.setPrecisionModel(t),this._scaleFactor=t.getScale()};ii.prototype.checkCorrectness=function(t){var e=ie.getNodedSubstrings(t),r=new kr(e);try{r.checkValid()}catch(i){if(i instanceof Kx)i.printStackTrace();else throw i}finally{}};ii.prototype.getNodedSubstrings=function(){return ie.getNodedSubstrings(this._nodedSegStrings)};ii.prototype.snapRound=function(t,e){var r=this.findInteriorIntersections(t,e);this.computeIntersectionSnaps(r),this.computeVertexSnaps(t)};ii.prototype.findInteriorIntersections=function(t,e){var r=new yo(e);return this._noder.setSegmentIntersector(r),this._noder.computeNodes(t),r.getInteriorIntersections()};ii.prototype.computeVertexSnaps=function(){var t=this;if(ct(arguments[0],he))for(var e=arguments[0],r=e.iterator();r.hasNext();){var i=r.next();t.computeVertexSnaps(i)}else if(arguments[0]instanceof ie)for(var s=arguments[0],o=s.getCoordinates(),a=0;a<o.length;a++){var l=new hn(o[a],t._scaleFactor,t._li),c=t._pointSnapper.snap(l,s,a);c&&s.addIntersection(o[a],a)}};ii.prototype.computeNodes=function(t){this._nodedSegStrings=t,this._noder=new _g,this._pointSnapper=new Ma(this._noder.getIndex()),this.snapRound(t,this._li)};ii.prototype.computeIntersectionSnaps=function(t){for(var e=this,r=t.iterator();r.hasNext();){var i=r.next(),s=new hn(i,e._scaleFactor,e._li);e._pointSnapper.snap(s)}};ii.prototype.interfaces_=function(){return[Rs]};ii.prototype.getClass=function(){return ii};var Ne=function(){if(this._argGeom=null,this._distance=null,this._bufParams=new Ct,this._resultGeometry=null,this._saveException=null,arguments.length===1){var t=arguments[0];this._argGeom=t}else if(arguments.length===2){var e=arguments[0],r=arguments[1];this._argGeom=e,this._bufParams=r}},Ka={CAP_ROUND:{configurable:!0},CAP_BUTT:{configurable:!0},CAP_FLAT:{configurable:!0},CAP_SQUARE:{configurable:!0},MAX_PRECISION_DIGITS:{configurable:!0}};Ne.prototype.bufferFixedPrecision=function(t){var e=new Qi(new ii(new Tt(1)),t.getScale()),r=new Ze(this._bufParams);r.setWorkingPrecisionModel(t),r.setNoder(e),this._resultGeometry=r.buffer(this._argGeom,this._distance)};Ne.prototype.bufferReducedPrecision=function(){var t=this;if(arguments.length===0){for(var e=Ne.MAX_PRECISION_DIGITS;e>=0;e--){try{t.bufferReducedPrecision(e)}catch(o){if(o instanceof Ai)t._saveException=o;else throw o}finally{}if(t._resultGeometry!==null)return null}throw this._saveException}else if(arguments.length===1){var r=arguments[0],i=Ne.precisionScaleFactor(this._argGeom,this._distance,r),s=new Tt(i);this.bufferFixedPrecision(s)}};Ne.prototype.computeGeometry=function(){if(this.bufferOriginalPrecision(),this._resultGeometry!==null)return null;var t=this._argGeom.getFactory().getPrecisionModel();t.getType()===Tt.FIXED?this.bufferFixedPrecision(t):this.bufferReducedPrecision()};Ne.prototype.setQuadrantSegments=function(t){this._bufParams.setQuadrantSegments(t)};Ne.prototype.bufferOriginalPrecision=function(){try{var t=new Ze(this._bufParams);this._resultGeometry=t.buffer(this._argGeom,this._distance)}catch(e){if(e instanceof Pi)this._saveException=e;else throw e}finally{}};Ne.prototype.getResultGeometry=function(t){return this._distance=t,this.computeGeometry(),this._resultGeometry};Ne.prototype.setEndCapStyle=function(t){this._bufParams.setEndCapStyle(t)};Ne.prototype.interfaces_=function(){return[]};Ne.prototype.getClass=function(){return Ne};Ne.bufferOp=function(){if(arguments.length===2){var t=arguments[0],e=arguments[1],r=new Ne(t),i=r.getResultGeometry(e);return i}else if(arguments.length===3){if(Number.isInteger(arguments[2])&&arguments[0]instanceof lt&&typeof arguments[1]=="number"){var s=arguments[0],o=arguments[1],a=arguments[2],l=new Ne(s);l.setQuadrantSegments(a);var c=l.getResultGeometry(o);return c}else if(arguments[2]instanceof Ct&&arguments[0]instanceof lt&&typeof arguments[1]=="number"){var u=arguments[0],h=arguments[1],f=arguments[2],d=new Ne(u,f),p=d.getResultGeometry(h);return p}}else if(arguments.length===4){var _=arguments[0],v=arguments[1],E=arguments[2],m=arguments[3],g=new Ne(_);g.setQuadrantSegments(E),g.setEndCapStyle(m);var y=g.getResultGeometry(v);return y}};Ne.precisionScaleFactor=function(t,e,r){var i=t.getEnvelopeInternal(),s=On.max(Math.abs(i.getMaxX()),Math.abs(i.getMaxY()),Math.abs(i.getMinX()),Math.abs(i.getMinY())),o=e>0?e:0,a=s+2*o,l=Math.trunc(Math.log(a)/Math.log(10)+1),c=r-l,u=Math.pow(10,c);return u};Ka.CAP_ROUND.get=function(){return Ct.CAP_ROUND};Ka.CAP_BUTT.get=function(){return Ct.CAP_FLAT};Ka.CAP_FLAT.get=function(){return Ct.CAP_FLAT};Ka.CAP_SQUARE.get=function(){return Ct.CAP_SQUARE};Ka.MAX_PRECISION_DIGITS.get=function(){return 12};Object.defineProperties(Ne,Ka);var Ge=function(){this._pt=[new z,new z],this._distance=dt.NaN,this._isNull=!0};Ge.prototype.getCoordinates=function(){return this._pt};Ge.prototype.getCoordinate=function(t){return this._pt[t]};Ge.prototype.setMinimum=function(){if(arguments.length===1){var t=arguments[0];this.setMinimum(t._pt[0],t._pt[1])}else if(arguments.length===2){var e=arguments[0],r=arguments[1];if(this._isNull)return this.initialize(e,r),null;var i=e.distance(r);i<this._distance&&this.initialize(e,r,i)}};Ge.prototype.initialize=function(){if(arguments.length===0)this._isNull=!0;else if(arguments.length===2){var t=arguments[0],e=arguments[1];this._pt[0].setCoordinate(t),this._pt[1].setCoordinate(e),this._distance=t.distance(e),this._isNull=!1}else if(arguments.length===3){var r=arguments[0],i=arguments[1],s=arguments[2];this._pt[0].setCoordinate(r),this._pt[1].setCoordinate(i),this._distance=s,this._isNull=!1}};Ge.prototype.getDistance=function(){return this._distance};Ge.prototype.setMaximum=function(){if(arguments.length===1){var t=arguments[0];this.setMaximum(t._pt[0],t._pt[1])}else if(arguments.length===2){var e=arguments[0],r=arguments[1];if(this._isNull)return this.initialize(e,r),null;var i=e.distance(r);i>this._distance&&this.initialize(e,r,i)}};Ge.prototype.interfaces_=function(){return[]};Ge.prototype.getClass=function(){return Ge};var jr=function(){};jr.prototype.interfaces_=function(){return[]};jr.prototype.getClass=function(){return jr};jr.computeDistance=function(){if(arguments[2]instanceof Ge&&arguments[0]instanceof Jt&&arguments[1]instanceof z)for(var t=arguments[0],e=arguments[1],r=arguments[2],i=t.getCoordinates(),s=new ot,o=0;o<i.length-1;o++){s.setCoordinates(i[o],i[o+1]);var a=s.closestPoint(e);r.setMinimum(a,e)}else if(arguments[2]instanceof Ge&&arguments[0]instanceof ge&&arguments[1]instanceof z){var l=arguments[0],c=arguments[1],u=arguments[2];jr.computeDistance(l.getExteriorRing(),c,u);for(var h=0;h<l.getNumInteriorRing();h++)jr.computeDistance(l.getInteriorRingN(h),c,u)}else if(arguments[2]instanceof Ge&&arguments[0]instanceof lt&&arguments[1]instanceof z){var f=arguments[0],d=arguments[1],p=arguments[2];if(f instanceof Jt)jr.computeDistance(f,d,p);else if(f instanceof ge)jr.computeDistance(f,d,p);else if(f instanceof Je)for(var _=f,v=0;v<_.getNumGeometries();v++){var E=_.getGeometryN(v);jr.computeDistance(E,d,p)}else p.setMinimum(f.getCoordinate(),d)}else if(arguments[2]instanceof Ge&&arguments[0]instanceof ot&&arguments[1]instanceof z){var m=arguments[0],g=arguments[1],y=arguments[2],b=m.closestPoint(g);y.setMinimum(b,g)}};var Ls=function(t){this._maxPtDist=new Ge,this._inputGeom=t||null},yg={MaxPointDistanceFilter:{configurable:!0},MaxMidpointDistanceFilter:{configurable:!0}};Ls.prototype.computeMaxMidpointDistance=function(t){var e=new ts(this._inputGeom);t.apply(e),this._maxPtDist.setMaximum(e.getMaxPointDistance())};Ls.prototype.computeMaxVertexDistance=function(t){var e=new vo(this._inputGeom);t.apply(e),this._maxPtDist.setMaximum(e.getMaxPointDistance())};Ls.prototype.findDistance=function(t){return this.computeMaxVertexDistance(t),this.computeMaxMidpointDistance(t),this._maxPtDist.getDistance()};Ls.prototype.getDistancePoints=function(){return this._maxPtDist};Ls.prototype.interfaces_=function(){return[]};Ls.prototype.getClass=function(){return Ls};yg.MaxPointDistanceFilter.get=function(){return vo};yg.MaxMidpointDistanceFilter.get=function(){return ts};Object.defineProperties(Ls,yg);var vo=function(t){this._maxPtDist=new Ge,this._minPtDist=new Ge,this._geom=t||null};vo.prototype.filter=function(t){this._minPtDist.initialize(),jr.computeDistance(this._geom,t,this._minPtDist),this._maxPtDist.setMaximum(this._minPtDist)};vo.prototype.getMaxPointDistance=function(){return this._maxPtDist};vo.prototype.interfaces_=function(){return[Qr]};vo.prototype.getClass=function(){return vo};var ts=function(t){this._maxPtDist=new Ge,this._minPtDist=new Ge,this._geom=t||null};ts.prototype.filter=function(t,e){if(e===0)return null;var r=t.getCoordinate(e-1),i=t.getCoordinate(e),s=new z((r.x+i.x)/2,(r.y+i.y)/2);this._minPtDist.initialize(),jr.computeDistance(this._geom,s,this._minPtDist),this._maxPtDist.setMaximum(this._minPtDist)};ts.prototype.isDone=function(){return!1};ts.prototype.isGeometryChanged=function(){return!1};ts.prototype.getMaxPointDistance=function(){return this._maxPtDist};ts.prototype.interfaces_=function(){return[nr]};ts.prototype.getClass=function(){return ts};var wi=function(t){this._comps=t||null};wi.prototype.filter=function(t){t instanceof ge&&this._comps.add(t)};wi.prototype.interfaces_=function(){return[Rr]};wi.prototype.getClass=function(){return wi};wi.getPolygons=function(){if(arguments.length===1){var t=arguments[0];return wi.getPolygons(t,new et)}else if(arguments.length===2){var e=arguments[0],r=arguments[1];return e instanceof ge?r.add(e):e instanceof Je&&e.apply(new wi(r)),r}};var Ae=function(){if(this._lines=null,this._isForcedToLineString=!1,arguments.length===1){var t=arguments[0];this._lines=t}else if(arguments.length===2){var e=arguments[0],r=arguments[1];this._lines=e,this._isForcedToLineString=r}};Ae.prototype.filter=function(t){if(this._isForcedToLineString&&t instanceof ti){var e=t.getFactory().createLineString(t.getCoordinateSequence());return this._lines.add(e),null}t instanceof Jt&&this._lines.add(t)};Ae.prototype.setForceToLineString=function(t){this._isForcedToLineString=t};Ae.prototype.interfaces_=function(){return[Ii]};Ae.prototype.getClass=function(){return Ae};Ae.getGeometry=function(){if(arguments.length===1){var t=arguments[0];return t.getFactory().buildGeometry(Ae.getLines(t))}else if(arguments.length===2){var e=arguments[0],r=arguments[1];return e.getFactory().buildGeometry(Ae.getLines(e,r))}};Ae.getLines=function(){if(arguments.length===1){var t=arguments[0];return Ae.getLines(t,!1)}else if(arguments.length===2){if(ct(arguments[0],he)&&ct(arguments[1],he)){for(var e=arguments[0],r=arguments[1],i=e.iterator();i.hasNext();){var s=i.next();Ae.getLines(s,r)}return r}else if(arguments[0]instanceof lt&&typeof arguments[1]=="boolean"){var o=arguments[0],a=arguments[1],l=new et;return o.apply(new Ae(l,a)),l}else if(arguments[0]instanceof lt&&ct(arguments[1],he)){var c=arguments[0],u=arguments[1];return c instanceof Jt?u.add(c):c.apply(new Ae(u)),u}}else if(arguments.length===3){if(typeof arguments[2]=="boolean"&&ct(arguments[0],he)&&ct(arguments[1],he)){for(var h=arguments[0],f=arguments[1],d=arguments[2],p=h.iterator();p.hasNext();){var _=p.next();Ae.getLines(_,f,d)}return f}else if(typeof arguments[2]=="boolean"&&arguments[0]instanceof lt&&ct(arguments[1],he)){var v=arguments[0],E=arguments[1],m=arguments[2];return v.apply(new Ae(E,m)),E}}};var or=function(){if(this._boundaryRule=jn.OGC_SFS_BOUNDARY_RULE,this._isIn=null,this._numBoundaries=null,arguments.length!==0){if(arguments.length===1){var t=arguments[0];if(t===null)throw new Xt("Rule must be non-null");this._boundaryRule=t}}};or.prototype.locateInternal=function(){var t=this;if(arguments[0]instanceof z&&arguments[1]instanceof ge){var e=arguments[0],r=arguments[1];if(r.isEmpty())return j.EXTERIOR;var i=r.getExteriorRing(),s=this.locateInPolygonRing(e,i);if(s===j.EXTERIOR)return j.EXTERIOR;if(s===j.BOUNDARY)return j.BOUNDARY;for(var o=0;o<r.getNumInteriorRing();o++){var a=r.getInteriorRingN(o),l=t.locateInPolygonRing(e,a);if(l===j.INTERIOR)return j.EXTERIOR;if(l===j.BOUNDARY)return j.BOUNDARY}return j.INTERIOR}else if(arguments[0]instanceof z&&arguments[1]instanceof Jt){var c=arguments[0],u=arguments[1];if(!u.getEnvelopeInternal().intersects(c))return j.EXTERIOR;var h=u.getCoordinates();return!u.isClosed()&&(c.equals(h[0])||c.equals(h[h.length-1]))?j.BOUNDARY:rt.isOnLine(c,h)?j.INTERIOR:j.EXTERIOR}else if(arguments[0]instanceof z&&arguments[1]instanceof bn){var f=arguments[0],d=arguments[1],p=d.getCoordinate();return p.equals2D(f)?j.INTERIOR:j.EXTERIOR}};or.prototype.locateInPolygonRing=function(t,e){return e.getEnvelopeInternal().intersects(t)?rt.locatePointInRing(t,e.getCoordinates()):j.EXTERIOR};or.prototype.intersects=function(t,e){return this.locate(t,e)!==j.EXTERIOR};or.prototype.updateLocationInfo=function(t){t===j.INTERIOR&&(this._isIn=!0),t===j.BOUNDARY&&this._numBoundaries++};or.prototype.computeLocation=function(t,e){var r=this;if(e instanceof bn&&this.updateLocationInfo(this.locateInternal(t,e)),e instanceof Jt)this.updateLocationInfo(this.locateInternal(t,e));else if(e instanceof ge)this.updateLocationInfo(this.locateInternal(t,e));else if(e instanceof Ms)for(var i=e,s=0;s<i.getNumGeometries();s++){var o=i.getGeometryN(s);r.updateLocationInfo(r.locateInternal(t,o))}else if(e instanceof Kr)for(var a=e,l=0;l<a.getNumGeometries();l++){var c=a.getGeometryN(l);r.updateLocationInfo(r.locateInternal(t,c))}else if(e instanceof Je)for(var u=new Zr(e);u.hasNext();){var h=u.next();h!==e&&r.computeLocation(t,h)}};or.prototype.locate=function(t,e){return e.isEmpty()?j.EXTERIOR:e instanceof Jt?this.locateInternal(t,e):e instanceof ge?this.locateInternal(t,e):(this._isIn=!1,this._numBoundaries=0,this.computeLocation(t,e),this._boundaryRule.isInBoundary(this._numBoundaries)?j.BOUNDARY:this._numBoundaries>0||this._isIn?j.INTERIOR:j.EXTERIOR)};or.prototype.interfaces_=function(){return[]};or.prototype.getClass=function(){return or};var Ye=function n(){if(this._component=null,this._segIndex=null,this._pt=null,arguments.length===2){var t=arguments[0],e=arguments[1];n.call(this,t,n.INSIDE_AREA,e)}else if(arguments.length===3){var r=arguments[0],i=arguments[1],s=arguments[2];this._component=r,this._segIndex=i,this._pt=s}},pE={INSIDE_AREA:{configurable:!0}};Ye.prototype.isInsideArea=function(){return this._segIndex===Ye.INSIDE_AREA};Ye.prototype.getCoordinate=function(){return this._pt};Ye.prototype.getGeometryComponent=function(){return this._component};Ye.prototype.getSegmentIndex=function(){return this._segIndex};Ye.prototype.interfaces_=function(){return[]};Ye.prototype.getClass=function(){return Ye};pE.INSIDE_AREA.get=function(){return-1};Object.defineProperties(Ye,pE);var ji=function(t){this._pts=t||null};ji.prototype.filter=function(t){t instanceof bn&&this._pts.add(t)};ji.prototype.interfaces_=function(){return[Rr]};ji.prototype.getClass=function(){return ji};ji.getPoints=function(){if(arguments.length===1){var t=arguments[0];return t instanceof bn?ir.singletonList(t):ji.getPoints(t,new et)}else if(arguments.length===2){var e=arguments[0],r=arguments[1];return e instanceof bn?r.add(e):e instanceof Je&&e.apply(new ji(r)),r}};var bo=function(){this._locations=null;var t=arguments[0];this._locations=t};bo.prototype.filter=function(t){(t instanceof bn||t instanceof Jt||t instanceof ge)&&this._locations.add(new Ye(t,0,t.getCoordinate()))};bo.prototype.interfaces_=function(){return[Rr]};bo.prototype.getClass=function(){return bo};bo.getLocations=function(t){var e=new et;return t.apply(new bo(e)),e};var Le=function(){if(this._geom=null,this._terminateDistance=0,this._ptLocator=new or,this._minDistanceLocation=null,this._minDistance=dt.MAX_VALUE,arguments.length===2){var t=arguments[0],e=arguments[1];this._geom=[t,e],this._terminateDistance=0}else if(arguments.length===3){var r=arguments[0],i=arguments[1],s=arguments[2];this._geom=new Array(2).fill(null),this._geom[0]=r,this._geom[1]=i,this._terminateDistance=s}};Le.prototype.computeContainmentDistance=function(){var t=this;if(arguments.length===0){var e=new Array(2).fill(null);if(this.computeContainmentDistance(0,e),this._minDistance<=this._terminateDistance)return null;this.computeContainmentDistance(1,e)}else if(arguments.length===2){var r=arguments[0],i=arguments[1],s=1-r,o=wi.getPolygons(this._geom[r]);if(o.size()>0){var a=bo.getLocations(this._geom[s]);if(this.computeContainmentDistance(a,o,i),this._minDistance<=this._terminateDistance)return this._minDistanceLocation[s]=i[0],this._minDistanceLocation[r]=i[1],null}}else if(arguments.length===3){if(arguments[2]instanceof Array&&ct(arguments[0],tr)&&ct(arguments[1],tr)){for(var l=arguments[0],c=arguments[1],u=arguments[2],h=0;h<l.size();h++)for(var f=l.get(h),d=0;d<c.size();d++)if(t.computeContainmentDistance(f,c.get(d),u),t._minDistance<=t._terminateDistance)return null}else if(arguments[2]instanceof Array&&arguments[0]instanceof Ye&&arguments[1]instanceof ge){var p=arguments[0],_=arguments[1],v=arguments[2],E=p.getCoordinate();if(j.EXTERIOR!==this._ptLocator.locate(E,_))return this._minDistance=0,v[0]=p,v[1]=new Ye(_,E),null}}};Le.prototype.computeMinDistanceLinesPoints=function(t,e,r){for(var i=this,s=0;s<t.size();s++)for(var o=t.get(s),a=0;a<e.size();a++){var l=e.get(a);if(i.computeMinDistance(o,l,r),i._minDistance<=i._terminateDistance)return null}};Le.prototype.computeFacetDistance=function(){var t=new Array(2).fill(null),e=Ae.getLines(this._geom[0]),r=Ae.getLines(this._geom[1]),i=ji.getPoints(this._geom[0]),s=ji.getPoints(this._geom[1]);if(this.computeMinDistanceLines(e,r,t),this.updateMinDistance(t,!1),this._minDistance<=this._terminateDistance||(t[0]=null,t[1]=null,this.computeMinDistanceLinesPoints(e,s,t),this.updateMinDistance(t,!1),this._minDistance<=this._terminateDistance)||(t[0]=null,t[1]=null,this.computeMinDistanceLinesPoints(r,i,t),this.updateMinDistance(t,!0),this._minDistance<=this._terminateDistance))return null;t[0]=null,t[1]=null,this.computeMinDistancePoints(i,s,t),this.updateMinDistance(t,!1)};Le.prototype.nearestLocations=function(){return this.computeMinDistance(),this._minDistanceLocation};Le.prototype.updateMinDistance=function(t,e){if(t[0]===null)return null;e?(this._minDistanceLocation[0]=t[1],this._minDistanceLocation[1]=t[0]):(this._minDistanceLocation[0]=t[0],this._minDistanceLocation[1]=t[1])};Le.prototype.nearestPoints=function(){this.computeMinDistance();var t=[this._minDistanceLocation[0].getCoordinate(),this._minDistanceLocation[1].getCoordinate()];return t};Le.prototype.computeMinDistance=function(){var t=this;if(arguments.length===0){if(this._minDistanceLocation!==null||(this._minDistanceLocation=new Array(2).fill(null),this.computeContainmentDistance(),this._minDistance<=this._terminateDistance))return null;this.computeFacetDistance()}else if(arguments.length===3){if(arguments[2]instanceof Array&&arguments[0]instanceof Jt&&arguments[1]instanceof bn){var e=arguments[0],r=arguments[1],i=arguments[2];if(e.getEnvelopeInternal().distance(r.getEnvelopeInternal())>this._minDistance)return null;for(var s=e.getCoordinates(),o=r.getCoordinate(),a=0;a<s.length-1;a++){var l=rt.distancePointLine(o,s[a],s[a+1]);if(l<t._minDistance){t._minDistance=l;var c=new ot(s[a],s[a+1]),u=c.closestPoint(o);i[0]=new Ye(e,a,u),i[1]=new Ye(r,0,o)}if(t._minDistance<=t._terminateDistance)return null}}else if(arguments[2]instanceof Array&&arguments[0]instanceof Jt&&arguments[1]instanceof Jt){var h=arguments[0],f=arguments[1],d=arguments[2];if(h.getEnvelopeInternal().distance(f.getEnvelopeInternal())>this._minDistance)return null;for(var p=h.getCoordinates(),_=f.getCoordinates(),v=0;v<p.length-1;v++)for(var E=0;E<_.length-1;E++){var m=rt.distanceLineLine(p[v],p[v+1],_[E],_[E+1]);if(m<t._minDistance){t._minDistance=m;var g=new ot(p[v],p[v+1]),y=new ot(_[E],_[E+1]),b=g.closestPoints(y);d[0]=new Ye(h,v,b[0]),d[1]=new Ye(f,E,b[1])}if(t._minDistance<=t._terminateDistance)return null}}}};Le.prototype.computeMinDistancePoints=function(t,e,r){for(var i=this,s=0;s<t.size();s++)for(var o=t.get(s),a=0;a<e.size();a++){var l=e.get(a),c=o.getCoordinate().distance(l.getCoordinate());if(c<i._minDistance&&(i._minDistance=c,r[0]=new Ye(o,0,o.getCoordinate()),r[1]=new Ye(l,0,l.getCoordinate())),i._minDistance<=i._terminateDistance)return null}};Le.prototype.distance=function(){if(this._geom[0]===null||this._geom[1]===null)throw new Xt("null geometries are not supported");return this._geom[0].isEmpty()||this._geom[1].isEmpty()?0:(this.computeMinDistance(),this._minDistance)};Le.prototype.computeMinDistanceLines=function(t,e,r){for(var i=this,s=0;s<t.size();s++)for(var o=t.get(s),a=0;a<e.size();a++){var l=e.get(a);if(i.computeMinDistance(o,l,r),i._minDistance<=i._terminateDistance)return null}};Le.prototype.interfaces_=function(){return[]};Le.prototype.getClass=function(){return Le};Le.distance=function(t,e){var r=new Le(t,e);return r.distance()};Le.isWithinDistance=function(t,e,r){var i=new Le(t,e,r);return i.distance()<=r};Le.nearestPoints=function(t,e){var r=new Le(t,e);return r.nearestPoints()};var ze=function(){this._pt=[new z,new z],this._distance=dt.NaN,this._isNull=!0};ze.prototype.getCoordinates=function(){return this._pt};ze.prototype.getCoordinate=function(t){return this._pt[t]};ze.prototype.setMinimum=function(){if(arguments.length===1){var t=arguments[0];this.setMinimum(t._pt[0],t._pt[1])}else if(arguments.length===2){var e=arguments[0],r=arguments[1];if(this._isNull)return this.initialize(e,r),null;var i=e.distance(r);i<this._distance&&this.initialize(e,r,i)}};ze.prototype.initialize=function(){if(arguments.length===0)this._isNull=!0;else if(arguments.length===2){var t=arguments[0],e=arguments[1];this._pt[0].setCoordinate(t),this._pt[1].setCoordinate(e),this._distance=t.distance(e),this._isNull=!1}else if(arguments.length===3){var r=arguments[0],i=arguments[1],s=arguments[2];this._pt[0].setCoordinate(r),this._pt[1].setCoordinate(i),this._distance=s,this._isNull=!1}};ze.prototype.toString=function(){return er.toLineString(this._pt[0],this._pt[1])};ze.prototype.getDistance=function(){return this._distance};ze.prototype.setMaximum=function(){if(arguments.length===1){var t=arguments[0];this.setMaximum(t._pt[0],t._pt[1])}else if(arguments.length===2){var e=arguments[0],r=arguments[1];if(this._isNull)return this.initialize(e,r),null;var i=e.distance(r);i>this._distance&&this.initialize(e,r,i)}};ze.prototype.interfaces_=function(){return[]};ze.prototype.getClass=function(){return ze};var vr=function(){};vr.prototype.interfaces_=function(){return[]};vr.prototype.getClass=function(){return vr};vr.computeDistance=function(){if(arguments[2]instanceof ze&&arguments[0]instanceof Jt&&arguments[1]instanceof z)for(var t=arguments[0],e=arguments[1],r=arguments[2],i=new ot,s=t.getCoordinates(),o=0;o<s.length-1;o++){i.setCoordinates(s[o],s[o+1]);var a=i.closestPoint(e);r.setMinimum(a,e)}else if(arguments[2]instanceof ze&&arguments[0]instanceof ge&&arguments[1]instanceof z){var l=arguments[0],c=arguments[1],u=arguments[2];vr.computeDistance(l.getExteriorRing(),c,u);for(var h=0;h<l.getNumInteriorRing();h++)vr.computeDistance(l.getInteriorRingN(h),c,u)}else if(arguments[2]instanceof ze&&arguments[0]instanceof lt&&arguments[1]instanceof z){var f=arguments[0],d=arguments[1],p=arguments[2];if(f instanceof Jt)vr.computeDistance(f,d,p);else if(f instanceof ge)vr.computeDistance(f,d,p);else if(f instanceof Je)for(var _=f,v=0;v<_.getNumGeometries();v++){var E=_.getGeometryN(v);vr.computeDistance(E,d,p)}else p.setMinimum(f.getCoordinate(),d)}else if(arguments[2]instanceof ze&&arguments[0]instanceof ot&&arguments[1]instanceof z){var m=arguments[0],g=arguments[1],y=arguments[2],b=m.closestPoint(g);y.setMinimum(b,g)}};var Hn=function(){this._g0=null,this._g1=null,this._ptDist=new ze,this._densifyFrac=0;var t=arguments[0],e=arguments[1];this._g0=t,this._g1=e},vg={MaxPointDistanceFilter:{configurable:!0},MaxDensifiedByFractionDistanceFilter:{configurable:!0}};Hn.prototype.getCoordinates=function(){return this._ptDist.getCoordinates()};Hn.prototype.setDensifyFraction=function(t){if(t>1||t<=0)throw new Xt("Fraction is not in range (0.0 - 1.0]");this._densifyFrac=t};Hn.prototype.compute=function(t,e){this.computeOrientedDistance(t,e,this._ptDist),this.computeOrientedDistance(e,t,this._ptDist)};Hn.prototype.distance=function(){return this.compute(this._g0,this._g1),this._ptDist.getDistance()};Hn.prototype.computeOrientedDistance=function(t,e,r){var i=new xo(e);if(t.apply(i),r.setMaximum(i.getMaxPointDistance()),this._densifyFrac>0){var s=new es(e,this._densifyFrac);t.apply(s),r.setMaximum(s.getMaxPointDistance())}};Hn.prototype.orientedDistance=function(){return this.computeOrientedDistance(this._g0,this._g1,this._ptDist),this._ptDist.getDistance()};Hn.prototype.interfaces_=function(){return[]};Hn.prototype.getClass=function(){return Hn};Hn.distance=function(){if(arguments.length===2){var t=arguments[0],e=arguments[1],r=new Hn(t,e);return r.distance()}else if(arguments.length===3){var i=arguments[0],s=arguments[1],o=arguments[2],a=new Hn(i,s);return a.setDensifyFraction(o),a.distance()}};vg.MaxPointDistanceFilter.get=function(){return xo};vg.MaxDensifiedByFractionDistanceFilter.get=function(){return es};Object.defineProperties(Hn,vg);var xo=function(){this._maxPtDist=new ze,this._minPtDist=new ze,this._euclideanDist=new vr,this._geom=null;var t=arguments[0];this._geom=t};xo.prototype.filter=function(t){this._minPtDist.initialize(),vr.computeDistance(this._geom,t,this._minPtDist),this._maxPtDist.setMaximum(this._minPtDist)};xo.prototype.getMaxPointDistance=function(){return this._maxPtDist};xo.prototype.interfaces_=function(){return[Qr]};xo.prototype.getClass=function(){return xo};var es=function(){this._maxPtDist=new ze,this._minPtDist=new ze,this._geom=null,this._numSubSegs=0;var t=arguments[0],e=arguments[1];this._geom=t,this._numSubSegs=Math.trunc(Math.round(1/e))};es.prototype.filter=function(t,e){var r=this;if(e===0)return null;for(var i=t.getCoordinate(e-1),s=t.getCoordinate(e),o=(s.x-i.x)/this._numSubSegs,a=(s.y-i.y)/this._numSubSegs,l=0;l<this._numSubSegs;l++){var c=i.x+l*o,u=i.y+l*a,h=new z(c,u);r._minPtDist.initialize(),vr.computeDistance(r._geom,h,r._minPtDist),r._maxPtDist.setMaximum(r._minPtDist)}};es.prototype.isDone=function(){return!1};es.prototype.isGeometryChanged=function(){return!1};es.prototype.getMaxPointDistance=function(){return this._maxPtDist};es.prototype.interfaces_=function(){return[nr]};es.prototype.getClass=function(){return es};var vn=function(t,e,r){this._minValidDistance=null,this._maxValidDistance=null,this._minDistanceFound=null,this._maxDistanceFound=null,this._isValid=!0,this._errMsg=null,this._errorLocation=null,this._errorIndicator=null,this._input=t||null,this._bufDistance=e||null,this._result=r||null},bg={VERBOSE:{configurable:!0},MAX_DISTANCE_DIFF_FRAC:{configurable:!0}};vn.prototype.checkMaximumDistance=function(t,e,r){var i=new Hn(e,t);if(i.setDensifyFraction(.25),this._maxDistanceFound=i.orientedDistance(),this._maxDistanceFound>r){this._isValid=!1;var s=i.getCoordinates();this._errorLocation=s[1],this._errorIndicator=t.getFactory().createLineString(s),this._errMsg="Distance between buffer curve and input is too large ("+this._maxDistanceFound+" at "+er.toLineString(s[0],s[1])+")"}};vn.prototype.isValid=function(){var t=Math.abs(this._bufDistance),e=vn.MAX_DISTANCE_DIFF_FRAC*t;return this._minValidDistance=t-e,this._maxValidDistance=t+e,this._input.isEmpty()||this._result.isEmpty()?!0:(this._bufDistance>0?this.checkPositiveValid():this.checkNegativeValid(),vn.VERBOSE&&De.out.println("Min Dist= "+this._minDistanceFound+"  err= "+(1-this._minDistanceFound/this._bufDistance)+"  Max Dist= "+this._maxDistanceFound+"  err= "+(this._maxDistanceFound/this._bufDistance-1)),this._isValid)};vn.prototype.checkNegativeValid=function(){if(!(this._input instanceof ge||this._input instanceof Kr||this._input instanceof Je))return null;var t=this.getPolygonLines(this._input);if(this.checkMinimumDistance(t,this._result,this._minValidDistance),!this._isValid)return null;this.checkMaximumDistance(t,this._result,this._maxValidDistance)};vn.prototype.getErrorIndicator=function(){return this._errorIndicator};vn.prototype.checkMinimumDistance=function(t,e,r){var i=new Le(t,e,r);if(this._minDistanceFound=i.distance(),this._minDistanceFound<r){this._isValid=!1;var s=i.nearestPoints();this._errorLocation=i.nearestPoints()[1],this._errorIndicator=t.getFactory().createLineString(s),this._errMsg="Distance between buffer curve and input is too small ("+this._minDistanceFound+" at "+er.toLineString(s[0],s[1])+" )"}};vn.prototype.checkPositiveValid=function(){var t=this._result.getBoundary();if(this.checkMinimumDistance(this._input,t,this._minValidDistance),!this._isValid)return null;this.checkMaximumDistance(this._input,t,this._maxValidDistance)};vn.prototype.getErrorLocation=function(){return this._errorLocation};vn.prototype.getPolygonLines=function(t){for(var e=new et,r=new Ae(e),i=wi.getPolygons(t),s=i.iterator();s.hasNext();){var o=s.next();o.apply(r)}return t.getFactory().buildGeometry(e)};vn.prototype.getErrorMessage=function(){return this._errMsg};vn.prototype.interfaces_=function(){return[]};vn.prototype.getClass=function(){return vn};bg.VERBOSE.get=function(){return!1};bg.MAX_DISTANCE_DIFF_FRAC.get=function(){return .012};Object.defineProperties(vn,bg);var ke=function(t,e,r){this._isValid=!0,this._errorMsg=null,this._errorLocation=null,this._errorIndicator=null,this._input=t||null,this._distance=e||null,this._result=r||null},xg={VERBOSE:{configurable:!0},MAX_ENV_DIFF_FRAC:{configurable:!0}};ke.prototype.isValid=function(){return this.checkPolygonal(),this._isValid?(this.checkExpectedEmpty(),this._isValid?(this.checkEnvelope(),this._isValid?(this.checkArea(),this._isValid?(this.checkDistance(),this._isValid):this._isValid):this._isValid):this._isValid):this._isValid};ke.prototype.checkEnvelope=function(){if(this._distance<0)return null;var t=this._distance*ke.MAX_ENV_DIFF_FRAC;t===0&&(t=.001);var e=new st(this._input.getEnvelopeInternal());e.expandBy(this._distance);var r=new st(this._result.getEnvelopeInternal());r.expandBy(t),r.contains(e)||(this._isValid=!1,this._errorMsg="Buffer envelope is incorrect",this._errorIndicator=this._input.getFactory().toGeometry(r)),this.report("Envelope")};ke.prototype.checkDistance=function(){var t=new vn(this._input,this._distance,this._result);t.isValid()||(this._isValid=!1,this._errorMsg=t.getErrorMessage(),this._errorLocation=t.getErrorLocation(),this._errorIndicator=t.getErrorIndicator()),this.report("Distance")};ke.prototype.checkArea=function(){var t=this._input.getArea(),e=this._result.getArea();this._distance>0&&t>e&&(this._isValid=!1,this._errorMsg="Area of positive buffer is smaller than input",this._errorIndicator=this._result),this._distance<0&&t<e&&(this._isValid=!1,this._errorMsg="Area of negative buffer is larger than input",this._errorIndicator=this._result),this.report("Area")};ke.prototype.checkPolygonal=function(){this._result instanceof ge||this._result instanceof Kr||(this._isValid=!1),this._errorMsg="Result is not polygonal",this._errorIndicator=this._result,this.report("Polygonal")};ke.prototype.getErrorIndicator=function(){return this._errorIndicator};ke.prototype.getErrorLocation=function(){return this._errorLocation};ke.prototype.checkExpectedEmpty=function(){if(this._input.getDimension()>=2||this._distance>0)return null;this._result.isEmpty()||(this._isValid=!1,this._errorMsg="Result is non-empty",this._errorIndicator=this._result),this.report("ExpectedEmpty")};ke.prototype.report=function(t){if(!ke.VERBOSE)return null;De.out.println("Check "+t+": "+(this._isValid?"passed":"FAILED"))};ke.prototype.getErrorMessage=function(){return this._errorMsg};ke.prototype.interfaces_=function(){return[]};ke.prototype.getClass=function(){return ke};ke.isValidMsg=function(t,e,r){var i=new ke(t,e,r);return i.isValid()?null:i.getErrorMessage()};ke.isValid=function(t,e,r){var i=new ke(t,e,r);return!!i.isValid()};xg.VERBOSE.get=function(){return!1};xg.MAX_ENV_DIFF_FRAC.get=function(){return .012};Object.defineProperties(ke,xg);var Fr=function(){this._pts=null,this._data=null;var t=arguments[0],e=arguments[1];this._pts=t,this._data=e};Fr.prototype.getCoordinates=function(){return this._pts};Fr.prototype.size=function(){return this._pts.length};Fr.prototype.getCoordinate=function(t){return this._pts[t]};Fr.prototype.isClosed=function(){return this._pts[0].equals(this._pts[this._pts.length-1])};Fr.prototype.getSegmentOctant=function(t){return t===this._pts.length-1?-1:mo.octant(this.getCoordinate(t),this.getCoordinate(t+1))};Fr.prototype.setData=function(t){this._data=t};Fr.prototype.getData=function(){return this._data};Fr.prototype.toString=function(){return er.toLineString(new ee(this._pts))};Fr.prototype.interfaces_=function(){return[ni]};Fr.prototype.getClass=function(){return Fr};var xe=function(){this._findAllIntersections=!1,this._isCheckEndSegmentsOnly=!1,this._li=null,this._interiorIntersection=null,this._intSegments=null,this._intersections=new et,this._intersectionCount=0,this._keepIntersections=!0;var t=arguments[0];this._li=t,this._interiorIntersection=null};xe.prototype.getInteriorIntersection=function(){return this._interiorIntersection};xe.prototype.setCheckEndSegmentsOnly=function(t){this._isCheckEndSegmentsOnly=t};xe.prototype.getIntersectionSegments=function(){return this._intSegments};xe.prototype.count=function(){return this._intersectionCount};xe.prototype.getIntersections=function(){return this._intersections};xe.prototype.setFindAllIntersections=function(t){this._findAllIntersections=t};xe.prototype.setKeepIntersections=function(t){this._keepIntersections=t};xe.prototype.processIntersections=function(t,e,r,i){if(!this._findAllIntersections&&this.hasIntersection()||t===r&&e===i)return null;if(this._isCheckEndSegmentsOnly){var s=this.isEndSegment(t,e)||this.isEndSegment(r,i);if(!s)return null}var o=t.getCoordinates()[e],a=t.getCoordinates()[e+1],l=r.getCoordinates()[i],c=r.getCoordinates()[i+1];this._li.computeIntersection(o,a,l,c),this._li.hasIntersection()&&this._li.isInteriorIntersection()&&(this._intSegments=new Array(4).fill(null),this._intSegments[0]=o,this._intSegments[1]=a,this._intSegments[2]=l,this._intSegments[3]=c,this._interiorIntersection=this._li.getIntersection(0),this._keepIntersections&&this._intersections.add(this._interiorIntersection),this._intersectionCount++)};xe.prototype.isEndSegment=function(t,e){return e===0||e>=t.size()-2};xe.prototype.hasIntersection=function(){return this._interiorIntersection!==null};xe.prototype.isDone=function(){return this._findAllIntersections?!1:this._interiorIntersection!==null};xe.prototype.interfaces_=function(){return[Os]};xe.prototype.getClass=function(){return xe};xe.createAllIntersectionsFinder=function(t){var e=new xe(t);return e.setFindAllIntersections(!0),e};xe.createAnyIntersectionFinder=function(t){return new xe(t)};xe.createIntersectionCounter=function(t){var e=new xe(t);return e.setFindAllIntersections(!0),e.setKeepIntersections(!1),e};var ar=function(){this._li=new Hs,this._segStrings=null,this._findAllIntersections=!1,this._segInt=null,this._isValid=!0;var t=arguments[0];this._segStrings=t};ar.prototype.execute=function(){if(this._segInt!==null)return null;this.checkInteriorIntersections()};ar.prototype.getIntersections=function(){return this._segInt.getIntersections()};ar.prototype.isValid=function(){return this.execute(),this._isValid};ar.prototype.setFindAllIntersections=function(t){this._findAllIntersections=t};ar.prototype.checkInteriorIntersections=function(){this._isValid=!0,this._segInt=new xe(this._li),this._segInt.setFindAllIntersections(this._findAllIntersections);var t=new _g;if(t.setSegmentIntersector(this._segInt),t.computeNodes(this._segStrings),this._segInt.hasIntersection())return this._isValid=!1,null};ar.prototype.checkValid=function(){if(this.execute(),!this._isValid)throw new Ai(this.getErrorMessage(),this._segInt.getInteriorIntersection())};ar.prototype.getErrorMessage=function(){if(this._isValid)return"no intersections found";var t=this._segInt.getIntersectionSegments();return"found non-noded intersection between "+er.toLineString(t[0],t[1])+" and "+er.toLineString(t[2],t[3])};ar.prototype.interfaces_=function(){return[]};ar.prototype.getClass=function(){return ar};ar.computeIntersections=function(t){var e=new ar(t);return e.setFindAllIntersections(!0),e.isValid(),e.getIntersections()};var ks=function n(){this._nv=null;var t=arguments[0];this._nv=new ar(n.toSegmentStrings(t))};ks.prototype.checkValid=function(){this._nv.checkValid()};ks.prototype.interfaces_=function(){return[]};ks.prototype.getClass=function(){return ks};ks.toSegmentStrings=function(t){for(var e=new et,r=t.iterator();r.hasNext();){var i=r.next();e.add(new Fr(i.getCoordinates(),i))}return e};ks.checkValid=function(t){var e=new ks(t);e.checkValid()};var Eo=function(t){this._mapOp=t};Eo.prototype.map=function(t){for(var e=this,r=new et,i=0;i<t.getNumGeometries();i++){var s=e._mapOp.map(t.getGeometryN(i));s.isEmpty()||r.add(s)}return t.getFactory().createGeometryCollection(_t.toGeometryArray(r))};Eo.prototype.interfaces_=function(){return[]};Eo.prototype.getClass=function(){return Eo};Eo.map=function(t,e){var r=new Eo(e);return r.map(t)};var Br=function(){this._op=null,this._geometryFactory=null,this._ptLocator=null,this._lineEdgesList=new et,this._resultLineList=new et;var t=arguments[0],e=arguments[1],r=arguments[2];this._op=t,this._geometryFactory=e,this._ptLocator=r};Br.prototype.collectLines=function(t){for(var e=this,r=this._op.getGraph().getEdgeEnds().iterator();r.hasNext();){var i=r.next();e.collectLineEdge(i,t,e._lineEdgesList),e.collectBoundaryTouchEdge(i,t,e._lineEdgesList)}};Br.prototype.labelIsolatedLine=function(t,e){var r=this._ptLocator.locate(t.getCoordinate(),this._op.getArgGeometry(e));t.getLabel().setLocation(e,r)};Br.prototype.build=function(t){return this.findCoveredLineEdges(),this.collectLines(t),this.buildLines(t),this._resultLineList};Br.prototype.collectLineEdge=function(t,e,r){var i=t.getLabel(),s=t.getEdge();t.isLineEdge()&&!t.isVisited()&&gt.isResultOfOp(i,e)&&!s.isCovered()&&(r.add(s),t.setVisitedEdge(!0))};Br.prototype.findCoveredLineEdges=function(){for(var t=this,e=this._op.getGraph().getNodes().iterator();e.hasNext();){var r=e.next();r.getEdges().findCoveredLineEdges()}for(var i=this._op.getGraph().getEdgeEnds().iterator();i.hasNext();){var s=i.next(),o=s.getEdge();if(s.isLineEdge()&&!o.isCoveredSet()){var a=t._op.isCoveredByA(s.getCoordinate());o.setCovered(a)}}};Br.prototype.labelIsolatedLines=function(t){for(var e=this,r=t.iterator();r.hasNext();){var i=r.next(),s=i.getLabel();i.isIsolated()&&(s.isNull(0)?e.labelIsolatedLine(i,0):e.labelIsolatedLine(i,1))}};Br.prototype.buildLines=function(t){for(var e=this,r=this._lineEdgesList.iterator();r.hasNext();){var i=r.next(),s=e._geometryFactory.createLineString(i.getCoordinates());e._resultLineList.add(s),i.setInResult(!0)}};Br.prototype.collectBoundaryTouchEdge=function(t,e,r){var i=t.getLabel();if(t.isLineEdge()||t.isVisited()||t.isInteriorAreaEdge()||t.getEdge().isInResult())return null;mt.isTrue(!(t.isInResult()||t.getSym().isInResult())||!t.getEdge().isInResult()),gt.isResultOfOp(i,e)&&e===gt.INTERSECTION&&(r.add(t.getEdge()),t.setVisitedEdge(!0))};Br.prototype.interfaces_=function(){return[]};Br.prototype.getClass=function(){return Br};var wo=function(){this._op=null,this._geometryFactory=null,this._resultPointList=new et;var t=arguments[0],e=arguments[1];this._op=t,this._geometryFactory=e};wo.prototype.filterCoveredNodeToPoint=function(t){var e=t.getCoordinate();if(!this._op.isCoveredByLA(e)){var r=this._geometryFactory.createPoint(e);this._resultPointList.add(r)}};wo.prototype.extractNonCoveredResultNodes=function(t){for(var e=this,r=this._op.getGraph().getNodes().iterator();r.hasNext();){var i=r.next();if(!i.isInResult()&&!i.isIncidentEdgeInResult()&&(i.getEdges().getDegree()===0||t===gt.INTERSECTION)){var s=i.getLabel();gt.isResultOfOp(s,t)&&e.filterCoveredNodeToPoint(i)}}};wo.prototype.build=function(t){return this.extractNonCoveredResultNodes(t),this._resultPointList};wo.prototype.interfaces_=function(){return[]};wo.prototype.getClass=function(){return wo};var fn=function(){this._inputGeom=null,this._factory=null,this._pruneEmptyGeometry=!0,this._preserveGeometryCollectionType=!0,this._preserveCollections=!1,this._preserveType=!1};fn.prototype.transformPoint=function(t,e){return this._factory.createPoint(this.transformCoordinates(t.getCoordinateSequence(),t))};fn.prototype.transformPolygon=function(t,e){var r=this,i=!0,s=this.transformLinearRing(t.getExteriorRing(),t);(s===null||!(s instanceof ti)||s.isEmpty())&&(i=!1);for(var o=new et,a=0;a<t.getNumInteriorRing();a++){var l=r.transformLinearRing(t.getInteriorRingN(a),t);l===null||l.isEmpty()||(l instanceof ti||(i=!1),o.add(l))}if(i)return this._factory.createPolygon(s,o.toArray([]));var c=new et;return s!==null&&c.add(s),c.addAll(o),this._factory.buildGeometry(c)};fn.prototype.createCoordinateSequence=function(t){return this._factory.getCoordinateSequenceFactory().create(t)};fn.prototype.getInputGeometry=function(){return this._inputGeom};fn.prototype.transformMultiLineString=function(t,e){for(var r=this,i=new et,s=0;s<t.getNumGeometries();s++){var o=r.transformLineString(t.getGeometryN(s),t);o!==null&&(o.isEmpty()||i.add(o))}return this._factory.buildGeometry(i)};fn.prototype.transformCoordinates=function(t,e){return this.copy(t)};fn.prototype.transformLineString=function(t,e){return this._factory.createLineString(this.transformCoordinates(t.getCoordinateSequence(),t))};fn.prototype.transformMultiPoint=function(t,e){for(var r=this,i=new et,s=0;s<t.getNumGeometries();s++){var o=r.transformPoint(t.getGeometryN(s),t);o!==null&&(o.isEmpty()||i.add(o))}return this._factory.buildGeometry(i)};fn.prototype.transformMultiPolygon=function(t,e){for(var r=this,i=new et,s=0;s<t.getNumGeometries();s++){var o=r.transformPolygon(t.getGeometryN(s),t);o!==null&&(o.isEmpty()||i.add(o))}return this._factory.buildGeometry(i)};fn.prototype.copy=function(t){return t.copy()};fn.prototype.transformGeometryCollection=function(t,e){for(var r=this,i=new et,s=0;s<t.getNumGeometries();s++){var o=r.transform(t.getGeometryN(s));o!==null&&(r._pruneEmptyGeometry&&o.isEmpty()||i.add(o))}return this._preserveGeometryCollectionType?this._factory.createGeometryCollection(_t.toGeometryArray(i)):this._factory.buildGeometry(i)};fn.prototype.transform=function(t){if(this._inputGeom=t,this._factory=t.getFactory(),t instanceof bn)return this.transformPoint(t,null);if(t instanceof Ca)return this.transformMultiPoint(t,null);if(t instanceof ti)return this.transformLinearRing(t,null);if(t instanceof Jt)return this.transformLineString(t,null);if(t instanceof Ms)return this.transformMultiLineString(t,null);if(t instanceof ge)return this.transformPolygon(t,null);if(t instanceof Kr)return this.transformMultiPolygon(t,null);if(t instanceof Je)return this.transformGeometryCollection(t,null);throw new Xt("Unknown Geometry subtype: "+t.getClass().getName())};fn.prototype.transformLinearRing=function(t,e){var r=this.transformCoordinates(t.getCoordinateSequence(),t);if(r===null)return this._factory.createLinearRing(null);var i=r.size();return i>0&&i<4&&!this._preserveType?this._factory.createLineString(r):this._factory.createLinearRing(r)};fn.prototype.interfaces_=function(){return[]};fn.prototype.getClass=function(){return fn};var si=function n(){if(this._snapTolerance=0,this._srcPts=null,this._seg=new ot,this._allowSnappingToSourceVertices=!1,this._isClosed=!1,arguments[0]instanceof Jt&&typeof arguments[1]=="number"){var t=arguments[0],e=arguments[1];n.call(this,t.getCoordinates(),e)}else if(arguments[0]instanceof Array&&typeof arguments[1]=="number"){var r=arguments[0],i=arguments[1];this._srcPts=r,this._isClosed=n.isClosed(r),this._snapTolerance=i}};si.prototype.snapVertices=function(t,e){for(var r=this,i=this._isClosed?t.size()-1:t.size(),s=0;s<i;s++){var o=t.get(s),a=r.findSnapForVertex(o,e);a!==null&&(t.set(s,new z(a)),s===0&&r._isClosed&&t.set(t.size()-1,new z(a)))}};si.prototype.findSnapForVertex=function(t,e){for(var r=this,i=0;i<e.length;i++){if(t.equals2D(e[i]))return null;if(t.distance(e[i])<r._snapTolerance)return e[i]}return null};si.prototype.snapTo=function(t){var e=new dc(this._srcPts);this.snapVertices(e,t),this.snapSegments(e,t);var r=e.toCoordinateArray();return r};si.prototype.snapSegments=function(t,e){var r=this;if(e.length===0)return null;var i=e.length;e[0].equals2D(e[e.length-1])&&(i=e.length-1);for(var s=0;s<i;s++){var o=e[s],a=r.findSegmentIndexToSnap(o,t);a>=0&&t.add(a+1,new z(o),!1)}};si.prototype.findSegmentIndexToSnap=function(t,e){for(var r=this,i=dt.MAX_VALUE,s=-1,o=0;o<e.size()-1;o++){if(r._seg.p0=e.get(o),r._seg.p1=e.get(o+1),r._seg.p0.equals2D(t)||r._seg.p1.equals2D(t)){if(r._allowSnappingToSourceVertices)continue;return-1}var a=r._seg.distance(t);a<r._snapTolerance&&a<i&&(i=a,s=o)}return s};si.prototype.setAllowSnappingToSourceVertices=function(t){this._allowSnappingToSourceVertices=t};si.prototype.interfaces_=function(){return[]};si.prototype.getClass=function(){return si};si.isClosed=function(t){return t.length<=1?!1:t[0].equals2D(t[t.length-1])};var ne=function(t){this._srcGeom=t||null},gE={SNAP_PRECISION_FACTOR:{configurable:!0}};ne.prototype.snapTo=function(t,e){var r=this.extractTargetCoordinates(t),i=new mE(e,r);return i.transform(this._srcGeom)};ne.prototype.snapToSelf=function(t,e){var r=this.extractTargetCoordinates(this._srcGeom),i=new mE(t,r,!0),s=i.transform(this._srcGeom),o=s;return e&&ct(o,qi)&&(o=s.buffer(0)),o};ne.prototype.computeSnapTolerance=function(t){var e=this.computeMinimumSegmentLength(t),r=e/10;return r};ne.prototype.extractTargetCoordinates=function(t){for(var e=new Mr,r=t.getCoordinates(),i=0;i<r.length;i++)e.add(r[i]);return e.toArray(new Array(0).fill(null))};ne.prototype.computeMinimumSegmentLength=function(t){for(var e=dt.MAX_VALUE,r=0;r<t.length-1;r++){var i=t[r].distance(t[r+1]);i<e&&(e=i)}return e};ne.prototype.interfaces_=function(){return[]};ne.prototype.getClass=function(){return ne};ne.snap=function(t,e,r){var i=new Array(2).fill(null),s=new ne(t);i[0]=s.snapTo(e,r);var o=new ne(e);return i[1]=o.snapTo(i[0],r),i};ne.computeOverlaySnapTolerance=function(){if(arguments.length===1){var t=arguments[0],e=ne.computeSizeBasedSnapTolerance(t),r=t.getPrecisionModel();if(r.getType()===Tt.FIXED){var i=1/r.getScale()*2/1.415;i>e&&(e=i)}return e}else if(arguments.length===2){var s=arguments[0],o=arguments[1];return Math.min(ne.computeOverlaySnapTolerance(s),ne.computeOverlaySnapTolerance(o))}};ne.computeSizeBasedSnapTolerance=function(t){var e=t.getEnvelopeInternal(),r=Math.min(e.getHeight(),e.getWidth()),i=r*ne.SNAP_PRECISION_FACTOR;return i};ne.snapToSelf=function(t,e,r){var i=new ne(t);return i.snapToSelf(e,r)};gE.SNAP_PRECISION_FACTOR.get=function(){return 1e-9};Object.defineProperties(ne,gE);var mE=function(n){function t(e,r,i){n.call(this),this._snapTolerance=e||null,this._snapPts=r||null,this._isSelfSnap=i!==void 0?i:!1}return n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t,t.prototype.snapLine=function(r,i){var s=new si(r,this._snapTolerance);return s.setAllowSnappingToSourceVertices(this._isSelfSnap),s.snapTo(i)},t.prototype.transformCoordinates=function(r,i){var s=r.toCoordinateArray(),o=this.snapLine(s,this._snapPts);return this._factory.getCoordinateSequenceFactory().create(o)},t.prototype.interfaces_=function(){return[]},t.prototype.getClass=function(){return t},t}(fn),Xe=function(){this._isFirst=!0,this._commonMantissaBitsCount=53,this._commonBits=0,this._commonSignExp=null};Xe.prototype.getCommon=function(){return dt.longBitsToDouble(this._commonBits)};Xe.prototype.add=function(t){var e=dt.doubleToLongBits(t);if(this._isFirst)return this._commonBits=e,this._commonSignExp=Xe.signExpBits(this._commonBits),this._isFirst=!1,null;var r=Xe.signExpBits(e);if(r!==this._commonSignExp)return this._commonBits=0,null;this._commonMantissaBitsCount=Xe.numCommonMostSigMantissaBits(this._commonBits,e),this._commonBits=Xe.zeroLowerBits(this._commonBits,64-(12+this._commonMantissaBitsCount))};Xe.prototype.toString=function(){if(arguments.length===1){var t=arguments[0],e=dt.longBitsToDouble(t),r=dt.toBinaryString(t),i="0000000000000000000000000000000000000000000000000000000000000000"+r,s=i.substring(i.length-64),o=s.substring(0,1)+"  "+s.substring(1,12)+"(exp) "+s.substring(12)+" [ "+e+" ]";return o}};Xe.prototype.interfaces_=function(){return[]};Xe.prototype.getClass=function(){return Xe};Xe.getBit=function(t,e){var r=1<<e;return(t&r)!==0?1:0};Xe.signExpBits=function(t){return t>>52};Xe.zeroLowerBits=function(t,e){var r=(1<<e)-1,i=~r,s=t&i;return s};Xe.numCommonMostSigMantissaBits=function(t,e){for(var r=0,i=52;i>=0;i--){if(Xe.getBit(t,i)!==Xe.getBit(e,i))return r;r++}return 52};var ns=function(){this._commonCoord=null,this._ccFilter=new So},Eg={CommonCoordinateFilter:{configurable:!0},Translater:{configurable:!0}};ns.prototype.addCommonBits=function(t){var e=new rs(this._commonCoord);t.apply(e),t.geometryChanged()};ns.prototype.removeCommonBits=function(t){if(this._commonCoord.x===0&&this._commonCoord.y===0)return t;var e=new z(this._commonCoord);e.x=-e.x,e.y=-e.y;var r=new rs(e);return t.apply(r),t.geometryChanged(),t};ns.prototype.getCommonCoordinate=function(){return this._commonCoord};ns.prototype.add=function(t){t.apply(this._ccFilter),this._commonCoord=this._ccFilter.getCommonCoordinate()};ns.prototype.interfaces_=function(){return[]};ns.prototype.getClass=function(){return ns};Eg.CommonCoordinateFilter.get=function(){return So};Eg.Translater.get=function(){return rs};Object.defineProperties(ns,Eg);var So=function(){this._commonBitsX=new Xe,this._commonBitsY=new Xe};So.prototype.filter=function(t){this._commonBitsX.add(t.x),this._commonBitsY.add(t.y)};So.prototype.getCommonCoordinate=function(){return new z(this._commonBitsX.getCommon(),this._commonBitsY.getCommon())};So.prototype.interfaces_=function(){return[Qr]};So.prototype.getClass=function(){return So};var rs=function(){this.trans=null;var t=arguments[0];this.trans=t};rs.prototype.filter=function(t,e){var r=t.getOrdinate(e,0)+this.trans.x,i=t.getOrdinate(e,1)+this.trans.y;t.setOrdinate(e,0,r),t.setOrdinate(e,1,i)};rs.prototype.isDone=function(){return!1};rs.prototype.isGeometryChanged=function(){return!0};rs.prototype.interfaces_=function(){return[nr]};rs.prototype.getClass=function(){return rs};var Ee=function(t,e){this._geom=new Array(2).fill(null),this._snapTolerance=null,this._cbr=null,this._geom[0]=t,this._geom[1]=e,this.computeSnapTolerance()};Ee.prototype.selfSnap=function(t){var e=new ne(t),r=e.snapTo(t,this._snapTolerance);return r};Ee.prototype.removeCommonBits=function(t){this._cbr=new ns,this._cbr.add(t[0]),this._cbr.add(t[1]);var e=new Array(2).fill(null);return e[0]=this._cbr.removeCommonBits(t[0].copy()),e[1]=this._cbr.removeCommonBits(t[1].copy()),e};Ee.prototype.prepareResult=function(t){return this._cbr.addCommonBits(t),t};Ee.prototype.getResultGeometry=function(t){var e=this.snap(this._geom),r=gt.overlayOp(e[0],e[1],t);return this.prepareResult(r)};Ee.prototype.checkValid=function(t){t.isValid()||De.out.println("Snapped geometry is invalid")};Ee.prototype.computeSnapTolerance=function(){this._snapTolerance=ne.computeOverlaySnapTolerance(this._geom[0],this._geom[1])};Ee.prototype.snap=function(t){var e=this.removeCommonBits(t),r=ne.snap(e[0],e[1],this._snapTolerance);return r};Ee.prototype.interfaces_=function(){return[]};Ee.prototype.getClass=function(){return Ee};Ee.overlayOp=function(t,e,r){var i=new Ee(t,e);return i.getResultGeometry(r)};Ee.union=function(t,e){return Ee.overlayOp(t,e,gt.UNION)};Ee.intersection=function(t,e){return Ee.overlayOp(t,e,gt.INTERSECTION)};Ee.symDifference=function(t,e){return Ee.overlayOp(t,e,gt.SYMDIFFERENCE)};Ee.difference=function(t,e){return Ee.overlayOp(t,e,gt.DIFFERENCE)};var en=function(t,e){this._geom=new Array(2).fill(null),this._geom[0]=t,this._geom[1]=e};en.prototype.getResultGeometry=function(t){var e=null,r=!1,i=null;try{e=gt.overlayOp(this._geom[0],this._geom[1],t);var s=!0;s&&(r=!0)}catch(o){if(o instanceof Pi)i=o;else throw o}finally{}if(!r)try{e=Ee.overlayOp(this._geom[0],this._geom[1],t)}catch(o){throw o instanceof Pi?i:o}finally{}return e};en.prototype.interfaces_=function(){return[]};en.prototype.getClass=function(){return en};en.overlayOp=function(t,e,r){var i=new en(t,e);return i.getResultGeometry(r)};en.union=function(t,e){return en.overlayOp(t,e,gt.UNION)};en.intersection=function(t,e){return en.overlayOp(t,e,gt.INTERSECTION)};en.symDifference=function(t,e){return en.overlayOp(t,e,gt.SYMDIFFERENCE)};en.difference=function(t,e){return en.overlayOp(t,e,gt.DIFFERENCE)};var $l=function(){this.mce=null,this.chainIndex=null;var t=arguments[0],e=arguments[1];this.mce=t,this.chainIndex=e};$l.prototype.computeIntersections=function(t,e){this.mce.computeIntersectsForChain(this.chainIndex,t.mce,t.chainIndex,e)};$l.prototype.interfaces_=function(){return[]};$l.prototype.getClass=function(){return $l};var wn=function n(){if(this._label=null,this._xValue=null,this._eventType=null,this._insertEvent=null,this._deleteEventIndex=null,this._obj=null,arguments.length===2){var t=arguments[0],e=arguments[1];this._eventType=n.DELETE,this._xValue=t,this._insertEvent=e}else if(arguments.length===3){var r=arguments[0],i=arguments[1],s=arguments[2];this._eventType=n.INSERT,this._label=r,this._xValue=i,this._obj=s}},wg={INSERT:{configurable:!0},DELETE:{configurable:!0}};wn.prototype.isDelete=function(){return this._eventType===wn.DELETE};wn.prototype.setDeleteEventIndex=function(t){this._deleteEventIndex=t};wn.prototype.getObject=function(){return this._obj};wn.prototype.compareTo=function(t){var e=t;return this._xValue<e._xValue?-1:this._xValue>e._xValue?1:this._eventType<e._eventType?-1:this._eventType>e._eventType?1:0};wn.prototype.getInsertEvent=function(){return this._insertEvent};wn.prototype.isInsert=function(){return this._eventType===wn.INSERT};wn.prototype.isSameLabel=function(t){return this._label===null?!1:this._label===t._label};wn.prototype.getDeleteEventIndex=function(){return this._deleteEventIndex};wn.prototype.interfaces_=function(){return[Gn]};wn.prototype.getClass=function(){return wn};wg.INSERT.get=function(){return 1};wg.DELETE.get=function(){return 2};Object.defineProperties(wn,wg);var nh=function(){};nh.prototype.interfaces_=function(){return[]};nh.prototype.getClass=function(){return nh};var Fe=function(){this._hasIntersection=!1,this._hasProper=!1,this._hasProperInterior=!1,this._properIntersectionPoint=null,this._li=null,this._includeProper=null,this._recordIsolated=null,this._isSelfIntersection=null,this._numIntersections=0,this.numTests=0,this._bdyNodes=null,this._isDone=!1,this._isDoneWhenProperInt=!1;var t=arguments[0],e=arguments[1],r=arguments[2];this._li=t,this._includeProper=e,this._recordIsolated=r};Fe.prototype.isTrivialIntersection=function(t,e,r,i){if(t===r&&this._li.getIntersectionNum()===1){if(Fe.isAdjacentSegments(e,i))return!0;if(t.isClosed()){var s=t.getNumPoints()-1;if(e===0&&i===s||i===0&&e===s)return!0}}return!1};Fe.prototype.getProperIntersectionPoint=function(){return this._properIntersectionPoint};Fe.prototype.setIsDoneIfProperInt=function(t){this._isDoneWhenProperInt=t};Fe.prototype.hasProperInteriorIntersection=function(){return this._hasProperInterior};Fe.prototype.isBoundaryPointInternal=function(t,e){for(var r=e.iterator();r.hasNext();){var i=r.next(),s=i.getCoordinate();if(t.isIntersection(s))return!0}return!1};Fe.prototype.hasProperIntersection=function(){return this._hasProper};Fe.prototype.hasIntersection=function(){return this._hasIntersection};Fe.prototype.isDone=function(){return this._isDone};Fe.prototype.isBoundaryPoint=function(t,e){return e===null?!1:!!(this.isBoundaryPointInternal(t,e[0])||this.isBoundaryPointInternal(t,e[1]))};Fe.prototype.setBoundaryNodes=function(t,e){this._bdyNodes=new Array(2).fill(null),this._bdyNodes[0]=t,this._bdyNodes[1]=e};Fe.prototype.addIntersections=function(t,e,r,i){if(t===r&&e===i)return null;this.numTests++;var s=t.getCoordinates()[e],o=t.getCoordinates()[e+1],a=r.getCoordinates()[i],l=r.getCoordinates()[i+1];this._li.computeIntersection(s,o,a,l),this._li.hasIntersection()&&(this._recordIsolated&&(t.setIsolated(!1),r.setIsolated(!1)),this._numIntersections++,this.isTrivialIntersection(t,e,r,i)||(this._hasIntersection=!0,(this._includeProper||!this._li.isProper())&&(t.addIntersections(this._li,e,0),r.addIntersections(this._li,i,1)),this._li.isProper()&&(this._properIntersectionPoint=this._li.getIntersection(0).copy(),this._hasProper=!0,this._isDoneWhenProperInt&&(this._isDone=!0),this.isBoundaryPoint(this._li,this._bdyNodes)||(this._hasProperInterior=!0))))};Fe.prototype.interfaces_=function(){return[]};Fe.prototype.getClass=function(){return Fe};Fe.isAdjacentSegments=function(t,e){return Math.abs(t-e)===1};var mk=function(n){function t(){n.call(this),this.events=new et,this.nOverlaps=null}return n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t,t.prototype.prepareEvents=function(){var r=this;ir.sort(this.events);for(var i=0;i<this.events.size();i++){var s=r.events.get(i);s.isDelete()&&s.getInsertEvent().setDeleteEventIndex(i)}},t.prototype.computeIntersections=function(){var r=this;if(arguments.length===1){var i=arguments[0];this.nOverlaps=0,this.prepareEvents();for(var s=0;s<this.events.size();s++){var o=r.events.get(s);if(o.isInsert()&&r.processOverlaps(s,o.getDeleteEventIndex(),o,i),i.isDone())break}}else if(arguments.length===3){if(arguments[2]instanceof Fe&&ct(arguments[0],tr)&&ct(arguments[1],tr)){var a=arguments[0],l=arguments[1],c=arguments[2];this.addEdges(a,a),this.addEdges(l,l),this.computeIntersections(c)}else if(typeof arguments[2]=="boolean"&&ct(arguments[0],tr)&&arguments[1]instanceof Fe){var u=arguments[0],h=arguments[1],f=arguments[2];f?this.addEdges(u,null):this.addEdges(u),this.computeIntersections(h)}}},t.prototype.addEdge=function(r,i){for(var s=this,o=r.getMonotoneChainEdge(),a=o.getStartIndexes(),l=0;l<a.length-1;l++){var c=new $l(o,l),u=new wn(i,o.getMinX(l),c);s.events.add(u),s.events.add(new wn(o.getMaxX(l),u))}},t.prototype.processOverlaps=function(r,i,s,o){for(var a=this,l=s.getObject(),c=r;c<i;c++){var u=a.events.get(c);if(u.isInsert()){var h=u.getObject();s.isSameLabel(u)||(l.computeIntersections(h,o),a.nOverlaps++)}}},t.prototype.addEdges=function(){var r=this;if(arguments.length===1)for(var i=arguments[0],s=i.iterator();s.hasNext();){var o=s.next();r.addEdge(o,o)}else if(arguments.length===2)for(var a=arguments[0],l=arguments[1],c=a.iterator();c.hasNext();){var u=c.next();r.addEdge(u,l)}},t.prototype.interfaces_=function(){return[]},t.prototype.getClass=function(){return t},t}(nh),oi=function(){this._min=dt.POSITIVE_INFINITY,this._max=dt.NEGATIVE_INFINITY},_E={NodeComparator:{configurable:!0}};oi.prototype.getMin=function(){return this._min};oi.prototype.intersects=function(t,e){return!(this._min>e||this._max<t)};oi.prototype.getMax=function(){return this._max};oi.prototype.toString=function(){return er.toLineString(new z(this._min,0),new z(this._max,0))};oi.prototype.interfaces_=function(){return[]};oi.prototype.getClass=function(){return oi};_E.NodeComparator.get=function(){return Xl};Object.defineProperties(oi,_E);var Xl=function(){};Xl.prototype.compare=function(t,e){var r=t,i=e,s=(r._min+r._max)/2,o=(i._min+i._max)/2;return s<o?-1:s>o?1:0};Xl.prototype.interfaces_=function(){return[ya]};Xl.prototype.getClass=function(){return Xl};var _k=function(n){function t(){n.call(this),this._item=null;var e=arguments[0],r=arguments[1],i=arguments[2];this._min=e,this._max=r,this._item=i}return n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t,t.prototype.query=function(r,i,s){if(!this.intersects(r,i))return null;s.visitItem(this._item)},t.prototype.interfaces_=function(){return[]},t.prototype.getClass=function(){return t},t}(oi),yk=function(n){function t(){n.call(this),this._node1=null,this._node2=null;var e=arguments[0],r=arguments[1];this._node1=e,this._node2=r,this.buildExtent(this._node1,this._node2)}return n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t,t.prototype.buildExtent=function(r,i){this._min=Math.min(r._min,i._min),this._max=Math.max(r._max,i._max)},t.prototype.query=function(r,i,s){if(!this.intersects(r,i))return null;this._node1!==null&&this._node1.query(r,i,s),this._node2!==null&&this._node2.query(r,i,s)},t.prototype.interfaces_=function(){return[]},t.prototype.getClass=function(){return t},t}(oi),ai=function(){this._leaves=new et,this._root=null,this._level=0};ai.prototype.buildTree=function(){var t=this;ir.sort(this._leaves,new oi.NodeComparator);for(var e=this._leaves,r=null,i=new et;;){if(t.buildLevel(e,i),i.size()===1)return i.get(0);r=e,e=i,i=r}};ai.prototype.insert=function(t,e,r){if(this._root!==null)throw new Error("Index cannot be added to once it has been queried");this._leaves.add(new _k(t,e,r))};ai.prototype.query=function(t,e,r){this.init(),this._root.query(t,e,r)};ai.prototype.buildRoot=function(){if(this._root!==null)return null;this._root=this.buildTree()};ai.prototype.printNode=function(t){De.out.println(er.toLineString(new z(t._min,this._level),new z(t._max,this._level)))};ai.prototype.init=function(){if(this._root!==null)return null;this.buildRoot()};ai.prototype.buildLevel=function(t,e){this._level++,e.clear();for(var r=0;r<t.size();r+=2){var i=t.get(r),s=r+1<t.size()?t.get(r):null;if(s===null)e.add(i);else{var o=new yk(t.get(r),t.get(r+1));e.add(o)}}};ai.prototype.interfaces_=function(){return[]};ai.prototype.getClass=function(){return ai};var Ra=function(){this._items=new et};Ra.prototype.visitItem=function(t){this._items.add(t)};Ra.prototype.getItems=function(){return this._items};Ra.prototype.interfaces_=function(){return[Ki]};Ra.prototype.getClass=function(){return Ra};var Na=function(){this._index=null;var t=arguments[0];if(!ct(t,qi))throw new Xt("Argument must be Polygonal");this._index=new Fs(t)},Sg={SegmentVisitor:{configurable:!0},IntervalIndexedGeometry:{configurable:!0}};Na.prototype.locate=function(t){var e=new Sr(t),r=new Oa(e);return this._index.query(t.y,t.y,r),e.getLocation()};Na.prototype.interfaces_=function(){return[Aa]};Na.prototype.getClass=function(){return Na};Sg.SegmentVisitor.get=function(){return Oa};Sg.IntervalIndexedGeometry.get=function(){return Fs};Object.defineProperties(Na,Sg);var Oa=function(){this._counter=null;var t=arguments[0];this._counter=t};Oa.prototype.visitItem=function(t){var e=t;this._counter.countSegment(e.getCoordinate(0),e.getCoordinate(1))};Oa.prototype.interfaces_=function(){return[Ki]};Oa.prototype.getClass=function(){return Oa};var Fs=function(){this._index=new ai;var t=arguments[0];this.init(t)};Fs.prototype.init=function(t){for(var e=this,r=Ae.getLines(t),i=r.iterator();i.hasNext();){var s=i.next(),o=s.getCoordinates();e.addLine(o)}};Fs.prototype.addLine=function(t){for(var e=this,r=1;r<t.length;r++){var i=new ot(t[r-1],t[r]),s=Math.min(i.p0.y,i.p1.y),o=Math.max(i.p0.y,i.p1.y);e._index.insert(s,o,i)}};Fs.prototype.query=function(){if(arguments.length===2){var t=arguments[0],e=arguments[1],r=new Ra;return this._index.query(t,e,r),r.getItems()}else if(arguments.length===3){var i=arguments[0],s=arguments[1],o=arguments[2];this._index.query(i,s,o)}};Fs.prototype.interfaces_=function(){return[]};Fs.prototype.getClass=function(){return Fs};var rl=function(n){function t(){if(n.call(this),this._parentGeom=null,this._lineEdgeMap=new tE,this._boundaryNodeRule=null,this._useBoundaryDeterminationRule=!0,this._argIndex=null,this._boundaryNodes=null,this._hasTooFewPoints=!1,this._invalidPoint=null,this._areaPtLocator=null,this._ptLocator=new or,arguments.length===2){var e=arguments[0],r=arguments[1],i=jn.OGC_SFS_BOUNDARY_RULE;this._argIndex=e,this._parentGeom=r,this._boundaryNodeRule=i,r!==null&&this.add(r)}else if(arguments.length===3){var s=arguments[0],o=arguments[1],a=arguments[2];this._argIndex=s,this._parentGeom=o,this._boundaryNodeRule=a,o!==null&&this.add(o)}}return n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t,t.prototype.insertBoundaryPoint=function(r,i){var s=this._nodes.addNode(i),o=s.getLabel(),a=1,l=j.NONE;l=o.getLocation(r,Q.ON),l===j.BOUNDARY&&a++;var c=t.determineBoundary(this._boundaryNodeRule,a);o.setLocation(r,c)},t.prototype.computeSelfNodes=function(){if(arguments.length===2){var r=arguments[0],i=arguments[1];return this.computeSelfNodes(r,i,!1)}else if(arguments.length===3){var s=arguments[0],o=arguments[1],a=arguments[2],l=new Fe(s,!0,!1);l.setIsDoneIfProperInt(a);var c=this.createEdgeSetIntersector(),u=this._parentGeom instanceof ti||this._parentGeom instanceof ge||this._parentGeom instanceof Kr,h=o||!u;return c.computeIntersections(this._edges,l,h),this.addSelfIntersectionNodes(this._argIndex),l}},t.prototype.computeSplitEdges=function(r){for(var i=this._edges.iterator();i.hasNext();){var s=i.next();s.eiList.addSplitEdges(r)}},t.prototype.computeEdgeIntersections=function(r,i,s){var o=new Fe(i,s,!0);o.setBoundaryNodes(this.getBoundaryNodes(),r.getBoundaryNodes());var a=this.createEdgeSetIntersector();return a.computeIntersections(this._edges,r._edges,o),o},t.prototype.getGeometry=function(){return this._parentGeom},t.prototype.getBoundaryNodeRule=function(){return this._boundaryNodeRule},t.prototype.hasTooFewPoints=function(){return this._hasTooFewPoints},t.prototype.addPoint=function(){if(arguments[0]instanceof bn){var r=arguments[0],i=r.getCoordinate();this.insertPoint(this._argIndex,i,j.INTERIOR)}else if(arguments[0]instanceof z){var s=arguments[0];this.insertPoint(this._argIndex,s,j.INTERIOR)}},t.prototype.addPolygon=function(r){var i=this;this.addPolygonRing(r.getExteriorRing(),j.EXTERIOR,j.INTERIOR);for(var s=0;s<r.getNumInteriorRing();s++){var o=r.getInteriorRingN(s);i.addPolygonRing(o,j.INTERIOR,j.EXTERIOR)}},t.prototype.addEdge=function(r){this.insertEdge(r);var i=r.getCoordinates();this.insertPoint(this._argIndex,i[0],j.BOUNDARY),this.insertPoint(this._argIndex,i[i.length-1],j.BOUNDARY)},t.prototype.addLineString=function(r){var i=yt.removeRepeatedPoints(r.getCoordinates());if(i.length<2)return this._hasTooFewPoints=!0,this._invalidPoint=i[0],null;var s=new eh(i,new Mt(this._argIndex,j.INTERIOR));this._lineEdgeMap.put(r,s),this.insertEdge(s),mt.isTrue(i.length>=2,"found LineString with single point"),this.insertBoundaryPoint(this._argIndex,i[0]),this.insertBoundaryPoint(this._argIndex,i[i.length-1])},t.prototype.getInvalidPoint=function(){return this._invalidPoint},t.prototype.getBoundaryPoints=function(){for(var r=this.getBoundaryNodes(),i=new Array(r.size()).fill(null),s=0,o=r.iterator();o.hasNext();){var a=o.next();i[s++]=a.getCoordinate().copy()}return i},t.prototype.getBoundaryNodes=function(){return this._boundaryNodes===null&&(this._boundaryNodes=this._nodes.getBoundaryNodes(this._argIndex)),this._boundaryNodes},t.prototype.addSelfIntersectionNode=function(r,i,s){if(this.isBoundaryNode(r,i))return null;s===j.BOUNDARY&&this._useBoundaryDeterminationRule?this.insertBoundaryPoint(r,i):this.insertPoint(r,i,s)},t.prototype.addPolygonRing=function(r,i,s){if(r.isEmpty())return null;var o=yt.removeRepeatedPoints(r.getCoordinates());if(o.length<4)return this._hasTooFewPoints=!0,this._invalidPoint=o[0],null;var a=i,l=s;rt.isCCW(o)&&(a=s,l=i);var c=new eh(o,new Mt(this._argIndex,j.BOUNDARY,a,l));this._lineEdgeMap.put(r,c),this.insertEdge(c),this.insertPoint(this._argIndex,o[0],j.BOUNDARY)},t.prototype.insertPoint=function(r,i,s){var o=this._nodes.addNode(i),a=o.getLabel();a===null?o._label=new Mt(r,s):a.setLocation(r,s)},t.prototype.createEdgeSetIntersector=function(){return new mk},t.prototype.addSelfIntersectionNodes=function(r){for(var i=this,s=this._edges.iterator();s.hasNext();)for(var o=s.next(),a=o.getLabel().getLocation(r),l=o.eiList.iterator();l.hasNext();){var c=l.next();i.addSelfIntersectionNode(r,c.coord,a)}},t.prototype.add=function(){if(arguments.length===1){var r=arguments[0];if(r.isEmpty())return null;if(r instanceof Kr&&(this._useBoundaryDeterminationRule=!1),r instanceof ge)this.addPolygon(r);else if(r instanceof Jt)this.addLineString(r);else if(r instanceof bn)this.addPoint(r);else if(r instanceof Ca)this.addCollection(r);else if(r instanceof Ms)this.addCollection(r);else if(r instanceof Kr)this.addCollection(r);else if(r instanceof Je)this.addCollection(r);else throw new Error(r.getClass().getName())}else return n.prototype.add.apply(this,arguments)},t.prototype.addCollection=function(r){for(var i=this,s=0;s<r.getNumGeometries();s++){var o=r.getGeometryN(s);i.add(o)}},t.prototype.locate=function(r){return ct(this._parentGeom,qi)&&this._parentGeom.getNumGeometries()>50?(this._areaPtLocator===null&&(this._areaPtLocator=new Na(this._parentGeom)),this._areaPtLocator.locate(r)):this._ptLocator.locate(r,this._parentGeom)},t.prototype.findEdge=function(){if(arguments.length===1){var r=arguments[0];return this._lineEdgeMap.get(r)}else return n.prototype.findEdge.apply(this,arguments)},t.prototype.interfaces_=function(){return[]},t.prototype.getClass=function(){return t},t.determineBoundary=function(r,i){return r.isInBoundary(i)?j.BOUNDARY:j.INTERIOR},t}(Kt),Da=function(){if(this._li=new Hs,this._resultPrecisionModel=null,this._arg=null,arguments.length===1){var t=arguments[0];this.setComputationPrecision(t.getPrecisionModel()),this._arg=new Array(1).fill(null),this._arg[0]=new rl(0,t)}else if(arguments.length===2){var e=arguments[0],r=arguments[1],i=jn.OGC_SFS_BOUNDARY_RULE;e.getPrecisionModel().compareTo(r.getPrecisionModel())>=0?this.setComputationPrecision(e.getPrecisionModel()):this.setComputationPrecision(r.getPrecisionModel()),this._arg=new Array(2).fill(null),this._arg[0]=new rl(0,e,i),this._arg[1]=new rl(1,r,i)}else if(arguments.length===3){var s=arguments[0],o=arguments[1],a=arguments[2];s.getPrecisionModel().compareTo(o.getPrecisionModel())>=0?this.setComputationPrecision(s.getPrecisionModel()):this.setComputationPrecision(o.getPrecisionModel()),this._arg=new Array(2).fill(null),this._arg[0]=new rl(0,s,a),this._arg[1]=new rl(1,o,a)}};Da.prototype.getArgGeometry=function(t){return this._arg[t].getGeometry()};Da.prototype.setComputationPrecision=function(t){this._resultPrecisionModel=t,this._li.setPrecisionModel(this._resultPrecisionModel)};Da.prototype.interfaces_=function(){return[]};Da.prototype.getClass=function(){return Da};var Ts=function(){};Ts.prototype.interfaces_=function(){return[]};Ts.prototype.getClass=function(){return Ts};Ts.map=function(){if(arguments[0]instanceof lt&&ct(arguments[1],Ts.MapOp)){for(var t=arguments[0],e=arguments[1],r=new et,i=0;i<t.getNumGeometries();i++){var s=e.map(t.getGeometryN(i));s!==null&&r.add(s)}return t.getFactory().buildGeometry(r)}else if(ct(arguments[0],he)&&ct(arguments[1],Ts.MapOp)){for(var o=arguments[0],a=arguments[1],l=new et,c=o.iterator();c.hasNext();){var u=c.next(),h=a.map(u);h!==null&&l.add(h)}return l}};Ts.MapOp=function(){};var gt=function(n){function t(){var e=arguments[0],r=arguments[1];n.call(this,e,r),this._ptLocator=new or,this._geomFact=null,this._resultGeom=null,this._graph=null,this._edgeList=new sr,this._resultPolyList=new et,this._resultLineList=new et,this._resultPointList=new et,this._graph=new Kt(new lE),this._geomFact=e.getFactory()}return n&&(t.__proto__=n),t.prototype=Object.create(n&&n.prototype),t.prototype.constructor=t,t.prototype.insertUniqueEdge=function(r){var i=this._edgeList.findEqualEdge(r);if(i!==null){var s=i.getLabel(),o=r.getLabel();i.isPointwiseEqual(r)||(o=new Mt(r.getLabel()),o.flip());var a=i.getDepth();a.isNull()&&a.add(s),a.add(o),s.merge(o)}else this._edgeList.add(r)},t.prototype.getGraph=function(){return this._graph},t.prototype.cancelDuplicateResultEdges=function(){for(var r=this._graph.getEdgeEnds().iterator();r.hasNext();){var i=r.next(),s=i.getSym();i.isInResult()&&s.isInResult()&&(i.setInResult(!1),s.setInResult(!1))}},t.prototype.isCoveredByLA=function(r){return!!(this.isCovered(r,this._resultLineList)||this.isCovered(r,this._resultPolyList))},t.prototype.computeGeometry=function(r,i,s,o){var a=new et;return a.addAll(r),a.addAll(i),a.addAll(s),a.isEmpty()?t.createEmptyResult(o,this._arg[0].getGeometry(),this._arg[1].getGeometry(),this._geomFact):this._geomFact.buildGeometry(a)},t.prototype.mergeSymLabels=function(){for(var r=this._graph.getNodes().iterator();r.hasNext();){var i=r.next();i.getEdges().mergeSymLabels()}},t.prototype.isCovered=function(r,i){for(var s=this,o=i.iterator();o.hasNext();){var a=o.next(),l=s._ptLocator.locate(r,a);if(l!==j.EXTERIOR)return!0}return!1},t.prototype.replaceCollapsedEdges=function(){for(var r=new et,i=this._edgeList.iterator();i.hasNext();){var s=i.next();s.isCollapsed()&&(i.remove(),r.add(s.getCollapsedEdge()))}this._edgeList.addAll(r)},t.prototype.updateNodeLabelling=function(){for(var r=this._graph.getNodes().iterator();r.hasNext();){var i=r.next(),s=i.getEdges().getLabel();i.getLabel().merge(s)}},t.prototype.getResultGeometry=function(r){return this.computeOverlay(r),this._resultGeom},t.prototype.insertUniqueEdges=function(r){for(var i=this,s=r.iterator();s.hasNext();){var o=s.next();i.insertUniqueEdge(o)}},t.prototype.computeOverlay=function(r){this.copyPoints(0),this.copyPoints(1),this._arg[0].computeSelfNodes(this._li,!1),this._arg[1].computeSelfNodes(this._li,!1),this._arg[0].computeEdgeIntersections(this._arg[1],this._li,!0);var i=new et;this._arg[0].computeSplitEdges(i),this._arg[1].computeSplitEdges(i),this.insertUniqueEdges(i),this.computeLabelsFromDepths(),this.replaceCollapsedEdges(),ks.checkValid(this._edgeList.getEdges()),this._graph.addEdges(this._edgeList.getEdges()),this.computeLabelling(),this.labelIncompleteNodes(),this.findResultAreaEdges(r),this.cancelDuplicateResultEdges();var s=new xn(this._geomFact);s.add(this._graph),this._resultPolyList=s.getPolygons();var o=new Br(this,this._geomFact,this._ptLocator);this._resultLineList=o.build(r);var a=new wo(this,this._geomFact,this._ptLocator);this._resultPointList=a.build(r),this._resultGeom=this.computeGeometry(this._resultPointList,this._resultLineList,this._resultPolyList,r)},t.prototype.labelIncompleteNode=function(r,i){var s=this._ptLocator.locate(r.getCoordinate(),this._arg[i].getGeometry());r.getLabel().setLocation(i,s)},t.prototype.copyPoints=function(r){for(var i=this,s=this._arg[r].getNodeIterator();s.hasNext();){var o=s.next(),a=i._graph.addNode(o.getCoordinate());a.setLabel(r,o.getLabel().getLocation(r))}},t.prototype.findResultAreaEdges=function(r){for(var i=this._graph.getEdgeEnds().iterator();i.hasNext();){var s=i.next(),o=s.getLabel();o.isArea()&&!s.isInteriorAreaEdge()&&t.isResultOfOp(o.getLocation(0,Q.RIGHT),o.getLocation(1,Q.RIGHT),r)&&s.setInResult(!0)}},t.prototype.computeLabelsFromDepths=function(){for(var r=this._edgeList.iterator();r.hasNext();){var i=r.next(),s=i.getLabel(),o=i.getDepth();if(!o.isNull()){o.normalize();for(var a=0;a<2;a++)!s.isNull(a)&&s.isArea()&&!o.isNull(a)&&(o.getDelta(a)===0?s.toLine(a):(mt.isTrue(!o.isNull(a,Q.LEFT),"depth of LEFT side has not been initialized"),s.setLocation(a,Q.LEFT,o.getLocation(a,Q.LEFT)),mt.isTrue(!o.isNull(a,Q.RIGHT),"depth of RIGHT side has not been initialized"),s.setLocation(a,Q.RIGHT,o.getLocation(a,Q.RIGHT))))}}},t.prototype.computeLabelling=function(){for(var r=this,i=this._graph.getNodes().iterator();i.hasNext();){var s=i.next();s.getEdges().computeLabelling(r._arg)}this.mergeSymLabels(),this.updateNodeLabelling()},t.prototype.labelIncompleteNodes=function(){for(var r=this,i=this._graph.getNodes().iterator();i.hasNext();){var s=i.next(),o=s.getLabel();s.isIsolated()&&(o.isNull(0)?r.labelIncompleteNode(s,0):r.labelIncompleteNode(s,1)),s.getEdges().updateLabelling(o)}},t.prototype.isCoveredByA=function(r){return!!this.isCovered(r,this._resultPolyList)},t.prototype.interfaces_=function(){return[]},t.prototype.getClass=function(){return t},t}(Da);gt.overlayOp=function(n,t,e){var r=new gt(n,t),i=r.getResultGeometry(e);return i};gt.intersection=function(n,t){if(n.isEmpty()||t.isEmpty())return gt.createEmptyResult(gt.INTERSECTION,n,t,n.getFactory());if(n.isGeometryCollection()){var e=t;return Eo.map(n,{interfaces_:function(){return[Ts.MapOp]},map:function(r){return r.intersection(e)}})}return n.checkNotGeometryCollection(n),n.checkNotGeometryCollection(t),en.overlayOp(n,t,gt.INTERSECTION)};gt.symDifference=function(n,t){if(n.isEmpty()||t.isEmpty()){if(n.isEmpty()&&t.isEmpty())return gt.createEmptyResult(gt.SYMDIFFERENCE,n,t,n.getFactory());if(n.isEmpty())return t.copy();if(t.isEmpty())return n.copy()}return n.checkNotGeometryCollection(n),n.checkNotGeometryCollection(t),en.overlayOp(n,t,gt.SYMDIFFERENCE)};gt.resultDimension=function(n,t,e){var r=t.getDimension(),i=e.getDimension(),s=-1;switch(n){case gt.INTERSECTION:s=Math.min(r,i);break;case gt.UNION:s=Math.max(r,i);break;case gt.DIFFERENCE:s=r;break;case gt.SYMDIFFERENCE:s=Math.max(r,i);break}return s};gt.createEmptyResult=function(n,t,e,r){var i=null;switch(gt.resultDimension(n,t,e)){case-1:i=r.createGeometryCollection(new Array(0).fill(null));break;case 0:i=r.createPoint();break;case 1:i=r.createLineString();break;case 2:i=r.createPolygon();break}return i};gt.difference=function(n,t){return n.isEmpty()?gt.createEmptyResult(gt.DIFFERENCE,n,t,n.getFactory()):t.isEmpty()?n.copy():(n.checkNotGeometryCollection(n),n.checkNotGeometryCollection(t),en.overlayOp(n,t,gt.DIFFERENCE))};gt.isResultOfOp=function(){if(arguments.length===2){var n=arguments[0],t=arguments[1],e=n.getLocation(0),r=n.getLocation(1);return gt.isResultOfOp(e,r,t)}else if(arguments.length===3){var i=arguments[0],s=arguments[1],o=arguments[2];switch(i===j.BOUNDARY&&(i=j.INTERIOR),s===j.BOUNDARY&&(s=j.INTERIOR),o){case gt.INTERSECTION:return i===j.INTERIOR&&s===j.INTERIOR;case gt.UNION:return i===j.INTERIOR||s===j.INTERIOR;case gt.DIFFERENCE:return i===j.INTERIOR&&s!==j.INTERIOR;case gt.SYMDIFFERENCE:return i===j.INTERIOR&&s!==j.INTERIOR||i!==j.INTERIOR&&s===j.INTERIOR}return!1}};gt.INTERSECTION=1;gt.UNION=2;gt.DIFFERENCE=3;gt.SYMDIFFERENCE=4;var $i=function(){this._g=null,this._boundaryDistanceTolerance=null,this._linework=null,this._ptLocator=new or,this._seg=new ot;var t=arguments[0],e=arguments[1];this._g=t,this._boundaryDistanceTolerance=e,this._linework=this.extractLinework(t)};$i.prototype.isWithinToleranceOfBoundary=function(t){for(var e=this,r=0;r<this._linework.getNumGeometries();r++)for(var i=e._linework.getGeometryN(r),s=i.getCoordinateSequence(),o=0;o<s.size()-1;o++){s.getCoordinate(o,e._seg.p0),s.getCoordinate(o+1,e._seg.p1);var a=e._seg.distance(t);if(a<=e._boundaryDistanceTolerance)return!0}return!1};$i.prototype.getLocation=function(t){return this.isWithinToleranceOfBoundary(t)?j.BOUNDARY:this._ptLocator.locate(t,this._g)};$i.prototype.extractLinework=function(t){var e=new La;t.apply(e);var r=e.getLinework(),i=_t.toLineStringArray(r);return t.getFactory().createMultiLineString(i)};$i.prototype.interfaces_=function(){return[]};$i.prototype.getClass=function(){return $i};var La=function(){this._linework=null,this._linework=new et};La.prototype.getLinework=function(){return this._linework};La.prototype.filter=function(t){var e=this;if(t instanceof ge){var r=t;this._linework.add(r.getExteriorRing());for(var i=0;i<r.getNumInteriorRing();i++)e._linework.add(r.getInteriorRingN(i))}};La.prototype.interfaces_=function(){return[Rr]};La.prototype.getClass=function(){return La};var Bs=function(){this._g=null,this._doLeft=!0,this._doRight=!0;var t=arguments[0];this._g=t};Bs.prototype.extractPoints=function(t,e,r){for(var i=this,s=t.getCoordinates(),o=0;o<s.length-1;o++)i.computeOffsetPoints(s[o],s[o+1],e,r)};Bs.prototype.setSidesToGenerate=function(t,e){this._doLeft=t,this._doRight=e};Bs.prototype.getPoints=function(t){for(var e=this,r=new et,i=Ae.getLines(this._g),s=i.iterator();s.hasNext();){var o=s.next();e.extractPoints(o,t,r)}return r};Bs.prototype.computeOffsetPoints=function(t,e,r,i){var s=e.x-t.x,o=e.y-t.y,a=Math.sqrt(s*s+o*o),l=r*s/a,c=r*o/a,u=(e.x+t.x)/2,h=(e.y+t.y)/2;if(this._doLeft){var f=new z(u-c,h+l);i.add(f)}if(this._doRight){var d=new z(u+c,h-l);i.add(d)}};Bs.prototype.interfaces_=function(){return[]};Bs.prototype.getClass=function(){return Bs};var Fn=function n(){this._geom=null,this._locFinder=null,this._location=new Array(3).fill(null),this._invalidLocation=null,this._boundaryDistanceTolerance=n.TOLERANCE,this._testCoords=new et;var t=arguments[0],e=arguments[1],r=arguments[2];this._boundaryDistanceTolerance=n.computeBoundaryDistanceTolerance(t,e),this._geom=[t,e,r],this._locFinder=[new $i(this._geom[0],this._boundaryDistanceTolerance),new $i(this._geom[1],this._boundaryDistanceTolerance),new $i(this._geom[2],this._boundaryDistanceTolerance)]},yE={TOLERANCE:{configurable:!0}};Fn.prototype.reportResult=function(t,e,r){De.out.println("Overlay result invalid - A:"+j.toLocationSymbol(e[0])+" B:"+j.toLocationSymbol(e[1])+" expected:"+(r?"i":"e")+" actual:"+j.toLocationSymbol(e[2]))};Fn.prototype.isValid=function(t){this.addTestPts(this._geom[0]),this.addTestPts(this._geom[1]);var e=this.checkValid(t);return e};Fn.prototype.checkValid=function(){var t=this;if(arguments.length===1){for(var e=arguments[0],r=0;r<this._testCoords.size();r++){var i=t._testCoords.get(r);if(!t.checkValid(e,i))return t._invalidLocation=i,!1}return!0}else if(arguments.length===2){var s=arguments[0],o=arguments[1];return this._location[0]=this._locFinder[0].getLocation(o),this._location[1]=this._locFinder[1].getLocation(o),this._location[2]=this._locFinder[2].getLocation(o),Fn.hasLocation(this._location,j.BOUNDARY)?!0:this.isValidResult(s,this._location)}};Fn.prototype.addTestPts=function(t){var e=new Bs(t);this._testCoords.addAll(e.getPoints(5*this._boundaryDistanceTolerance))};Fn.prototype.isValidResult=function(t,e){var r=gt.isResultOfOp(e[0],e[1],t),i=e[2]===j.INTERIOR,s=!(r^i);return s||this.reportResult(t,e,r),s};Fn.prototype.getInvalidLocation=function(){return this._invalidLocation};Fn.prototype.interfaces_=function(){return[]};Fn.prototype.getClass=function(){return Fn};Fn.hasLocation=function(t,e){for(var r=0;r<3;r++)if(t[r]===e)return!0;return!1};Fn.computeBoundaryDistanceTolerance=function(t,e){return Math.min(ne.computeSizeBasedSnapTolerance(t),ne.computeSizeBasedSnapTolerance(e))};Fn.isValid=function(t,e,r,i){var s=new Fn(t,e,i);return s.isValid(r)};yE.TOLERANCE.get=function(){return 1e-6};Object.defineProperties(Fn,yE);var In=function n(t){this._geomFactory=null,this._skipEmpty=!1,this._inputGeoms=null,this._geomFactory=n.extractFactory(t),this._inputGeoms=t};In.prototype.extractElements=function(t,e){var r=this;if(t===null)return null;for(var i=0;i<t.getNumGeometries();i++){var s=t.getGeometryN(i);r._skipEmpty&&s.isEmpty()||e.add(s)}};In.prototype.combine=function(){for(var t=this,e=new et,r=this._inputGeoms.iterator();r.hasNext();){var i=r.next();t.extractElements(i,e)}return e.size()===0?this._geomFactory!==null?this._geomFactory.createGeometryCollection(null):null:this._geomFactory.buildGeometry(e)};In.prototype.interfaces_=function(){return[]};In.prototype.getClass=function(){return In};In.combine=function(){if(arguments.length===1){var t=arguments[0],e=new In(t);return e.combine()}else if(arguments.length===2){var r=arguments[0],i=arguments[1],s=new In(In.createList(r,i));return s.combine()}else if(arguments.length===3){var o=arguments[0],a=arguments[1],l=arguments[2],c=new In(In.createList(o,a,l));return c.combine()}};In.extractFactory=function(t){return t.isEmpty()?null:t.iterator().next().getFactory()};In.createList=function(){if(arguments.length===2){var t=arguments[0],e=arguments[1],r=new et;return r.add(t),r.add(e),r}else if(arguments.length===3){var i=arguments[0],s=arguments[1],o=arguments[2],a=new et;return a.add(i),a.add(s),a.add(o),a}};var ae=function(){this._inputPolys=null,this._geomFactory=null;var t=arguments[0];this._inputPolys=t,this._inputPolys===null&&(this._inputPolys=new et)},vE={STRTREE_NODE_CAPACITY:{configurable:!0}};ae.prototype.reduceToGeometries=function(t){for(var e=this,r=new et,i=t.iterator();i.hasNext();){var s=i.next(),o=null;ct(s,tr)?o=e.unionTree(s):s instanceof lt&&(o=s),r.add(o)}return r};ae.prototype.extractByEnvelope=function(t,e,r){for(var i=new et,s=0;s<e.getNumGeometries();s++){var o=e.getGeometryN(s);o.getEnvelopeInternal().intersects(t)?i.add(o):r.add(o)}return this._geomFactory.buildGeometry(i)};ae.prototype.unionOptimized=function(t,e){var r=t.getEnvelopeInternal(),i=e.getEnvelopeInternal();if(!r.intersects(i)){var s=In.combine(t,e);return s}if(t.getNumGeometries()<=1&&e.getNumGeometries()<=1)return this.unionActual(t,e);var o=r.intersection(i);return this.unionUsingEnvelopeIntersection(t,e,o)};ae.prototype.union=function(){if(this._inputPolys===null)throw new Error("union() method cannot be called twice");if(this._inputPolys.isEmpty())return null;this._geomFactory=this._inputPolys.iterator().next().getFactory();for(var t=new iE(ae.STRTREE_NODE_CAPACITY),e=this._inputPolys.iterator();e.hasNext();){var r=e.next();t.insert(r.getEnvelopeInternal(),r)}this._inputPolys=null;var i=t.itemsTree(),s=this.unionTree(i);return s};ae.prototype.binaryUnion=function(){if(arguments.length===1){var t=arguments[0];return this.binaryUnion(t,0,t.size())}else if(arguments.length===3){var e=arguments[0],r=arguments[1],i=arguments[2];if(i-r<=1){var s=ae.getGeometry(e,r);return this.unionSafe(s,null)}else{if(i-r===2)return this.unionSafe(ae.getGeometry(e,r),ae.getGeometry(e,r+1));var o=Math.trunc((i+r)/2),a=this.binaryUnion(e,r,o),l=this.binaryUnion(e,o,i);return this.unionSafe(a,l)}}};ae.prototype.repeatedUnion=function(t){for(var e=null,r=t.iterator();r.hasNext();){var i=r.next();e===null?e=i.copy():e=e.union(i)}return e};ae.prototype.unionSafe=function(t,e){return t===null&&e===null?null:t===null?e.copy():e===null?t.copy():this.unionOptimized(t,e)};ae.prototype.unionActual=function(t,e){return ae.restrictToPolygons(t.union(e))};ae.prototype.unionTree=function(t){var e=this.reduceToGeometries(t),r=this.binaryUnion(e);return r};ae.prototype.unionUsingEnvelopeIntersection=function(t,e,r){var i=new et,s=this.extractByEnvelope(r,t,i),o=this.extractByEnvelope(r,e,i),a=this.unionActual(s,o);i.add(a);var l=In.combine(i);return l};ae.prototype.bufferUnion=function(){if(arguments.length===1){var t=arguments[0],e=t.get(0).getFactory(),r=e.buildGeometry(t),i=r.buffer(0);return i}else if(arguments.length===2){var s=arguments[0],o=arguments[1],a=s.getFactory(),l=a.createGeometryCollection([s,o]),c=l.buffer(0);return c}};ae.prototype.interfaces_=function(){return[]};ae.prototype.getClass=function(){return ae};ae.restrictToPolygons=function(t){if(ct(t,qi))return t;var e=wi.getPolygons(t);return e.size()===1?e.get(0):t.getFactory().createMultiPolygon(_t.toPolygonArray(e))};ae.getGeometry=function(t,e){return e>=t.size()?null:t.get(e)};ae.union=function(t){var e=new ae(t);return e.union()};vE.STRTREE_NODE_CAPACITY.get=function(){return 4};Object.defineProperties(ae,vE);var rh=function(){};rh.prototype.interfaces_=function(){return[]};rh.prototype.getClass=function(){return rh};rh.union=function(t,e){if(t.isEmpty()||e.isEmpty()){if(t.isEmpty()&&e.isEmpty())return gt.createEmptyResult(gt.UNION,t,e,t.getFactory());if(t.isEmpty())return e.copy();if(e.isEmpty())return t.copy()}return t.checkNotGeometryCollection(t),t.checkNotGeometryCollection(e),en.overlayOp(t,e,gt.UNION)};function js(){return new ih}function ih(){this.reset()}ih.prototype={constructor:ih,reset:function(){this.s=this.t=0},add:function(n){Ay(Hc,n,this.t),Ay(this,Hc.s,this.s),this.s?this.t+=Hc.t:this.s=Hc.t},valueOf:function(){return this.s}};var Hc=new ih;function Ay(n,t,e){var r=n.s=t+e,i=r-t,s=r-i;n.t=t-s+(e-i)}var se=1e-6,kt=Math.PI,Ei=kt/2,My=kt/4,Ni=kt*2,us=180/kt,mr=kt/180,qe=Math.abs,vk=Math.atan,ka=Math.atan2,fe=Math.cos,de=Math.sin,Za=Math.sqrt;function bE(n){return n>1?0:n<-1?kt:Math.acos(n)}function Co(n){return n>1?Ei:n<-1?-Ei:Math.asin(n)}function dl(){}function sh(n,t){n&&Ny.hasOwnProperty(n.type)&&Ny[n.type](n,t)}var Ry={Feature:function(n,t){sh(n.geometry,t)},FeatureCollection:function(n,t){for(var e=n.features,r=-1,i=e.length;++r<i;)sh(e[r].geometry,t)}},Ny={Sphere:function(n,t){t.sphere()},Point:function(n,t){n=n.coordinates,t.point(n[0],n[1],n[2])},MultiPoint:function(n,t){for(var e=n.coordinates,r=-1,i=e.length;++r<i;)n=e[r],t.point(n[0],n[1],n[2])},LineString:function(n,t){jd(n.coordinates,t,0)},MultiLineString:function(n,t){for(var e=n.coordinates,r=-1,i=e.length;++r<i;)jd(e[r],t,0)},Polygon:function(n,t){Oy(n.coordinates,t)},MultiPolygon:function(n,t){for(var e=n.coordinates,r=-1,i=e.length;++r<i;)Oy(e[r],t)},GeometryCollection:function(n,t){for(var e=n.geometries,r=-1,i=e.length;++r<i;)sh(e[r],t)}};function jd(n,t,e){var r=-1,i=n.length-e,s;for(t.lineStart();++r<i;)s=n[r],t.point(s[0],s[1],s[2]);t.lineEnd()}function Oy(n,t){var e=-1,r=n.length;for(t.polygonStart();++e<r;)jd(n[e],t,1);t.polygonEnd()}function bk(n,t){n&&Ry.hasOwnProperty(n.type)?Ry[n.type](n,t):sh(n,t)}js();js();function $d(n){return[ka(n[1],n[0]),Co(n[2])]}function Fa(n){var t=n[0],e=n[1],r=fe(e);return[r*fe(t),r*de(t),de(e)]}function jc(n,t){return n[0]*t[0]+n[1]*t[1]+n[2]*t[2]}function oh(n,t){return[n[1]*t[2]-n[2]*t[1],n[2]*t[0]-n[0]*t[2],n[0]*t[1]-n[1]*t[0]]}function Wf(n,t){n[0]+=t[0],n[1]+=t[1],n[2]+=t[2]}function $c(n,t){return[n[0]*t,n[1]*t,n[2]*t]}function Xd(n){var t=Za(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]);n[0]/=t,n[1]/=t,n[2]/=t}js();function xE(n,t){function e(r,i){return r=n(r,i),t(r[0],r[1])}return n.invert&&t.invert&&(e.invert=function(r,i){return r=t.invert(r,i),r&&n.invert(r[0],r[1])}),e}function Gd(n,t){return[n>kt?n-Ni:n<-kt?n+Ni:n,t]}Gd.invert=Gd;function xk(n,t,e){return(n%=Ni)?t||e?xE(Ly(n),ky(t,e)):Ly(n):t||e?ky(t,e):Gd}function Dy(n){return function(t,e){return t+=n,[t>kt?t-Ni:t<-kt?t+Ni:t,e]}}function Ly(n){var t=Dy(n);return t.invert=Dy(-n),t}function ky(n,t){var e=fe(n),r=de(n),i=fe(t),s=de(t);function o(a,l){var c=fe(l),u=fe(a)*c,h=de(a)*c,f=de(l),d=f*e+u*r;return[ka(h*i-d*s,u*e-f*r),Co(d*i+h*s)]}return o.invert=function(a,l){var c=fe(l),u=fe(a)*c,h=de(a)*c,f=de(l),d=f*i-h*s;return[ka(h*i+f*s,u*e+d*r),Co(d*e-u*r)]},o}function Ek(n,t,e,r,i,s){if(e){var o=fe(t),a=de(t),l=r*e;i==null?(i=t+r*Ni,s=t-l/2):(i=Fy(o,i),s=Fy(o,s),(r>0?i<s:i>s)&&(i+=r*Ni));for(var c,u=i;r>0?u>s:u<s;u-=l)c=$d([o,-a*fe(u),-a*de(u)]),n.point(c[0],c[1])}}function Fy(n,t){t=Fa(t),t[0]-=n,Xd(t);var e=bE(-t[1]);return((-t[2]<0?-e:e)+Ni-se)%Ni}function EE(){var n=[],t;return{point:function(e,r){t.push([e,r])},lineStart:function(){n.push(t=[])},lineEnd:dl,rejoin:function(){n.length>1&&n.push(n.pop().concat(n.shift()))},result:function(){var e=n;return n=[],t=null,e}}}function wk(n,t,e,r,i,s){var o=n[0],a=n[1],l=t[0],c=t[1],u=0,h=1,f=l-o,d=c-a,p;if(p=e-o,!(!f&&p>0)){if(p/=f,f<0){if(p<u)return;p<h&&(h=p)}else if(f>0){if(p>h)return;p>u&&(u=p)}if(p=i-o,!(!f&&p<0)){if(p/=f,f<0){if(p>h)return;p>u&&(u=p)}else if(f>0){if(p<u)return;p<h&&(h=p)}if(p=r-a,!(!d&&p>0)){if(p/=d,d<0){if(p<u)return;p<h&&(h=p)}else if(d>0){if(p>h)return;p>u&&(u=p)}if(p=s-a,!(!d&&p<0)){if(p/=d,d<0){if(p>h)return;p>u&&(u=p)}else if(d>0){if(p<u)return;p<h&&(h=p)}return u>0&&(n[0]=o+u*f,n[1]=a+u*d),h<1&&(t[0]=o+h*f,t[1]=a+h*d),!0}}}}}function pu(n,t){return qe(n[0]-t[0])<se&&qe(n[1]-t[1])<se}function Xc(n,t,e,r){this.x=n,this.z=t,this.o=e,this.e=r,this.v=!1,this.n=this.p=null}function wE(n,t,e,r,i){var s=[],o=[],a,l;if(n.forEach(function(p){if(!((_=p.length-1)<=0)){var _,v=p[0],E=p[_],m;if(pu(v,E)){for(i.lineStart(),a=0;a<_;++a)i.point((v=p[a])[0],v[1]);i.lineEnd();return}s.push(m=new Xc(v,p,null,!0)),o.push(m.o=new Xc(v,null,m,!1)),s.push(m=new Xc(E,p,null,!1)),o.push(m.o=new Xc(E,null,m,!0))}}),!!s.length){for(o.sort(t),By(s),By(o),a=0,l=o.length;a<l;++a)o[a].e=e=!e;for(var c=s[0],u,h;;){for(var f=c,d=!0;f.v;)if((f=f.n)===c)return;u=f.z,i.lineStart();do{if(f.v=f.o.v=!0,f.e){if(d)for(a=0,l=u.length;a<l;++a)i.point((h=u[a])[0],h[1]);else r(f.x,f.n.x,1,i);f=f.n}else{if(d)for(u=f.p.z,a=u.length-1;a>=0;--a)i.point((h=u[a])[0],h[1]);else r(f.x,f.p.x,-1,i);f=f.p}f=f.o,u=f.z,d=!d}while(!f.v);i.lineEnd()}}}function By(n){if(t=n.length){for(var t,e=0,r=n[0],i;++e<t;)r.n=i=n[e],i.p=r,r=i;r.n=i=n[0],i.p=r}}function SE(n,t){return n<t?-1:n>t?1:n>=t?0:NaN}function Sk(n){return n.length===1&&(n=Ck(n)),{left:function(t,e,r,i){for(r==null&&(r=0),i==null&&(i=t.length);r<i;){var s=r+i>>>1;n(t[s],e)<0?r=s+1:i=s}return r},right:function(t,e,r,i){for(r==null&&(r=0),i==null&&(i=t.length);r<i;){var s=r+i>>>1;n(t[s],e)>0?i=s:r=s+1}return r}}}function Ck(n){return function(t,e){return SE(n(t),e)}}Sk(SE);function CE(n){for(var t=n.length,e,r=-1,i=0,s,o;++r<t;)i+=n[r].length;for(s=new Array(i);--t>=0;)for(o=n[t],e=o.length;--e>=0;)s[--i]=o[e];return s}var Gc=1e9,Yc=-1e9;function Tk(n,t,e,r){function i(c,u){return n<=c&&c<=e&&t<=u&&u<=r}function s(c,u,h,f){var d=0,p=0;if(c==null||(d=o(c,h))!==(p=o(u,h))||l(c,u)<0^h>0)do f.point(d===0||d===3?n:e,d>1?r:t);while((d=(d+h+4)%4)!==p);else f.point(u[0],u[1])}function o(c,u){return qe(c[0]-n)<se?u>0?0:3:qe(c[0]-e)<se?u>0?2:1:qe(c[1]-t)<se?u>0?1:0:u>0?3:2}function a(c,u){return l(c.x,u.x)}function l(c,u){var h=o(c,1),f=o(u,1);return h!==f?h-f:h===0?u[1]-c[1]:h===1?c[0]-u[0]:h===2?c[1]-u[1]:u[0]-c[0]}return function(c){var u=c,h=EE(),f,d,p,_,v,E,m,g,y,b,x,w={point:S,lineStart:L,lineEnd:O,polygonStart:T,polygonEnd:M};function S(V,C){i(V,C)&&u.point(V,C)}function I(){for(var V=0,C=0,R=d.length;C<R;++C)for(var D=d[C],H=1,K=D.length,G=D[0],Y,J,ut=G[0],at=G[1];H<K;++H)Y=ut,J=at,G=D[H],ut=G[0],at=G[1],J<=r?at>r&&(ut-Y)*(r-J)>(at-J)*(n-Y)&&++V:at<=r&&(ut-Y)*(r-J)<(at-J)*(n-Y)&&--V;return V}function T(){u=h,f=[],d=[],x=!0}function M(){var V=I(),C=x&&V,R=(f=CE(f)).length;(C||R)&&(c.polygonStart(),C&&(c.lineStart(),s(null,null,1,c),c.lineEnd()),R&&wE(f,a,V,s,c),c.polygonEnd()),u=c,f=d=p=null}function L(){w.point=P,d&&d.push(p=[]),b=!0,y=!1,m=g=NaN}function O(){f&&(P(_,v),E&&y&&h.rejoin(),f.push(h.result())),w.point=S,y&&u.lineEnd()}function P(V,C){var R=i(V,C);if(d&&p.push([V,C]),b)_=V,v=C,E=R,b=!1,R&&(u.lineStart(),u.point(V,C));else if(R&&y)u.point(V,C);else{var D=[m=Math.max(Yc,Math.min(Gc,m)),g=Math.max(Yc,Math.min(Gc,g))],H=[V=Math.max(Yc,Math.min(Gc,V)),C=Math.max(Yc,Math.min(Gc,C))];wk(D,H,n,t,e,r)?(y||(u.lineStart(),u.point(D[0],D[1])),u.point(H[0],H[1]),R||u.lineEnd(),x=!1):R&&(u.lineStart(),u.point(V,C),x=!1)}m=V,g=C,y=R}return w}}var Hf=js();function Pk(n,t){var e=t[0],r=t[1],i=[de(e),-fe(e),0],s=0,o=0;Hf.reset();for(var a=0,l=n.length;a<l;++a)if(u=(c=n[a]).length)for(var c,u,h=c[u-1],f=h[0],d=h[1]/2+My,p=de(d),_=fe(d),v=0;v<u;++v,f=m,p=y,_=b,h=E){var E=c[v],m=E[0],g=E[1]/2+My,y=de(g),b=fe(g),x=m-f,w=x>=0?1:-1,S=w*x,I=S>kt,T=p*y;if(Hf.add(ka(T*w*de(S),_*b+T*fe(S))),s+=I?x+w*Ni:x,I^f>=e^m>=e){var M=oh(Fa(h),Fa(E));Xd(M);var L=oh(i,M);Xd(L);var O=(I^x>=0?-1:1)*Co(L[2]);(r>O||r===O&&(M[0]||M[1]))&&(o+=I^x>=0?1:-1)}}return(s<-1e-6||s<se&&Hf<-1e-6)^o&1}js();function Uy(n){return n}js();js();var Ba=1/0,ah=Ba,Gl=-Ba,lh=Gl,Vy={point:Ik,lineStart:dl,lineEnd:dl,polygonStart:dl,polygonEnd:dl,result:function(){var n=[[Ba,ah],[Gl,lh]];return Gl=lh=-(ah=Ba=1/0),n}};function Ik(n,t){n<Ba&&(Ba=n),n>Gl&&(Gl=n),t<ah&&(ah=t),t>lh&&(lh=t)}js();function TE(n,t,e,r){return function(i,s){var o=t(s),a=i.invert(r[0],r[1]),l=EE(),c=t(l),u=!1,h,f,d,p={point:_,lineStart:E,lineEnd:m,polygonStart:function(){p.point=g,p.lineStart=y,p.lineEnd=b,f=[],h=[]},polygonEnd:function(){p.point=_,p.lineStart=E,p.lineEnd=m,f=CE(f);var x=Pk(h,a);f.length?(u||(s.polygonStart(),u=!0),wE(f,Mk,x,e,s)):x&&(u||(s.polygonStart(),u=!0),s.lineStart(),e(null,null,1,s),s.lineEnd()),u&&(s.polygonEnd(),u=!1),f=h=null},sphere:function(){s.polygonStart(),s.lineStart(),e(null,null,1,s),s.lineEnd(),s.polygonEnd()}};function _(x,w){var S=i(x,w);n(x=S[0],w=S[1])&&s.point(x,w)}function v(x,w){var S=i(x,w);o.point(S[0],S[1])}function E(){p.point=v,o.lineStart()}function m(){p.point=_,o.lineEnd()}function g(x,w){d.push([x,w]);var S=i(x,w);c.point(S[0],S[1])}function y(){c.lineStart(),d=[]}function b(){g(d[0][0],d[0][1]),c.lineEnd();var x=c.clean(),w=l.result(),S,I=w.length,T,M,L;if(d.pop(),h.push(d),d=null,!!I){if(x&1){if(M=w[0],(T=M.length-1)>0){for(u||(s.polygonStart(),u=!0),s.lineStart(),S=0;S<T;++S)s.point((L=M[S])[0],L[1]);s.lineEnd()}return}I>1&&x&2&&w.push(w.pop().concat(w.shift())),f.push(w.filter(Ak))}}return p}}function Ak(n){return n.length>1}function Mk(n,t){return((n=n.x)[0]<0?n[1]-Ei-se:Ei-n[1])-((t=t.x)[0]<0?t[1]-Ei-se:Ei-t[1])}const zy=TE(function(){return!0},Rk,Ok,[-kt,-Ei]);function Rk(n){var t=NaN,e=NaN,r=NaN,i;return{lineStart:function(){n.lineStart(),i=1},point:function(s,o){var a=s>0?kt:-kt,l=qe(s-t);qe(l-kt)<se?(n.point(t,e=(e+o)/2>0?Ei:-Ei),n.point(r,e),n.lineEnd(),n.lineStart(),n.point(a,e),n.point(s,e),i=0):r!==a&&l>=kt&&(qe(t-r)<se&&(t-=r*se),qe(s-a)<se&&(s-=a*se),e=Nk(t,e,s,o),n.point(r,e),n.lineEnd(),n.lineStart(),n.point(a,e),i=0),n.point(t=s,e=o),r=a},lineEnd:function(){n.lineEnd(),t=e=NaN},clean:function(){return 2-i}}}function Nk(n,t,e,r){var i,s,o=de(n-e);return qe(o)>se?vk((de(t)*(s=fe(r))*de(e)-de(r)*(i=fe(t))*de(n))/(i*s*o)):(t+r)/2}function Ok(n,t,e,r){var i;if(n==null)i=e*Ei,r.point(-kt,i),r.point(0,i),r.point(kt,i),r.point(kt,0),r.point(kt,-i),r.point(0,-i),r.point(-kt,-i),r.point(-kt,0),r.point(-kt,i);else if(qe(n[0]-t[0])>se){var s=n[0]<t[0]?kt:-kt;i=e*s/2,r.point(-s,i),r.point(0,i),r.point(s,i)}else r.point(t[0],t[1])}function Dk(n,t){var e=fe(n),r=e>0,i=qe(e)>se;function s(u,h,f,d){Ek(d,n,t,f,u,h)}function o(u,h){return fe(u)*fe(h)>e}function a(u){var h,f,d,p,_;return{lineStart:function(){p=d=!1,_=1},point:function(v,E){var m=[v,E],g,y=o(v,E),b=r?y?0:c(v,E):y?c(v+(v<0?kt:-kt),E):0;if(!h&&(p=d=y)&&u.lineStart(),y!==d&&(g=l(h,m),(!g||pu(h,g)||pu(m,g))&&(m[0]+=se,m[1]+=se,y=o(m[0],m[1]))),y!==d)_=0,y?(u.lineStart(),g=l(m,h),u.point(g[0],g[1])):(g=l(h,m),u.point(g[0],g[1]),u.lineEnd()),h=g;else if(i&&h&&r^y){var x;!(b&f)&&(x=l(m,h,!0))&&(_=0,r?(u.lineStart(),u.point(x[0][0],x[0][1]),u.point(x[1][0],x[1][1]),u.lineEnd()):(u.point(x[1][0],x[1][1]),u.lineEnd(),u.lineStart(),u.point(x[0][0],x[0][1])))}y&&(!h||!pu(h,m))&&u.point(m[0],m[1]),h=m,d=y,f=b},lineEnd:function(){d&&u.lineEnd(),h=null},clean:function(){return _|(p&&d)<<1}}}function l(u,h,f){var d=Fa(u),p=Fa(h),_=[1,0,0],v=oh(d,p),E=jc(v,v),m=v[0],g=E-m*m;if(!g)return!f&&u;var y=e*E/g,b=-e*m/g,x=oh(_,v),w=$c(_,y),S=$c(v,b);Wf(w,S);var I=x,T=jc(w,I),M=jc(I,I),L=T*T-M*(jc(w,w)-1);if(!(L<0)){var O=Za(L),P=$c(I,(-T-O)/M);if(Wf(P,w),P=$d(P),!f)return P;var V=u[0],C=h[0],R=u[1],D=h[1],H;C<V&&(H=V,V=C,C=H);var K=C-V,G=qe(K-kt)<se,Y=G||K<se;if(!G&&D<R&&(H=R,R=D,D=H),Y?G?R+D>0^P[1]<(qe(P[0]-V)<se?R:D):R<=P[1]&&P[1]<=D:K>kt^(V<=P[0]&&P[0]<=C)){var J=$c(I,(-T+O)/M);return Wf(J,w),[P,$d(J)]}}}function c(u,h){var f=r?n:kt-n,d=0;return u<-f?d|=1:u>f&&(d|=2),h<-f?d|=4:h>f&&(d|=8),d}return TE(o,a,s,r?[0,-n]:[-kt,n-kt])}function PE(n){return function(t){var e=new Yd;for(var r in n)e[r]=n[r];return e.stream=t,e}}function Yd(){}Yd.prototype={constructor:Yd,point:function(n,t){this.stream.point(n,t)},sphere:function(){this.stream.sphere()},lineStart:function(){this.stream.lineStart()},lineEnd:function(){this.stream.lineEnd()},polygonStart:function(){this.stream.polygonStart()},polygonEnd:function(){this.stream.polygonEnd()}};function IE(n,t,e){var r=t[1][0]-t[0][0],i=t[1][1]-t[0][1],s=n.clipExtent&&n.clipExtent();n.scale(150).translate([0,0]),s!=null&&n.clipExtent(null),bk(e,n.stream(Vy));var o=Vy.result(),a=Math.min(r/(o[1][0]-o[0][0]),i/(o[1][1]-o[0][1])),l=+t[0][0]+(r-a*(o[1][0]+o[0][0]))/2,c=+t[0][1]+(i-a*(o[1][1]+o[0][1]))/2;return s!=null&&n.clipExtent(s),n.scale(a*150).translate([l,c])}function Lk(n,t,e){return IE(n,[[0,0],t],e)}var Wy=16,kk=fe(30*mr);function Hy(n,t){return+t?Bk(n,t):Fk(n)}function Fk(n){return PE({point:function(t,e){t=n(t,e),this.stream.point(t[0],t[1])}})}function Bk(n,t){function e(r,i,s,o,a,l,c,u,h,f,d,p,_,v){var E=c-r,m=u-i,g=E*E+m*m;if(g>4*t&&_--){var y=o+f,b=a+d,x=l+p,w=Za(y*y+b*b+x*x),S=Co(x/=w),I=qe(qe(x)-1)<se||qe(s-h)<se?(s+h)/2:ka(b,y),T=n(I,S),M=T[0],L=T[1],O=M-r,P=L-i,V=m*O-E*P;(V*V/g>t||qe((E*O+m*P)/g-.5)>.3||o*f+a*d+l*p<kk)&&(e(r,i,s,o,a,l,M,L,I,y/=w,b/=w,x,_,v),v.point(M,L),e(M,L,I,y,b,x,c,u,h,f,d,p,_,v))}}return function(r){var i,s,o,a,l,c,u,h,f,d,p,_,v={point:E,lineStart:m,lineEnd:y,polygonStart:function(){r.polygonStart(),v.lineStart=b},polygonEnd:function(){r.polygonEnd(),v.lineStart=m}};function E(S,I){S=n(S,I),r.point(S[0],S[1])}function m(){h=NaN,v.point=g,r.lineStart()}function g(S,I){var T=Fa([S,I]),M=n(S,I);e(h,f,u,d,p,_,h=M[0],f=M[1],u=S,d=T[0],p=T[1],_=T[2],Wy,r),r.point(h,f)}function y(){v.point=E,r.lineEnd()}function b(){m(),v.point=x,v.lineEnd=w}function x(S,I){g(i=S,I),s=h,o=f,a=d,l=p,c=_,v.point=g}function w(){e(h,f,u,d,p,_,s,o,i,a,l,c,Wy,r),v.lineEnd=y,y()}return v}}var Uk=PE({point:function(n,t){this.stream.point(n*mr,t*mr)}});function Vk(n){return zk(function(){return n})()}function zk(n){var t,e=150,r=480,i=250,s,o,a=0,l=0,c=0,u=0,h=0,f,d,p=null,_=zy,v=null,E,m,g,y=Uy,b=.5,x=Hy(M,b),w,S;function I(P){return P=d(P[0]*mr,P[1]*mr),[P[0]*e+s,o-P[1]*e]}function T(P){return P=d.invert((P[0]-s)/e,(o-P[1])/e),P&&[P[0]*us,P[1]*us]}function M(P,V){return P=t(P,V),[P[0]*e+s,o-P[1]*e]}I.stream=function(P){return w&&S===P?w:w=Uk(_(f,x(y(S=P))))},I.clipAngle=function(P){return arguments.length?(_=+P?Dk(p=P*mr,6*mr):(p=null,zy),O()):p*us},I.clipExtent=function(P){return arguments.length?(y=P==null?(v=E=m=g=null,Uy):Tk(v=+P[0][0],E=+P[0][1],m=+P[1][0],g=+P[1][1]),O()):v==null?null:[[v,E],[m,g]]},I.scale=function(P){return arguments.length?(e=+P,L()):e},I.translate=function(P){return arguments.length?(r=+P[0],i=+P[1],L()):[r,i]},I.center=function(P){return arguments.length?(a=P[0]%360*mr,l=P[1]%360*mr,L()):[a*us,l*us]},I.rotate=function(P){return arguments.length?(c=P[0]%360*mr,u=P[1]%360*mr,h=P.length>2?P[2]%360*mr:0,L()):[c*us,u*us,h*us]},I.precision=function(P){return arguments.length?(x=Hy(M,b=P*P),O()):Za(b)},I.fitExtent=function(P,V){return IE(I,P,V)},I.fitSize=function(P,V){return Lk(I,P,V)};function L(){d=xE(f=xk(c,u,h),t);var P=t(a,l);return s=r-P[0]*e,o=i+P[1]*e,O()}function O(){return w=S=null,I}return function(){return t=n.apply(this,arguments),I.invert=t.invert&&T,L()}}function AE(n){return function(t,e){var r=fe(t),i=fe(e),s=n(r*i);return[s*i*de(t),s*de(e)]}}function ME(n){return function(t,e){var r=Za(t*t+e*e),i=n(r),s=de(i),o=fe(i);return[ka(t*s,r*o),Co(r&&e*s/r)]}}var Wk=AE(function(n){return Za(2/(1+n))});Wk.invert=ME(function(n){return 2*Co(n/2)});var RE=AE(function(n){return(n=bE(n))&&n/de(n)});RE.invert=ME(function(n){return n});function Hk(){return Vk(RE).scale(79.4188).clipAngle(180-.001)}function jy(n,t){return[n,t]}jy.invert=jy;function jk(n,t,e){e=e||{};var r=e.units||"kilometers",i=e.steps||8;if(!n)throw new Error("geojson is required");if(typeof e!="object")throw new Error("options must be an object");if(typeof i!="number")throw new Error("steps must be an number");if(t===void 0)throw new Error("radius is required");if(i<=0)throw new Error("steps must be greater than 0");var s=[];switch(n.type){case"GeometryCollection":return Xa(n,function(o){var a=gu(o,t,r,i);a&&s.push(a)}),Ir(s);case"FeatureCollection":return ho(n,function(o){var a=gu(o,t,r,i);a&&ho(a,function(l){l&&s.push(l)})}),Ir(s)}return gu(n,t,r,i)}function gu(n,t,e,r){var i=n.properties||{},s=n.type==="Feature"?n.geometry:n;if(s.type==="GeometryCollection"){var o=[];return Xa(n,function(_){var v=gu(_,t,e,r);v&&o.push(v)}),Ir(o)}var a=$k(s),l={type:s.type,coordinates:OE(s.coordinates,a)},c=new mg,u=c.read(l),h=sg(og(t,e),"meters"),f=Ne.bufferOp(u,h,r),d=new nE;if(f=d.write(f),!NE(f.coordinates)){var p={type:f.type,coordinates:DE(f.coordinates,a)};return Pr(p,i)}}function NE(n){return Array.isArray(n[0])?NE(n[0]):isNaN(n[0])}function OE(n,t){return typeof n[0]!="object"?t(n):n.map(function(e){return OE(e,t)})}function DE(n,t){return typeof n[0]!="object"?t.invert(n):n.map(function(e){return DE(e,t)})}function $k(n){var t=lg(n).geometry.coordinates,e=[-t[0],-t[1]];return Hk().rotate(e).scale(nn)}/**
 * splaytree v3.1.2
 * Fast Splay tree for Node and browser
 *
 * @author Alexander Milevski <info@w8r.name>
 * @license MIT
 * @preserve
 *//*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */function Xk(n,t){var e={label:0,sent:function(){if(s[0]&1)throw s[1];return s[1]},trys:[],ops:[]},r,i,s,o;return o={next:a(0),throw:a(1),return:a(2)},typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function a(c){return function(u){return l([c,u])}}function l(c){if(r)throw new TypeError("Generator is already executing.");for(;e;)try{if(r=1,i&&(s=c[0]&2?i.return:c[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,c[1])).done)return s;switch(i=0,s&&(c=[c[0]&2,s.value]),c[0]){case 0:case 1:s=c;break;case 4:return e.label++,{value:c[1],done:!1};case 5:e.label++,i=c[1],c=[0];continue;case 7:c=e.ops.pop(),e.trys.pop();continue;default:if(s=e.trys,!(s=s.length>0&&s[s.length-1])&&(c[0]===6||c[0]===2)){e=0;continue}if(c[0]===3&&(!s||c[1]>s[0]&&c[1]<s[3])){e.label=c[1];break}if(c[0]===6&&e.label<s[1]){e.label=s[1],s=c;break}if(s&&e.label<s[2]){e.label=s[2],e.ops.push(c);break}s[2]&&e.ops.pop(),e.trys.pop();continue}c=t.call(n,e)}catch(u){c=[6,u],i=0}finally{r=s=0}if(c[0]&5)throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}var Us=function(){function n(t,e){this.next=null,this.key=t,this.data=e,this.left=null,this.right=null}return n}();function Gk(n,t){return n>t?1:n<t?-1:0}function ds(n,t,e){for(var r=new Us(null,null),i=r,s=r;;){var o=e(n,t.key);if(o<0){if(t.left===null)break;if(e(n,t.left.key)<0){var a=t.left;if(t.left=a.right,a.right=t,t=a,t.left===null)break}s.left=t,s=t,t=t.left}else if(o>0){if(t.right===null)break;if(e(n,t.right.key)>0){var a=t.right;if(t.right=a.left,a.left=t,t=a,t.right===null)break}i.right=t,i=t,t=t.right}else break}return i.right=t.left,s.left=t.right,t.left=r.right,t.right=r.left,t}function jf(n,t,e,r){var i=new Us(n,t);if(e===null)return i.left=i.right=null,i;e=ds(n,e,r);var s=r(n,e.key);return s<0?(i.left=e.left,i.right=e,e.left=null):s>=0&&(i.right=e.right,i.left=e,e.right=null),i}function $y(n,t,e){var r=null,i=null;if(t){t=ds(n,t,e);var s=e(t.key,n);s===0?(r=t.left,i=t.right):s<0?(i=t.right,t.right=null,r=t):(r=t.left,t.left=null,i=t)}return{left:r,right:i}}function Yk(n,t,e){return t===null?n:(n===null||(t=ds(n.key,t,e),t.left=n),t)}function qd(n,t,e,r,i){if(n){r(""+t+(e?" ":" ")+i(n)+`
`);var s=t+(e?"    ":"   ");n.left&&qd(n.left,s,!1,r,i),n.right&&qd(n.right,s,!0,r,i)}}var Cg=function(){function n(t){t===void 0&&(t=Gk),this._root=null,this._size=0,this._comparator=t}return n.prototype.insert=function(t,e){return this._size++,this._root=jf(t,e,this._root,this._comparator)},n.prototype.add=function(t,e){var r=new Us(t,e);this._root===null&&(r.left=r.right=null,this._size++,this._root=r);var i=this._comparator,s=ds(t,this._root,i),o=i(t,s.key);return o===0?this._root=s:(o<0?(r.left=s.left,r.right=s,s.left=null):o>0&&(r.right=s.right,r.left=s,s.right=null),this._size++,this._root=r),this._root},n.prototype.remove=function(t){this._root=this._remove(t,this._root,this._comparator)},n.prototype._remove=function(t,e,r){var i;if(e===null)return null;e=ds(t,e,r);var s=r(t,e.key);return s===0?(e.left===null?i=e.right:(i=ds(t,e.left,r),i.right=e.right),this._size--,i):e},n.prototype.pop=function(){var t=this._root;if(t){for(;t.left;)t=t.left;return this._root=ds(t.key,this._root,this._comparator),this._root=this._remove(t.key,this._root,this._comparator),{key:t.key,data:t.data}}return null},n.prototype.findStatic=function(t){for(var e=this._root,r=this._comparator;e;){var i=r(t,e.key);if(i===0)return e;i<0?e=e.left:e=e.right}return null},n.prototype.find=function(t){return this._root&&(this._root=ds(t,this._root,this._comparator),this._comparator(t,this._root.key)!==0)?null:this._root},n.prototype.contains=function(t){for(var e=this._root,r=this._comparator;e;){var i=r(t,e.key);if(i===0)return!0;i<0?e=e.left:e=e.right}return!1},n.prototype.forEach=function(t,e){for(var r=this._root,i=[],s=!1;!s;)r!==null?(i.push(r),r=r.left):i.length!==0?(r=i.pop(),t.call(e,r),r=r.right):s=!0;return this},n.prototype.range=function(t,e,r,i){for(var s=[],o=this._comparator,a=this._root,l;s.length!==0||a;)if(a)s.push(a),a=a.left;else{if(a=s.pop(),l=o(a.key,e),l>0)break;if(o(a.key,t)>=0&&r.call(i,a))return this;a=a.right}return this},n.prototype.keys=function(){var t=[];return this.forEach(function(e){var r=e.key;return t.push(r)}),t},n.prototype.values=function(){var t=[];return this.forEach(function(e){var r=e.data;return t.push(r)}),t},n.prototype.min=function(){return this._root?this.minNode(this._root).key:null},n.prototype.max=function(){return this._root?this.maxNode(this._root).key:null},n.prototype.minNode=function(t){if(t===void 0&&(t=this._root),t)for(;t.left;)t=t.left;return t},n.prototype.maxNode=function(t){if(t===void 0&&(t=this._root),t)for(;t.right;)t=t.right;return t},n.prototype.at=function(t){for(var e=this._root,r=!1,i=0,s=[];!r;)if(e)s.push(e),e=e.left;else if(s.length>0){if(e=s.pop(),i===t)return e;i++,e=e.right}else r=!0;return null},n.prototype.next=function(t){var e=this._root,r=null;if(t.right){for(r=t.right;r.left;)r=r.left;return r}for(var i=this._comparator;e;){var s=i(t.key,e.key);if(s===0)break;s<0?(r=e,e=e.left):e=e.right}return r},n.prototype.prev=function(t){var e=this._root,r=null;if(t.left!==null){for(r=t.left;r.right;)r=r.right;return r}for(var i=this._comparator;e;){var s=i(t.key,e.key);if(s===0)break;s<0?e=e.left:(r=e,e=e.right)}return r},n.prototype.clear=function(){return this._root=null,this._size=0,this},n.prototype.toList=function(){return Kk(this._root)},n.prototype.load=function(t,e,r){e===void 0&&(e=[]),r===void 0&&(r=!1);var i=t.length,s=this._comparator;if(r&&Jd(t,e,0,i-1,s),this._root===null)this._root=Kd(t,e,0,i),this._size=i;else{var o=Zk(this.toList(),qk(t,e),s);i=this._size+i,this._root=Zd({head:o},0,i)}return this},n.prototype.isEmpty=function(){return this._root===null},Object.defineProperty(n.prototype,"size",{get:function(){return this._size},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"root",{get:function(){return this._root},enumerable:!0,configurable:!0}),n.prototype.toString=function(t){t===void 0&&(t=function(r){return String(r.key)});var e=[];return qd(this._root,"",!0,function(r){return e.push(r)},t),e.join("")},n.prototype.update=function(t,e,r){var i=this._comparator,s=$y(t,this._root,i),o=s.left,a=s.right;i(t,e)<0?a=jf(e,r,a,i):o=jf(e,r,o,i),this._root=Yk(o,a,i)},n.prototype.split=function(t){return $y(t,this._root,this._comparator)},n.prototype[Symbol.iterator]=function(){var t,e,r;return Xk(this,function(i){switch(i.label){case 0:t=this._root,e=[],r=!1,i.label=1;case 1:return r?[3,6]:t===null?[3,2]:(e.push(t),t=t.left,[3,5]);case 2:return e.length===0?[3,4]:(t=e.pop(),[4,t]);case 3:return i.sent(),t=t.right,[3,5];case 4:r=!0,i.label=5;case 5:return[3,1];case 6:return[2]}})},n}();function Kd(n,t,e,r){var i=r-e;if(i>0){var s=e+Math.floor(i/2),o=n[s],a=t[s],l=new Us(o,a);return l.left=Kd(n,t,e,s),l.right=Kd(n,t,s+1,r),l}return null}function qk(n,t){for(var e=new Us(null,null),r=e,i=0;i<n.length;i++)r=r.next=new Us(n[i],t[i]);return r.next=null,e.next}function Kk(n){for(var t=n,e=[],r=!1,i=new Us(null,null),s=i;!r;)t?(e.push(t),t=t.left):e.length>0?(t=s=s.next=e.pop(),t=t.right):r=!0;return s.next=null,i.next}function Zd(n,t,e){var r=e-t;if(r>0){var i=t+Math.floor(r/2),s=Zd(n,t,i),o=n.head;return o.left=s,n.head=n.head.next,o.right=Zd(n,i+1,e),o}return null}function Zk(n,t,e){for(var r=new Us(null,null),i=r,s=n,o=t;s!==null&&o!==null;)e(s.key,o.key)<0?(i.next=s,s=s.next):(i.next=o,o=o.next),i=i.next;return s!==null?i.next=s:o!==null&&(i.next=o),r.next}function Jd(n,t,e,r,i){if(!(e>=r)){for(var s=n[e+r>>1],o=e-1,a=r+1;;){do o++;while(i(n[o],s)<0);do a--;while(i(n[a],s)>0);if(o>=a)break;var l=n[o];n[o]=n[a],n[a]=l,l=t[o],t[o]=t[a],t[a]=l}Jd(n,t,e,a,i),Jd(n,t,a+1,r,i)}}const Xi=11102230246251565e-32,gn=134217729,Jk=(3+8*Xi)*Xi;function $f(n,t,e,r,i){let s,o,a,l,c=t[0],u=r[0],h=0,f=0;u>c==u>-c?(s=c,c=t[++h]):(s=u,u=r[++f]);let d=0;if(h<n&&f<e)for(u>c==u>-c?(o=c+s,a=s-(o-c),c=t[++h]):(o=u+s,a=s-(o-u),u=r[++f]),s=o,a!==0&&(i[d++]=a);h<n&&f<e;)u>c==u>-c?(o=s+c,l=o-s,a=s-(o-l)+(c-l),c=t[++h]):(o=s+u,l=o-s,a=s-(o-l)+(u-l),u=r[++f]),s=o,a!==0&&(i[d++]=a);for(;h<n;)o=s+c,l=o-s,a=s-(o-l)+(c-l),c=t[++h],s=o,a!==0&&(i[d++]=a);for(;f<e;)o=s+u,l=o-s,a=s-(o-l)+(u-l),u=r[++f],s=o,a!==0&&(i[d++]=a);return(s!==0||d===0)&&(i[d++]=s),d}function Qk(n,t){let e=t[0];for(let r=1;r<n;r++)e+=t[r];return e}function yc(n){return new Float64Array(n)}const tF=(3+16*Xi)*Xi,eF=(2+12*Xi)*Xi,nF=(9+64*Xi)*Xi*Xi,$o=yc(4),Xy=yc(8),Gy=yc(12),Yy=yc(16),Cn=yc(4);function rF(n,t,e,r,i,s,o){let a,l,c,u,h,f,d,p,_,v,E,m,g,y,b,x,w,S;const I=n-i,T=e-i,M=t-s,L=r-s;y=I*L,f=gn*I,d=f-(f-I),p=I-d,f=gn*L,_=f-(f-L),v=L-_,b=p*v-(y-d*_-p*_-d*v),x=M*T,f=gn*M,d=f-(f-M),p=M-d,f=gn*T,_=f-(f-T),v=T-_,w=p*v-(x-d*_-p*_-d*v),E=b-w,h=b-E,$o[0]=b-(E+h)+(h-w),m=y+E,h=m-y,g=y-(m-h)+(E-h),E=g-x,h=g-E,$o[1]=g-(E+h)+(h-x),S=m+E,h=S-m,$o[2]=m-(S-h)+(E-h),$o[3]=S;let O=Qk(4,$o),P=eF*o;if(O>=P||-O>=P||(h=n-I,a=n-(I+h)+(h-i),h=e-T,c=e-(T+h)+(h-i),h=t-M,l=t-(M+h)+(h-s),h=r-L,u=r-(L+h)+(h-s),a===0&&l===0&&c===0&&u===0)||(P=nF*o+Jk*Math.abs(O),O+=I*u+L*a-(M*c+T*l),O>=P||-O>=P))return O;y=a*L,f=gn*a,d=f-(f-a),p=a-d,f=gn*L,_=f-(f-L),v=L-_,b=p*v-(y-d*_-p*_-d*v),x=l*T,f=gn*l,d=f-(f-l),p=l-d,f=gn*T,_=f-(f-T),v=T-_,w=p*v-(x-d*_-p*_-d*v),E=b-w,h=b-E,Cn[0]=b-(E+h)+(h-w),m=y+E,h=m-y,g=y-(m-h)+(E-h),E=g-x,h=g-E,Cn[1]=g-(E+h)+(h-x),S=m+E,h=S-m,Cn[2]=m-(S-h)+(E-h),Cn[3]=S;const V=$f(4,$o,4,Cn,Xy);y=I*u,f=gn*I,d=f-(f-I),p=I-d,f=gn*u,_=f-(f-u),v=u-_,b=p*v-(y-d*_-p*_-d*v),x=M*c,f=gn*M,d=f-(f-M),p=M-d,f=gn*c,_=f-(f-c),v=c-_,w=p*v-(x-d*_-p*_-d*v),E=b-w,h=b-E,Cn[0]=b-(E+h)+(h-w),m=y+E,h=m-y,g=y-(m-h)+(E-h),E=g-x,h=g-E,Cn[1]=g-(E+h)+(h-x),S=m+E,h=S-m,Cn[2]=m-(S-h)+(E-h),Cn[3]=S;const C=$f(V,Xy,4,Cn,Gy);y=a*u,f=gn*a,d=f-(f-a),p=a-d,f=gn*u,_=f-(f-u),v=u-_,b=p*v-(y-d*_-p*_-d*v),x=l*c,f=gn*l,d=f-(f-l),p=l-d,f=gn*c,_=f-(f-c),v=c-_,w=p*v-(x-d*_-p*_-d*v),E=b-w,h=b-E,Cn[0]=b-(E+h)+(h-w),m=y+E,h=m-y,g=y-(m-h)+(E-h),E=g-x,h=g-E,Cn[1]=g-(E+h)+(h-x),S=m+E,h=S-m,Cn[2]=m-(S-h)+(E-h),Cn[3]=S;const R=$f(C,Gy,4,Cn,Yy);return Yy[R-1]}function iF(n,t,e,r,i,s){const o=(t-s)*(e-i),a=(n-i)*(r-s),l=o-a,c=Math.abs(o+a);return Math.abs(l)>=tF*c?l:-rF(n,t,e,r,i,s,c)}var LE={};const il=(n,t)=>n.ll.x<=t.x&&t.x<=n.ur.x&&n.ll.y<=t.y&&t.y<=n.ur.y,Qd=(n,t)=>{if(t.ur.x<n.ll.x||n.ur.x<t.ll.x||t.ur.y<n.ll.y||n.ur.y<t.ll.y)return null;const e=n.ll.x<t.ll.x?t.ll.x:n.ll.x,r=n.ur.x<t.ur.x?n.ur.x:t.ur.x,i=n.ll.y<t.ll.y?t.ll.y:n.ll.y,s=n.ur.y<t.ur.y?n.ur.y:t.ur.y;return{ll:{x:e,y:i},ur:{x:r,y:s}}};let bs=Number.EPSILON;bs===void 0&&(bs=Math.pow(2,-52));const sF=bs*bs,qy=(n,t)=>{if(-bs<n&&n<bs&&-bs<t&&t<bs)return 0;const e=n-t;return e*e<sF*n*t?0:n<t?-1:1};class oF{constructor(){this.reset()}reset(){this.xRounder=new Ky,this.yRounder=new Ky}round(t,e){return{x:this.xRounder.round(t),y:this.yRounder.round(e)}}}class Ky{constructor(){this.tree=new Cg,this.round(0)}round(t){const e=this.tree.add(t),r=this.tree.prev(e);if(r!==null&&qy(e.key,r.key)===0)return this.tree.remove(t),r.key;const i=this.tree.next(e);return i!==null&&qy(e.key,i.key)===0?(this.tree.remove(t),i.key):t}}const Yl=new oF,mu=(n,t)=>n.x*t.y-n.y*t.x,kE=(n,t)=>n.x*t.x+n.y*t.y,Zy=(n,t,e)=>{const r=iF(n.x,n.y,t.x,t.y,e.x,e.y);return r>0?-1:r<0?1:0},ch=n=>Math.sqrt(kE(n,n)),aF=(n,t,e)=>{const r={x:t.x-n.x,y:t.y-n.y},i={x:e.x-n.x,y:e.y-n.y};return mu(i,r)/ch(i)/ch(r)},lF=(n,t,e)=>{const r={x:t.x-n.x,y:t.y-n.y},i={x:e.x-n.x,y:e.y-n.y};return kE(i,r)/ch(i)/ch(r)},Jy=(n,t,e)=>t.y===0?null:{x:n.x+t.x/t.y*(e-n.y),y:e},Qy=(n,t,e)=>t.x===0?null:{x:e,y:n.y+t.y/t.x*(e-n.x)},cF=(n,t,e,r)=>{if(t.x===0)return Qy(e,r,n.x);if(r.x===0)return Qy(n,t,e.x);if(t.y===0)return Jy(e,r,n.y);if(r.y===0)return Jy(n,t,e.y);const i=mu(t,r);if(i==0)return null;const s={x:e.x-n.x,y:e.y-n.y},o=mu(s,t)/i,a=mu(s,r)/i,l=n.x+a*t.x,c=e.x+o*r.x,u=n.y+a*t.y,h=e.y+o*r.y,f=(l+c)/2,d=(u+h)/2;return{x:f,y:d}};class yr{static compare(t,e){const r=yr.comparePoints(t.point,e.point);return r!==0?r:(t.point!==e.point&&t.link(e),t.isLeft!==e.isLeft?t.isLeft?1:-1:Ps.compare(t.segment,e.segment))}static comparePoints(t,e){return t.x<e.x?-1:t.x>e.x?1:t.y<e.y?-1:t.y>e.y?1:0}constructor(t,e){t.events===void 0?t.events=[this]:t.events.push(this),this.point=t,this.isLeft=e}link(t){if(t.point===this.point)throw new Error("Tried to link already linked events");const e=t.point.events;for(let r=0,i=e.length;r<i;r++){const s=e[r];this.point.events.push(s),s.point=this.point}this.checkForConsuming()}checkForConsuming(){const t=this.point.events.length;for(let e=0;e<t;e++){const r=this.point.events[e];if(r.segment.consumedBy===void 0)for(let i=e+1;i<t;i++){const s=this.point.events[i];s.consumedBy===void 0&&r.otherSE.point.events===s.otherSE.point.events&&r.segment.consume(s.segment)}}}getAvailableLinkedEvents(){const t=[];for(let e=0,r=this.point.events.length;e<r;e++){const i=this.point.events[e];i!==this&&!i.segment.ringOut&&i.segment.isInResult()&&t.push(i)}return t}getLeftmostComparator(t){const e=new Map,r=i=>{const s=i.otherSE;e.set(i,{sine:aF(this.point,t.point,s.point),cosine:lF(this.point,t.point,s.point)})};return(i,s)=>{e.has(i)||r(i),e.has(s)||r(s);const{sine:o,cosine:a}=e.get(i),{sine:l,cosine:c}=e.get(s);return o>=0&&l>=0?a<c?1:a>c?-1:0:o<0&&l<0?a<c?-1:a>c?1:0:l<o?-1:l>o?1:0}}}let uF=0;class Ps{static compare(t,e){const r=t.leftSE.point.x,i=e.leftSE.point.x,s=t.rightSE.point.x,o=e.rightSE.point.x;if(o<r)return 1;if(s<i)return-1;const a=t.leftSE.point.y,l=e.leftSE.point.y,c=t.rightSE.point.y,u=e.rightSE.point.y;if(r<i){if(l<a&&l<c)return 1;if(l>a&&l>c)return-1;const h=t.comparePoint(e.leftSE.point);if(h<0)return 1;if(h>0)return-1;const f=e.comparePoint(t.rightSE.point);return f!==0?f:-1}if(r>i){if(a<l&&a<u)return-1;if(a>l&&a>u)return 1;const h=e.comparePoint(t.leftSE.point);if(h!==0)return h;const f=t.comparePoint(e.rightSE.point);return f<0?1:f>0?-1:1}if(a<l)return-1;if(a>l)return 1;if(s<o){const h=e.comparePoint(t.rightSE.point);if(h!==0)return h}if(s>o){const h=t.comparePoint(e.rightSE.point);if(h<0)return 1;if(h>0)return-1}if(s!==o){const h=c-a,f=s-r,d=u-l,p=o-i;if(h>f&&d<p)return 1;if(h<f&&d>p)return-1}return s>o?1:s<o||c<u?-1:c>u?1:t.id<e.id?-1:t.id>e.id?1:0}constructor(t,e,r,i){this.id=++uF,this.leftSE=t,t.segment=this,t.otherSE=e,this.rightSE=e,e.segment=this,e.otherSE=t,this.rings=r,this.windings=i}static fromRing(t,e,r){let i,s,o;const a=yr.comparePoints(t,e);if(a<0)i=t,s=e,o=1;else if(a>0)i=e,s=t,o=-1;else throw new Error(`Tried to create degenerate segment at [${t.x}, ${t.y}]`);const l=new yr(i,!0),c=new yr(s,!1);return new Ps(l,c,[r],[o])}replaceRightSE(t){this.rightSE=t,this.rightSE.segment=this,this.rightSE.otherSE=this.leftSE,this.leftSE.otherSE=this.rightSE}bbox(){const t=this.leftSE.point.y,e=this.rightSE.point.y;return{ll:{x:this.leftSE.point.x,y:t<e?t:e},ur:{x:this.rightSE.point.x,y:t>e?t:e}}}vector(){return{x:this.rightSE.point.x-this.leftSE.point.x,y:this.rightSE.point.y-this.leftSE.point.y}}isAnEndpoint(t){return t.x===this.leftSE.point.x&&t.y===this.leftSE.point.y||t.x===this.rightSE.point.x&&t.y===this.rightSE.point.y}comparePoint(t){if(this.isAnEndpoint(t))return 0;const e=this.leftSE.point,r=this.rightSE.point,i=this.vector();if(e.x===r.x)return t.x===e.x?0:t.x<e.x?1:-1;const s=(t.y-e.y)/i.y,o=e.x+s*i.x;if(t.x===o)return 0;const a=(t.x-e.x)/i.x,l=e.y+a*i.y;return t.y===l?0:t.y<l?-1:1}getIntersection(t){const e=this.bbox(),r=t.bbox(),i=Qd(e,r);if(i===null)return null;const s=this.leftSE.point,o=this.rightSE.point,a=t.leftSE.point,l=t.rightSE.point,c=il(e,a)&&this.comparePoint(a)===0,u=il(r,s)&&t.comparePoint(s)===0,h=il(e,l)&&this.comparePoint(l)===0,f=il(r,o)&&t.comparePoint(o)===0;if(u&&c)return f&&!h?o:!f&&h?l:null;if(u)return h&&s.x===l.x&&s.y===l.y?null:s;if(c)return f&&o.x===a.x&&o.y===a.y?null:a;if(f&&h)return null;if(f)return o;if(h)return l;const d=cF(s,this.vector(),a,t.vector());return d===null||!il(i,d)?null:Yl.round(d.x,d.y)}split(t){const e=[],r=t.events!==void 0,i=new yr(t,!0),s=new yr(t,!1),o=this.rightSE;this.replaceRightSE(s),e.push(s),e.push(i);const a=new Ps(i,o,this.rings.slice(),this.windings.slice());return yr.comparePoints(a.leftSE.point,a.rightSE.point)>0&&a.swapEvents(),yr.comparePoints(this.leftSE.point,this.rightSE.point)>0&&this.swapEvents(),r&&(i.checkForConsuming(),s.checkForConsuming()),e}swapEvents(){const t=this.rightSE;this.rightSE=this.leftSE,this.leftSE=t,this.leftSE.isLeft=!0,this.rightSE.isLeft=!1;for(let e=0,r=this.windings.length;e<r;e++)this.windings[e]*=-1}consume(t){let e=this,r=t;for(;e.consumedBy;)e=e.consumedBy;for(;r.consumedBy;)r=r.consumedBy;const i=Ps.compare(e,r);if(i!==0){if(i>0){const s=e;e=r,r=s}if(e.prev===r){const s=e;e=r,r=s}for(let s=0,o=r.rings.length;s<o;s++){const a=r.rings[s],l=r.windings[s],c=e.rings.indexOf(a);c===-1?(e.rings.push(a),e.windings.push(l)):e.windings[c]+=l}r.rings=null,r.windings=null,r.consumedBy=e,r.leftSE.consumedBy=e.leftSE,r.rightSE.consumedBy=e.rightSE}}prevInResult(){return this._prevInResult!==void 0?this._prevInResult:(this.prev?this.prev.isInResult()?this._prevInResult=this.prev:this._prevInResult=this.prev.prevInResult():this._prevInResult=null,this._prevInResult)}beforeState(){if(this._beforeState!==void 0)return this._beforeState;if(!this.prev)this._beforeState={rings:[],windings:[],multiPolys:[]};else{const t=this.prev.consumedBy||this.prev;this._beforeState=t.afterState()}return this._beforeState}afterState(){if(this._afterState!==void 0)return this._afterState;const t=this.beforeState();this._afterState={rings:t.rings.slice(0),windings:t.windings.slice(0),multiPolys:[]};const e=this._afterState.rings,r=this._afterState.windings,i=this._afterState.multiPolys;for(let a=0,l=this.rings.length;a<l;a++){const c=this.rings[a],u=this.windings[a],h=e.indexOf(c);h===-1?(e.push(c),r.push(u)):r[h]+=u}const s=[],o=[];for(let a=0,l=e.length;a<l;a++){if(r[a]===0)continue;const c=e[a],u=c.poly;if(o.indexOf(u)===-1)if(c.isExterior)s.push(u);else{o.indexOf(u)===-1&&o.push(u);const h=s.indexOf(c.poly);h!==-1&&s.splice(h,1)}}for(let a=0,l=s.length;a<l;a++){const c=s[a].multiPoly;i.indexOf(c)===-1&&i.push(c)}return this._afterState}isInResult(){if(this.consumedBy)return!1;if(this._isInResult!==void 0)return this._isInResult;const t=this.beforeState().multiPolys,e=this.afterState().multiPolys;switch(Gr.type){case"union":{const r=t.length===0,i=e.length===0;this._isInResult=r!==i;break}case"intersection":{let r,i;t.length<e.length?(r=t.length,i=e.length):(r=e.length,i=t.length),this._isInResult=i===Gr.numMultiPolys&&r<i;break}case"xor":{const r=Math.abs(t.length-e.length);this._isInResult=r%2===1;break}case"difference":{const r=i=>i.length===1&&i[0].isSubject;this._isInResult=r(t)!==r(e);break}default:throw new Error(`Unrecognized operation type found ${Gr.type}`)}return this._isInResult}}class tv{constructor(t,e,r){if(!Array.isArray(t)||t.length===0)throw new Error("Input geometry is not a valid Polygon or MultiPolygon");if(this.poly=e,this.isExterior=r,this.segments=[],typeof t[0][0]!="number"||typeof t[0][1]!="number")throw new Error("Input geometry is not a valid Polygon or MultiPolygon");const i=Yl.round(t[0][0],t[0][1]);this.bbox={ll:{x:i.x,y:i.y},ur:{x:i.x,y:i.y}};let s=i;for(let o=1,a=t.length;o<a;o++){if(typeof t[o][0]!="number"||typeof t[o][1]!="number")throw new Error("Input geometry is not a valid Polygon or MultiPolygon");let l=Yl.round(t[o][0],t[o][1]);l.x===s.x&&l.y===s.y||(this.segments.push(Ps.fromRing(s,l,this)),l.x<this.bbox.ll.x&&(this.bbox.ll.x=l.x),l.y<this.bbox.ll.y&&(this.bbox.ll.y=l.y),l.x>this.bbox.ur.x&&(this.bbox.ur.x=l.x),l.y>this.bbox.ur.y&&(this.bbox.ur.y=l.y),s=l)}(i.x!==s.x||i.y!==s.y)&&this.segments.push(Ps.fromRing(s,i,this))}getSweepEvents(){const t=[];for(let e=0,r=this.segments.length;e<r;e++){const i=this.segments[e];t.push(i.leftSE),t.push(i.rightSE)}return t}}class hF{constructor(t,e){if(!Array.isArray(t))throw new Error("Input geometry is not a valid Polygon or MultiPolygon");this.exteriorRing=new tv(t[0],this,!0),this.bbox={ll:{x:this.exteriorRing.bbox.ll.x,y:this.exteriorRing.bbox.ll.y},ur:{x:this.exteriorRing.bbox.ur.x,y:this.exteriorRing.bbox.ur.y}},this.interiorRings=[];for(let r=1,i=t.length;r<i;r++){const s=new tv(t[r],this,!1);s.bbox.ll.x<this.bbox.ll.x&&(this.bbox.ll.x=s.bbox.ll.x),s.bbox.ll.y<this.bbox.ll.y&&(this.bbox.ll.y=s.bbox.ll.y),s.bbox.ur.x>this.bbox.ur.x&&(this.bbox.ur.x=s.bbox.ur.x),s.bbox.ur.y>this.bbox.ur.y&&(this.bbox.ur.y=s.bbox.ur.y),this.interiorRings.push(s)}this.multiPoly=e}getSweepEvents(){const t=this.exteriorRing.getSweepEvents();for(let e=0,r=this.interiorRings.length;e<r;e++){const i=this.interiorRings[e].getSweepEvents();for(let s=0,o=i.length;s<o;s++)t.push(i[s])}return t}}class ev{constructor(t,e){if(!Array.isArray(t))throw new Error("Input geometry is not a valid Polygon or MultiPolygon");try{typeof t[0][0][0]=="number"&&(t=[t])}catch{}this.polys=[],this.bbox={ll:{x:Number.POSITIVE_INFINITY,y:Number.POSITIVE_INFINITY},ur:{x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY}};for(let r=0,i=t.length;r<i;r++){const s=new hF(t[r],this);s.bbox.ll.x<this.bbox.ll.x&&(this.bbox.ll.x=s.bbox.ll.x),s.bbox.ll.y<this.bbox.ll.y&&(this.bbox.ll.y=s.bbox.ll.y),s.bbox.ur.x>this.bbox.ur.x&&(this.bbox.ur.x=s.bbox.ur.x),s.bbox.ur.y>this.bbox.ur.y&&(this.bbox.ur.y=s.bbox.ur.y),this.polys.push(s)}this.isSubject=e}getSweepEvents(){const t=[];for(let e=0,r=this.polys.length;e<r;e++){const i=this.polys[e].getSweepEvents();for(let s=0,o=i.length;s<o;s++)t.push(i[s])}return t}}class uh{static factory(t){const e=[];for(let r=0,i=t.length;r<i;r++){const s=t[r];if(!s.isInResult()||s.ringOut)continue;let o=null,a=s.leftSE,l=s.rightSE;const c=[a],u=a.point,h=[];for(;o=a,a=l,c.push(a),a.point!==u;)for(;;){const f=a.getAvailableLinkedEvents();if(f.length===0){const _=c[0].point,v=c[c.length-1].point;throw new Error(`Unable to complete output ring starting at [${_.x}, ${_.y}]. Last matching segment found ends at [${v.x}, ${v.y}].`)}if(f.length===1){l=f[0].otherSE;break}let d=null;for(let _=0,v=h.length;_<v;_++)if(h[_].point===a.point){d=_;break}if(d!==null){const _=h.splice(d)[0],v=c.splice(_.index);v.unshift(v[0].otherSE),e.push(new uh(v.reverse()));continue}h.push({index:c.length,point:a.point});const p=a.getLeftmostComparator(o);l=f.sort(p)[0].otherSE;break}e.push(new uh(c))}return e}constructor(t){this.events=t;for(let e=0,r=t.length;e<r;e++)t[e].segment.ringOut=this;this.poly=null}getGeom(){let t=this.events[0].point;const e=[t];for(let c=1,u=this.events.length-1;c<u;c++){const h=this.events[c].point,f=this.events[c+1].point;Zy(h,t,f)!==0&&(e.push(h),t=h)}if(e.length===1)return null;const r=e[0],i=e[1];Zy(r,t,i)===0&&e.shift(),e.push(e[0]);const s=this.isExteriorRing()?1:-1,o=this.isExteriorRing()?0:e.length-1,a=this.isExteriorRing()?e.length:-1,l=[];for(let c=o;c!=a;c+=s)l.push([e[c].x,e[c].y]);return l}isExteriorRing(){if(this._isExteriorRing===void 0){const t=this.enclosingRing();this._isExteriorRing=t?!t.isExteriorRing():!0}return this._isExteriorRing}enclosingRing(){return this._enclosingRing===void 0&&(this._enclosingRing=this._calcEnclosingRing()),this._enclosingRing}_calcEnclosingRing(){let t=this.events[0];for(let i=1,s=this.events.length;i<s;i++){const o=this.events[i];yr.compare(t,o)>0&&(t=o)}let e=t.segment.prevInResult(),r=e?e.prevInResult():null;for(;;){if(!e)return null;if(!r)return e.ringOut;if(r.ringOut!==e.ringOut)return r.ringOut.enclosingRing()!==e.ringOut?e.ringOut:e.ringOut.enclosingRing();e=r.prevInResult(),r=e?e.prevInResult():null}}}class nv{constructor(t){this.exteriorRing=t,t.poly=this,this.interiorRings=[]}addInterior(t){this.interiorRings.push(t),t.poly=this}getGeom(){const t=[this.exteriorRing.getGeom()];if(t[0]===null)return null;for(let e=0,r=this.interiorRings.length;e<r;e++){const i=this.interiorRings[e].getGeom();i!==null&&t.push(i)}return t}}class fF{constructor(t){this.rings=t,this.polys=this._composePolys(t)}getGeom(){const t=[];for(let e=0,r=this.polys.length;e<r;e++){const i=this.polys[e].getGeom();i!==null&&t.push(i)}return t}_composePolys(t){const e=[];for(let r=0,i=t.length;r<i;r++){const s=t[r];if(!s.poly)if(s.isExteriorRing())e.push(new nv(s));else{const o=s.enclosingRing();o.poly||e.push(new nv(o)),o.poly.addInterior(s)}}return e}}class dF{constructor(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Ps.compare;this.queue=t,this.tree=new Cg(e),this.segments=[]}process(t){const e=t.segment,r=[];if(t.consumedBy)return t.isLeft?this.queue.remove(t.otherSE):this.tree.remove(e),r;const i=t.isLeft?this.tree.add(e):this.tree.find(e);if(!i)throw new Error(`Unable to find segment #${e.id} [${e.leftSE.point.x}, ${e.leftSE.point.y}] -> [${e.rightSE.point.x}, ${e.rightSE.point.y}] in SweepLine tree.`);let s=i,o=i,a,l;for(;a===void 0;)s=this.tree.prev(s),s===null?a=null:s.key.consumedBy===void 0&&(a=s.key);for(;l===void 0;)o=this.tree.next(o),o===null?l=null:o.key.consumedBy===void 0&&(l=o.key);if(t.isLeft){let c=null;if(a){const h=a.getIntersection(e);if(h!==null&&(e.isAnEndpoint(h)||(c=h),!a.isAnEndpoint(h))){const f=this._splitSafely(a,h);for(let d=0,p=f.length;d<p;d++)r.push(f[d])}}let u=null;if(l){const h=l.getIntersection(e);if(h!==null&&(e.isAnEndpoint(h)||(u=h),!l.isAnEndpoint(h))){const f=this._splitSafely(l,h);for(let d=0,p=f.length;d<p;d++)r.push(f[d])}}if(c!==null||u!==null){let h=null;c===null?h=u:u===null?h=c:h=yr.comparePoints(c,u)<=0?c:u,this.queue.remove(e.rightSE),r.push(e.rightSE);const f=e.split(h);for(let d=0,p=f.length;d<p;d++)r.push(f[d])}r.length>0?(this.tree.remove(e),r.push(t)):(this.segments.push(e),e.prev=a)}else{if(a&&l){const c=a.getIntersection(l);if(c!==null){if(!a.isAnEndpoint(c)){const u=this._splitSafely(a,c);for(let h=0,f=u.length;h<f;h++)r.push(u[h])}if(!l.isAnEndpoint(c)){const u=this._splitSafely(l,c);for(let h=0,f=u.length;h<f;h++)r.push(u[h])}}}this.tree.remove(e)}return r}_splitSafely(t,e){this.tree.remove(t);const r=t.rightSE;this.queue.remove(r);const i=t.split(e);return i.push(r),t.consumedBy===void 0&&this.tree.add(t),i}}const rv=typeof process<"u"&&LE.POLYGON_CLIPPING_MAX_QUEUE_SIZE||1e6,pF=typeof process<"u"&&LE.POLYGON_CLIPPING_MAX_SWEEPLINE_SEGMENTS||1e6;class gF{run(t,e,r){Gr.type=t,Yl.reset();const i=[new ev(e,!0)];for(let h=0,f=r.length;h<f;h++)i.push(new ev(r[h],!1));if(Gr.numMultiPolys=i.length,Gr.type==="difference"){const h=i[0];let f=1;for(;f<i.length;)Qd(i[f].bbox,h.bbox)!==null?f++:i.splice(f,1)}if(Gr.type==="intersection")for(let h=0,f=i.length;h<f;h++){const d=i[h];for(let p=h+1,_=i.length;p<_;p++)if(Qd(d.bbox,i[p].bbox)===null)return[]}const s=new Cg(yr.compare);for(let h=0,f=i.length;h<f;h++){const d=i[h].getSweepEvents();for(let p=0,_=d.length;p<_;p++)if(s.insert(d[p]),s.size>rv)throw new Error("Infinite loop when putting segment endpoints in a priority queue (queue size too big).")}const o=new dF(s);let a=s.size,l=s.pop();for(;l;){const h=l.key;if(s.size===a){const d=h.segment;throw new Error(`Unable to pop() ${h.isLeft?"left":"right"} SweepEvent [${h.point.x}, ${h.point.y}] from segment #${d.id} [${d.leftSE.point.x}, ${d.leftSE.point.y}] -> [${d.rightSE.point.x}, ${d.rightSE.point.y}] from queue.`)}if(s.size>rv)throw new Error("Infinite loop when passing sweep line over endpoints (queue size too big).");if(o.segments.length>pF)throw new Error("Infinite loop when passing sweep line over endpoints (too many sweep line segments).");const f=o.process(h);for(let d=0,p=f.length;d<p;d++){const _=f[d];_.consumedBy===void 0&&s.insert(_)}a=s.size,l=s.pop()}Yl.reset();const c=uh.factory(o.segments);return new fF(c).getGeom()}}const Gr=new gF,mF=function(n){for(var t=arguments.length,e=new Array(t>1?t-1:0),r=1;r<t;r++)e[r-1]=arguments[r];return Gr.run("union",n,e)},_F=function(n){for(var t=arguments.length,e=new Array(t>1?t-1:0),r=1;r<t;r++)e[r-1]=arguments[r];return Gr.run("intersection",n,e)},yF=function(n){for(var t=arguments.length,e=new Array(t>1?t-1:0),r=1;r<t;r++)e[r-1]=arguments[r];return Gr.run("xor",n,e)},vF=function(n){for(var t=arguments.length,e=new Array(t>1?t-1:0),r=1;r<t;r++)e[r-1]=arguments[r];return Gr.run("difference",n,e)};var Tg={union:mF,intersection:_F,xor:yF,difference:vF};function Ke(n){if(!n)throw new Error("coord is required");if(!Array.isArray(n)){if(n.type==="Feature"&&n.geometry!==null&&n.geometry.type==="Point")return n.geometry.coordinates;if(n.type==="Point")return n.coordinates}if(Array.isArray(n)&&n.length>=2&&!Array.isArray(n[0])&&!Array.isArray(n[1]))return n;throw new Error("coord must be GeoJSON Point or an Array of numbers")}function An(n){if(Array.isArray(n))return n;if(n.type==="Feature"){if(n.geometry!==null)return n.geometry.coordinates}else if(n.coordinates)return n.coordinates;throw new Error("coords must be GeoJSON Feature, Geometry Object or an Array")}function iv(n,t,e){if(!n)throw new Error("No feature passed");if(!e)throw new Error(".featureOf() requires a name");if(!n||n.type!=="Feature"||!n.geometry)throw new Error("Invalid input to "+e+", Feature with geometry required");if(!n.geometry||n.geometry.type!==t)throw new Error("Invalid input to "+e+": must be a "+t+", given "+n.geometry.type)}function lr(n){return n.type==="Feature"?n.geometry:n}function bF(n,t){return n.type==="FeatureCollection"?"FeatureCollection":n.type==="GeometryCollection"?"GeometryCollection":n.type==="Feature"&&n.geometry!==null?n.geometry.type:n.type}function FE(n,t){var e=lr(n),r=lr(t),i=n.properties||{},s=Tg.difference(e.coordinates,r.coordinates);return s.length===0?null:s.length===1?uo(s[0],i):ig(s,i)}function Zt(n,t,e){e===void 0&&(e={});var r=Ke(n),i=Ke(t),s=cn(i[1]-r[1]),o=cn(i[0]-r[0]),a=cn(r[1]),l=cn(i[1]),c=Math.pow(Math.sin(s/2),2)+Math.pow(Math.sin(o/2),2)*Math.cos(a)*Math.cos(l);return sg(2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c)),e.units)}var Xf={exports:{}},sv;function xF(){return sv||(sv=1,function(n){var t=Object.prototype.hasOwnProperty,e="~";function r(){}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(e=!1));function i(l,c,u){this.fn=l,this.context=c,this.once=u||!1}function s(l,c,u,h,f){if(typeof u!="function")throw new TypeError("The listener must be a function");var d=new i(u,h||l,f),p=e?e+c:c;return l._events[p]?l._events[p].fn?l._events[p]=[l._events[p],d]:l._events[p].push(d):(l._events[p]=d,l._eventsCount++),l}function o(l,c){--l._eventsCount===0?l._events=new r:delete l._events[c]}function a(){this._events=new r,this._eventsCount=0}a.prototype.eventNames=function(){var c=[],u,h;if(this._eventsCount===0)return c;for(h in u=this._events)t.call(u,h)&&c.push(e?h.slice(1):h);return Object.getOwnPropertySymbols?c.concat(Object.getOwnPropertySymbols(u)):c},a.prototype.listeners=function(c){var u=e?e+c:c,h=this._events[u];if(!h)return[];if(h.fn)return[h.fn];for(var f=0,d=h.length,p=new Array(d);f<d;f++)p[f]=h[f].fn;return p},a.prototype.listenerCount=function(c){var u=e?e+c:c,h=this._events[u];return h?h.fn?1:h.length:0},a.prototype.emit=function(c,u,h,f,d,p){var _=e?e+c:c;if(!this._events[_])return!1;var v=this._events[_],E=arguments.length,m,g;if(v.fn){switch(v.once&&this.removeListener(c,v.fn,void 0,!0),E){case 1:return v.fn.call(v.context),!0;case 2:return v.fn.call(v.context,u),!0;case 3:return v.fn.call(v.context,u,h),!0;case 4:return v.fn.call(v.context,u,h,f),!0;case 5:return v.fn.call(v.context,u,h,f,d),!0;case 6:return v.fn.call(v.context,u,h,f,d,p),!0}for(g=1,m=new Array(E-1);g<E;g++)m[g-1]=arguments[g];v.fn.apply(v.context,m)}else{var y=v.length,b;for(g=0;g<y;g++)switch(v[g].once&&this.removeListener(c,v[g].fn,void 0,!0),E){case 1:v[g].fn.call(v[g].context);break;case 2:v[g].fn.call(v[g].context,u);break;case 3:v[g].fn.call(v[g].context,u,h);break;case 4:v[g].fn.call(v[g].context,u,h,f);break;default:if(!m)for(b=1,m=new Array(E-1);b<E;b++)m[b-1]=arguments[b];v[g].fn.apply(v[g].context,m)}}return!0},a.prototype.on=function(c,u,h){return s(this,c,u,h,!1)},a.prototype.once=function(c,u,h){return s(this,c,u,h,!0)},a.prototype.removeListener=function(c,u,h,f){var d=e?e+c:c;if(!this._events[d])return this;if(!u)return o(this,d),this;var p=this._events[d];if(p.fn)p.fn===u&&(!f||p.once)&&(!h||p.context===h)&&o(this,d);else{for(var _=0,v=[],E=p.length;_<E;_++)(p[_].fn!==u||f&&!p[_].once||h&&p[_].context!==h)&&v.push(p[_]);v.length?this._events[d]=v.length===1?v[0]:v:o(this,d)}return this},a.prototype.removeAllListeners=function(c){var u;return c?(u=e?e+c:c,this._events[u]&&o(this,u)):(this._events=new r,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=e,a.EventEmitter=a,n.exports=a}(Xf)),Xf.exports}xF();function is(n,t,e,r){r===void 0&&(r={});var i=Ke(n),s=cn(i[0]),o=cn(i[1]),a=cn(e),l=og(t,r.units),c=Math.asin(Math.sin(o)*Math.cos(l)+Math.cos(o)*Math.sin(l)*Math.cos(a)),u=s+Math.atan2(Math.sin(a)*Math.sin(l)*Math.cos(o),Math.cos(l)-Math.sin(o)*Math.sin(c)),h=Zu(u),f=Zu(c);return wt([h,f],r.properties)}function cr(n,t,e){if(e===void 0&&(e={}),e.final===!0)return EF(n,t);var r=Ke(n),i=Ke(t),s=cn(r[0]),o=cn(i[0]),a=cn(r[1]),l=cn(i[1]),c=Math.sin(o-s)*Math.cos(l),u=Math.cos(a)*Math.sin(l)-Math.sin(a)*Math.cos(l)*Math.cos(o-s);return Zu(Math.atan2(c,u))}function EF(n,t){var e=cr(t,n);return e=(e+180)%360,e}function jh(n,t,e){e===void 0&&(e={});var r=Ke(n),i=Ke(t);i[0]+=i[0]-r[0]>180?-360:r[0]-i[0]>180?360:0;var s=wF(r,i),o=ag(s,"meters",e.units);return o}function wF(n,t,e){e=e===void 0?nn:Number(e);var r=e,i=n[1]*Math.PI/180,s=t[1]*Math.PI/180,o=s-i,a=Math.abs(t[0]-n[0])*Math.PI/180;a>Math.PI&&(a-=2*Math.PI);var l=Math.log(Math.tan(s/2+Math.PI/4)/Math.tan(i/2+Math.PI/4)),c=Math.abs(l)>1e-11?o/l:Math.cos(i),u=Math.sqrt(o*o+c*c*a*a),h=u*r;return h}function SF(n,t,e){if(e===void 0&&(e={}),e.method||(e.method="geodesic"),e.units||(e.units="kilometers"),!n)throw new Error("pt is required");if(Array.isArray(n)?n=wt(n):n.type==="Point"?n=Pr(n):iv(n,"Point","point"),!t)throw new Error("line is required");Array.isArray(t)?t=Nn(t):t.type==="LineString"?t=Pr(t):iv(t,"LineString","line");var r=1/0,i=n.geometry.coordinates;return ek(t,function(s){var o=s.geometry.coordinates[0],a=s.geometry.coordinates[1],l=CF(i,o,a,e);l<r&&(r=l)}),ag(r,"degrees",e.units)}function CF(n,t,e,r){var i=[e[0]-t[0],e[1]-t[1]],s=[n[0]-t[0],n[1]-t[1]],o=ov(s,i);if(o<=0)return Gf(n,t,{method:r.method,units:"degrees"});var a=ov(i,i);if(a<=o)return Gf(n,e,{method:r.method,units:"degrees"});var l=o/a,c=[t[0]+l*i[0],t[1]+l*i[1]];return Gf(n,c,{method:r.method,units:"degrees"})}function ov(n,t){return n[0]*t[0]+n[1]*t[1]}function Gf(n,t,e){return e.method==="planar"?jh(n,t,e):Zt(n,t,e)}function ql(n){"@babel/helpers - typeof";return ql=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},ql(n)}function TF(n,t){if(ql(n)!="object"||!n)return n;var e=n[Symbol.toPrimitive];if(e!==void 0){var r=e.call(n,t);if(ql(r)!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(n)}function PF(n){var t=TF(n,"string");return ql(t)=="symbol"?t:t+""}function ue(n,t,e){return(t=PF(t))in n?Object.defineProperty(n,t,{value:e,enumerable:!0,configurable:!0,writable:!0}):n[t]=e,n}var mn=1e-6,Ua=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var n=0,t=arguments.length;t--;)n+=arguments[t]*arguments[t];return Math.sqrt(n)});function IF(){var n=new Ua(4);return Ua!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0,n[3]=0),n}function AF(n,t,e){return n[0]=t[0]*e,n[1]=t[1]*e,n[2]=t[2]*e,n[3]=t[3]*e,n}function MF(n,t,e){var r=t[0],i=t[1],s=t[2],o=t[3];return n[0]=e[0]*r+e[4]*i+e[8]*s+e[12]*o,n[1]=e[1]*r+e[5]*i+e[9]*s+e[13]*o,n[2]=e[2]*r+e[6]*i+e[10]*s+e[14]*o,n[3]=e[3]*r+e[7]*i+e[11]*s+e[15]*o,n}(function(){var n=IF();return function(t,e,r,i,s,o){var a,l;for(e||(e=4),r||(r=0),i?l=Math.min(i*e+r,t.length):l=t.length,a=r;a<l;a+=e)n[0]=t[a],n[1]=t[a+1],n[2]=t[a+2],n[3]=t[a+3],s(n,n,o),t[a]=n[0],t[a+1]=n[1],t[a+2]=n[2],t[a+3]=n[3];return t}})();function _u(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function aa(n,t){const e=MF([],t,n);return AF(e,e,1/e[3]),e}function tp(n,t,e){return n<t?t:n>e?e:n}function RF(n){return Math.log(n)*Math.LOG2E}const NF=Math.log2||RF;function OF(n,t){var e=t[0],r=t[1],i=t[2],s=t[3],o=t[4],a=t[5],l=t[6],c=t[7],u=t[8],h=t[9],f=t[10],d=t[11],p=t[12],_=t[13],v=t[14],E=t[15],m=e*a-r*o,g=e*l-i*o,y=e*c-s*o,b=r*l-i*a,x=r*c-s*a,w=i*c-s*l,S=u*_-h*p,I=u*v-f*p,T=u*E-d*p,M=h*v-f*_,L=h*E-d*_,O=f*E-d*v,P=m*O-g*L+y*M+b*T-x*I+w*S;return P?(P=1/P,n[0]=(a*O-l*L+c*M)*P,n[1]=(i*L-r*O-s*M)*P,n[2]=(_*w-v*x+E*b)*P,n[3]=(f*x-h*w-d*b)*P,n[4]=(l*T-o*O-c*I)*P,n[5]=(e*O-i*T+s*I)*P,n[6]=(v*y-p*w-E*g)*P,n[7]=(u*w-f*y+d*g)*P,n[8]=(o*L-a*T+c*S)*P,n[9]=(r*T-e*L-s*S)*P,n[10]=(p*x-_*y+E*m)*P,n[11]=(h*y-u*x-d*m)*P,n[12]=(a*I-o*M-l*S)*P,n[13]=(e*M-r*I+i*S)*P,n[14]=(_*g-p*b-v*m)*P,n[15]=(u*b-h*g+f*m)*P,n):null}function Yf(n,t,e){var r=t[0],i=t[1],s=t[2],o=t[3],a=t[4],l=t[5],c=t[6],u=t[7],h=t[8],f=t[9],d=t[10],p=t[11],_=t[12],v=t[13],E=t[14],m=t[15],g=e[0],y=e[1],b=e[2],x=e[3];return n[0]=g*r+y*a+b*h+x*_,n[1]=g*i+y*l+b*f+x*v,n[2]=g*s+y*c+b*d+x*E,n[3]=g*o+y*u+b*p+x*m,g=e[4],y=e[5],b=e[6],x=e[7],n[4]=g*r+y*a+b*h+x*_,n[5]=g*i+y*l+b*f+x*v,n[6]=g*s+y*c+b*d+x*E,n[7]=g*o+y*u+b*p+x*m,g=e[8],y=e[9],b=e[10],x=e[11],n[8]=g*r+y*a+b*h+x*_,n[9]=g*i+y*l+b*f+x*v,n[10]=g*s+y*c+b*d+x*E,n[11]=g*o+y*u+b*p+x*m,g=e[12],y=e[13],b=e[14],x=e[15],n[12]=g*r+y*a+b*h+x*_,n[13]=g*i+y*l+b*f+x*v,n[14]=g*s+y*c+b*d+x*E,n[15]=g*o+y*u+b*p+x*m,n}function ep(n,t,e){var r=e[0],i=e[1],s=e[2],o,a,l,c,u,h,f,d,p,_,v,E;return t===n?(n[12]=t[0]*r+t[4]*i+t[8]*s+t[12],n[13]=t[1]*r+t[5]*i+t[9]*s+t[13],n[14]=t[2]*r+t[6]*i+t[10]*s+t[14],n[15]=t[3]*r+t[7]*i+t[11]*s+t[15]):(o=t[0],a=t[1],l=t[2],c=t[3],u=t[4],h=t[5],f=t[6],d=t[7],p=t[8],_=t[9],v=t[10],E=t[11],n[0]=o,n[1]=a,n[2]=l,n[3]=c,n[4]=u,n[5]=h,n[6]=f,n[7]=d,n[8]=p,n[9]=_,n[10]=v,n[11]=E,n[12]=o*r+u*i+p*s+t[12],n[13]=a*r+h*i+_*s+t[13],n[14]=l*r+f*i+v*s+t[14],n[15]=c*r+d*i+E*s+t[15]),n}function BE(n,t,e){var r=e[0],i=e[1],s=e[2];return n[0]=t[0]*r,n[1]=t[1]*r,n[2]=t[2]*r,n[3]=t[3]*r,n[4]=t[4]*i,n[5]=t[5]*i,n[6]=t[6]*i,n[7]=t[7]*i,n[8]=t[8]*s,n[9]=t[9]*s,n[10]=t[10]*s,n[11]=t[11]*s,n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15],n}function DF(n,t,e){var r=Math.sin(e),i=Math.cos(e),s=t[4],o=t[5],a=t[6],l=t[7],c=t[8],u=t[9],h=t[10],f=t[11];return t!==n&&(n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n[4]=s*i+c*r,n[5]=o*i+u*r,n[6]=a*i+h*r,n[7]=l*i+f*r,n[8]=c*i-s*r,n[9]=u*i-o*r,n[10]=h*i-a*r,n[11]=f*i-l*r,n}function LF(n,t,e){var r=Math.sin(e),i=Math.cos(e),s=t[0],o=t[1],a=t[2],l=t[3],c=t[4],u=t[5],h=t[6],f=t[7];return t!==n&&(n[8]=t[8],n[9]=t[9],n[10]=t[10],n[11]=t[11],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n[0]=s*i+c*r,n[1]=o*i+u*r,n[2]=a*i+h*r,n[3]=l*i+f*r,n[4]=c*i-s*r,n[5]=u*i-o*r,n[6]=h*i-a*r,n[7]=f*i-l*r,n}function kF(n,t,e,r,i){var s=1/Math.tan(t/2),o;return n[0]=s/e,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=s,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=-1,n[12]=0,n[13]=0,n[15]=0,i!=null&&i!==1/0?(o=1/(r-i),n[10]=(i+r)*o,n[14]=2*i*r*o):(n[10]=-1,n[14]=-2*r),n}var FF=kF;function av(n,t){var e=n[0],r=n[1],i=n[2],s=n[3],o=n[4],a=n[5],l=n[6],c=n[7],u=n[8],h=n[9],f=n[10],d=n[11],p=n[12],_=n[13],v=n[14],E=n[15],m=t[0],g=t[1],y=t[2],b=t[3],x=t[4],w=t[5],S=t[6],I=t[7],T=t[8],M=t[9],L=t[10],O=t[11],P=t[12],V=t[13],C=t[14],R=t[15];return Math.abs(e-m)<=mn*Math.max(1,Math.abs(e),Math.abs(m))&&Math.abs(r-g)<=mn*Math.max(1,Math.abs(r),Math.abs(g))&&Math.abs(i-y)<=mn*Math.max(1,Math.abs(i),Math.abs(y))&&Math.abs(s-b)<=mn*Math.max(1,Math.abs(s),Math.abs(b))&&Math.abs(o-x)<=mn*Math.max(1,Math.abs(o),Math.abs(x))&&Math.abs(a-w)<=mn*Math.max(1,Math.abs(a),Math.abs(w))&&Math.abs(l-S)<=mn*Math.max(1,Math.abs(l),Math.abs(S))&&Math.abs(c-I)<=mn*Math.max(1,Math.abs(c),Math.abs(I))&&Math.abs(u-T)<=mn*Math.max(1,Math.abs(u),Math.abs(T))&&Math.abs(h-M)<=mn*Math.max(1,Math.abs(h),Math.abs(M))&&Math.abs(f-L)<=mn*Math.max(1,Math.abs(f),Math.abs(L))&&Math.abs(d-O)<=mn*Math.max(1,Math.abs(d),Math.abs(O))&&Math.abs(p-P)<=mn*Math.max(1,Math.abs(p),Math.abs(P))&&Math.abs(_-V)<=mn*Math.max(1,Math.abs(_),Math.abs(V))&&Math.abs(v-C)<=mn*Math.max(1,Math.abs(v),Math.abs(C))&&Math.abs(E-R)<=mn*Math.max(1,Math.abs(E),Math.abs(R))}function BF(){var n=new Ua(2);return Ua!=Float32Array&&(n[0]=0,n[1]=0),n}function lv(n,t,e){return n[0]=t[0]+e[0],n[1]=t[1]+e[1],n}function UF(n,t){return n[0]=-t[0],n[1]=-t[1],n}function UE(n,t,e,r){var i=t[0],s=t[1];return n[0]=i+r*(e[0]-i),n[1]=s+r*(e[1]-s),n}(function(){var n=BF();return function(t,e,r,i,s,o){var a,l;for(e||(e=2),r||(r=0),i?l=Math.min(i*e+r,t.length):l=t.length,a=r;a<l;a+=e)n[0]=t[a],n[1]=t[a+1],s(n,n,o),t[a]=n[0],t[a+1]=n[1];return t}})();function VF(){var n=new Ua(3);return Ua!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n}function zF(n,t,e){return n[0]=t[0]+e[0],n[1]=t[1]+e[1],n[2]=t[2]+e[2],n}function WF(n,t,e){return n[0]=t[0]*e[0],n[1]=t[1]*e[1],n[2]=t[2]*e[2],n}function HF(n,t){return n[0]=-t[0],n[1]=-t[1],n[2]=-t[2],n}var jF=WF;(function(){var n=VF();return function(t,e,r,i,s,o){var a,l;for(e||(e=3),r||(r=0),i?l=Math.min(i*e+r,t.length):l=t.length,a=r;a<l;a+=e)n[0]=t[a],n[1]=t[a+1],n[2]=t[a+2],s(n,n,o),t[a]=n[0],t[a+1]=n[1],t[a+2]=n[2];return t}})();function Vs(n,t){if(!n)throw new Error(t||"@math.gl/web-mercator: assertion failed.")}const Yr=Math.PI,VE=Yr/4,Si=Yr/180,np=180/Yr,Kl=512,cv=4003e4,uv=85.051129,zE=1.5;function $F(n){return Math.pow(2,n)}function ra(n){const[t,e]=n;Vs(Number.isFinite(t)),Vs(Number.isFinite(e)&&e>=-90&&e<=90,"invalid latitude");const r=t*Si,i=e*Si,s=Kl*(r+Yr)/(2*Yr),o=Kl*(Yr+Math.log(Math.tan(VE+i*.5)))/(2*Yr);return[s,o]}function Cl(n){const[t,e]=n,r=t/Kl*(2*Yr)-Yr,i=2*(Math.atan(Math.exp(e/Kl*(2*Yr)-Yr))-VE);return[r*np,i*np]}function XF(n){const{latitude:t,longitude:e,highPrecision:r=!1}=n;Vs(Number.isFinite(t)&&Number.isFinite(e));const i=Kl,s=Math.cos(t*Si),o=i/360,a=o/s,l=i/cv/s,c={unitsPerMeter:[l,l,l],metersPerUnit:[1/l,1/l,1/l],unitsPerDegree:[o,a,l],degreesPerUnit:[1/o,1/a,1/l]};if(r){const u=Si*Math.tan(t*Si)/s,h=o*u/2,f=i/cv*u,d=f/a*l;c.unitsPerDegree2=[0,h,f],c.unitsPerMeter2=[d,0,d]}return c}function GF(n){const{height:t,pitch:e,bearing:r,altitude:i,scale:s,center:o}=n,a=_u();ep(a,a,[0,0,-i]),DF(a,a,-e*Si),LF(a,a,r*Si);const l=s/t;return BE(a,a,[l,l,l]),o&&ep(a,a,HF([],o)),a}function YF(n){const{width:t,height:e,altitude:r,pitch:i=0,offset:s,center:o,scale:a,nearZMultiplier:l=1,farZMultiplier:c=1}=n;let{fovy:u=hh(zE)}=n;r!==void 0&&(u=hh(r));const h=u*Si,f=i*Si,d=WE(u);let p=d;o&&(p+=o[2]*a/Math.cos(f)/e);const _=h*(.5+(s?s[1]:0)/e),v=Math.sin(_)*p/Math.sin(tp(Math.PI/2-f-_,.01,Math.PI-.01)),E=Math.sin(f)*v+p,m=p*10,g=Math.min(E*c,m);return{fov:h,aspect:t/e,focalDistance:d,near:l,far:g}}function qF(n){const{fov:t,aspect:e,near:r,far:i}=YF(n);return FF([],t,e,r,i)}function hh(n){return 2*Math.atan(.5/n)*np}function WE(n){return .5/Math.tan(.5*n*Si)}function KF(n,t){const[e,r,i=0]=n;return Vs(Number.isFinite(e)&&Number.isFinite(r)&&Number.isFinite(i)),aa(t,[e,r,i,1])}function hv(n,t,e=0){const[r,i,s]=n;if(Vs(Number.isFinite(r)&&Number.isFinite(i),"invalid pixel coordinate"),Number.isFinite(s))return aa(t,[r,i,s,1]);const o=aa(t,[r,i,0,1]),a=aa(t,[r,i,1,1]),l=o[2],c=a[2],u=l===c?0:((e||0)-l)/(c-l);return UE([],o,a,u)}function ZF(n){const{width:t,height:e,bounds:r,minExtent:i=0,maxZoom:s=24,offset:o=[0,0]}=n,[[a,l],[c,u]]=r,h=JF(n.padding),f=ra([a,tp(u,-85.051129,uv)]),d=ra([c,tp(l,-85.051129,uv)]),p=[Math.max(Math.abs(d[0]-f[0]),i),Math.max(Math.abs(d[1]-f[1]),i)],_=[t-h.left-h.right-Math.abs(o[0])*2,e-h.top-h.bottom-Math.abs(o[1])*2];Vs(_[0]>0&&_[1]>0);const v=_[0]/p[0],E=_[1]/p[1],m=(h.right-h.left)/2/v,g=(h.top-h.bottom)/2/E,y=[(d[0]+f[0])/2+m,(d[1]+f[1])/2+g],b=Cl(y),x=Math.min(s,NF(Math.abs(Math.min(v,E))));return Vs(Number.isFinite(x)),{longitude:b[0],latitude:b[1],zoom:x}}function JF(n=0){return typeof n=="number"?{top:n,bottom:n,left:n,right:n}:(Vs(Number.isFinite(n.top)&&Number.isFinite(n.bottom)&&Number.isFinite(n.left)&&Number.isFinite(n.right)),n)}const fv=Math.PI/180;function QF(n,t=0){const{width:e,height:r,unproject:i}=n,s={targetZ:t},o=i([0,r],s),a=i([e,r],s);let l,c;const u=n.fovy?.5*n.fovy*fv:Math.atan(.5/n.altitude),h=(90-n.pitch)*fv;return u>h-.01?(l=dv(n,0,t),c=dv(n,e,t)):(l=i([0,0],s),c=i([e,0],s)),[o,a,c,l]}function dv(n,t,e){const{pixelUnprojectionMatrix:r}=n,i=aa(r,[t,0,1,1]),s=aa(r,[t,n.height,1,1]),a=(e*n.distanceScales.unitsPerMeter[2]-i[2])/(s[2]-i[2]),l=UE([],i,s,a),c=Cl(l);return c.push(e),c}class Va{constructor(t={width:1,height:1}){ue(this,"latitude",void 0),ue(this,"longitude",void 0),ue(this,"zoom",void 0),ue(this,"pitch",void 0),ue(this,"bearing",void 0),ue(this,"altitude",void 0),ue(this,"fovy",void 0),ue(this,"meterOffset",void 0),ue(this,"center",void 0),ue(this,"width",void 0),ue(this,"height",void 0),ue(this,"scale",void 0),ue(this,"distanceScales",void 0),ue(this,"viewMatrix",void 0),ue(this,"projectionMatrix",void 0),ue(this,"viewProjectionMatrix",void 0),ue(this,"pixelProjectionMatrix",void 0),ue(this,"pixelUnprojectionMatrix",void 0),ue(this,"equals",E=>E instanceof Va?E.width===this.width&&E.height===this.height&&av(E.projectionMatrix,this.projectionMatrix)&&av(E.viewMatrix,this.viewMatrix):!1),ue(this,"project",(E,m={})=>{const{topLeft:g=!0}=m,y=this.projectPosition(E),b=KF(y,this.pixelProjectionMatrix),[x,w]=b,S=g?w:this.height-w;return E.length===2?[x,S]:[x,S,b[2]]}),ue(this,"unproject",(E,m={})=>{const{topLeft:g=!0,targetZ:y=void 0}=m,[b,x,w]=E,S=g?x:this.height-x,I=y&&y*this.distanceScales.unitsPerMeter[2],T=hv([b,S,w],this.pixelUnprojectionMatrix,I),[M,L,O]=this.unprojectPosition(T);return Number.isFinite(w)?[M,L,O]:Number.isFinite(y)?[M,L,y]:[M,L]}),ue(this,"projectPosition",E=>{const[m,g]=ra(E),y=(E[2]||0)*this.distanceScales.unitsPerMeter[2];return[m,g,y]}),ue(this,"unprojectPosition",E=>{const[m,g]=Cl(E),y=(E[2]||0)*this.distanceScales.metersPerUnit[2];return[m,g,y]});let{width:e,height:r,altitude:i=null,fovy:s=null}=t;const{latitude:o=0,longitude:a=0,zoom:l=0,pitch:c=0,bearing:u=0,position:h=null,nearZMultiplier:f=.02,farZMultiplier:d=1.01}=t;e=e||1,r=r||1,s===null&&i===null?(i=zE,s=hh(i)):s===null?s=hh(i):i===null&&(i=WE(s));const p=$F(l);i=Math.max(.75,i);const _=XF({longitude:a,latitude:o}),v=ra([a,o]);v.push(0),h&&zF(v,v,jF([],h,_.unitsPerMeter)),this.projectionMatrix=qF({width:e,height:r,scale:p,center:v,pitch:c,fovy:s,nearZMultiplier:f,farZMultiplier:d}),this.viewMatrix=GF({height:r,scale:p,center:v,pitch:c,bearing:u,altitude:i}),this.width=e,this.height=r,this.scale=p,this.latitude=o,this.longitude=a,this.zoom=l,this.pitch=c,this.bearing=u,this.altitude=i,this.fovy=s,this.center=v,this.meterOffset=h||[0,0,0],this.distanceScales=_,this._initMatrices(),Object.freeze(this)}_initMatrices(){const{width:t,height:e,projectionMatrix:r,viewMatrix:i}=this,s=_u();Yf(s,s,r),Yf(s,s,i),this.viewProjectionMatrix=s;const o=_u();BE(o,o,[t/2,-e/2,1]),ep(o,o,[1,-1,0]),Yf(o,o,s);const a=OF(_u(),o);if(!a)throw new Error("Pixel project matrix not invertible");this.pixelProjectionMatrix=o,this.pixelUnprojectionMatrix=a}projectFlat(t){return ra(t)}unprojectFlat(t){return Cl(t)}getMapCenterByLngLatPosition({lngLat:t,pos:e}){const r=hv(e,this.pixelUnprojectionMatrix),i=ra(t),s=lv([],i,UF([],r)),o=lv([],this.center,s);return Cl(o)}fitBounds(t,e={}){const{width:r,height:i}=this,{longitude:s,latitude:o,zoom:a}=ZF(Object.assign({width:r,height:i,bounds:t},e));return new Va({width:r,height:i,longitude:s,latitude:o,zoom:a})}getBounds(t){const e=this.getBoundingRegion(t),r=Math.min(...e.map(a=>a[0])),i=Math.max(...e.map(a=>a[0])),s=Math.min(...e.map(a=>a[1])),o=Math.max(...e.map(a=>a[1]));return[[r,s],[i,o]]}getBoundingRegion(t={}){return QF(this,t.z||0)}getLocationAtPoint({lngLat:t,pos:e}){return this.getMapCenterByLngLatPosition({lngLat:t,pos:e})}}function tB(n,t,e){const r=n.indexOf(t);return r<0?n:n.slice(0,r)+e+n.slice(r)}class q6 extends cc{static layerName="JunctionScatterplotLayer";static defaultProps={...io.defaultProps,getFillColor:t=>[0,0,0,255],getStrokeColor:t=>[255,255,255,255],getInnerRadius:t=>1};renderLayers(){const{id:t,getFillColor:e,getStrokeColor:r,getInnerRadius:i,updateTriggers:s}=this.props;return[new io({...this.props,id:`${t}-full`,data:this.props.data,getLineColor:r,updateTriggers:{...s,getStrokeColor:s.getStrokeColor}}),new io({...this.props,id:`${t}-inner`,data:this.props.data,getFillColor:e,getRadius:i,pickable:!1,updateTriggers:{...s,getFillColor:s.getFillColor,getRadius:s.getInnerRadius}})]}}function eB(n,t,e){e===void 0&&(e={});var r=lr(n),i=lr(t),s=Tg.union(r.coordinates,i.coordinates);return s.length===0?null:s.length===1?uo(s[0],e.properties):ig(s,e.properties)}function nB(n,t,e){e===void 0&&(e={});var r=lr(n),i=lr(t),s=Tg.intersection(r.coordinates,i.coordinates);return s.length===0?null:s.length===1?uo(s[0],e.properties):ig(s,e.properties)}function $h(n){if(!n)throw new Error("geojson is required");switch(n.type){case"Feature":return HE(n);case"FeatureCollection":return rB(n);case"Point":case"LineString":case"Polygon":case"MultiPoint":case"MultiLineString":case"MultiPolygon":case"GeometryCollection":return Pg(n);default:throw new Error("unknown GeoJSON type")}}function HE(n){var t={type:"Feature"};return Object.keys(n).forEach(function(e){switch(e){case"type":case"properties":case"geometry":return;default:t[e]=n[e]}}),t.properties=jE(n.properties),t.geometry=Pg(n.geometry),t}function jE(n){var t={};return n&&Object.keys(n).forEach(function(e){var r=n[e];typeof r=="object"?r===null?t[e]=null:Array.isArray(r)?t[e]=r.map(function(i){return i}):t[e]=jE(r):t[e]=r}),t}function rB(n){var t={type:"FeatureCollection"};return Object.keys(n).forEach(function(e){switch(e){case"type":case"features":return;default:t[e]=n[e]}}),t.features=n.features.map(function(e){return HE(e)}),t}function Pg(n){var t={type:n.type};return n.bbox&&(t.bbox=n.bbox),n.type==="GeometryCollection"?(t.geometries=n.geometries.map(function(e){return Pg(e)}),t):(t.coordinates=$E(n.coordinates),t)}function $E(n){var t=n;return typeof t[0]!="object"?t.slice():t.map(function(e){return $E(e)})}function rp(n){for(var t=An(n),e=0,r=1,i,s;r<t.length;)i=s||t[0],s=t[r],e+=(s[0]-i[0])*(s[1]+i[1]),r++;return e>0}function iB(n,t){if(t=t||{},!Mh(t))throw new Error("options is invalid");var e=t.reverse||!1,r=t.mutate||!1;if(!n)throw new Error("<geojson> is required");if(typeof e!="boolean")throw new Error("<reverse> must be a boolean");if(typeof r!="boolean")throw new Error("<mutate> must be a boolean");r===!1&&(n=$h(n));var i=[];switch(n.type){case"GeometryCollection":return Xa(n,function(s){yu(s,e)}),n;case"FeatureCollection":return ho(n,function(s){ho(yu(s,e),function(o){i.push(o)})}),Ir(i)}return yu(n,e)}function yu(n,t){var e=n.type==="Feature"?n.geometry.type:n.type;switch(e){case"GeometryCollection":return Xa(n,function(r){yu(r,t)}),n;case"LineString":return pv(An(n),t),n;case"Polygon":return gv(An(n),t),n;case"MultiLineString":return An(n).forEach(function(r){pv(r,t)}),n;case"MultiPolygon":return An(n).forEach(function(r){gv(r,t)}),n;case"Point":case"MultiPoint":return n}}function pv(n,t){rp(n)===t&&n.reverse()}function gv(n,t){rp(n[0])!==t&&n[0].reverse();for(var e=1;e<n.length;e++)rp(n[e])===t&&n[e].reverse()}function XE(n,t,e){if(!Array.isArray(n[0]))return!0;for(let r=0;r<n.length;r++)if(XE(n[r],[...t,r],e)){e(n,t);break}return!1}function Zl(n,t,e){const r={type:"LineString",coordinates:[n,t]},i=wt(e),s=SF(i,r),o=cr(n,t),l=(e[0]-n[0])*(t[1]-n[1])-(e[1]-n[1])*(t[0]-n[0])<0?o-90:o-270,c=is(t,s,l),u=is(n,s,l);return[c.geometry.coordinates,u.geometry.coordinates]}function mv(n,t,e,r){const i=n-e,s=t-r;return Math.sqrt(i*i+s*s)}function sB(n,t,e){return t*e+n*(1-e)}function oB(n,t,e){const r=new Va(e),s=n.geometry.coordinates.map(([w,S,I=0])=>r.project([w,S,I])),[o,a]=r.project(t.geometry.coordinates);let l=1/0,c={};s.forEach(([w,S],I)=>{if(I===0)return;const[T,M]=s[I-1],L=M-S,O=w-T,P=T*S-w*M,V=L*L+O*O,C=Math.abs(L*o+O*a+P)/Math.sqrt(V);C<l&&(l=C,c={index:I,x0:(O*(O*o-L*a)-L*P)/V,y0:(L*(-O*o+L*a)-O*P)/V})});const{index:u,x0:h,y0:f}=c,[d,p,_=0]=s[u-1],[v,E,m=0]=s[u],g=mv(d,p,v,E),b=mv(d,p,h,f)/g,x=sB(_,m,b);return{type:"Feature",geometry:{type:"Point",coordinates:r.unproject([h,f,x])},properties:{dist:l,index:u-1}}}function aB(n,t,e){let r;e&&(r=new Va(e));let i=wt([1/0,1/0],{dist:1/0});return!n.geometry?.coordinates.length||n.geometry?.coordinates.length<2||Rh(n,s=>{const o=An(s),a=An(t);let l,c,u,h,f,d,p;if(o.length>1&&a.length){let v,E;r?(v=o.map(y=>r.project(y)),E=r.project(a)):(v=o,E=a);for(let y=1;y<v.length;y++){if(v[y][0]!==v[y-1][0]){const T=(v[y][1]-v[y-1][1])/(v[y][0]-v[y-1][0]),M=v[y][1]-T*v[y][0];p=Math.abs(T*E[0]+M-E[1])/Math.sqrt(T*T+1)}else p=Math.abs(E[0]-v[y][0]);const b=Math.pow(v[y][1]-v[y-1][1],2)+Math.pow(v[y][0]-v[y-1][0],2),x=Math.pow(v[y][1]-E[1],2)+Math.pow(v[y][0]-E[0],2),w=Math.pow(v[y-1][1]-E[1],2)+Math.pow(v[y-1][0]-E[0],2),S=Math.pow(p,2),I=x-S+w-S;I>b&&(p=Math.sqrt(Math.min(x,w))),(l==null||l>p)&&(I>b?w<x?(c=0,u=1):(u=0,c=1):(c=Math.sqrt(w-S)/Math.sqrt(b),u=Math.sqrt(x-S)/Math.sqrt(b)),l=p,d=y)}const m=v[d-1][0]-v[d][0],g=v[d-1][1]-v[d][1];h=v[d-1][0]-m*c,f=v[d-1][1]-g*c}let _={x:h,y:f,idx:d-1,to:c,from:u};if(r){const v=r.unproject([_.x,_.y]);_={x:v[0],y:v[1],idx:d-1,to:c,from:u}}i=wt([_.x,_.y],{dist:Math.abs(_.from-_.to),index:_.idx})}),i}function Ur(n){const t=Lo(n);return t.length?t[0]:null}function lB(n){return Lo(n).find(e=>e.properties.editHandleType==="snap-source")}function cB(n){return n&&n.filter(t=>!t.isGuide)}function _v(n){return Lo(n).find(({properties:e})=>e.featureIndex>=0&&e.editHandleType==="existing")}function ip(n){return Lo(n).find(({properties:e})=>e.featureIndex>=0&&e.editHandleType==="intermediate")}function Lo(n){return n&&n.filter(e=>e.isGuide&&e.object.properties.guideType==="editHandle").map(e=>e.object)||[]}function fh(n,t,e="existing"){let r=[];switch(n.type){case"Point":r=[{type:"Feature",properties:{guideType:"editHandle",editHandleType:e,positionIndexes:[],featureIndex:t},geometry:{type:"Point",coordinates:n.coordinates}}];break;case"MultiPoint":case"LineString":r=r.concat(qf(n.coordinates,[],t,e));break;case"Polygon":case"MultiLineString":for(let i=0;i<n.coordinates.length;i++)r=r.concat(qf(n.coordinates[i],[i],t,e)),n.type==="Polygon"&&(r=r.slice(0,-1));break;case"MultiPolygon":for(let i=0;i<n.coordinates.length;i++)for(let s=0;s<n.coordinates[i].length;s++)r=r.concat(qf(n.coordinates[i][s],[i,s],t,e)),r=r.slice(0,-1);break;default:throw Error(`Unhandled geometry type: ${n.type}`)}return r}function qf(n,t,e,r="existing"){const i=[];for(let s=0;s<n.length;s++){const o=n[s];i.push({type:"Feature",properties:{guideType:"editHandle",positionIndexes:[...t,s],featureIndex:e,editHandleType:r},geometry:{type:"Point",coordinates:o}})}return i}function uB(n,t,e){const r=n.geometry.coordinates;if(!r)return null;const i=r[0].slice(0,4);i[t%4]=e;const s=i[(t+2)%4],o=i[t%4];return i[(t+1)%4]=[o[0],s[1]],i[(t+3)%4]=[s[0],o[1]],[[...i,i[0]]]}function Ig(n,t){return typeof n[0]=="number"?!isNaN(n[0])&&isFinite(n[0])?t(n):n:n.map(e=>Ig(e,t)).filter(Boolean)}function GE(n){return n.picks.length&&n.picks.find(t=>t.featureType==="points")}class Ve{featureCollection;constructor(t){this.featureCollection=t}getObject(){return this.featureCollection}replacePosition(t,e,r){const i=this.featureCollection.features[t].geometry,s=i.type==="Polygon"||i.type==="MultiPolygon",o={...i,coordinates:YE(i.coordinates,e,r,s)};return this.replaceGeometry(t,o)}removePosition(t,e){const r=this.featureCollection.features[t].geometry;if(r.type==="Point")throw Error("Can't remove a position from a Point or there'd be nothing left");if(r.type==="MultiPoint"&&r.coordinates.length<2)throw Error("Can't remove the last point of a MultiPoint or there'd be nothing left");if(r.type==="LineString"&&r.coordinates.length<3)throw Error("Can't remove position. LineString must have at least two positions");if(r.type==="Polygon"&&r.coordinates[0].length<5&&Array.isArray(e)&&e[0]===0)throw Error("Can't remove position. Polygon's outer ring must have at least four positions");if(r.type==="MultiLineString"&&r.coordinates.length===1&&r.coordinates[0].length<3)throw Error("Can't remove position. MultiLineString must have at least two positions");if(r.type==="MultiPolygon"&&r.coordinates.length===1&&r.coordinates[0][0].length<5&&Array.isArray(e)&&e[0]===0&&e[1]===0)throw Error("Can't remove position. MultiPolygon's outer ring must have at least four positions");const i=r.type==="Polygon"||r.type==="MultiPolygon",s={...r,coordinates:qE(r.coordinates,e,i)};return hB(s),this.replaceGeometry(t,s)}addPosition(t,e,r){const i=this.featureCollection.features[t].geometry;if(i.type==="Point")throw new Error("Unable to add a position to a Point feature");i.type==="Polygon"||i.type;const s={...i,coordinates:KE(i.coordinates,e,r)};return this.replaceGeometry(t,s)}replaceGeometry(t,e){const r={...this.featureCollection.features[t],geometry:e},i={...this.featureCollection,features:[...this.featureCollection.features.slice(0,t),r,...this.featureCollection.features.slice(t+1)]};return new Ve(i)}addFeature(t){return this.addFeatures([t])}addFeatures(t){const e={...this.featureCollection,features:[...this.featureCollection.features,...t]};return new Ve(e)}deleteFeature(t){return this.deleteFeatures([t])}deleteFeatures(t){const e=[...this.featureCollection.features];t.sort();for(let i=t.length-1;i>=0;i--){const s=t[i];s>=0&&s<e.length&&e.splice(s,1)}const r={...this.featureCollection,features:e};return new Ve(r)}}function qc(n,t){if(n.length===2&&t.length===3){const e=t[2];return[n[0],n[1],e]}return n}function YE(n,t,e,r){if(!t)return n;if(t.length===0)return qc(e,n);if(t.length===1){const i=[...n.slice(0,t[0]),qc(e,n[t[0]]),...n.slice(t[0]+1)];return r&&(t[0]===0||t[0]===n.length-1)&&(i[0]=qc(e,n[0]),i[n.length-1]=qc(e,n[0])),i}return[...n.slice(0,t[0]),YE(n[t[0]],t.slice(1,t.length),e,r),...n.slice(t[0]+1)]}function qE(n,t,e){if(!t)return n;if(t.length===0)throw Error("Must specify the index of the position to remove");if(t.length===1){const r=[...n.slice(0,t[0]),...n.slice(t[0]+1)];return e&&(t[0]===0||t[0]===n.length-1)&&(t[0]===0?r[r.length-1]=r[0]:t[0]===n.length-1&&(r[0]=r[r.length-1])),r}return[...n.slice(0,t[0]),qE(n[t[0]],t.slice(1,t.length),e),...n.slice(t[0]+1)]}function KE(n,t,e,r){if(!t)return n;if(t.length===0)throw Error("Must specify the index of the position to remove");return t.length===1?[...n.slice(0,t[0]),e,...n.slice(t[0])]:[...n.slice(0,t[0]),KE(n[t[0]],t.slice(1,t.length),e),...n.slice(t[0]+1)]}function hB(n){switch(n.type){case"Polygon":fB(n);break;case"MultiLineString":dB(n);break;case"MultiPolygon":pB(n);break}}function fB(n){const t=n.coordinates;for(let e=1;e<t.length;e++)ZE(t,e)&&e--}function dB(n){for(let t=0;t<n.coordinates.length;t++)n.coordinates[t].length===1&&(n.coordinates.splice(t,1),t--)}function pB(n){for(let t=0;t<n.coordinates.length;t++){const e=n.coordinates[t];e[0].length<=3&&(n.coordinates.splice(t,1),t--);for(let i=1;i<e.length;i++)ZE(e,i)&&i--}}function ZE(n,t){return n[t].length<=3?(n.splice(t,1),!0):!1}const gB={type:"FeatureCollection",features:[]},mB=[];class Un{_clickSequence=[];getGuides(t){return gB}getTooltips(t){return mB}getSelectedFeature(t){return t.selectedIndexes.length===1?t.data.features[t.selectedIndexes[0]]:null}getSelectedGeometry(t){const e=this.getSelectedFeature(t);return e?e.geometry:null}getSelectedFeaturesAsFeatureCollection(t){const{features:e}=t.data;return{type:"FeatureCollection",features:t.selectedIndexes.map(i=>e[i])}}getClickSequence(){return this._clickSequence}addClickSequence({mapCoords:t}){this._clickSequence.push(t)}resetClickSequence(){this._clickSequence=[]}getTentativeGuide(t){return this.getGuides(t).features.find(r=>r.properties&&r.properties.guideType==="tentative")}isSelectionPicked(t,e){if(!t.length)return!1;const r=cB(t).map(({index:o})=>o),i=Lo(t).map(({properties:o})=>o.featureIndex),s=new Set([...r,...i]);return e.selectedIndexes.some(o=>s.has(o))}rewindPolygon(t){const{geometry:e}=t;return e.type==="Polygon"||e.type==="MultiPolygon"?iB(t):t}getAddFeatureAction(t,e,r){const i=t;r=r||{};const s=i.type==="Feature"?i:{type:"Feature",properties:r,geometry:i},o=this.rewindPolygon(s),a=new Ve(e).addFeature(o).getObject();return{updatedData:a,editType:"addFeature",editContext:{featureIndexes:[a.features.length-1]}}}getAddManyFeaturesAction({features:t},e){let r=new Ve(e);const i=r.getObject().features.length,s=[];for(const o of t){const{properties:a,geometry:l}=o,c=l;r=r.addFeature({type:"Feature",properties:a,geometry:c}),s.push(i+s.length)}return{updatedData:r.getObject(),editType:"addFeature",editContext:{featureIndexes:s}}}getAddFeatureOrBooleanPolygonAction(t,e,r){const i=t;r=r||{};const s=this.getSelectedFeature(e),{modeConfig:o}=e;if(o&&o.booleanOperation){if(!s||s.geometry.type!=="Polygon"&&s.geometry.type!=="MultiPolygon")return console.warn("booleanOperation only supported for single Polygon or MultiPolygon selection"),null;const a=i.type==="Feature"?i:{type:"Feature",geometry:i};let l;if(o.booleanOperation==="union")l=eB(s,a);else if(o.booleanOperation==="difference")l=FE(s,a);else if(o.booleanOperation==="intersection")l=nB(s,a);else return console.warn(`Invalid booleanOperation ${o.booleanOperation}`),null;if(!l)return console.warn("Canceling edit. Boolean operation erased entire polygon."),null;const c=e.selectedIndexes[0];return{updatedData:new Ve(e.data).replaceGeometry(c,l.geometry).getObject(),editType:"unionGeometry",editContext:{featureIndexes:[c]}}}return this.getAddFeatureAction(t,e.data,r)}createTentativeFeature(t){return null}handleClick(t,e){}handlePointerMove(t,e){const r=this.createTentativeFeature(e);r&&e.onEdit({updatedData:e.data,editType:"updateTentativeFeature",editContext:{feature:r}})}handleStartDragging(t,e){}handleStopDragging(t,e){}handleDragging(t,e){}handleKeyUp(t,e){t.key==="Escape"&&(this.resetClickSequence(),e.onEdit({updatedData:e.data,editType:"cancelFeature",editContext:{}}))}}function Xh(n,t){return[(n[0]+t[0])/2,(n[1]+t[1])/2]}class _B extends Un{}function Ag(n,t,e){e===void 0&&(e={});var r;e.final?r=yv(Ke(t),Ke(n)):r=yv(Ke(n),Ke(t));var i=r>180?-(360-r):r;return i}function yv(n,t){var e=cn(n[1]),r=cn(t[1]),i=cn(t[0]-n[0]);i>Math.PI&&(i-=2*Math.PI),i<-Math.PI&&(i+=2*Math.PI);var s=Math.log(Math.tan(r/2+Math.PI/4)/Math.tan(e/2+Math.PI/4)),o=Math.atan2(i,s);return(Zu(o)+360)%360}function za(n,t,e,r){r===void 0&&(r={});var i=t<0,s=ag(Math.abs(t),r.units,"meters");i&&(s=-Math.abs(s));var o=Ke(n),a=yB(o,s,e);return a[0]+=a[0]-o[0]>180?-360:o[0]-a[0]>180?360:0,wt(a,r.properties)}function yB(n,t,e,r){r=r===void 0?nn:Number(r);var i=t/r,s=n[0]*Math.PI/180,o=cn(n[1]),a=cn(e),l=i*Math.cos(a),c=o+l;Math.abs(c)>Math.PI/2&&(c=c>0?Math.PI-c:-Math.PI-c);var u=Math.log(Math.tan(c/2+Math.PI/4)/Math.tan(o/2+Math.PI/4)),h=Math.abs(u)>1e-11?l/u:Math.cos(o),f=i*Math.sin(a)/h,d=s+f;return[(d*180/Math.PI+540)%360-180,c*180/Math.PI]}function vB(n,t,e){const r=lg(n),i=za(r,t,e),s=Ig(n.geometry.coordinates,o=>{const a=jh(r.geometry.coordinates,o),l=Ag(r.geometry.coordinates,o);return za(i.geometry.coordinates,a,l).geometry.coordinates});return n.geometry.coordinates=s,n}class dh extends Un{_geometryBeforeTranslate;_isTranslatable=void 0;handleDragging(t,e){if(this._isTranslatable){if(this._geometryBeforeTranslate){const r=this.getTranslateAction(t.pointerDownMapCoords,t.mapCoords,"translating",e);r&&e.onEdit(r)}t.cancelPan()}}handlePointerMove(t,e){this._isTranslatable=this.isSelectionPicked(t.pointerDownPicks||t.picks,e),this.updateCursor(e)}handleStartDragging(t,e){this._isTranslatable&&(t.cancelPan(),this._geometryBeforeTranslate=this.getSelectedFeaturesAsFeatureCollection(e))}handleStopDragging(t,e){if(this._geometryBeforeTranslate){const r=this.getTranslateAction(t.pointerDownMapCoords,t.mapCoords,"translated",e);r&&e.onEdit(r),this._geometryBeforeTranslate=null}}updateCursor(t){this._isTranslatable?t.onUpdateCursor("move"):t.onUpdateCursor(null)}getTranslateAction(t,e,r,i){if(!this._geometryBeforeTranslate)return null;let s=new Ve(i.data);const o=i.selectedIndexes,{viewport:a,screenSpace:l}=i.modeConfig||{};if(a&&l){const c=a.project?a:new Va(a),u=c.project(t),h=c.project(e),f=h[0]-u[0],d=h[1]-u[1];for(let p=0;p<o.length;p++){const _=o[p],v=this._geometryBeforeTranslate.features[p];let E=v.geometry.coordinates;E&&(E=Ig(E,m=>{const g=c.project(m);return g?(g[0]+=f,g[1]+=d,c.unproject(g)):null}),s=s.replaceGeometry(_,{type:v.geometry.type,coordinates:E}))}}else{const c=wt(t),u=wt(e),h=Zt(c,u),f=cr(c,u),d=this._geometryBeforeTranslate.features.map(p=>vB($h(p),h,f));for(let p=0;p<o.length;p++){const _=o[p],v=d[p];s=s.replaceGeometry(_,v.geometry)}}return{updatedData:s.getObject(),editType:r,editContext:{featureIndexes:o}}}}class Mg extends Un{getGuides(t){const e=[],{data:r,lastPointerMoveEvent:i}=t,{features:s}=r,o=i&&i.picks,a=i&&i.mapCoords;for(const l of t.selectedIndexes)if(l<s.length){const{geometry:c}=s[l];e.push(...fh(c,l))}else console.warn(`selectedFeatureIndexes out of range ${l}`);if(o&&o.length&&a){const c=!_v(o)&&o.find(u=>!u.isGuide);if(c&&!c.object.geometry.type.includes("Point")&&!(t.modeConfig?.lockRectangles&&c.object.properties.shape==="Rectangle")&&t.selectedIndexes.includes(c.index)){let u=null,h=[];const f=wt(a);if(XE(c.object.geometry.coordinates,[],(d,p)=>{const _=Nn(d),v=this.getNearestPoint(_,f,t.modeConfig&&t.modeConfig.viewport);(!u||v.properties.dist<u.properties.dist)&&(u=v,h=p)}),u){const{geometry:{coordinates:d},properties:{index:p}}=u;e.push({type:"Feature",properties:{guideType:"editHandle",editHandleType:"intermediate",featureIndex:c.index,positionIndexes:[...h,p+1]},geometry:{type:"Point",coordinates:d}})}}}return{type:"FeatureCollection",features:e}}getNearestPoint(t,e,r){const{coordinates:i}=t.geometry;if(i.some(s=>s.length>2)){if(r)return oB(t,e,r);console.log("Editing 3D point but modeConfig.viewport not provided. Falling back to 2D logic.")}return aB(t,e,r)}handleClick(t,e){const r=_v(t.picks),i=ip(t.picks);if(r){const{featureIndex:s,positionIndexes:o}=r.properties;let a;try{a=new Ve(e.data).removePosition(s,o).getObject()}catch{}a&&e.onEdit({updatedData:a,editType:"removePosition",editContext:{featureIndexes:[s],positionIndexes:o,position:r.geometry.coordinates}})}else if(i){const{featureIndex:s,positionIndexes:o}=i.properties,a=e.data.features[s];if(!(e.modeConfig?.lockRectangles&&a?.properties.shape==="Rectangle")){const c=new Ve(e.data).addPosition(s,o,i.geometry.coordinates).getObject();c&&e.onEdit({updatedData:c,editType:"addPosition",editContext:{featureIndexes:[s],positionIndexes:o,position:i.geometry.coordinates}})}}}handleDragging(t,e){const r=Ur(t.pointerDownPicks);r&&(t.cancelPan(),this._dragEditHandle("movePosition",e,r,t))}_dragEditHandle(t,e,r,i){const s=r.properties,o=e.data.features[s.featureIndex];let a;if(e.modeConfig?.lockRectangles&&o.properties.shape==="Rectangle"){const l=uB(o,s.positionIndexes[1],i.mapCoords);a=new Ve(e.data).replaceGeometry(s.featureIndex,{coordinates:l,type:"Polygon"}).getObject()}else a=new Ve(e.data).replacePosition(s.featureIndex,s.positionIndexes,i.mapCoords).getObject();e.onEdit({updatedData:a,editType:t,editContext:{featureIndexes:[s.featureIndex],positionIndexes:s.positionIndexes,position:i.mapCoords}})}handlePointerMove(t,e){const r=this.getCursor(t);e.onUpdateCursor(r)}handleStartDragging(t,e){GE(t)&&t.cancelPan();const r=e.selectedIndexes,i=ip(t.picks);if(r.length&&i){const s=i.properties,o=new Ve(e.data).addPosition(s.featureIndex,s.positionIndexes,t.mapCoords).getObject();e.onEdit({updatedData:o,editType:"addPosition",editContext:{featureIndexes:[s.featureIndex],positionIndexes:s.positionIndexes,position:t.mapCoords}})}}handleStopDragging(t,e){const r=e.selectedIndexes,i=Ur(t.picks);r.length&&i&&this._dragEditHandle("finishMovePosition",e,i,t)}getCursor(t){const e=t&&t.picks||[];return Lo(e).length?"cell":null}}function Jl(n,t){t===void 0&&(t={});var e=0,r=0,i=0;return Ws(n,function(s){e+=s[0],r+=s[1],i++},!0),wt([e/i,r/i],t.properties)}function bB(n,t){t===void 0&&(t={});var e=lr(n);switch(!t.properties&&n.type==="Feature"&&(t.properties=n.properties),e.type){case"Polygon":return Rg(e,t);case"MultiPolygon":return xB(e,t);default:throw new Error("invalid poly")}}function Rg(n,t){t===void 0&&(t={});var e=lr(n),r=e.coordinates,i=t.properties?t.properties:n.type==="Feature"?n.properties:{};return JE(r,i)}function xB(n,t){t===void 0&&(t={});var e=lr(n),r=e.coordinates,i=t.properties?t.properties:n.type==="Feature"?n.properties:{},s=[];return r.forEach(function(o){s.push(JE(o,i))}),Ir(s)}function JE(n,t){return n.length>1?QL(n,t):Nn(n[0],t)}function EB(n,t,e){if(e=e||{},!Mh(e))throw new Error("options is invalid");var r=e.origin,i=e.mutate;if(!n)throw new Error("geojson required");if(typeof t!="number"||t===0)throw new Error("invalid factor");var s=Array.isArray(r)||typeof r=="object";return i!==!0&&(n=$h(n)),n.type==="FeatureCollection"&&!s?(ho(n,function(o,a){n.features[a]=vv(o,t,r)}),n):vv(n,t,r)}function vv(n,t,e){var r=bF(n)==="Point";return e=wB(n,e),t===1||r||Ws(n,function(i){var s=jh(e,i),o=Ag(e,i),a=s*t,l=An(za(e,a,o));i[0]=l[0],i[1]=l[1],i.length===3&&(i[2]*=t)}),n}function wB(n,t){if(t==null&&(t="centroid"),Array.isArray(t)||typeof t=="object")return Ke(t);var e=n.bbox?n.bbox:_a(n),r=e[0],i=e[1],s=e[2],o=e[3];switch(t){case"sw":case"southwest":case"westsouth":case"bottomleft":return wt([r,i]);case"se":case"southeast":case"eastsouth":case"bottomright":return wt([s,i]);case"nw":case"northwest":case"westnorth":case"topleft":return wt([r,o]);case"ne":case"northeast":case"eastnorth":case"topright":return wt([s,o]);case"center":return lg(n);case void 0:case null:case"centroid":return Jl(n);default:throw new Error("invalid origin")}}class vu extends Un{_geometryBeingScaled;_selectedEditHandle;_cornerGuidePoints=[];_cursor;_isScaling=!1;_isSinglePointGeometrySelected=t=>{const{features:e}=t||{};if(Array.isArray(e)&&e.length===1){const{type:r}=lr(e[0]);return r==="Point"}return!1};_getOppositeScaleHandle=t=>{const e=t&&t.properties&&Array.isArray(t.properties.positionIndexes)&&t.properties.positionIndexes[0];if(typeof e!="number")return null;const r=this._cornerGuidePoints.length,i=(e+r/2)%r;return this._cornerGuidePoints.find(s=>Array.isArray(s.properties.positionIndexes)?s.properties.positionIndexes[0]===i:!1)||null};_getUpdatedData=(t,e)=>{let r=new Ve(t.data);const i=t.selectedIndexes;for(let s=0;s<i.length;s++){const o=i[s],a=e.features[s];r=r.replaceGeometry(o,a.geometry)}return r.getObject()};isEditHandleSelected=()=>!!this._selectedEditHandle;getScaleAction=(t,e,r,i)=>{if(!this._selectedEditHandle)return null;const s=this._getOppositeScaleHandle(this._selectedEditHandle),o=Ke(s),a=SB(o,t,e),l=EB(this._geometryBeingScaled,a,{origin:o});return{updatedData:this._getUpdatedData(i,l),editType:r,editContext:{featureIndexes:i.selectedIndexes}}};updateCursor=t=>{if(this._selectedEditHandle){this._cursor&&t.onUpdateCursor(this._cursor);const e=this.getSelectedFeaturesAsFeatureCollection(t),r=Jl(e),i=cr(r,this._selectedEditHandle),s=i<0?i+180:i;s>=0&&s<=90||s>=180&&s<=270?(this._cursor="nesw-resize",t.onUpdateCursor("nesw-resize")):(this._cursor="nwse-resize",t.onUpdateCursor("nwse-resize"))}else t.onUpdateCursor(null),this._cursor=null};handlePointerMove(t,e){if(!this._isScaling){const r=Ur(t.picks);this._selectedEditHandle=r&&r.properties.editHandleType==="scale"?r:null,this.updateCursor(e)}}handleStartDragging(t,e){this._selectedEditHandle&&(t.cancelPan(),this._isScaling=!0,this._geometryBeingScaled=this.getSelectedFeaturesAsFeatureCollection(e))}handleDragging(t,e){if(!this._isScaling)return;e.onUpdateCursor(this._cursor);const r=this.getScaleAction(t.pointerDownMapCoords,t.mapCoords,"scaling",e);r&&e.onEdit(r),t.cancelPan()}handleStopDragging(t,e){if(this._isScaling){const r=this.getScaleAction(t.pointerDownMapCoords,t.mapCoords,"scaled",e);r&&e.onEdit(r),e.onUpdateCursor(null),this._geometryBeingScaled=null,this._selectedEditHandle=null,this._cursor=null,this._isScaling=!1}}getGuides(t){this._cornerGuidePoints=[];const e=this.getSelectedFeaturesAsFeatureCollection(t);if(this._isSinglePointGeometrySelected(e))return{type:"FeatureCollection",features:[]};const r=Ao(_a(e));r.properties.mode="scale";const i=[];return Ws(r,(s,o)=>{if(o<4){const a=wt(s,{guideType:"editHandle",editHandleType:"scale",positionIndexes:[o]});i.push(a)}}),this._cornerGuidePoints=i,Ir([Rg(r),...this._cornerGuidePoints])}}function SB(n,t,e){const r=Zt(n,t);return Zt(n,e)/r}function QE(n,t,e){if(e=e||{},!Mh(e))throw new Error("options is invalid");var r=e.pivot,i=e.mutate;if(!n)throw new Error("geojson is required");if(t==null||isNaN(t))throw new Error("angle is required");return t===0||(r||(r=Jl(n)),(i===!1||i===void 0)&&(n=$h(n)),Ws(n,function(s){var o=Ag(r,s),a=o+t,l=jh(r,s),c=An(za(r,l,a));s[0]=c[0],s[1]=c[1]})),n}class bu extends Un{_selectedEditHandle;_geometryBeingRotated;_isRotating=!1;_isSinglePointGeometrySelected=t=>{const{features:e}=t||{};if(Array.isArray(e)&&e.length===1){const{type:r}=lr(e[0]);return r==="Point"}return!1};getIsRotating=()=>this._isRotating;getGuides(t){const e=this._geometryBeingRotated||this.getSelectedFeaturesAsFeatureCollection(t);if(this._isSinglePointGeometrySelected(e))return{type:"FeatureCollection",features:[]};if(this._isRotating)return Ir([Jl(e)]);const r=Ao(_a(e));let i=null,s=null,o=0;Ws(r,h=>{if(i){const f=Xh(h,i);(!s||f[1]>s[1])&&(s=f);const d=Zt(h,i);o=Math.max(o,d)}i=h});const a=s&&[s[0],s[1]+o/1e3],l=Nn([s,a]),c=wt(a,{guideType:"editHandle",editHandleType:"rotate"}),u=[Rg(r),c,l];return Ir(u)}handleDragging(t,e){if(!this._isRotating)return;const r=this.getRotateAction(t.pointerDownMapCoords,t.mapCoords,"rotating",e);r&&e.onEdit(r),t.cancelPan()}handlePointerMove(t,e){if(!this._isRotating){const r=Ur(t.picks);this._selectedEditHandle=r&&r.properties.editHandleType==="rotate"?r:null}this.updateCursor(e)}handleStartDragging(t,e){this._selectedEditHandle&&(t.cancelPan(),this._isRotating=!0,this._geometryBeingRotated=this.getSelectedFeaturesAsFeatureCollection(e))}handleStopDragging(t,e){if(this._isRotating){const r=this.getRotateAction(t.pointerDownMapCoords,t.mapCoords,"rotated",e);r&&e.onEdit(r),this._geometryBeingRotated=null,this._selectedEditHandle=null,this._isRotating=!1}}updateCursor(t){this._selectedEditHandle?t.onUpdateCursor("crosshair"):t.onUpdateCursor(null)}getRotateAction(t,e,r,i){if(!this._geometryBeingRotated)return null;const s=Jl(this._geometryBeingRotated),o=CB(s,t,e),a=QE(this._geometryBeingRotated,o,{pivot:s});let l=new Ve(i.data);const c=i.selectedIndexes;for(let u=0;u<c.length;u++){const h=c[u],f=a.features[u];l=l.replaceGeometry(h,f.geometry)}return{updatedData:l.getObject(),editType:r,editContext:{featureIndexes:c}}}}function CB(n,t,e){const r=cr(n,t);return cr(n,e)-r}class TB extends dh{handleStartDragging(t,e){super.handleStartDragging(t,e),this._geometryBeforeTranslate&&e.onEdit(this.getAddManyFeaturesAction(this._geometryBeforeTranslate,e.data))}updateCursor(t){this._isTranslatable?t.onUpdateCursor("copy"):t.onUpdateCursor(null)}}function PB(n,t,e){if(e===void 0&&(e={}),!n)throw new Error("point is required");if(!t)throw new Error("polygon is required");var r=Ke(n),i=lr(t),s=i.type,o=t.bbox,a=i.coordinates;if(o&&IB(r,o)===!1)return!1;s==="Polygon"&&(a=[a]);for(var l=!1,c=0;c<a.length&&!l;c++)if(bv(r,a[c][0],e.ignoreBoundary)){for(var u=!1,h=1;h<a[c].length&&!u;)bv(r,a[c][h],!e.ignoreBoundary)&&(u=!0),h++;u||(l=!0)}return l}function bv(n,t,e){var r=!1;t[0][0]===t[t.length-1][0]&&t[0][1]===t[t.length-1][1]&&(t=t.slice(0,t.length-1));for(var i=0,s=t.length-1;i<t.length;s=i++){var o=t[i][0],a=t[i][1],l=t[s][0],c=t[s][1],u=n[1]*(o-l)+a*(l-n[0])+c*(n[0]-o)===0&&(o-n[0])*(l-n[0])<=0&&(a-n[1])*(c-n[1])<=0;if(u)return!e;var h=a>n[1]!=c>n[1]&&n[0]<(l-o)*(n[1]-a)/(c-a)+o;h&&(r=!r)}return r}function IB(n,t){return t[0]<=n[0]&&t[1]<=n[1]&&t[2]>=n[0]&&t[3]>=n[1]}function xv(n){if(!n)throw new Error("geojson is required");var t=[];return Rh(n,function(e){AB(e,t)}),Ir(t)}function AB(n,t){var e=[],r=n.geometry;if(r!==null){switch(r.type){case"Polygon":e=An(r);break;case"LineString":e=[An(r)]}e.forEach(function(i){var s=MB(i,n.properties);s.forEach(function(o){o.id=t.length,t.push(o)})})}}function MB(n,t){var e=[];return n.reduce(function(r,i){var s=Nn([r,i],t);return s.bbox=RB(r,i),e.push(s),i}),e}function RB(n,t){var e=n[0],r=n[1],i=t[0],s=t[1],o=e<i?e:i,a=r<s?r:s,l=e>i?e:i,c=r>s?r:s;return[o,a,l,c]}var Kc={exports:{}},xu={exports:{}},NB=xu.exports,Ev;function OB(){return Ev||(Ev=1,function(n,t){(function(e,r){n.exports=r()})(NB,function(){function e(m,g,y,b,x){(function w(S,I,T,M,L){for(;M>T;){if(M-T>600){var O=M-T+1,P=I-T+1,V=Math.log(O),C=.5*Math.exp(2*V/3),R=.5*Math.sqrt(V*C*(O-C)/O)*(P-O/2<0?-1:1),D=Math.max(T,Math.floor(I-P*C/O+R)),H=Math.min(M,Math.floor(I+(O-P)*C/O+R));w(S,I,D,H,L)}var K=S[I],G=T,Y=M;for(r(S,T,I),L(S[M],K)>0&&r(S,T,M);G<Y;){for(r(S,G,Y),G++,Y--;L(S[G],K)<0;)G++;for(;L(S[Y],K)>0;)Y--}L(S[T],K)===0?r(S,T,Y):r(S,++Y,M),Y<=I&&(T=Y+1),I<=Y&&(M=Y-1)}})(m,g,y||0,b||m.length-1,x||i)}function r(m,g,y){var b=m[g];m[g]=m[y],m[y]=b}function i(m,g){return m<g?-1:m>g?1:0}var s=function(m){m===void 0&&(m=9),this._maxEntries=Math.max(4,m),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()};function o(m,g,y){if(!y)return g.indexOf(m);for(var b=0;b<g.length;b++)if(y(m,g[b]))return b;return-1}function a(m,g){l(m,0,m.children.length,g,m)}function l(m,g,y,b,x){x||(x=v(null)),x.minX=1/0,x.minY=1/0,x.maxX=-1/0,x.maxY=-1/0;for(var w=g;w<y;w++){var S=m.children[w];c(x,m.leaf?b(S):S)}return x}function c(m,g){return m.minX=Math.min(m.minX,g.minX),m.minY=Math.min(m.minY,g.minY),m.maxX=Math.max(m.maxX,g.maxX),m.maxY=Math.max(m.maxY,g.maxY),m}function u(m,g){return m.minX-g.minX}function h(m,g){return m.minY-g.minY}function f(m){return(m.maxX-m.minX)*(m.maxY-m.minY)}function d(m){return m.maxX-m.minX+(m.maxY-m.minY)}function p(m,g){return m.minX<=g.minX&&m.minY<=g.minY&&g.maxX<=m.maxX&&g.maxY<=m.maxY}function _(m,g){return g.minX<=m.maxX&&g.minY<=m.maxY&&g.maxX>=m.minX&&g.maxY>=m.minY}function v(m){return{children:m,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function E(m,g,y,b,x){for(var w=[g,y];w.length;)if(!((y=w.pop())-(g=w.pop())<=b)){var S=g+Math.ceil((y-g)/b/2)*b;e(m,S,g,y,x),w.push(g,S,S,y)}}return s.prototype.all=function(){return this._all(this.data,[])},s.prototype.search=function(m){var g=this.data,y=[];if(!_(m,g))return y;for(var b=this.toBBox,x=[];g;){for(var w=0;w<g.children.length;w++){var S=g.children[w],I=g.leaf?b(S):S;_(m,I)&&(g.leaf?y.push(S):p(m,I)?this._all(S,y):x.push(S))}g=x.pop()}return y},s.prototype.collides=function(m){var g=this.data;if(!_(m,g))return!1;for(var y=[];g;){for(var b=0;b<g.children.length;b++){var x=g.children[b],w=g.leaf?this.toBBox(x):x;if(_(m,w)){if(g.leaf||p(m,w))return!0;y.push(x)}}g=y.pop()}return!1},s.prototype.load=function(m){if(!m||!m.length)return this;if(m.length<this._minEntries){for(var g=0;g<m.length;g++)this.insert(m[g]);return this}var y=this._build(m.slice(),0,m.length-1,0);if(this.data.children.length)if(this.data.height===y.height)this._splitRoot(this.data,y);else{if(this.data.height<y.height){var b=this.data;this.data=y,y=b}this._insert(y,this.data.height-y.height-1,!0)}else this.data=y;return this},s.prototype.insert=function(m){return m&&this._insert(m,this.data.height-1),this},s.prototype.clear=function(){return this.data=v([]),this},s.prototype.remove=function(m,g){if(!m)return this;for(var y,b,x,w=this.data,S=this.toBBox(m),I=[],T=[];w||I.length;){if(w||(w=I.pop(),b=I[I.length-1],y=T.pop(),x=!0),w.leaf){var M=o(m,w.children,g);if(M!==-1)return w.children.splice(M,1),I.push(w),this._condense(I),this}x||w.leaf||!p(w,S)?b?(y++,w=b.children[y],x=!1):w=null:(I.push(w),T.push(y),y=0,b=w,w=w.children[0])}return this},s.prototype.toBBox=function(m){return m},s.prototype.compareMinX=function(m,g){return m.minX-g.minX},s.prototype.compareMinY=function(m,g){return m.minY-g.minY},s.prototype.toJSON=function(){return this.data},s.prototype.fromJSON=function(m){return this.data=m,this},s.prototype._all=function(m,g){for(var y=[];m;)m.leaf?g.push.apply(g,m.children):y.push.apply(y,m.children),m=y.pop();return g},s.prototype._build=function(m,g,y,b){var x,w=y-g+1,S=this._maxEntries;if(w<=S)return a(x=v(m.slice(g,y+1)),this.toBBox),x;b||(b=Math.ceil(Math.log(w)/Math.log(S)),S=Math.ceil(w/Math.pow(S,b-1))),(x=v([])).leaf=!1,x.height=b;var I=Math.ceil(w/S),T=I*Math.ceil(Math.sqrt(S));E(m,g,y,T,this.compareMinX);for(var M=g;M<=y;M+=T){var L=Math.min(M+T-1,y);E(m,M,L,I,this.compareMinY);for(var O=M;O<=L;O+=I){var P=Math.min(O+I-1,L);x.children.push(this._build(m,O,P,b-1))}}return a(x,this.toBBox),x},s.prototype._chooseSubtree=function(m,g,y,b){for(;b.push(g),!g.leaf&&b.length-1!==y;){for(var x=1/0,w=1/0,S=void 0,I=0;I<g.children.length;I++){var T=g.children[I],M=f(T),L=(O=m,P=T,(Math.max(P.maxX,O.maxX)-Math.min(P.minX,O.minX))*(Math.max(P.maxY,O.maxY)-Math.min(P.minY,O.minY))-M);L<w?(w=L,x=M<x?M:x,S=T):L===w&&M<x&&(x=M,S=T)}g=S||g.children[0]}var O,P;return g},s.prototype._insert=function(m,g,y){var b=y?m:this.toBBox(m),x=[],w=this._chooseSubtree(b,this.data,g,x);for(w.children.push(m),c(w,b);g>=0&&x[g].children.length>this._maxEntries;)this._split(x,g),g--;this._adjustParentBBoxes(b,x,g)},s.prototype._split=function(m,g){var y=m[g],b=y.children.length,x=this._minEntries;this._chooseSplitAxis(y,x,b);var w=this._chooseSplitIndex(y,x,b),S=v(y.children.splice(w,y.children.length-w));S.height=y.height,S.leaf=y.leaf,a(y,this.toBBox),a(S,this.toBBox),g?m[g-1].children.push(S):this._splitRoot(y,S)},s.prototype._splitRoot=function(m,g){this.data=v([m,g]),this.data.height=m.height+1,this.data.leaf=!1,a(this.data,this.toBBox)},s.prototype._chooseSplitIndex=function(m,g,y){for(var b,x,w,S,I,T,M,L=1/0,O=1/0,P=g;P<=y-g;P++){var V=l(m,0,P,this.toBBox),C=l(m,P,y,this.toBBox),R=(x=V,w=C,S=void 0,I=void 0,T=void 0,M=void 0,S=Math.max(x.minX,w.minX),I=Math.max(x.minY,w.minY),T=Math.min(x.maxX,w.maxX),M=Math.min(x.maxY,w.maxY),Math.max(0,T-S)*Math.max(0,M-I)),D=f(V)+f(C);R<L?(L=R,b=P,O=D<O?D:O):R===L&&D<O&&(O=D,b=P)}return b||y-g},s.prototype._chooseSplitAxis=function(m,g,y){var b=m.leaf?this.compareMinX:u,x=m.leaf?this.compareMinY:h;this._allDistMargin(m,g,y,b)<this._allDistMargin(m,g,y,x)&&m.children.sort(b)},s.prototype._allDistMargin=function(m,g,y,b){m.children.sort(b);for(var x=this.toBBox,w=l(m,0,g,x),S=l(m,y-g,y,x),I=d(w)+d(S),T=g;T<y-g;T++){var M=m.children[T];c(w,m.leaf?x(M):M),I+=d(w)}for(var L=y-g-1;L>=g;L--){var O=m.children[L];c(S,m.leaf?x(O):O),I+=d(S)}return I},s.prototype._adjustParentBBoxes=function(m,g,y){for(var b=y;b>=0;b--)c(g[b],m)},s.prototype._condense=function(m){for(var g=m.length-1,y=void 0;g>=0;g--)m[g].children.length===0?g>0?(y=m[g-1].children).splice(y.indexOf(m[g]),1):this.clear():a(m[g],this.toBBox)},s})}(xu)),xu.exports}var Kf={},wv;function tw(){return wv||(wv=1,function(n){Object.defineProperty(n,"__esModule",{value:!0}),n.earthRadius=63710088e-1,n.factors={centimeters:n.earthRadius*100,centimetres:n.earthRadius*100,degrees:n.earthRadius/111325,feet:n.earthRadius*3.28084,inches:n.earthRadius*39.37,kilometers:n.earthRadius/1e3,kilometres:n.earthRadius/1e3,meters:n.earthRadius,metres:n.earthRadius,miles:n.earthRadius/1609.344,millimeters:n.earthRadius*1e3,millimetres:n.earthRadius*1e3,nauticalmiles:n.earthRadius/1852,radians:1,yards:n.earthRadius*1.0936},n.unitsFactors={centimeters:100,centimetres:100,degrees:1/111325,feet:3.28084,inches:39.37,kilometers:1/1e3,kilometres:1/1e3,meters:1,metres:1,miles:1/1609.344,millimeters:1e3,millimetres:1e3,nauticalmiles:1/1852,radians:1/n.earthRadius,yards:1.0936133},n.areaFactors={acres:247105e-9,centimeters:1e4,centimetres:1e4,feet:10.763910417,hectares:1e-4,inches:1550.003100006,kilometers:1e-6,kilometres:1e-6,meters:1,metres:1,miles:386e-9,millimeters:1e6,millimetres:1e6,yards:1.195990046};function t(M,L,O){O===void 0&&(O={});var P={type:"Feature"};return(O.id===0||O.id)&&(P.id=O.id),O.bbox&&(P.bbox=O.bbox),P.properties=L||{},P.geometry=M,P}n.feature=t;function e(M,L,O){switch(M){case"Point":return r(L).geometry;case"LineString":return a(L).geometry;case"Polygon":return s(L).geometry;case"MultiPoint":return h(L).geometry;case"MultiLineString":return u(L).geometry;case"MultiPolygon":return f(L).geometry;default:throw new Error(M+" is invalid")}}n.geometry=e;function r(M,L,O){if(O===void 0&&(O={}),!M)throw new Error("coordinates is required");if(!Array.isArray(M))throw new Error("coordinates must be an Array");if(M.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!w(M[0])||!w(M[1]))throw new Error("coordinates must contain numbers");var P={type:"Point",coordinates:M};return t(P,L,O)}n.point=r;function i(M,L,O){return O===void 0&&(O={}),c(M.map(function(P){return r(P,L)}),O)}n.points=i;function s(M,L,O){O===void 0&&(O={});for(var P=0,V=M;P<V.length;P++){var C=V[P];if(C.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");for(var R=0;R<C[C.length-1].length;R++)if(C[C.length-1][R]!==C[0][R])throw new Error("First and last Position are not equivalent.")}var D={type:"Polygon",coordinates:M};return t(D,L,O)}n.polygon=s;function o(M,L,O){return O===void 0&&(O={}),c(M.map(function(P){return s(P,L)}),O)}n.polygons=o;function a(M,L,O){if(O===void 0&&(O={}),M.length<2)throw new Error("coordinates must be an array of two or more positions");var P={type:"LineString",coordinates:M};return t(P,L,O)}n.lineString=a;function l(M,L,O){return O===void 0&&(O={}),c(M.map(function(P){return a(P,L)}),O)}n.lineStrings=l;function c(M,L){L===void 0&&(L={});var O={type:"FeatureCollection"};return L.id&&(O.id=L.id),L.bbox&&(O.bbox=L.bbox),O.features=M,O}n.featureCollection=c;function u(M,L,O){O===void 0&&(O={});var P={type:"MultiLineString",coordinates:M};return t(P,L,O)}n.multiLineString=u;function h(M,L,O){O===void 0&&(O={});var P={type:"MultiPoint",coordinates:M};return t(P,L,O)}n.multiPoint=h;function f(M,L,O){O===void 0&&(O={});var P={type:"MultiPolygon",coordinates:M};return t(P,L,O)}n.multiPolygon=f;function d(M,L,O){O===void 0&&(O={});var P={type:"GeometryCollection",geometries:M};return t(P,L,O)}n.geometryCollection=d;function p(M,L){if(L===void 0&&(L=0),L&&!(L>=0))throw new Error("precision must be a positive number");var O=Math.pow(10,L||0);return Math.round(M*O)/O}n.round=p;function _(M,L){L===void 0&&(L="kilometers");var O=n.factors[L];if(!O)throw new Error(L+" units is invalid");return M*O}n.radiansToLength=_;function v(M,L){L===void 0&&(L="kilometers");var O=n.factors[L];if(!O)throw new Error(L+" units is invalid");return M/O}n.lengthToRadians=v;function E(M,L){return g(v(M,L))}n.lengthToDegrees=E;function m(M){var L=M%360;return L<0&&(L+=360),L}n.bearingToAzimuth=m;function g(M){var L=M%(2*Math.PI);return L*180/Math.PI}n.radiansToDegrees=g;function y(M){var L=M%360;return L*Math.PI/180}n.degreesToRadians=y;function b(M,L,O){if(L===void 0&&(L="kilometers"),O===void 0&&(O="kilometers"),!(M>=0))throw new Error("length must be a positive number");return _(v(M,L),O)}n.convertLength=b;function x(M,L,O){if(L===void 0&&(L="meters"),O===void 0&&(O="kilometers"),!(M>=0))throw new Error("area must be a positive number");var P=n.areaFactors[L];if(!P)throw new Error("invalid original units");var V=n.areaFactors[O];if(!V)throw new Error("invalid final units");return M/P*V}n.convertArea=x;function w(M){return!isNaN(M)&&M!==null&&!Array.isArray(M)}n.isNumber=w;function S(M){return!!M&&M.constructor===Object}n.isObject=S;function I(M){if(!M)throw new Error("bbox is required");if(!Array.isArray(M))throw new Error("bbox must be an Array");if(M.length!==4&&M.length!==6)throw new Error("bbox must be an Array of 4 or 6 numbers");M.forEach(function(L){if(!w(L))throw new Error("bbox must only contain numbers")})}n.validateBBox=I;function T(M){if(!M)throw new Error("id is required");if(["string","number"].indexOf(typeof M)===-1)throw new Error("id must be a number or a string")}n.validateId=T}(Kf)),Kf}var Ce={},Sv;function DB(){if(Sv)return Ce;Sv=1,Object.defineProperty(Ce,"__esModule",{value:!0});var n=tw();function t(m,g,y){if(m!==null)for(var b,x,w,S,I,T,M,L=0,O=0,P,V=m.type,C=V==="FeatureCollection",R=V==="Feature",D=C?m.features.length:1,H=0;H<D;H++){M=C?m.features[H].geometry:R?m.geometry:m,P=M?M.type==="GeometryCollection":!1,I=P?M.geometries.length:1;for(var K=0;K<I;K++){var G=0,Y=0;if(S=P?M.geometries[K]:M,S!==null){T=S.coordinates;var J=S.type;switch(L=y&&(J==="Polygon"||J==="MultiPolygon")?1:0,J){case null:break;case"Point":if(g(T,O,H,G,Y)===!1)return!1;O++,G++;break;case"LineString":case"MultiPoint":for(b=0;b<T.length;b++){if(g(T[b],O,H,G,Y)===!1)return!1;O++,J==="MultiPoint"&&G++}J==="LineString"&&G++;break;case"Polygon":case"MultiLineString":for(b=0;b<T.length;b++){for(x=0;x<T[b].length-L;x++){if(g(T[b][x],O,H,G,Y)===!1)return!1;O++}J==="MultiLineString"&&G++,J==="Polygon"&&Y++}J==="Polygon"&&G++;break;case"MultiPolygon":for(b=0;b<T.length;b++){for(Y=0,x=0;x<T[b].length;x++){for(w=0;w<T[b][x].length-L;w++){if(g(T[b][x][w],O,H,G,Y)===!1)return!1;O++}Y++}G++}break;case"GeometryCollection":for(b=0;b<S.geometries.length;b++)if(t(S.geometries[b],g,y)===!1)return!1;break;default:throw new Error("Unknown Geometry Type")}}}}}function e(m,g,y,b){var x=y;return t(m,function(w,S,I,T,M){S===0&&y===void 0?x=w:x=g(x,w,S,I,T,M)},b),x}function r(m,g){var y;switch(m.type){case"FeatureCollection":for(y=0;y<m.features.length&&g(m.features[y].properties,y)!==!1;y++);break;case"Feature":g(m.properties,0);break}}function i(m,g,y){var b=y;return r(m,function(x,w){w===0&&y===void 0?b=x:b=g(b,x,w)}),b}function s(m,g){if(m.type==="Feature")g(m,0);else if(m.type==="FeatureCollection")for(var y=0;y<m.features.length&&g(m.features[y],y)!==!1;y++);}function o(m,g,y){var b=y;return s(m,function(x,w){w===0&&y===void 0?b=x:b=g(b,x,w)}),b}function a(m){var g=[];return t(m,function(y){g.push(y)}),g}function l(m,g){var y,b,x,w,S,I,T,M,L,O,P=0,V=m.type==="FeatureCollection",C=m.type==="Feature",R=V?m.features.length:1;for(y=0;y<R;y++){for(I=V?m.features[y].geometry:C?m.geometry:m,M=V?m.features[y].properties:C?m.properties:{},L=V?m.features[y].bbox:C?m.bbox:void 0,O=V?m.features[y].id:C?m.id:void 0,T=I?I.type==="GeometryCollection":!1,S=T?I.geometries.length:1,x=0;x<S;x++){if(w=T?I.geometries[x]:I,w===null){if(g(null,P,M,L,O)===!1)return!1;continue}switch(w.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":{if(g(w,P,M,L,O)===!1)return!1;break}case"GeometryCollection":{for(b=0;b<w.geometries.length;b++)if(g(w.geometries[b],P,M,L,O)===!1)return!1;break}default:throw new Error("Unknown Geometry Type")}}P++}}function c(m,g,y){var b=y;return l(m,function(x,w,S,I,T){w===0&&y===void 0?b=x:b=g(b,x,w,S,I,T)}),b}function u(m,g){l(m,function(y,b,x,w,S){var I=y===null?null:y.type;switch(I){case null:case"Point":case"LineString":case"Polygon":return g(n.feature(y,x,{bbox:w,id:S}),b,0)===!1?!1:void 0}var T;switch(I){case"MultiPoint":T="Point";break;case"MultiLineString":T="LineString";break;case"MultiPolygon":T="Polygon";break}for(var M=0;M<y.coordinates.length;M++){var L=y.coordinates[M],O={type:T,coordinates:L};if(g(n.feature(O,x),b,M)===!1)return!1}})}function h(m,g,y){var b=y;return u(m,function(x,w,S){w===0&&S===0&&y===void 0?b=x:b=g(b,x,w,S)}),b}function f(m,g){u(m,function(y,b,x){var w=0;if(y.geometry){var S=y.geometry.type;if(!(S==="Point"||S==="MultiPoint")){var I,T=0,M=0,L=0;if(t(y,function(O,P,V,C,R){if(I===void 0||b>T||C>M||R>L){I=O,T=b,M=C,L=R,w=0;return}var D=n.lineString([I,O],y.properties);if(g(D,b,x,R,w)===!1)return!1;w++,I=O})===!1)return!1}}})}function d(m,g,y){var b=y,x=!1;return f(m,function(w,S,I,T,M){x===!1&&y===void 0?b=w:b=g(b,w,S,I,T,M),x=!0}),b}function p(m,g){if(!m)throw new Error("geojson is required");u(m,function(y,b,x){if(y.geometry!==null){var w=y.geometry.type,S=y.geometry.coordinates;switch(w){case"LineString":if(g(y,b,x,0,0)===!1)return!1;break;case"Polygon":for(var I=0;I<S.length;I++)if(g(n.lineString(S[I],y.properties),b,x,I)===!1)return!1;break}}})}function _(m,g,y){var b=y;return p(m,function(x,w,S,I){w===0&&y===void 0?b=x:b=g(b,x,w,S,I)}),b}function v(m,g){if(g=g||{},!n.isObject(g))throw new Error("options is invalid");var y=g.featureIndex||0,b=g.multiFeatureIndex||0,x=g.geometryIndex||0,w=g.segmentIndex||0,S=g.properties,I;switch(m.type){case"FeatureCollection":y<0&&(y=m.features.length+y),S=S||m.features[y].properties,I=m.features[y].geometry;break;case"Feature":S=S||m.properties,I=m.geometry;break;case"Point":case"MultiPoint":return null;case"LineString":case"Polygon":case"MultiLineString":case"MultiPolygon":I=m;break;default:throw new Error("geojson is invalid")}if(I===null)return null;var T=I.coordinates;switch(I.type){case"Point":case"MultiPoint":return null;case"LineString":return w<0&&(w=T.length+w-1),n.lineString([T[w],T[w+1]],S,g);case"Polygon":return x<0&&(x=T.length+x),w<0&&(w=T[x].length+w-1),n.lineString([T[x][w],T[x][w+1]],S,g);case"MultiLineString":return b<0&&(b=T.length+b),w<0&&(w=T[b].length+w-1),n.lineString([T[b][w],T[b][w+1]],S,g);case"MultiPolygon":return b<0&&(b=T.length+b),x<0&&(x=T[b].length+x),w<0&&(w=T[b][x].length-w-1),n.lineString([T[b][x][w],T[b][x][w+1]],S,g)}throw new Error("geojson is invalid")}function E(m,g){if(g=g||{},!n.isObject(g))throw new Error("options is invalid");var y=g.featureIndex||0,b=g.multiFeatureIndex||0,x=g.geometryIndex||0,w=g.coordIndex||0,S=g.properties,I;switch(m.type){case"FeatureCollection":y<0&&(y=m.features.length+y),S=S||m.features[y].properties,I=m.features[y].geometry;break;case"Feature":S=S||m.properties,I=m.geometry;break;case"Point":case"MultiPoint":return null;case"LineString":case"Polygon":case"MultiLineString":case"MultiPolygon":I=m;break;default:throw new Error("geojson is invalid")}if(I===null)return null;var T=I.coordinates;switch(I.type){case"Point":return n.point(T,S,g);case"MultiPoint":return b<0&&(b=T.length+b),n.point(T[b],S,g);case"LineString":return w<0&&(w=T.length+w),n.point(T[w],S,g);case"Polygon":return x<0&&(x=T.length+x),w<0&&(w=T[x].length+w),n.point(T[x][w],S,g);case"MultiLineString":return b<0&&(b=T.length+b),w<0&&(w=T[b].length+w),n.point(T[b][w],S,g);case"MultiPolygon":return b<0&&(b=T.length+b),x<0&&(x=T[b].length+x),w<0&&(w=T[b][x].length-w),n.point(T[b][x][w],S,g)}throw new Error("geojson is invalid")}return Ce.coordAll=a,Ce.coordEach=t,Ce.coordReduce=e,Ce.featureEach=s,Ce.featureReduce=o,Ce.findPoint=E,Ce.findSegment=v,Ce.flattenEach=u,Ce.flattenReduce=h,Ce.geomEach=l,Ce.geomReduce=c,Ce.lineEach=p,Ce.lineReduce=_,Ce.propEach=r,Ce.propReduce=i,Ce.segmentEach=f,Ce.segmentReduce=d,Ce}var sl={},Te={},Nt={},Cv;function LB(){if(Cv)return Nt;Cv=1,Object.defineProperty(Nt,"__esModule",{value:!0});var n=63710088e-1,t={centimeters:n*100,centimetres:n*100,degrees:360/(2*Math.PI),feet:n*3.28084,inches:n*39.37,kilometers:n/1e3,kilometres:n/1e3,meters:n,metres:n,miles:n/1609.344,millimeters:n*1e3,millimetres:n*1e3,nauticalmiles:n/1852,radians:1,yards:n*1.0936},e={acres:247105e-9,centimeters:1e4,centimetres:1e4,feet:10.763910417,hectares:1e-4,inches:1550.003100006,kilometers:1e-6,kilometres:1e-6,meters:1,metres:1,miles:386e-9,nauticalmiles:29155334959812285e-23,millimeters:1e6,millimetres:1e6,yards:1.195990046};function r(P,V,C={}){const R={type:"Feature"};return(C.id===0||C.id)&&(R.id=C.id),C.bbox&&(R.bbox=C.bbox),R.properties=V||{},R.geometry=P,R}function i(P,V,C={}){switch(P){case"Point":return s(V).geometry;case"LineString":return c(V).geometry;case"Polygon":return a(V).geometry;case"MultiPoint":return d(V).geometry;case"MultiLineString":return f(V).geometry;case"MultiPolygon":return p(V).geometry;default:throw new Error(P+" is invalid")}}function s(P,V,C={}){if(!P)throw new Error("coordinates is required");if(!Array.isArray(P))throw new Error("coordinates must be an Array");if(P.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!T(P[0])||!T(P[1]))throw new Error("coordinates must contain numbers");return r({type:"Point",coordinates:P},V,C)}function o(P,V,C={}){return h(P.map(R=>s(R,V)),C)}function a(P,V,C={}){for(const D of P){if(D.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");if(D[D.length-1].length!==D[0].length)throw new Error("First and last Position are not equivalent.");for(let H=0;H<D[D.length-1].length;H++)if(D[D.length-1][H]!==D[0][H])throw new Error("First and last Position are not equivalent.")}return r({type:"Polygon",coordinates:P},V,C)}function l(P,V,C={}){return h(P.map(R=>a(R,V)),C)}function c(P,V,C={}){if(P.length<2)throw new Error("coordinates must be an array of two or more positions");return r({type:"LineString",coordinates:P},V,C)}function u(P,V,C={}){return h(P.map(R=>c(R,V)),C)}function h(P,V={}){const C={type:"FeatureCollection"};return V.id&&(C.id=V.id),V.bbox&&(C.bbox=V.bbox),C.features=P,C}function f(P,V,C={}){return r({type:"MultiLineString",coordinates:P},V,C)}function d(P,V,C={}){return r({type:"MultiPoint",coordinates:P},V,C)}function p(P,V,C={}){return r({type:"MultiPolygon",coordinates:P},V,C)}function _(P,V,C={}){return r({type:"GeometryCollection",geometries:P},V,C)}function v(P,V=0){if(V&&!(V>=0))throw new Error("precision must be a positive number");const C=Math.pow(10,V||0);return Math.round(P*C)/C}function E(P,V="kilometers"){const C=t[V];if(!C)throw new Error(V+" units is invalid");return P*C}function m(P,V="kilometers"){const C=t[V];if(!C)throw new Error(V+" units is invalid");return P/C}function g(P,V){return x(m(P,V))}function y(P){let V=P%360;return V<0&&(V+=360),V}function b(P){return P=P%360,P>180?P-360:P<-180?P+360:P}function x(P){return P%(2*Math.PI)*180/Math.PI}function w(P){return P%360*Math.PI/180}function S(P,V="kilometers",C="kilometers"){if(!(P>=0))throw new Error("length must be a positive number");return E(m(P,V),C)}function I(P,V="meters",C="kilometers"){if(!(P>=0))throw new Error("area must be a positive number");const R=e[V];if(!R)throw new Error("invalid original units");const D=e[C];if(!D)throw new Error("invalid final units");return P/R*D}function T(P){return!isNaN(P)&&P!==null&&!Array.isArray(P)}function M(P){return P!==null&&typeof P=="object"&&!Array.isArray(P)}function L(P){if(!P)throw new Error("bbox is required");if(!Array.isArray(P))throw new Error("bbox must be an Array");if(P.length!==4&&P.length!==6)throw new Error("bbox must be an Array of 4 or 6 numbers");P.forEach(V=>{if(!T(V))throw new Error("bbox must only contain numbers")})}function O(P){if(!P)throw new Error("id is required");if(["string","number"].indexOf(typeof P)===-1)throw new Error("id must be a number or a string")}return Nt.areaFactors=e,Nt.azimuthToBearing=b,Nt.bearingToAzimuth=y,Nt.convertArea=I,Nt.convertLength=S,Nt.degreesToRadians=w,Nt.earthRadius=n,Nt.factors=t,Nt.feature=r,Nt.featureCollection=h,Nt.geometry=i,Nt.geometryCollection=_,Nt.isNumber=T,Nt.isObject=M,Nt.lengthToDegrees=g,Nt.lengthToRadians=m,Nt.lineString=c,Nt.lineStrings=u,Nt.multiLineString=f,Nt.multiPoint=d,Nt.multiPolygon=p,Nt.point=s,Nt.points=o,Nt.polygon=a,Nt.polygons=l,Nt.radiansToDegrees=x,Nt.radiansToLength=E,Nt.round=v,Nt.validateBBox=L,Nt.validateId=O,Nt}var Tv;function kB(){if(Tv)return Te;Tv=1,Object.defineProperty(Te,"__esModule",{value:!0});var n=LB();function t(m,g,y){if(m!==null)for(var b,x,w,S,I,T,M,L=0,O=0,P,V=m.type,C=V==="FeatureCollection",R=V==="Feature",D=C?m.features.length:1,H=0;H<D;H++){M=C?m.features[H].geometry:R?m.geometry:m,P=M?M.type==="GeometryCollection":!1,I=P?M.geometries.length:1;for(var K=0;K<I;K++){var G=0,Y=0;if(S=P?M.geometries[K]:M,S!==null){T=S.coordinates;var J=S.type;switch(L=y&&(J==="Polygon"||J==="MultiPolygon")?1:0,J){case null:break;case"Point":if(g(T,O,H,G,Y)===!1)return!1;O++,G++;break;case"LineString":case"MultiPoint":for(b=0;b<T.length;b++){if(g(T[b],O,H,G,Y)===!1)return!1;O++,J==="MultiPoint"&&G++}J==="LineString"&&G++;break;case"Polygon":case"MultiLineString":for(b=0;b<T.length;b++){for(x=0;x<T[b].length-L;x++){if(g(T[b][x],O,H,G,Y)===!1)return!1;O++}J==="MultiLineString"&&G++,J==="Polygon"&&Y++}J==="Polygon"&&G++;break;case"MultiPolygon":for(b=0;b<T.length;b++){for(Y=0,x=0;x<T[b].length;x++){for(w=0;w<T[b][x].length-L;w++){if(g(T[b][x][w],O,H,G,Y)===!1)return!1;O++}Y++}G++}break;case"GeometryCollection":for(b=0;b<S.geometries.length;b++)if(t(S.geometries[b],g,y)===!1)return!1;break;default:throw new Error("Unknown Geometry Type")}}}}}function e(m,g,y,b){var x=y;return t(m,function(w,S,I,T,M){S===0&&y===void 0?x=w:x=g(x,w,S,I,T,M)},b),x}function r(m,g){var y;switch(m.type){case"FeatureCollection":for(y=0;y<m.features.length&&g(m.features[y].properties,y)!==!1;y++);break;case"Feature":g(m.properties,0);break}}function i(m,g,y){var b=y;return r(m,function(x,w){w===0&&y===void 0?b=x:b=g(b,x,w)}),b}function s(m,g){if(m.type==="Feature")g(m,0);else if(m.type==="FeatureCollection")for(var y=0;y<m.features.length&&g(m.features[y],y)!==!1;y++);}function o(m,g,y){var b=y;return s(m,function(x,w){w===0&&y===void 0?b=x:b=g(b,x,w)}),b}function a(m){var g=[];return t(m,function(y){g.push(y)}),g}function l(m,g){var y,b,x,w,S,I,T,M,L,O,P=0,V=m.type==="FeatureCollection",C=m.type==="Feature",R=V?m.features.length:1;for(y=0;y<R;y++){for(I=V?m.features[y].geometry:C?m.geometry:m,M=V?m.features[y].properties:C?m.properties:{},L=V?m.features[y].bbox:C?m.bbox:void 0,O=V?m.features[y].id:C?m.id:void 0,T=I?I.type==="GeometryCollection":!1,S=T?I.geometries.length:1,x=0;x<S;x++){if(w=T?I.geometries[x]:I,w===null){if(g(null,P,M,L,O)===!1)return!1;continue}switch(w.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":{if(g(w,P,M,L,O)===!1)return!1;break}case"GeometryCollection":{for(b=0;b<w.geometries.length;b++)if(g(w.geometries[b],P,M,L,O)===!1)return!1;break}default:throw new Error("Unknown Geometry Type")}}P++}}function c(m,g,y){var b=y;return l(m,function(x,w,S,I,T){w===0&&y===void 0?b=x:b=g(b,x,w,S,I,T)}),b}function u(m,g){l(m,function(y,b,x,w,S){var I=y===null?null:y.type;switch(I){case null:case"Point":case"LineString":case"Polygon":return g(n.feature.call(void 0,y,x,{bbox:w,id:S}),b,0)===!1?!1:void 0}var T;switch(I){case"MultiPoint":T="Point";break;case"MultiLineString":T="LineString";break;case"MultiPolygon":T="Polygon";break}for(var M=0;M<y.coordinates.length;M++){var L=y.coordinates[M],O={type:T,coordinates:L};if(g(n.feature.call(void 0,O,x),b,M)===!1)return!1}})}function h(m,g,y){var b=y;return u(m,function(x,w,S){w===0&&S===0&&y===void 0?b=x:b=g(b,x,w,S)}),b}function f(m,g){u(m,function(y,b,x){var w=0;if(y.geometry){var S=y.geometry.type;if(!(S==="Point"||S==="MultiPoint")){var I,T=0,M=0,L=0;if(t(y,function(O,P,V,C,R){if(I===void 0||b>T||C>M||R>L){I=O,T=b,M=C,L=R,w=0;return}var D=n.lineString.call(void 0,[I,O],y.properties);if(g(D,b,x,R,w)===!1)return!1;w++,I=O})===!1)return!1}}})}function d(m,g,y){var b=y,x=!1;return f(m,function(w,S,I,T,M){x===!1&&y===void 0?b=w:b=g(b,w,S,I,T,M),x=!0}),b}function p(m,g){if(!m)throw new Error("geojson is required");u(m,function(y,b,x){if(y.geometry!==null){var w=y.geometry.type,S=y.geometry.coordinates;switch(w){case"LineString":if(g(y,b,x,0,0)===!1)return!1;break;case"Polygon":for(var I=0;I<S.length;I++)if(g(n.lineString.call(void 0,S[I],y.properties),b,x,I)===!1)return!1;break}}})}function _(m,g,y){var b=y;return p(m,function(x,w,S,I){w===0&&y===void 0?b=x:b=g(b,x,w,S,I)}),b}function v(m,g){if(g=g||{},!n.isObject.call(void 0,g))throw new Error("options is invalid");var y=g.featureIndex||0,b=g.multiFeatureIndex||0,x=g.geometryIndex||0,w=g.segmentIndex||0,S=g.properties,I;switch(m.type){case"FeatureCollection":y<0&&(y=m.features.length+y),S=S||m.features[y].properties,I=m.features[y].geometry;break;case"Feature":S=S||m.properties,I=m.geometry;break;case"Point":case"MultiPoint":return null;case"LineString":case"Polygon":case"MultiLineString":case"MultiPolygon":I=m;break;default:throw new Error("geojson is invalid")}if(I===null)return null;var T=I.coordinates;switch(I.type){case"Point":case"MultiPoint":return null;case"LineString":return w<0&&(w=T.length+w-1),n.lineString.call(void 0,[T[w],T[w+1]],S,g);case"Polygon":return x<0&&(x=T.length+x),w<0&&(w=T[x].length+w-1),n.lineString.call(void 0,[T[x][w],T[x][w+1]],S,g);case"MultiLineString":return b<0&&(b=T.length+b),w<0&&(w=T[b].length+w-1),n.lineString.call(void 0,[T[b][w],T[b][w+1]],S,g);case"MultiPolygon":return b<0&&(b=T.length+b),x<0&&(x=T[b].length+x),w<0&&(w=T[b][x].length-w-1),n.lineString.call(void 0,[T[b][x][w],T[b][x][w+1]],S,g)}throw new Error("geojson is invalid")}function E(m,g){if(g=g||{},!n.isObject.call(void 0,g))throw new Error("options is invalid");var y=g.featureIndex||0,b=g.multiFeatureIndex||0,x=g.geometryIndex||0,w=g.coordIndex||0,S=g.properties,I;switch(m.type){case"FeatureCollection":y<0&&(y=m.features.length+y),S=S||m.features[y].properties,I=m.features[y].geometry;break;case"Feature":S=S||m.properties,I=m.geometry;break;case"Point":case"MultiPoint":return null;case"LineString":case"Polygon":case"MultiLineString":case"MultiPolygon":I=m;break;default:throw new Error("geojson is invalid")}if(I===null)return null;var T=I.coordinates;switch(I.type){case"Point":return n.point.call(void 0,T,S,g);case"MultiPoint":return b<0&&(b=T.length+b),n.point.call(void 0,T[b],S,g);case"LineString":return w<0&&(w=T.length+w),n.point.call(void 0,T[w],S,g);case"Polygon":return x<0&&(x=T.length+x),w<0&&(w=T[x].length+w),n.point.call(void 0,T[x][w],S,g);case"MultiLineString":return b<0&&(b=T.length+b),w<0&&(w=T[b].length+w),n.point.call(void 0,T[b][w],S,g);case"MultiPolygon":return b<0&&(b=T.length+b),x<0&&(x=T[b].length+x),w<0&&(w=T[b][x].length-w),n.point.call(void 0,T[b][x][w],S,g)}throw new Error("geojson is invalid")}return Te.coordAll=a,Te.coordEach=t,Te.coordReduce=e,Te.featureEach=s,Te.featureReduce=o,Te.findPoint=E,Te.findSegment=v,Te.flattenEach=u,Te.flattenReduce=h,Te.geomEach=l,Te.geomReduce=c,Te.lineEach=p,Te.lineReduce=_,Te.propEach=r,Te.propReduce=i,Te.segmentEach=f,Te.segmentReduce=d,Te}var Pv;function FB(){if(Pv)return sl;Pv=1,Object.defineProperty(sl,"__esModule",{value:!0});var n=kB();function t(r,i={}){if(r.bbox!=null&&i.recompute!==!0)return r.bbox;const s=[1/0,1/0,-1/0,-1/0];return n.coordEach.call(void 0,r,o=>{s[0]>o[0]&&(s[0]=o[0]),s[1]>o[1]&&(s[1]=o[1]),s[2]<o[0]&&(s[2]=o[0]),s[3]<o[1]&&(s[3]=o[1])}),s}var e=t;return sl.bbox=t,sl.default=e,sl}var Iv;function BB(){if(Iv)return Kc.exports;Iv=1;var n=OB(),t=tw(),e=DB(),r=FB().default,i=e.featureEach;e.coordEach,t.polygon;var s=t.featureCollection;function o(a){var l=new n(a);return l.insert=function(c){if(c.type!=="Feature")throw new Error("invalid feature");return c.bbox=c.bbox?c.bbox:r(c),n.prototype.insert.call(this,c)},l.load=function(c){var u=[];return Array.isArray(c)?c.forEach(function(h){if(h.type!=="Feature")throw new Error("invalid features");h.bbox=h.bbox?h.bbox:r(h),u.push(h)}):i(c,function(h){if(h.type!=="Feature")throw new Error("invalid features");h.bbox=h.bbox?h.bbox:r(h),u.push(h)}),n.prototype.load.call(this,u)},l.remove=function(c,u){if(c.type!=="Feature")throw new Error("invalid feature");return c.bbox=c.bbox?c.bbox:r(c),n.prototype.remove.call(this,c,u)},l.clear=function(){return n.prototype.clear.call(this)},l.search=function(c){var u=n.prototype.search.call(this,this.toBBox(c));return s(u)},l.collides=function(c){return n.prototype.collides.call(this,this.toBBox(c))},l.all=function(){var c=n.prototype.all.call(this);return s(c)},l.toJSON=function(){return n.prototype.toJSON.call(this)},l.fromJSON=function(c){return n.prototype.fromJSON.call(this,c)},l.toBBox=function(c){var u;if(c.bbox)u=c.bbox;else if(Array.isArray(c)&&c.length===4)u=c;else if(Array.isArray(c)&&c.length===6)u=[c[0],c[1],c[3],c[4]];else if(c.type==="Feature")u=r(c);else if(c.type==="FeatureCollection")u=r(c);else throw new Error("invalid geojson");return{minX:u[0],minY:u[1],maxX:u[2],maxY:u[3]}},l}return Kc.exports=o,Kc.exports.default=o,Kc.exports}var UB=BB();const VB=_h(UB);function Gh(n,t){var e={},r=[];if(n.type==="LineString"&&(n=Pr(n)),t.type==="LineString"&&(t=Pr(t)),n.type==="Feature"&&t.type==="Feature"&&n.geometry!==null&&t.geometry!==null&&n.geometry.type==="LineString"&&t.geometry.type==="LineString"&&n.geometry.coordinates.length===2&&t.geometry.coordinates.length===2){var i=Av(n,t);return i&&r.push(i),Ir(r)}var s=VB();return s.load(xv(t)),ho(xv(n),function(o){ho(s.search(o),function(a){var l=Av(o,a);if(l){var c=An(l).join(",");e[c]||(e[c]=!0,r.push(l))}})}),Ir(r)}function Av(n,t){var e=An(n),r=An(t);if(e.length!==2)throw new Error("<intersects> line1 must only contain 2 coordinates");if(r.length!==2)throw new Error("<intersects> line2 must only contain 2 coordinates");var i=e[0][0],s=e[0][1],o=e[1][0],a=e[1][1],l=r[0][0],c=r[0][1],u=r[1][0],h=r[1][1],f=(h-c)*(o-i)-(u-l)*(a-s),d=(u-l)*(s-c)-(h-c)*(i-l),p=(o-i)*(s-c)-(a-s)*(i-l);if(f===0)return null;var _=d/f,v=p/f;if(_>=0&&_<=1&&v>=0&&v<=1){var E=i+_*(o-i),m=s+_*(a-s);return wt([E,m])}return null}function Mv(n,t,e){e===void 0&&(e={});var r=wt([1/0,1/0],{dist:1/0}),i=0;return Rh(n,function(s){for(var o=An(s),a=0;a<o.length-1;a++){var l=wt(o[a]);l.properties.dist=Zt(t,l,e);var c=wt(o[a+1]);c.properties.dist=Zt(t,c,e);var u=Zt(l,c,e),h=Math.max(l.properties.dist,c.properties.dist),f=cr(l,c),d=is(t,h,f+90,e),p=is(t,h,f-90,e),_=Gh(Nn([d.geometry.coordinates,p.geometry.coordinates]),Nn([l.geometry.coordinates,c.geometry.coordinates])),v=null;_.features.length>0&&(v=_.features[0],v.properties.dist=Zt(t,v,e),v.properties.location=i+Zt(l,v,e)),l.properties.dist<r.properties.dist&&(r=l,r.properties.index=a,r.properties.location=i),c.properties.dist<r.properties.dist&&(r=c,r.properties.index=a+1,r.properties.location=i+u),v&&v.properties.dist<r.properties.dist&&(r=v,r.properties.index=a),i+=u}}),r}class zB extends Un{calculateMapCoords(t,e,r){const i=r.modeConfig;if(!i||!i.lock90Degree||!t.length)return e;if(t.length===1){const l=t[0],c=this.getSelectedGeometry(r),u=bB(c),h=u.type==="FeatureCollection"?u.features:[u];let f=Number.MAX_SAFE_INTEGER,d=null;if(h.forEach(p=>{const _=Mv(p,l),v=Zt(_,l);f>v&&(f=v,d=_)}),d){const p=cr(l,d),_=Zt(l,e,{units:"meters"});return is(l,_,p,{units:"meters"}).geometry.coordinates}return e}const s=t[t.length-1],[o]=Zl(t[t.length-2],s,e);return Mv(Nn([s,o]),e).geometry.coordinates}getGuides(t){const e=this.getClickSequence(),r={type:"FeatureCollection",features:[]};if(e.length===0||!t.lastPointerMoveEvent)return r;const{mapCoords:i}=t.lastPointerMoveEvent;return r.features.push({type:"Feature",properties:{guideType:"tentative"},geometry:{type:"LineString",coordinates:[...e,this.calculateMapCoords(e,i,t)]}}),r}handleClick(t,e){const r=this.getTentativeGuide(e),i=this.getSelectedGeometry(e);if(!i){console.warn("A polygon must be selected for splitting");return}const s=this.getClickSequence();r&&r.geometry.type==="LineString"?s.push(r.geometry.coordinates[r.geometry.coordinates.length-1]):this.addClickSequence(t);const o={type:"Point",coordinates:s[s.length-1]},a=PB(o,i);if(s.length>1&&r&&!a){if(this.resetClickSequence(),Gh(r,i).features.length===0)return;const c=this.splitPolygon(r,e);c&&e.onEdit(c)}}handlePointerMove(t,e){e.onUpdateCursor("cell")}splitPolygon(t,e){const r=this.getSelectedGeometry(e),i=e.selectedIndexes[0],s=e.modeConfig||{};let{gap:o=.1,units:a="centimeters"}=s;o===0&&(o=.1,a="centimeters");const l=jk(t,o,{units:a}),c=FE(r,l);if(!c)return console.warn("Canceling edit. Split Polygon erased"),null;const{type:u,coordinates:h}=c.geometry;let f=[];return u==="Polygon"?f=h.map(_=>[_]):f=h.reduce((_,v)=>(v.forEach(E=>{_.push([E])}),_),[]),{updatedData:new Ve(e.data).replaceGeometry(i,{type:"MultiPolygon",coordinates:f}).getObject(),editType:"split",editContext:{featureIndexes:[i]}}}}class WB extends Mg{isPointAdded=!1;handleDragging(t,e){const r=Ur(t.pointerDownPicks);if(r){const{featureIndex:i}=r.properties;let{positionIndexes:s}=r.properties;const o=this.coordinatesSize(s,i,e.data);s=this.isPointAdded?this.nextPositionIndexes(s,o):s;const a=this.getPointForPositionIndexes(this.prevPositionIndexes(s,o),i,e.data),l=this.getPointForPositionIndexes(s,i,e.data);if(a&&l){const[c,u]=Zl(a,l,t.mapCoords),h=new Ve(e.data).replacePosition(i,this.prevPositionIndexes(s,o),u).replacePosition(i,s,c).getObject();e.onEdit({updatedData:h,editType:"extruding",editContext:{featureIndexes:[i],positionIndexes:this.nextPositionIndexes(s,o),position:c}}),t.cancelPan()}}}handleStartDragging(t,e){GE(t)&&t.cancelPan();const r=e.selectedIndexes,i=ip(t.picks);if(r.length&&i){const{positionIndexes:s,featureIndex:o}=i.properties,a=this.coordinatesSize(s,o,e.data),l=this.getPointForPositionIndexes(this.prevPositionIndexes(s,a),o,e.data),c=this.getPointForPositionIndexes(s,o,e.data);if(l&&c){let u=new Ve(e.data);this.isOrthogonal(s,o,a,e.data)||(u=u.addPosition(o,s,c)),this.isOrthogonal(this.prevPositionIndexes(s,a),o,a,e.data)||(u=u.addPosition(o,s,l),this.isPointAdded=!0),e.onEdit({updatedData:u.getObject(),editType:"startExtruding",editContext:{featureIndexes:[o],positionIndexes:s,position:l}})}}}handleStopDragging(t,e){const r=e.selectedIndexes,i=Ur(t.pointerDownPicks);if(r.length&&i){const{featureIndex:s}=i.properties;let{positionIndexes:o}=i.properties;const a=this.coordinatesSize(o,s,e.data);o=this.isPointAdded?this.nextPositionIndexes(o,a):o;const l=this.getPointForPositionIndexes(this.prevPositionIndexes(o,a),s,e.data),c=this.getPointForPositionIndexes(o,s,e.data);if(l&&c){const[u,h]=Zl(l,c,t.mapCoords),f=new Ve(e.data).replacePosition(s,this.prevPositionIndexes(o,a),h).replacePosition(s,o,u).getObject();e.onEdit({updatedData:f,editType:"extruded",editContext:{featureIndexes:[s],positionIndexes:o,position:u}})}}this.isPointAdded=!1}coordinatesSize(t,e,{features:r}){let i=0;if(Array.isArray(t)){const o=r[e].geometry.coordinates;if(t.length===3){const[a,l]=t;o.length&&o[a].length&&(i=o[a][l].length)}else{const[a]=t;o.length&&o[a].length&&(i=o[a].length)}}return i}getBearing(t,e){const r=cr(t,e);return r<0?Math.floor(360+r):Math.floor(r)}isOrthogonal(t,e,r,i){if(!Array.isArray(t))return!1;t[t.length-1]===r-1&&(t[t.length-1]=0);const s=this.getPointForPositionIndexes(this.prevPositionIndexes(t,r),e,i),o=this.getPointForPositionIndexes(this.nextPositionIndexes(t,r),e,i),a=this.getPointForPositionIndexes(t,e,i),l=this.getBearing(a,s),c=this.getBearing(a,o);return[89,90,91,269,270,271].includes(Math.abs(l-c))}nextPositionIndexes(t,e){if(!Array.isArray(t))return[];const r=[...t];return r.length&&(r[r.length-1]=r[r.length-1]===e-1?0:r[r.length-1]+1),r}prevPositionIndexes(t,e){if(!Array.isArray(t))return[];const r=[...t];return r.length&&(r[r.length-1]=r[r.length-1]===0?e-2:r[r.length-1]-1),r}getPointForPositionIndexes(t,e,{features:r}){let i;if(Array.isArray(t)){const o=r[e].geometry.coordinates;if(t.length===3){const[a,l,c]=t;o.length&&o[a].length&&(i=o[a][l][c])}else{const[a,l]=t;o.length&&o[a].length&&(i=o[a][l])}}return i}}function HB({pointerDownScreenCoords:n,screenCoords:t}){return 10*(n[1]-t[1])}class jB extends Mg{makeElevatedEvent(t,e,r){const{minElevation:i=0,maxElevation:s=2e4,calculateElevationChange:o=HB}=r.modeConfig||{};if(!t.pointerDownScreenCoords)return t;let a=e.length===3?e[2]:0;return a+=o({pointerDownScreenCoords:t.pointerDownScreenCoords,screenCoords:t.screenCoords}),a=Math.min(a,s),a=Math.max(a,i),Object.assign({},t,{mapCoords:[e[0],e[1],a]})}handlePointerMove(t,e){const r=Ur(t.pointerDownPicks),i=r?r.geometry.coordinates:t.mapCoords;super.handlePointerMove(this.makeElevatedEvent(t,i,e),e)}handleStopDragging(t,e){const r=Ur(t.picks),i=r?r.geometry.coordinates:t.mapCoords;super.handleStopDragging(this.makeElevatedEvent(t,i,e),e)}getCursor(t){let e=super.getCursor(t);return e==="cell"&&(e="ns-resize"),e}static calculateElevationChangeWithViewport(t,{pointerDownScreenCoords:e,screenCoords:r}){return 156543.03392*Math.cos(t.latitude*Math.PI/180)/Math.pow(2,t.zoom)*(e[1]-r[1])/2}}class $B extends Un{createTentativeFeature(t){const{lastPointerMoveEvent:e}=t,r=e?[e.mapCoords]:[];return{type:"Feature",properties:{guideType:"tentative"},geometry:{type:"Point",coordinates:r[0]}}}handleClick({mapCoords:t},e){const r={type:"Point",coordinates:t};e.onEdit(this.getAddFeatureAction(r,e.data))}handlePointerMove(t,e){e.onUpdateCursor("cell"),super.handlePointerMove(t,e)}}function XB(n,t){if(n===t)return!0;if(Array.isArray(n)){const e=n.length;if(!t||t.length!==e)return!1;for(let r=0;r<e;r++)if(n[r]!==t[r])return!1;return!0}return!1}function Ng(n){let t={},e;return r=>{for(const i in r)if(!XB(r[i],t[i])){e=n(r),t=r;break}return e}}class GB extends Un{dist=0;position=null;elems=[];handleClick(t,e){const{picks:r}=t,i=Ur(r);let s=!1;i||(this.addClickSequence(t),s=!0);const o=this.getClickSequence();if(i||this.calculateInfoDraw(o),o.length>1&&i&&Array.isArray(i.properties.positionIndexes)&&i.properties.positionIndexes[0]===o.length-1){this.dist=0;const a={type:"LineString",coordinates:[...o]};this.resetClickSequence();const l=this.getAddFeatureAction(a,e.data);l&&e.onEdit(l)}else s&&e.onEdit({updatedData:e.data,editType:"addTentativePosition",editContext:{position:t.mapCoords}})}handleKeyUp(t,e){const{key:r}=t;if(r==="Enter"){const i=this.getClickSequence();if(i.length>1){const s={type:"LineString",coordinates:[...i]};this.resetClickSequence();const o=this.getAddFeatureAction(s,e.data);o&&e.onEdit(o)}}else r==="Escape"&&(this.resetClickSequence(),e.onEdit({updatedData:e.data,editType:"cancelFeature",editContext:{}}))}getGuides(t){const{lastPointerMoveEvent:e}=t,r=this.getClickSequence(),i=e?[e.mapCoords]:[],s={type:"FeatureCollection",features:[]};let o;r.length>0&&(o={type:"Feature",properties:{guideType:"tentative"},geometry:{type:"LineString",coordinates:[...r,...i]}}),o&&s.features.push(o);const a=r.map((l,c)=>({type:"Feature",properties:{guideType:"editHandle",editHandleType:"existing",featureIndex:-1,positionIndexes:[c]},geometry:{type:"Point",coordinates:l}}));return s.features.push(...a),s}handlePointerMove(t,e){e.onUpdateCursor("cell")}getTooltips(t){return this._getTooltips({modeConfig:t.modeConfig,dist:this.dist})}calculateInfoDraw(t){t.length>1&&(this.position=t[t.length-1],this.dist+=Zt(t[t.length-2],t[t.length-1]))}_getTooltips=Ng(({modeConfig:t,dist:e})=>{let r=[];const{formatTooltip:i}=t||{};let s;return e&&(i?s=i(e):s=`Distance: ${parseFloat(e).toFixed(2)} kilometers`,r=[{position:this.position,text:s}]),r})}class Yh extends Un{createTentativeFeature(t){const{lastPointerMoveEvent:e}=t,r=this.getClickSequence(),i=e?[e.mapCoords]:[];let s;return r.length===1||r.length===2?s={type:"Feature",properties:{guideType:"tentative"},geometry:{type:"LineString",coordinates:[...r,...i]}}:r.length>2&&(s={type:"Feature",properties:{guideType:"tentative"},geometry:{type:"Polygon",coordinates:[[...r,...i,r[0]]]}}),s}getGuides(t){const e=this.getClickSequence(),r={type:"FeatureCollection",features:[]},i=this.createTentativeFeature(t);i&&r.features.push(i);const s=e.map((o,a)=>({type:"Feature",properties:{guideType:"editHandle",editHandleType:"existing",featureIndex:-1,positionIndexes:[a]},geometry:{type:"Point",coordinates:o}}));return r.features.push(...s),r}handleClick(t,e){const{picks:r}=t,i=Ur(r),s=this.getClickSequence();let o=!1;if(s.length>2&&e.modeConfig&&e.modeConfig.preventOverlappingLines){const l=Nn([s[s.length-1],t.mapCoords]),c=Nn([...s.slice(0,s.length-1)]);Gh(l,c).features.length>0&&(o=!0)}let a=!1;if(!i&&!o&&(this.addClickSequence(t),a=!0),s.length>2&&i&&Array.isArray(i.properties.positionIndexes)&&(i.properties.positionIndexes[0]===0||i.properties.positionIndexes[0]===s.length-1)){const l={type:"Polygon",coordinates:[[...s,s[0]]]};this.resetClickSequence();const c=this.getAddFeatureOrBooleanPolygonAction(l,e);c&&e.onEdit(c)}else a&&e.onEdit({updatedData:e.data,editType:"addTentativePosition",editContext:{position:t.mapCoords}})}handleKeyUp(t,e){if(t.key==="Enter"){const r=this.getClickSequence();if(r.length>2){const i={type:"Polygon",coordinates:[[...r,r[0]]]};this.resetClickSequence();const s=this.getAddFeatureOrBooleanPolygonAction(i,e);s&&e.onEdit(s)}}else t.key==="Escape"&&(this.resetClickSequence(),e.onEdit({updatedData:e.data,editType:"cancelFeature",editContext:{}}))}handlePointerMove(t,e){e.onUpdateCursor("cell"),super.handlePointerMove(t,e)}}var Zf,Rv;function YB(){if(Rv)return Zf;Rv=1;var n=200,t="__lodash_hash_undefined__",e=9007199254740991,r="[object Arguments]",i="[object Function]",s="[object GeneratorFunction]",o="[object Symbol]",a=/[\\^$.*+?()[\]{}|]/g,l=/^\[object .+?Constructor\]$/,c=/^(?:0|[1-9]\d*)$/,u=typeof ps=="object"&&ps&&ps.Object===Object&&ps,h=typeof self=="object"&&self&&self.Object===Object&&self,f=u||h||Function("return this")();function d(k,q,nt){switch(nt.length){case 0:return k.call(q);case 1:return k.call(q,nt[0]);case 2:return k.call(q,nt[0],nt[1]);case 3:return k.call(q,nt[0],nt[1],nt[2])}return k.apply(q,nt)}function p(k,q){var nt=k?k.length:0;return!!nt&&m(k,q,0)>-1}function _(k,q){for(var nt=-1,ft=k?k.length:0,te=Array(ft);++nt<ft;)te[nt]=q(k[nt],nt,k);return te}function v(k,q){for(var nt=-1,ft=q.length,te=k.length;++nt<ft;)k[te+nt]=q[nt];return k}function E(k,q,nt,ft){for(var te=k.length,we=nt+-1;++we<te;)if(q(k[we],we,k))return we;return-1}function m(k,q,nt){if(q!==q)return E(k,g,nt);for(var ft=nt-1,te=k.length;++ft<te;)if(k[ft]===q)return ft;return-1}function g(k){return k!==k}function y(k,q){for(var nt=-1,ft=Array(k);++nt<k;)ft[nt]=q(nt);return ft}function b(k,q){return k.has(q)}function x(k,q){return k?.[q]}function w(k){var q=!1;if(k!=null&&typeof k.toString!="function")try{q=!!(k+"")}catch{}return q}function S(k,q){return function(nt){return k(q(nt))}}var I=Array.prototype,T=Function.prototype,M=Object.prototype,L=f["__core-js_shared__"],O=function(){var k=/[^.]+$/.exec(L&&L.keys&&L.keys.IE_PROTO||"");return k?"Symbol(src)_1."+k:""}(),P=T.toString,V=M.hasOwnProperty,C=M.toString,R=RegExp("^"+P.call(V).replace(a,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),D=f.Symbol,H=S(Object.getPrototypeOf,Object),K=M.propertyIsEnumerable,G=I.splice,Y=D?D.isConcatSpreadable:void 0,J=Object.getOwnPropertySymbols,ut=Math.max,at=Lg(f,"Map"),Ft=Lg(Object,"create");function Et(k){var q=-1,nt=k?k.length:0;for(this.clear();++q<nt;){var ft=k[q];this.set(ft[0],ft[1])}}function ht(){this.__data__=Ft?Ft(null):{}}function Gt(k){return this.has(k)&&delete this.__data__[k]}function Rt(k){var q=this.__data__;if(Ft){var nt=q[k];return nt===t?void 0:nt}return V.call(q,k)?q[k]:void 0}function ui(k){var q=this.__data__;return Ft?q[k]!==void 0:V.call(q,k)}function $s(k,q){var nt=this.__data__;return nt[k]=Ft&&q===void 0?t:q,this}Et.prototype.clear=ht,Et.prototype.delete=Gt,Et.prototype.get=Rt,Et.prototype.has=ui,Et.prototype.set=$s;function Bi(k){var q=-1,nt=k?k.length:0;for(this.clear();++q<nt;){var ft=k[q];this.set(ft[0],ft[1])}}function vc(){this.__data__=[]}function Dt(k){var q=this.__data__,nt=xc(q,k);if(nt<0)return!1;var ft=q.length-1;return nt==ft?q.pop():G.call(q,nt,1),!0}function Lt(k){var q=this.__data__,nt=xc(q,k);return nt<0?void 0:q[nt][1]}function vw(k){return xc(this.__data__,k)>-1}function bw(k,q){var nt=this.__data__,ft=xc(nt,k);return ft<0?nt.push([k,q]):nt[ft][1]=q,this}Bi.prototype.clear=vc,Bi.prototype.delete=Dt,Bi.prototype.get=Lt,Bi.prototype.has=vw,Bi.prototype.set=bw;function Fo(k){var q=-1,nt=k?k.length:0;for(this.clear();++q<nt;){var ft=k[q];this.set(ft[0],ft[1])}}function xw(){this.__data__={hash:new Et,map:new(at||Bi),string:new Et}}function Ew(k){return Ec(this,k).delete(k)}function ww(k){return Ec(this,k).get(k)}function Sw(k){return Ec(this,k).has(k)}function Cw(k,q){return Ec(this,k).set(k,q),this}Fo.prototype.clear=xw,Fo.prototype.delete=Ew,Fo.prototype.get=ww,Fo.prototype.has=Sw,Fo.prototype.set=Cw;function bc(k){var q=-1,nt=k?k.length:0;for(this.__data__=new Fo;++q<nt;)this.add(k[q])}function Tw(k){return this.__data__.set(k,t),this}function Pw(k){return this.__data__.has(k)}bc.prototype.add=bc.prototype.push=Tw,bc.prototype.has=Pw;function Iw(k,q){var nt=qh(k)||kg(k)?y(k.length,String):[],ft=nt.length,te=!!ft;for(var we in k)te&&(we=="length"||zw(we,ft))||nt.push(we);return nt}function xc(k,q){for(var nt=k.length;nt--;)if(Yw(k[nt][0],q))return nt;return-1}function Aw(k,q,nt,ft){var te=-1,we=p,dr=!0,Ui=k.length,wc=[],t1=q.length;if(!Ui)return wc;q.length>=n&&(we=b,dr=!1,q=new bc(q));t:for(;++te<Ui;){var Bo=k[te],Sc=Bo;if(Bo=Bo!==0?Bo:0,dr&&Sc===Sc){for(var zg=t1;zg--;)if(q[zg]===Sc)continue t;wc.push(Bo)}else we(q,Sc,ft)||wc.push(Bo)}return wc}function Mw(k,q,nt,ft,te){var we=-1,dr=k.length;for(nt||(nt=Vw),te||(te=[]);++we<dr;){var Ui=k[we];nt(Ui)?v(te,Ui):te[te.length]=Ui}return te}function Rw(k,q,nt){var ft=q(k);return qh(k)?ft:v(ft,nt(k))}function Nw(k){if(!Kh(k)||Hw(k))return!1;var q=Bg(k)||w(k)?R:l;return q.test(Gw(k))}function Ow(k){if(!Kh(k))return $w(k);var q=jw(k),nt=[];for(var ft in k)ft=="constructor"&&(q||!V.call(k,ft))||nt.push(ft);return nt}function Dw(k,q){return k=Object(k),Lw(k,q,function(nt,ft){return ft in k})}function Lw(k,q,nt){for(var ft=-1,te=q.length,we={};++ft<te;){var dr=q[ft],Ui=k[dr];nt(Ui,dr)&&(we[dr]=Ui)}return we}function kw(k,q){return q=ut(q===void 0?k.length-1:q,0),function(){for(var nt=arguments,ft=-1,te=ut(nt.length-q,0),we=Array(te);++ft<te;)we[ft]=nt[q+ft];ft=-1;for(var dr=Array(q+1);++ft<q;)dr[ft]=nt[ft];return dr[q]=we,d(k,this,dr)}}function Fw(k){return Rw(k,Jw,Uw)}function Ec(k,q){var nt=k.__data__;return Ww(q)?nt[typeof q=="string"?"string":"hash"]:nt.map}function Lg(k,q){var nt=x(k,q);return Nw(nt)?nt:void 0}var Bw=J?S(J,Object):Vg,Uw=J?function(k){for(var q=[];k;)v(q,Bw(k)),k=H(k);return q}:Vg;function Vw(k){return qh(k)||kg(k)||!!(Y&&k&&k[Y])}function zw(k,q){return q=q??e,!!q&&(typeof k=="number"||c.test(k))&&k>-1&&k%1==0&&k<q}function Ww(k){var q=typeof k;return q=="string"||q=="number"||q=="symbol"||q=="boolean"?k!=="__proto__":k===null}function Hw(k){return!!O&&O in k}function jw(k){var q=k&&k.constructor,nt=typeof q=="function"&&q.prototype||M;return k===nt}function $w(k){var q=[];if(k!=null)for(var nt in Object(k))q.push(nt);return q}function Xw(k){if(typeof k=="string"||Zw(k))return k;var q=k+"";return q=="0"&&1/k==-1/0?"-0":q}function Gw(k){if(k!=null){try{return P.call(k)}catch{}try{return k+""}catch{}}return""}function Yw(k,q){return k===q||k!==k&&q!==q}function kg(k){return qw(k)&&V.call(k,"callee")&&(!K.call(k,"callee")||C.call(k)==r)}var qh=Array.isArray;function Fg(k){return k!=null&&Kw(k.length)&&!Bg(k)}function qw(k){return Ug(k)&&Fg(k)}function Bg(k){var q=Kh(k)?C.call(k):"";return q==i||q==s}function Kw(k){return typeof k=="number"&&k>-1&&k%1==0&&k<=e}function Kh(k){var q=typeof k;return!!k&&(q=="object"||q=="function")}function Ug(k){return!!k&&typeof k=="object"}function Zw(k){return typeof k=="symbol"||Ug(k)&&C.call(k)==o}function Jw(k){return Fg(k)?Iw(k):Ow(k)}var Qw=kw(function(k,q){return k==null?{}:(q=_(Mw(q),Xw),Dw(k,Aw(Fw(k),q)))});function Vg(){return[]}return Zf=Qw,Zf}var qB=YB();const ew=_h(qB);class ko extends Un{handleClick(t,e){e.modeConfig&&e.modeConfig.dragToDraw||(this.addClickSequence(t),this.checkAndFinishPolygon(e))}handleStartDragging(t,e){!e.modeConfig||!e.modeConfig.dragToDraw||(this.addClickSequence(t),t.cancelPan())}handleStopDragging(t,e){!e.modeConfig||!e.modeConfig.dragToDraw||(this.addClickSequence(t),this.checkAndFinishPolygon(e))}checkAndFinishPolygon(t){const e=this.getClickSequence(),r=this.getTentativeGuide(t);if(e.length>1&&r&&r.geometry.type==="Polygon"){const i={type:"Feature",properties:ew(r.properties,"guideType"),geometry:{type:"Polygon",coordinates:r.geometry.coordinates}},s=this.getAddFeatureOrBooleanPolygonAction(i,t);this.resetClickSequence(),s&&t.onEdit(s)}}getGuides(t){const{lastPointerMoveEvent:e,modeConfig:r}=t,i=this.getClickSequence(),s={type:"FeatureCollection",features:[]};if(i.length===0||!e)return s;const o=i[0],a=e.mapCoords,l=this.getTwoClickPolygon(o,a,r);return l&&s.features.push({type:"Feature",properties:{...l.properties,guideType:"tentative"},geometry:l.geometry}),s}getTwoClickPolygon(t,e,r){return null}handlePointerMove(t,e){e.onUpdateCursor("cell"),super.handlePointerMove(t,e)}createTentativeFeature(t){const{lastPointerMoveEvent:e}=t,r=this.getClickSequence(),i=e?[e.mapCoords]:[];let s;return r.length===1&&(s=this.getTwoClickPolygon(r[0],i[0],t.modeConfig)),s}}class KB extends ko{getTwoClickPolygon(t,e,r){const i=Ao([t[0],t[1],e[0],e[1]]);return i.properties=i.properties||{},i.properties.shape="Rectangle",i}}function nw(n,t,e){e===void 0&&(e={});for(var r=lr(n),i=r.coordinates,s=0,o=0;o<i.length&&!(t>=s&&o===i.length-1);o++)if(s>=t){var a=t-s;if(a){var l=cr(i[o],i[o-1])-180,c=is(i[o],a,l,e);return c}else return wt(i[o])}else s+=Zt(i[o],i[o+1],e);return wt(i[i.length-1])}class ZB extends ko{getTwoClickPolygon(t,e,r){const i=[e[0],t[1]],s=[t[0],e[1]],o=Zt(wt(i),wt(t)),a=Zt(wt(s),wt(t)),l=o<=a?o:a,c=o<=a?i:s,u=Nn([c,e]),f=nw(u,l).geometry.coordinates,d=Ao([t[0],t[1],f[0],f[1]]);return d.properties=d.properties||{},d.properties.shape="Square",d}}class JB extends ko{getTwoClickPolygon(t,e,r){const i=t[0]>e[0]?t[0]+Math.abs(t[0]-e[0]):t[0]-Math.abs(t[0]-e[0]),s=t[1]>e[1]?t[1]+Math.abs(t[1]-e[1]):t[1]-Math.abs(t[1]-e[1]),o=Ao([i,s,e[0],e[1]]);return o.properties=o.properties||{},o.properties.shape="Rectangle",o}}class QB extends ko{getTwoClickPolygon(t,e,r){const i=[e[0],t[1]],s=[t[0],e[1]],o=Zt(wt(i),wt(t)),a=Zt(wt(s),wt(t)),l=o<=a?o:a,c=o<=a?i:s,u=Nn([c,e]),f=nw(u,l).geometry.coordinates,d=t[0]>f[0]?t[0]+Math.abs(t[0]-f[0]):t[0]-Math.abs(t[0]-f[0]),p=t[1]>f[1]?t[1]+Math.abs(t[1]-f[1]):t[1]-Math.abs(t[1]-f[1]),_=Ao([d,p,f[0],f[1]]);return _.properties=_.properties||{},_.properties.shape="Square",_}}function rw(n,t,e){e===void 0&&(e={});for(var r=e.steps||64,i=e.properties?e.properties:!Array.isArray(n)&&n.type==="Feature"&&n.properties?n.properties:{},s=[],o=0;o<r;o++)s.push(is(n,t,o*-360/r,e).geometry.coordinates);return s.push(s[0]),uo([s],i)}var Nv=6378137;function iw(n){return tk(n,function(t,e){return t+t4(e)},0)}function t4(n){var t=0,e;switch(n.type){case"Polygon":return Ov(n.coordinates);case"MultiPolygon":for(e=0;e<n.coordinates.length;e++)t+=Ov(n.coordinates[e]);return t;case"Point":case"MultiPoint":case"LineString":case"MultiLineString":return 0}return 0}function Ov(n){var t=0;if(n&&n.length>0){t+=Math.abs(Dv(n[0]));for(var e=1;e<n.length;e++)t-=Math.abs(Dv(n[e]))}return t}function Dv(n){var t,e,r,i,s,o,a,l=0,c=n.length;if(c>2){for(a=0;a<c;a++)a===c-2?(i=c-2,s=c-1,o=0):a===c-1?(i=c-1,s=0,o=1):(i=a,s=a+1,o=a+2),t=n[i],e=n[s],r=n[o],l+=(Jf(r[0])-Jf(t[0]))*Math.sin(Jf(e[1]));l=l*Nv*Nv/2}return l}function Jf(n){return n*Math.PI/180}class e4 extends ko{radius=null;position=null;areaCircle=null;getTwoClickPolygon(t,e,r){const{steps:i=64}=r||{},s={steps:i};this.position=e,i<4&&(console.warn("Minimum steps to draw a circle is 4 "),s.steps=4),this.radius=Math.max(Zt(t,e),.001);const o=rw(t,this.radius,s);return o.properties=o.properties||{},o.properties.shape="Circle",o.properties.editProperties=o.properties.editProperties||{},o.properties.editProperties.shape="Circle",o.properties.editProperties.radius={value:this.radius,unit:"kilometers"},o.properties.editProperties.center=t,this.areaCircle=iw(o),o}getTooltips(t){return this._getTooltips({modeConfig:t?.modeConfig,radius:this.radius,areaCircle:this.areaCircle})}_getTooltips=Ng(({modeConfig:t,radius:e,areaCircle:r})=>{let i=[];const{formatTooltip:s}=t||{};let o;return e&&r&&(s?o=s(e):o=`Radius: ${parseFloat(e).toFixed(2)} kilometers
      
 Area: ${parseFloat(r).toFixed(2)}`,i=[{position:this.position,text:o}]),i})}class n4 extends ko{radius=null;position=null;areaCircle=null;diameter=null;getTwoClickPolygon(t,e,r){const{steps:i=64}=r||{},s={steps:i};i<4&&(console.warn("Minimum steps to draw a circle is 4 "),s.steps=4);const o=Xh(t,e);this.radius=Math.max(Zt(t,o),.001),this.diameter=Math.max(Zt(t,e),.001),this.position=o;const a=rw(o,this.radius,s);return a.properties=a.properties||{},a.properties.shape="Circle",a.properties.editProperties=a.properties.editProperties||{},a.properties.editProperties.shape="Circle",a.properties.editProperties.radius={value:this.radius,unit:"kilometers"},a.properties.editProperties.center=o,this.areaCircle=iw(a),a}getTooltips(t){return this._getTooltips({modeConfig:t.modeConfig,radius:this.radius,areaCircle:this.areaCircle,diameter:this.diameter})}_getTooltips=Ng(({modeConfig:t,radius:e,areaCircle:r,diameter:i})=>{let s=[];const{formatTooltip:o}=t||{};let a;return e&&r&&(o?a=o(e):a=`Radius: ${parseFloat(e).toFixed(2)} kilometers
      
 Area: ${parseFloat(r).toFixed(2)}
      
 Diameter: ${parseFloat(i).toFixed(2)} kilometers`,s=[{position:this.position,text:a}]),s})}function sw(n,t,e,r){r=r||{};var i=r.steps||64,s=r.units||"kilometers",o=r.angle||0,a=r.pivot||n,l=r.properties||n.properties||{};if(!n)throw new Error("center is required");if(!t)throw new Error("xSemiAxis is required");if(!e)throw new Error("ySemiAxis is required");if(!Mh(r))throw new Error("options must be an object");if(!Ju(i))throw new Error("steps must be a number");if(!Ju(o))throw new Error("angle must be a number");var c=Ke(n);if(s==="degrees")var u=cn(o);else t=za(n,t,90,{units:s}),e=za(n,e,0,{units:s}),t=Ke(t)[0]-c[0],e=Ke(e)[1]-c[1];for(var h=[],f=0;f<i;f+=1){var d=f*-360/i,p=t*e/Math.sqrt(Math.pow(e,2)+Math.pow(t,2)*Math.pow(Lv(d),2)),_=t*e/Math.sqrt(Math.pow(t,2)+Math.pow(e,2)/Math.pow(Lv(d),2));if(d<-90&&d>=-270&&(p=-p),d<-180&&d>=-360&&(_=-_),s==="degrees"){var v=p*Math.cos(u)+_*Math.sin(u),E=_*Math.cos(u)-p*Math.sin(u);p=v,_=E}h.push([p+c[0],_+c[1]])}return h.push(h[0]),s==="degrees"?uo([h],l):QE(uo([h],l),o,{pivot:a})}function Lv(n){var t=n*Math.PI/180;return Math.tan(t)}class r4 extends ko{getTwoClickPolygon(t,e,r){const i=Math.min(t[0],e[0]),s=Math.min(t[1],e[1]),o=Math.max(t[0],e[0]),a=Math.max(t[1],e[1]),l=Ao([i,s,o,a]).geometry.coordinates[0],c=Xh(t,e),u=Math.max(Zt(wt(l[0]),wt(l[1])),.001),h=Math.max(Zt(wt(l[0]),wt(l[3])),.001),f=sw(c,u,h);return f.properties=f.properties||{},f.properties.editProperties=f.properties.editProperties||{},f.properties.editProperties.shape="Ellipse",f.properties.editProperties.xSemiAxis={value:u,unit:"kilometers"},f.properties.editProperties.ySemiAxis={value:h,unit:"kilometers"},f.properties.editProperties.angle=0,f.properties.editProperties.center=c,f}}class ow extends Un{handleClick(t,e){this.addClickSequence(t);const r=this.getClickSequence(),i=this.getTentativeGuide(e);if(r.length>2&&i&&i.geometry.type==="Polygon"){const s=this.getAddFeatureOrBooleanPolygonAction(i.geometry,e,ew(i.properties,"guideType"));this.resetClickSequence(),s&&e.onEdit(s)}}getGuides(t){const{lastPointerMoveEvent:e,modeConfig:r}=t,i=this.getClickSequence(),s={type:"FeatureCollection",features:[]};if(i.length===0)return s;const o=e.mapCoords;if(i.length===1)s.features.push({type:"Feature",properties:{guideType:"tentative"},geometry:{type:"LineString",coordinates:[i[0],o]}});else{const a=this.getThreeClickPolygon(i[0],i[1],o,r);a&&s.features.push({type:"Feature",properties:{...a.properties,guideType:"tentative"},geometry:a.geometry})}return s}getThreeClickPolygon(t,e,r,i){return null}handlePointerMove(t,e){e.onUpdateCursor("cell"),super.handlePointerMove(t,e)}createTentativeFeature(t){const{lastPointerMoveEvent:e}=t,r=this.getClickSequence(),i=e?[e.mapCoords]:[];let s;return r.length===2&&(s=this.getThreeClickPolygon(r[0],r[1],i[0],t.modeConfig)),s}}class i4 extends ow{getThreeClickPolygon(t,e,r,i){const[s,o]=Zl(t,e,r);return{type:"Feature",properties:{shape:"Rectangle"},geometry:{type:"Polygon",coordinates:[[t,e,s,o,t]]}}}}class s4 extends ow{getThreeClickPolygon(t,e,r,i){const s=Xh(t,e),o=Math.max(Zt(s,wt(r)),.001),a=Math.max(Zt(t,e),.001)/2,l={angle:cr(t,e)},c=sw(s,o,a,l);return c.properties=c.properties||{},c.properties.editProperties=c.properties.editProperties||{},c.properties.editProperties.shape="Ellipse",c.properties.editProperties.xSemiAxis={value:o,unit:"kilometers"},c.properties.editProperties.ySemiAxis={value:a,unit:"kilometers"},c.properties.editProperties.angle=l.angle,c.properties.editProperties.center=s,c}}class o4 extends Un{createTentativeFeature(t){const e=this.getClickSequence(),{mapCoords:r}=t.lastPointerMoveEvent;let i;if(e.length<=1)i=r;else{const o=e[e.length-2],a=e[e.length-1];[i]=Zl(o,a,r)}let s;return e.length<3?s={type:"Feature",properties:{guideType:"tentative"},geometry:{type:"LineString",coordinates:[...e,i]}}:s={type:"Feature",properties:{guideType:"tentative"},geometry:{type:"Polygon",coordinates:[[...e,i,e[0]]]}},s}getGuides(t){const e={type:"FeatureCollection",features:[]};if(this.getClickSequence().length===0||!t.lastPointerMoveEvent)return e;const i=this.createTentativeFeature(t);return e.features.push(i),e.features=e.features.concat(fh(i.geometry,-1)),e.features=e.features.slice(0,-1),e}handlePointerMove(t,e){e.onUpdateCursor("cell"),super.handlePointerMove(t,e)}handleClick(t,e){const{picks:r}=t,i=this.getTentativeGuide(e);this.addClickSequence(t);const s=this.getClickSequence();if(i)if(s.length===3&&i.geometry.type==="LineString"){const o=i.geometry;s[s.length-1]=o.coordinates[o.coordinates.length-1]}else if(s.length>3&&i.geometry.type==="Polygon"){const o=i.geometry;s[s.length-1]=o.coordinates[0][o.coordinates[0].length-2];const a=Ur(r);if(a&&Array.isArray(a.properties.positionIndexes)&&(a.properties.positionIndexes[1]===0||a.properties.positionIndexes[1]===o.coordinates[0].length-3)){const l={type:"Polygon",coordinates:this.finalizedCoordinates([...o.coordinates[0]])};this.resetClickSequence();const c=this.getAddFeatureOrBooleanPolygonAction(l,e);c&&e.onEdit(c)}}else{const o={screenCoords:[-1,-1],mapCoords:t.mapCoords,picks:[],pointerDownPicks:null,pointerDownScreenCoords:null,pointerDownMapCoords:null,cancelPan:()=>{},sourceEvent:null};this.handlePointerMove(o,e)}}finalizedCoordinates(t){let e=[[...t.slice(0,-2),t[0]]],r=this.getIntermediatePoint([...t]);if(r)e=[[...t.slice(0,-2),r,t[0]]];else{const i=[...t];i.splice(-3,1),r=this.getIntermediatePoint([...i]),r&&(e=[[...t.slice(0,-3),r,t[0]]])}return e}getIntermediatePoint(t){let e=null;if(t.length>4){const[r,i]=[...t],s=cr(r,i),o=t[t.length-3],a=t[t.length-4],l=cr(o,a),c={first:[],second:[]};[1,2,3].forEach(h=>{const f=s+h*90;c.first.push(f>180?f-360:f);const d=l+h*90;c.second.push(d>180?d-360:d)});const u=Zt(wt(r),wt(o));[0,1,2].forEach(h=>{const f=Nn([r,is(r,u,c.first[h]).geometry.coordinates]);[0,1,2].forEach(d=>{const p=Nn([o,is(o,u,c.second[d]).geometry.coordinates]),_=Gh(f,p);_&&_.features.length&&(e=_.features[0].geometry.coordinates)})})}return e}}var Qf,kv;function a4(){if(kv)return Qf;kv=1;var n="Expected a function",t=NaN,e="[object Symbol]",r=/^\s+|\s+$/g,i=/^[-+]0x[0-9a-f]+$/i,s=/^0b[01]+$/i,o=/^0o[0-7]+$/i,a=parseInt,l=typeof ps=="object"&&ps&&ps.Object===Object&&ps,c=typeof self=="object"&&self&&self.Object===Object&&self,u=l||c||Function("return this")(),h=Object.prototype,f=h.toString,d=Math.max,p=Math.min,_=function(){return u.Date.now()};function v(x,w,S){var I,T,M,L,O,P,V=0,C=!1,R=!1,D=!0;if(typeof x!="function")throw new TypeError(n);w=b(w)||0,m(S)&&(C=!!S.leading,R="maxWait"in S,M=R?d(b(S.maxWait)||0,w):M,D="trailing"in S?!!S.trailing:D);function H(ht){var Gt=I,Rt=T;return I=T=void 0,V=ht,L=x.apply(Rt,Gt),L}function K(ht){return V=ht,O=setTimeout(J,w),C?H(ht):L}function G(ht){var Gt=ht-P,Rt=ht-V,ui=w-Gt;return R?p(ui,M-Rt):ui}function Y(ht){var Gt=ht-P,Rt=ht-V;return P===void 0||Gt>=w||Gt<0||R&&Rt>=M}function J(){var ht=_();if(Y(ht))return ut(ht);O=setTimeout(J,G(ht))}function ut(ht){return O=void 0,D&&I?H(ht):(I=T=void 0,L)}function at(){O!==void 0&&clearTimeout(O),V=0,I=P=T=O=void 0}function Ft(){return O===void 0?L:ut(_())}function Et(){var ht=_(),Gt=Y(ht);if(I=arguments,T=this,P=ht,Gt){if(O===void 0)return K(P);if(R)return O=setTimeout(J,w),H(P)}return O===void 0&&(O=setTimeout(J,w)),L}return Et.cancel=at,Et.flush=Ft,Et}function E(x,w,S){var I=!0,T=!0;if(typeof x!="function")throw new TypeError(n);return m(S)&&(I="leading"in S?!!S.leading:I,T="trailing"in S?!!S.trailing:T),v(x,w,{leading:I,maxWait:w,trailing:T})}function m(x){var w=typeof x;return!!x&&(w=="object"||w=="function")}function g(x){return!!x&&typeof x=="object"}function y(x){return typeof x=="symbol"||g(x)&&f.call(x)==e}function b(x){if(typeof x=="number")return x;if(y(x))return t;if(m(x)){var w=typeof x.valueOf=="function"?x.valueOf():x;x=m(w)?w+"":w}if(typeof x!="string")return x===0?x:+x;x=x.replace(r,"");var S=s.test(x);return S||o.test(x)?a(x.slice(2),S?2:8):i.test(x)?t:+x}return Qf=E,Qf}var l4=a4();const c4=_h(l4);class u4 extends Yh{handleDraggingThrottled=null;handleClick(t,e){}handleStartDragging(t,e){t.cancelPan(),e.modeConfig&&e.modeConfig.throttleMs?this.handleDraggingThrottled=c4(this.handleDraggingAux,e.modeConfig.throttleMs):this.handleDraggingThrottled=this.handleDraggingAux}handleStopDragging(t,e){this.addClickSequence(t);const r=this.getClickSequence();if(this.handleDraggingThrottled&&this.handleDraggingThrottled.cancel&&this.handleDraggingThrottled.cancel(),r.length>2){const i={type:"Polygon",coordinates:[[...r,r[0]]]},s=this.getAddFeatureOrBooleanPolygonAction(i,e);s&&e.onEdit(s)}this.resetClickSequence()}handleDraggingAux(t,e){const{picks:r}=t;Ur(r)||(this.addClickSequence(t),e.onEdit({updatedData:e.data,editType:"addTentativePosition",editContext:{position:t.mapCoords}}))}handleDragging(t,e){this.handleDraggingThrottled&&this.handleDraggingThrottled(t,e)}handleKeyUp(t,e){if(t.key==="Enter"){const r=this.getClickSequence();if(r.length>2){const i={type:"Polygon",coordinates:[[...r,r[0]]]};this.resetClickSequence();const s=this.getAddFeatureOrBooleanPolygonAction(i,e);s&&e.onEdit(s)}}else t.key==="Escape"&&(this.resetClickSequence(),this.handleDraggingThrottled&&(this.handleDraggingThrottled=null),e.onEdit({updatedData:e.data,editType:"cancelFeature",editContext:{}}))}}class Fv extends Un{_handler;constructor(t){super(),this._handler=t}_getSnappedMouseEvent(t,e,r){return Object.assign(t,{mapCoords:r.geometry.coordinates,pointerDownMapCoords:e&&e.geometry.coordinates})}_getPickedSnapTarget(t){return Lo(t).find(e=>e.properties.editHandleType==="snap-target")}_getPickedSnapSource(t){return lB(t)}_getUpdatedSnapSourceHandle(t,e){const{featureIndex:r,positionIndexes:i}=t.properties;if(!Array.isArray(i))return t;const s=e.features[r],o=i.reduce((a,l)=>a[l],s.geometry.coordinates);return{...t,geometry:{type:"Point",coordinates:o}}}_getSnapTargets(t){let{additionalSnapTargets:e}=t.modeConfig||{};return e=e||[],[...t.data.features,...e]}_getSnapTargetHandles(t){const e=[],r=this._getSnapTargets(t);for(let i=0;i<r.length;i++)if(!t.selectedIndexes.includes(i)){const{geometry:o}=r[i];e.push(...fh(o,i,"snap-target"))}return e}getGuides(t){const{modeConfig:e,lastPointerMoveEvent:r}=t,{enableSnapping:i}=e||{},s={type:"FeatureCollection",features:[...this._handler.getGuides(t).features]};if(!i)return s;const o=r&&this._getPickedSnapSource(r.pointerDownPicks);if(o)return s.features.push(...this._getSnapTargetHandles(t),this._getUpdatedSnapSourceHandle(o,t.data)),s;const{features:a}=t.data;for(const l of t.selectedIndexes)if(l<a.length){const{geometry:c}=a[l];s.features.push(...fh(c,l,"snap-source"))}return s}_getSnapAwareEvent(t,e){const r=this._getPickedSnapSource(e.lastPointerMoveEvent.pointerDownPicks),i=this._getPickedSnapTarget(t.picks);return r&&i?this._getSnappedMouseEvent(t,r,i):t}handleStartDragging(t,e){this._handler.handleStartDragging(t,e)}handleStopDragging(t,e){this._handler.handleStopDragging(this._getSnapAwareEvent(t,e),e)}handleDragging(t,e){this._handler.handleDragging(this._getSnapAwareEvent(t,e),e)}handlePointerMove(t,e){this._handler.handlePointerMove(this._getSnapAwareEvent(t,e),e)}}class h4 extends Un{_modes;constructor(t){super(),this._modes=t}_coalesce(t,e=null){let r=null;for(let i=0;i<this._modes.length&&(r=t(this._modes[i]),!(e?e(r):r));i++);return r}handleClick(t,e){this._coalesce(r=>r.handleClick(t,e))}handlePointerMove(t,e){return this._coalesce(r=>r.handlePointerMove(t,e))}handleStartDragging(t,e){return this._coalesce(r=>r.handleStartDragging(t,e))}handleStopDragging(t,e){return this._coalesce(r=>r.handleStopDragging(t,e))}handleDragging(t,e){return this._coalesce(r=>r.handleDragging(t,e))}getGuides(t){const e=[];for(const r of this._modes)e.push(...r.getGuides(t).features);return{type:"FeatureCollection",features:e}}}class f4 extends h4{constructor(){super([new dh,new vu,new bu])}handlePointerMove(t,e){let r=null;super.handlePointerMove(t,{...e,onUpdateCursor:i=>{r=i||r}}),e.onUpdateCursor(r)}handleStartDragging(t,e){let r=null,i=null;const s=[];t.picks.length&&t.cancelPan(),this._modes.forEach(o=>{o instanceof dh?i=o:(o instanceof vu&&(r=o),s.push(o))}),r instanceof vu&&!r.isEditHandleSelected()&&s.push(i),s.filter(Boolean).forEach(o=>o.handleStartDragging(t,e))}getGuides(t){let e=super.getGuides(t);const r=(this._modes||[]).find(i=>i instanceof bu);if(r instanceof bu){const i=e.features.filter(s=>{const{editHandleType:o,mode:a}=s.properties||{},l=[a];return r.getIsRotating()&&l.push(o),!l.includes("scale")});e=Ir(i)}return e}}class d4 extends Un{handleClick(t,e){const r=e.lastPointerMoveEvent.picks.map(i=>i.index);if(r.length>0){const i=r[0],s=e.data.features.filter((l,c)=>c!==i),a={updatedData:{...e.data,features:s},editType:"deleteFeature",editContext:{featureIndexes:r}};e.onEdit(a)}}}const aw=2/3,Bv=["click","pointermove","panstart","panmove","panend","keyup"];class p4 extends cc{static layerName="EditableLayer";state=void 0;onLayerClick(t){}onStartDragging(t){}onStopDragging(t){}onDragging(t){}onPointerMove(t){}onLayerKeyUp(t){}initializeState(){this.setState({_editableLayerState:{pointerDownPicks:null,pointerDownScreenCoords:null,pointerDownMapCoords:null,eventHandler:this._forwardEventToCurrentLayer.bind(this)}}),this._addEventHandlers()}finalizeState(){this._removeEventHandlers()}_addEventHandlers(){const{eventManager:t}=this.context.deck,{eventHandler:e}=this.state._editableLayerState;for(const r of Bv)t.on(r,e,{priority:100})}_removeEventHandlers(){const{eventManager:t}=this.context.deck,{eventHandler:e}=this.state._editableLayerState;for(const r of Bv)t.off(r,e)}_forwardEventToCurrentLayer(t){const e=this.getCurrentLayer(),r=e[`_on${t.type}`].bind(e);if(!r){console.warn(`no handler for mjolnir.js event ${t.type}`);return}r(t)}_onclick({srcEvent:t}){const e=this.getScreenCoords(t),r=this.getMapCoords(e),i=this.getPicks(e);this.onLayerClick({mapCoords:r,screenCoords:e,picks:i,sourceEvent:t})}_onkeyup({srcEvent:t}){this.onLayerKeyUp(t)}_onpanstart(t){const e=this.getScreenCoords(t.srcEvent),r=this.getMapCoords(e),i=this.getPicks(e);this.setState({_editableLayerState:{...this.state._editableLayerState,pointerDownScreenCoords:e,pointerDownMapCoords:r,pointerDownPicks:i}}),this.onStartDragging({picks:i,screenCoords:e,mapCoords:r,pointerDownScreenCoords:e,pointerDownMapCoords:r,cancelPan:()=>{this.props.onCancelPan&&this.props.onCancelPan(),t.stopImmediatePropagation()},sourceEvent:t.srcEvent})}_onpanmove(t){const{srcEvent:e}=t,r=this.getScreenCoords(e),i=this.getMapCoords(r),{pointerDownPicks:s,pointerDownScreenCoords:o,pointerDownMapCoords:a}=this.state._editableLayerState,l=this.getPicks(r);this.onDragging({screenCoords:r,mapCoords:i,picks:l,pointerDownPicks:s,pointerDownScreenCoords:o,pointerDownMapCoords:a,sourceEvent:e,cancelPan:t.stopImmediatePropagation})}_onpanend({srcEvent:t}){const e=this.getScreenCoords(t),r=this.getMapCoords(e),{pointerDownPicks:i,pointerDownScreenCoords:s,pointerDownMapCoords:o}=this.state._editableLayerState,a=this.getPicks(e);this.onStopDragging({picks:a,screenCoords:e,mapCoords:r,pointerDownPicks:i,pointerDownScreenCoords:s,pointerDownMapCoords:o,sourceEvent:t}),this.setState({_editableLayerState:{...this.state._editableLayerState,pointerDownScreenCoords:null,pointerDownMapCoords:null,pointerDownPicks:null}})}_onpointermove(t){const{srcEvent:e}=t,r=this.getScreenCoords(e),i=this.getMapCoords(r),{pointerDownPicks:s,pointerDownScreenCoords:o,pointerDownMapCoords:a}=this.state._editableLayerState,l=this.getPicks(r);this.onPointerMove({screenCoords:r,mapCoords:i,picks:l,pointerDownPicks:s,pointerDownScreenCoords:o,pointerDownMapCoords:a,sourceEvent:e,cancelPan:t.stopImmediatePropagation})}getPicks(t){return this.context.deck.pickMultipleObjects({x:t[0],y:t[1],layerIds:[this.props.id],radius:this.props.pickingRadius,depth:this.props.pickingDepth})}getScreenCoords(t){return[t.clientX-this.context.gl.canvas.getBoundingClientRect().left,t.clientY-this.context.gl.canvas.getBoundingClientRect().top]}getMapCoords(t){return this.context.viewport.unproject([t[0],t[1]])}}const Uv=`uniform pickingLineWidthUniforms {
  float extraPixels;
} pickingLineWidth;
`,g4={name:"pickingLineWidth",vs:Uv,fs:Uv,uniformTypes:{extraPixels:"f32"}},m4={...$a.defaultProps,pickingLineWidthExtraPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER}};class Og extends $a{getShaders(){const t=super.getShaders();return t.vs=tB(t.vs,"vec3 width;",`
       if(bool(picking.isActive)){
        widthPixels.xy += pickingLineWidth.extraPixels;
       }
      `),{...t,modules:[...t.modules,g4]}}draw(t){const{pickingLineWidthExtraPixels:e}=this.props,r={extraPixels:e};this.state.model.shaderInputs.setProps({pickingLineWidth:r}),super.draw(t)}}Og.defaultProps=m4;Og.layerName="EditablePathLayer";const _4=[0,0,0,153],y4=[0,0,0,144],v4=[0,0,0,255],b4=[0,0,144,144],x4=[144,144,144,255],E4=[144,144,144,144],w4=[192,0,0,255],S4=[0,0,0,128],C4=[124,0,192,255],T4=[255,255,255,255],P4=5,I4=3,A4=7,M4=32*aw,lw=Yh;function pi(n){return!n||typeof n!="function"?n:t=>n(R4(t))}function R4(n){return n.__source?n.__source.object:n.sourceFeature?n.sourceFeature.feature:n}function Vv(n){switch(n.properties.editHandleType){case"existing":return w4;case"snap-source":return C4;case"intermediate":default:return S4}}function N4(n){return T4}function O4(n){switch(n.properties.editHandleType){case"existing":return P4;case"snap":return A4;case"intermediate":default:return I4}}const D4={mode:lw,onEdit:()=>{},pickable:!0,pickingRadius:10,pickingDepth:5,fp64:!1,filled:!0,stroked:!0,lineWidthScale:aw,lineWidthMinPixels:1,lineWidthMaxPixels:Number.MAX_SAFE_INTEGER,pickingLineWidthExtraPixels:0,lineWidthUnits:"pixels",lineJointRounded:!1,lineCapRounded:!1,lineMiterLimit:4,pointRadiusScale:1,pointRadiusMinPixels:2,pointRadiusMaxPixels:Number.MAX_SAFE_INTEGER,getLineColor:(n,t,e)=>t?v4:_4,getFillColor:(n,t,e)=>t?b4:y4,getRadius:n=>n&&n.properties&&n.properties.radius||n&&n.properties&&n.properties.size||1,getLineWidth:n=>n&&n.properties&&n.properties.lineWidth||3,getTentativeLineColor:n=>x4,getTentativeFillColor:n=>E4,getTentativeLineWidth:n=>n&&n.properties&&n.properties.lineWidth||3,editHandleType:"point",editHandlePointRadiusScale:1,editHandlePointOutline:!0,editHandlePointStrokeWidth:2,editHandlePointRadiusUnits:"pixels",editHandlePointRadiusMinPixels:4,editHandlePointRadiusMaxPixels:8,getEditHandlePointColor:Vv,getEditHandlePointOutlineColor:N4,getEditHandlePointRadius:O4,editHandleIconAtlas:null,editHandleIconMapping:null,editHandleIconSizeScale:1,editHandleIconSizeUnits:"pixels",getEditHandleIcon:n=>n.properties.editHandleType,getEditHandleIconSize:10,getEditHandleIconColor:Vv,getEditHandleIconAngle:0,billboard:!0},L4={view:_B,modify:Mg,translate:new Fv(new dh),transform:new Fv(new f4),scale:vu,rotate:bu,duplicate:TB,split:zB,extrude:WB,elevation:jB,delete:d4,drawPoint:$B,drawLineString:GB,drawPolygon:Yh,drawRectangle:KB,drawSquare:ZB,drawRectangleFromCenter:JB,drawSquareFromCenter:QB,drawCircleFromCenter:e4,drawCircleByBoundingBox:n4,drawEllipseByBoundingBox:r4,drawRectangleUsing3Points:i4,drawEllipseUsing3Points:s4,draw90DegreePolygon:o4,drawPolygonByDragging:u4};class k4 extends p4{static layerName="EditableGeoJsonLayer";static defaultProps=D4;state=void 0;renderLayers(){const t=this.getSubLayerProps({id:"geojson",data:this.props.data,fp64:this.props.fp64,filled:this.props.filled,stroked:this.props.stroked,lineWidthScale:this.props.lineWidthScale,lineWidthMinPixels:this.props.lineWidthMinPixels,lineWidthMaxPixels:this.props.lineWidthMaxPixels,lineWidthUnits:this.props.lineWidthUnits,lineJointRounded:this.props.lineJointRounded,lineCapRounded:this.props.lineCapRounded,lineMiterLimit:this.props.lineMiterLimit,pointRadiusScale:this.props.pointRadiusScale,pointRadiusMinPixels:this.props.pointRadiusMinPixels,pointRadiusMaxPixels:this.props.pointRadiusMaxPixels,getLineColor:this.selectionAwareAccessor(this.props.getLineColor),getFillColor:this.selectionAwareAccessor(this.props.getFillColor),getPointRadius:this.selectionAwareAccessor(this.props.getRadius),getLineWidth:this.selectionAwareAccessor(this.props.getLineWidth),_subLayerProps:{linestrings:{billboard:this.props.billboard,updateTriggers:{all:[this.props.selectedFeatureIndexes,this.props.mode]}},"polygons-stroke":{billboard:this.props.billboard,pickingLineWidthExtraPixels:this.props.pickingLineWidthExtraPixels,type:Og,updateTriggers:{all:[this.props.selectedFeatureIndexes,this.props.mode]}}},updateTriggers:{getLineColor:[this.props.selectedFeatureIndexes,this.props.mode],getFillColor:[this.props.selectedFeatureIndexes,this.props.mode],getPointRadius:[this.props.selectedFeatureIndexes,this.props.mode],getLineWidth:[this.props.selectedFeatureIndexes,this.props.mode]}});let e=[new Ol(t)];return e=e.concat(this.createGuidesLayers(),this.createTooltipsLayers()),e}initializeState(){super.initializeState(),this.setState({selectedFeatures:[],editHandles:[]})}shouldUpdateState(t){return super.shouldUpdateState(t)||t.changeFlags.stateChanged}updateState({props:t,oldProps:e,changeFlags:r,context:i}){if(super.updateState({oldProps:e,props:t,changeFlags:r,context:i}),r.propsOrDataChanged&&(Object.keys(e).length===0||t.mode!==e.mode)){let a;if(typeof t.mode=="function"){const l=t.mode;a=new l}else typeof t.mode=="string"?(a=L4[t.mode],console.warn("Deprecated use of passing `mode` as a string. Pass the mode's class constructor instead.")):a=t.mode;a||(console.warn(`No mode configured for ${String(t.mode)}`),a=new lw),a!==this.state.mode&&this.setState({mode:a,cursor:null})}let s=[];if(Array.isArray(t.selectedFeatureIndexes)&&typeof t.data=="object"&&"features"in t.data){const o=t.data;s=t.selectedFeatureIndexes.map(a=>o.features[a])}this.setState({selectedFeatures:s})}getModeProps(t){return{modeConfig:t.modeConfig,data:t.data,selectedIndexes:t.selectedFeatureIndexes,lastPointerMoveEvent:this.state.lastPointerMoveEvent,cursor:this.state.cursor,onEdit:e=>{this.setNeedsUpdate(),t.onEdit(e)},onUpdateCursor:e=>{this.setState({cursor:e})}}}selectionAwareAccessor(t){return typeof t!="function"?t:e=>t(e,this.isFeatureSelected(e),this.props.mode)}isFeatureSelected(t){return!this.props.data||!this.props.selectedFeatureIndexes||!this.props.selectedFeatureIndexes.length?!1:this.state.selectedFeatures.includes(t)}getPickingInfo({info:t,sourceLayer:e}){return e.id.endsWith("guides")&&(t.isGuide=!0),t}_updateAutoHighlight(t){if(t?.sourceLayer)if(t.isGuide)for(const e of t.sourceLayer.getSubLayers())e.updateAutoHighlight(t);else t.sourceLayer.updateAutoHighlight(t)}createGuidesLayers(){const e=this.getActiveMode().getGuides(this.getModeProps(this.props));if(!e||!e.features.length)return[];const r={linestrings:{billboard:this.props.billboard,autoHighlight:!1},"polygons-fill":{autoHighlight:!1},"polygons-stroke":{billboard:this.props.billboard}};return this.props.editHandleType==="icon"?r["points-icon"]={type:uc,iconAtlas:this.props.editHandleIconAtlas,iconMapping:this.props.editHandleIconMapping,sizeUnits:this.props.editHandleIconSizeUnits,sizeScale:this.props.editHandleIconSizeScale,getIcon:pi(this.props.getEditHandleIcon),getSize:pi(this.props.getEditHandleIconSize),getColor:pi(this.props.getEditHandleIconColor),getAngle:pi(this.props.getEditHandleIconAngle),billboard:this.props.billboard}:r["points-circle"]={type:io,radiusScale:this.props.editHandlePointRadiusScale,stroked:this.props.editHandlePointOutline,getLineWidth:this.props.editHandlePointStrokeWidth,radiusUnits:this.props.editHandlePointRadiusUnits,radiusMinPixels:this.props.editHandlePointRadiusMinPixels,radiusMaxPixels:this.props.editHandlePointRadiusMaxPixels,getRadius:pi(this.props.getEditHandlePointRadius),getFillColor:pi(this.props.getEditHandlePointColor),getLineColor:pi(this.props.getEditHandlePointOutlineColor),billboard:this.props.billboard},[new Ol(this.getSubLayerProps({id:"guides",data:e,fp64:this.props.fp64,_subLayerProps:r,lineWidthScale:this.props.lineWidthScale,lineWidthMinPixels:this.props.lineWidthMinPixels,lineWidthMaxPixels:this.props.lineWidthMaxPixels,lineWidthUnits:this.props.lineWidthUnits,lineJointRounded:this.props.lineJointRounded,lineCapRounded:this.props.lineCapRounded,lineMiterLimit:this.props.lineMiterLimit,getLineColor:pi(this.props.getTentativeLineColor),getLineWidth:pi(this.props.getTentativeLineWidth),getFillColor:pi(this.props.getTentativeFillColor),pointType:this.props.editHandleType==="icon"?"icon":"circle",iconAtlas:this.props.editHandleIconAtlas}))]}createTooltipsLayers(){const e=this.getActiveMode().getTooltips(this.getModeProps(this.props));return[new Ah({getSize:M4,...this.getSubLayerProps({id:"tooltips",data:e})})]}onLayerClick(t){this.getActiveMode().handleClick(t,this.getModeProps(this.props))}onLayerKeyUp(t){this.getActiveMode().handleKeyUp(t,this.getModeProps(this.props))}onStartDragging(t){this.getActiveMode().handleStartDragging(t,this.getModeProps(this.props))}onDragging(t){this.getActiveMode().handleDragging(t,this.getModeProps(this.props))}onStopDragging(t){this.getActiveMode().handleStopDragging(t,this.getModeProps(this.props))}onPointerMove(t){this.setState({lastPointerMoveEvent:t}),this.getActiveMode().handlePointerMove(t,this.getModeProps(this.props))}getCursor({isDragging:t}){if(this.state===null||this.state===void 0)return null;let{cursor:e}=this.state;return e||(e=t?"grabbing":"grab"),e}getActiveMode(){return this.state.mode}}const F4={pathArc:function(n,t=50,e=!0,r=!0){const{pickup:i,dropoff:s,height:o}=n,a=(g,y,b)=>g+(y-g)*b,l=(g,y,b)=>b.map(x=>a(g,y,x)),c=(g,y=0,b=0,x,w=1)=>{const S=b-y,I=g*w;if(I===0)return y+S*x;const T=S/I,M=T*T+1,L=0<S?0:1,O=a(y,b,L),P=a(x,1-x,L);return Math.sqrt(P*(M-P))*I+O},u=(g,y,b)=>Math.max(y,Math.min(g,b)),h=g=>Array.from({length:g},(y,b)=>b),f=(g,y,b)=>(b=u((b-g)/(y-g),0,1),b*b*(3-2*b)),d=(g=100,y=!0)=>h(g).map(y?b=>f(0,1,b/(g-1)):b=>a(0,1,b/(g-1))),_=d(t,e).map(g=>c(o,i[2],s[2],g)),v=d(t,r),E=l(i[0],s[0],v),m=l(i[1],s[1],v);return _.map((g,y)=>[E[y],m[y],g])}};function B4(n){const[t,e]=ve(3),r={PathStyleExtension:Ku},i={EditableGeoJsonLayer:k4,DrawPolygonMode:Yh},s={GoogleMapsOverlay:KL},o={GeoJsonLayer:Ol,PathLayer:$a};let a,l="marker_atlas",c,u,h={icon:()=>{alert("Icon Layer is not ready")},editable:()=>{alert("Editable Layer is not ready")},path:()=>{alert("Path Layer is not ready")},dashedArcPath:()=>{alert("Arc Layer is not ready")},staticEditable:void 0},f;const d=`${Sy.apiAtlasUrl}/${l}.png`,p=[],_={fnGetScale:b=>{const x=Math.pow(n.sigZoom()*b/60,2);return console.log("scale into",x),Math.min(x,34.41777777777777)}};gh(()=>{f=n.gmapref,JL.getMapData("geojson.json").then(b=>{u=b,Sy.getAtlasDefinition(l+".json").then(x=>{console.log("atlasdef",x),c=ZL.getIconMappingFromTexPackerJSONHash(x),m()})})});const v=()=>{h.icon=()=>new o.GeoJsonLayer({id:"icon-layer",data:u,pickable:!0,pointType:"icon",iconAtlas:d,getIcon:x=>"im_critical.png",iconSizeScale:_.fnGetScale(32),iconMapping:c});const b=[[38.35,173.65],[293.1,-81.1],[303.65,-96.2],[308.45,-114.05],[306.85,-132.45],[299,-149.15],[285.95,-162.2],[269.25,-170.05],[250.85,-171.6],[233,-166.85],[217.9,-156.25],[-7.6,69.25],[-22.7,81.8],[-39.9,91.4],[-58.6,97.6],[-78.1,100.25],[-97.75,99.3],[-116.9,94.75],[-134.9,86.7],[-151.05,75.45],[-164.9,61.45],[-175.95,45.15],[-183.8,27.1],[-188.15,7.9],[-188.85,-11.75],[-186,-31.25],[-179.55,-49.85],[-169.75,-66.95],[-157,-81.9],[-141.7,-94.35],[-124.4,-103.7],[-105.65,-109.7],[-86.1,-112.15],[-66.45,-110.95],[-47.4,-106.2],[-29.5,-97.95],[-13.45,-86.5],[1.45,-73.9],[19.65,-66.55],[39.25,-66.35],[57.6,-73.25],[72.2,-86.3],[81.05,-103.8],[83,-123.3],[77.7,-142.15],[65.95,-157.85],[49.3,-168.2],[30.05,-171.8],[-288.85,-171.8]];h.path=()=>new o.PathLayer({id:"path-layer",data:[{path:b}],coordinateSystem:At.METER_OFFSETS,coordinateOrigin:[106.8167,-6.1754],getPath:x=>x.path,getWidth:2,getColor:[60,100,160],widthUnits:"pixels",getDashArray:[4,3],dashJustified:!1,extensions:[new Ku({highPrecisionDash:!0})]}),h.dashedArcPath=()=>{const x=[{pickup:[105.9955409814338,-8.403480081564624],dropoff:[112.6535629832967,-7.375859742310922],height:5e5,tripStartTime:5,tripEndTime:0}];return new o.PathLayer({data:x,id:"dashed-arc-path",billboard:!0,widthScale:20,widthMinPixels:1,getPath:w=>F4.pathArc(w),getColor:w=>[0,128,255],getWidth:w=>5,getDashArray:[3,2],dashJustified:!0,dashGapPickable:!0,extensions:[new r.PathStyleExtension({highPrecisionDash:!0})]})},h.editable=()=>new i.EditableGeoJsonLayer({id:"geojson-layer-editable",data:u,mode:i.DrawPolygonMode,selectedFeatureIndexes:p,pickable:!0,onClick:x=>{console.log("Clicked Editable",x)},onEdit:x=>{console.log("Edited feature",x)}}),h.staticEditable=h.editable()},E=()=>{let b=new s.GoogleMapsOverlay({interleaved:!1,getCursor:h.staticEditable.getCursor.bind(h.staticEditable),layers:[...y()],style:{zIndex:"10000"}});a=b,b.setMap(f),console.log("DeckGL Overlay Loaded",a,h)},m=()=>{v(),E()},g=()=>{a.setProps({layers:[...y()]})},y=()=>[h.icon(),h.staticEditable,h.path(),h.dashedArcPath()];return Jn(()=>{n.sigZoom(),a&&g()}),[]}var Is=Object.freeze({Linear:Object.freeze({None:function(n){return n},In:function(n){return n},Out:function(n){return n},InOut:function(n){return n}}),Quadratic:Object.freeze({In:function(n){return n*n},Out:function(n){return n*(2-n)},InOut:function(n){return(n*=2)<1?.5*n*n:-.5*(--n*(n-2)-1)}}),Cubic:Object.freeze({In:function(n){return n*n*n},Out:function(n){return--n*n*n+1},InOut:function(n){return(n*=2)<1?.5*n*n*n:.5*((n-=2)*n*n+2)}}),Quartic:Object.freeze({In:function(n){return n*n*n*n},Out:function(n){return 1- --n*n*n*n},InOut:function(n){return(n*=2)<1?.5*n*n*n*n:-.5*((n-=2)*n*n*n-2)}}),Quintic:Object.freeze({In:function(n){return n*n*n*n*n},Out:function(n){return--n*n*n*n*n+1},InOut:function(n){return(n*=2)<1?.5*n*n*n*n*n:.5*((n-=2)*n*n*n*n+2)}}),Sinusoidal:Object.freeze({In:function(n){return 1-Math.sin((1-n)*Math.PI/2)},Out:function(n){return Math.sin(n*Math.PI/2)},InOut:function(n){return .5*(1-Math.sin(Math.PI*(.5-n)))}}),Exponential:Object.freeze({In:function(n){return n===0?0:Math.pow(1024,n-1)},Out:function(n){return n===1?1:1-Math.pow(2,-10*n)},InOut:function(n){return n===0?0:n===1?1:(n*=2)<1?.5*Math.pow(1024,n-1):.5*(-Math.pow(2,-10*(n-1))+2)}}),Circular:Object.freeze({In:function(n){return 1-Math.sqrt(1-n*n)},Out:function(n){return Math.sqrt(1- --n*n)},InOut:function(n){return(n*=2)<1?-.5*(Math.sqrt(1-n*n)-1):.5*(Math.sqrt(1-(n-=2)*n)+1)}}),Elastic:Object.freeze({In:function(n){return n===0?0:n===1?1:-Math.pow(2,10*(n-1))*Math.sin((n-1.1)*5*Math.PI)},Out:function(n){return n===0?0:n===1?1:Math.pow(2,-10*n)*Math.sin((n-.1)*5*Math.PI)+1},InOut:function(n){return n===0?0:n===1?1:(n*=2,n<1?-.5*Math.pow(2,10*(n-1))*Math.sin((n-1.1)*5*Math.PI):.5*Math.pow(2,-10*(n-1))*Math.sin((n-1.1)*5*Math.PI)+1)}}),Back:Object.freeze({In:function(n){var t=1.70158;return n===1?1:n*n*((t+1)*n-t)},Out:function(n){var t=1.70158;return n===0?0:--n*n*((t+1)*n+t)+1},InOut:function(n){var t=2.5949095;return(n*=2)<1?.5*(n*n*((t+1)*n-t)):.5*((n-=2)*n*((t+1)*n+t)+2)}}),Bounce:Object.freeze({In:function(n){return 1-Is.Bounce.Out(1-n)},Out:function(n){return n<1/2.75?7.5625*n*n:n<2/2.75?7.5625*(n-=1.5/2.75)*n+.75:n<2.5/2.75?7.5625*(n-=2.25/2.75)*n+.9375:7.5625*(n-=2.625/2.75)*n+.984375},InOut:function(n){return n<.5?Is.Bounce.In(n*2)*.5:Is.Bounce.Out(n*2-1)*.5+.5}}),generatePow:function(n){return n===void 0&&(n=4),n=n<Number.EPSILON?Number.EPSILON:n,n=n>1e4?1e4:n,{In:function(t){return Math.pow(t,n)},Out:function(t){return 1-Math.pow(1-t,n)},InOut:function(t){return t<.5?Math.pow(t*2,n)/2:(1-Math.pow(2-t*2,n))/2+.5}}}}),pl=function(){return performance.now()},cw=function(){function n(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._tweens={},this._tweensAddedDuringUpdate={},this.add.apply(this,t)}return n.prototype.getAll=function(){var t=this;return Object.keys(this._tweens).map(function(e){return t._tweens[e]})},n.prototype.removeAll=function(){this._tweens={}},n.prototype.add=function(){for(var t,e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];for(var i=0,s=e;i<s.length;i++){var o=s[i];(t=o._group)===null||t===void 0||t.remove(o),o._group=this,this._tweens[o.getId()]=o,this._tweensAddedDuringUpdate[o.getId()]=o}},n.prototype.remove=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var r=0,i=t;r<i.length;r++){var s=i[r];s._group=void 0,delete this._tweens[s.getId()],delete this._tweensAddedDuringUpdate[s.getId()]}},n.prototype.allStopped=function(){return this.getAll().every(function(t){return!t.isPlaying()})},n.prototype.update=function(t,e){t===void 0&&(t=pl()),e===void 0&&(e=!0);var r=Object.keys(this._tweens);if(r.length!==0)for(;r.length>0;){this._tweensAddedDuringUpdate={};for(var i=0;i<r.length;i++){var s=this._tweens[r[i]],o=!e;s&&s.update(t,o)===!1&&!e&&this.remove(s)}r=Object.keys(this._tweensAddedDuringUpdate)}},n}(),sp={Linear:function(n,t){var e=n.length-1,r=e*t,i=Math.floor(r),s=sp.Utils.Linear;return t<0?s(n[0],n[1],r):t>1?s(n[e],n[e-1],e-r):s(n[i],n[i+1>e?e:i+1],r-i)},Utils:{Linear:function(n,t,e){return(t-n)*e+n}}},uw=function(){function n(){}return n.nextId=function(){return n._nextId++},n._nextId=0,n}(),op=new cw,td=function(){function n(t,e){this._isPaused=!1,this._pauseStart=0,this._valuesStart={},this._valuesEnd={},this._valuesStartRepeat={},this._duration=1e3,this._isDynamic=!1,this._initialRepeat=0,this._repeat=0,this._yoyo=!1,this._isPlaying=!1,this._reversed=!1,this._delayTime=0,this._startTime=0,this._easingFunction=Is.Linear.None,this._interpolationFunction=sp.Linear,this._chainedTweens=[],this._onStartCallbackFired=!1,this._onEveryStartCallbackFired=!1,this._id=uw.nextId(),this._isChainStopped=!1,this._propertiesAreSetUp=!1,this._goToEnd=!1,this._object=t,typeof e=="object"?(this._group=e,e.add(this)):e===!0&&(this._group=op,op.add(this))}return n.prototype.getId=function(){return this._id},n.prototype.isPlaying=function(){return this._isPlaying},n.prototype.isPaused=function(){return this._isPaused},n.prototype.getDuration=function(){return this._duration},n.prototype.to=function(t,e){if(e===void 0&&(e=1e3),this._isPlaying)throw new Error("Can not call Tween.to() while Tween is already started or paused. Stop the Tween first.");return this._valuesEnd=t,this._propertiesAreSetUp=!1,this._duration=e<0?0:e,this},n.prototype.duration=function(t){return t===void 0&&(t=1e3),this._duration=t<0?0:t,this},n.prototype.dynamic=function(t){return t===void 0&&(t=!1),this._isDynamic=t,this},n.prototype.start=function(t,e){if(t===void 0&&(t=pl()),e===void 0&&(e=!1),this._isPlaying)return this;if(this._repeat=this._initialRepeat,this._reversed){this._reversed=!1;for(var r in this._valuesStartRepeat)this._swapEndStartRepeatValues(r),this._valuesStart[r]=this._valuesStartRepeat[r]}if(this._isPlaying=!0,this._isPaused=!1,this._onStartCallbackFired=!1,this._onEveryStartCallbackFired=!1,this._isChainStopped=!1,this._startTime=t,this._startTime+=this._delayTime,!this._propertiesAreSetUp||e){if(this._propertiesAreSetUp=!0,!this._isDynamic){var i={};for(var s in this._valuesEnd)i[s]=this._valuesEnd[s];this._valuesEnd=i}this._setupProperties(this._object,this._valuesStart,this._valuesEnd,this._valuesStartRepeat,e)}return this},n.prototype.startFromCurrentValues=function(t){return this.start(t,!0)},n.prototype._setupProperties=function(t,e,r,i,s){for(var o in r){var a=t[o],l=Array.isArray(a),c=l?"array":typeof a,u=!l&&Array.isArray(r[o]);if(!(c==="undefined"||c==="function")){if(u){var h=r[o];if(h.length===0)continue;for(var f=[a],d=0,p=h.length;d<p;d+=1){var _=this._handleRelativeValue(a,h[d]);if(isNaN(_)){u=!1,console.warn("Found invalid interpolation list. Skipping.");break}f.push(_)}u&&(r[o]=f)}if((c==="object"||l)&&a&&!u){e[o]=l?[]:{};var v=a;for(var E in v)e[o][E]=v[E];i[o]=l?[]:{};var h=r[o];if(!this._isDynamic){var m={};for(var E in h)m[E]=h[E];r[o]=h=m}this._setupProperties(v,e[o],h,i[o],s)}else(typeof e[o]>"u"||s)&&(e[o]=a),l||(e[o]*=1),u?i[o]=r[o].slice().reverse():i[o]=e[o]||0}}},n.prototype.stop=function(){return this._isChainStopped||(this._isChainStopped=!0,this.stopChainedTweens()),this._isPlaying?(this._isPlaying=!1,this._isPaused=!1,this._onStopCallback&&this._onStopCallback(this._object),this):this},n.prototype.end=function(){return this._goToEnd=!0,this.update(this._startTime+this._duration),this},n.prototype.pause=function(t){return t===void 0&&(t=pl()),this._isPaused||!this._isPlaying?this:(this._isPaused=!0,this._pauseStart=t,this)},n.prototype.resume=function(t){return t===void 0&&(t=pl()),!this._isPaused||!this._isPlaying?this:(this._isPaused=!1,this._startTime+=t-this._pauseStart,this._pauseStart=0,this)},n.prototype.stopChainedTweens=function(){for(var t=0,e=this._chainedTweens.length;t<e;t++)this._chainedTweens[t].stop();return this},n.prototype.group=function(t){return t?(t.add(this),this):(console.warn("tween.group() without args has been removed, use group.add(tween) instead."),this)},n.prototype.remove=function(){var t;return(t=this._group)===null||t===void 0||t.remove(this),this},n.prototype.delay=function(t){return t===void 0&&(t=0),this._delayTime=t,this},n.prototype.repeat=function(t){return t===void 0&&(t=0),this._initialRepeat=t,this._repeat=t,this},n.prototype.repeatDelay=function(t){return this._repeatDelayTime=t,this},n.prototype.yoyo=function(t){return t===void 0&&(t=!1),this._yoyo=t,this},n.prototype.easing=function(t){return t===void 0&&(t=Is.Linear.None),this._easingFunction=t,this},n.prototype.interpolation=function(t){return t===void 0&&(t=sp.Linear),this._interpolationFunction=t,this},n.prototype.chain=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return this._chainedTweens=t,this},n.prototype.onStart=function(t){return this._onStartCallback=t,this},n.prototype.onEveryStart=function(t){return this._onEveryStartCallback=t,this},n.prototype.onUpdate=function(t){return this._onUpdateCallback=t,this},n.prototype.onRepeat=function(t){return this._onRepeatCallback=t,this},n.prototype.onComplete=function(t){return this._onCompleteCallback=t,this},n.prototype.onStop=function(t){return this._onStopCallback=t,this},n.prototype.update=function(t,e){var r=this,i;if(t===void 0&&(t=pl()),e===void 0&&(e=n.autoStartOnUpdate),this._isPaused)return!0;var s;if(!this._goToEnd&&!this._isPlaying)if(e)this.start(t,!0);else return!1;if(this._goToEnd=!1,t<this._startTime)return!0;this._onStartCallbackFired===!1&&(this._onStartCallback&&this._onStartCallback(this._object),this._onStartCallbackFired=!0),this._onEveryStartCallbackFired===!1&&(this._onEveryStartCallback&&this._onEveryStartCallback(this._object),this._onEveryStartCallbackFired=!0);var o=t-this._startTime,a=this._duration+((i=this._repeatDelayTime)!==null&&i!==void 0?i:this._delayTime),l=this._duration+this._repeat*a,c=function(){if(r._duration===0||o>l)return 1;var _=Math.trunc(o/a),v=o-_*a,E=Math.min(v/r._duration,1);return E===0&&o===r._duration?1:E},u=c(),h=this._easingFunction(u);if(this._updateProperties(this._object,this._valuesStart,this._valuesEnd,h),this._onUpdateCallback&&this._onUpdateCallback(this._object,u),this._duration===0||o>=this._duration)if(this._repeat>0){var f=Math.min(Math.trunc((o-this._duration)/a)+1,this._repeat);isFinite(this._repeat)&&(this._repeat-=f);for(s in this._valuesStartRepeat)!this._yoyo&&typeof this._valuesEnd[s]=="string"&&(this._valuesStartRepeat[s]=this._valuesStartRepeat[s]+parseFloat(this._valuesEnd[s])),this._yoyo&&this._swapEndStartRepeatValues(s),this._valuesStart[s]=this._valuesStartRepeat[s];return this._yoyo&&(this._reversed=!this._reversed),this._startTime+=a*f,this._onRepeatCallback&&this._onRepeatCallback(this._object),this._onEveryStartCallbackFired=!1,!0}else{this._onCompleteCallback&&this._onCompleteCallback(this._object);for(var d=0,p=this._chainedTweens.length;d<p;d++)this._chainedTweens[d].start(this._startTime+this._duration,!1);return this._isPlaying=!1,!1}return!0},n.prototype._updateProperties=function(t,e,r,i){for(var s in r)if(e[s]!==void 0){var o=e[s]||0,a=r[s],l=Array.isArray(t[s]),c=Array.isArray(a),u=!l&&c;u?t[s]=this._interpolationFunction(a,i):typeof a=="object"&&a?this._updateProperties(t[s],o,a,i):(a=this._handleRelativeValue(o,a),typeof a=="number"&&(t[s]=o+(a-o)*i))}},n.prototype._handleRelativeValue=function(t,e){return typeof e!="string"?e:e.charAt(0)==="+"||e.charAt(0)==="-"?t+parseFloat(e):parseFloat(e)},n.prototype._swapEndStartRepeatValues=function(t){var e=this._valuesStartRepeat[t],r=this._valuesEnd[t];typeof r=="string"?this._valuesStartRepeat[t]=this._valuesStartRepeat[t]+parseFloat(r):this._valuesStartRepeat[t]=this._valuesEnd[t],this._valuesEnd[t]=e},n.autoStartOnUpdate=!1,n}();uw.nextId;var Oi=op;Oi.getAll.bind(Oi);Oi.removeAll.bind(Oi);Oi.add.bind(Oi);Oi.remove.bind(Oi);Oi.update.bind(Oi);const U4=(n,t)=>{const e=o=>{const a=t,l=a.getCenter(),c={tilt:a.getTilt(),heading:a.getHeading(),zoom:a.getZoom(),center:{lat:l?.lat()||0,lng:l?.lng()||0}};let u;const h=o.duration||3e3,f=h/1.5,d={tilt:c.tilt,heading:c.heading,zoom:c.zoom,center:{...c.center},arc:0},p={tilt:0,heading:0,zoom:o.zoom,center:{lat:o.lat,lng:o.lng},arc:1},_={...d.center,arc:d.arc},v=new td(_).to({...p.center,arc:p.arc},f).easing(Is.Quintic.Out).onUpdate(w=>{const S=(1-w.arc)*d.center.lat+w.arc*p.center.lat,I=(1-w.arc)*d.center.lng+w.arc*p.center.lng;a.moveCamera({center:{lat:S,lng:I}})}),E={tilt:d.tilt,heading:d.heading,zoom:d.zoom,arc:d.arc},m={tilt:p.tilt,heading:p.heading,zoom:p.zoom,arc:p.arc},g=new td(E).to(m,h).easing(Is.Cubic.Out).onUpdate(w=>{const I=r(d,p,-.7),T=I-Math.pow(w.arc*2-1,2)*(I-w.zoom);a.moveCamera({zoom:T,tilt:w.tilt,heading:w.heading})}),y=new cw;y.add(v),y.add(g),v.start(),g.start();function b(w){y.allStopped()||(u=requestAnimationFrame(b),y.update(w))}return u=requestAnimationFrame(b),{isStopped:()=>y.allStopped(),stopAnimation:()=>{u&&cancelAnimationFrame(u),v&&v.isPlaying()&&v.stop(),g&&g.isPlaying()&&g.stop()}}},r=(o,a,l=1)=>{const c=n,u=new c.maps.LatLng(o.center),h=new c.maps.LatLng(a.center),f=c.maps.geometry.spherical.computeDistanceBetween(u,h)/1e3,d=Math.log(f+1),p=Math.abs(o.zoom-a.zoom),_=(d+p)*l;return Math.max(o.zoom,a.zoom)+_},i=(o,a)=>{const l=n,c=new l.maps.LatLng(o.center),u=new l.maps.LatLng(a.center),h=l.maps.geometry.spherical.computeDistanceBetween(c,u)/1e3,f=Math.abs(o.zoom-a.zoom),d=1e3,p=Math.log(h+1)*500,_=f*100,v=d+p+_;return Math.min(v,5e3)};return{fnFlyTo:e,fnCalculateMaxArcZoom:r,fnCalculateFlyDuration:i,fnFlyToBounds:(o,a)=>{const l=t,c=n;if(!l||!c||!o||o.length!==2)return{isStopped:()=>!0,stopAnimation:()=>{}};const[u,h]=o[0],[f,d]=o[1],p={lat:Math.min(h,d),lng:Math.min(u,f)},_={lat:Math.max(h,d),lng:Math.max(u,f)},v=new c.maps.LatLngBounds(p,_),E=v.getCenter().toJSON(),m={height:256,width:256},g=21;function y(O){const P=Math.sin(O*Math.PI/180),V=Math.log((1+P)/(1-P))/2;return Math.max(Math.min(V,Math.PI),-Math.PI)/2}function b(O,P,V){const C=O.getNorthEast(),R=O.getSouthWest(),D=(y(C.lat())-y(R.lat()))/Math.PI,H=C.lng()-R.lng(),K=(H<0?H+360:H)/360,G=Math.log(P.height/V/m.height/D)/Math.LN2,Y=Math.log(P.width/V/m.width/K)/Math.LN2;return Math.min(G,Y,g)}const x=a?.padding??50,w=l.getDiv(),S={width:w.offsetWidth||800,height:w.offsetHeight||600},I=b(v,S,x),T={tilt:l.getTilt(),heading:l.getHeading(),zoom:l.getZoom(),center:l.getCenter()?.toJSON(),arc:0},M={tilt:a?.tilt??l.getTilt(),heading:a?.heading??l.getHeading(),zoom:I,center:E,arc:1},L=i(T,M);if(console.log("duration precalculation",L),a?.useFlyTo)return e({lat:M.center?.lat,lng:M.center?.lng,zoom:M.zoom,duration:L});{let O=function(R){V.isPlaying()&&(P=requestAnimationFrame(O),V.update(R),console.log("animatingbbox"))},P;const V=new td(T).to(M,L).easing(Is.Quadratic.Out).onUpdate(R=>{const D=(1-R.arc)*T.center.lat+R.arc*M.center.lat,H=(1-R.arc)*T.center.lng+R.arc*M.center.lng,G=r(T,M,-.9),Y=G-Math.pow(R.arc*2-1,2)*(G-R.zoom);l.moveCamera({center:{lat:D,lng:H},zoom:Y,tilt:R.tilt,heading:R.heading})}).start();return P=requestAnimationFrame(O),{isStopped:()=>!V.isPlaying(),stopAnimation:()=>{P&&cancelAnimationFrame(P),V&&V.isPlaying()&&V.stop()}}}}}};function Mn(){return Mn=Object.assign?Object.assign.bind():function(n){for(var t=1;t<arguments.length;t++){var e=arguments[t];for(var r in e)({}).hasOwnProperty.call(e,r)&&(n[r]=e[r])}return n},Mn.apply(null,arguments)}var Di;(function(n){n.Commit="commit",n.Provisional="provisional",n.Finish="finish"})(Di||(Di={}));const V4="https://raw.githubusercontent.com/JamesLMilner/terra-draw/refs/heads/main/assets/markers/marker-blue.png",Ie={SELECTED:"selected",MID_POINT:"midPoint",SELECTION_POINT_FEATURE_ID:"selectionPointFeatureId",SELECTION_POINT:"selectionPoint"},sn={MODE:"mode",CURRENTLY_DRAWING:"currentlyDrawing",EDITED:"edited",CLOSING_POINT:"closingPoint",SNAPPING_POINT:"snappingPoint",COORDINATE_POINT:"coordinatePoint",COORDINATE_POINT_FEATURE_ID:"coordinatePointFeatureId",COORDINATE_POINT_IDS:"coordinatePointIds",PROVISIONAL_COORDINATE_COUNT:"provisionalCoordinateCount",COMMITTED_COORDINATE_COUNT:"committedCoordinateCount",MARKER:"marker"},Eu=10;function ed(n){return!!(n&&typeof n=="object"&&n!==null&&!Array.isArray(n))}function zv(n){return!!(n&&typeof n=="object"&&"properties"in n&&typeof n.properties=="object"&&n.properties!==null&&"mode"in n.properties)}function Wv(n){return!!function(t){return typeof t=="number"&&!isNaN(new Date(t).valueOf())}(n)}const z4="Feature mode property does not match the mode being added to";var Wa;(function(n){n.Drawing="drawing",n.Select="select",n.Static="static",n.Render="render"})(Wa||(Wa={}));const W4={rightClick:!0,contextMenu:!1,leftClick:!0,onDragStart:!0,onDrag:!0,onDragEnd:!0};class Dg{get state(){return this._state}set state(t){throw new Error("Please use the modes lifecycle methods")}get styles(){return this._styles}set styles(t){if(typeof t!="object")throw new Error("Styling must be an object");this.onStyleChange&&this.onStyleChange([],"styling"),this._styles=t}registerBehaviors(t){}constructor(t,e=!1){this._state="unregistered",this._styles={},this.pointerEvents=W4,this.behaviors=[],this.validate=void 0,this.pointerDistance=40,this.coordinatePrecision=void 0,this.onStyleChange=void 0,this.store=void 0,this.projection="web-mercator",this.setDoubleClickToZoom=void 0,this.unproject=void 0,this.project=void 0,this.setCursor=void 0,this.type=Wa.Drawing,this.mode="base",e||this.updateOptions(t)}updateOptions(t){t!=null&&t.styles&&(this.styles=Mn({},this._styles,t.styles)),t!=null&&t.pointerDistance&&(this.pointerDistance=t.pointerDistance),t!=null&&t.validation&&(this.validate=t&&t.validation),t!=null&&t.projection&&(this.projection=t.projection),t?.pointerEvents!==void 0&&(this.pointerEvents=t.pointerEvents)}allowPointerEvent(t,e){return typeof t=="boolean"?t:typeof t!="function"||t(e)}setDrawing(){if(this._state!=="started")throw new Error("Mode must be unregistered or stopped to start");this._state="drawing"}setStarted(){if(this._state!=="stopped"&&this._state!=="registered"&&this._state!=="drawing"&&this._state!=="selecting")throw new Error("Mode must be unregistered or stopped to start");this._state="started",this.setDoubleClickToZoom(!1)}setStopped(){if(this._state!=="started")throw new Error("Mode must be started to be stopped");this._state="stopped",this.setDoubleClickToZoom(!0)}register(t){if(this._state!=="unregistered")throw new Error("Can not register unless mode is unregistered");this._state="registered",this.store=t.store,this.store.registerOnChange(t.onChange),this.setDoubleClickToZoom=t.setDoubleClickToZoom,this.project=t.project,this.unproject=t.unproject,this.onSelect=t.onSelect,this.onDeselect=t.onDeselect,this.setCursor=t.setCursor,this.onStyleChange=t.onChange,this.onFinish=t.onFinish,this.coordinatePrecision=t.coordinatePrecision,this.registerBehaviors({mode:t.mode,store:this.store,project:this.project,unproject:this.unproject,pointerDistance:this.pointerDistance,coordinatePrecision:t.coordinatePrecision,projection:this.projection})}validateFeature(t){return this.performFeatureValidation(t)}afterFeatureAdded(t){}afterFeatureUpdated(t){}performFeatureValidation(t){if(this._state==="unregistered")throw new Error("Mode must be registered");const e=function(r,i){let s;if(ed(r))if(r.id==null)s="Feature has no id";else if(typeof r.id!="string"&&typeof r.id!="number")s="Feature must be string or number as per GeoJSON spec";else if(i(r.id))if(ed(r.geometry))if(ed(r.properties))if(typeof r.geometry.type=="string"&&["Polygon","LineString","Point"].includes(r.geometry.type))if(Array.isArray(r.geometry.coordinates)){if(!r.properties.mode||typeof r.properties.mode!="string")return{valid:!1,reason:"Feature does not have a valid mode property"}}else s="Feature coordinates is not an array";else s="Feature is not Point, LineString or Polygon";else s="Feature has no properties";else s="Feature has no geometry";else s="Feature must match the id strategy (default is UUID4)";else s="Feature is not object";return s?{valid:!1,reason:s}:{valid:!0}}(t,this.store.idStrategy.isValidId);if(this.validate){const r=this.validate(t,{project:this.project,unproject:this.unproject,coordinatePrecision:this.coordinatePrecision,updateType:Di.Provisional});return{valid:e.valid&&r.valid,reason:r.reason}}return{valid:e.valid,reason:e.reason}}validateModeFeature(t,e){const r=this.performFeatureValidation(t);return r.valid?t.properties.mode!==this.mode?{valid:!1,reason:z4}:e(t):{valid:!1,reason:r.reason}}onFinish(t,e){}onDeselect(t){}onSelect(t){}onKeyDown(t){}onKeyUp(t){}onMouseMove(t){}onClick(t){}onDragStart(t,e){}onDrag(t,e){}onDragEnd(t,e){}getHexColorStylingValue(t,e,r){return this.getStylingValue(t,e,r)}getNumericStylingValue(t,e,r){return this.getStylingValue(t,e,r)}getUrlStylingValue(t,e,r){return this.getStylingValue(t,e,r)}getStylingValue(t,e,r){return t===void 0?e:typeof t=="function"?t(r):t}}class H4 extends Dg{constructor(...t){super(...t),this.type=Wa.Select}}function Ql(n,t){const e=c=>c*Math.PI/180,r=e(n[1]),i=e(n[0]),s=e(t[1]),o=s-r,a=e(t[0])-i,l=Math.sin(o/2)*Math.sin(o/2)+Math.cos(r)*Math.cos(s)*Math.sin(a/2)*Math.sin(a/2);return 2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l))*6371e3/1e3}const hw=63710088e-1;function so(n){return n%360*Math.PI/180}function ap(n){return n%(2*Math.PI)*180/Math.PI}function Me(n,t=9){const e=Math.pow(10,t);return Math.round(n*e)/e}const Hv=57.29577951308232,jv=.017453292519943295,ph=6378137,ye=(n,t)=>({x:n===0?0:n*jv*ph,y:t===0?0:Math.log(Math.tan(Math.PI/4+t*jv/2))*ph}),Ha=(n,t)=>({lng:n===0?0:Hv*(n/ph),lat:t===0?0:(2*Math.atan(Math.exp(t/ph))-Math.PI/2)*Hv});function j4(n){let t;if(n.geometry.type==="Polygon")t=n.geometry.coordinates;else{if(n.geometry.type!=="LineString")throw new Error("Self intersects only accepts Polygons and LineStrings");t=[n.geometry.coordinates]}const e=[];for(let s=0;s<t.length;s++)for(let o=0;o<t[s].length-1;o++)for(let a=0;a<t.length;a++)for(let l=0;l<t[a].length-1;l++)i(s,o,a,l);return e.length>0;function r(s){return s<0||s>1}function i(s,o,a,l){const c=t[s][o],u=t[s][o+1],h=t[a][l],f=t[a][l+1],d=function(v,E,m,g){if(Zc(v,m)||Zc(v,g)||Zc(E,m)||Zc(g,m))return null;const y=v[0],b=v[1],x=E[0],w=E[1],S=m[0],I=m[1],T=g[0],M=g[1],L=(y-x)*(I-M)-(b-w)*(S-T);return L===0?null:[((y*w-b*x)*(S-T)-(y-x)*(S*M-I*T))/L,((y*w-b*x)*(I-M)-(b-w)*(S*M-I*T))/L]}(c,u,h,f);if(d===null)return;let p,_;p=u[0]!==c[0]?(d[0]-c[0])/(u[0]-c[0]):(d[1]-c[1])/(u[1]-c[1]),_=f[0]!==h[0]?(d[0]-h[0])/(f[0]-h[0]):(d[1]-h[1])/(f[1]-h[1]),r(p)||r(_)||(d.toString(),e.push(d))}}function Zc(n,t){return n[0]===t[0]&&n[1]===t[1]}function fw(n,t){return $v(n[0])<=t&&$v(n[1])<=t}function $4(n){return n.length===2&&typeof n[0]=="number"&&typeof n[1]=="number"&&n[0]!==1/0&&n[1]!==1/0&&(e=n[0])>=-180&&e<=180&&(t=n[1])>=-90&&t<=90;var t,e}function $v(n){let t=1,e=0;for(;Math.round(n*t)/t!==n;)t*=10,e++;return e}const X4="Feature has holes",G4="Feature has less than 4 coordinates",Y4="Feature has invalid coordinates",q4="Feature coordinates are not closed";function K4(n,t){if(n.geometry.type!=="Polygon")return{valid:!1,reason:"Feature is not a Polygon"};if(n.geometry.coordinates.length!==1)return{valid:!1,reason:X4};if(n.geometry.coordinates[0].length<4)return{valid:!1,reason:G4};for(let i=0;i<n.geometry.coordinates[0].length;i++){if(!$4(n.geometry.coordinates[0][i]))return{valid:!1,reason:Y4};if(!fw(n.geometry.coordinates[0][i],t))return{valid:!1,reason:"Feature has coordinates with excessive precision"}}return(e=n.geometry.coordinates[0][0])[0]!==(r=n.geometry.coordinates[0][n.geometry.coordinates[0].length-1])[0]||e[1]!==r[1]?{valid:!1,reason:q4}:{valid:!0};var e,r}const Ci=(n,t)=>{const{x:e,y:r}=n,{x:i,y:s}=t,o=i-e,a=s-r;return Math.sqrt(a*a+o*o)};function Z4(n){if(!function(e){const r=e.coordinates[0];let i=0;for(let s=0;s<r.length-1;s++){const[o,a]=r[s],[l,c]=r[s+1];i+=(l-o)*(c+a)}return i<0}(n))return{type:"Polygon",coordinates:[n.coordinates[0].reverse()]}}const J4={cancel:"Escape",finish:"Enter"},Q4={start:"crosshair",close:"pointer"};class tU extends Dg{constructor(t){super(t,!0),this.mode="freehand",this.startingClick=!1,this.currentId=void 0,this.closingPointId=void 0,this.minDistance=20,this.keyEvents=J4,this.cursors=Q4,this.preventPointsNearClose=!0,this.autoClose=!1,this.autoCloseTimeout=500,this.hasLeftStartingPoint=!1,this.preventNewFeature=!1,this.updateOptions(t)}updateOptions(t){super.updateOptions(t),t!=null&&t.minDistance&&(this.minDistance=t.minDistance),t?.preventPointsNearClose!==void 0&&(this.preventPointsNearClose=t.preventPointsNearClose),t?.autoClose!==void 0&&(this.autoClose=t.autoClose),t!=null&&t.autoCloseTimeout&&(this.autoCloseTimeout=t.autoCloseTimeout),t?.keyEvents===null?this.keyEvents={cancel:null,finish:null}:t!=null&&t.keyEvents&&(this.keyEvents=Mn({},this.keyEvents,t.keyEvents)),t!=null&&t.cursors&&(this.cursors=Mn({},this.cursors,t.cursors))}close(){if(this.currentId===void 0)return;if(this.currentId){const e=Z4(this.store.getGeometryCopy(this.currentId));e&&this.store.updateGeometry([{id:this.currentId,geometry:e}]),this.store.updateProperty([{id:this.currentId,property:sn.CURRENTLY_DRAWING,value:void 0}])}const t=this.currentId;if(this.validate&&t){const e=this.store.getGeometryCopy(t);if(!this.validate({type:"Feature",id:t,geometry:e,properties:{}},{project:this.project,unproject:this.unproject,coordinatePrecision:this.coordinatePrecision,updateType:Di.Finish}).valid)return}this.closingPointId&&this.store.delete([this.closingPointId]),this.startingClick=!1,this.currentId=void 0,this.closingPointId=void 0,this.hasLeftStartingPoint=!1,this.state==="drawing"&&this.setStarted(),this.onFinish(t,{mode:this.mode,action:"draw"})}start(){this.setStarted(),this.setCursor(this.cursors.start)}stop(){this.cleanUp(),this.setStopped(),this.setCursor("unset")}onMouseMove(t){if(this.currentId===void 0||this.startingClick===!1)return void this.setCursor(this.cursors.start);const e=this.store.getGeometryCopy(this.currentId),r=e.coordinates[0].length-2,[i,s]=e.coordinates[0][r],{x:o,y:a}=this.project(i,s),l=Ci({x:o,y:a},{x:t.containerX,y:t.containerY}),[c,u]=e.coordinates[0][0],{x:h,y:f}=this.project(c,u);if(Ci({x:h,y:f},{x:t.containerX,y:t.containerY})<this.pointerDistance){if(this.autoClose&&this.hasLeftStartingPoint&&(this.preventNewFeature=!0,setTimeout(()=>{this.preventNewFeature=!1},this.autoCloseTimeout),this.close()),this.setCursor(this.cursors.close),this.preventPointsNearClose)return}else this.hasLeftStartingPoint=!0,this.setCursor(this.cursors.start);if(l<this.minDistance)return;e.coordinates[0].pop();const d={type:"Polygon",coordinates:[[...e.coordinates[0],[t.lng,t.lat],e.coordinates[0][0]]]};this.validate&&!this.validate({type:"Feature",id:this.currentId,geometry:d,properties:{}},{project:this.project,unproject:this.unproject,coordinatePrecision:this.coordinatePrecision,updateType:Di.Provisional}).valid||this.store.updateGeometry([{id:this.currentId,geometry:d}])}onClick(t){if(t.button==="right"&&this.allowPointerEvent(this.pointerEvents.rightClick,t)||t.button==="left"&&this.allowPointerEvent(this.pointerEvents.leftClick,t)||t.isContextMenu&&this.allowPointerEvent(this.pointerEvents.contextMenu,t)){if(this.preventNewFeature)return;if(this.startingClick===!1){const[e,r]=this.store.create([{geometry:{type:"Polygon",coordinates:[[[t.lng,t.lat],[t.lng,t.lat],[t.lng,t.lat],[t.lng,t.lat]]]},properties:{mode:this.mode,[sn.CURRENTLY_DRAWING]:!0}},{geometry:{type:"Point",coordinates:[t.lng,t.lat]},properties:{mode:this.mode,[sn.CLOSING_POINT]:!0}}]);return this.currentId=e,this.closingPointId=r,this.startingClick=!0,void(this.state!=="drawing"&&this.setDrawing())}this.close()}}onKeyDown(){}onKeyUp(t){t.key===this.keyEvents.cancel?this.cleanUp():t.key===this.keyEvents.finish&&this.startingClick===!0&&this.close()}onDragStart(){}onDrag(){}onDragEnd(){}cleanUp(){const t=this.currentId,e=this.closingPointId;this.closingPointId=void 0,this.currentId=void 0,this.startingClick=!1,this.state==="drawing"&&this.setStarted();try{t!==void 0&&this.store.delete([t]),e!==void 0&&this.store.delete([e])}catch{}}styleFeature(t){const e=Mn({},{polygonFillColor:"#3f97e0",polygonOutlineColor:"#3f97e0",polygonOutlineWidth:4,polygonFillOpacity:.3,pointColor:"#3f97e0",pointOutlineColor:"#ffffff",pointOutlineWidth:0,pointWidth:6,lineStringColor:"#3f97e0",lineStringWidth:4,zIndex:0,markerUrl:void 0,markerHeight:void 0,markerWidth:void 0});return t.type==="Feature"&&t.geometry.type==="Polygon"&&t.properties.mode===this.mode?(e.polygonFillColor=this.getHexColorStylingValue(this.styles.fillColor,e.polygonFillColor,t),e.polygonOutlineColor=this.getHexColorStylingValue(this.styles.outlineColor,e.polygonOutlineColor,t),e.polygonOutlineWidth=this.getNumericStylingValue(this.styles.outlineWidth,e.polygonOutlineWidth,t),e.polygonFillOpacity=this.getNumericStylingValue(this.styles.fillOpacity,e.polygonFillOpacity,t),e.zIndex=Eu,e):(t.type==="Feature"&&t.geometry.type==="Point"&&t.properties.mode===this.mode&&(e.pointWidth=this.getNumericStylingValue(this.styles.closingPointWidth,e.pointWidth,t),e.pointColor=this.getHexColorStylingValue(this.styles.closingPointColor,e.pointColor,t),e.pointOutlineColor=this.getHexColorStylingValue(this.styles.closingPointOutlineColor,e.pointOutlineColor,t),e.pointOutlineWidth=this.getNumericStylingValue(this.styles.closingPointOutlineWidth,2,t),e.zIndex=50),e)}validateFeature(t){return this.validateModeFeature(t,e=>K4(e,this.coordinatePrecision))}afterFeatureUpdated(t){this.currentId===t.id&&(this.closingPointId&&this.store.delete([this.closingPointId]),this.startingClick=!1,this.currentId=void 0,this.closingPointId=void 0,this.hasLeftStartingPoint=!1)}}class fr{constructor({store:t,mode:e,project:r,unproject:i,pointerDistance:s,coordinatePrecision:o,projection:a}){this.store=void 0,this.mode=void 0,this.project=void 0,this.unproject=void 0,this.pointerDistance=void 0,this.coordinatePrecision=void 0,this.projection=void 0,this.store=t,this.mode=e,this.project=r,this.unproject=i,this.pointerDistance=s,this.coordinatePrecision=o,this.projection=a}}function dw({unproject:n,point:t,pointerDistance:e}){const r=e/2,{x:i,y:s}=t;return{type:"Feature",properties:{},geometry:{type:"Polygon",coordinates:[[n(i-r,s-r),n(i+r,s-r),n(i+r,s+r),n(i-r,s+r),n(i-r,s-r)].map(o=>[o.lng,o.lat])]}}}class eU extends fr{constructor(t){super(t)}create(t){const{containerX:e,containerY:r}=t;return dw({unproject:this.unproject,point:{x:e,y:r},pointerDistance:this.pointerDistance})}}class nU extends fr{constructor(t){super(t)}measure(t,e){const{x:r,y:i}=this.project(e[0],e[1]);return Ci({x:r,y:i},{x:t.containerX,y:t.containerY})}}class rU extends fr{constructor(t,e,r){super(t),this.config=void 0,this.pixelDistance=void 0,this.clickBoundingBox=void 0,this.getSnappableCoordinateFirstClick=i=>this.getSnappable(i,s=>!!(s.properties&&s.properties.mode===this.mode)).coordinate,this.getSnappableCoordinate=(i,s)=>this.getSnappable(i,o=>!!(o.properties&&o.properties.mode===this.mode&&o.id!==s)).coordinate,this.config=t,this.pixelDistance=e,this.clickBoundingBox=r}getSnappable(t,e){const r=this.clickBoundingBox.create(t),i=this.store.search(r,e),s={featureId:void 0,featureCoordinateIndex:void 0,coordinate:void 0,minDist:1/0};return i.forEach(o=>{let a;if(o.geometry.type==="Polygon")a=o.geometry.coordinates[0];else{if(o.geometry.type!=="LineString")return;a=o.geometry.coordinates}a.forEach((l,c)=>{const u=this.pixelDistance.measure(t,l);u<s.minDist&&u<this.pointerDistance&&(s.coordinate=l,s.minDist=u,s.featureId=o.id,s.featureCoordinateIndex=c)})}),s}}function iU({x:n,y:t},{x:e,y:r}){const i=e-n,s=r-t;if(i===0&&s===0)return 0;let o=Math.atan2(s,i);return o*=180/Math.PI,o>180?o-=360:o<-180&&(o+=360),o}function Xv(n){return Math.sqrt(Math.pow(n[0],2)+Math.pow(n[1],2)+Math.pow(n[2],2))}function Ys(n,t){const e=function(r,i){const[s,o,a]=r,[l,c,u]=i;return s*l+o*c+a*u}(n,t)/(Xv(n)*Xv(t));return Math.acos(Math.min(Math.max(e,-1),1))}function nd(n){const t=so(n[1]),e=so(n[0]);return[Math.cos(t)*Math.cos(e),Math.cos(t)*Math.sin(e),Math.sin(t)]}function qs(n){const[t,e,r]=n,i=ap(Math.asin(r));return[ap(Math.atan2(e,t)),i]}function sU(n,t,e){const r=nd(n),i=nd(t),s=nd(e),[o,a,l]=s,[c,u,h]=function(M,L){const[O,P,V]=M,[C,R,D]=L;return[P*D-V*R,V*C-O*D,O*R-P*C]}(r,i),f=u*l-h*a,d=h*o-c*l,p=c*a-u*o,_=p*u-d*h,v=f*h-p*c,E=d*c-f*u,m=1/Math.sqrt(Math.pow(_,2)+Math.pow(v,2)+Math.pow(E,2)),g=[_*m,v*m,E*m],y=[-1*_*m,-1*v*m,-1*E*m],b=Ys(r,i),x=Ys(r,g),w=Ys(i,g),S=Ys(r,y),I=Ys(i,y);let T;return T=x<S&&x<I||w<S&&w<I?g:y,Ys(r,T)>b||Ys(i,T)>b?Ql(qs(T),qs(r))<=Ql(qs(T),qs(i))?[qs(r),!0,!1]:[qs(i),!1,!0]:[qs(T),!1,!1]}function oU(n,t,e){const r=t.x-n.x,i=t.y-n.y,s=Math.max(0,Math.min(1,((e.x-n.x)*r+(e.y-n.y)*i)/(r*r+i*i)));return{x:n.x+s*r,y:n.y+s*i}}class aU extends fr{constructor(t,e,r){super(t),this.config=void 0,this.pixelDistance=void 0,this.clickBoundingBox=void 0,this.getSnappableCoordinateFirstClick=i=>{const s=this.getSnappable(i,o=>!!(o.properties&&o.properties.mode===this.mode));return s.coordinate?[Me(s.coordinate[0],this.config.coordinatePrecision),Me(s.coordinate[1],this.config.coordinatePrecision)]:void 0},this.getSnappableCoordinate=(i,s)=>{const o=this.getSnappable(i,a=>!!(a.properties&&a.properties.mode===this.mode&&a.id!==s));return o.coordinate?[Me(o.coordinate[0],this.config.coordinatePrecision),Me(o.coordinate[1],this.config.coordinatePrecision)]:void 0},this.config=t,this.pixelDistance=e,this.clickBoundingBox=r}getSnappable(t,e){const r=this.clickBoundingBox.create(t),i=this.store.search(r,e),s={featureId:void 0,featureCoordinateIndex:void 0,coordinate:void 0,minDistance:1/0};return i.forEach(o=>{let a;if(o.geometry.type==="Polygon")a=o.geometry.coordinates[0];else{if(o.geometry.type!=="LineString")return;a=o.geometry.coordinates}const l=[];for(let f=0;f<a.length-1;f++)l.push([a[f],a[f+1]]);let c;const u=[t.lng,t.lat];if(this.config.projection==="web-mercator"?c=function(f,d){let p=[1/0,1/0],_=1/0,v=0;for(let E of d){const m=E[0],g=E[1];let y,b=1/0;const x=ye(m[0],m[1]),w=ye(g[0],g[1]),S=ye(f[0],f[1]);if(m[0]===f[0]&&m[1]===f[1])y=m;else if(g[0]===f[0]&&g[1]===f[1])y=g;else{const{x:I,y:T}=oU(x,w,S),{lng:M,lat:L}=Ha(I,T);y=[M,L]}y&&(b=Ci(S,ye(y[0],y[1])),b<_&&(p=y,_=b,v=d.indexOf(E)))}return _===1/0?void 0:{coordinate:p,lineIndex:v,distance:_}}(u,l):this.config.projection==="globe"&&(c=function(f,d){let p=[1/0,1/0],_=1/0,v=0;for(let E of d){const m=E[0],g=E[1];let y,b=1/0;m[0]===f[0]&&m[1]===f[1]?y=m:g[0]===f[0]&&g[1]===f[1]?y=g:[y]=sU(m,g,f),y&&(b=Ql(f,y),b<_&&(p=y,_=b,v=d.indexOf(E)))}return _===1/0?void 0:{coordinate:p,distance:_,lineIndex:v}}(u,l)),!c)return;const h=this.pixelDistance.measure(t,c.coordinate);h<s.minDistance&&h<this.pointerDistance&&(s.featureId=o.id,s.coordinate=[Me(c.coordinate[0],this.config.coordinatePrecision),Me(c.coordinate[1],this.config.coordinatePrecision)],s.featureCoordinateIndex=c.lineIndex,s.minDistance=h)}),s}}class lU extends fr{constructor(t){super(t)}createOrUpdate(t){const e=this.store.getGeometryCopy(t),r=this.store.getPropertiesCopy(t);let i;if(e.type==="Polygon")i=e.coordinates[0].slice(0,-1);else{if(e.type!=="LineString")return;i=e.coordinates}const s=this.store.getPropertiesCopy(t),o=s.coordinatePointIds;if(o)if(o&&o.every(a=>this.store.has(a))){const a=s.coordinatePointIds,l=a.map(c=>this.store.getGeometryCopy(c).coordinates);if(a.length!==i.length){this.deleteCoordinatePoints(a);const c=this.createPoints(i,r.mode,t);this.setFeatureCoordinatePoints(t,c)}else i.forEach((c,u)=>{c[0]===l[u][0]&&c[1]===l[u][1]||this.store.updateGeometry([{id:a[u],geometry:{type:"Point",coordinates:c}}])})}else{const a=o.filter(c=>this.store.has(c));a.length&&this.deleteCoordinatePoints(a);const l=this.createPoints(i,r.mode,t);this.setFeatureCoordinatePoints(t,l)}else{const a=this.createPoints(i,r.mode,t);this.setFeatureCoordinatePoints(t,a)}}deletePointsByFeatureIds(t){for(const e of t)this.deleteIfPresent(e)}getUpdated(t,e){const r=this.store.getPropertiesCopy(t);if(r.coordinatePointIds)return r.coordinatePointIds.map((i,s)=>({id:i,geometry:Mn({},this.store.getGeometryCopy(i),{coordinates:e[s]})}))}createPoints(t,e,r){return this.store.create(t.map((i,s)=>({geometry:{type:"Point",coordinates:i},properties:{mode:e,[sn.COORDINATE_POINT]:!0,[sn.COORDINATE_POINT_FEATURE_ID]:r,index:s}})))}setFeatureCoordinatePoints(t,e){this.store.updateProperty([{id:t,property:sn.COORDINATE_POINT_IDS,value:e}])}deleteCoordinatePoints(t){const e=t.filter(r=>this.store.has(r));this.store.delete(e)}deleteIfPresent(t){const e=this.store.getPropertiesCopy(t).coordinatePointIds;e&&(this.deleteCoordinatePoints(e),this.setFeatureCoordinatePoints(t,null))}}function lp(n,t){const e=n,r=t,i=so(e[1]),s=so(r[1]);let o=so(r[0]-e[0]);o>Math.PI&&(o-=2*Math.PI),o<-Math.PI&&(o+=2*Math.PI);const a=Math.log(Math.tan(s/2+Math.PI/4)/Math.tan(i/2+Math.PI/4)),l=(ap(Math.atan2(o,a))+360)%360;return l>180?-(360-l):l}function pw(n,t,e){let r=t;t<0&&(r=-Math.abs(r));const i=r/hw,s=n[0]*Math.PI/180,o=so(n[1]),a=so(e),l=i*Math.cos(a);let c=o+l;Math.abs(c)>Math.PI/2&&(c=c>0?Math.PI-c:-Math.PI-c);const u=Math.log(Math.tan(c/2+Math.PI/4)/Math.tan(o/2+Math.PI/4)),h=Math.abs(u)>1e-11?l/u:Math.cos(o),f=[(180*(s+i*Math.sin(a)/h)/Math.PI+540)%360-180,180*c/Math.PI];return f[0]+=f[0]-n[0]>180?-360:n[0]-f[0]>180?360:0,f}function cU(n,t,e,r,i){const s=r(n[0],n[1]),o=r(t[0],t[1]),{lng:a,lat:l}=i((s.x+o.x)/2,(s.y+o.y)/2);return[Me(a,e),Me(l,e)]}function uU(n,t,e){const r=pw(n,1e3*Ql(n,t)/2,lp(n,t));return[Me(r[0],e),Me(r[1],e)]}function Gv({featureCoords:n,precision:t,unproject:e,project:r,projection:i}){const s=[];for(let o=0;o<n.length-1;o++){let a;if(i==="web-mercator")a=cU(n[o],n[o+1],t,r,e);else{if(i!=="globe")throw new Error("Invalid projection");a=uU(n[o],n[o+1],t)}s.push(a)}return s}class hU extends fr{constructor(t,e,r){super(t),this.config=void 0,this.selectionPointBehavior=void 0,this.coordinatePointBehavior=void 0,this._midPoints=[],this.config=t,this.selectionPointBehavior=e,this.coordinatePointBehavior=r}get ids(){return this._midPoints.concat()}set ids(t){}insert(t,e,r){const i=this.store.getGeometryCopy(e),{midPointFeatureId:s,midPointSegment:o}=this.store.getPropertiesCopy(e),a=this.store.getGeometryCopy(s),l=a.type==="Polygon"?a.coordinates[0]:a.coordinates;l.splice(o+1,0,i.coordinates),a.coordinates=a.type==="Polygon"?[l]:l,this.store.updateGeometry([{id:s,geometry:a}]),this.store.getPropertiesCopy(t)[sn.COORDINATE_POINT_IDS]&&this.coordinatePointBehavior.createOrUpdate(t),this.store.delete([...this._midPoints,...this.selectionPointBehavior.ids]),this.create(l,s,r),this.selectionPointBehavior.create(l,a.type,s)}create(t,e,r){if(!this.store.has(e))throw new Error("Store does not have feature with this id");this._midPoints=this.store.create(function(i,s,o,a,l,c){return Gv({featureCoords:i,precision:o,project:a,unproject:l,projection:c}).map((u,h)=>({geometry:{type:"Point",coordinates:u},properties:s(h)}))}(t,i=>({mode:this.mode,[Ie.MID_POINT]:!0,midPointSegment:i,midPointFeatureId:e}),r,this.config.project,this.config.unproject,this.projection))}delete(){this._midPoints.length&&(this.store.delete(this._midPoints),this._midPoints=[])}getUpdated(t){if(this._midPoints.length!==0)return Gv({featureCoords:t,precision:this.coordinatePrecision,project:this.config.project,unproject:this.config.unproject,projection:this.config.projection}).map((e,r)=>({id:this._midPoints[r],geometry:{type:"Point",coordinates:e}}))}}class fU extends fr{constructor(t){super(t),this._selectionPoints=[]}get ids(){return this._selectionPoints.concat()}set ids(t){}create(t,e,r){this._selectionPoints=this.store.create(function(i,s,o){const a=[],l=s==="Polygon"?i.length-1:i.length;for(let c=0;c<l;c++)a.push({geometry:{type:"Point",coordinates:i[c]},properties:o(c)});return a}(t,e,i=>({mode:this.mode,index:i,[Ie.SELECTION_POINT]:!0,[Ie.SELECTION_POINT_FEATURE_ID]:r})))}delete(){this.ids.length&&(this.store.delete(this.ids),this._selectionPoints=[])}getUpdated(t){if(this._selectionPoints.length!==0)return this._selectionPoints.map((e,r)=>({id:e,geometry:{type:"Point",coordinates:t[r]}}))}getOneUpdated(t,e){if(this._selectionPoints[t]!==void 0)return{id:this._selectionPoints[t],geometry:{type:"Point",coordinates:e}}}}function gw(n,t){let e=!1;for(let o=0,a=t.length;o<a;o++){const l=t[o];for(let c=0,u=l.length,h=u-1;c<u;h=c++)(i=l[c])[1]>(r=n)[1]!=(s=l[h])[1]>r[1]&&r[0]<(s[0]-i[0])*(r[1]-i[1])/(s[1]-i[1])+i[0]&&(e=!e)}var r,i,s;return e}const cp=(n,t,e)=>{const r=s=>s*s,i=(s,o)=>r(s.x-o.x)+r(s.y-o.y);return Math.sqrt(((s,o,a)=>{const l=i(o,a);if(l===0)return i(s,o);let c=((s.x-o.x)*(a.x-o.x)+(s.y-o.y)*(a.y-o.y))/l;return c=Math.max(0,Math.min(1,c)),i(s,{x:o.x+c*(a.x-o.x),y:o.y+c*(a.y-o.y)})})(n,t,e))};class dU extends fr{constructor(t,e,r){super(t),this.config=void 0,this.createClickBoundingBox=void 0,this.pixelDistance=void 0,this.config=t,this.createClickBoundingBox=e,this.pixelDistance=r}find(t,e){let r,i,s,o,a=1/0,l=1/0,c=1/0;const u=this.createClickBoundingBox.create(t),h=this.store.search(u);for(let f=0;f<h.length;f++){const d=h[f],p=d.geometry;if(p.type==="Point"){if(d.properties.selectionPoint||d.properties.coordinatePoint||!e&&d.properties[Ie.MID_POINT])continue;const _=this.pixelDistance.measure(t,p.coordinates);d.properties[Ie.MID_POINT]&&_<this.pointerDistance&&_<c?(c=_,s=d):!d.properties[Ie.MID_POINT]&&_<this.pointerDistance&&_<a&&(a=_,r=d)}else if(p.type==="LineString"){if(r)continue;for(let _=0;_<p.coordinates.length-1;_++){const v=p.coordinates[_],E=p.coordinates[_+1],m=cp({x:t.containerX,y:t.containerY},this.project(v[0],v[1]),this.project(E[0],E[1]));m<this.pointerDistance&&m<l&&(l=m,i=d)}}else if(p.type==="Polygon"){if(r||i)continue;gw([t.lng,t.lat],p.coordinates)&&(o=d)}}return{clickedFeature:r||i||o,clickedMidPoint:s}}}class pU extends fr{constructor(t,e,r,i,s){super(t),this.config=void 0,this.featuresAtCursorEvent=void 0,this.selectionPoints=void 0,this.midPoints=void 0,this.coordinatePoints=void 0,this.draggedFeatureId=null,this.dragPosition=void 0,this.config=t,this.featuresAtCursorEvent=e,this.selectionPoints=r,this.midPoints=i,this.coordinatePoints=s}startDragging(t,e){this.draggedFeatureId=e,this.dragPosition=[t.lng,t.lat]}stopDragging(){this.draggedFeatureId=null,this.dragPosition=void 0}isDragging(){return this.draggedFeatureId!==null}canDrag(t,e){const{clickedFeature:r}=this.featuresAtCursorEvent.find(t,!0);return!(!r||r.id!==e)}drag(t,e){if(!this.draggedFeatureId)return;const r=this.store.getGeometryCopy(this.draggedFeatureId),i=[t.lng,t.lat];if(r.type==="Polygon"||r.type==="LineString"){let s,o;if(r.type==="Polygon"?(s=r.coordinates[0],o=s.length-1):(s=r.coordinates,o=s.length),!this.dragPosition)return!1;for(let u=0;u<o;u++){const h=s[u];let f,d;if(this.config.projection==="web-mercator"){const p=ye(this.dragPosition[0],this.dragPosition[1]),_=ye(i[0],i[1]),v=ye(h[0],h[1]),E={x:p.x-_.x,y:p.y-_.y},m=v.x-E.x,g=v.y-E.y,{lng:y,lat:b}=Ha(m,g);f=y,d=b}else{const p=[this.dragPosition[0]-i[0],this.dragPosition[1]-i[1]];f=h[0]-p[0],d=h[1]-p[1]}if(f=Me(f,this.config.coordinatePrecision),d=Me(d,this.config.coordinatePrecision),f>180||f<-180||d>90||d<-90)return!1;s[u]=[f,d]}r.type==="Polygon"&&(s[s.length-1]=[s[0][0],s[0][1]]);const a=this.selectionPoints.getUpdated(s)||[],l=this.midPoints.getUpdated(s)||[],c=this.coordinatePoints.getUpdated(this.draggedFeatureId,s)||[];if(e&&!e({type:"Feature",id:this.draggedFeatureId,geometry:r,properties:{}},{project:this.config.project,unproject:this.config.unproject,coordinatePrecision:this.config.coordinatePrecision,updateType:Di.Provisional}).valid)return!1;this.store.updateGeometry([{id:this.draggedFeatureId,geometry:r},...a,...l,...c]),this.dragPosition=[t.lng,t.lat]}else r.type==="Point"&&(this.store.updateGeometry([{id:this.draggedFeatureId,geometry:{type:"Point",coordinates:i}}]),this.dragPosition=[t.lng,t.lat])}}class gU extends fr{constructor(t,e,r,i,s,o,a){super(t),this.config=void 0,this.pixelDistance=void 0,this.selectionPoints=void 0,this.midPoints=void 0,this.coordinatePoints=void 0,this.coordinateSnapping=void 0,this.lineSnapping=void 0,this.draggedCoordinate={id:null,index:-1},this.config=t,this.pixelDistance=e,this.selectionPoints=r,this.midPoints=i,this.coordinatePoints=s,this.coordinateSnapping=o,this.lineSnapping=a}getClosestCoordinate(t,e){const r={dist:1/0,index:-1,isFirstOrLastPolygonCoord:!1};let i;if(e.type==="LineString")i=e.coordinates;else{if(e.type!=="Polygon")return r;i=e.coordinates[0]}for(let s=0;s<i.length;s++){const o=this.pixelDistance.measure(t,i[s]);if(o<this.pointerDistance&&o<r.dist){const a=e.type==="Polygon"&&(s===i.length-1||s===0);r.dist=o,r.index=a?0:s,r.isFirstOrLastPolygonCoord=a}}return r}getDraggableIndex(t,e){const r=this.store.getGeometryCopy(e),i=this.getClosestCoordinate(t,r);return i.index===-1?-1:i.index}snapCoordinate(t,e,r){let i=[t.lng,t.lat];const s=o=>!!(o.properties&&o.properties.mode===r.properties.mode&&o.id!==this.draggedCoordinate.id);if(e!=null&&e.toLine){let o;o=this.lineSnapping.getSnappable(t,s).coordinate,o&&(i=o)}if(e.toCoordinate){let o;o=this.coordinateSnapping.getSnappable(t,s).coordinate,o&&(i=o)}if(e!=null&&e.toCustom){let o;o=e.toCustom(t,{currentCoordinate:this.draggedCoordinate.index,currentId:r.id,getCurrentGeometrySnapshot:r.id?()=>this.store.getGeometryCopy(r.id):()=>null,project:this.project,unproject:this.unproject}),o&&(i=o)}return i}drag(t,e,r,i){const s=this.draggedCoordinate.id;if(s===null)return!1;const o=this.draggedCoordinate.index,a=this.store.getGeometryCopy(s),l=this.store.getPropertiesCopy(s),c=a.type==="LineString"?a.coordinates:a.coordinates[0],u=a.type==="Polygon"&&(o===c.length-1||o===0),h={type:"Feature",id:s,geometry:a,properties:l},f=this.snapCoordinate(t,i,h);if(t.lng>180||t.lng<-180||t.lat>90||t.lat<-90)return!1;if(u){const E=c.length-1;c[0]=f,c[E]=f}else c[o]=f;const d=this.selectionPoints.getOneUpdated(o,f),p=d?[d]:[],_=this.midPoints.getUpdated(c)||[],v=this.coordinatePoints.getUpdated(s,c)||[];return!(a.type!=="Point"&&!e&&j4({geometry:a})||r&&!r(h,{project:this.config.project,unproject:this.config.unproject,coordinatePrecision:this.config.coordinatePrecision,updateType:Di.Provisional}).valid||(this.store.updateGeometry([{id:s,geometry:a},...p,..._,...v]),0))}isDragging(){return this.draggedCoordinate.id!==null}startDragging(t,e){this.draggedCoordinate={id:t,index:e}}stopDragging(){this.draggedCoordinate={id:null,index:-1}}}function Yv(n){let t=0,e=0,r=0;return(n.geometry.type==="Polygon"?n.geometry.coordinates[0].slice(0,-1):n.geometry.coordinates).forEach(i=>{t+=i[0],e+=i[1],r++},!0),[t/r,e/r]}const mw=(n,t)=>{if(t===0||t===360||t===-360)return n;const e=.017453292519943295*t,r=(n.geometry.type==="Polygon"?n.geometry.coordinates[0]:n.geometry.coordinates).map(([o,a])=>ye(o,a)),i=r.reduce((o,a)=>({x:o.x+a.x,y:o.y+a.y}),{x:0,y:0});i.x/=r.length,i.y/=r.length;const s=r.map(o=>({x:i.x+(o.x-i.x)*Math.cos(e)-(o.y-i.y)*Math.sin(e),y:i.y+(o.x-i.x)*Math.sin(e)+(o.y-i.y)*Math.cos(e)})).map(({x:o,y:a})=>[Ha(o,a).lng,Ha(o,a).lat]);return n.geometry.type==="Polygon"?n.geometry.coordinates[0]=s:n.geometry.coordinates=s,n};function up(n){const t=(n.geometry.type==="Polygon"?n.geometry.coordinates[0]:n.geometry.coordinates).map(e=>{const{x:r,y:i}=ye(e[0],e[1]);return[r,i]});return n.geometry.type==="Polygon"?function(e){let r=0,i=0,s=0;const o=e.length;for(let a=0;a<o-1;a++){const[l,c]=e[a],[u,h]=e[a+1],f=l*h-u*c;r+=f,i+=(l+u)*f,s+=(c+h)*f}return r/=2,i/=6*r,s/=6*r,{x:i,y:s}}(t):function(e){const r=e.length;let i=0,s=0;for(let o=0;o<r;o++){const[a,l]=e[o];i+=a,s+=l}return{x:i/r,y:s/r}}(t)}class mU extends fr{constructor(t,e,r,i){super(t),this.config=void 0,this.selectionPoints=void 0,this.midPoints=void 0,this.coordinatePoints=void 0,this.lastBearing=void 0,this.selectedGeometry=void 0,this.selectedGeometryCentroid=void 0,this.selectedGeometryWebMercatorCentroid=void 0,this.config=t,this.selectionPoints=e,this.midPoints=r,this.coordinatePoints=i}reset(){this.lastBearing=void 0,this.selectedGeometry=void 0,this.selectedGeometryWebMercatorCentroid=void 0,this.selectedGeometryCentroid=void 0}rotate(t,e,r){this.selectedGeometry||(this.selectedGeometry=this.store.getGeometryCopy(e));const i=this.selectedGeometry;if(i.type!=="Polygon"&&i.type!=="LineString")return;const s=[t.lng,t.lat];let o;const a={type:"Feature",geometry:i,properties:{}};if(this.config.projection==="web-mercator"){this.selectedGeometryWebMercatorCentroid||(this.selectedGeometryWebMercatorCentroid=up(a));const f=ye(t.lng,t.lat);if(o=iU(this.selectedGeometryWebMercatorCentroid,f),o===0)return;if(!this.lastBearing)return void(this.lastBearing=o);mw(a,-(this.lastBearing-o))}else{if(this.config.projection!=="globe")throw new Error("Unsupported projection");if(this.selectedGeometryCentroid||(this.selectedGeometryCentroid=Yv({geometry:i})),o=lp(this.selectedGeometryCentroid,s),!this.lastBearing)return void(this.lastBearing=o+180);(function(f,d){if(d===0||d===360||d===-360)return f;const p=Yv(f);(f.geometry.type==="Polygon"?f.geometry.coordinates[0]:f.geometry.coordinates).forEach(_=>{const v=lp(p,_)+d,E=function(g,y){g[0]+=g[0]-y[0]>180?-360:y[0]-g[0]>180?360:0;const b=hw,x=y[1]*Math.PI/180,w=g[1]*Math.PI/180,S=w-x;let I=Math.abs(g[0]-y[0])*Math.PI/180;I>Math.PI&&(I-=2*Math.PI);const T=Math.log(Math.tan(w/2+Math.PI/4)/Math.tan(x/2+Math.PI/4)),M=Math.abs(T)>1e-11?S/T:Math.cos(x);return Math.sqrt(S*S+M*M*I*I)*b}(p,_),m=pw(p,E,v);_[0]=m[0],_[1]=m[1]})})(a,-(this.lastBearing-(o+180)))}const l=i.type==="Polygon"?i.coordinates[0]:i.coordinates;l.forEach(f=>{f[0]=Me(f[0],this.coordinatePrecision),f[1]=Me(f[1],this.coordinatePrecision)});const c=this.midPoints.getUpdated(l)||[],u=this.selectionPoints.getUpdated(l)||[],h=this.coordinatePoints.getUpdated(e,l)||[];if(r&&!r({id:e,type:"Feature",geometry:i,properties:{}},{project:this.config.project,unproject:this.config.unproject,coordinatePrecision:this.config.coordinatePrecision,updateType:Di.Provisional}))return!1;this.store.updateGeometry([{id:e,geometry:i},...u,...c,...h]),this.projection==="web-mercator"?this.lastBearing=o:this.projection==="globe"&&(this.lastBearing=o+180)}}class _U extends fr{constructor(t,e){super(t),this.config=void 0,this.dragCoordinateResizeBehavior=void 0,this.config=t,this.dragCoordinateResizeBehavior=e}scale(t,e,r){if(!this.dragCoordinateResizeBehavior.isDragging()){const i=this.dragCoordinateResizeBehavior.getDraggableIndex(t,e);this.dragCoordinateResizeBehavior.startDragging(e,i)}this.dragCoordinateResizeBehavior.drag(t,"center-fixed",r)}reset(){this.dragCoordinateResizeBehavior.stopDragging()}}function _w({coordinates:n,originX:t,originY:e,xScale:r,yScale:i}){r===1&&i===1||n.forEach(s=>{const{x:o,y:a}=ye(s[0],s[1]),l=t+(o-t)*r,c=e+(a-e)*i,{lng:u,lat:h}=Ha(l,c);s[0]=u,s[1]=h})}class yU extends fr{constructor(t,e,r,i,s){super(t),this.config=void 0,this.pixelDistance=void 0,this.selectionPoints=void 0,this.midPoints=void 0,this.coordinatePoints=void 0,this.minimumScale=1e-4,this.draggedCoordinate={id:null,index:-1},this.boundingBoxMaps={opposite:{0:4,1:5,2:6,3:7,4:0,5:1,6:2,7:3}},this.config=t,this.pixelDistance=e,this.selectionPoints=r,this.midPoints=i,this.coordinatePoints=s}getClosestCoordinate(t,e){const r={dist:1/0,index:-1,isFirstOrLastPolygonCoord:!1};let i;if(e.type==="LineString")i=e.coordinates;else{if(e.type!=="Polygon")return r;i=e.coordinates[0]}for(let s=0;s<i.length;s++){const o=this.pixelDistance.measure(t,i[s]);if(o<this.pointerDistance&&o<r.dist){const a=e.type==="Polygon"&&(s===i.length-1||s===0);r.dist=o,r.index=a?0:s,r.isFirstOrLastPolygonCoord=a}}return r}isValidDragWebMercator(t,e,r){switch(t){case 0:if(e<=0||r>=0)return!1;break;case 1:if(r>=0)return!1;break;case 2:if(e>=0||r>=0)return!1;break;case 3:if(e>=0)return!1;break;case 4:if(e>=0||r<=0)return!1;break;case 5:if(r<=0)return!1;break;case 6:if(e<=0||r<=0)return!1;break;case 7:if(e<=0)return!1}return!0}getSelectedFeatureDataWebMercator(){if(!this.draggedCoordinate.id||this.draggedCoordinate.index===-1)return null;const t=this.getFeature(this.draggedCoordinate.id);if(!t)return null;const e=this.getNormalisedCoordinates(t.geometry);return{boundingBox:this.getBBoxWebMercator(e),feature:t,updatedCoords:e,selectedCoordinate:e[this.draggedCoordinate.index]}}centerWebMercatorDrag(t){const e=this.getSelectedFeatureDataWebMercator();if(!e)return null;const{feature:r,boundingBox:i,updatedCoords:s,selectedCoordinate:o}=e,a=up(r);if(!a)return null;const l=ye(o[0],o[1]),{closestBBoxIndex:c}=this.getIndexesWebMercator(i,l),u=ye(t.lng,t.lat);return this.scaleWebMercator({closestBBoxIndex:c,updatedCoords:s,webMercatorCursor:u,webMercatorSelected:l,webMercatorOrigin:a}),s}centerFixedWebMercatorDrag(t){const e=this.getSelectedFeatureDataWebMercator();if(!e)return null;const{feature:r,boundingBox:i,updatedCoords:s,selectedCoordinate:o}=e,a=up(r);if(!a)return null;const l=ye(o[0],o[1]),{closestBBoxIndex:c}=this.getIndexesWebMercator(i,l),u=ye(t.lng,t.lat);return this.scaleFixedWebMercator({closestBBoxIndex:c,updatedCoords:s,webMercatorCursor:u,webMercatorSelected:l,webMercatorOrigin:a}),s}scaleFixedWebMercator({closestBBoxIndex:t,webMercatorOrigin:e,webMercatorSelected:r,webMercatorCursor:i,updatedCoords:s}){if(!this.isValidDragWebMercator(t,e.x-i.x,e.y-i.y))return null;let o=Ci(e,i)/Ci(e,r);return o<0&&(o=this.minimumScale),_w({coordinates:s,originX:e.x,originY:e.y,xScale:o,yScale:o}),s}oppositeFixedWebMercatorDrag(t){const e=this.getSelectedFeatureDataWebMercator();if(!e)return null;const{boundingBox:r,updatedCoords:i,selectedCoordinate:s}=e,o=ye(s[0],s[1]),{oppositeBboxIndex:a,closestBBoxIndex:l}=this.getIndexesWebMercator(r,o),c={x:r[a][0],y:r[a][1]},u=ye(t.lng,t.lat);return this.scaleFixedWebMercator({closestBBoxIndex:l,updatedCoords:i,webMercatorCursor:u,webMercatorSelected:o,webMercatorOrigin:c}),i}oppositeWebMercatorDrag(t){const e=this.getSelectedFeatureDataWebMercator();if(!e)return null;const{boundingBox:r,updatedCoords:i,selectedCoordinate:s}=e,o=ye(s[0],s[1]),{oppositeBboxIndex:a,closestBBoxIndex:l}=this.getIndexesWebMercator(r,o),c={x:r[a][0],y:r[a][1]},u=ye(t.lng,t.lat);return this.scaleWebMercator({closestBBoxIndex:l,updatedCoords:i,webMercatorCursor:u,webMercatorSelected:o,webMercatorOrigin:c}),i}scaleWebMercator({closestBBoxIndex:t,webMercatorOrigin:e,webMercatorSelected:r,webMercatorCursor:i,updatedCoords:s}){const o=e.x-i.x,a=e.y-i.y;if(!this.isValidDragWebMercator(t,o,a))return null;let l=1;o!==0&&t!==1&&t!==5&&(l=1-(e.x-r.x-o)/o);let c=1;return a!==0&&t!==3&&t!==7&&(c=1-(e.y-r.y-a)/a),this.validateScale(l,c)?(l<0&&(l=this.minimumScale),c<0&&(c=this.minimumScale),this.performWebMercatorScale(s,e.x,e.y,l,c),s):null}getFeature(t){if(this.draggedCoordinate.id===null)return null;const e=this.store.getGeometryCopy(t);return e.type!=="Polygon"&&e.type!=="LineString"?null:{id:t,type:"Feature",geometry:e,properties:{}}}getNormalisedCoordinates(t){return t.type==="Polygon"?t.coordinates[0]:t.coordinates}validateScale(t,e){const r=!isNaN(t)&&e<Number.MAX_SAFE_INTEGER,i=!isNaN(e)&&e<Number.MAX_SAFE_INTEGER;return r&&i}performWebMercatorScale(t,e,r,i,s){t.forEach(o=>{const{x:a,y:l}=ye(o[0],o[1]),c=e+(a-e)*i,u=r+(l-r)*s,{lng:h,lat:f}=Ha(c,u);o[0]=h,o[1]=f})}getBBoxWebMercator(t){const e=[1/0,1/0,-1/0,-1/0];(t=t.map(a=>{const{x:l,y:c}=ye(a[0],a[1]);return[l,c]})).forEach(([a,l])=>{a<e[0]&&(e[0]=a),l<e[1]&&(e[1]=l),a>e[2]&&(e[2]=a),l>e[3]&&(e[3]=l)});const[r,i,s,o]=e;return[[r,o],[(r+s)/2,o],[s,o],[s,o+(i-o)/2],[s,i],[(r+s)/2,i],[r,i],[r,o+(i-o)/2]]}getIndexesWebMercator(t,e){let r,i=1/0;for(let s=0;s<t.length;s++){const o=Ci({x:e.x,y:e.y},{x:t[s][0],y:t[s][1]});o<i&&(r=s,i=o)}if(r===void 0)throw new Error("No closest coordinate found");return{oppositeBboxIndex:this.boundingBoxMaps.opposite[r],closestBBoxIndex:r}}isDragging(){return this.draggedCoordinate.id!==null}startDragging(t,e){this.draggedCoordinate={id:t,index:e}}stopDragging(){this.draggedCoordinate={id:null,index:-1}}getDraggableIndex(t,e){const r=this.store.getGeometryCopy(e),i=this.getClosestCoordinate(t,r);return i.index===-1?-1:i.index}drag(t,e,r){if(!this.draggedCoordinate.id)return!1;const i=this.getFeature(this.draggedCoordinate.id);if(!i)return!1;let s=null;if(e==="center"?s=this.centerWebMercatorDrag(t):e==="opposite"?s=this.oppositeWebMercatorDrag(t):e==="center-fixed"?s=this.centerFixedWebMercatorDrag(t):e==="opposite-fixed"&&(s=this.oppositeFixedWebMercatorDrag(t)),!s)return!1;for(let u=0;u<s.length;u++){const h=s[u];if(h[0]=Me(h[0],this.coordinatePrecision),h[1]=Me(h[1],this.coordinatePrecision),!fw(h,this.coordinatePrecision))return!1}const o=this.midPoints.getUpdated(s)||[],a=this.selectionPoints.getUpdated(s)||[],l=this.coordinatePoints.getUpdated(i.id,s)||[],c={type:i.geometry.type,coordinates:i.geometry.type==="Polygon"?[s]:s};return!(r&&!r({id:this.draggedCoordinate.id,type:"Feature",geometry:c,properties:{}},{project:this.config.project,unproject:this.config.unproject,coordinatePrecision:this.config.coordinatePrecision,updateType:Di.Provisional}).valid||(this.store.updateGeometry([{id:this.draggedCoordinate.id,geometry:c},...a,...o,...l]),0))}}const vU={deselect:"Escape",delete:"Delete",rotate:["Control","r"],scale:["Control","s"]},qv={pointerOver:"move",dragStart:"move",dragEnd:"move",insertMidpoint:"crosshair"};class bU extends H4{constructor(t){super(t,!0),this.mode="select",this.allowManualDeselection=!0,this.dragEventThrottle=5,this.dragEventCount=0,this.selected=[],this.flags={},this.keyEvents=vU,this.cursors=qv,this.validations={},this.selectionPoints=void 0,this.midPoints=void 0,this.coordinateSnap=void 0,this.featuresAtMouseEvent=void 0,this.pixelDistance=void 0,this.clickBoundingBox=void 0,this.dragFeature=void 0,this.dragCoordinate=void 0,this.rotateFeature=void 0,this.scaleFeature=void 0,this.dragCoordinateResizeFeature=void 0,this.coordinatePoints=void 0,this.lineSnap=void 0,this.updateOptions(t)}updateOptions(t){if(super.updateOptions(t),this.cursors=t&&t.cursors?Mn({},this.cursors,t.cursors):qv,t?.keyEvents===null?this.keyEvents={deselect:null,delete:null,rotate:null,scale:null}:t!=null&&t.keyEvents&&(this.keyEvents=Mn({},this.keyEvents,t.keyEvents)),t?.dragEventThrottle!==void 0&&(this.dragEventThrottle=t.dragEventThrottle),t?.allowManualDeselection!==void 0&&(this.allowManualDeselection=t.allowManualDeselection),t!=null&&t.flags){this.flags=Mn({},this.flags,t.flags),this.validations={};for(const e in this.flags){const r=this.flags[e].feature;r&&r.validation&&(this.validations[e]=r.validation)}}}selectFeature(t){this.select(t,!1)}setSelecting(){if(this._state!=="started")throw new Error("Mode must be started to move to selecting state");this._state="selecting"}registerBehaviors(t){this.pixelDistance=new nU(t),this.clickBoundingBox=new eU(t),this.featuresAtMouseEvent=new dU(t,this.clickBoundingBox,this.pixelDistance),this.selectionPoints=new fU(t),this.coordinatePoints=new lU(t),this.midPoints=new hU(t,this.selectionPoints,this.coordinatePoints),this.coordinateSnap=new rU(t,this.pixelDistance,this.clickBoundingBox),this.lineSnap=new aU(t,this.pixelDistance,this.clickBoundingBox),this.rotateFeature=new mU(t,this.selectionPoints,this.midPoints,this.coordinatePoints),this.dragFeature=new pU(t,this.featuresAtMouseEvent,this.selectionPoints,this.midPoints,this.coordinatePoints),this.dragCoordinate=new gU(t,this.pixelDistance,this.selectionPoints,this.midPoints,this.coordinatePoints,this.coordinateSnap,this.lineSnap),this.dragCoordinateResizeFeature=new yU(t,this.pixelDistance,this.selectionPoints,this.midPoints,this.coordinatePoints),this.scaleFeature=new _U(t,this.dragCoordinateResizeFeature)}deselectFeature(){this.deselect()}deselect(){const t=this.selected.filter(e=>this.store.has(e)).map(e=>({id:e,property:Ie.SELECTED,value:!1}));this.store.updateProperty(t),this.onDeselect(this.selected[0]),this.selected=[],this.selectionPoints.delete(),this.midPoints.delete()}deleteSelected(){this.store.delete(this.selected),this.selected=[]}onRightClick(t){if(!this.selectionPoints.ids.length)return;let e,r=1/0;if(this.selectionPoints.ids.forEach(f=>{const d=this.store.getGeometryCopy(f),p=this.pixelDistance.measure(t,d.coordinates);p<this.pointerDistance&&p<r&&(r=p,e=this.store.getPropertiesCopy(f))}),!e)return;const i=e.selectionPointFeatureId,s=e.index,o=this.store.getPropertiesCopy(i),a=this.flags[o.mode],l=this.validations[o.mode];if(!(a&&a.feature&&a.feature.coordinates&&a.feature.coordinates.deletable))return;const c=this.store.getGeometryCopy(i);let u;if(c.type==="Polygon"){if(u=c.coordinates[0],u.length<=4)return}else if(c.type==="LineString"&&(u=c.coordinates,u.length<=2))return;if(!u||(c.type!=="Polygon"||s!==0&&s!==u.length-1?u.splice(s,1):(u.shift(),u.pop(),u.push([u[0][0],u[0][1]])),l&&!l({id:i,type:"Feature",geometry:c,properties:o},{project:this.project,unproject:this.unproject,coordinatePrecision:this.coordinatePrecision,updateType:Di.Commit}).valid))return;const h=[...this.midPoints.ids,...this.selectionPoints.ids];this.store.delete(h),this.store.updateGeometry([{id:i,geometry:c}]),o.coordinatePointIds&&this.coordinatePoints.createOrUpdate(i),this.selectionPoints.create(u,c.type,i),a&&a.feature&&a.feature.coordinates&&a.feature.coordinates.midpoints&&this.midPoints.create(u,i,this.coordinatePrecision)}select(t,e=!0){if(this.selected[0]===t)return;const{mode:r}=this.store.getPropertiesCopy(t),i=this.flags[r];if(!i||!i.feature)return;const s=this.selected[0];if(s){if(s===t)return;this.deselect()}e&&this.setCursor(this.cursors.pointerOver),this.selected=[t],this.store.updateProperty([{id:t,property:Ie.SELECTED,value:!0}]),this.onSelect(t);const{type:o,coordinates:a}=this.store.getGeometryCopy(t);if(o!=="LineString"&&o!=="Polygon")return;const l=o==="LineString"?a:a[0];l&&i&&i.feature.coordinates&&(this.selectionPoints.create(l,o,t),i.feature.coordinates.midpoints&&this.midPoints.create(l,t,this.coordinatePrecision))}onLeftClick(t){const{clickedFeature:e,clickedMidPoint:r}=this.featuresAtMouseEvent.find(t,this.selected.length>0);if(this.selected.length&&r)this.midPoints.insert(this.selected[0],r.id,this.coordinatePrecision);else if(e&&e.id)this.select(e.id,!0);else if(this.selected.length&&this.allowManualDeselection)return void this.deselect()}start(){this.setStarted(),this.setSelecting()}stop(){this.cleanUp(),this.setStarted(),this.setStopped()}onClick(t){t.button==="right"&&this.allowPointerEvent(this.pointerEvents.rightClick,t)||t.isContextMenu&&this.allowPointerEvent(this.pointerEvents.contextMenu,t)?this.onRightClick(t):t.button==="left"&&this.allowPointerEvent(this.pointerEvents.leftClick,t)&&this.onLeftClick(t)}canScale(t){return this.keyEvents.scale&&this.keyEvents.scale.every(e=>t.heldKeys.includes(e))}canRotate(t){return this.keyEvents.rotate&&this.keyEvents.rotate.every(e=>t.heldKeys.includes(e))}preventDefaultKeyEvent(t){const e=this.canRotate(t),r=this.canScale(t);(e||r)&&t.preventDefault()}onKeyDown(t){this.preventDefaultKeyEvent(t)}onKeyUp(t){if(this.preventDefaultKeyEvent(t),this.keyEvents.delete&&t.key===this.keyEvents.delete){if(!this.selected.length)return;const e=this.selected[0];this.onDeselect(this.selected[0]),this.coordinatePoints.deletePointsByFeatureIds([e]),this.deleteSelected(),this.selectionPoints.delete(),this.midPoints.delete()}else this.keyEvents.deselect&&t.key===this.keyEvents.deselect&&this.cleanUp()}cleanUp(){this.selected.length&&this.deselect()}onDragStart(t,e){if(!this.allowPointerEvent(this.pointerEvents.onDragStart,t)||!this.selected.length)return;const r=this.store.getPropertiesCopy(this.selected[0]),i=this.flags[r.mode];if(!(i&&i.feature&&(i.feature.draggable||i.feature.coordinates&&i.feature.coordinates.draggable||i.feature.coordinates&&i.feature.coordinates.resizable||i.feature.coordinates&&typeof i.feature.coordinates.midpoints=="object"&&i.feature.coordinates.midpoints.draggable)))return;this.dragEventCount=0;const s=this.selected[0],o=this.dragCoordinate.getDraggableIndex(t,s);if(i&&i.feature&&i.feature.coordinates&&(i.feature.coordinates.draggable||i.feature.coordinates.resizable)&&o!==-1)return this.setCursor(this.cursors.dragStart),i.feature.coordinates.resizable?this.dragCoordinateResizeFeature.startDragging(s,o):this.dragCoordinate.startDragging(s,o),void e(!1);if(i&&i.feature&&i.feature.coordinates&&typeof i.feature.coordinates.midpoints=="object"&&i.feature.coordinates.midpoints.draggable){const{clickedMidPoint:a}=this.featuresAtMouseEvent.find(t,this.selected.length>0);if(this.selected.length&&a){this.midPoints.insert(s,a.id,this.coordinatePrecision);const l=this.dragCoordinate.getDraggableIndex(t,s);return this.dragCoordinate.startDragging(s,l),void e(!1)}}return i&&i.feature&&i.feature.draggable&&this.dragFeature.canDrag(t,s)?(this.setCursor(this.cursors.dragStart),this.dragFeature.startDragging(t,s),void e(!1)):void 0}onDrag(t,e){if(!this.allowPointerEvent(this.pointerEvents.onDrag,t))return;const r=this.selected[0];if(!r)return;const i=this.store.getPropertiesCopy(r),s=this.flags[i.mode],o=(s&&s.feature&&s.feature.selfIntersectable)===!0;if(this.dragEventCount++,this.dragEventCount%this.dragEventThrottle==0)return;const a=this.validations[i.mode];if(s&&s.feature&&s.feature.rotateable&&this.canRotate(t))return e(!1),void this.rotateFeature.rotate(t,r,a);if(s&&s.feature&&s.feature.scaleable&&this.canScale(t))return e(!1),void this.scaleFeature.scale(t,r,a);if(this.dragCoordinateResizeFeature.isDragging()&&s.feature&&s.feature.coordinates&&s.feature.coordinates.resizable){if(this.projection==="globe")throw new Error("Globe is currently unsupported projection for resizable");return e(!1),void this.dragCoordinateResizeFeature.drag(t,s.feature.coordinates.resizable,a)}if(this.dragCoordinate.isDragging()){var l;const c=(l=s.feature)==null||(l=l.coordinates)==null?void 0:l.snappable;let u={toCoordinate:!1};return c===!0?u={toCoordinate:!0}:typeof c=="object"&&(u=c),void this.dragCoordinate.drag(t,o,a,u)}this.dragFeature.isDragging()?this.dragFeature.drag(t,a):e(!0)}onDragEnd(t,e){this.allowPointerEvent(this.pointerEvents.onDragEnd,t)&&(this.setCursor(this.cursors.dragEnd),this.dragCoordinate.isDragging()?this.onFinish(this.selected[0],{mode:this.mode,action:"dragCoordinate"}):this.dragFeature.isDragging()?this.onFinish(this.selected[0],{mode:this.mode,action:"dragFeature"}):this.dragCoordinateResizeFeature.isDragging()&&this.onFinish(this.selected[0],{mode:this.mode,action:"dragCoordinateResize"}),this.dragCoordinate.stopDragging(),this.dragFeature.stopDragging(),this.dragCoordinateResizeFeature.stopDragging(),this.rotateFeature.reset(),this.scaleFeature.reset(),e(!0))}onMouseMove(t){if(!this.selected.length)return void this.setCursor("unset");if(this.dragFeature.isDragging())return;let e=!1;this.midPoints.ids.forEach(s=>{if(e)return;const o=this.store.getGeometryCopy(s);this.pixelDistance.measure(t,o.coordinates)<this.pointerDistance&&(e=!0)});let r=!1;if(this.selectionPoints.ids.forEach(s=>{const o=this.store.getGeometryCopy(s);this.pixelDistance.measure(t,o.coordinates)<this.pointerDistance&&(e=!1,r=!0)}),e)return void this.setCursor(this.cursors.insertMidpoint);const{clickedFeature:i}=this.featuresAtMouseEvent.find(t,!0);this.setCursor(this.selected.length>0&&(i&&i.id===this.selected[0]||r)?this.cursors.pointerOver:"unset")}styleFeature(t){const e=Mn({},{polygonFillColor:"#3f97e0",polygonOutlineColor:"#3f97e0",polygonOutlineWidth:4,polygonFillOpacity:.3,pointColor:"#3f97e0",pointOutlineColor:"#ffffff",pointOutlineWidth:0,pointWidth:6,lineStringColor:"#3f97e0",lineStringWidth:4,zIndex:0,markerUrl:void 0,markerHeight:void 0,markerWidth:void 0});if(t.properties.mode===this.mode&&t.geometry.type==="Point"){if(t.properties[Ie.SELECTION_POINT])return e.pointColor=this.getHexColorStylingValue(this.styles.selectionPointColor,e.pointColor,t),e.pointOutlineColor=this.getHexColorStylingValue(this.styles.selectionPointOutlineColor,e.pointOutlineColor,t),e.pointWidth=this.getNumericStylingValue(this.styles.selectionPointWidth,e.pointWidth,t),e.pointOutlineWidth=this.getNumericStylingValue(this.styles.selectionPointOutlineWidth,2,t),e.zIndex=30,e;if(t.properties[Ie.MID_POINT])return e.pointColor=this.getHexColorStylingValue(this.styles.midPointColor,e.pointColor,t),e.pointOutlineColor=this.getHexColorStylingValue(this.styles.midPointOutlineColor,e.pointOutlineColor,t),e.pointWidth=this.getNumericStylingValue(this.styles.midPointWidth,4,t),e.pointOutlineWidth=this.getNumericStylingValue(this.styles.midPointOutlineWidth,2,t),e.zIndex=50,e}else if(t.properties[Ie.SELECTED]){if(t.geometry.type==="Point"&&t.properties[sn.MARKER])return e.markerUrl=this.getUrlStylingValue(this.styles.selectedMarkerUrl,V4,t),e.markerHeight=this.getNumericStylingValue(this.styles.selectedMarkerHeight,40,t),e.markerWidth=this.getNumericStylingValue(this.styles.selectedMarkerWidth,32,t),e;if(t.geometry.type==="Polygon")return e.polygonFillColor=this.getHexColorStylingValue(this.styles.selectedPolygonColor,e.polygonFillColor,t),e.polygonOutlineWidth=this.getNumericStylingValue(this.styles.selectedPolygonOutlineWidth,e.polygonOutlineWidth,t),e.polygonOutlineColor=this.getHexColorStylingValue(this.styles.selectedPolygonOutlineColor,e.polygonOutlineColor,t),e.polygonFillOpacity=this.getNumericStylingValue(this.styles.selectedPolygonFillOpacity,e.polygonFillOpacity,t),e.zIndex=Eu,e;if(t.geometry.type==="LineString")return e.lineStringColor=this.getHexColorStylingValue(this.styles.selectedLineStringColor,e.lineStringColor,t),e.lineStringWidth=this.getNumericStylingValue(this.styles.selectedLineStringWidth,e.lineStringWidth,t),e.zIndex=Eu,e;if(t.geometry.type==="Point")return e.pointWidth=this.getNumericStylingValue(this.styles.selectedPointWidth,e.pointWidth,t),e.pointColor=this.getHexColorStylingValue(this.styles.selectedPointColor,e.pointColor,t),e.pointOutlineColor=this.getHexColorStylingValue(this.styles.selectedPointOutlineColor,e.pointOutlineColor,t),e.pointOutlineWidth=this.getNumericStylingValue(this.styles.selectedPointOutlineWidth,e.pointOutlineWidth,t),e.zIndex=Eu,e}return e}afterFeatureUpdated(t){if(this.selected.length&&t.id===this.selected[0]){var e,r;const i=this.flags[t.properties.mode];if(i==null||(e=i.feature)==null||!e.coordinates)return;const s=t.geometry.type,o=t.id;let a;if(this.selectionPoints.delete(),this.midPoints.delete(),s==="Polygon")a=t.geometry.coordinates[0];else{if(s!=="LineString")return;a=t.geometry.coordinates}this.selectionPoints.create(a,s,o),i!=null&&(r=i.feature)!=null&&(r=r.coordinates)!=null&&r.midpoints&&this.midPoints.create(s==="Polygon"?t.geometry.coordinates[0]:t.geometry.coordinates,o,this.coordinatePrecision)}}}class xU extends Dg{constructor(...t){super(...t),this.type=Wa.Static,this.mode="static"}start(){}stop(){}onKeyUp(){}onKeyDown(){}onClick(){}onDragStart(){}onDrag(){}onDragEnd(){}onMouseMove(){}cleanUp(){}styleFeature(){return Mn({},{polygonFillColor:"#3f97e0",polygonOutlineColor:"#3f97e0",polygonOutlineWidth:4,polygonFillOpacity:.3,pointColor:"#3f97e0",pointOutlineColor:"#ffffff",pointOutlineWidth:0,pointWidth:6,lineStringColor:"#3f97e0",lineStringWidth:4,zIndex:0,markerUrl:void 0,markerHeight:void 0,markerWidth:void 0})}}function yw(n,t,e,r,i){for(;r>e;){if(r-e>600){const l=r-e+1,c=t-e+1,u=Math.log(l),h=.5*Math.exp(2*u/3),f=.5*Math.sqrt(u*h*(l-h)/l)*(c-l/2<0?-1:1);yw(n,t,Math.max(e,Math.floor(t-c*h/l+f)),Math.min(r,Math.floor(t+(l-c)*h/l+f)),i)}const s=n[t];let o=e,a=r;for(ol(n,e,t),i(n[r],s)>0&&ol(n,e,r);o<a;){for(ol(n,o,a),o++,a--;i(n[o],s)<0;)o++;for(;i(n[a],s)>0;)a--}i(n[e],s)===0?ol(n,e,a):(a++,ol(n,a,r)),a<=t&&(e=a+1),t<=a&&(r=a-1)}}function ol(n,t,e){const r=n[t];n[t]=n[e],n[e]=r}function Xo(n,t){gl(n,0,n.children.length,t,n)}function gl(n,t,e,r,i){i||(i=qo([])),i.minX=1/0,i.minY=1/0,i.maxX=-1/0,i.maxY=-1/0;for(let s=t;s<e;s++){const o=n.children[s];ml(i,n.leaf?r(o):o)}return i}function ml(n,t){return n.minX=Math.min(n.minX,t.minX),n.minY=Math.min(n.minY,t.minY),n.maxX=Math.max(n.maxX,t.maxX),n.maxY=Math.max(n.maxY,t.maxY),n}function EU(n,t){return n.minX-t.minX}function wU(n,t){return n.minY-t.minY}function rd(n){return(n.maxX-n.minX)*(n.maxY-n.minY)}function Jc(n){return n.maxX-n.minX+(n.maxY-n.minY)}function SU(n,t){const e=Math.max(n.minX,t.minX),r=Math.max(n.minY,t.minY),i=Math.min(n.maxX,t.maxX),s=Math.min(n.maxY,t.maxY);return Math.max(0,i-e)*Math.max(0,s-r)}function id(n,t){return n.minX<=t.minX&&n.minY<=t.minY&&t.maxX<=n.maxX&&t.maxY<=n.maxY}function Qc(n,t){return t.minX<=n.maxX&&t.minY<=n.maxY&&t.maxX>=n.minX&&t.maxY>=n.minY}function qo(n){return{children:n,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function Kv(n,t,e,r,i){const s=[t,e];for(;s.length;){if((e=s.pop())-(t=s.pop())<=r)continue;const o=t+Math.ceil((e-t)/r/2)*r;yw(n,o,t,e,i),s.push(t,o,o,e)}}class CU{constructor(t){this._maxEntries=void 0,this._minEntries=void 0,this.data=void 0,this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()}search(t){let e=this.data;const r=[];if(!Qc(t,e))return r;const i=this.toBBox,s=[];for(;e;){for(let o=0;o<e.children.length;o++){const a=e.children[o],l=e.leaf?i(a):a;Qc(t,l)&&(e.leaf?r.push(a):id(t,l)?this._all(a,r):s.push(a))}e=s.pop()}return r}collides(t){let e=this.data;if(Qc(t,e)){const r=[];for(;e;){for(let i=0;i<e.children.length;i++){const s=e.children[i],o=e.leaf?this.toBBox(s):s;if(Qc(t,o)){if(e.leaf||id(t,o))return!0;r.push(s)}}e=r.pop()}}return!1}load(t){if(t.length<this._minEntries){for(let r=0;r<t.length;r++)this.insert(t[r]);return}let e=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===e.height)this._splitRoot(this.data,e);else{if(this.data.height<e.height){const r=this.data;this.data=e,e=r}this._insert(e,this.data.height-e.height-1,!0)}else this.data=e}insert(t){this._insert(t,this.data.height-1)}clear(){this.data=qo([])}remove(t){let e=this.data;const r=this.toBBox(t),i=[],s=[];let o,a,l=!1;for(;e||i.length;){if(e||(e=i.pop(),a=i[i.length-1],o=s.pop(),l=!0),e.leaf){const c=e.children.indexOf(t);c!==-1&&(e.children.splice(c,1),i.push(e),this._condense(i))}l||e.leaf||!id(e,r)?a?(o++,e=a.children[o],l=!1):e=null:(i.push(e),s.push(o),o=0,a=e,e=e.children[0])}}toBBox(t){return t}compareMinX(t,e){return t.minX-e.minX}compareMinY(t,e){return t.minY-e.minY}_all(t,e){const r=[];for(;t;)t.leaf?e.push(...t.children):r.push(...t.children),t=r.pop();return e}_build(t,e,r,i){const s=r-e+1;let o,a=this._maxEntries;if(s<=a)return o=qo(t.slice(e,r+1)),Xo(o,this.toBBox),o;i||(i=Math.ceil(Math.log(s)/Math.log(a)),a=Math.ceil(s/Math.pow(a,i-1))),o=qo([]),o.leaf=!1,o.height=i;const l=Math.ceil(s/a),c=l*Math.ceil(Math.sqrt(a));Kv(t,e,r,c,this.compareMinX);for(let u=e;u<=r;u+=c){const h=Math.min(u+c-1,r);Kv(t,u,h,l,this.compareMinY);for(let f=u;f<=h;f+=l){const d=Math.min(f+l-1,h);o.children.push(this._build(t,f,d,i-1))}}return Xo(o,this.toBBox),o}_chooseSubtree(t,e,r,i){for(;i.push(e),!e.leaf&&i.length-1!==r;){let a,l=1/0,c=1/0;for(let u=0;u<e.children.length;u++){const h=e.children[u],f=rd(h),d=(s=t,o=h,(Math.max(o.maxX,s.maxX)-Math.min(o.minX,s.minX))*(Math.max(o.maxY,s.maxY)-Math.min(o.minY,s.minY))-f);d<c?(c=d,l=f<l?f:l,a=h):d===c&&f<l&&(l=f,a=h)}e=a||e.children[0]}var s,o;return e}_insert(t,e,r){const i=r?t:this.toBBox(t),s=[],o=this._chooseSubtree(i,this.data,e,s);for(o.children.push(t),ml(o,i);e>=0&&s[e].children.length>this._maxEntries;)this._split(s,e),e--;this._adjustParentBBoxes(i,s,e)}_split(t,e){const r=t[e],i=r.children.length,s=this._minEntries;this._chooseSplitAxis(r,s,i);const o=this._chooseSplitIndex(r,s,i),a=qo(r.children.splice(o,r.children.length-o));a.height=r.height,a.leaf=r.leaf,Xo(r,this.toBBox),Xo(a,this.toBBox),e?t[e-1].children.push(a):this._splitRoot(r,a)}_splitRoot(t,e){this.data=qo([t,e]),this.data.height=t.height+1,this.data.leaf=!1,Xo(this.data,this.toBBox)}_chooseSplitIndex(t,e,r){let i,s=1/0,o=1/0;for(let a=e;a<=r-e;a++){const l=gl(t,0,a,this.toBBox),c=gl(t,a,r,this.toBBox),u=SU(l,c),h=rd(l)+rd(c);u<s?(s=u,i=a,o=h<o?h:o):u===s&&h<o&&(o=h,i=a)}return i||r-e}_chooseSplitAxis(t,e,r){const i=t.leaf?this.compareMinX:EU,s=t.leaf?this.compareMinY:wU;this._allDistMargin(t,e,r,i)<this._allDistMargin(t,e,r,s)&&t.children.sort(i)}_allDistMargin(t,e,r,i){t.children.sort(i);const s=this.toBBox,o=gl(t,0,e,s),a=gl(t,r-e,r,s);let l=Jc(o)+Jc(a);for(let c=e;c<r-e;c++){const u=t.children[c];ml(o,t.leaf?s(u):u),l+=Jc(o)}for(let c=r-e-1;c>=e;c--){const u=t.children[c];ml(a,t.leaf?s(u):u),l+=Jc(a)}return l}_adjustParentBBoxes(t,e,r){for(let i=r;i>=0;i--)ml(e[i],t)}_condense(t){for(let e,r=t.length-1;r>=0;r--)t[r].children.length===0?r>0?(e=t[r-1].children,e.splice(e.indexOf(t[r]),1)):this.clear():Xo(t[r],this.toBBox)}}class TU{constructor(t){this.tree=void 0,this.idToNode=void 0,this.nodeToId=void 0,this.tree=new CU(t&&t.maxEntries?t.maxEntries:9),this.idToNode=new Map,this.nodeToId=new Map}setMaps(t,e){this.idToNode.set(t.id,e),this.nodeToId.set(e,t.id)}toBBox(t){const e=[],r=[];let i;if(t.geometry.type==="Polygon")i=t.geometry.coordinates[0];else if(t.geometry.type==="LineString")i=t.geometry.coordinates;else{if(t.geometry.type!=="Point")throw new Error("Not a valid feature to turn into a bounding box");i=[t.geometry.coordinates]}for(let a=0;a<i.length;a++)r.push(i[a][1]),e.push(i[a][0]);const s=Math.min(...r),o=Math.max(...r);return{minX:Math.min(...e),minY:s,maxX:Math.max(...e),maxY:o}}insert(t){if(this.idToNode.get(String(t.id)))throw new Error("Feature already exists");const e=this.toBBox(t);this.setMaps(t,e),this.tree.insert(e)}load(t){const e=[],r=new Set;t.forEach(i=>{const s=this.toBBox(i);if(this.setMaps(i,s),r.has(String(i.id)))throw new Error(`Duplicate feature ID found ${i.id}`);r.add(String(i.id)),e.push(s)}),this.tree.load(e)}update(t){this.remove(t.id);const e=this.toBBox(t);this.setMaps(t,e),this.tree.insert(e)}remove(t){const e=this.idToNode.get(t);if(!e)throw new Error(`${t} not inserted into the spatial index`);this.tree.remove(e)}clear(){this.tree.clear()}search(t){return this.tree.search(this.toBBox(t)).map(e=>this.nodeToId.get(e))}collides(t){return this.tree.collides(this.toBBox(t))}}const PU={getId:()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){const t=16*Math.random()|0;return(n=="x"?t:3&t|8).toString(16)}),isValidId:n=>typeof n=="string"&&n.length===36};class IU{constructor(t){this.idStrategy=void 0,this.tracked=void 0,this.spatialIndex=void 0,this.store=void 0,this._onChange=()=>{},this.store={},this.spatialIndex=new TU,this.tracked=!t||t.tracked!==!1,this.idStrategy=t&&t.idStrategy?t.idStrategy:PU}clone(t){return JSON.parse(JSON.stringify(t))}getId(){return this.idStrategy.getId()}has(t){return!!this.store[t]}load(t,e,r,i){if(t.length===0)return[];let s=this.clone(t);const o=[],a=[];s=s.filter(c=>{c.id==null&&(c.id=this.idStrategy.getId());const u=c.id;if(e){const h=e(c);if(!h.valid)return o.push({id:u,valid:!1,reason:h.reason}),!1}if(this.tracked){if(c.properties.createdAt){if(!Wv(c.properties.createdAt))return o.push({id:c.id,valid:!1,reason:"createdAt is not a valid numeric timestamp"}),!1}else c.properties.createdAt=+new Date;if(c.properties.updatedAt){if(!Wv(c.properties.updatedAt))return o.push({id:c.id,valid:!1,reason:"updatedAt is not a valid numeric timestamp"}),!1}else c.properties.updatedAt=+new Date}return this.has(u)?(o.push({id:u,valid:!1,reason:`Feature already exists with this id: ${u}`}),!1):(this.store[u]=c,a.push(c),o.push({id:u,valid:!0}),!0)}),this.spatialIndex.load(s);const l=a.map(({id:c})=>c);return l.length>0&&(this._onChange(l,"create",i),r&&a.forEach(c=>{r(c)})),o}search(t,e){const r=this.spatialIndex.search(t).map(i=>this.store[i]);return this.clone(e?r.filter(e):r)}registerOnChange(t){this._onChange=(e,r,i)=>{t(e,r,i)}}getGeometryCopy(t){const e=this.store[t];if(!e)throw new Error(`No feature with this id (${t}), can not get geometry copy`);return this.clone(e.geometry)}getPropertiesCopy(t){const e=this.store[t];if(!e)throw new Error(`No feature with this id (${t}), can not get properties copy`);return this.clone(e.properties)}updateProperty(t,e){const r=[];t.forEach(({id:i,property:s,value:o})=>{const a=this.store[i];if(!a)throw new Error(`No feature with this (${i}), can not update geometry`);r.push(i),o===void 0?delete a.properties[s]:a.properties[s]=o,this.tracked&&(a.properties.updatedAt=+new Date)}),this._onChange&&this._onChange(r,"update",e)}updateGeometry(t,e){const r=[];t.forEach(({id:i,geometry:s})=>{r.push(i);const o=this.store[i];if(!o)throw new Error(`No feature with this (${i}), can not update geometry`);o.geometry=this.clone(s),this.spatialIndex.update(o),this.tracked&&(o.properties.updatedAt=+new Date)}),this._onChange&&this._onChange(r,"update",e)}create(t,e){const r=[];return t.forEach(({geometry:i,properties:s})=>{let o,a=Mn({},s);this.tracked&&(o=+new Date,s?(a.createdAt=typeof s.createdAt=="number"?s.createdAt:o,a.updatedAt=typeof s.updatedAt=="number"?s.updatedAt:o):a={createdAt:o,updatedAt:o});const l=this.getId(),c={id:l,type:"Feature",geometry:i,properties:a};this.store[l]=c,this.spatialIndex.insert(c),r.push(l)}),this._onChange&&this._onChange([...r],"create",e),r}delete(t,e){t.forEach(r=>{if(!this.store[r])throw new Error(`No feature with id ${r}, can not delete`);delete this.store[r],this.spatialIndex.remove(r)}),this._onChange&&this._onChange([...t],"delete",e)}copy(t){return this.clone(this.store[t])}copyAll(){return this.clone(Object.keys(this.store).map(t=>this.store[t]))}copyAllWhere(t){return this.clone(Object.keys(this.store).map(e=>this.store[e]).filter(e=>e.properties&&t(e.properties)))}clear(){this.store={},this.spatialIndex.clear()}size(){return Object.keys(this.store).length}}class Go{constructor({name:t,callback:e,unregister:r,register:i}){this.name=void 0,this.callback=void 0,this.registered=!1,this.register=void 0,this.unregister=void 0,this.name=t,this.register=()=>{this.registered||(this.registered=!0,i(e))},this.unregister=()=>{this.register&&(this.registered=!1,r(e))},this.callback=e}}var AU={__proto__:null,TerraDrawBaseAdapter:class{constructor(n){this._nextKeyUpIsContextMenu=!1,this._lastPointerDownEventTarget=void 0,this._ignoreMismatchedPointerEvents=!1,this._minPixelDragDistance=void 0,this._minPixelDragDistanceDrawing=void 0,this._minPixelDragDistanceSelecting=void 0,this._lastDrawEvent=void 0,this._coordinatePrecision=void 0,this._heldKeys=new Set,this._listeners=[],this._dragState="not-dragging",this._currentModeCallbacks=void 0,this._ignoreMismatchedPointerEvents=typeof n.ignoreMismatchedPointerEvents=="boolean"&&n.ignoreMismatchedPointerEvents,this._minPixelDragDistance=typeof n.minPixelDragDistance=="number"?n.minPixelDragDistance:1,this._minPixelDragDistanceSelecting=typeof n.minPixelDragDistanceSelecting=="number"?n.minPixelDragDistanceSelecting:1,this._minPixelDragDistanceDrawing=typeof n.minPixelDragDistanceDrawing=="number"?n.minPixelDragDistanceDrawing:8,this._coordinatePrecision=typeof n.coordinatePrecision=="number"?n.coordinatePrecision:9}getButton(n){return n.button===-1?"neither":n.button===0?"left":n.button===1?"middle":n.button===2?"right":"neither"}getMapElementXYPosition(n){const t=this.getMapEventElement(),{left:e,top:r}=t.getBoundingClientRect();return{containerX:n.clientX-e,containerY:n.clientY-r}}getDrawEventFromEvent(n,t=!1){const e=this.getLngLatFromEvent(n);if(!e)return null;const{lng:r,lat:i}=e,{containerX:s,containerY:o}=this.getMapElementXYPosition(n),a=this.getButton(n),l=Array.from(this._heldKeys);return{lng:Me(r,this._coordinatePrecision),lat:Me(i,this._coordinatePrecision),containerX:s,containerY:o,button:a,heldKeys:l,isContextMenu:t}}register(n){this._currentModeCallbacks=n,this._listeners=this.getAdapterListeners(),this._listeners.forEach(t=>{t.register()})}getCoordinatePrecision(){return this._coordinatePrecision}getAdapterListeners(){return[new Go({name:"pointerdown",callback:n=>{if(!this._currentModeCallbacks||!n.isPrimary)return;const t=this.getDrawEventFromEvent(n);t&&(this._dragState="pre-dragging",this._lastDrawEvent=t,this._lastPointerDownEventTarget=n.target?n.target:void 0)},register:n=>{this.getMapEventElement().addEventListener("pointerdown",n)},unregister:n=>{this.getMapEventElement().removeEventListener("pointerdown",n)}}),new Go({name:"pointermove",callback:n=>{if(!this._currentModeCallbacks||!n.isPrimary)return;n.preventDefault();const t=this.getDrawEventFromEvent(n);if(t)if(this._dragState==="not-dragging")this._currentModeCallbacks.onMouseMove(t),this._lastDrawEvent=t;else if(this._dragState==="pre-dragging"){if(!this._lastDrawEvent)return;const e={x:this._lastDrawEvent.containerX,y:this._lastDrawEvent.containerY},r={x:t.containerX,y:t.containerY},i=this._currentModeCallbacks.getState(),s=Ci(e,r);let o=!1;if(o=i==="drawing"?s<this._minPixelDragDistanceDrawing:i==="selecting"?s<this._minPixelDragDistanceSelecting:s<this._minPixelDragDistance,o)return;this._nextKeyUpIsContextMenu=!1,this._dragState="dragging",this._currentModeCallbacks.onDragStart(t,a=>{this.setDraggability.bind(this)(a)})}else this._dragState==="dragging"&&this._currentModeCallbacks.onDrag(t,e=>{this.setDraggability.bind(this)(e)})},register:n=>{this.getMapEventElement().addEventListener("pointermove",n)},unregister:n=>{this.getMapEventElement().removeEventListener("pointermove",n)}}),new Go({name:"contextmenu",callback:n=>{this._currentModeCallbacks&&(n.preventDefault(),this._nextKeyUpIsContextMenu=!0)},register:n=>{this.getMapEventElement().addEventListener("contextmenu",n)},unregister:n=>{this.getMapEventElement().removeEventListener("contextmenu",n)}}),new Go({name:"pointerup",callback:n=>{if(!this._currentModeCallbacks||n.target!==this.getMapEventElement()||this._ignoreMismatchedPointerEvents&&this._lastPointerDownEventTarget!==n.target||(this._lastPointerDownEventTarget=void 0,!n.isPrimary))return;const t=this.getDrawEventFromEvent(n);t&&(this._dragState==="dragging"?this._currentModeCallbacks.onDragEnd(t,e=>{this.setDraggability.bind(this)(e)}):this._dragState!=="not-dragging"&&this._dragState!=="pre-dragging"||(this._nextKeyUpIsContextMenu&&(t.isContextMenu=!0,this._nextKeyUpIsContextMenu=!1),this._currentModeCallbacks.onClick(t)),this._dragState="not-dragging",this.setDraggability(!0))},register:n=>{this.getMapEventElement().addEventListener("pointerup",n)},unregister:n=>{this.getMapEventElement().removeEventListener("pointerup",n)}}),new Go({name:"keyup",callback:n=>{this._currentModeCallbacks&&(this._heldKeys.delete(n.key),this._currentModeCallbacks.onKeyUp({key:n.key,heldKeys:Array.from(this._heldKeys),preventDefault:()=>n.preventDefault()}))},register:n=>{this.getMapEventElement().addEventListener("keyup",n)},unregister:n=>{this.getMapEventElement().removeEventListener("keyup",n)}}),new Go({name:"keydown",callback:n=>{this._currentModeCallbacks&&(this._heldKeys.add(n.key),this._currentModeCallbacks.onKeyDown({key:n.key,heldKeys:Array.from(this._heldKeys),preventDefault:()=>n.preventDefault()}))},register:n=>{this.getMapEventElement().addEventListener("keydown",n)},unregister:n=>{this.getMapEventElement().removeEventListener("keydown",n)}})]}unregister(){this._listeners.forEach(n=>{n.unregister()}),this.clear(),this._currentModeCallbacks=void 0,this._lastDrawEvent=void 0,this._lastPointerDownEventTarget=void 0,this._nextKeyUpIsContextMenu=!1}}};function hp(n){if(n===null||typeof n=="boolean"||typeof n=="string")return!0;if(n===void 0)return!1;if(typeof n=="number")return Number.isFinite(n);if(typeof n=="bigint"||typeof n=="symbol"||typeof n=="function"||n instanceof RegExp||n instanceof Map||n instanceof Set||n instanceof Date)return!1;if(typeof n=="object"&&n!==null&&!Array.isArray(n)){const t=Object.getPrototypeOf(n);if(t!==Object.prototype&&t!==null)return!1}if(ArrayBuffer.isView(n)&&!(n instanceof DataView))return!1;if(Array.isArray(n)){for(const t of n)if(!hp(t))return!1}return typeof n=="object"&&Object.keys(n).every(t=>typeof t=="string"&&hp(n[t]))}class MU{constructor(t){this._modes=void 0,this._mode=void 0,this._adapter=void 0,this._enabled=!1,this._store=void 0,this._eventListeners=void 0,this._instanceSelectMode=void 0,this._adapter=t.adapter,this._mode=new xU;const e=new Set,r=t.modes.reduce((u,h)=>{if(e.has(h.mode))throw new Error(`There is already a ${h.mode} mode provided`);return e.add(h.mode),u[h.mode]=h,u},{}),i=Object.keys(r);if(i.length===0)throw new Error("No modes provided");i.forEach(u=>{if(r[u].type===Wa.Select){if(this._instanceSelectMode)throw new Error("only one type of select mode can be provided");this._instanceSelectMode=u}}),this._modes=Mn({},r,{static:this._mode}),this._eventListeners={change:[],select:[],deselect:[],finish:[],ready:[]},this._store=new IU({tracked:!!t.tracked,idStrategy:t.idStrategy?t.idStrategy:void 0});const s=u=>{const h=[],f=this._store.copyAll().filter(d=>!u.includes(d.id)||(h.push(d),!1));return{changed:h,unchanged:f}},o=(u,h)=>{this._enabled&&this._eventListeners.finish.forEach(f=>{f(u,h)})},a=(u,h,f)=>{if(!this._enabled)return;this._eventListeners.change.forEach(_=>{_(u,h,f)});const{changed:d,unchanged:p}=s(u);h==="create"?this._adapter.render({created:d,deletedIds:[],unchanged:p,updated:[]},this.getModeStyles()):h==="update"?this._adapter.render({created:[],deletedIds:[],unchanged:p,updated:d},this.getModeStyles()):h==="delete"?this._adapter.render({created:[],deletedIds:u,unchanged:p,updated:[]},this.getModeStyles()):h==="styling"&&this._adapter.render({created:[],deletedIds:[],unchanged:p,updated:[]},this.getModeStyles())},l=u=>{if(!this._enabled)return;this._eventListeners.select.forEach(d=>{d(u)});const{changed:h,unchanged:f}=s([u]);this._adapter.render({created:[],deletedIds:[],unchanged:f,updated:h},this.getModeStyles())},c=u=>{if(!this._enabled)return;this._eventListeners.deselect.forEach(d=>{d()});const{changed:h,unchanged:f}=s([u]);h&&this._adapter.render({created:[],deletedIds:[],unchanged:f,updated:h},this.getModeStyles())};Object.keys(this._modes).forEach(u=>{this._modes[u].register({mode:u,store:this._store,setCursor:this._adapter.setCursor.bind(this._adapter),project:this._adapter.project.bind(this._adapter),unproject:this._adapter.unproject.bind(this._adapter),setDoubleClickToZoom:this._adapter.setDoubleClickToZoom.bind(this._adapter),onChange:a,onSelect:l,onDeselect:c,onFinish:o,coordinatePrecision:this._adapter.getCoordinatePrecision()})})}checkEnabled(){if(!this._enabled)throw new Error("Terra Draw is not enabled")}getModeStyles(){const t={};return Object.keys(this._modes).forEach(e=>{t[e]=r=>this._instanceSelectMode&&r.properties[Ie.SELECTED]?this._modes[this._instanceSelectMode].styleFeature.bind(this._modes[this._instanceSelectMode])(r):this._modes[e].styleFeature.bind(this._modes[e])(r)}),t}featuresAtLocation({lng:t,lat:e},r){const i=r&&r.pointerDistance!==void 0?r.pointerDistance:30,s=!r||r.ignoreSelectFeatures===void 0||r.ignoreSelectFeatures,o=!(!r||r.ignoreCoordinatePoints===void 0)&&r.ignoreCoordinatePoints,a=!(!r||r.ignoreCurrentlyDrawing===void 0)&&r.ignoreCurrentlyDrawing,l=!(!r||r.ignoreClosingPoints===void 0)&&r.ignoreClosingPoints,c=!(!r||r.ignoreSnappingPoints===void 0)&&r.ignoreSnappingPoints,u=this._adapter.unproject.bind(this._adapter),h=this._adapter.project.bind(this._adapter),f=h(t,e),d=dw({unproject:u,point:f,pointerDistance:i});return this._store.search(d).filter(p=>{if(s&&(p.properties[Ie.MID_POINT]||p.properties[Ie.SELECTION_POINT])||o&&p.properties[sn.COORDINATE_POINT]||l&&p.properties[sn.CLOSING_POINT]||a&&p.properties[sn.CURRENTLY_DRAWING]||c&&p.properties[sn.SNAPPING_POINT])return!1;if(p.geometry.type==="Point"){const _=p.geometry.coordinates,v=h(_[0],_[1]);return Ci(f,v)<i}if(p.geometry.type==="LineString"){const _=p.geometry.coordinates;for(let v=0;v<_.length-1;v++){const E=_[v],m=_[v+1];if(cp(f,h(E[0],E[1]),h(m[0],m[1]))<i)return!0}return!1}if(gw([t,e],p.geometry.coordinates))return!0;if(r!=null&&r.includePolygonsWithinPointerDistance){const _=p.geometry.coordinates;for(const v of _)for(let E=0;E<v.length-1;E++){const m=v[E],g=v[E+1],y=h(m[0],m[1]),b=h(g[0],g[1]);if(cp(f,y,b)<i)return!0}}return!1}).map(p=>{if(r==null||!r.addClosestCoordinateInfoToProperties)return p;let _;if(p.geometry.type==="Polygon")_=p.geometry.coordinates[0].slice(0,-1);else{if(p.geometry.type!=="LineString")return p;_=p.geometry.coordinates}let v,E=-1,m=1/0;for(let g=0;g<_.length;g++){const y=_[g],b=Ci(h(y[0],y[1]),f);b<m&&(E=g,m=b,v=y)}return p.properties.closestCoordinateIndexToEvent=E,p.properties.closestCoordinatePixelDistanceToEvent=m,p.properties.closestCoordinateDistanceKmToEvent=Ql(v,[t,e]),p})}getSelectModeOrThrow(){const t=this.getSelectMode({switchToSelectMode:!0});if(!t)throw new Error("No select mode defined in instance");return t}getSelectMode({switchToSelectMode:t}){if(this.checkEnabled(),!this._instanceSelectMode)return null;const e=this.getMode();return t&&e!==this._instanceSelectMode&&this.setMode(this._instanceSelectMode),this._modes[this._instanceSelectMode]}isGuidanceFeature(t){return!!(t.properties[Ie.MID_POINT]||t.properties[Ie.SELECTION_POINT]||t.properties[sn.COORDINATE_POINT]||t.properties[sn.SNAPPING_POINT])}setModeStyles(t,e){if(this.checkEnabled(),!this._modes[t])throw new Error("No mode with this name present");this._modes[t].styles=e}updateModeOptions(t,e){if(this.checkEnabled(),!this._modes[t])throw new Error("No mode with this name present");this._modes[t].updateOptions(e)}getSnapshot(){return this._store.copyAll()}getSnapshotFeature(t){if(this._store.has(t))return this._store.copy(t)}clear(){this.checkEnabled(),this._adapter.clear()}get enabled(){return this._enabled}set enabled(t){throw new Error("Enabled is read only")}getMode(){return this._mode.mode}getModeState(){return this._mode.state}setMode(t){if(this.checkEnabled(),!this._modes[t])throw new Error("No mode with this name present");this._mode.stop(),this._mode=this._modes[t],this._mode.start()}removeFeatures(t){this.checkEnabled();const e=[];t.forEach(r=>{if(!this._store.has(r))throw new Error(`No feature with id ${r}, can not delete`);const i=this._store.copy(r);i.properties[Ie.SELECTED]&&this.deselectFeature(r),i.properties[sn.COORDINATE_POINT_IDS]&&e.push(...i.properties[sn.COORDINATE_POINT_IDS])}),this._store.delete([...t,...e],{origin:"api"})}selectFeature(t){this.getSelectModeOrThrow().selectFeature(t)}deselectFeature(t){this.getSelectModeOrThrow().deselectFeature(t)}getFeatureId(){return this._store.getId()}hasFeature(t){return this._store.has(t)}checkIsReservedProperty(t){return![...Object.values(Ie),...Object.values(sn)].includes(t)}updateFeatureProperties(t,e){if(!this._store.has(t))throw new Error(`No feature with id ${t} present in store`);const r=this._store.copy(t);if(this.isGuidanceFeature(r))throw new Error("Guidance features are not allowed to be updated directly.");const i=r.properties.mode;if(!this._modes[i])throw new Error(`No mode with name ${i} present in instance`);const s=Object.entries(e);s.forEach(([o,a])=>{if(!this.checkIsReservedProperty(o))throw new Error(`You are trying to update a reserved property name: ${o}. Please choose another name.`);if(a!==void 0&&!hp(a))throw new Error(`Invalid JSON value provided for property ${o}`)}),this._store.updateProperty(s.map(([o,a])=>({id:r.id,property:o,value:a})),{origin:"api"})}updateFeatureGeometry(t,e){if(!this._store.has(t))throw new Error(`No feature with id ${t} present in store`);const r=this._store.copy(t);if(this.isGuidanceFeature(r))throw new Error("Guidance features are not allowed to be updated directly.");if(!(r&&e&&e.type&&e.coordinates))throw new Error("Invalid geometry provided");if(e.type!==r.geometry.type)throw new Error(`Geometry type mismatch: expected ${r.geometry.type}, got ${e.type}`);const i=r.properties.mode,s=this._modes[i];if(!s)throw new Error(`No mode with name ${i} present in instance`);const o=Mn({},r,{geometry:e}),a=s.validateFeature(o);if(!a.valid)throw new Error(`Feature validation failed: ${a.reason||"Unknown reason"}`);if(this._store.updateGeometry([{id:r.id,geometry:e}],{origin:"api"}),s.afterFeatureUpdated){s.afterFeatureUpdated(o);const l=o.properties[Ie.SELECTED],c=this.getSelectMode({switchToSelectMode:!1});c&&l&&c.afterFeatureUpdated(o)}}transformFeatureGeometry(t,e){if(!this._store.has(t))throw new Error(`No feature with id ${t} present in store`);let r=this._store.copy(t);if(this.isGuidanceFeature(r))throw new Error("Guidance features are not allowed to be updated directly.");const i=r.properties.mode,s=this._modes[i];if(!s)throw new Error(`No mode with name ${i} present in instance`);let o;if(r.geometry.type==="Polygon")o=r.geometry.coordinates[0];else{if(r.geometry.type!=="LineString")throw new Error(`Feature geometry type ${r.geometry.type} is not supported for transformation`);o=r.geometry.coordinates}if(e.projection!="web-mercator")throw new Error(`Projection ${e.projection} is not currently supported for transformation`);if(e.type==="scale"){const{x:a,y:l}=ye(e.origin[0],e.origin[1]);_w({coordinates:o,originX:a,originY:l,xScale:e.options.xScale||1,yScale:e.options.yScale||1})}else e.type==="rotate"&&(r=mw(r,e.options.angle||0),o=r.geometry.type==="Polygon"?r.geometry.coordinates[0]:r.geometry.coordinates);if(o=o.map(a=>[Me(a[0],this._adapter.getCoordinatePrecision()),Me(a[1],this._adapter.getCoordinatePrecision())]),r.geometry.coordinates=r.geometry.type==="Polygon"?[o]:o,this._store.updateGeometry([{id:r.id,geometry:r.geometry}],{origin:"api"}),s.afterFeatureUpdated){s.afterFeatureUpdated(r);const a=r.properties[Ie.SELECTED],l=this.getSelectMode({switchToSelectMode:!1});l&&a&&l.afterFeatureUpdated(r)}}addFeatures(t){return this.checkEnabled(),t.length===0?[]:this._store.load(t,e=>{if(zv(e)){const r=e.properties.mode,i=this._modes[r];if(!i)return{id:e.id,valid:!1,reason:`${r} mode is not in the list of instantiated modes`};const s=i.validateFeature.bind(i)(e);return{id:e.id,valid:s.valid,reason:s.reason?s.reason:s.valid?void 0:"Feature is invalid"}}return{id:e.id,valid:!1,reason:"Mode property does not exist"}},e=>{if(zv(e)){const r=this._modes[e.properties.mode];r&&r.afterFeatureAdded&&r.afterFeatureAdded(e)}},{origin:"api"})}start(){this._enabled||(this._enabled=!0,this._adapter.register({onReady:()=>{this._eventListeners.ready.forEach(t=>{t()})},getState:()=>this._mode.state,onClick:t=>{this._mode.onClick(t)},onMouseMove:t=>{this._mode.onMouseMove(t)},onKeyDown:t=>{this._mode.onKeyDown(t)},onKeyUp:t=>{this._mode.onKeyUp(t)},onDragStart:(t,e)=>{this._mode.onDragStart(t,e)},onDrag:(t,e)=>{this._mode.onDrag(t,e)},onDragEnd:(t,e)=>{this._mode.onDragEnd(t,e)},onClear:()=>{this._mode.cleanUp(),this._store.clear()}}))}getFeaturesAtLngLat(t,e){const{lng:r,lat:i}=t;return this.featuresAtLocation({lng:r,lat:i},e)}getFeaturesAtPointerEvent(t,e){const r=this._adapter.getLngLatFromEvent.bind(this._adapter)(t);return r===null?[]:this.featuresAtLocation(r,e)}stop(){this._enabled&&(this._enabled=!1,this._adapter.unregister())}on(t,e){const r=this._eventListeners[t];r.includes(e)||r.push(e)}off(t,e){const r=this._eventListeners[t];r.includes(e)&&r.splice(r.indexOf(e),1)}}class RU extends AU.TerraDrawBaseAdapter{constructor(t){super(t),this._cursor=void 0,this._cursorStyleSheet=void 0,this._lib=void 0,this._map=void 0,this._overlay=void 0,this._clickEventListener=void 0,this._mouseMoveEventListener=void 0,this._readyCalled=!1,this.renderedFeatureIds=new Set,this._lib=t.lib,this._map=t.map,this._coordinatePrecision=typeof t.coordinatePrecision=="number"?t.coordinatePrecision:9}get _layers(){var t;return((t=this.renderedFeatureIds)==null?void 0:t.size)>0}circlePath(t,e,r){const i=2*r;return`M ${t} ${e} m -${r}, 0 a ${r},${r} 0 1,0 ${i},0 a ${r},${r} 0 1,0 -${i},0`}register(t){super.register(t),this._overlay=new this._lib.OverlayView,this._overlay.draw=function(){},this._overlay.onAdd=()=>{var e;(e=this._currentModeCallbacks)!=null&&e.onReady&&!this._readyCalled&&(this._currentModeCallbacks.onReady(),this._readyCalled=!0)},this._overlay.setMap(this._map),this._overlay.onRemove=()=>{},this._clickEventListener=this._map.data.addListener("click",e=>{const r=this._listeners.find(({name:i})=>i==="click");r&&r.callback(e)}),this._mouseMoveEventListener=this._map.data.addListener("mousemove",e=>{const r=this._listeners.find(({name:i})=>i==="mousemove");r&&r.callback(e)})}unregister(){var t,e;super.unregister(),(t=this._clickEventListener)==null||t.remove(),(e=this._mouseMoveEventListener)==null||e.remove(),this._overlay&&this._overlay.getMap()&&this._overlay.setMap(null),this._overlay=void 0,this._readyCalled=!1}getLngLatFromEvent(t){if(!this._overlay)throw new Error("cannot get overlay");const e=this._map.getBounds();if(!e)return null;const r=e.getNorthEast(),i=e.getSouthWest(),s=new this._lib.LatLngBounds(i,r),o=this._map.getDiv(),a=t.clientX-o.getBoundingClientRect().left,l=t.clientY-o.getBoundingClientRect().top,c=new this._lib.Point(a,l),u=this._overlay.getProjection();if(!u)return null;const h=u.fromContainerPixelToLatLng(c);return h&&s.contains(h)?{lng:h.lng(),lat:h.lat()}:null}getMapEventElement(){return this._map.getDiv().querySelector('div[style*="z-index: 3;"]')}project(t,e){if(!this._overlay)throw new Error("cannot get overlay");if(this._map.getBounds()===void 0)throw new Error("cannot get bounds");const r=this._overlay.getProjection();if(r===void 0)throw new Error("cannot get projection");const i=r.fromLatLngToContainerPixel(new this._lib.LatLng(e,t));if(i===null)throw new Error("cannot project coordinates");return{x:i.x,y:i.y}}unproject(t,e){if(!this._overlay)throw new Error("cannot get overlay");const r=this._overlay.getProjection();if(r===void 0)throw new Error("cannot get projection");const i=r.fromContainerPixelToLatLng(new this._lib.Point(t,e));if(i===null)throw new Error("cannot unproject coordinates");return{lng:i.lng(),lat:i.lat()}}setCursor(t){if(t!==this._cursor){if(this._cursorStyleSheet&&(this._cursorStyleSheet.remove(),this._cursorStyleSheet=void 0),t!=="unset"){const e=this._map.getDiv().querySelector(".gm-style > div");if(e){e.classList.add("terra-draw-google-maps");const r=document.createElement("style");r.innerHTML=`.terra-draw-google-maps { cursor: ${t} !important; }`,document.getElementsByTagName("head")[0].appendChild(r),this._cursorStyleSheet=r}}this._cursor=t}}setDoubleClickToZoom(t){this._map.setOptions(t?{disableDoubleClickZoom:!1}:{disableDoubleClickZoom:!0})}setDraggability(t){this._map.setOptions({draggable:t})}render(t,e){this._layers&&(t.deletedIds.forEach(i=>{const s=this._map.data.getFeatureById(i);s&&(this._map.data.remove(s),this.renderedFeatureIds.delete(i))}),t.updated.forEach(i=>{if(!i||!i.id)throw new Error("Feature is not valid");const s=this._map.data.getFeatureById(i.id);if(!s)throw new Error("Feature could not be found by Google Maps API");switch(s.forEachProperty((o,a)=>{s.setProperty(a,void 0)}),Object.keys(i.properties).forEach(o=>{s.setProperty(o,i.properties[o])}),i.geometry.type){case"Point":{const o=i.geometry.coordinates;s.setGeometry(new this._lib.Data.Point(new this._lib.LatLng(o[1],o[0])))}break;case"LineString":{const o=i.geometry.coordinates,a=[];for(let l=0;l<o.length;l++){const c=o[l],u=new this._lib.LatLng(c[1],c[0]);a.push(u)}s.setGeometry(new this._lib.Data.LineString(a))}break;case"Polygon":{const o=i.geometry.coordinates,a=[];for(let l=0;l<o.length;l++){const c=[];for(let u=0;u<o[l].length;u++){const h=new this._lib.LatLng(o[l][u][1],o[l][u][0]);c.push(h)}a.push(c)}s.setGeometry(new this._lib.Data.Polygon(a))}}}),t.created.forEach(i=>{this.renderedFeatureIds.add(i.id),this._map.data.addGeoJson(i)})),t.created.forEach(i=>{this.renderedFeatureIds.add(i.id)});const r={type:"FeatureCollection",features:[...t.created]};this._map.data.addGeoJson(r),this._map.data.setStyle(i=>{const s=i.getProperty("mode"),o=i.getGeometry();if(!o)throw new Error("Google Maps geometry not found");const a=o.getType(),l={},c=i.getId();i.forEachProperty((h,f)=>{l[f]=h});const u=e[s]({type:"Feature",id:c,geometry:{type:a,coordinates:[]},properties:l});switch(a){case"Point":return u.markerUrl?{clickable:!1,icon:{url:u.markerUrl,scaledSize:u.markerWidth&&u.markerHeight?new this._lib.Size(u.markerWidth,u.markerHeight):void 0},zIndex:u.zIndex}:{clickable:!1,icon:{path:this.circlePath(0,0,u.pointWidth),fillColor:u.pointColor,fillOpacity:1,strokeColor:u.pointOutlineColor,strokeWeight:u.pointOutlineWidth,rotation:0,scale:1},zIndex:u.zIndex};case"LineString":return{strokeColor:u.lineStringColor,strokeWeight:u.lineStringWidth,zIndex:u.zIndex};case"Polygon":return{strokeColor:u.polygonOutlineColor,strokeWeight:u.polygonOutlineWidth,fillOpacity:u.polygonFillOpacity,fillColor:u.polygonFillColor,zIndex:u.zIndex}}throw Error("Unknown feature type")})}clearLayers(){this._layers&&(this._map.data.forEach(t=>{const e=t.getId();this.renderedFeatureIds.has(e)&&this._map.data.remove(t)}),this.renderedFeatureIds=new Set)}clear(){this._currentModeCallbacks&&(this._currentModeCallbacks.onClear(),this.clearLayers())}getCoordinatePrecision(){return super.getCoordinatePrecision()}}const NU=n=>{const[t,e]=ve(void 0),[r,i]=ve(void 0),s=["#E74C3C","#FF0066","#9B59B6","#673AB7","#3F51B5","#3498DB","#03A9F4","#00BCD4","#009688","#27AE60","#8BC34A","#CDDC39","#F1C40F","#FFC107","#F39C12","#FF5722","#795548"],o=()=>{const u=Date.now()%s.length;return s[u]},a=c=>{t()?.setMode(c)},l=()=>{t()?.clear()};return gh(()=>{e(new MU({adapter:new RU({map:n.gmapref,lib:n.googleref.maps,coordinatePrecision:9}),modes:[new bU({flags:{freehand:{feature:{draggable:!0,rotateable:!0,coordinates:{midpoints:!0,draggable:!0,deletable:!0}}}}}),new tU({styles:(()=>{const c=o();return{fillColor:c,outlineColor:c}})()})]})),t()?.start(),n.onTerradrawUpdate&&t()?.on("change",(c,u)=>{console.log("FeatureUpdate",c,u);const h=t()?.getSnapshot();console.log("Snapshot",h),n.onTerradrawUpdate(r(),c,u,h)}),n.onTerradrawFinish&&t()?.on("finish",(c,u)=>{console.log("FeatureFinish",c,u);const h=t()?.getSnapshot();console.log("Snapshot",h),n.onTerradrawFinish(r(),c,u,h)}),i({terraDrawInstance:t(),fnChangeDrawMode:a,fnClearDraw:l}),n.onReady&&n.onReady(r())}),["TerraDraw Disini",Tl(()=>Tl(()=>!!n.children)()&&n.children(r()))]};var OU=Bn('<div>API Key : <input placeholder="API Key">Map ID : <input placeholder="Map ID"><button type=submit>Apply'),DU=Bn("<button>flyToTween"),LU=Bn("<button>flyToBboxTween"),kU=Bn("<button>flyToBboxTweenJayapura"),FU=Bn("<button>panToBounds"),BU=Bn("<div><!$><!/><!$><!/>"),UU=Bn("<div><div>Halo Dunia"),VU=Bn("<button>FreeHand"),zU=Bn("<button>Select"),WU=Bn("<button>Clear");function HU(){const[n,t]=ve(3),[e,r]=ve(),[i,s]=ve(),[o,a]=ve(void 0),[l,c]=ve(void 0),[u,h]=ve(void 0),[f,d]=ve(void 0);n();let p,_;const v=()=>{a(u()),c(f())},E=()=>{const T=e(),M=i();T&&M&&(p=U4(M,T))},m=T=>{r(T),console.log("Map Ready",e()),E()},g=()=>{s(window.google),console.log("Google Provider Loaded",i()),E()},y=T=>{t(T.detail.zoom)},b=T=>{_=p.fnFlyTo(T)},x=(T,M)=>{console.log("With new flyTo service :)"),_=p.fnFlyToBounds(T,M)},w=T=>{const M=new google.maps.LatLngBounds(new google.maps.LatLng(T[0][1],T[0][0]),new google.maps.LatLng(T[1][1],T[1][0]));e().panToBounds(M,{})},S=T=>{const M=new google.maps.LatLngBounds;return T.features.forEach(L=>{const O=L.geometry.coordinates,P=V=>{typeof V[0]=="number"&&typeof V[1]=="number"?M.extend(new google.maps.LatLng(V[1],V[0])):Array.isArray(V)&&V.forEach(P)};P(O)}),M},I=()=>{console.log("User attempt to drag"),_&&!_.isStopped()&&_.stopAnimation()};return gh(()=>{console.log("Function panToBounds",w),console.log("Function fnGeoJSONToBounds",S)}),(()=>{var T=Tn(BU),M=T.firstChild,[L,O]=sd(M.nextSibling),P=L.nextSibling,[V,C]=sd(P.nextSibling);return wu(T,Pn(_l,{get when(){return!o()},get children(){var R=Tn(OU),D=R.firstChild,H=D.nextSibling,K=H.nextSibling,G=K.nextSibling,Y=G.nextSibling;return H.addEventListener("change",J=>h(J.target.value)),G.addEventListener("change",J=>d(J.target.value)),Y.$$click=v,gi(),R}}),L,O),wu(T,Pn(_l,{get when(){return o()},get children(){return[(()=>{var R=Tn(DU);return R.$$click=()=>b({lat:-6.309615123970005,lng:106.82188445078322,zoom:15}),gi(),R})(),(()=>{var R=Tn(LU);return R.$$click=()=>x([[106.81548037914058,-6.301188823396288],[106.82820078053862,-6.318298021062958]],{padding:1,useFlyTo:!1}),gi(),R})(),(()=>{var R=Tn(kU);return R.$$click=()=>x([[140.34466715682066,-2.394364723691936],[140.73294259110833,-2.6180471200476774]],{padding:1,useFlyTo:!1}),gi(),R})(),(()=>{var R=Tn(FU);return R.$$click=()=>w([[106.81548037914058,-6.301188823396288],[106.82820078053862,-6.318298021062958]]),gi(),R})(),Pn(x1,{onLoad:g,libraries:["geometry","places"],get apiKey(){return o()},get children(){return[Pn(r0,{ref:R=>m(R),style:{height:"500px",width:"100%"},gestureHandling:"greedy",onProjectionChanged:()=>{console.log("Projection Change")},disableDoubleClickZoom:!0,disableDefaultUI:!0,defaultBounds:{north:-11.5,south:11.5,east:141.5,west:95},get mapId(){return l()},renderingType:"VECTOR",onDrag:I,onZoomChanged:y}),Pn(_l,{get when(){return Tl(()=>!!e())()&&i()},get children(){return[Pn(a1,{each:[.25,.5,.75],children:(R,D)=>Pn(O1,{get gmapref(){return e()},get googleref(){return i()},latitude:R,get longitude(){return 140+D()},get children(){var H=Tn(UU),K=H.firstChild;return H.$$click=()=>alert("Accessed"+D()),H.style.setProperty("pointer-events","auto"),K.style.setProperty("background-color","#FFFA"),gi(),H}})}),Pn(B4,{sigZoom:n,get gmapref(){return e()},onReady:()=>{}}),Pn(NU,{get googleref(){return i()},get gmapref(){return e()},onTerradrawFinish:(R,D,H)=>{console.log("Disini FInisshh",R,D,H)},onReady:R=>{},children:R=>[(()=>{var D=Tn(VU);return D.$$click=()=>{R?.fnChangeDrawMode("freehand")},gi(),D})(),(()=>{var D=Tn(zU);return D.$$click=()=>{R?.fnChangeDrawMode("select")},gi(),D})(),(()=>{var D=Tn(WU);return D.$$click=()=>{R?.fnClearDraw()},gi(),D})()]})]}})]}})]}}),V,C),T})()}o1(["click"]);var jU=Bn("<main><h1>Example Solid Gmaps</h1><!$><!/>");function K6(){return(()=>{var n=Tn(jU),t=n.firstChild,e=t.nextSibling,[r,i]=sd(e.nextSibling);return wu(n,Pn(HU,{}),r,i),n})()}export{K6 as default};
